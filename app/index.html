<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Primary Meta Tags -->
    <title>xFetishHub — Discover, Analyze & Watch. Your Private Adult Guide.</title>
    <meta name="title" content="xFetishHub — Discover, Analyze & Watch. Your Private Adult Guide.">
    
    <!-- Описание -->
    <meta name="description" content="More than a generator. Your intelligent home for adult preferences. Analyze your tastes with charts, discover 1000+ genres, and watch videos securely via the built-in private browser.">
    
    <!-- Ключевые слова -->
    <meta name="keywords" content="adult preference analyzer, porn tracker, fetish statistics, private porn browser, sex taste analysis, porn discovery, fetish encyclopedia, smart porn guide, xxx recommendation engine, porn roulette, fetishhub, safe adult browsing">
    
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="language" content="English">
    <meta name="author" content="xFetishHub">
    <meta name="rating" content="adult">
    <meta name="age-rating" content="18">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.xfetishhub.site/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.xfetishhub.site/">
    <meta property="og:title" content="xFetishHub — Your Intelligent Adult Guide">
    <meta property="og:description" content="Analyze your tastes, track history, and discover new desires in a secure, private environment.">
    <meta property="og:image" content="https://www.xfetishhub.site/og-image.jpg">
    <meta property="og:site_name" content="xFetishHub">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.xfetishhub.site/">
    <meta property="twitter:title" content="xFetishHub — Discover Your Desires">
    <meta property="twitter:description" content="The all-in-one platform for adult discovery, statistics, and private viewing.">
    <meta property="twitter:image" content="https://www.xfetishhub.site/og-image.jpg">

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo_icon.png">
    <link rel="apple-touch-icon" href="logo_icon.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FetishHub">
    <meta name="theme-color" content="#050505">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- SCHEMA.ORG: Позиционируем как ПРИЛОЖЕНИЕ (SoftwareApplication), а не просто веб-страницу -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "xFetishHub",
      "url": "https://www.xfetishhub.site/",
      "description": "An intelligent platform for tracking adult preferences, analyzing sexual statistics, and discovering new content categories securely.",
      "applicationCategory": "LifestyleApplication",
      "operatingSystem": "Web, iOS, Android",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": "Preference Analytics, Private Browser, Content Discovery, Fetish Tracker"
    }
    </script>
    
    <style>
        /* === LOADER === */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999999;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            background-color: #12000b;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        #loading-overlay.hidden {
            opacity: 0; visibility: hidden; pointer-events: none;
        }

        .loader-logo {
            width: 70px; height: 70px;
            object-fit: contain;
            margin-bottom: 25px;
            opacity: 0.9;
            animation: breathe 2.5s infinite ease-in-out;
        }

        .loader-text {
            font-size: 13px; font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-align: center;
            min-height: 20px; /* Чтобы текст не прыгал */
            margin-bottom: 15px;
            opacity: 0.7;
        }

        /* Прогресс бар */
        .loader-progress-container {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .loader-progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent, #ff00cc); /* Использует цвет темы или дефолтный розовый */
            border-radius: 4px;
            transition: width 0.2s ease-out;
            box-shadow: 0 0 10px var(--accent, #ff00cc);
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.95); opacity: 0.6; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        /* =========================================
        1. VARIABLES & RESET & THEMES
        ========================================= */
        :root {
            --bg-color: #12000b;
            --sidebar-bg: #1a0010;
            --card-bg: #2b001b;
            --nav-bg: #2b001b;
            
            --text-main: #ffffff;
            --text-secondary: #888888;
            
            /* PINK ACCENTS ONLY */
            --accent: #ff00cc; 
            --accent-light: #ff66e0;
            
            --border: #4d0030;
            --highlight-green: #2ecc71;
            --highlight-red: #e74c3c;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --modal-bg: rgba(18, 0, 11, 0.95);
            
            /* iOS Style Colors */
            --ios-bg: #12000b;
            --ios-card: #2b001b;
            --ios-separator: #4d0030;
            --ios-header: #8E8E93; 

            --card-gradient: linear-gradient(165deg, #2b001b 0%, #1a0010 100%);
        }

        body.light-theme {
            --bg-color: #ffeef8;
            --sidebar-bg: #fff5fb; 
            --card-bg: #ffffff;
            --nav-bg: #ffffff;
            
            --text-main: #000000;
            --text-secondary: #666666; 
            
            --border: #fbcfe8;
            --modal-bg: rgba(255, 255, 255, 0.95);
            
            --accent: #db2777;
            --accent-light: #f472b6;

            --ios-bg: #ffeef8;
            --ios-card: #ffffff;
            --ios-separator: #e5e7eb;
            --ios-header: #6D6D72; 

            --card-gradient: linear-gradient(165deg, #ffffff 0%, #ffeef8 100%);
        }

        body[data-theme="noir"] {
            --accent: #ffffff;
            --accent-light: #cccccc;
            --highlight-green: #ffffff;
            --highlight-red: #ffffff;
            --text-secondary: #aaaaaa;
            --ios-separator: #333333;
            --border: #333333;
        }

        /* 1. Кнопки управления (Tinder-style) */
        body[data-theme="noir"] .t-circle-btn {
            background: #000000 !important;
            border: 1px solid #ffffff !important;
            color: #ffffff !important;
            box-shadow: none !important;
            background-image: none !important;
        }

        /* Активное состояние кнопок (инверсия) */
        body[data-theme="noir"] .t-circle-btn:active,
        body[data-theme="noir"] .t-circle-btn.active,
        body[data-theme="noir"] .t-circle-btn.wl.active {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #ffffff !important;
        }

        /* 2. Большая кнопка генерации/старта */
        body[data-theme="noir"] .btn-gen,
        body[data-theme="noir"] .btn-start-capsule,
        body[data-theme="noir"] .btn-watch {
            background: #000000 !important;
            border: 1px solid #ffffff !important;
            color: #ffffff !important;
            box-shadow: 0 4px 15px rgba(255,255,255,0.1) !important;
            background-image: none !important;
        }
        
        body[data-theme="noir"] .btn-gen:active,
        body[data-theme="noir"] .btn-start-capsule:active {
            background: #ffffff !important;
            color: #000000 !important;
        }

        /* 3. Тумблеры (Switch) */
        body[data-theme="noir"] input:checked + .slider {
            background-color: #ffffff !important;
        }
        body[data-theme="noir"] input:checked + .slider:before {
            background-color: #000000 !important;
            transform: translateX(20px);
        }
        body[data-theme="noir"] .slider {
            background-color: #333333;
        }

        /* 4. Бейджи (Extreme, LGBT...) */
        body[data-theme="noir"] .warning-badge {
            background: #000000 !important;
            border: 1px solid #ffffff !important;
            color: #ffffff !important;
        }

        /* 5. Иконки в настройках и навбаре */
        body[data-theme="noir"] .nav-item.active .nav-icon {
            color: #ffffff !important;
        }
        
        /* 6. Активные элементы списков */
        body[data-theme="noir"] .theme-item.active {
            border-color: #ffffff !important;
        }
        body[data-theme="noir"] .lock-icon {
            color: #ffffff !important;
        }

        /* 7. График статистики */
        body[data-theme="noir"] .chart-bar {
            background: #ffffff !important;
        }
        
        /* 8. Логотип (Fetish часть) */
        body[data-theme="noir"] .logo span {
            background: #ffffff !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* 9. Кнопки выбора режима (Start Screen) */
        body[data-theme="noir"] .mode-circle-btn {
            background: #000000 !important;      
            border: 1px solid #ffffff !important; 
            box-shadow: none !important;         
            color: #ffffff !important;           
        }
        
        body[data-theme="noir"] .mode-circle-btn:active {
            background: #ffffff !important;       
            color: #000000 !important;
        }

        body[data-theme="noir"] .ai-icon-img {
            filter: invert(1) !important; 
        }
        body[data-theme="noir"] .mode-circle-btn:active .ai-icon-img {
            filter: invert(0) !important; 
        }

        /* === THEME: OLD MONEY (Mahogany & Gold) === */
        body[data-theme="old-money"] {
            --bg-color: #1a0505;
            --sidebar-bg: #260909;
            --card-bg: #2e0b0b;
            --nav-bg: #3d0e0e;
            
            --text-main: #f0e6d2; /* Папирус */
            --text-secondary: #a38970; /* Медь */
            
            --accent: #c5a059; /* Старое золото */
            --accent-light: #e6c98c; /* Светлое золото */
            
            --border: #4a1919;
            --ios-card: #2e0b0b;
            --ios-bg: #1a0505;
            --ios-separator: #4a1919;
            --ios-header: #8a6a4b;

            --card-gradient: linear-gradient(165deg, #2e0b0b 0%, #1a0505 100%);
            --modal-bg: rgba(26, 5, 5, 0.95);
        }

        /* 1. ЛОГОТИП (Золотой градиент) */
        body[data-theme="old-money"] .logo span,
        body[data-theme="old-money"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #f9f1d8 0%, #c5a059 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-shadow: 0 2px 10px rgba(197, 160, 89, 0.2);
        }

        /* 2. ИКОНКИ В ИНТЕРФЕЙСЕ (Золотой фильтр) */
        body[data-theme="old-money"] .nav-icon-img,
        body[data-theme="old-money"] .settings-icon,
        body[data-theme="old-money"] .share-icon-img,
        body[data-theme="old-money"] .ex-card-icon {
            filter: invert(75%) sepia(26%) saturate(677%) hue-rotate(357deg) brightness(89%) contrast(88%) drop-shadow(0 2px 5px rgba(0,0,0,0.3)) !important;
            opacity: 1;
        }

        /* 3. ДЕКОРАЦИИ (Летающие иконки) - ЗОЛОТОЙ ГРАДИЕНТ/ОТЛИВ */
        body[data-theme="old-money"] .deco-icon {
            /* Фильтр, превращающий белое/черное в золото + тень для объема */
            filter: invert(68%) sepia(35%) saturate(735%) hue-rotate(2deg) brightness(110%) contrast(100%) drop-shadow(0 4px 0px #3d1515) !important;
            opacity: 0.9;
        }

        /* =========================================
           4. КНОПКИ УПРАВЛЕНИЯ (TINDER) - ИСПРАВЛЕНИЕ
           ========================================= */
        
        /* ОБЩИЙ СТИЛЬ для кнопок: Undo, Pass, Like, WL */
        body[data-theme="old-money"] .t-circle-btn.undo,
        body[data-theme="old-money"] .t-circle-btn.dislike,
        body[data-theme="old-money"] .t-circle-btn.like,
        body[data-theme="old-money"] .t-circle-btn.wl {
            background: #260909 !important; /* Темный фон (Махагон) */
            border: 1px solid #5c2424 !important; /* Рамка */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important; /* Тень */
        }

        /* ИКОНКИ ВНУТРИ ЭТИХ КНОПОК -> ДЕЛАЕМ ЗОЛОТЫМИ */
        body[data-theme="old-money"] .t-circle-btn.undo .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.dislike .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.like .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.wl .action-icon-img {
            /* Золотой фильтр (#c5a059) */
            filter: invert(75%) sepia(26%) saturate(677%) hue-rotate(357deg) brightness(89%) contrast(88%) !important;
        }

        /* АКТИВНОЕ СОСТОЯНИЕ (При нажатии) */
        body[data-theme="old-money"] .t-circle-btn:active,
        body[data-theme="old-money"] .t-circle-btn.wl.active {
            background: #f0e6d2 !important; /* Светлая вспышка */
            border-color: #fff !important;
        }
        /* При нажатии иконка темнеет */
        body[data-theme="old-money"] .t-circle-btn:active .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.wl.active .action-icon-img {
            filter: brightness(0.2) !important; 
        }

        /* ОСОБЫЙ СТИЛЬ ДЛЯ КНОПКИ WATCH (Центральная) */
        body[data-theme="old-money"] .t-circle-btn.watch {
            /* Яркий золотой градиент */
            background: linear-gradient(135deg, #c5a059 0%, #8a6a4b 100%) !important;
            border: 1px solid #f0e6d2 !important; 
            box-shadow: 0 0 25px rgba(197, 160, 89, 0.4) !important;
        }
        /* Иконка внутри Watch -> ТЕМНАЯ (для контраста с золотом) */
        body[data-theme="old-money"] .t-circle-btn.watch .action-icon-img {
            filter: brightness(0.15) !important; 
        }

        /* 5. КНОПКИ НА СТАРТОВОМ ЭКРАНЕ (Start Screen) */
        body[data-theme="old-money"] .mode-circle-btn {
            background: #260909 !important;
            border: 1px solid #5c2424 !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6) !important;
        }
        /* Иконки внутри - БЕЛЫЕ */
        body[data-theme="old-money"] .mode-circle-btn .side-icon-img,
        body[data-theme="old-money"] .mode-circle-btn .ai-icon-img {
            filter: brightness(0) invert(1) !important; 
            opacity: 1 !important;
            drop-shadow: 0 0 10px rgba(197, 160, 89, 0.5) !important;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden; /* Скролл только внутри контейнеров */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        button, select, input { font-family: inherit; outline: none; }
        a { text-decoration: none; color: inherit; }

        /* === CUSTOMIZATION === */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 колонки */
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-item {
            background: var(--ios-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            overflow: hidden;
        }

        .theme-item.active {
            border-color: var(--accent);
            background: var(--nav-bg);
        }
        
        .theme-item.locked {
            opacity: 0.6;
        }

        /* Квадраты предпросмотра */
        .theme-preview-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(128,128,128,0.2);
            position: relative;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Кружок цвета внутри квадрата */
        .theme-preview-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .theme-info {
            display: flex;
            flex-direction: column;
        }
        
        .theme-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .theme-type {
            font-size: 10px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .lock-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        /* Стили для элемента темы в режиме предпросмотра */
        .theme-item.previewing {
            border-color: var(--accent) !important;
            background: var(--nav-bg);
        }

        /* Убираем прозрачность для заблокированных тем, чтобы их было видно при клике */
        .theme-item.locked.previewing {
            opacity: 1 !important;
        }

        .pro-badge-icon {
            font-size: 10px;
            font-weight: 800;
            background: var(--accent); /* Цвет темы */
            color: #000; /* Контрастный текст */
            padding: 3px 6px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        /* 2. Плавающая панель "Unlock" (внизу экрана) */
        #preview-floating-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(120px); /* Спрятана внизу */
            width: 90%;
            max-width: 380px; /* Чуть компактнее */
            
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            
            padding: 10px 10px 10px 20px; /* Больше воздуха */
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px; /* Гарантированный отступ между текстом и кнопкой */
            
            z-index: 30000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            pointer-events: auto;
        }

        /* Состояние "Видно" */
        #preview-floating-bar.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Светлая тема для плашки */
        body.light-theme #preview-floating-bar {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Прозрачный щит-перехватчик */
        #preview-overlay-shield {
            display: none; /* Скрыт по умолчанию */
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 29000; /* Перекрывает всё, кроме плашки Unlock */
            background: transparent; /* Невидимый */
            -webkit-tap-highlight-color: transparent;
        }

        /* Когда активен — блокирует всё */
        #preview-overlay-shield.active {
            display: block;
        }

        /* =========================================
        2. MAIN LAYOUT (Sidebar & Content)
        ========================================= */
        .app-layout { display: flex; height: 100%; width: 100%; }

        .sidebar {
            width: 340px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .main-content {
            flex: 1;
            position: relative;
            height: 100%;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: hidden !important;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            overflow-x: visible;
            -webkit-overflow-scrolling: touch; 
            padding: 20px 15px;
            padding-bottom: 120px;
            padding-top: 110px; /* Место под хедер на мобильных */
            width: 100%;
            box-sizing: border-box;
        }

        .tab-content.active { display: flex; }

        .center-wrapper {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 auto;
        }

        /* =========================================
        3. HEADERS, LOGO & MASKS
        ========================================= */
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 0;
            letter-spacing: -1px;
            cursor: pointer;
            line-height: 1;
        }
        .logo span { 
            /* Градиент: Сверху #CB53F0, Снизу цвет темы */
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            position: relative;
            z-index: 1;
        }

        .logo-img {
            height: 45px;
            width: auto;
            display: block;
            object-fit: contain;
            transform: translateY(0);
            margin-right: 2px;
        }

        body.tab-home-active .mobile-header .subtitle {
            display: none !important; /* Скрываем подзаголовок */
        }

        body.tab-home-active .mobile-header {
            min-width: auto;
            width: auto;
            padding: 8px 20px;
            border-radius: 50px;
            min-height: 50px; 
        }

        body.tab-home-active .mobile-header .logo {
            font-size: 22px;
            margin: 0;
        }

        body.tab-home-active .mobile-header .logo-img {
            height: 35px;
            transform: translateY(0);
        }

        body.tab-home-active #tab-home {
            padding-top: 80px !important; 
        }

        /* 1. Скрываем подзаголовок на ВСЕХ вкладках */
        body.tab-home-active .mobile-header .subtitle,
        body.tab-settings-active .mobile-header .subtitle,
        body.tab-account-active .mobile-header .subtitle {
            display: none !important;
        }

        /* 2. Превращаем хедер в компактную капсулу на ВСЕХ вкладках */
        body.tab-home-active .mobile-header,
        body.tab-settings-active .mobile-header,
        body.tab-account-active .mobile-header {
            min-width: auto;
            width: auto;
            padding: 8px 20px;      /* Компактные отступы */
            border-radius: 50px;    /* Полная капсула */
            min-height: 50px;
            flex-direction: row;    /* Элементы в строку */
        }

        /* 3. Уменьшаем размер шрифта логотипа */
        body.tab-home-active .mobile-header .logo,
        body.tab-settings-active .mobile-header .logo,
        body.tab-account-active .mobile-header .logo {
            font-size: 22px;
            margin: 0;
        }

        /* 4. Уменьшаем картинку логотипа */
        body.tab-home-active .mobile-header .logo-img,
        body.tab-settings-active .mobile-header .logo-img,
        body.tab-account-active .mobile-header .logo-img {
            height: 35px;
            transform: translateY(0);
        }

        /* 5. Корректируем отступ контента сверху (так как шапка стала меньше) */
        body.tab-settings-active #tab-settings,
        body.tab-account-active #tab-account {
            padding-top: 90px !important; /* Было 110px, уменьшаем под размер капсулы */
        }
        
        .subtitle {
            font-size: 11px; 
            color: var(--text-secondary); 
            text-transform: uppercase;
            letter-spacing: 1px; 
            text-align: center; 
            
            margin-top: -5px !important;   /* Тянем вверх к логотипу */
            margin-bottom: 25px !important; /* Отступ снизу до меню */
            
            font-weight: 600; 
            opacity: 0.7; 
            max-width: 240px; 
            margin-left: auto; /* Центрирование */
            margin-right: auto;
            line-height: 1.4;
        }

        /* Градиентные маски для скролла */
        .top-gradient-mask {
            display: none;
            position: fixed; top: -50px; left: 0; width: 100%; height: 160px;
            z-index: 9000; pointer-events: none;
            background: linear-gradient(to bottom, var(--bg-color) 40%, transparent 100%);
        }
        .bottom-gradient-mask {
            display: none; 
            position: fixed; bottom: -50px; left: 0; width: 100%; height: 160px;
            z-index: 9000; pointer-events: none;
            background: linear-gradient(to top, var(--bg-color) 40%, transparent 100%);
        }

        @keyframes cardPopIn {
            0% { 
                opacity: 0;
                transform: scale(0.8) translateY(30px);
            }
            60% {
                opacity: 1;
                transform: scale(1.02) translateY(-5px); /* Легкий перелет */
            }
            100% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .anim-initial-pop {
            animation: cardPopIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
        }

        /* Скрываем элементы карточки до начала анимации */
        .card-content-hidden .stagger-item {
            opacity: 0;
            animation: none !important;
        }

        /* =========================================
        4. GENERATOR CARD & SLOT MACHINE
        ========================================= */
        .animation-text-box { text-align: center; min-height: 20px; margin-bottom: 5px; width: 100%; }
        .animation-text { font-size: 14px; font-weight: 700; color: var(--accent); text-transform: uppercase; opacity: 0; transition: opacity 0.2s; }
        .animation-text.visible { opacity: 1; }

        .status-text-combined {
            /* Позиционирование НАД карточкой */
            position: absolute;
            bottom: 100%; /* Приклеиваем к верху контейнера */
            left: 0;
            width: 100%;
            margin-bottom: 15px; /* Отступ от карточки */
            z-index: 15; 
            
            /* Стили текста */
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 16px; 
            font-weight: 700; 
            color: var(--text-main);
            text-transform: uppercase; 
            letter-spacing: 1px;
            line-height: 1.3; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            
            transform-origin: 50% 400px; /* Примерно центр низа карточки */
            will-change: transform;
            pointer-events: none; /* Чтобы текст не мешал свайпать */
        }

        .card {
            position: relative; 
            display: flex !important;
            flex-direction: column !important;
            justify-content: space-between !important; 
            
            width: 100%;
            min-height: 60vh; 
            height: auto;
            
            background: var(--card-gradient);
            border: 1px solid var(--border);
            border-radius: 28px;
            overflow: hidden; 
            padding: 0 !important; 
            
            transition: transform 0.1s linear; 
            z-index: 5;
        }

        body.light-theme .card {
            background: var(--card-gradient);
            border: 1px solid rgba(0,0,0,0.04) !important;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.08) !important;
        }

        body.light-theme .mobile-header {
            background: rgba(255, 255, 255, 0.85) !important;
            border: 1px solid rgba(0, 0, 0, 0.05) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        body.light-theme .bottom-nav {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        }

        body.light-theme .ios-group,
        body.light-theme .capsule-btn,
        body.light-theme .mode-capsule-btn {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .voice-icon-img,
        body.light-theme .ai-icon-img {
            filter: invert(0) drop-shadow(0 2px 5px rgba(0, 0, 0, 0.05));
            opacity: 0.6;
        }

        .card.has-results {
            min-height: inherit !important;
            height: auto !important;
            padding-top: 15px !important; 
            padding-bottom: 15px !important;
            justify-content: flex-start !important;
            gap: 5px; 
        }

        @keyframes flyInSmooth {
            0% { 
                transform: translateX(100px) scale(0.9); /* Слегка справа и меньше */
                opacity: 0; 
                filter: blur(10px);
            }
            100% { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
                filter: blur(0);
            }
        }

        .anim-slow-enter {
            /* 0.8s - медленнее и плавнее, чем обычный свайп */
            animation: flyInSmooth 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }
        
        /* Slot Window */
        .slot-window {
            width: 100%;
            /* На мобильных высота авто, чтобы не занимать лишнее место */
            height: auto !important; 
            min-height: 100px;
            
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            
            /* Маска для красивого исчезновения текста */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
        }

        /* На совсем маленьких экранах (iPhone SE и т.д.) чуть уменьшаем */
        @media (max-height: 650px) {
            .slot-window {
                height: 180px !important;
            }
        }

        .card.has-results .slot-window {
            height: auto !important;
            margin: 0 !important;
            overflow: visible !important;
            -webkit-mask-image: none !important;
            mask-image: none !important;
        }

        .slot-reel {
            display: flex; flex-direction: column; align-items: center;
            transform: translateY(0); width: 100%;
            will-change: transform;
        }

        .slot-item {
            height: auto !important; 
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            padding: 0 10px;
            font-size: clamp(32px, 8vw, 60px) !important;
            font-weight: 800;
            color: var(--text-main);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .card.has-results .slot-item {
            height: auto !important;
            padding: 0 10px !important;
            margin-bottom: 5px;
            font-size: clamp(28px, 6vw, 42px) !important;
            
            display: block !important; 
            text-align: center !important;
            white-space: normal !important; 
            line-height: 1.2 !important;
        }

        .slot-item span {
            font-weight: 600;
            margin-left: 6px; 
            display: inline; 
        }

        .card > div:last-child {
            z-index: 20; 
            flex: 0 0 auto; 
            width: 100%;
            padding-bottom: 20px;
            margin-top: auto; 
            background: transparent; 
        }

        
        /* Animations & Effects */
        .slot-item.shrunk { transform: scale(0.8); opacity: 0.7; }
        .slot-item.zoomed { transform: scale(1.2); color: var(--accent); text-shadow: 0 0 20px rgba(255, 153, 0, 0.4); }
        
        .card.flash-active { background-color: #fff !important; border-color: #fff !important; transform: scale(1.02); }
        
        .result-description { 
            font-size: 19px !important; 
            font-weight: 500 !important;
            color: var(--text-secondary) !important;
            line-height: 1.5 !important;
            max-width: 90%; 
            margin: 0 auto; 
            text-align: center;
            opacity: 0.2;
        }
        .result-description.fade-visible:not(:empty) { display: block; }

        /* Idle Animation */
        @keyframes scrollIdle { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
        .slot-reel.idle { animation: scrollIdle 60s linear infinite; filter: blur(5px); opacity: 0.6; }
        .slot-reel.spinning { filter: blur(0); opacity: 1; }

        /* === АНИМАЦИИ FLY IN === */
        
        /* Карточка вылетает СЛЕВА (для "Другое" / Свайп влево / Вернуться) */
        @keyframes flyInLeft {
            0% { 
                transform: translateX(-150%) rotate(-15deg); /* Чуть дальше вылет */
                opacity: 0; 
                filter: blur(20px); /* Сильный блюр в начале */
            }
            50% {
                opacity: 1;
                filter: blur(10px); /* Блюр в середине */
            }
            100% { 
                transform: translateX(0) rotate(0); 
                opacity: 1; 
                filter: blur(0); /* Четкость в конце */
            }
        }

        /* Карточка вылетает СПРАВА (для "Похожее" / Свайп вправо) */
        @keyframes flyInRight {
            0% { 
                transform: translateX(150%) rotate(15deg); 
                opacity: 0; 
                filter: blur(20px); 
            }
            50% {
                opacity: 1;
                filter: blur(10px);
            }
            100% { 
                transform: translateX(0) rotate(0); 
                opacity: 1; 
                filter: blur(0); 
            }
        }

        /* Классы для JS */
        .anim-fly-left {
            animation: flyInLeft 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }

        .anim-fly-right {
            animation: flyInRight 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }

        /* =========================================
        5. BUTTONS & CONTROLS
        ========================================= */
        .btn-gen, .btn-watch, .related-item-btn, .btn-action { border-radius: 22px; outline: none; border: none; cursor: pointer; }
        
        .gen-controls { display: flex; gap: 10px; width: 100%; margin-bottom: 15px; transition: opacity 0.3s; }
        .btn-gen { flex: 1; padding: 22px; background: var(--text-main); color: var(--bg-color); font-size: 18px; font-weight: 900; text-transform: uppercase; box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .btn-gen.secondary { background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border); font-size: 16px; flex: 0.8; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .btn-watch { flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 15px; text-transform: uppercase; background: var(--accent); color: #000; }

        .card-actions { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-action { 
            flex: 1; padding: 15px; border-radius: 18px; border: 1px solid var(--border); 
            background: transparent; color: var(--text-secondary); font-size: 24px;
            font-weight: 700; transition: all 0.2s; max-width: 80px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-action.ban:hover, .btn-action.ban.active { border-color: var(--highlight-red); background: rgba(231, 76, 60, 0.15); color: var(--highlight-red); transform: scale(1.05); }
        .btn-action.fav:hover, .btn-action.fav.active { border-color: var(--highlight-green); background: rgba(46, 204, 113, 0.15); color: var(--highlight-green); transform: scale(1.05); }

        .btn-watch-later {
            width: 54px;
            flex-shrink: 0;
            border-radius: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-watch-later:active {
            transform: scale(0.95);
        }

        /* Активное состояние кнопки (когда добавлено) - Синий цвет */
        .btn-watch-later.active {
            background: #3498db; /* Синий */
            color: #ffffff;
            border-color: #3498db;
        }

        /* Стиль тега в списке "Смотреть позже" (Синий) */
        .catalog-item.wl-active { 
            background: rgba(52, 152, 219, 0.2); 
            color: #3498db; 
            border: 1px solid #3498db; 
        }

        /* Related & Tags */
        .related-section { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 35px !important;
            margin-bottom: 20px; 
            text-align: center; 
        }
        .related-tags {
            display: flex;
            flex-wrap: wrap;       /* Разрешаем перенос на следующую строку */
            justify-content: center; /* Центрируем теги */
            gap: 10px;             /* Расстояние между тегами */
            width: 100%;
        }
        .related-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; opacity: 0.8; }
        .related-item-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; color: var(--text-main); transition: 0.2s; }

        /* Utility */
        .visually-hidden { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .fade-hidden { opacity: 0; transform: translateY(10px); transition: opacity 0.5s ease, transform 0.5s ease; display: none; }
        .fade-visible { opacity: 1; transform: translateY(0); display: flex; }

        /* --- ИКОНКИ ИНТЕНСИВНОСТИ --- */
        .intensity-selector-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px; /* Отступы по бокам для иконок */
            margin-top: 5px;
        }

        .intensity-btn {
            width: 45px;  /* Размер иконки */
            height: 45px;
            object-fit: contain;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            
            /* Неактивное состояние: серое и полупрозрачное */
            filter: grayscale(100%);
            opacity: 0.3; 
        }

        /* Активное состояние: цветное, яркое, чуть увеличено */
        .intensity-btn.active {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.15);
        }

        /* --- ОБНОВЛЕНИЕ ДЛЯ СТАТУСА ПОДПИСКИ --- */
        #settings-plan-status {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-secondary);
        }
        /* Цвет для PRO/BEAST */
        #settings-plan-status.premium {
            color: var(--accent) !important;
            font-weight: 800;
        }

        #intensity-value-label {
            font-size: 14px; 
            font-weight: 800; 
            text-transform: uppercase; 
            margin-right: 2px;
            
            /* По умолчанию скрыт и смещен немного вниз */
            opacity: 0;
            transform: translateY(5px);
            
            /* Плавная анимация для всех свойств */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Класс для показа */
        #intensity-value-label.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* =========================================
        6. IOS SETTINGS & COMPONENTS
        ========================================= */
        .ios-group {
            background: var(--ios-card); border-radius: 22px; overflow: hidden; margin-bottom: 20px; width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .ios-header {
            margin: 25px 0 8px 20px; font-size: 13px; color: var(--ios-header);
            text-transform: uppercase; display: flex; justify-content: space-between;
        }
        .ios-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; background: var(--ios-card); min-height: 44px; position: relative;
        }
        .ios-row:not(:last-child)::after {
            content: ""; 
            position: absolute; 
            bottom: 0; 
            left: 48px; 
            right: 16px;
            height: 1px;
            background-color: var(--ios-separator); 
            transform: scaleY(0.5);
        }
        .ios-row.clickable { cursor: pointer; transition: background 0.2s; }
        .ios-row.clickable:active { background: var(--nav-bg); }
        
        .capsule-btn {
            background: var(--ios-card); border-radius: 22px; padding: 5px 20px;
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            min-height: 55px; cursor: pointer; transition: transform 0.2s, background 0.2s; border: none;
        }
        .capsule-btn:active { transform: scale(0.98); background: var(--nav-bg); }
        .capsule-btn span { font-weight: 600; font-size: 16px; color: var(--text-main); }
        .capsule-btn select { font-weight: 700; color: var(--accent) !important; font-size: 17px; background: transparent; border: none; text-align: right; appearance: none; -webkit-appearance: none; }

        .platform-select, .ios-row select {
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
            border: none;
            font-size: 16px;
            color: var(--text-secondary);
            text-align: right;
            direction: rtl;
            padding-right: 0;
            font-weight: 400;
            cursor: pointer;
            font-family: inherit;
        }

        /* Account Elements */
        .sync-date { font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 10px; margin-bottom: 20px; opacity: 0.6; }
        
        /* Switches & Sliders */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; margin: 0 5px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .range-slider { width: 100%; cursor: pointer; }
        .intensity-labels { display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px; }
        .intensity-label { font-size: 12px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; }
        .intensity-label.active { color: var(--accent); font-weight: 700; }

        /* Accordion */
        .accordion { background: transparent !important; }
        .accordion-head { padding: 16px !important; font-size: 17px !important; color: var(--text-main) !important; display: flex; justify-content: space-between; }
        .accordion-body { display: none; padding: 0 16px 16px; flex-wrap: wrap; gap: 8px; }
        .accordion-body.open { display: flex; }
        
        /* Tags */
        .capsule-accordion-head { background: var(--card-bg); border: 1px solid var(--border); border-radius: 50px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; width: auto; max-width: 200px; margin: 0 auto 15px auto; cursor: pointer; font-size: 13px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; }

        /* =========================================
        7. MOBILE BOTTOM NAV
        ========================================= */
        .bottom-nav {
            display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px; height: 65px;
            background: var(--ios-card); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px;
            z-index: 9999; padding: 0 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            justify-content: space-between;
        }
        body.light-theme .bottom-nav { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--text-secondary); flex: 1; cursor: pointer; transition: all 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active .nav-icon { transform: translateY(-2px); color: var(--accent); }
        .nav-icon { font-size: 22px; margin-bottom: 2px; transition: transform 0.2s; }

        .nav-icon-img {
            height: 24px;
            width: 24px;
            object-fit: contain;
            margin-bottom: 4px;
            transition: filter 0.3s, transform 0.2s;
            
            filter: invert(1);
        }

        /* Светлая тема */
        body.light-theme .nav-icon-img {
            filter: invert(0);
            opacity: 0.6;
        }

        /* Активное состояние (светлая тема) */
        body.light-theme .nav-item.active .nav-icon-img {
            filter: invert(0);
            opacity: 1;
        }

        .nav-item.active .nav-icon-img {
            transform: scale(1.1);
        }

        /* =========================================
        8. MODALS (GENERAL)
        ========================================= */
        .modal-overlay {
            /* Фиксация позиции и слоя */
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important;
            z-index: 20000 !important;
            
            /* Фон и блюр */
            background: rgba(0, 0, 0, 0.6) !important;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            
            /* Flex для позиционирования окна */
            display: flex !important;
            flex-direction: column !important;
            
            /* СКРЫТО ПО УМОЛЧАНИЮ (Анимация через opacity) */
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            transition: opacity 0.3s ease, visibility 0.3s !important;
        }

        /* СОСТОЯНИЕ "ОТКРЫТО" - ЭТОТ КЛАСС ДОБАВЛЯЕТ JS */
        .modal-overlay.open {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        /* 2. САМО ОКНО (MODAL) */
        .modal {
            /* Сброс старых размеров и отступов */
            margin: 0 !important;
            max-width: none !important;
            max-height: none !important;
            position: relative !important;
            
            /* Фон и тени */
            background: var(--sidebar-bg) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            
            /* Плавная анимация появления */
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1) !important;
        }

        /* 3. ШАПКА (HEADER) */
        .modal-header {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important; /* Заголовок по центру */
            min-height: 60px !important;
            padding: 15px 20px !important;
            border-bottom: none !important;     /* Убираем разделитель */
            position: relative !important;
            
            font-size: 18px !important;
            font-weight: 800 !important;
            color: var(--text-main) !important;
            text-transform: uppercase !important;
        }

        /* Кнопка закрытия (Крестик) - Всегда справа */
        .modal-header > span:last-child {
            position: absolute !important;
            right: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            
            width: 32px !important; height: 32px !important;
            border-radius: 50% !important;
            background: rgba(128, 128, 128, 0.15) !important;
            color: var(--text-secondary) !important;
            
            align-items: center !important; justify-content: center !important;
            font-size: 16px !important; cursor: pointer !important;
            z-index: 10 !important;
        }

        /* 4. ТЕЛО (BODY) */
        .modal-body {
            flex: 1 !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            padding: 0 20px 30px 20px !important;
        }

        #sub-status-btn {
            background: var(--card-bg); 
            border: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }

       @media (min-width: 769px) {
            .modal-overlay {
                justify-content: center !important;
                align-items: center !important;
            }

            .modal {
                width: 550px !important;       /* Фиксированная ширина */
                max-width: 90% !important;
                height: auto !important;
                max-height: 85vh !important;   /* Не на весь экран */
                
                border-radius: 24px !important;
                
                /* Анимация: Легкое увеличение */
                transform: scale(0.95) !important;
            }

            .modal-overlay.open .modal {
                transform: scale(1) !important;
            }
        }

        /* --- МОБИЛЬНАЯ ВЕРСИЯ (Узкий экран) --- */
        @media (max-width: 768px) {
            .modal-overlay {
                justify-content: flex-end !important; /* Прижать к низу */
                align-items: center !important;
            }

            .modal {
                width: 100% !important;
                height: auto !important;
                max-height: 85vh !important; /* Шторка не на весь экран */
                min-height: 300px !important;
                
                /* Скругление только сверху */
                border-radius: 28px 28px 0 0 !important;
                border-bottom: none !important;
                border-left: none !important;
                border-right: none !important;
                
                /* Учет "челки" iPhone снизу */
                padding-bottom: env(safe-area-inset-bottom) !important;
                
                /* Анимация: Выезд снизу */
                transform: translateY(100%) !important;
            }

            .modal-overlay.open .modal {
                transform: translateY(0) !important;
            }

            /* "Ручка" шторки (серая полоска) */
            .modal-header::before {
                content: '';
                position: absolute;
                top: 8px; left: 50%;
                transform: translateX(-50%);
                width: 40px; height: 4px;
                background: rgba(128, 128, 128, 0.3);
                border-radius: 10px;
                pointer-events: none;
            }
            
            /* Сдвигаем заголовок чуть ниже из-за ручки */
            .modal-header {
                padding-top: 25px !important;
            }
        }

        #modal-stats-body {
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important; 
            min-height: 0 !important;
        }


        /* Catalog Search */
        .modal-search-box { width: 100%; margin-bottom: 15px; position: relative; }
        .modal-search-input { width: 100%; background: var(--ios-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; font-size: 16px; color: var(--text-main); }
        .modal-suggestions { display: none; flex-direction: column; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; margin-top: 5px; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .suggestion-row { padding: 10px 15px; border-bottom: 1px solid var(--border); font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; }
        
        .catalog-item { padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: default; display: inline-flex; align-items: center; gap: 8px; margin: 3px; }
        .catalog-item.active { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
        .catalog-item.ban-active { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
        .catalog-remove-btn { cursor: pointer; opacity: 0.6; padding: 0 4px; }

        /* =========================================
        9. STATS & CHARTS
        ========================================= */
        .axis-label-y { position: absolute; left: -15px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 10px; color: var(--text-secondary); }
        .axis-label-x-title { position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-secondary); }
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 250px; width: 100%; border-bottom: 1px solid var(--border); border-left: 1px solid var(--border); position: relative; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; flex: 1; height: 100%; position: relative; }
        .chart-bar.secondary { background: var(--text-secondary); margin-right: 2px; }
        .bar-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 2px; height: 100%; }
        .chart-value-y {
            font-size: 10px; 
            font-weight: 700; 
            color: var(--text-main);
            margin-bottom: 4px; 
            text-align: center;
            width: 100%;
        }

        .stats-tf-capsule, .stats-nav-capsule { background: var(--ios-card); border: 1px solid var(--border); border-radius: 50px; display: flex; padding: 3px; width: 100%; }
        .stats-tf-capsule { height: 36px; margin-bottom: 8px; }
        .stats-nav-capsule { height: 50px; }
        .stats-tf-item, .stats-nav-item { flex: 1; display: flex; align-items: center; justify-content: center; border-radius: 40px; font-size: 11px; font-weight: 700; color: var(--text-secondary); cursor: pointer; text-transform: uppercase; }
        .stats-tf-item.active, .stats-nav-item.active { background: var(--nav-bg); color: var(--text-main); }

        /* =========================================
        10. SUBSCRIPTION MODAL (RESPONSIVE)
        ========================================= */
        .plan-card {
            flex: 1 !important;
            min-width: 0 !important; 
            background: var(--ios-card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 20px !important;
            padding: 20px !important;
            margin: 0 !important; 
        }
        .plan-card {
            position: relative !important; 
            overflow: hidden !important;  
            display: flex !important;
            flex-direction: column !important;
            background: var(--ios-card) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05) !important;
        }
        .plan-card.pro { border-color: #ff9900; box-shadow: 0 0 20px rgba(255, 153, 0, 0.1); }
        .plan-card.beast { border-color: #9b59b6; background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), transparent); box-shadow: 0 0 20px rgba(155, 89, 182, 0.15); }
        
        .plan-title { font-size: 22px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; }
        .plan-card.pro .plan-title { color: #ff9900; }
        .plan-card.beast .plan-title { color: #9b59b6; }
        .plan-price { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 15px; }
        
        .plan-features { list-style: none; padding: 0; margin: 0 0 20px 0; }
        .plan-features li { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 20px; position: relative; }
        .plan-features li::before { content: "•"; position: absolute; left: 0; color: var(--text-main); }
        
        .plan-btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; text-transform: uppercase; font-size: 14px; margin-top: auto; }
        .plan-btn.current { background: var(--nav-bg); color: var(--text-secondary); opacity: 0.7; }
        .plan-btn.pro-btn { background: #ff9900; color: #000; box-shadow: 0 4px 15px rgba(255, 153, 0, 0.3); }
        .plan-btn.beast-btn { background: #9b59b6; color: #fff; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); }

        /* Mobile Default Layout for Plans */
        .plans-container {
            display: flex !important;
            flex-direction: column !important; 
            gap: 15px !important;
            padding-bottom: 20px !important;
        }
        #modal-sub-overlay .modal { width: 90%; max-width: 400px; max-height: 90vh; }

        /* =========================================
        11. Tinder Logic
        ========================================= */
        .tinder-actions {
            margin-top: auto; 
            padding-top: 10px;
            border-top: none;
            width: 100%;
            display: flex;
            gap: 10px;
        }

        .result-description {
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-secondary);
        }

        .related-section {
            margin-top: 5px !important;
            margin-bottom: 15px;
        }

        .btn-tinder {
            flex: 1;
            padding: 18px 10px;
            border-radius: 50px; /* Полностью круглые края */
            border: none;
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-tinder:active { transform: scale(0.95); }

        .btn-pass {
            background:transparent;
            border: 2px solid var(--highlight-red);
            color: var(--highlight-red);
        }
        
        .btn-like {
            background: var(--highlight-green) !important;
            color: #fff !important; /* Белый текст для контраста */
            border: 2px solid var(--highlight-green) !important;
        }

        .btn-like:active, .btn-like.active-state {
            background: rgba(46, 204, 113, 0.2) !important;
            color: var(--highlight-green) !important;
        }

        /* === 3. КНОПКА НАЗАД (UNDO) === */
        .undo-container {
            margin-top: 5px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .btn-undo {
            width: auto !important;
            height: auto !important;
            border-radius: 50px !important;
            padding: 8px 24px !important; 
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 13px !important;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-undo:active {
            background: var(--nav-bg);
            transform: scale(0.96);
        }

        /* === 4. СВАЙПЫ (Карточка) === */
        .card {
            position: relative; 
            overflow: hidden;
            touch-action: none; /* Важно для свайпов на мобильных */
            transform-origin: 50% 100%;
            will-change: transform, opacity;
            justify-content: space-between;
            margin-bottom: 10px !important; 
        }

        .card-reject {
            background: rgba(231, 76, 60, 0.9) !important; /* Красный */
            border-color: #c0392b !important;
            filter: blur(5px) grayscale(0.5); /* Блюр */
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.6) !important;
        }

        .card-like {
            background: rgba(46, 204, 113, 0.9) !important; /* Зеленый */
            border-color: #27ae60 !important;
            filter: blur(5px) grayscale(0.5); /* Блюр */
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6) !important;
        }

        /* --- 3. Начальная кнопка (Капсула внутри карточки) --- */
        #start-btn-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: auto;
            padding-bottom: 15px;
            
            flex-shrink: 0 !important; 
            min-height: 70px;
            
            position: relative;
            z-index: 30; 
        }

        .btn-start-capsule {
            /* Градиент темы: Слева светлее, Справа основной цвет */
            background: linear-gradient(to right, var(--accent-light), var(--accent));
            
            color: white; /* Текст всегда белый для контраста */
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 18px 40px;
            border-radius: 50px;
            border: none;
            
            /* Свечение (тень) в цвет темы */
            box-shadow: 0 10px 40px -5px var(--accent);
            
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            
            flex-shrink: 0; 
            z-index: 30;
        }

        .btn-start-capsule:active {
            transform: scale(0.95);
            /* Уменьшаем тень при нажатии */
            box-shadow: 0 5px 20px -5px var(--accent);
        }

        /* --- 4. Анимация "Вишенка на торте" (Staggered Fade Up) --- */
        @keyframes fadeInUpSmooth {
            from {
                opacity: 0;
                transform: translateY(20px);
                filter: blur(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }
        }

        /* Базовый класс для элементов, которые должны появляться плавно */
        .stagger-item {
            opacity: 0; /* Скрыты по умолчанию */
            animation: fadeInUpSmooth 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* Задержки (Очередь появления) */
        .delay-1 { animation-delay: 0.1s; } /* Заголовок (почти сразу после вспышки) */
        .delay-2 { animation-delay: 0.3s; } /* Описание */
        .delay-3 { animation-delay: 0.5s; } /* Похожие */
        .delay-4 { animation-delay: 0.7s; } /* Кнопки (Watch/Like) */
        .delay-5 { animation-delay: 1.0s; } /* Объяснение (Вишенка) */

        /* Фикс для заголовка (слота), чтобы он не конфликтовал со скриптом барабана */
        .slot-reel .slot-item.final-result {
            opacity: 0;
            animation: fadeInUpSmooth 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards 0.1s;
        }

        /* Активные состояния для новых кнопок */
        .btn-tinder.active-state {
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.3);
            transform: scale(0.98);
        }
        .btn-like.active-state { 
            background: #fff !important; 
            color: var(--accent) !important; 
            border-color: #fff !important;
        }
        .btn-pass.active-state { 
            background: var(--highlight-red) !important; 
            color: #fff !important; 
        }

        .restore-anim { animation: flyInLeft 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* 1. Скрываем старые кнопки по ID, а не по классу, чтобы не задеть кнопку старта */
        #btn-gen, #btn-similar { 
            display: none !important; 
        }

        /* 2. Принудительно показываем контейнер старта, если у него нет класса hidden-initial */
        #start-btn-container:not(.hidden-initial) {
            display: flex !important;
        }

        /* 3. Гарантируем, что новые кнопки будут Flex, когда мы уберем скрывающий класс */
        #main-actions:not(.hidden-initial) {
            display: flex !important;
        }

        .hidden-initial, .visually-hidden {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        #start-btn-container {
            transition: opacity 0.3s ease;
        }
        
        /* Адаптация под мобильные */
        @media (max-width: 768px) {
            
            /* 1. ГЛОБАЛЬНЫЕ СКРЫТИЯ */
            .sidebar, .tinder-actions, .btn-group, .undo-container, .badge-tooltip { display: none !important; }
            .mobile-header, .bottom-nav, .top-gradient-mask, .bottom-gradient-mask { display: flex !important; }
            .main-content { padding: 0 !important; }

            /* 2. КОНТЕЙНЕР */
            #tab-home .center-wrapper {
                height: 100vh !important;
                height: 100dvh !important;
                padding-top: 65px !important; 
                padding-bottom: 90px !important; 
                display: flex;
                flex-direction: column;
                justify-content: flex-start !important;
                overflow: hidden !important; 
                width: 100% !important;
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* 3. КАРТОЧКА */
            .card, .card.has-results {
                flex-grow: 1 !important;
                height: 100% !important;
                margin-bottom: 0 !important;
                width: 100% !important;
                padding: 10px 5px !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
                overflow: hidden !important;
            }

            /* === ВНУТРЕННИЕ БЛОКИ === */
            .card > div:nth-child(1) { flex: 0 0 auto !important; min-height: 25px !important; } /* Бейджи */
            
            /* ЦЕНТР (Возвращено space-evenly) */
            .card > div:nth-child(2) {
                flex: 1 1 auto !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-evenly !important; 
                align-items: center !important;
                overflow: hidden !important; 
                padding: 10px 0 !important;
            }

            .card > div:last-child { flex: 0 0 auto !important; margin-top: 5px !important; width: 100%; } /* Кнопки */

            /* --- ЭЛЕМЕНТЫ КОНТЕНТА --- */
            
            .slot-window {
                width: 100%;
                height: auto !important;
                flex: 0 1 auto !important;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .slot-item { 
                font-size: clamp(26px, 9vw, 48px) !important;
                line-height: 1.1 !important;
            }

            /* === ОПИСАНИЕ === */
             #result-desc {
                max-height: none !important; 
                overflow-y: visible !important;
                
                flex-shrink: 0 !important; 
                
                font-size: 15px !important;
                line-height: 1.35 !important;
                margin: 10px 0 15px 0 !important;
                white-space: normal !important; 
                
                display: -webkit-box;
                -webkit-line-clamp: 6; /* Показать максимум 6 строк */
                -webkit-box-orient: vertical;
                overflow: hidden !important; 
            }
            
            /* === ПОХОЖИЕ (ТЕГИ) === */
            .related-section {
                margin-top: 0 !important; /* Отступ уже задан в margin-bottom описания */
                margin-bottom: 5px !important;
                width: 100%;
                display: flex !important;
                flex-direction: column;
                align-items: center;
            }
            
            .related-tags { 
                display: flex !important;
                flex-wrap: nowrap !important; /* Запрещаем перенос строк */
                overflow-x: auto !important;  /* Разрешаем горизонтальный скролл */
                justify-content: flex-start !important; /* Выравнивание по началу */
                width: 100%;
                padding-bottom: 5px;
                gap: 6px !important;
                
                scrollbar-width: none; 
                -ms-overflow-style: none;
                
                mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
                -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            }
            .related-tags::-webkit-scrollbar { 
                display: none; 
            }
            
            .related-item-btn { 
                flex-shrink: 0 !important; /* Запрещаем кнопкам сжиматься */
                white-space: nowrap !important; 
                font-size: 12px; 
                padding: 8px 14px; 
            }

            /* --- КНОПКИ --- */
            .tinder-nav-row {
                gap: 8px !important; margin-bottom: 5px !important;
                justify-content: space-between !important; padding: 0 5px !important;
            }
            .t-circle-btn.small { width: 38px !important; height: 38px !important; font-size: 18px !important; }
            .t-circle-btn.medium { width: 50px !important; height: 50px !important; font-size: 24px !important; }
            .t-circle-btn.large { width: 64px !important; height: 64px !important; font-size: 28px !important; }

            #start-btn-container { min-height: 50px !important; }
            .btn-start-capsule { padding: 12px 30px !important; font-size: 16px !important; }

            #tab-settings .center-wrapper, #tab-account .center-wrapper { 
                padding: 40px 15px 120px 15px !important; height: auto !important; display: block !important;
            }
        }

        /* Зеленый тег (Лайк) */
        .onb-tag.like {
            background: rgba(46, 204, 113, 0.2); 
            color: #2ecc71; 
            border: 1px solid #2ecc71;
        }

        /* Красный тег (Дизлайк) */
        .onb-tag.dislike {
            background: rgba(231, 76, 60, 0.2); 
            color: #e74c3c; 
            border: 1px solid #e74c3c;
        }

        /* Общий стиль */
        .onb-tag {
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            animation: popIn 0.3s ease;
            cursor: default;
        }

        #tab-settings #mobile-mode-mount {
            margin-top: 0 !important;
            margin-bottom: 20px !important;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        #tab-settings .mode-capsule-btn {
            width: 100%; 
            max-width: 200px;
            justify-content: center;
            background: var(--ios-card);
            height: 44px;
        }

        .capsule-trigger {
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px; /* Полная капсула */
            padding: 8px 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            margin: 0 auto; /* Центрируем кнопку */
        }
        
        .capsule-trigger:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.98);
        }

        body.light-theme .capsule-trigger {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        /* === 4. ИКОНКА ЧАСОВ === */
        .t-circle-btn.wl {
            font-size: 26px; 
            padding-top: 2px; 
        }

        /* =========================================
        12. OTHER COMPONENTS (Badges, History)
        ========================================= */

        .warning-badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; color: #fff; cursor: help; }
        .badge-extreme { background: var(--highlight-red); }
        .badge-lgbt { background: #9b59b6; }
        .badge-niche { background: #34495e; }
        .badge-wrapper { display: flex; justify-content: center; gap: 6px; margin-bottom: 2px; margin-top: 5px; width: 100%; position: relative; z-index: 5; }
        
        .badge-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: #fff; padding: 12px; border-radius: 14px; font-size: 13px; line-height: 1.4;
            width: 220px; text-align: left; pointer-events: none; opacity: 0; transition: opacity 0.2s;
            margin-bottom: 10px; border: 1px solid var(--border); z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .warning-badge:hover .badge-tooltip { opacity: 1; pointer-events: auto; }

        .history-item-ios {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--ios-card); font-size: 16px; color: var(--text-main);
            position: relative; cursor: pointer; transition: background 0.2s;
        }
        .history-item-ios:active { background: var(--nav-bg); }
        .history-item-ios:not(:last-child)::after {
            content: ""; 
            position: absolute; 
            bottom: 0; 
            left: 16px; 
            right: 16px;
            height: 1px;
            background-color: var(--ios-separator); 
            transform: scaleY(0.5);
        }

        /* Onboarding & Age Gate */
        .onb-tag { background: var(--accent); color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #age-gate .logo { font-size: 40px; margin-bottom: 20px; }
        #age-gate .logo-img { height: 70px; margin-right: 10px; }

        .mobile-header {
            display: none; position: fixed; top: calc(10px + env(safe-area-inset-top)); 
            left: 50%; transform: translateX(-50%); width: auto; min-width: 260px; max-width: 90%;
            background: var(--ios-card) !important; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border) !important; border-radius: 35px; z-index: 9999;
            padding: 12px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-main);
        }
        body.light-theme .mobile-header { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.1); }
        .mobile-header .logo { font-size: 20px; margin-bottom: 0; }
        .mobile-header .logo-img { height: 40px; }

        /* === 12. PREMIUM STATS === */
        .locked-feature {
            position: relative;
            opacity: 0.5;
            pointer-events: none;
            filter: blur(2px);
        }
        .lock-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            pointer-events: auto; /* Чтобы клик проходил на оверлей */
        }
        .lock-badge {
            background: var(--accent); color: #000;
            padding: 5px 10px; border-radius: 12px;
            font-weight: 800; font-size: 12px; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* === WRAPPED / SUMMARY UI (Spotify Style) === */
        .wrapped-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 25000; background: #000;
            display: none; flex-direction: column;
        }
        .wrapped-overlay.active { display: flex; animation: fadeIn 0.3s ease; }

        /* Динамические фоны для слайдов */
        .wrapped-slide {
            flex: 1; display: none; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 40px; text-align: center;
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
        }
        .wrapped-slide.active-slide { display: flex; }

        /* Градиенты для разных настроений */
        .bg-fire { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); }
        .bg-dark { background: linear-gradient(-45deg, #000000, #434343, #1a1a1a); }
        .bg-toxic { background: linear-gradient(-45deg, #11998e, #38ef7d, #000000); }
        .bg-passion { background: linear-gradient(-45deg, #8E2DE2, #4A00E0, #ff00cc); }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .wrapped-big-text {
            font-size: clamp(40px, 10vw, 80px);
            font-weight: 900; line-height: 1; margin-bottom: 20px;
            color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }
        .wrapped-sub-text {
            font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.9);
            line-height: 1.5; max-width: 400px;
        }
        .wrapped-stat-box {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px;
            margin: 20px 0; border: 1px solid rgba(255,255,255,0.3);
        }
        .wrapped-highlight { color: #ffe600; font-weight: 800; }

        .wrapped-nav-area {
            position: absolute; top: 0; height: 100%; width: 30%; z-index: 10;
        }
        .nav-left { left: 0; }
        .nav-right { right: 0; }
        .wrapped-close {
            position: absolute; top: 20px; right: 20px;
            font-size: 24px; color: rgba(255,255,255,0.5); z-index: 30; cursor: pointer;
        }

        /* Анимация заполнения бара */
        @keyframes fillBarAnim {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* Класс для запуска анимации */
        .wrapped-progress-fill.animating {
            animation: fillBarAnim linear forwards;
        }

        /* Класс для паузы (добавляется JS-ом при удержании) */
        .wrapped-overlay.paused .wrapped-progress-fill {
            animation-play-state: paused !important;
        }

        /*  финальная карточка */
        .sum-row.detail-row {
            font-size: 11px; 
            color: var(--text-secondary);
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        #share-header-overlay {
            display: none; 
            width: 100%;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .share-qr-box {
            background: #fff;
            padding: 5px;
            border-radius: 8px;
            height: 60px;
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-logo-text {
            font-weight: 900;
            font-size: 24px;
            color: #fff;
            line-height: 1;
        }
        .share-logo-text span {
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .share-caption {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* Стиль для иконки Share в шапке модалки */
        .share-icon-img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            filter: invert(1); /* Белая для темной темы */
            opacity: 0.8;
        }

        /* Для светлой темы */
        body.light-theme .share-icon-img {
            filter: invert(0); /* Черная */
        }

        /* Контейнер для генерации скриншота (скрыт от глаз, но виден для скрипта) */
        #export-stats-container {
            position: fixed;
            top: 0;
            left: -9999px; /* Убираем за пределы экрана */
            z-index: -1;
            width: 360px; /* Фиксированная ширина как у Wrapped */
            /* Используем стили Wrapped карточки */
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: none;
        }

        /* Принудительные стили для графика внутри скриншота, чтобы он влез */
        #export-stats-container .chart-container, 
        #export-stats-container .chart-wrapper {
            height: 180px !important; 
            border: none !important;
            margin: 0 !important;
        }

        /* --- Кнопка Share в Wrapped (Круглая) --- */
        .btn-round-share {
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.15); 
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-round-share:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }
        .btn-round-share img {
            width: 24px; 
            height: 24px; 
            filter: invert(1); /* Белая иконка */
        }

        /* --- QR Header для скриншотов --- */
        /* Этот блок скрыт в UI, но появляется на картинке */
        .screenshot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
            background: transparent;
        }

        .screenshot-logo-area {
            display: flex;
            flex-direction: column;
        }

        .screenshot-logo {
            font-size: 28px;
            font-weight: 900;
            color: #fff;
            line-height: 1;
        }
        .screenshot-logo span {
            color: var(--accent) !important; 
            background: none !important; 
            -webkit-text-fill-color: initial !important;
        }

        .screenshot-caption {
            font-size: 12px;
            text-transform: uppercase;
            color: #ccc;
            letter-spacing: 2px;
            margin-top: 5px;
            font-weight: 600;
        }

        .screenshot-qr {
            background: #fff;
            padding: 5px;
            border-radius: 10px;
            height: 70px;
            width: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wrapped-progress-container {
            position: absolute; 
            top: 15px; 
            left: 0; 
            width: 100%;
            padding: 0 15px; 
            display: flex; 
            gap: 4px; 
            z-index: 9999; /* Поверх всего */
            pointer-events: none; 
        }
        .wrapped-progress-bar {
            height: 3px; 
            flex: 1; 
            background: rgba(255,255,255,0.3);
            border-radius: 2px; 
            overflow: hidden;
        }
        .wrapped-progress-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            box-shadow: 0 0 8px rgba(255,255,255,0.8);
        }

        /* --- ДИЗАЙН СТАТИСТИКИ (CARD UI) --- */
        .stats-card-ui {
            background: var(--ios-card); /* Или темный фон как в Wrapped */
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        /* Адаптация заголовка внутри карточки */
        .stats-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 5px;
        }

        .stats-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 700;
        }

        /* QR код внутри статистики */
        .stats-qr-box {
            background: #fff;
            padding: 4px;
            border-radius: 8px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* --- СТИЛИ ДЛЯ ЛЕГЕНДЫ (В интерфейсе) --- */
        .stats-legend-row {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-dot {
            width: 8px; 
            height: 8px; 
            border-radius: 2px;
        }

        /* --- СТИЛЬ ДЛЯ ЭКСПОРТА (СКРИНШОТА) --- */
        /* Это то, как будет выглядеть картинка */
        #export-stats-card {
            position: fixed;
            left: -9999px; /* Скрываем за экраном */
            top: 0;
            z-index: -9999;
            
            width: 375px; /* Фиксированная ширина как у мобильника */
            background: var(--sidebar-bg); /* Темный фон */
            border: 1px solid var(--border);
            border-radius: 24px; /* Закругления */
            padding: 30px; /* Отступы внутри */
            
            display: flex;
            flex-direction: column;
            gap: 20px;
            font-family: var(--font-main);
        }

        /* Логотип в экспорте */
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(128,128,128,0.2);
            padding-bottom: 20px;
        }

        /* Убедимся, что при экспорте карточка ведет себя нормально */
        .export-clone-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            z-index: -100;
            /* Фиксированная ширина для красивой картинки, чтобы не была узкой */
            width: 600px !important; 
            max-width: none !important;
            background: #12000b; /* Фон подложки, если прозрачность глючит */
            padding: 40px !important; /* Больше отступов для красоты */
            border-radius: 0 !important; /* Квадратные края для картинки или скругленные, как угодно */
        }

        /* Принудительно растягиваем внутреннюю карточку при экспорте */
        .export-clone-container .sum-card-new {
            width: 100% !important;
            max-width: 100% !important;
            box-shadow: none !important;
            margin: 0 !important;
        }

        /* Фикс для переносов в психотипе */
        .sum-stat-box {
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
        }

        /* === STATS UPDATE === */
        /* Контейнер графика */
        .chart-wrapper {
            flex-shrink: 0 !important;
            height: 220px !important; /* Фиксированная высота */
            margin-bottom: 20px !important;
            width: 100% !important;
        }

        /* Скролл-контейнер для предпочтений */
        .chart-scroll-view {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            height: 100%;
            align-items: flex-end;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            padding-bottom: 5px; /* Отступ для скролла */
        }
        .chart-scroll-view::-webkit-scrollbar { display: none; }

        /* Колонка предпочтений (5 + немного 6-ая колонка) */
        .pref-col {
            min-width: 17%; 
            max-width: 17%;
            height: 100%; 
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 0 4px;
        }

        /* Колонка активности */
        .act-col {
            min-width: 45px; 
            margin-right: 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            height: 100%;
        }

        /* Контейнер для трех столбиков */
        .act-bars-group {
            display: flex;
            align-items: flex-end;
            gap: 3px; /* Расстояние между столбиками */
            height: 70%; /* Высота зоны столбиков */
            width: 100%;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(128,128,128,0.1);
        }

        .act-bar {
            flex: 1;
            border-radius: 2px 2px 0 0;
            min-height: 2px;
            transition: height 0.3s ease;
        }

        /* Сами бары */
        .chart-bar {
            width: 100%; 
            /* Градиент сверху вниз: от светлого акцента к основному цвету */
            background: linear-gradient(180deg, var(--accent-light) 0%, var(--accent) 100%) !important;
            border-radius: 6px 6px 0 0; /* Скругляем только верх */
            transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 4px;
            position: relative;
            margin: 0;
            /* Легкое свечение для красоты */
            box-shadow: 0 -2px 10px rgba(var(--accent), 0.3); 
        }

        /* Подписи под графиком */
        .chart-label-x {
            margin-top: 5px;
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .act-values-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 4px;
            padding: 0 2px;
        }

        .act-val {
            font-size: 8px;
            font-weight: 700;
            text-align: center;
            flex: 1;
        }

        .chart-label-x {
            margin-top: 4px;
            font-size: 9px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Цифры для активности (ПОД графиком) */
        .act-values {
            display: flex;
            gap: 5px;
            font-size: 9px;
            font-weight: 700;
            margin-top: 2px;
            color: var(--text-main);
        }

        /* === 13. PAYMENT MODAL STYLES === */
        .pay-desc {
            padding: 15px 20px 10px;
            color: var(--text-secondary);
            font-size: 13px;
            text-align: center;
            line-height: 1.4;
        }

        /* Секция промокода */
        .promo-container {
            margin: 10px 15px 20px 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .promo-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            margin-left: 5px;
        }

        .promo-input-group {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .promo-input {
            flex: 1;
            background: var(--ios-bg); /* Цвет фона как у страницы */
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            font-size: 15px;
            color: var(--text-main);
            outline: none;
            transition: border-color 0.2s;
        }

        .promo-input:focus {
            border-color: var(--accent);
        }

        .promo-btn {
            width: 44px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        .promo-btn:active {
            transform: scale(0.95);
        }

        /* === 14. LOGIN MODAL === */
        .auth-benefits {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .auth-benefits li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-main);
        }

        .auth-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--nav-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .auth-note {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 15px;
            line-height: 1.4;
            opacity: 0.7;
        }

        .btn-google {
            width: 100%;
            background: #FFFFFF;
            color: #1f1f1f;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 14px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-google:active { transform: scale(0.98); }

        /* 15. SYNC MODAL STYLES */
        .sync-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .sync-stat-item.full-width {
            grid-column: span 2;
            width: 100%;
            
            display: flex;
            flex-direction: column;
            align-items: center !important; 
            justify-content: center !important;
            text-align: center !important;
            
            padding: 20px 15px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            background: var(--ios-card);
            border-radius: 16px;
        }

        .sync-stat-item.full-width:active {
            background: var(--nav-bg);
            transform: scale(0.98);
        }

        .sync-stat-item {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .sync-stat-val {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .sync-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Анимация вращения для кнопки синхронизации */
        @keyframes spinIcon { 100% { transform: rotate(360deg); } }
        .spinning-icon { animation: spinIcon 1s linear infinite; display: inline-block; }


        /* Fetish Wrapped */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .wrapped-lock-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px dashed var(--border);
        }
        .wrapped-lock-title {
            font-size: 16px; font-weight: 800; margin-bottom: 5px;
            background: linear-gradient(45deg, #FF9900, #9B59B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }
        .wrapped-lock-desc {
            font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;
        }
        .w-progress-track {
            height: 8px; width: 100%; background: rgba(255,255,255,0.1);
            border-radius: 4px; overflow: hidden; margin-bottom: 8px;
        }
        .w-progress-fill {
            height: 100%; background: linear-gradient(90deg, #FF9900, #9B59B6);
            width: 0%; transition: width 0.5s ease;
        }
        .w-progress-text {
            font-size: 11px; font-weight: 700; color: var(--text-main);
        }

        /* WRAPPED ARCHIVE (Вкладка истории) */
        .wrapped-archive-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: var(--ios-card); margin-bottom: 1px;
            cursor: pointer; position: relative;
        }
        .wrapped-archive-item:active { background: var(--nav-bg); }
        .w-badge {
            font-size: 10px; font-weight: 800; text-transform: uppercase;
            padding: 4px 8px; border-radius: 6px; color: #000; margin-left: 10px;
        }
        .w-badge.daily { background: #bdc3c7; } /* Серый */
        .w-badge.weekly { background: #2ecc71; } /* Зеленый */
        .w-badge.monthly { background: #f1c40f; } /* Золотой */
        .w-badge.yearly { background: linear-gradient(45deg, #FF9900, #9B59B6); color: #fff; }

        /* ФИНАЛЬНАЯ КАРТОЧКА */
        .sum-card-new {
            background: rgba(20, 20, 20, 0.95); 
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 24px; 
            padding: 25px;
            width: 90%; 
            max-width: 360px;
            display: flex; 
            flex-direction: column; 
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            position: relative; 
            overflow: hidden;
        }
        .sum-logo-new { font-weight: 900; font-size: 24px; color: #fff; letter-spacing: -1px; }
        .sum-logo-new span.grad { 
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .sum-logo-new span.neutral { color: #fff; }

        .sum-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .sum-stat-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center; }
        .sum-stat-val { font-size: 22px; font-weight: 800; color: #fff; }
        .sum-stat-lbl { font-size: 10px; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 4px; }

        /* Значки достижений */
        .achievement-badge {
            width: 120px; height: 120px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
            border: 4px solid rgba(255,255,255,0.1);
        }

        /* Финальная сводка (Summary Card) */
        .summary-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            padding: 25px;
            width: 90%;
            max-width: 340px;
            text-align: left;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 0; 
            transform: translateY(20px);
            animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards 0.5s;
        }
        @keyframes slideUpFade {
            to { opacity: 1; transform: translateY(0); }
        }
        .sum-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding-bottom: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.15);
            margin-bottom: 5px;
        }
        .sum-header-left {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Логотип: Картинка + Текст */
        .sum-logo-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .sum-logo-img {
            height: 32px; 
            width: auto;
            object-fit: contain;
        }

        .sum-logo-text { 
            font-weight: 900; 
            font-size: 20px; 
            color: #fff; 
            letter-spacing: -0.5px;
            line-height: 1;
        }

        /* Цветные буквы (если не нуар) */
        .sum-logo-text span.grad { 
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Важно для некоторых браузеров */
            display: inline-block; /* Чтобы градиент не ломался */
        }

        /* Нуарная тема: всё белое */
        body[data-theme="noir"] .sum-logo-text span.grad {
            background: none !important;
            -webkit-background-clip: border-box !important;
            background-clip: border-box !important;
            -webkit-text-fill-color: #ffffff !important;
            color: #ffffff !important;
        }

        /* Подпись "Узнай себя" */
        .sum-caption {
            font-size: 10px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            font-weight: 600;
            letter-spacing: 1px;
            margin-left: 2px; /* Чуть подвинуть под текст */
        }

        /* QR Код */
        .sum-qr-box {
            background: #fff;
            padding: 4px;
            border-radius: 8px;
            width: 64px;
            height: 64px;
            flex-shrink: 0; /* Чтобы не сжимался */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sum-qr-img {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Бейджик периода в карточке */
        .sum-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            margin-top: -10px; 
        }
        .sum-logo { font-weight: 900; font-size: 18px; color: #fff; }
        .sum-date { font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; text-align: right; }
        .sum-row { display: flex; justify-content: space-between; align-items: center; }
        .sum-label { font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; font-weight: 600; }
        .sum-val { font-size: 18px; font-weight: 800; color: #fff; }
        .sum-big-val { font-size: 28px; font-weight: 900; color: #ffe600; text-shadow: 0 0 20px rgba(255, 230, 0, 0.3); }
        .sum-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .sum-tag { 
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); 
            padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #fff; font-weight: 600; 
        }

        /* --- Анимация для отложенного появления (Интрига) --- */
        @keyframes fadeInUpReveal {
            from { opacity: 0; transform: translateY(15px); filter: blur(5px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .reveal-delayed {
            opacity: 0; /* Скрыто по умолчанию */
            animation: fadeInUpReveal 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .delay-1500 { animation-delay: 1.5s; } /* Задержка 1.5 сек (для слайда сравнения) */
        .delay-3000 { animation-delay: 3.0s; } /* Задержка 3.0 сек (для психотипа) */

        /* --- Исправление переноса текста в финальной карточке --- */
        .sum-stat-box {
            /* Разрешаем перенос длинных слов */
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            
            /* Включаем расстановку дефисов (если поддерживается браузером) */
            -webkit-hyphens: auto;
            -ms-hyphens: auto;
            hyphens: auto;
            
            /* Разрешаем блоку растягиваться по высоте */
            height: auto !important; 
            min-height: 80px; /* Минимальная высота для красоты */
            
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Убеждаемся, что заголовок внутри бокса тоже не ломает верстку */
        .sum-stat-box div[style*="font-size:22px"] {
            line-height: 1.2 !important;
            margin-bottom: 5px;
        }

        /* === TINDER STYLE CONTROLS === */
        .tinder-nav-row {
            display: flex;
            align-items: center;
            justify-content: space-evenly;
            width: 100%;
            margin-top: auto;
            margin-bottom: 10px;
            gap: 15px; /* Чуть больше расстояние */
            padding: 0 5px;
        }

        .t-circle-btn {
            border: none; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: #fff !important; 
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
            
            /* Тонкая рамка для стиля */
            border: 1px solid rgba(255,255,255,0.1); 
        }

        .t-circle-btn:active {
            transform: scale(0.92);
            filter: brightness(0.9);
        }

        /* Размеры */
        .t-circle-btn.small { width: 44px; height: 44px; font-size: 20px; }
        .t-circle-btn.medium { width: 58px; height: 58px; font-size: 26px; }
        .t-circle-btn.large { width: 72px; height: 72px; font-size: 32px; }

        /* Цвета */
        .t-circle-btn.undo {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        /* 2. DISLIKE (Красный градиент) */
        .t-circle-btn.dislike {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4);
        }

        /* 3. WATCH (Цвет темы + Свечение) */
        .t-circle-btn.watch {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
            
            /* Мощное свечение */
            box-shadow: 0 0 20px var(--accent), 
                        0 0 40px var(--accent-light),
                        inset 0 0 10px rgba(255,255,255,0.5);
            
            animation: pulseGlow 2s infinite;
            z-index: 2; /* Чуть выше остальных */
            border: 1px solid rgba(255,255,255,0.3);
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 20px var(--accent); transform: scale(1); }
            50% { box-shadow: 0 0 35px var(--accent); transform: scale(1.05); }
            100% { box-shadow: 0 0 20px var(--accent); transform: scale(1); }
        }

        /* 4. LIKE (Зеленый градиент) */
        .t-circle-btn.like {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        /* 5. WATCH LATER (серый) */
        .t-circle-btn.wl {
            background: rgba(255, 255, 255, 0.15); /* Полупрозрачный серый */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary) !important;
            box-shadow: none; /* Без свечения */
            transition: all 0.2s ease;
        }

        /* При наведении или нажатии чуть светлее */
        .t-circle-btn.wl:active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* АКТИВНОЕ СОСТОЯНИЕ (Синий градиент) */
        .t-circle-btn.wl.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
            border-color: transparent !important;
            color: #ffffff !important;
            box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3);
        }

        body.light-theme .t-circle-btn.wl {
            background: rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.1);
            color: #666 !important;
        }
        body.light-theme .t-circle-btn.wl.active {
            color: #ffffff !important; 
        }

        /* Нажатие */
        .t-circle-btn:active {
            transform: scale(0.92) !important; /* Перебивает анимацию пульса */
            filter: brightness(1.1);
        }
        
        /* Disabled */
        .t-circle-btn:disabled {
            background: #bdc3c7; /* Серый */
            box-shadow: none;
            opacity: 0.7;
            cursor: default;
            transform: none !important;
        }

        /* Скрываем старые элементы, которые мы заменили */
        .tinder-actions, .btn-group, .undo-container {
            display: none !important;
        }
        
        /* Карточка должна быть Flex-колонкой для правильного размещения */
        .card {
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important;
            padding-bottom: 10px !important;
        }
        
        /* Адаптация описания, чтобы не прилипало */
        .result-description {
            margin-bottom: 20px;
        }

        /* ROADMAP STYLES */
        .roadmap-container {
            display: flex !important;
            flex-direction: column !important;
            gap: 0 !important;
            padding-bottom: 20px;
        }

        .roadmap-item {
            display: flex !important;
            gap: 15px !important;
            padding-bottom: 0 !important; 
            position: relative !important;
        }

        .roadmap-item:last-child {
            padding-bottom: 0;
        }

        /* Колонка с иконкой и линией */
        .rm-visual-col {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            width: 40px !important;
            flex-shrink: 0 !important;
        }

        /* Иконка */
        .rm-icon-box {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.05);
            z-index: 2; /* Поверх линии */
            background: var(--card-bg); /* Чтобы не просвечивала */
        }

        /* Линия-соединитель */
        .rm-line {
            width: 2px !important;
            background: var(--border) !important;
            flex-grow: 1 !important;
            min-height: 20px !important;
            margin-top: -5px !important;
            margin-bottom: -5px !important;
        }

        .roadmap-item:last-child .rm-line {
            display: none !important;
        }


        /* Контент */
        .rm-content {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 25px !important;
        }

        .rm-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 5px;
        }

        .rm-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Кнопка-капсула с плюсом */
        .btn-capsule-plus {
            width: 60%; /* Ширина как у второстепенных кнопок */
            max-width: 200px;
            height: 44px;
            border-radius: 22px;
            background: transparent;
            border: 1px solid var(--border); /* Тонкая обводка */
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 auto;
            padding-bottom: 4px; /* Выравнивание плюса */
        }

        /* Активное состояние кнопки (когда открыто) */
        .btn-capsule-plus.active {
            background: var(--nav-bg);
            border-color: var(--accent);
            color: var(--accent);
            transform: scale(0.98);
        }

        /* Анимация иконки плюса */
        .btn-capsule-plus span {
            transition: transform 0.3s ease;
            display: block;
            line-height: 1;
        }

        /* Поворот плюса в крестик */
        .btn-capsule-plus.active span {
            transform: rotate(45deg);
        }

        /* Контейнер с модификаторами */
        #mod-container {
            width: 100%;
            max-height: 0; /* Высота 0 скрывает контент */
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 0;
            padding: 0 10px; /* Немного отступа по бокам */
            visibility: hidden; /* Скрываем от кликов */
        }

        .mods-wrapper-expanded.open #mod-container {
            max-height: 500px; 
            opacity: 1;
            margin-top: 40px; 
            padding-bottom: 15px;
            visibility: visible;
        }

        /* Состояние "Открыто" */
        #mod-container.open {
            max-height: 300px; /* Достаточно для всех тегов */
            opacity: 1;
            margin-top: 15px;
            padding-bottom: 10px;
        }

        #mods-block {
            width: 100%;
            padding: 0 15px; 
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }


        .mods-wrapper-expanded {
            position: relative;
            width: 60px; 
            height: 44px; 
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            margin: 10px auto 0 auto;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 10;
        }

        /* Иконка (Плюс -> Крестик) */
        .mods-icon-plus {
            position: absolute;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 300;
            color: var(--text-secondary);
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            
            /* ЦЕНТР (Закрыто) */
            top: 50%;
            right: 50%;
            transform: translate(50%, -50%);
        }

        /* Контент тегов (Список) */
        .mods-content {
            opacity: 0;
            width: 100%;
            padding: 45px 15px 20px 15px; /* Сверху отступ под крестик */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            transform: translateY(20px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none; /* Чтобы не кликалось в закрытом */
            visibility: hidden; /* Скрываем полностью */
        }

        /* === СОСТОЯНИЕ OPEN (ОТКРЫТО) === */
        .mods-wrapper-expanded.open {
            width: 100% !important; 
            max-width: 100%; 
            height: auto;
            min-height: 160px;
            background: var(--ios-card);
            border-color: var(--accent);
            border-radius: 24px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            margin-top: 5px;
        }

        /* Крестик улетает в угол */
        .mods-wrapper-expanded.open .mods-icon-plus {
            color: var(--highlight-red);
            top: 15px;
            right: 15px;
            left: auto; 
            transform: rotate(45deg);
        }

        .mods-wrapper-expanded.open .mods-content {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }

        /* Заголовок в выпадающем окне карточки */
        .mods-header {
            width: 100%;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            opacity: 0.7;
        }

        /* Чипы в модальном окне настроек */
        .mod-chip {
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border: 1px solid transparent;
            
            /* Flex для красивого выравнивания иконок */
            display: inline-flex; 
            align-items: center;
            gap: 6px; /* Отступ между текстом и иконками */
        }

        .custom-mod-del:hover {
            color: #fff !important;
            transform: scale(1.2);
        }

        /* Активные (Зеленые) */
        .mod-chip.active {
            background: rgba(46, 204, 113, 0.15);
            color: #2ecc71;
            border-color: rgba(46, 204, 113, 0.3) !important;
        }

        .mod-chip.active::after {
            content: none !important;
        }

        /* Неактивные (Серые) */
        .mod-chip.inactive {
            background: var(--ios-card);
            color: var(--text-secondary);
            border-color: var(--border);
            opacity: 0.8;
        }
        .mod-chip.inactive:hover {
            opacity: 1;
            background: var(--nav-bg);
        }

        .custom-mod-del {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.1);
            color: var(--highlight-red);
            font-size: 10px;
            margin-left: 4px;
            transition: all 0.2s;
        }

        .custom-mod-del:hover {
            background: var(--highlight-red);
            color: #fff;
            transform: scale(1.2);
        }

        /* Обновленный стиль тегов */
        .tag {
            padding: 8px 14px;
            border-radius: 12px;
            background: var(--bg-color);
            border: 1px solid var(--border);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: 0.2s;
            cursor: pointer;
            user-select: none;
        }
        .tag:active {
            transform: scale(0.95);
        }
        .tag.selected {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .swipe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            
            /* Лежит поверх всего контента */
            z-index: 50 !important; 
            
            /* Скругляем углы под карточку */
            border-radius: 28px;
            
            pointer-events: none; 
            opacity: 1 !important; /* Управляем цветом через RGBA, а не opacity */
            background-color: transparent; /* По умолчанию прозрачный */
            transition: background-color 0.1s linear;
        }

        /* Верхняя часть (Бейджи) */
        .card > div:nth-child(2) { 
            z-index: 15; 
            padding-top: 20px;
            flex: 0 0 auto; /* Не сжимать */
        }

        /* ЦЕНТРАЛЬНАЯ ЧАСТЬ (Слот + Описание) */
        .card > div:nth-child(3) {
            z-index: 15;
            flex: 1 1 auto; /* Резиновая: может сжиматься и расти */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Чтобы длинное описание не ломало верстку */
            padding: 0 15px;
        }

        #onb-input {
            flex-shrink: 0 !important; /* Запрещаем сжимать поле ввода */
        }
        
        #onb-tags-container {
            max-height: 25vh; /* Ограничиваем высоту списка тегов */
            overflow-y: auto; /* Добавляем прокрутку, если тегов много */
            padding: 5px;
        }
        
        /* Скрываем скроллбар для красоты */
        #onb-tags-container::-webkit-scrollbar { display: none; }

        .version-tag {
                font-size: 11px;
                font-weight: 500;
                
                /* Сброс градиента */
                background: none !important;
                -webkit-text-fill-color: var(--text-secondary) !important; 
                color: var(--text-secondary) !important;
                
                opacity: 0.5;
                margin-left: 6px;
                
                /* Выравнивание */
                position: relative;
                top: 5px; /* Сдвигаем вниз от центральной линии */
            }

        /* Общий стиль для иконок */
        .deco-icon {
            position: absolute;
            z-index: 99 !important; 
            pointer-events: none; /* Клики проходят сквозь них */
            will-change: transform;
            transition: filter 0.3s ease; /* Плавная смена цвета при смене темы */
        }

        /* --- 1. ТЁМНАЯ ТЕМА (По умолчанию) --- */
        /* Исходники черные -> инвертируем в белые + белая тень */
        .deco-icon {
            /* invert(1) делает черное белым */
            filter: invert(1) drop-shadow(0 0 10px rgba(255, 255, 255, 0.4));
            opacity: 0.9;
        }

        /* --- 2. СВЕТЛАЯ ТЕМА --- */
        /* Исходники черные -> оставляем черными (invert 0) + темная тень */
        body.light-theme .deco-icon {
            filter: invert(0) drop-shadow(0 5px 15px rgba(0, 0, 0, 0.15));
            opacity: 0.8; 
        }

        /* АНИМАЦИИ ПАРЕНИЯ */
        @keyframes floatLeft {
            0% { transform: translate3d(0, 0, 0) rotate(-20deg) scale(1); }
            50% { transform: translate3d(-8px, -12px, 0) rotate(-15deg) scale(1.05); }
            100% { transform: translate3d(0, 0, 0) rotate(-20deg) scale(1); }
        }

        @keyframes floatRight {
            0% { transform: translate3d(0, 0, 0) rotate(15deg) scale(1); }
            50% { transform: translate3d(8px, -12px, 0) rotate(20deg) scale(1.05); }
            100% { transform: translate3d(0, 0, 0) rotate(15deg) scale(1); }
        }

        .icon-left {
            width: 140px;
            top: -40px; 
            left: -20px;
            animation: floatLeft 6s ease-in-out infinite;
        }

        .icon-right {
            width: 110px;
            top: -20px;
            right: -10px;
            animation: floatRight 7s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .icon-left {
                width: 75px !important;  
                top: 5px !important;    
                left: -5px !important;  
            }

            .icon-right {
                width: 60px !important;  
                top: 15px !important;   
                right: 0px !important;  
            }
        }

        body.no-deco .deco-icon {
            display: none !important;
        }

        /* === BESTIE PLAN STYLES === */
        .plan-card.bestie {
            border: 2px solid #00d2ff; /* Яркий голубой бордюр */
            background: linear-gradient(165deg, rgba(0, 210, 255, 0.1), rgba(58, 123, 213, 0.05));
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.15);
            order: -1; /* На мобильных ставим его первым, чтобы заметили */
        }

        @media (min-width: 769px) {
            .plan-card.bestie { order: 0; }
        }

        .plan-card.bestie .plan-title {
            background: linear-gradient(to right, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #00d2ff;
        }

        .bestie-badge {
            position: absolute;
            top: 0; right: 0;
            background: #00d2ff;
            color: #000;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-bottom-left-radius: 12px;
        }

        .modal-header-actions {
            position: absolute !important;
            right: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important; /* Отступ между кнопками */
        }

        /* Общий стиль для круглых кнопок (Крестик и Поделиться) */
        .icon-btn-round {
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            background: rgba(128, 128, 128, 0.15) !important;
            color: var(--text-secondary) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 16px !important;
            cursor: pointer !important;
            transition: background 0.2s !important;
        }

        .icon-btn-round:hover {
            background: var(--nav-bg) !important;
            color: var(--text-main) !important;
        }

        .modal-header > span:last-child {
            display: none !important; 
        }

        /* Стили для счетчика (Scarcity Bar) */
        .limit-container {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .limit-labels {
            display: flex; 
            justify-content: space-between; 
            font-size: 11px; 
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .limit-track {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .limit-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            width: 96%; /* 48 из 50 */
            box-shadow: 0 0 10px #00d2ff;
            animation: pulseBar 2s infinite;
        }

        @keyframes pulseBar {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .plan-btn.bestie-btn {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        }

        /* === NOTCH & BORDER STYLES === */

        /* Базовый стиль чёлки */
        .card-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Спрятана сверху */
            
            padding: 6px 16px;
            border-radius: 0 0 14px 14px; /* Закругления только снизу */
            
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #fff;
            
            z-index: 40; /* Поверх бейджей */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            
            /* Пружинистая анимация появления */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s;
            pointer-events: none; /* Чтобы сквозь неё проходили клики */
        }

        /* Класс для показа чёлки */
        .card-notch.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* --- ВАРИАНТ 1: WATCH LATER (Синий) --- */
        .card.status-wl {
            border: 2px solid #3498db !important;
            box-shadow: 0 0 25px rgba(52, 152, 219, 0.15) !important;
        }
        .card.status-wl .card-notch {
            background: #3498db;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        /* --- ВАРИАНТ 2: FAVORITE (Зеленый) --- */
        .card.status-fav {
            border: 2px solid #2ecc71 !important;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.15) !important;
        }
        .card.status-fav .card-notch {
            background: #2ecc71;
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
        }

        /* --- ВАРИАНТ 3: DISLIKED (Красный) - на случай просмотра истории --- */
        .card.status-ban {
            border: 2px solid #e74c3c !important;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.15) !important;
        }
        .card.status-ban .card-notch {
            background: #e74c3c;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }

        /* === 1. MODE CAPSULE (DROPDOWN STYLE) === */
        .mode-capsule-wrapper {
            position: relative;
            z-index: 100;
            display: none; /* Скрыто по умолчанию (пока нет 10 действий) */
        }

        /* Стиль самой кнопки-капсулы */
        .mode-capsule-btn {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .mode-capsule-btn:active, .mode-capsule-wrapper.open .mode-capsule-btn {
            background: var(--nav-bg);
            color: var(--text-main);
            border-color: var(--accent);
        }

        /* Выпадающий список */
        .mode-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            width: 160px;
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 6px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mode-capsule-wrapper.open .mode-dropdown {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(5px);
        }

        .mode-item {
            padding: 10px 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .mode-item:hover, .mode-item:active {
            background: var(--nav-bg);
            color: var(--text-main);
        }

        .mode-item.active {
            background: rgba(155, 89, 182, 0.1); /* Акцент */
            color: var(--accent);
        }

        /* === 2. START SCREEN (CARD OVERLAY) === */
        .mode-start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-gradient);
            z-index: 50; /* Перекрывает всё внутри карточки */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between !important;
            padding: 40px 20px 30px 20px !important;
            transition: opacity 0.3s;
        }

        .mode-start-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .mode-greeting-text {
            font-size: clamp(24px, 5vw, 36px) !important; 
            font-weight: 800 !important;
            line-height: 1.2 !important; 
            text-align: center;
            color: var(--text-main);
            
            margin-top: auto; 
            margin-bottom: auto;
            max-width: 95%; 
            
            transition: opacity 0.3s ease;
        }

        .mode-buttons-circle-row {
            display: flex;
            justify-content: center;
            gap: 25px;
            width: 100%;
            margin-top: auto; 
            margin-bottom: 10px;
        }

        .mode-circle-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            border: none !important;
            font-size: 32px;
            
            /* Тень и позиционирование */
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            color: #fff; /* Эмодзи всегда яркие */
            
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .mode-circle-btn:active {
            transform: scale(0.92);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* === 3. РАСПОЛОЖЕНИЕ КАПСУЛЫ (PC vs MOBILE) === */

        /* По умолчанию (Mobile): Капсула под хедером */
        #mobile-mode-mount {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: -15px !important; 
            margin-bottom: 25px !important;
            position: relative;
            z-index: 60;
        }

        #pc-mode-mount {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 15px; 
            border-top: none !important;
            padding-top: 0 !important;
        }

        /* PC ВЕРСИЯ */
        @media (min-width: 769px) {
            #mobile-mode-mount {
                display: none !important; /* Скрываем мобильную версию */
            }

            #pc-mode-mount {
                display: flex;
                width: 100%;
                margin-top: auto; /* Прижимаем к низу сайдбара (или куда вам нужно) */
                padding-top: 20px;
                border-top: 1px solid var(--border);
            }
            
            /* Капсула на ПК растягивается или имеет свой стиль */
            #pc-mode-mount .mode-capsule-btn {
                width: auto; 
                min-width: 140px;
                justify-content: center;
            }
        }

        /* === AI ASSISTANT MODE STYLES === */

        .mode-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px; 
            width: 100%;
            margin-top: auto;
            margin-bottom: 20px;
        }

        .mode-circle-btn {
            border-radius: 50%;
            border: none !important; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            transition: transform 0.1s, background 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .mode-circle-btn:active {
            transform: scale(0.92);
        }

        .mode-circle-btn.center-btn {
            width: 85px;
            height: 85px;
            font-size: 40px;
            z-index: 10;
            /* Градиент по умолчанию */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 10px 30px rgba(118, 75, 162, 0.5);
        }

        .mode-circle-btn.side-btn {
            width: 60px;
            height: 60px;
            font-size: 26px;
            z-index: 5;
        }

        .mode-circle-btn.explore {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }

        .mode-circle-btn.pleasure {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
        }

        /* UI ВВОДА ЗАПРОСА (Скрыт по умолчанию) */
        .assistant-ui {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: var(--card-gradient);
            z-index: 60;
            padding: 20px;
            opacity: 0;
            transform: scale(0.9) translateY(20px); 
            transition: 
                opacity 0.4s ease,
                transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            
            pointer-events: none;
        }

        .assistant-ui.visible {
            display: flex;
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }

        .fade-out-up {
            opacity: 0 !important;
            transform: translateY(-30px) scale(0.9) !important;
            pointer-events: none !important;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .assistant-prompt {
            font-size: 24px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-main);
            line-height: 1.2;
        }

        .assistant-input-group {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            width: 100%;
            
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 5px 5px 5px 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .assistant-input {
            flex: 1; 
            background: transparent !important;
            border: none;
            outline: none;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            padding: 10px 0;
            margin-right: 10px; 
        }
        .assistant-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .btn-mic-trigger {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; 
        }
        .btn-mic-trigger.listening {
            background: #e74c3c;
            animation: pulseMic 1.5s infinite;
        }

        @keyframes pulseMic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .btn-ai-confirm {
            background: #fff;
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            
            opacity: 0;
            pointer-events: none;
            transform: translateY(15px);
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .btn-ai-confirm.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .btn-ai-confirm:active {
            transform: translateY(10px) scale(0.95) !important;
        }

        .btn-ai-cancel {
            margin-top: 20px;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-ai-cancel:active {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }


        /* АНИМАЦИЯ "ДУМАЮ..." */
        .thinking-ui {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 70;
            background: var(--card-gradient);
        }
        .thinking-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .ai-icon-img {
            width: 45px;
            height: 45px;
            object-fit: contain;
            pointer-events: none; /* Чтобы клик проходил сквозь картинку на кнопку */
            
            /* По умолчанию (Темная тема) -> Инвертируем черный в белый */
            filter: invert(1) drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease;
        }

        .ai-hint-text {
            display: block;
            margin-top: 15px; /* Отступ сверху побольше */
            font-size: 14px;  /* Было ~10px (0.65em), стало крупнее */
            font-weight: 600; /* Жирнее */
            opacity: 0.9;     /* Ярче (было 0.8) */
            line-height: 1.4;
            color: var(--text-secondary);
        }

        /* Светлая тема -> Оставляем черным */
        body.light-theme .ai-icon-img {
            filter: invert(0) drop-shadow(0 0 2px rgba(0, 0, 0, 0.1));
        }

        .mode-circle-btn.center-btn.ai-assist {
            /* Адаптивный градиент темы */
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%) !important;
            
            /* Тонкая белая обводка для контраста */
            border: 2px solid rgba(255, 255, 255, 0.4) !important;
            
            /* Начальная тень */
            box-shadow: 0 0 20px var(--accent), 
                        0 0 40px var(--accent-light);
            
            /* Анимация пульсации */
            animation: aiPulseGlow 2s infinite ease-in-out;
            z-index: 10;
        }

        .rolling-input-overlay {
            position: absolute;
            top: 0;
            left: 15px; 
            height: 100%;
            width: 80%;
            pointer-events: none;
            display: flex;
            align-items: center;
            overflow: hidden;
            opacity: 0.6;
            transition: opacity 0.2s;
            z-index: 1;
        }

        /* Скрываем подсказки, когда пользователь печатает */
        .assistant-input:focus + .rolling-input-overlay,
        .assistant-input:not(:placeholder-shown) ~ .rolling-input-overlay, 
        .rolling-input-overlay.hidden {
            opacity: 0 !important;
        }

        .assistant-input:focus ~ .rolling-input-overlay {
            opacity: 0;
        }

        .rolling-list {
            display: flex;
            flex-direction: column;
        }

        .rolling-item {
            height: 50px; 
            display: flex;
            align-items: center;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            font-style: italic;
        }

        /* Анимация прокрутки */
        @keyframes scrollPrompts {
            0%, 15% { transform: translateY(0); }
            20%, 35% { transform: translateY(-50px); }
            40%, 55% { transform: translateY(-100px); }
            60%, 75% { transform: translateY(-150px); }
            80%, 95% { transform: translateY(-200px); }
            100% { transform: translateY(-250px); } 
        }

        .animate-scroll {
            animation: scrollPrompts 12s cubic-bezier(0.6, 0.0, 0.4, 1.0) infinite;
        }


        /* Анимация свечения (масштаб + тень) */
        @keyframes aiPulseGlow {
            0% {
                box-shadow: 0 0 15px var(--accent);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 35px var(--accent), 0 0 50px var(--accent-light);
                transform: scale(1.05); /* Легкое увеличение */
            }
            100% {
                box-shadow: 0 0 15px var(--accent);
                transform: scale(1);
            }
        }

        /* При нажатии чуть уменьшаем, но сохраняем градиент */
        .mode-circle-btn.center-btn.ai-assist:active {
            transform: scale(0.95) !important;
            animation: none; /* Пауза анимации при клике */
        }

        /* Спец. стиль для темы NOIR (Черно-белая) */
        body[data-theme="noir"] .mode-circle-btn.center-btn.ai-assist {
            background: #000000 !important;
            border: 2px solid #ffffff !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5) !important;
        }

        /* иконка для боковых кнопок (scope.png, favorite.png) */
        .side-icon-img {
            width: 32px;  /* Чуть меньше, чем центральная (45px) */
            height: 32px;
            object-fit: contain;
            pointer-events: none;
            
            /* Темная тема (Default): Инвертируем черный в белый + тень */
            filter: invert(1) drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease;
        }

        /* Стили для иконок внутри кнопок действий */
        .action-icon-img {
            width: 50%;
            height: 50%;
            object-fit: contain;
            pointer-events: none;
            
            /* Темная тема (Default): Инвертируем черный в белый */
            filter: invert(1);
            transition: filter 0.3s ease;
        }

        /* Кнопка WATCH: Всегда белая иконка (т.к. фон цветной) */
        .t-circle-btn.watch .action-icon-img {
            filter: brightness(0) invert(1) !important;
            width: 45%; /* Чуть меньше для Play */
            height: 45%;
            margin-left: 2px; /* Визуальная коррекция для треугольника */
        }

        /* Светлая тема: Иконки черные (кроме Watch) */
        body.light-theme .action-icon-img {
            filter: invert(0);
        }
        body.light-theme .t-circle-btn.watch .action-icon-img {
            filter: brightness(0) invert(1) !important; /* Оставляем белой */
        }

        /* Watch Later ACTIVE: Когда кнопка синяя, иконка должна быть белой */
        .t-circle-btn.wl.active .action-icon-img {
            filter: brightness(0) invert(1) !important;
        }

        /* Тема NOIR */
        body[data-theme="noir"] .action-icon-img {
            filter: invert(1) !important;
        }
        /* В Noir при нажатии фон белый, иконка должна стать черной */
        body[data-theme="noir"] .t-circle-btn:active .action-icon-img,
        body[data-theme="noir"] .t-circle-btn.active .action-icon-img {
            filter: invert(0) !important;
        }

        body.light-theme .side-icon-img {
            filter: invert(0) drop-shadow(0 0 2px rgba(0, 0, 0, 0.1));
        }

        body[data-theme="noir"] .side-icon-img {
            filter: invert(1) !important;
        }
        body[data-theme="noir"] .mode-circle-btn:active .side-icon-img {
            filter: invert(0) !important;
        }

        .voice-icon-img {
            width: 24px; /* Чуть меньше кнопки */
            height: 24px;
            object-fit: contain;
            pointer-events: none;
            
            /* Темная тема (Default): Инвертируем черный в белый */
            filter: invert(1) drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease, transform 0.2s;
        }

        /* Светлая тема: Оставляем черным */
        body.light-theme .voice-icon-img {
            filter: invert(0) opacity(0.7);
        }

        /* Анимация при записи (Красное свечение) */
        .btn-mic-trigger.listening .voice-icon-img {
            filter: invert(1) drop-shadow(0 0 8px #e74c3c) !important;
            transform: scale(1.1);
        }

        /* =========================================
        ИКОНКИ НАСТРОЕК И СТРЕЛКИ
        ========================================= */

        /* Стили для иконок слева (png) */
        .settings-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-right: 12px; /* Отступ от иконки до текста */
            flex-shrink: 0;
            
            /* По умолчанию (Темная тема): Инвертируем черные PNG в белые */
            filter: invert(1);
            opacity: 0.9;
            transition: filter 0.3s, opacity 0.3s;
        }

        /* Светлая тема: Оставляем черными (как в оригинале) */
        body.light-theme .settings-icon {
            filter: invert(0);
            opacity: 0.65;
        }

        /* Обертка для левой части (Иконка + Текст), чтобы они стояли в ряд */
        .ios-row-left {
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* --- CSS СТРЕЛКА (Вместо эмодзи ›) --- */
        .chevron {
            width: 8px;
            height: 8px;
            border-top: 2px solid var(--text-secondary);
            border-right: 2px solid var(--text-secondary);
            transform: rotate(45deg);
            margin-left: 8px;
            opacity: 0.6;
        }

        /* Стрелка вниз (для выпадающих списков, если нужно) */
        .chevron-down {
            width: 8px;
            height: 8px;
            border-bottom: 2px solid var(--text-secondary);
            border-right: 2px solid var(--text-secondary);
            transform: rotate(45deg);
            margin-left: 8px;
            opacity: 0.6;
            margin-bottom: 3px;
        }

        /* Убираем старые эмодзи в тексте, если они где-то остались в HTML */
        .ios-row span {
            display: inline-flex;
            align-items: center;
        }

        /* --- INTENSITY TOAST POPUP --- */
        #intensity-toast {
            position: absolute;
            top: 45px;
            left: 0;
            width: 100%; 
            padding: 0 5px;
            
            font-size: 11px; 
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            
            pointer-events: none;
            opacity: 0;
            white-space: nowrap;
            z-index: 20;
            
            transition: opacity 0.2s; 
        }

        /* Цвета и свечение (Neon Text) */
        .toast-safe {
            color: #2ecc71; /* Зеленый */
            text-shadow: 0 0 15px rgba(46, 204, 113, 0.6), 0 0 30px rgba(46, 204, 113, 0.2);
        }

        .toast-spicy {
            color: #f1c40f; /* Желто-оранжевый */
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.6), 0 0 30px rgba(241, 196, 15, 0.2);
        }

        .toast-extreme {
            color: #ff004c; /* Агрессивный красный */
            text-shadow: 0 0 15px rgba(255, 0, 76, 0.8), 0 0 40px rgba(255, 0, 76, 0.4);
        }

        /* Новая анимация: Появление снизу-вверх и растворение */
        @keyframes floatUpSimple {
            0% {
                opacity: 0;
                transform: translateY(5px) scale(0.9); /* Чуть ниже и меньше */
            }
            20% {
                opacity: 1;
                transform: translateY(0) scale(1);     /* Нормальная позиция */
            }
            80% {
                opacity: 1;
                transform: translateY(0) scale(1);     /* Пауза */
            }
            100% {
                opacity: 0;
                transform: translateY(-10px) scale(1); /* Улетает вверх */
            }
        }

        .anim-toast {
            animation: floatUpSimple 1.0s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        #intensity-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            outline: none;
            cursor: pointer;
            background: var(--border);
            display: block;
        }

        #intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            margin-top: -1px;
        }

        .slider-container {
            width: 100%;
            padding: 0 5px;
            position: relative;
            margin-top: 5px !important; 
            margin-bottom: 0px;
        }

        .slider-narrow-wrapper {
            width: 85%;
            margin: 5px auto 5px auto !important; 
            position: relative;
            overflow: visible; 
            padding: 0 !important; 
            height: auto !important;
        }

        /* Иконки под слайдером */
        .intensity-labels-icons {
            display: flex;
            justify-content: space-between;
            padding: 0 2px;
        }

        /* Боксы иконок */
        .int-icon-box {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .int-icon-wrapper {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .int-icon-wrapper:active {
            transform: scale(0.9);
        }

        .int-icon {
            width: 20px; 
            height: 20px;
            object-fit: contain;
            transition: all 0.3s ease;
            
            filter: invert(1);
            opacity: 0.3;
        }

        body.light-theme .int-icon {
            filter: invert(0);
            opacity: 0.8;
        }

        body[data-theme="noir"] .int-icon.active-safe,
        body[data-theme="noir"] .int-icon.active-spicy,
        body[data-theme="noir"] .int-icon.active-extreme {
            filter: invert(1) !important;
            opacity: 1;
            transform: scale(1.15);
        }

        /* --- ИКОНКА СБРОСА (КРАСНАЯ) --- */
        .settings-icon.red-icon {
            filter: invert(36%) sepia(83%) saturate(1963%) hue-rotate(339deg) brightness(96%) contrast(87%) !important;
            opacity: 1 !important;
        }

        /* --- ЦВЕТА ДЛЯ АКТИВНЫХ ИКОНОК --- */

        /* 1. SAFE (Зеленый #2ecc71) */
        .int-icon.active-safe {
            filter: invert(68%) sepia(61%) saturate(452%) hue-rotate(97deg) brightness(89%) contrast(85%) !important;
            opacity: 1;
            transform: scale(1.2);
        }

        /* 2. SPICY (Оранжевый #f39c12) */
        .int-icon.active-spicy {
            filter: invert(77%) sepia(33%) saturate(5427%) hue-rotate(357deg) brightness(101%) contrast(90%) !important;
            opacity: 1;
            transform: scale(1.2);
        }

        /* 3. EXTREME (Красный #e74c3c) */
        .int-icon.active-extreme {
            filter: invert(43%) sepia(97%) saturate(1874%) hue-rotate(338deg) brightness(96%) contrast(89%) !important;
            opacity: 1;
            transform: scale(1.2);
        }

        #hist-list-swipes .ios-row, 
        #hist-list-watch .ios-row,
        #hist-list-wrapped .wrapped-archive-item {
            border-radius: 16px !important;
            margin-bottom: 8px !important; /* Отступ между карточками */
            border: 1px solid var(--border) !important; /* Легкая обводка для красоты */
        }

        /* Убираем линию-разделитель, так как теперь у нас отдельные карточки */
        #hist-list-swipes .ios-row::after,
        #hist-list-watch .ios-row::after {
            display: none !important;
        }

        /* 2. РОАДМАП (Выравнивание и отступы) */
        .roadmap-item {
            align-items: center !important; /* Иконки по центру вертикально */
            margin-bottom: 25px !important; /* Отступ между пунктами */
        }

        .rm-content {
            display: flex !important;
            flex-direction: column !important;
            gap: 6px !important; /* Отступ между Заголовком и Описанием */
            padding-bottom: 0 !important; /* Убираем лишний отступ снизу */
        }

        .rm-line {
            display: none !important;
        }

        /* 3. ЗАЛ СЛАВЫ (Отступы) */
        #sponsors-list {
            margin-right: 15px !important; /* Добавляем отступ справа */
            width: auto !important;
        }

        /* PANIC SETTINGS STYLES */
        .panic-key-box {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.2s;
            user-select: none;
        }
        .panic-key-box:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-secondary);
        }
        .panic-key-box.recording {
            border-color: var(--accent);
            background: rgba(255, 0, 204, 0.1); /* Pink tint */
            animation: pulseBorder 1.5s infinite;
        }
        .panic-key-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .panic-key-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
            font-family: monospace;
        }
        .panic-note {
            font-size: 12px; 
            color: var(--text-secondary); 
            line-height: 1.5; 
            margin-bottom: 20px; 
            text-align: center;
        }
        .panic-highlight {
            color: var(--text-main);
            font-weight: 700;
        }

        @keyframes pulseBorder {
            0% { border-color: var(--accent); }
            50% { border-color: transparent; }
            100% { border-color: var(--accent); }
        }

        /* --- НОВЫЙ СТИЛЬ EXPLORED BAR --- */
        .explored-row {
            padding: 12px 16px;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important; /* Центрируем по вертикали бар и иконку */
            min-height: 50px;
            border-bottom: 1px solid rgba(128,128,128,0.1);
        }

        .explored-left {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        /* Правая часть: Бар + Цифры */
        .explored-right {
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            width: 140px; /* Фиксированная ширина */
            position: relative;
        }

        /* Трек бара */
        .explored-track {
            width: 100%;
            height: 8px; /* Чуть толще для красоты */
            background: var(--nav-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 4px; /* Отступ до цифр */
        }

        /* Заливка */
        .explored-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), #9b59b6);
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 0 10px var(--accent); /* Легкое свечение */
        }

        /* Контейнер для цифр под баром */
        .explored-nums-container {
            position: relative;
            width: 100%;
            height: 14px; /* Высота под шрифт */
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* Бегущая цифра (Текущее) */
        #ex-current {
            position: absolute;
            top: 0;
            left: 0; /* Будет меняться через JS */
            transform: translateX(-50%); /* Центрируем относительно конца полоски */
            transition: left 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            color: var(--text-main); /* Ярче */
            white-space: nowrap;
        }

        /* Статичная цифра (Всего) */
        #ex-total-label {
            position: absolute;
            top: 0;
            right: 0;
            opacity: 0.6;
        }

        /* --- Сетка категорий --- */
        .explored-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 колонки */
            gap: 12px;
            padding-bottom: 20px;
        }

        /* --- Карточка категории --- */
        .ex-card {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: transform 0.2s;
            overflow: hidden;
        }

        .ex-card:active {
            transform: scale(0.98);
        }

        /* Иконка сверху по центру */
        .ex-card-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 10px;
            /* Инверсия для темной темы, если иконки черные */
            filter: invert(1) drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            transition: filter 0.3s;
        }

        body.light-theme .ex-card-icon {
            filter: invert(0) drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        /* Название категории */
        .ex-card-title {
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-main);
            margin-bottom: 8px;
            text-align: center;
        }

        /* Прогресс-бар контейнер */
        .ex-progress-track {
            width: 100%;
            height: 6px;
            background: rgba(128,128,128,0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 5px;
        }

        /* Прогресс-бар заливка */
        .ex-progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Текст статистики (снизу) */
        .ex-card-stats {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        /* --- СТИЛЬ ДЛЯ ПОЛНОСТЬЮ ОТКРЫТЫХ (ЗЕЛЕНЫЙ) --- */
        .ex-card.completed {
            border: 1px solid #2ecc71;
            background: rgba(46, 204, 113, 0.1); /* Легкий зеленый фон */
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.2);
        }

        .ex-card.completed .ex-progress-fill {
            background: #2ecc71; /* Зеленая полоска */
        }

        .ex-card.completed .ex-card-title {
            color: #2ecc71;
        }

        .ex-card.completed .ex-card-icon {
            /* Зеленое свечение иконки */
            filter: invert(1) sepia(1) saturate(5) hue-rotate(80deg) drop-shadow(0 0 5px #2ecc71); 
        }
        /* Коррекция для светлой темы для completed */
        body.light-theme .ex-card.completed .ex-card-icon {
            filter: invert(0) sepia(1) saturate(5) hue-rotate(80deg);
        }

        .ex-date {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Показываем дату только если выполнено */
        .ex-card.completed .ex-date {
            opacity: 1;
            color: #2ecc71; /* Зеленый цвет */
        }

        /* --- СТИЛИ ДЛЯ ПОЛЕЗНОСТЕЙ (TIPS) --- */

        /* Сетка: 2 колонки */
        .tips-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 колонки */
            gap: 12px;
            padding-bottom: 20px;
        }

        /* Карточка-контейнер */
        .tip-card {
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            overflow: hidden; /* Чтобы шапка не вылезала */
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            aspect-ratio: 0.8; /* Чуть вытянутый прямоугольник (близко к 4:3 вертикально) */
            cursor: pointer;
            transition: transform 0.2s;
            background: var(--ios-card); /* Подложка */
        }

        .tip-card:active {
            transform: scale(0.96);
        }

        /* 1/3 Сверху: Цветная шапка */
        .tip-card-header {
            height: 35%; /* Треть высоты */
            width: 100%;
            /* Фон задается через JS (градиент) */
        }

        /* 2/3 Снизу: Нейтральное стекло */
        .tip-card-body {
            height: 65%;
            width: 100%;
            position: relative; /* Для позиционирования иконки */
            padding: 12px;
            display: flex;
            flex-direction: column;
            
            /* Стеклянный нейтральный фон */
            background: var(--ios-card); 
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.05), transparent);
        }

        /* Иконка (Эмодзи) */
        .tip-card-icon {
            position: absolute;
            top: -22px; /* Поднимаем вверх, чтобы села на границу */
            left: 12px; /* Слева */
            font-size: 36px; /* Крупный размер */
            line-height: 1;
            z-index: 2;
            /* Тень для контраста на фоне границы */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }

        /* Заголовок */
        .tip-card-title {
            margin-top: 18px; /* Отступ сверху, чтобы не наехать на иконку */
            font-size: 13px;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1.2;
            margin-bottom: 6px;
        }

        /* Описание */
        .tip-card-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.35;
            font-weight: 500;
            
            /* Обрезаем лишнее */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tip-card.viewed {
            opacity: 0.5;
            transform: scale(0.98);
            order: 1;
            filter: grayscale(0.5); 
        }

        /* Текст заголовка "Стань гуру" (маленький и серый) */
        .tips-guru-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            opacity: 0.7;
        }

        /* =========================================
        DYNAMIC LOGO GRADIENTS PER THEME 
        ========================================= */

        /* Базовые настройки для текста-градиента */
        .logo span, 
        .sum-logo-text span.grad {
            display: inline-block; /* Важно для корректной отрисовки */
            color: transparent;    /* На случай, если градиент не загрузится */
        }

        /* --- 1. BLUE (Midnight / Sky) --- */
        body[data-theme="blue-dark"] .logo span,
        body[data-theme="blue-light"] .logo span,
        body[data-theme="blue-dark"] .sum-logo-text span.grad,
        body[data-theme="blue-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #64ffda 0%, #2563eb 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 2. GREEN (Forest / Mint) --- */
        body[data-theme="green-dark"] .logo span,
        body[data-theme="green-light"] .logo span,
        body[data-theme="green-dark"] .sum-logo-text span.grad,
        body[data-theme="green-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #86efac 0%, #16a34a 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 3. RED (Vampire / Rose) --- */
        body[data-theme="red-dark"] .logo span,
        body[data-theme="red-light"] .logo span,
        body[data-theme="red-dark"] .sum-logo-text span.grad,
        body[data-theme="red-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #fb7185 0%, #e11d48 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 4. GOLD (Luxury / Sand) --- */
        body[data-theme="gold-dark"] .logo span,
        body[data-theme="gold-light"] .logo span,
        body[data-theme="gold-dark"] .sum-logo-text span.grad,
        body[data-theme="gold-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #facc15 0%, #d97706 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 5. PURPLE (Amethyst / Lavender) --- */
        body[data-theme="purple-dark"] .logo span,
        body[data-theme="purple-light"] .logo span,
        body[data-theme="purple-dark"] .sum-logo-text span.grad,
        body[data-theme="purple-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #e9d5ff 0%, #9333ea 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 6. ORANGE (Magma / Peach) --- */
        body[data-theme="orange-dark"] .logo span,
        body[data-theme="orange-light"] .logo span,
        body[data-theme="orange-dark"] .sum-logo-text span.grad,
        body[data-theme="orange-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #fb923c 0%, #ea580c 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 7. NOIR (Черно-белая) --- */
        body[data-theme="noir"] .logo span,
        body[data-theme="noir"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #ffffff 0%, #888888 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        /* --- 8. OLD MONEY (Mahogany) --- */
        body[data-theme="old-money"] .logo span,
        body[data-theme="old-money"] .sum-logo-text span.grad {
            /* Золотой градиент */
            background: linear-gradient(180deg, #e6c98c 20%, #c5a059 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* --- 9. DEFAULT (Розовый) --- */
        body:not([data-theme^="blue"]):not([data-theme^="green"]):not([data-theme^="red"]):not([data-theme^="gold"]):not([data-theme^="purple"]):not([data-theme^="orange"]):not([data-theme="noir"]):not([data-theme="old-money"]) .logo span {
            background: linear-gradient(180deg, #CB53F0 20%, #ff00cc 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }


        /* === НОВЫЙ БЛОК ИНТЕНСИВНОСТИ === */
        .intensity-wrapper {
            background: var(--nav-bg); /* Цвет фона как у активных элементов */
            border-radius: 20px;       /* Закругленные края */
            padding: 15px 10px;        /* Внутренние отступы */
            margin: 10px 12px 12px 12px; /* Отступы от краев группы */
            border: 1px solid var(--border);
        }

        .intensity-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 5px;
        }

        .intensity-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-main);
            letter-spacing: 1px;
        }

        /* Ограничитель ширины для слайдера и иконок */
        .intensity-controls-inner {
            width: 80%;       /* Слайдер стал меньше (уже) */
            margin: 0 auto;   /* Центрирование */
            position: relative;
        }

        /* =========================================
        18. MEDIA QUERIES (ADAPTATION)
        ========================================= */

        @media (max-width: 768px) {
            #row-install-app, 
            #group-install-container { 
                display: none !important;
            }
        }

        /* DESKTOP / TABLET (> 768px) */
        @media (min-width: 769px) {
            
            /* 1. Глобальный контейнер таба - центрирует всё содержимое */
            #tab-home {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                height: 100vh !important;
                width: 100% !important;
                padding: 0 !important;
                overflow: hidden !important;
                position: relative; 
            }

            /* 2. Промежуточная обертка - сжимаем её до размера контента */
            #tab-home .center-wrapper {
                height: auto !important;
                width: auto !important; /* Не растягивать на всю ширину! */
                max-width: none !important; 
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                margin: 0 auto !important; /* Центрирование по горизонтали */
                flex-direction: column !important;
            }

            /* 3. ЯКОРЯ КАРТОЧКИ (Самое важное для иконок) */
            /* Задаем им фиксированную ширину, чтобы иконки знали, где "край" карточки */
            #card-anchor, #card-anim-wrapper {
                width: 650px !important; /* Ширина равна ширине карточки */
                max-width: 90vw !important;
                position: relative !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
            }

            /* 4. САМА КАРТОЧКА */
            .card {
                width: 100% !important; /* Занимает всю ширину якоря (650px) */
                height: 85vh !important;
                
                min-height: 700px !important;
                max-height: 950px !important;
                
                margin: 0 !important;
                justify-content: space-between !important; 
            }

            /* 5. ИКОНКИ НА ПК (Возвращаем их на место) */
            .icon-left {
                width: 160px !important; /* Чуть крупнее для ПК */
                top: -40px !important;
                left: -40px !important;
            }
            .icon-right {
                width: 130px !important;
                top: -30px !important;
                right: -30px !important;
            }

            /* 6. ТЕКСТ РЕЗУЛЬТАТА */
            .slot-window {
                height: 55% !important; 
                display: flex !important;
                align-items: center !important;
            }
            .slot-item {
                font-size: 110px !important; 
                line-height: 1.1 !important;
            }

            /* 7. Фраза над карточкой */
            .status-text-combined {
                font-size: 24px !important;
                margin-bottom: 30px !important;
                white-space: nowrap; /* Чтобы не переносилась */
            }

            /* 8. Кнопки управления */
            .t-circle-btn.large { width: 90px !important; height: 90px !important; font-size: 40px !important; }
            .t-circle-btn.medium { width: 70px !important; height: 70px !important; font-size: 30px !important; }
            
            /* 9. Модальные окна */
            #modal-sub-overlay .modal {
                width: 950px !important;
                max-width: 95% !important;
            }
            .plans-container { flex-direction: row; align-items: stretch; justify-content: center; }
            .plan-card { flex: 1; }
        }

        #hist-list-swipes, #hist-list-watch {
            padding-bottom: 20px;
        }

        .stats-tf-capsule, 
        .stats-nav-capsule {
            flex-shrink: 0 !important;
            width: 100% !important;
        }

        @media (min-width: 769px) {
            .plans-container {
                flex-direction: row !important;
                align-items: stretch !important;
            }
        }

        /* Закрепленный футер модального окна */
        .modal-footer {
            flex-shrink: 0; /* Запрещаем сжиматься */
            padding: 15px 20px;
            background: var(--sidebar-bg); /* Цвет фона как у модалки */
            border-top: 1px solid var(--border); /* Разделитель сверху */
            z-index: 10;
            
            /* Учет безопасной зоны на iPhone (чтобы не перекрывало полоску домой) */
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        /* Корректировка капсулы, чтобы она растягивалась красиво */
        .modal-footer .stats-nav-capsule {
            margin-top: 0;
            width: 100%;
        }

        /* VERSION CAPSULE STYLE */
        .version-card {
            display: flex;
            align-items: center; /* Центрирование по вертикали */
            justify-content: space-between;
            
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 18px; /* Скругление капсулы */
            padding: 12px 16px;
            margin-bottom: 10px;
            
            transition: transform 0.2s;
        }

        .version-card:active {
            transform: scale(0.98);
            background: var(--nav-bg);
        }

        /* Левая часть: Версия */
        .v-ver-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--accent);
            font-weight: 800;
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 10px;
            min-width: 50px;
            text-align: center;
            margin-right: 12px;
            flex-shrink: 0; /* Чтобы не сжималась */
        }

        /* Середина: Описание */
        .v-content {
            flex: 1; /* Занимает всё свободное место */
            font-size: 13px;
            color: var(--text-main);
            line-height: 1.3;
            margin-right: 12px;
            font-weight: 500;
        }

        /* Правая часть: Дата */
        .v-date {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            white-space: nowrap; /* Чтобы дата не переносилась */
            flex-shrink: 0;
        }

        /* === BENTO GRID SYSTEM === */
        .bento-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Две колонки */
            grid-auto-rows: min-content;    /* Высота по содержимому */
            gap: 12px;
            padding-bottom: 20px;
        }

        /* Базовая карточка Бенто */
        .bento-box {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .bento-box:active {
            transform: scale(0.98);
            background: var(--nav-bg);
        }

        /* --- ТИПЫ БЛОКОВ --- */

        /* 1. Широкий блок (на всю ширину) */
        .bento-wide {
            grid-column: span 2;
        }

        /* 2. Блок подписки (Акцентный) */
        .bento-sub {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            min-height: 100px;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Цветовые модификаторы для подписки */
        .bento-sub.is-free { border-color: var(--border); }
        .bento-sub.is-pro { border-color: #ff9900; background: linear-gradient(135deg, rgba(255, 153, 0, 0.1), transparent); }
        .bento-sub.is-beast { border-color: #9b59b6; background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), transparent); }
        .bento-sub.is-bestie { border-color: #00d2ff; background: linear-gradient(135deg, rgba(0, 210, 255, 0.1), transparent); }

        /* 3. Квадратные статы (Apple Watch style) */
        .bento-stat {
            aspect-ratio: 1.1 / 1; /* Почти квадрат */
            justify-content: space-between;
        }

        .bento-stat-large {
            display: flex;
            flex-direction: column;
            align-items: center;      /* Центрирование по горизонтали */
            justify-content: center;  /* Центрирование по вертикали */
            text-align: center;
            padding: 15px 10px;
            gap: 6px;                 /* Отступы между элементами */
            aspect-ratio: 1 / 1;      /* Строгий квадрат */
        }

        /* Крупная иконка по центру */
        .bento-img-icon {
            width: 42px;
            height: 42px;
            object-fit: contain;
            margin-bottom: 2px;
            
            /* Адаптация цвета (инверсия для темной темы, как в сайдбаре) */
            filter: invert(1);
            opacity: 0.9;
            transition: transform 0.2s;
        }

        /* Светлая тема - иконки темные */
        body.light-theme .bento-img-icon {
            filter: invert(0);
            opacity: 0.7;
        }

        /* Эффект при нажатии на блок */
        .bento-stat-large:active .bento-img-icon {
            transform: scale(0.9);
        }

        /* Корректировка цифры */
        .bento-stat-large .bento-val {
            font-size: 28px;     /* Чуть крупнее */
            margin-top: 0;       /* Убираем старый margin-top: auto */
            line-height: 1;
        }

        /* Корректировка подписи */
        .bento-stat-large .bento-label {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 2px;
        }

        /* --- ВНУТРЕННОСТИ КАРТОЧЕК --- */

        /* Иконка в углу */
        .bento-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: var(--bg-color); /* Темнее фона карточки */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* Заголовок (мелкий) */
        .bento-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Значение (большое) */
        .bento-val {
            font-size: 26px;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-top: auto; /* Прижать к низу, если флекс */
        }

        /* Профиль (User Identity) */
        .bento-profile {
            display: flex;
            flex-direction: row !important;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
        }
        .profile-avatar {
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            background: var(--nav-bg); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 16px;
        }

        /* Кнопка синхронизации */
        .bento-action {
            background: var(--accent);
            color: #000;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 14px;
            padding: 18px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
        }
        .bento-action:active {
            transform: scale(0.96);
            filter: brightness(0.9);
        }

        /* Кнопки выхода/сброса (мелкие внизу) */
        .bento-footer-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 5px;
        }
        .bento-small-btn {
            flex: 1;
            padding: 12px;
            border-radius: 16px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        #age-gate {
            background-color: var(--bg-color) !important; /* Сплошной цвет темы */
            backdrop-filter: none !important; /* Убираем блюр, он не нужен на сплошном */
            opacity: 1 !important; /* Гарантируем видимость */
        }

        /* 2. Центрирование кнопок в модальных окнах (Установка и Онбординг) */
        #modal-install-overlay .btn-gen,
        #onboarding-overlay .btn-gen {
            display: flex !important;
            justify-content: center !important; /* Центрирует текст/иконку по горизонтали */
            align-items: center !important;     /* Центрирует по вертикали */
            text-align: center !important;      /* На всякий случай для текста */
            width: 100% !important;             /* Растягиваем кнопку на всю ширину */
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        #block-account .ios-row[onclick*="handleLoginClick"] {
            padding: 10px 12px !important;
        }

        #block-prefs .ios-group > div:not(.ios-row):not(.custom-separator) {
            padding: 10px 10px 8px 14px !important; 
        }

        @media (min-width: 769px) {
            #block-account .ios-row[onclick*="handleLoginClick"] {
                padding: 8px 10px !important;
            }
        }

        /* =========================================
        MACOS STYLE SIDEBAR (DESKTOP ONLY)
        ========================================= */
        @media (min-width: 769px) {
            
            body {
                /* Добавляем немного отступа контенту, чтобы он не прилипал к парящему сайдбару */
                overflow: hidden; /* Убираем скролл у всего body */
            }

            .sidebar {
                /* 1. РАЗМЕРЫ И ОТСТУПЫ (Парящий эффект) */
                height: calc(100vh - 20px) !important;
                margin-top: 10px !important;
                margin-left: 10px !important;
                margin-bottom: 10px !important;
                margin-right: 0 !important; /* Справа не нужен отступ, там контент */
                
                border-radius: 22px !important;

                padding: 10px !important;
                
                /* 2. ЭФФЕКТ СТЕКЛА (Glassmorphism) */
                background: rgba(28, 28, 30, 0.65) !important; 
                
                backdrop-filter: blur(25px) saturate(180%) !important;
                -webkit-backdrop-filter: blur(25px) saturate(180%) !important;
                
                /* 3. ГРАНИЦЫ И ТЕНИ */
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-right: 1px solid rgba(255, 255, 255, 0.1) !important; /* Перебиваем старый border-right */
                
                /* Глубокая тень для ощущения "парения" */
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5) !important;
                
                z-index: 100 !important;
            }

            /* Адаптация для СВЕТЛОЙ ТЕМЫ */
            body.light-theme .sidebar {
                /* Полупрозрачный белый */
                background: rgba(255, 255, 255, 0.65) !important;
                border: 1px solid rgba(0, 0, 0, 0.05) !important;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            }

            /* Убираем скроллбар внутри сайдбара, чтобы было красиво, но оставляем возможность скроллить */
            .sidebar::-webkit-scrollbar {
                width: 0px;
                background: transparent;
            }
            
            /* Корректируем логотип, чтобы он красиво смотрелся в стекле */
            .sidebar .logo {
                margin-top: 10px !important; 
                margin-bottom: 10px !important;
                min-height: 40px;            
            }
        }

        @media (max-width: 768px) {
    
            /* 1. СКРЫВАЕМ ЗАГОЛОВКИ БЛОКОВ */
            .ios-header {
                display: none !important;
            }

            /* 2. УБИРАЕМ ВНУТРЕННИЕ ОТСТУПЫ У КОНТЕЙНЕРОВ */
            /* Это позволяет блокам растягиваться почти на всю ширину */
            #tab-settings, 
            #tab-account,
            #tab-settings .center-wrapper, 
            #tab-account .center-wrapper {
                padding-left: 0 !important;
                padding-right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            /* 3. НАСТРАИВАЕМ САМИ БЛОКИ */
            .ios-group {
                /* Маленькие отступы от краев (10px) */
                margin-left: 20px !important; 
                margin-right: 20px !important;
                width: auto !important;
                
                margin-top: 0 !important;
                margin-bottom: 15px !important; /* Расстояние между блоками */
            }

            /* 4. ОТСТУП СВЕРХУ ДЛЯ ПЕРВОГО БЛОКА */
            #block-prefs .ios-group:first-child,
            #block-account .ios-group:first-child {
                margin-top: 15px !important;
            }
        }

        @media (max-width: 768px) {
            
            /* Сбрасываем внешние отступы у контейнеров-оберток */
            #block-prefs, #block-account, #block-extras, #block-history {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
                padding-top: 0 !important;
            }

            /* Единственный источник отступа - сама группа кнопок */
            .ios-group {
                /* Стандартный отступ между всеми блоками */
                margin-bottom: 15px !important;
                margin-top: 0 !important;
            }

            /* Фикс для первого элемента, чтобы не прилипал к шапке */
            #block-prefs {
                margin-top: 15px !important;
            }
            
        }

        /* --- 2. ПК ВЕРСИЯ (Стиль macOS Finder) --- */
        @media (min-width: 769px) {
            
            /* Возвращаем заголовки (делаем их маленькими и аккуратными) */
            .ios-header {
                display: flex !important;
                font-size: 11px !important;
                font-weight: 700 !important;
                color: var(--text-secondary) !important;
                margin: 15px 0 5px 12px !important; /* Отступы как в списках */
                text-transform: uppercase;
                opacity: 0.7;
            }

            /* УБИРАЕМ СТИЛЬ КАРТОЧКИ У БЛОКОВ (Прозрачный фон, без границ) */
            .ios-group {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important; /* Чтобы ховер не обрезался */
            }

            /* СТИЛИЗУЕМ СТРОКИ (КНОПКИ) */
            .ios-row {
                background: transparent !important; /* Прозрачный фон */
                border-radius: 8px !important;      /* Скругление при наведении */
                margin: 0 5px 2px 5px !important;   /* Небольшой зазор между кнопками */
                padding: 8px 10px !important;       /* Компактные отступы внутри */
                min-height: 36px !important;        /* Чуть компактнее по высоте */
                border: none !important;            /* Убираем границы */
            }

            /* Убираем линии-разделители между кнопками */
            .ios-row::after {
                display: none !important;
            }

            /* Эффект наведения (Светлая подсветка как в macOS) */
            .ios-row.clickable:hover {
                background: rgba(255, 255, 255, 0.1) !important;
            }
            
            /* Для светлой темы на ПК */
            body.light-theme .ios-row.clickable:hover {
                background: rgba(0, 0, 0, 0.05) !important;
            }

            /* Убираем шевроны (стрелочки) на ПК, для чистоты */
            .chevron {
                opacity: 0.3;
            }
        }

        /* === PC TWEAKS FOR GRIDS (3 COLUMNS) === */
        @media (min-width: 769px) {
            
            /* 1. Делаем модальные окна шире именно для Tips и Explored, 
                чтобы 3 карточки влезли свободно */
            #modal-tips-overlay .modal,
            #modal-explored-overlay .modal {
                width: 750px !important; /* Увеличили ширину (было 550px) */
                max-width: 95vw !important;
            }

            /* 2. Переключаем сетку на 3 колонки */
            .tips-grid,
            .explored-grid {
                grid-template-columns: repeat(3, 1fr) !important; /* 3 равные колонки */
                gap: 20px !important; /* Чуть больше воздуха между карточками */
            }

            .ex-card-title {
                font-size: 12px !important; 
            }
        }

        /* === НОВЫЕ СТИЛИ ДЛЯ БАЗЫ ЗНАНИЙ (КАРУСЕЛЬ) === */

        /* Заголовок категории */
        .tips-category-title {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 30px 0 15px 0;
            text-align: center; /* Центрирование */
            width: 100%;
        }

        /* Контейнер скролла */
        .tips-scroll-row {
            display: flex;
            overflow-x: auto;
            overflow-y: visible; /* Чтобы тени не обрезались */
            gap: 15px;
            padding: 20px 20px 40px 20px; /* Отступы по бокам + снизу для теней */
            
            /* Убираем жесткий snap, чтобы скролл был плавным как в Instagram/AppStore */
            /* scroll-snap-type: x mandatory; <- УДАЛЕНО, чтобы не конфликтовало */
            
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .tips-scroll-row::-webkit-scrollbar { display: none; }

        /* Карточка */
        .tip-card {
            /* Фиксируем размер, но используем min-width, чтобы не сжимались */
            min-width: 240px;
            width: 240px;
            height: 320px;
            
            display: flex;
            flex-direction: column;
            
            /* ВАЖНО: visible, чтобы иконка могла торчать наружу */
            overflow: visible !important; 
            
            border-radius: 24px;
            border: 1px solid var(--border);
            background: var(--ios-card);
            position: relative;
            cursor: pointer;
            
            /* Убираем тусклость */
            opacity: 1 !important;
            filter: none !important;
            transform: scale(1) !important;
            
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .tip-card:active {
            transform: scale(0.96) !important;
        }

        /* Верхняя цветная часть (1/3) */
        .tip-card-header {
            height: 35% !important;
            width: 100%;
            /* Скругляем только верх */
            border-radius: 24px 24px 0 0;
        }

        /* Нижняя часть (2/3) */
        .tip-card-body {
            height: 65% !important;
            width: 100%;
            padding: 15px;
            background: var(--ios-card);
            
            display: flex;
            flex-direction: column;
            text-align: left; /* Текст слева, как раньше */
            
            /* Скругляем только низ */
            border-radius: 0 0 24px 24px;
            position: relative;
        }

        .tip-card-icon {
            font-size: 42px;
            position: absolute;
            
            /* Поднимаем вверх, чтобы она села на границу */
            top: -25px !important; 
            left: 15px !important;
            
            /* Сбрасываем центрирование, которое ломало вид */
            transform: none !important; 
            
            z-index: 10;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
            line-height: 1;
        }

        /* Заголовок */
        .tip-card-title {
            /* Отступ сверху, чтобы не наехать на иконку */
            margin-top: 25px !important;
            font-size: 15px;
            font-weight: 800;
            line-height: 1.2;
            color: var(--text-main);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Описание */
        .tip-card-desc {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.7;
            line-height: 1.4;
            color: var(--text-secondary);
            
            display: -webkit-box;
            -webkit-line-clamp: 5; /* Показываем больше текста */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Галочка прочитанного */
        .tip-card.viewed::after {
            content: "✓";
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            z-index: 20;
            backdrop-filter: blur(4px);
        }

        .seo-context {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

    </style>

</head>
<body>

<!-- EKRAN ZAGRUZKI -->
<div id="loading-overlay">
    <img src="icon_light.png" class="loader-logo" alt="Loading...">
    <div class="loader-text" id="loader-phrase">INITIALIZING...</div>
    
    <div class="loader-progress-container">
        <div class="loader-progress-fill" id="loader-bar"></div>
    </div>
</div>

<script>
    (function() {
        // 1. МГНОВЕННАЯ УСТАНОВКА ЦВЕТА ФОНА (Чтобы не мигало)
        const themeId = localStorage.getItem('xch_theme_id') || 'dark';
        const overlay = document.getElementById('loading-overlay');
        const fill = document.getElementById('loader-bar');
        const logo = document.querySelector('.loader-logo');
        const text = document.getElementById('loader-phrase');

        // Карта цветов фона
        const bgColors = {
            'dark': '#12000b', 'light': '#ffeef8',
            'blue-dark': '#020c1b', 'blue-light': '#dbeafe',
            'green-dark': '#020a02', 'green-light': '#dcfce7',
            'red-dark': '#0d0000', 'red-light': '#ffe4e6',
            'gold-dark': '#0a0900', 'gold-light': '#fef3c7',
            'noir': '#000000', 'old-money': '#1a0505'
        };
        // Карта акцентов (для бара)
        const accentColors = {
            'dark': '#ff00cc', 'light': '#db2777',
            'blue-dark': '#64ffda', 'blue-light': '#2563eb',
            'green-dark': '#2ecc71', 'green-light': '#16a34a',
            'red-dark': '#e74c3c', 'red-light': '#e11d48',
            'gold-dark': '#f1c40f', 'gold-light': '#d97706',
            'noir': '#ffffff', 'old-money': '#c5a059'
        };

        if (bgColors[themeId]) overlay.style.backgroundColor = bgColors[themeId];
        if (accentColors[themeId]) fill.style.background = accentColors[themeId];

        // Адаптация под светлую тему
        if (themeId.includes('light')) {
            text.style.color = '#555';
            logo.style.filter = 'invert(1)';
            document.querySelector('.loader-progress-container').style.background = 'rgba(0,0,0,0.1)';
        }

        // 2. СПИСОК ФРАЗ (Англ + немного юмора/техно)
        const phrases = [
            "Warming up engines...",
            "Decrypting desires...",
            "Loading pleasure...",
            "Scanning for kinks...",
            "Preparing visuals...",
            "Calibrating algorithms...",
            "Checking compatibility...",
            "Connecting to the hub...",
            "Fetching spicy data...",
            "Analyzing preferences...",
            "Unlocking categories...",
            "Setting the mood...",
            "Almost there...",
            "Optimizing experience..."
        ];

        // 3. АНИМАЦИЯ ФРАЗ
        let phraseIndex = Math.floor(Math.random() * phrases.length);
        text.innerText = phrases[phraseIndex]; // Первая фраза сразу

        const phraseInterval = setInterval(() => {
            phraseIndex = (phraseIndex + 1) % phrases.length;
            text.innerText = phrases[phraseIndex];
        }, 800); // Меняем каждые 800мс

        // 4. СИМУЛЯЦИЯ ПРОГРЕСС БАРА
        let progress = 0;
        const progressInterval = setInterval(() => {
            // Быстро до 30%, медленнее до 70%, очень медленно до 90%
            let increment = 0;
            if (progress < 30) increment = Math.random() * 5;
            else if (progress < 70) increment = Math.random() * 2;
            else if (progress < 90) increment = Math.random() * 0.5;
            
            progress += increment;
            if (progress > 90) progress = 90; // Ждем полной загрузки страницы
            
            fill.style.width = progress + '%';
        }, 100);

        // Сохраняем ID интервалов в window, чтобы остановить их при полной загрузке
        window.loaderIntervals = { phrase: phraseInterval, progress: progressInterval };
    })();
</script>

<div class="top-gradient-mask"></div>

<div class="app-layout">

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <!-- Логотип: Картинка + Текст -->
        <div class="logo" onclick="resetToHome()">
            <img src="logo.png" alt="X" class="logo-img">
            x<span>Fetish</span>Hub
        </div>
        <!-- Подзаголовок -->
        <div class="subtitle" data-key="subtitle">Your home for adult preferences</div>

        <div id="pc-settings-mount"></div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <div class="mobile-header">
            <div class="logo" onclick="resetToHome()"> 
                <img src="logo.png" alt="X" class="logo-img">
                x<span>Fetish</span>Hub
            </div>
            <div class="subtitle" data-key="subtitle">Your home for adult preferences</div>
            
        </div>

       <!-- TAB 1: HOME -->
        <div id="tab-home" class="tab-content active">
            <div class="center-wrapper">

                <!-- ЯКОРЬ -->
                <div id="card-anchor" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: visible;">
                    
                    <!-- ОБЁРТКА (Wrapper) -->
                    <div id="card-anim-wrapper" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: visible; z-index: 10;">
                        
                        <!-- 1. ФРАЗА СЮДА -->
                        <div class="status-text-combined stagger-item delay-5" id="status-text"></div>

                        <!-- 2. Иконки -->
                        <img src="" id="deco-left" class="deco-icon icon-left" alt="">
                        <img src="" id="deco-right" class="deco-icon icon-right" alt="">


                        <!-- КАРТОЧКА -->
                        <div class="card" id="card-block">

                            <div id="card-notch" class="card-notch">
                                <span id="card-notch-text">STATUS</span>
                            </div>

                            <!-- START SCREEN OVERLAY -->
                            <div id="mode-start-overlay" class="mode-start-overlay hidden">
                                
                                <!-- Текст-приветствие -->
                                <div id="mode-start-text" class="mode-greeting-text" data-key="mode_greeting_hint">
                                    What are we watching today?
                                </div>
                                
                                <!-- КНОПКИ РЕЖИМОВ -->
                                <div id="mode-buttons-container" class="mode-buttons-row">
                                    
                                    <!-- 1. Explore (Scope Icon) -->
                                    <button class="mode-circle-btn side-btn explore" onclick="setAppModeAndStart('explore')">
                                        <img src="scope.png" class="side-icon-img" alt="Explore">
                                    </button>
                                    
                                    <!-- 2. AI Assistant (AI Icon) -->
                                    <button class="mode-circle-btn center-btn ai-assist" onclick="openAssistantUI()">
                                        <img src="ai.png" class="ai-icon-img" alt="AI">
                                    </button>
                                    
                                    <!-- 3. Pleasure (Favorite Icon) -->
                                    <button class="mode-circle-btn side-btn pleasure" onclick="setAppModeAndStart('pleasure')">
                                        <img src="favorite.png" class="side-icon-img" alt="Pleasure">
                                    </button>

                                </div>

                                <!-- UI АССИСТЕНТА -->
                                <div id="assistant-ui" class="assistant-ui">
                                    <div class="assistant-prompt" data-key="ai_prompt">What do you desire? 😏</div>
                                    
                                    <div class="assistant-input-group" style="position: relative; overflow: hidden;">
                                        <!-- 1. Контейнер рулетки (Абсолютно поверх фона, под инпутом) -->
                                        <div id="ai-rolling-container" class="rolling-input-overlay">
                                            <div class="rolling-list" id="ai-rolling-list">
                                                <!-- Сюда JS вставит варианты -->
                                            </div>
                                        </div>

                                        <!-- 2. Сам инпут (Прозрачный фон) -->
                                        <input type="text" id="ai-input" class="assistant-input" style="position: relative; z-index: 2; background: transparent !important;" autocomplete="off">
                                        
                                        <button class="btn-mic-trigger" id="btn-mic" onclick="toggleVoiceInput()" style="position: relative; z-index: 3;">
                                            <img src="voice.png" class="voice-icon-img" alt="Voice">
                                        </button>
                                    </div>

                                    <button id="btn-ai-go" class="btn-ai-confirm" onclick="processAiRequest()">
                                        <span data-key="ai_btn_go">Find It</span>
                                    </button>
                                    
                                    <div class="btn-ai-cancel" onclick="closeAssistantUI()">
                                        <span data-key="btn_cancel">Cancel</span>
                                    </div>
                                </div>

                                <!-- UI ДУМАНИЯ -->
                                <div id="thinking-ui" class="thinking-ui">
                                    <div class="thinking-spinner"></div>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--text-secondary);" id="ai-thinking-text" data-key="ai_thinking">Thinking...</div>
                                </div>
                            </div>

                            <!-- Оверлей для цвета при свайпе -->
                            <div class="swipe-overlay"></div>
                            
                            <!-- Верхняя часть: Бейджи -->
                            <div style="width:100%; display:flex; justify-content:center; min-height: 30px; flex-shrink: 0;" class="stagger-item delay-1" id="badge-container-anim">
                                <div class="badge-wrapper" id="badge-wrapper"></div>
                            </div>

                            <!-- ЦЕНТРАЛЬНАЯ ЧАСТЬ (flex-grow: 1, чтобы занимать всё свободное место) -->
                            <div style="width:100%; display:flex; flex-direction:column; align-items:center; justify-content: center; flex-grow: 1; overflow: hidden;">
                                
                                <!-- Название (Слот-машина) -->
                                <div class="slot-window">
                                    <div id="slot-reel" class="slot-reel">
                                        <!-- Начальный текст -->
                                        <div class="slot-item" id="result-text" style="opacity: 0.8; font-size: 32px;">Ready?</div>
                                    </div>
                                </div>
                                
                                <!-- Описание -->
                                <div id="result-desc" class="result-description stagger-item delay-2"></div>
                                
                                <!-- "Вам может понравиться" -->
                                <div class="related-section hidden-initial stagger-item delay-3" id="related-block">
                                    <div class="related-title" data-key="related_header">You might also like:</div>
                                    <div class="related-tags" id="related-tags"></div>
                                </div>
                            </div>

                            <!-- НИЖНЯЯ ЧАСТЬ: Кнопки (flex-shrink: 0, чтобы не сжимались) -->
                            <div style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top: auto; flex-shrink: 0; padding-bottom: 5px;">
                                
                                <!-- 1. Кнопка СТАРТА (Внутри карточки) -->
                                <div id="start-btn-container">
                                    <button class="btn-start-capsule" onclick="startNewSession()">
                                        🔥 <span data-key="btn_start">Let's Go</span>
                                    </button>
                                </div>

                                <!-- 2. КНОПКИ УПРАВЛЕНИЯ -->
                                <div class="tinder-nav-row hidden-initial stagger-item delay-4" id="tinder-controls">
                                    
                                    <!-- BACK -->
                                    <button class="t-circle-btn small undo" id="btn-t-undo" onclick="undoLastAction()">
                                        <img src="back.png" class="action-icon-img" alt="Undo">
                                    </button>
                                    
                                    <!-- DISLIKE -->
                                    <button class="t-circle-btn medium dislike" id="btn-t-pass" onclick="handleSwipeAction('left')">
                                        <img src="dislike.png" class="action-icon-img" alt="Pass">
                                    </button>
                                    
                                    <!-- WATCH -->
                                    <a href="#" target="_blank" class="t-circle-btn large watch" id="btn-t-watch" onclick="handleOutboundClick(event)">
                                        <img src="watch.png" class="action-icon-img" alt="Watch">
                                    </a>
                                    
                                    <!-- LIKE -->
                                    <button class="t-circle-btn medium like" id="btn-t-like" onclick="handleSwipeAction('right')">
                                        <img src="like.png" class="action-icon-img" alt="Like">
                                    </button>
                                    
                                    <!-- WATCH LATER -->
                                    <button class="t-circle-btn small wl" id="btn-t-wl" onclick="toggleWatchLater()">
                                        <img src="watchlater.png" class="action-icon-img" alt="Later">
                                    </button>
                                </div>

                                <!-- 3. Модификаторы (Expandable Capsule) -->
                                <div id="mods-block" class="hidden-initial stagger-item delay-4" style="width:100%; display: flex; justify-content: center;">
                                    
                                    <!-- Сама капсула -->
                                    <div id="mods-capsule" class="mods-wrapper-expanded" onclick="toggleModifiers(event)">
                                        <!-- Иконка (Плюс / Крестик) -->
                                        <div class="mods-icon-plus">+</div>
                                        
                                        <!-- Контейнер для тегов (Сюда JS будет вставлять кнопки) -->
                                        <div class="mods-content" id="mod-container">
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div> <!-- Конец .card -->
                    </div> <!-- Конец #card-anim-wrapper -->
                </div>
            </div>
        </div>

        <!-- TAB 2: SETTINGS -->
        <div id="tab-settings" class="tab-content">
            <div class="center-wrapper">
                <div id="mount-prefs"></div>
            </div>
        </div>

        <!-- TAB 3: ACCOUNT (Account & Extras) -->
        <div id="tab-account" class="tab-content">
            <div class="center-wrapper">
                <div id="mount-account"></div>
                <div id="mount-extras"></div>
            </div>
        </div>
    </div>
 </div>

<div class="bottom-gradient-mask"></div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <img src="home.png" class="nav-icon-img" alt="Home">
        <span data-key="nav_home">Home</span>
    </div>
    <div class="nav-item" onclick="switchTab('settings')" id="nav-settings">
        <img src="settings.png" class="nav-icon-img" alt="Settings">
        <span data-key="nav_settings">Settings</span>
    </div>
    <div class="nav-item" onclick="switchTab('account')" id="nav-account">
        <img src="account.png" class="nav-icon-img" alt="Account">
        <span data-key="nav_account">Account</span>
    </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal-overlay" id="modal-history-overlay" onclick="closeHistoryModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="history_title">History</span>
            <span onclick="closeHistoryModal(null, true)">✕</span>
        </div>
        
        <!-- Тело с контентом (скроллится) -->
        <div class="modal-body" style="padding-bottom: 10px !important;">
            <div id="hist-list-swipes" style="display:block;"></div>
            <div id="hist-list-watch" style="display:none;"></div>
            <div id="hist-list-wrapped" style="display:none;"></div>
        </div>

        <!-- Футер с кнопками (ПРИБИТ К НИЗУ) -->
        <div class="modal-footer">
            <div class="stats-nav-capsule">
                <div class="stats-nav-item active" id="hist-nav-swipes" onclick="switchHistoryTab('swipes')">
                    <span data-key="hist_tab_swipes">Swipes</span>
                </div>
                <div class="stats-nav-item" id="hist-nav-watch" onclick="switchHistoryTab('watch')">
                    <span data-key="hist_tab_watch">Time</span>
                </div>
                <div class="stats-nav-item" id="hist-nav-wrapped" onclick="switchHistoryTab('wrapped')">
                    <span>Wrapped</span>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- FAVORITES (LIKED) MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeList(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="favorites_catalog">Liked</span>
            <span onclick="closeList(null, true)">✕</span>
        </div>
        <div class="modal-body" id="modal-catalog-body">
            <!-- JS inserts content here -->
        </div>
    </div>
</div>

<!-- BLACKLIST (DISLIKED) MODAL -->
<div class="modal-overlay" id="modal-blacklist-overlay" onclick="closeBlacklist(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="blacklist_catalog">Disliked</span>
            <span onclick="closeBlacklist(null, true)">✕</span>
        </div>
        <div class="modal-body" id="modal-blacklist-body">
            <!-- JS inserts content here -->
        </div>
    </div>
</div>

<!-- STATISTICS MODAL -->
<div class="modal-overlay" id="modal-stats-overlay" onclick="closeStats(event)">
    <div class="modal">
        <div class="modal-header">
            <!-- Заголовок по центру -->
            <span data-key="btn_stats">Statistics</span>
            
            <!-- Кнопка Share справа -->
            <div class="modal-header-actions">
                <div class="icon-btn-round" onclick="shareStats()" title="Share">
                    <img src="share.png" class="share-icon-img" alt="Share">
                </div>
            </div>
        </div>

        <div class="modal-body">
            <!-- Wrapped Button -->
            <button id="btn-wrapped-trigger" onclick="openWrapped()" class="btn-gen" style="width:100%; padding:12px; margin-bottom:15px; font-size:14px; background: linear-gradient(45deg, #FF9900, #9B59B6); color:#fff; display:none; border:none; border-radius:16px; font-weight:800; text-transform:uppercase; letter-spacing:1px; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);">
                <span data-key="wrapped_btn">Fetish Wrapped ✨</span>
            </button>

            <!-- Chart Container -->
            <div id="modal-stats-body" style="min-height: 250px;"></div>

            <!-- Footer Controls -->
            <div style="margin-top: 20px;">
                <div class="stats-tf-capsule">
                    <div class="stats-tf-item active" id="tf-week" onclick="switchTimeframe('week')">Week</div>
                    <div class="stats-tf-item" id="tf-month" onclick="switchTimeframe('month')">Month</div>
                    <div class="stats-tf-item" id="tf-year" onclick="switchTimeframe('year')">Year</div>
                    <div class="stats-tf-item" id="tf-all" onclick="switchTimeframe('all')">All</div>
                </div>
                <div class="stats-nav-capsule" style="margin-top: 8px;">
                    <div class="stats-nav-item active" id="stat-nav-tags" onclick="switchStatsTab('tags')">
                        <span data-key="stats_prefs">Preferences</span>
                    </div>
                    <div class="stats-nav-item" id="stat-nav-activity" onclick="switchStatsTab('activity')">
                        <span data-key="stats_activity">Activity</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AGE GATE OVERLAY -->
<div id="age-gate" class="modal-overlay" style="z-index: 20000; background: var(--bg-color);">
    <div class="center-wrapper" style="text-align:center; padding:20px;">
        
        <!-- Логотип -->
        <div class="logo">
            <img src="logo.png" alt="X" class="logo-img">
            x<span>Fetish</span>Hub
        </div>

        <h2 style="margin-bottom:10px;" data-key="age_title">Age Verification</h2>
        
        <p style="color:var(--text-secondary); margin-bottom:30px; line-height:1.5;" data-key="age_desc">
            This website contains age-restricted materials. Are you 18 years or older?
        </p>
        
        <!-- КНОПКИ И ЯЗЫК В ОДНОМ БЛОКЕ -->
        <div style="display:flex; flex-wrap: wrap; gap:10px; width:100%; max-width:320px; justify-content:center; align-items: center;">
            
            <!-- Язык  -->
            <div style="position: relative;">
                <select onchange="changeLanguage(this.value)" style="
                    appearance: none; -webkit-appearance: none;
                    background: transparent;
                    color: var(--text-secondary);
                    border: 1px solid var(--border);
                    border-radius: 20px;
                    padding: 12px 30px 12px 15px; /* Место под стрелочку */
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    height: 100%;
                    min-width: 80px;
                    text-align: center;
                ">
                    <option value="en">EN</option>
                    <option value="ru">RU</option>
                    <option value="es">ES</option>
                    <option value="de">DE</option>
                </select>
                <!-- Кастомная стрелочка -->
                <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; font-size: 10px;">▼</span>
            </div>

            <!-- Кнопка НЕТ -->
            <button class="btn-gen secondary" onclick="blockAccess()" data-key="age_no" style="flex: 1; min-width: 80px; padding: 12px;">No</button>
            
            <!-- Кнопка ДА -->
            <button class="btn-gen" onclick="passAgeGate()" style="background:var(--accent); color:#000; flex: 1.5; padding: 12px;" data-key="age_yes">Yes, 18+</button>
        </div>
    </div>
</div>

<!-- BLOCKED SCREEN -->
<div id="age-block" class="modal-overlay" style="z-index: 20001; background: #000; display:none;">
    <div class="center-wrapper" style="text-align:center;">
        <div style="font-size:50px; margin-bottom:20px;">⛔</div>
        <h2 style="color:#fff;" data-key="age_block_msg">This website is only for users over 18 years of age.</h2>
    </div>
</div>

<!-- ONBOARDING PREFERENCES -->
<div id="onboarding-overlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <span data-key="onb_title">Quick Setup</span>
            <!-- Без кнопки закрытия, так как это обязательный шаг, но есть Skip внизу -->
        </div>
        
        <div class="modal-body">
            <p style="color:var(--text-secondary); font-size:14px; text-align:center; margin-bottom: 20px;" data-key="onb_desc">
                Tell us what you like in one sentence.
            </p>
            
            <textarea id="onb-input" rows="3" 
                style="width:100%; background:var(--bg-color); border:1px solid var(--border); border-radius:12px; padding:12px; color:var(--text-main); font-size:16px; resize:none;"
                placeholder="e.g. I like milf..."></textarea>
            
            <button class="btn-gen" onclick="processOnboardingText()" data-key="onb_btn_check" style="margin-top:15px; padding:12px; font-size:14px;">
                Check
            </button>

            <!-- Results area -->
            <div id="onb-results" style="display:none; flex-direction:column; gap:10px; margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                <div style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; text-align:center;" data-key="onb_found">Found:</div>
                <div id="onb-tags-container" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;"></div>
                <button class="btn-watch" onclick="finishOnboarding()" data-key="onb_btn_confirm" style="margin-top:10px;">Confirm & Start</button>
            </div>
            
            <div style="text-align:center; margin-top:15px;">
                <span style="font-size:13px; color:var(--text-secondary); text-decoration:underline; cursor:pointer;" onclick="skipOnboarding()" data-key="onb_skip">Skip setup</span>
            </div>
        </div>
    </div>
</div>

<div id="ui-blocks-source" style="display:none;">
    
   <!-- BLOCK: PREFERENCES -->
    <div id="block-prefs">
        
        <div class="ios-header" style="margin-top: 0;" data-key="header_prefs">Preferences</div>
        <div class="ios-group">
            
            <!-- 1. Site -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="site.png" class="settings-icon" alt="Site">
                    <span class="platform-label" data-key="site_label">Site</span>
                </div>
                <select id="platform" class="platform-select" onchange="savePlatform(this.value)" dir="rtl">
                    <option value="xh">xHamster</option>
                    <option value="ph">Pornhub</option>
                    <option value="xv">xVideos</option>
                    <option value="sb">SpankBang</option>
                    <option value="yp">YouPorn</option>
                    <option value="rt">RedTube</option>
                    <option value="random" data-key="site_random">Random</option>
                </select>
            </div>

            <!-- 2. Mode -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="modes.png" class="settings-icon" alt="Mode">
                    <span class="platform-label" data-key="mode_label">Mode</span>
                    <img src="question.png" id="tip-icon-modes" class="settings-icon" 
                        onclick="openSpecificTip('modes')"
                        alt="Info" 
                        style="width:14px; height:14px; margin-left:6px; opacity:0.5; cursor:pointer; transition: opacity 0.3s ease;">
                </div>
                <select id="app-mode-select" class="platform-select" onchange="setAppMode(this.value)" dir="rtl">
                    <option value="explore" data-key="mode_explore">Explore</option>
                    <option value="pleasure" data-key="mode_pleasure">Pleasure</option>
                </select>
            </div>
        </div>

        <div class="ios-header" data-key="header_filters">Filters</div>
        <div class="ios-group">
            
            <!-- 3. INTENSITY -->
            <div style="padding: 12px 16px; overflow: visible;">
                <!-- Заголовок + Иконка + Текст значения -->
                <div class="ios-row-left" style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; width: 100%; overflow: visible;">
                    
                    <!-- Левая часть: Иконка и Заголовок -->
                    <div style="display:flex; align-items:center; overflow: visible;">
                        <!-- Контейнер для иконки -->
                        <div style="width: 24px; height: 24px; margin-right: 12px; display: flex; align-items: center; justify-content: center; overflow: visible;">
                            <img src="safe.png" id="main-intensity-icon" class="settings-icon" alt="Safety" style="width: 24px; height: 24px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); object-fit: contain; margin: 0;">
                        </div>
                        <!-- Заголовок -->
                        <div style="display:flex; align-items:center;">
                            <div style="font-size:16px;" data-key="exploration_mode">Intensity</div>
                            <img src="question.png" id="intensity-info-icon" class="settings-icon" 
                                onclick="openSpecificTip('intensity')"
                                alt="Info" 
                                style="width:14px; height:14px; margin-left:6px; opacity:0.5; cursor:pointer; transition: opacity 0.3s ease;">
                        </div>
                    </div>
                    
                    <!-- Текст значения справа -->
                    <span id="intensity-value-label" style="font-size:14px; font-weight:800; opacity: 0; transition: opacity 0.6s ease; text-transform: uppercase; margin-right: 2px;">
                        Safe 🛡️
                    </span>
                </div>
                
                <!-- Слайдер  -->
                <div class="slider-container" style="margin-left: 24px; width: calc(100% - 20px); box-sizing: border-box; margin-bottom: 5px;">
                    <input type="range" min="1" max="3" value="1" step="1" id="intensity-slider" oninput="updateIntensity(this.value)">
                </div>
            </div>

            <!-- РАЗДЕЛИТЕЛЬ -->
            <div class="custom-separator"></div>

            <!-- 4. Orientation -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="orientation.png" class="settings-icon" alt="Orientation">
                    <span class="platform-label" data-key="ori_label">Orientation</span>
                </div>
                <select id="orientation-select" class="platform-select" onchange="changeOrientation(this.value)">
                    <option value="hetero" data-key="ori_hetero">Hetero</option>
                    <option value="gay" data-key="ori_gay">Gay</option>
                    <option value="trans" data-key="ori_trans">Trans</option>
                    <option value="pan" data-key="ori_pan">Pansexual</option>
                </select>
            </div>

            <!-- 5. Language -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="language.png" class="settings-icon" alt="Lang">
                    <span class="platform-label" data-key="lang_label">Language</span>
                </div>
                <select id="lang-select" class="platform-select" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ru">Русский</option>
                    <option value="es">Español</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>

            <!-- 6. Search EN -->
            <div id="comp-search" class="ios-row" style="display:none;">
                <div class="ios-row-left">
                    <img src="en_search.png" class="settings-icon" alt="Search EN">
                    <span class="toggle-text" data-key="search_en_label">Search EN</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="force-en" checked onchange="updateLink()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- 7. Theme -->
            <div class="ios-row clickable" onclick="openThemeModal()">
                <div class="ios-row-left">
                    <img src="appearance.png" class="settings-icon" alt="Theme">
                    <span class="toggle-text" data-key="theme_label">Appearance</span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="current-theme-name" style="color:var(--text-secondary); font-size:15px;">Dark</span>
                    <div class="chevron"></div>
                </div>
            </div>

            <!-- 8. Modifiers -->
            <div class="ios-row clickable" onclick="openModifiersSettings()">
                <div class="ios-row-left">
                    <img src="modifiers.png" class="settings-icon" alt="Mods">
                    <span class="toggle-text" data-key="mod_manage">Manage Modifiers</span>
                </div>
                <div class="chevron"></div>
            </div>

            <!-- 9. Deco -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="deco.png" class="settings-icon" alt="Deco">
                    <span class="toggle-text" data-key="deco_label">Show Decorations</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="deco-toggle" checked onchange="toggleDecoIcons(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- BLOCK: ACCOUNT -->
    <div id="block-account">
        <div class="ios-header" style="display:flex; justify-content:space-between; align-items:baseline; padding-right: 16px;">
            <span data-key="nav_account">Account</span>
            <span id="last-sync-date" style="font-size:11px; color:var(--text-secondary); text-transform:none; font-weight:400; opacity:0.8; display:none;"></span>
        </div>
        
        <div class="ios-group">
            
            <!-- 1. ВХОД -->
            <div class="ios-row clickable" onclick="window.handleLoginClick()" style="padding: 12px 16px;">
                <div class="ios-row-left">
                    <img src="user_account.png" class="settings-icon" alt="User">
                    <span id="login-btn-text" style="font-weight:600; font-size:17px; color:var(--text-main);" data-key="login_text">Sync Data</span>
                </div>
                <div class="chevron"></div>
            </div>

            <!-- 3. СПИСКИ -->
            <div class="ios-row clickable" onclick="openFavoritesCatalog()">
                <div class="ios-row-left">
                    <img src="liked.png" class="settings-icon" alt="Liked">
                    <span data-key="favorites_catalog">Liked</span>
                </div>
                <span class="badge" id="count-fav" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>
            <div class="ios-row clickable" onclick="openBlacklistCatalog()">
                <div class="ios-row-left">
                    <img src="disliked.png" class="settings-icon" alt="Disliked">
                    <span data-key="blacklist_catalog">Disliked</span>
                </div>
                <span class="badge" id="count-ban" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>
            <div class="ios-row clickable" onclick="openWatchLaterCatalog()">
                <div class="ios-row-left">
                    <img src="watched-later.png" class="settings-icon" alt="WL">
                    <span data-key="watch_later">Watch Later</span>
                </div>
                <span class="badge" id="count-wl" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>

            <!-- ADMIN BUTTON -->
            <div id="btn-admin-trigger" class="ios-row clickable" onclick="openAdminModal()" style="display:none;">
                <div class="ios-row-left">
                    <img src="admin.png" class="settings-icon" alt="Admin">
                    <span style="font-weight:700; color:#ff0000;">Admin Panel</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <div class="ios-header" data-key="info_header">Information</div>
        <div class="ios-group">
            
            <!-- 1. ПОЛЕЗНОСТИ -->
            <div class="ios-row clickable" onclick="openTipsModal()">
                <div class="ios-row-left">
                    <img src="book.png" class="settings-icon" alt="Tips" style="margin-right: 12px;">
                    <span data-key="tips_btn">Tips & Tricks</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openStatistics()">
                <div class="ios-row-left">
                    <img src="stats.png" class="settings-icon" alt="Stats">
                    <span data-key="btn_open_stats">Statistics</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openHistoryModal()">
                <div class="ios-row-left">
                    <img src="history.png" class="settings-icon" alt="History">
                    <span data-key="history_title">History</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openExploredModal()">
                <div class="ios-row-left">
                    <img src="explored.png" class="settings-icon" alt="Explored">
                    <span data-key="explored_label">Explored</span>
                </div>
                
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="ex-total-display" style="font-size:15px; color:var(--text-secondary); font-weight:600;">0 / 0</span>
                    <div class="chevron"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- BLOCK: EXTRAS -->
    <div id="block-extras">
    
        <!-- 1. ССЫЛКИ (Community) -->
        <div class="ios-header" data-key="header_community">Community</div>
        <div class="ios-group">
            <!-- Reddit -->
            <div class="ios-row clickable" onclick="window.open('https://www.reddit.com/user/xfetishhub/', '_blank')">
                <div class="ios-row-left">
                    <img src="reddit.png" class="settings-icon" alt="Reddit">
                    <span>Reddit</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>

            <!-- X (Twitter) -->
            <div class="ios-row clickable" onclick="window.open('https://x.com/xfetishhub', '_blank')">
                <div class="ios-row-left">
                    <img src="x.png" class="settings-icon" alt="X">
                    <span>X (Twitter)</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>

            <!-- Report Issue -->
            <div class="ios-row clickable" onclick="window.open('https://tally.so/r/Y50280', '_blank')">
                <div class="ios-row-left">
                    <img src="report.png" class="settings-icon" alt="Report">
                    <span data-key="report_issue">Report Issue</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>

            <!-- About -->
            <div class="ios-row clickable" onclick="window.open('https://www.xfetishhub.site', '_blank')">
                <div class="ios-row-left">
                    <img src="about.png" class="settings-icon" alt="About">
                    <span data-key="lbl_about">About Project</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>
        </div>

        <!-- 2. УСТАНОВКА (Install) -->
        <div class="ios-header" data-key="install_title">Install App</div>
        <div class="ios-group" id="group-install-container">
            <div id="row-install-app" class="ios-row clickable" onclick="openQRModal()">
                <div class="ios-row-left">
                    <img src="install.png" class="settings-icon" alt="Install">
                    <span data-key="btn_install_phone">Install on Phone</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 3. ФУНКЦИИ (Roadmap + Panic) -->
        <div class="ios-header" data-key="header_features">Features</div>
        <div class="ios-group">
            <div class="ios-row clickable" onclick="openRoadmap()">
                <div class="ios-row-left">
                    <img src="roadmap.png" class="settings-icon" alt="Roadmap">
                    <span data-key="btn_roadmap">Roadmap</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openPanicSettings()">
                <div class="ios-row-left">
                    <img src="sos.png" class="settings-icon" alt="SOS">
                    <span data-key="panic_btn">Emergency Mode</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 4. ЮРИДИЧЕСКОЕ (Legal) -->
        <div class="ios-header" data-key="header_legal">Legal</div>
        <div class="ios-group">
            <div class="ios-row clickable" onclick="window.openLegal('terms')">
                <div class="ios-row-left">
                    <img src="terms.png" class="settings-icon" alt="Terms">
                    <span data-key="doc_terms">Terms of Use</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="window.openLegal('privacy')">
                <div class="ios-row-left">
                    <img src="privacy.png" class="settings-icon" alt="Privacy">
                    <span data-key="doc_privacy">Privacy Policy</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="window.openLegal('refund')">
                <div class="ios-row-left">
                    <img src="refund.png" class="settings-icon" alt="Refund">
                    <span data-key="doc_refund">Refund Policy</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 5. СПОНСОРЫ (Sponsors) -->
        <!-- Без заголовка, просто отдельный блок -->
        <div class="ios-group" style="margin-top: 25px;">
            <div class="ios-row clickable" onclick="openSponsorsModal()">
                <div class="ios-row-left">
                    <img src="sponsors.png" class="settings-icon" alt="Sponsors">
                    <span data-key="btn_early_sponsors">Early Sponsors</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 6. ВЕРСИЯ (Version) -->
        <div class="ios-group">
            <div class="ios-row clickable" onclick="openChangelogModal()">
                <div class="ios-row-left">
                    <img src="info.png" class="settings-icon" alt="Version"> 
                    <span data-key="btn_version">Version</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:15px; color:var(--text-secondary); font-weight:500;">0.1</span>
                    <div class="chevron"></div>
                </div>
            </div>
        </div>

    </div>
    
    <div id="block-history" style="margin-top:20px;">
        <div class="ios-header" data-key="history_title">History</div>
        <div class="ios-group" id="history-list"></div>
    </div>
</div>

<!-- SUBSCRIPTION MODAL -->
<div class="modal-overlay" id="modal-sub-overlay" onclick="closeSubModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="sub_title">Premium Access</span>
            <div class="modal-header-actions">
                <div class="icon-btn-round" onclick="closeSubModal(null, true)">✕</div>
            </div>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px; margin-top:5px;">
                <p style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="sub_intro">
                    xFetishHub is an ad-free project. Your subscription ensures its survival.
                </p>
            </div>

            <!-- Toggle -->
            <div class="billing-toggle-container" style="display:flex; justify-content:center; margin-bottom: 20px;">
                <div class="stats-nav-capsule" style="width: auto; min-width: 200px;">
                    <div id="btn-billing-monthly" class="stats-nav-item active" onclick="switchBilling('monthly')" data-key="bill_monthly">
                        Monthly
                    </div>
                    <div id="btn-billing-yearly" class="stats-nav-item" onclick="switchBilling('yearly')">
                        <span data-key="bill_yearly">Yearly</span> <span style="font-size:10px; color:var(--accent); margin-left:3px;">-20%</span>
                    </div>
                </div>
            </div>

            <!-- PLANS GRID -->
            <div class="plans-container">
                
                <!-- 1. FREE -->
                <div class="plan-card">
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px;">Free</div>
                    <div class="plan-price" style="font-size:18px; font-weight:700; margin-bottom:15px;">$0</div>
                    <ul class="plan-features">
                        <li id="free-limit-row">🎲 15 Generations / day</li>
                        <li data-key="feat_wrapped_limited">🎁 1 Fetish Wrapped / week</li>
                        <li data-key="feat_stats_basic">📊 Basic Statistics</li>
                    </ul>
                    <button class="plan-btn current" disabled data-key="btn_current">Current Plan</button>
                </div>

                <!-- 2. PRO -->
                <div class="plan-card pro" style="border-color:#ff9900;">
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px; color:#ff9900;">Pro</div>
                    <div class="plan-price" id="price-pro" style="font-size:18px; font-weight:700; margin-bottom:15px;">$2.99 <span style="font-size:12px">/ mo</span></div>
                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_unlim">🔥 <b>Unlimited</b> Gens</li>
                        <li data-key="feat_stats_adv">📈 Advanced Stats</li>
                        <li data-key="feat_wrapped_unlim">✨ <b>Unlimited</b> Wrapped</li>
                        <li data-key="feat_custom">🎨 Deep Customization</li>
                    </ul>
                    <button class="plan-btn pro-btn" onclick="openPaymentSelection('pro')" data-key="btn_get_pro" style="background:#ff9900; color:#000;">Get Pro</button>
                </div>

                <!-- 3. BEAST -->
                <div class="plan-card beast" style="border-color:#9b59b6;">
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px; color:#9b59b6;">Beast</div>
                    <div class="plan-price" id="price-beast" style="font-size:18px; font-weight:700; margin-bottom:15px;">$4.99 <span style="font-size:12px">/ mo</span></div>
                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_all_pro">👑 <b>All Pro Features</b></li>
                        <li data-key="feat_discord">💬 <b>Discord</b> (Dev Chat)</li>
                        <li data-key="feat_vote">🗳️ Vote on Roadmap</li>
                    </ul>
                    <button class="plan-btn beast-btn" onclick="openPaymentSelection('beast')" data-key="btn_get_beast" style="background:#9b59b6; color:#fff;">Unleash Beast</button>
                </div>

                <!-- 4. BESTIE  -->
                <div class="plan-card bestie" style="border: 2px solid #00d2ff; background: linear-gradient(165deg, rgba(0, 210, 255, 0.1), transparent); position: relative;">
                    <div class="bestie-badge" style="background:#00d2ff; color:#000; font-size:10px; font-weight:800; padding:4px 8px; position:absolute; top:0; right:0; border-radius:0 0 0 10px; z-index:5;" data-key="badge_limited">LIMITED</div>
                    
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px; color:#00d2ff;">Bestie</div>
                    <div class="plan-price" style="font-size:18px; font-weight:700; margin-bottom:15px;">$49.99 <span style="font-size:12px">/ once</span></div>
                    
                    <div class="limit-container" style="background:rgba(0,0,0,0.2); padding:8px; border-radius:8px; margin-bottom:10px;">
                        <div class="limit-labels" style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:4px;">
                            <span style="color:#ff6b6b; font-weight:700;" data-key="limit_burn">🔥 ALMOST GONE</span>
                            <span style="color:#fff;">48 / 50</span>
                        </div>
                        <div style="width:100%; height:4px; background:rgba(255,255,255,0.1); border-radius:2px;"><div style="width:96%; height:100%; background:#00d2ff;"></div></div>
                    </div>

                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_lifetime">♾️ <b>Lifetime Access</b></li>
                        <li data-key="feat_all_beast">🦁 <b>All Beast Features</b></li> 
                        <li data-key="feat_sponsors">💎 In Sponsors List</li>
                    </ul>
                    <button class="plan-btn bestie-btn" onclick="openPaymentSelection('bestie')" data-key="btn_get_bestie" style="background:linear-gradient(90deg, #00d2ff, #3a7bd5); color:#fff;">Get Forever</button>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- THEME MODAL -->
<div class="modal-overlay" id="modal-theme-overlay" onclick="closeThemeModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="theme_title">Choose Theme</span>
            <span onclick="closeThemeModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body">
            <div class="ios-header" style="margin-left:0; margin-top:0;" data-key="theme_basic">Basic</div>
            <div class="theme-grid" id="theme-list-basic">
                <!-- JS inserts themes here -->
            </div>

            <div class="ios-header" style="margin-left:0;" data-key="theme_premium">Premium</div>
            <div class="theme-grid" id="theme-list-premium">
                <!-- JS inserts themes here -->
            </div>
        </div>
        <!-- Панель предпросмотра (Скрыта по умолчанию) -->
        <div id="theme-preview-bar" style="display:none; padding: 15px; border-top: 1px solid var(--border); background: var(--sidebar-bg); flex-direction: column; gap: 10px; align-items: center; text-align: center;">
            <div style="font-size: 13px; color: var(--text-secondary);">
                <span data-key="theme_preview_mode">Preview Mode</span>
            </div>
            <button class="btn-gen" onclick="buyCurrentPreview()" style="width: 100%; padding: 12px; background: linear-gradient(45deg, #FF9900, #9B59B6); color: white; border: none; font-size: 14px; text-transform: uppercase; font-weight: 800; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);">
                <span data-key="btn_unlock_theme">Unlock Theme 🔒</span>
            </button>
        </div>
    </div>
</div>

<!-- MODIFIERS SETTINGS MODAL -->
<div class="modal-overlay" id="modal-mods-overlay" onclick="closeModifiersSettings(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="mod_title">Modifiers</span>
            <!-- Счетчик в углу заголовка -->
            <span id="mods-counter" style="position: absolute; right: 50px; font-size:12px; color:var(--text-secondary); background:var(--ios-card); padding:2px 8px; border-radius:10px;">0/10</span>
            <span onclick="closeModifiersSettings(null, true)">✕</span>
        </div>
        
        <div class="modal-body">
            <!-- ACTIVE -->
            <div style="font-size:12px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:10px; font-weight:700;" data-key="mod_active_sec">
                Active
            </div>
            <div id="mods-list-active" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:25px; min-height:50px;">
                <!-- JS content -->
            </div>

            <div style="height:1px; background:var(--border); margin-bottom:20px;"></div>

            <!-- INACTIVE -->
            <div style="font-size:12px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:10px; font-weight:700;" data-key="mod_inactive_sec">
                Inactive
            </div>
            <div id="mods-list-inactive" style="display:flex; flex-wrap:wrap; gap:8px;">
                <!-- JS content -->
            </div>
        </div>
    </div>
</div>

<!-- LEGAL MODAL -->
<div class="modal-overlay" id="modal-legal-overlay" onclick="closeLegal(event)">
    <div class="modal">
        <div class="modal-header">
            <span id="legal-modal-title">Document</span>
            <span onclick="closeLegal(null, true)">✕</span>
        </div>
        
        <div class="modal-body">
            <div id="legal-modal-content" style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                <!-- JS Content -->
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--border); text-align: center;">
            <button class="btn-gen" onclick="closeLegal(null, true)" data-key="btn_close" style="padding: 10px 30px; font-size: 14px; width: auto;">Close</button>
        </div>
    </div>
</div>

<!-- ADMIN MODAL -->
<div class="modal-overlay" id="modal-admin-overlay" onclick="closeAdminModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span style="color:#e74c3c;">Admin Control</span> 
            <span onclick="closeAdminModal(null, true)">✕</span>
        </div>

        <div class="modal-body">
            
            <!-- Generate Code -->
            <div class="ios-group" style="padding:15px; margin-bottom: 20px;">
                <div style="font-weight:700; margin-bottom:10px; font-size:12px; text-transform:uppercase; color:var(--text-secondary);">Promo Generator</div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="admin-code-type" class="promo-input" style="flex:1;">
                        <option value="pro">Pro</option>
                        <option value="beast">Beast</option>
                        <option value="bestie">Bestie</option>
                    </select>
                    <input type="number" id="admin-code-days" class="promo-input" style="width:80px;" value="30">
                </div>
                <button class="btn-gen secondary" onclick="adminGenerateCode()" style="padding:10px; font-size:14px;">Create Code</button>
                <div id="admin-code-result" style="margin-top:15px; font-family:monospace; font-size:16px; color:#2ecc71; text-align:center; font-weight:800; min-height:20px;"></div>
            </div>

            <!-- Gift Sub -->
            <div class="ios-group" style="padding:15px;">
                <div style="font-weight:700; margin-bottom:10px; font-size:12px; text-transform:uppercase; color:var(--text-secondary);">Gift via Email</div>
                <input type="text" id="admin-gift-email" class="promo-input" placeholder="User Email..." style="margin-bottom:10px;">
                
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="admin-gift-type" class="promo-input" style="flex:1;">
                        <option value="pro">Pro</option>
                        <option value="beast">Beast</option>
                    </select>
                    <input type="number" id="admin-gift-days" class="promo-input" style="width:80px;" value="30">
                </div>
                
                <button class="btn-gen" onclick="adminGiftSub()" style="padding:10px; font-size:14px; background:var(--accent); color:#000;">Activate</button>
            </div>

        </div>
    </div>
</div>

<!-- INSTALL APP MODAL -->
<div class="modal-overlay" id="modal-install-overlay">
    <div class="modal">
        <div class="modal-header">
            <span data-key="install_title">Install App</span>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="logo.png" style="width:60px; height:60px; border-radius:15px; margin-bottom:15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                
                <p style="font-size:14px; color:var(--text-secondary); line-height:1.5;" data-key="install_desc">
                    Install our app for a full-screen experience and private browsing history.
                </p>
            </div>

            <!-- Platform Select -->
            <div class="ios-group" style="margin-bottom:15px;">
                <!-- iOS -->
                <div class="ios-row clickable" onclick="toggleInstallInstruct('ios')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:20px;">🍎</span>
                        <span style="font-weight:600;">iPhone (Safari)</span>
                    </div>
                    <span>▼</span>
                </div>
                <div id="instruct-ios" style="display:none; padding:15px; background:var(--bg-color); font-size:13px; color:var(--text-secondary); line-height:1.6;">
                    1. <span data-key="inst_ios_1">Tap Share</span> <br>
                    2. <span data-key="inst_ios_2">Scroll down and tap</span> <br>
                    <span style="font-weight:700; color:var(--text-main);">➕ <span data-key="inst_ios_btn">Add to Home Screen</span></span>
                </div>

                <!-- Android -->
                <div class="ios-row clickable" onclick="toggleInstallInstruct('android')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:20px;">🤖</span>
                        <span style="font-weight:600;">Android (Chrome)</span>
                    </div>
                    <span>▼</span>
                </div>
                <div id="instruct-android" style="display:none; padding:15px; background:var(--bg-color); font-size:13px; color:var(--text-secondary); line-height:1.6;">
                    1. <span data-key="inst_and_1">Tap Menu (3 dots)</span> <br>
                    2. <span data-key="inst_and_2">Select</span> <br>
                    <span style="font-weight:700; color:var(--text-main);">⬇ <span data-key="inst_and_btn">Install App</span></span>
                </div>
            </div>

            <button class="btn-gen secondary" onclick="skipInstall()" data-key="install_continue" style="padding:15px; font-size:14px;">
                Continue in Browser
            </button>
        </div>
    </div>
</div>

<!-- LOGIN (AUTH) MODAL -->
<div class="modal-overlay" id="modal-login-overlay" onclick="closeLoginModal(event)">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <span data-key="auth_title">Sync & Backup</span>
            <span onclick="closeLoginModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom: 20px;">
                <div style="font-size:40px; margin-bottom:10px;">☁️</div>
            </div>

            <ul class="auth-benefits">
                <li>
                    <div class="auth-icon">🔄</div>
                    <span data-key="auth_p1">Sync history across devices</span>
                </li>
                <li>
                    <div class="auth-icon">⭐</div>
                    <span data-key="auth_p2">Activate Premium status</span>
                </li>
                <li>
                    <div class="auth-icon">🔒</div>
                    <span data-key="auth_p3">Anonymous secure storage</span>
                </li>
            </ul>

            <button class="btn-google" onclick="performGoogleLogin()">
                <img src="google_logo.svg.png" width="20" height="20" style="object-fit: contain;">
                <span data-key="btn_google_signin">Continue with Google</span>
            </button>

            <div class="auth-note" data-key="auth_security_note">
                We respect your privacy. No data leaks.
            </div>
        </div>
    </div>
</div>

<!-- SYNC INFO MODAL (BENTO GRID VERSION) -->
<div class="modal-overlay" id="modal-sync-info-overlay" onclick="closeSyncInfoModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="sync_title">Cloud Storage</span>
            <div class="modal-header-actions">
                <div class="icon-btn-round" onclick="closeSyncInfoModal(null, true)">✕</div>
            </div>
        </div>
        
        <div class="modal-body">
            
            <div class="bento-container">
                
                <!-- 1. ПРОФИЛЬ -->
                <div class="bento-box bento-wide bento-profile">
                    <div class="profile-avatar">👤</div>
                    <div style="display:flex; flex-direction:column; overflow:hidden;">
                        <span style="font-size:10px; color:var(--text-secondary); text-transform:uppercase;">Account ID</span>
                        <span id="sync-email-display" style="font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">...</span>
                    </div>
                </div>

                <!-- 2. ПОДПИСКА -->
                <div id="sync-sub-card" class="bento-box bento-wide bento-sub clickable" onclick="closeSyncInfoModal(null, true); openSubModal();">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%; margin-bottom:5px;">
                        <div class="bento-label" data-key="lbl_subscription">SUBSCRIPTION</div>
                        <div style="font-size:18px;">✨</div>
                    </div>
                    <div id="sync-sub-value" style="font-size:32px; font-weight:900; letter-spacing:1px; margin-bottom:2px;">...</div>
                    <div id="sync-sub-desc" style="font-size:12px; opacity:0.7;">Checking...</div>
                </div>

                <!-- 3. СЕТКА СТАТИСТИКИ -->
                
                <!-- Liked -->
                <div class="bento-box bento-stat-large clickable" onclick="closeSyncInfoModal(null, true); openFavoritesCatalog();">
                    <img src="liked.png" class="bento-img-icon" alt="Liked">
                    <div class="bento-val" id="cloud-fav-count">0</div>
                    <div class="bento-label" data-key="favorites_catalog">Liked</div>
                </div>

                <!-- Watch Later -->
                <div class="bento-box bento-stat-large clickable" onclick="closeSyncInfoModal(null, true); openWatchLaterCatalog();">
                    <img src="watched-later.png" class="bento-img-icon" alt="Saved">
                    <div class="bento-val" id="cloud-wl-count">0</div>
                    <div class="bento-label" data-key="watch_later">Saved</div>
                </div>

                <!-- Explored -->
                <div class="bento-box bento-stat-large clickable" onclick="closeSyncInfoModal(null, true); openExploredModal();">
                    <img src="explored.png" class="bento-img-icon" alt="Explored">
                    <div class="bento-val" id="cloud-explored-count">0</div>
                    <div class="bento-label" data-key="explored_label">Explored</div>
                </div>

                <!-- Disliked -->
                <div class="bento-box bento-stat-large clickable" onclick="closeSyncInfoModal(null, true); openBlacklistCatalog();">
                    <img src="disliked.png" class="bento-img-icon" alt="Ban">
                    <div class="bento-val" id="cloud-ban-count">0</div>
                    <div class="bento-label" data-key="blacklist_catalog">Disliked</div>
                </div>

                <!-- 4. КНОПКА СИНХРОНИЗАЦИИ -->
                <button class="bento-box bento-wide bento-action" onclick="performManualSync()" id="btn-manual-sync">
                    <span id="sync-btn-text" data-key="btn_sync">Synchronize Device</span>
                </button>

            </div>

            <!-- Футер (Выход) -->
            <div class="bento-footer-actions">
                <button class="bento-small-btn" onclick="window.logout()">
                    <span data-key="logout_text">Log Out</span>
                </button>
                <button class="bento-small-btn" onclick="resetAppHistory()" style="color:var(--highlight-red); border-color:rgba(231,76,60,0.3);">
                    <span data-key="btn_reset">Reset Data</span>
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ROADMAP MODAL -->
<div class="modal-overlay" id="modal-roadmap-overlay" onclick="closeRoadmap(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="roadmap_title">Future Plans</span>
            <span onclick="closeRoadmap(null, true)">✕</span>
        </div>

        <div class="modal-body">
            <p style="font-size:13px; color:var(--text-secondary); line-height:1.5; margin-bottom:25px; text-align:center;" data-key="roadmap_desc">
                With your support, xFetishHub will evolve. Here is what we are building:
            </p>

            <div class="roadmap-container">
                
                <!-- 1. Global Intelligence -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#9b59b6; background:rgba(155, 89, 182, 0.15); border:1px solid rgba(155, 89, 182, 0.3); z-index:2;">🌐</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_global_title">Global Intelligence</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_global_desc">
                            Aggregation of anonymous data. Global 'Most Loved' charts.
                        </div>
                    </div>
                </div>

                <!-- 2. Co-op Mode -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#2ecc71; background:rgba(46, 204, 113, 0.15); border:1px solid rgba(46, 204, 113, 0.3); z-index:2;">🤝</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_coop_title">Co-op Mode</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_coop_desc">
                            Invite a partner. See results in real-time. Perfect for distant couples.
                        </div>
                    </div>
                </div>

                <!-- 3. More Categories -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#ff9900; background:rgba(255, 153, 0, 0.15); border:1px solid rgba(255, 153, 0, 0.3); z-index:2;">📚</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_content_title">5000+ Categories</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_content_desc">
                            Massive database expansion. Every micro-fetish indexed.
                        </div>
                    </div>
                </div>

                <!-- 4. Actor Selector -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#3498db; background:rgba(52, 152, 219, 0.15); border:1px solid rgba(52, 152, 219, 0.3); z-index:2;">⭐</div>
                        <!-- No line for last item -->
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_actors_title">Actor Selector</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_actors_desc">
                            Find pornstars based on visual preferences and body types.
                        </div>
                    </div>
                </div>

            </div>

            <div style="margin-top:10px; text-align:center;">
                <button class="btn-gen secondary" onclick="closeRoadmap(null, true); openSubModal();" style="border-color:var(--accent); color:var(--text-main);">
                    <span data-key="rm_support_btn">Support Development 🚀</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR CODE MODAL -->
<div class="modal-overlay" id="modal-qr-overlay" onclick="closeQRModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="qr_title">Scan to Install</span>
            <span onclick="closeQRModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body" style="text-align: center;">
            <div style="background: white; padding: 15px; border-radius: 20px; display: inline-block; margin-bottom: 20px;">
                <img id="qr-code-img" src="" alt="QR Code" style="width: 200px; height: 200px; display: block;">
            </div>

            <p style="font-size:14px; color:var(--text-secondary); line-height: 1.5;" data-key="qr_desc">
                Scan with your phone camera.
            </p>
        </div>
    </div>
</div>

<!-- SPONSORS MODAL -->
<div class="modal-overlay" id="modal-sponsors-overlay" onclick="closeSponsorsModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="sponsors_title">Early Sponsors</span>
            <span onclick="closeSponsorsModal(null, true)">✕</span>
        </div>
        <div class="modal-body">
            <div style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;" data-key="sponsors_desc">
                Legends who supported xFetishHub early.
            </div>
            <div class="ios-group" id="sponsors-list">
            </div>
        </div>
    </div>
</div>

<!-- CRYPTO PAYMENT MODAL -->
<div class="modal-overlay" id="modal-crypto-payment" onclick="closeCryptoModal(event)">
    <div class="modal" style="text-align: center;">
        
        <div class="modal-header">
            <span data-key="pay_header">USDT Payment</span>
            <span onclick="closeCryptoModal(null, true)">✕</span>
        </div>

        <div class="modal-body">
            
            <!-- MAIN VIEW: QR & Address -->
            <div id="crypto-main-view">
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:15px; line-height:1.4;" data-key="pay_instruction">
                    Send the <b>EXACT amount</b> (including decimals!) via <b>Tron (TRC20)</b>.
                </p>
                
                <!-- QR Code Box -->
                <div style="margin-bottom:20px; background:white; padding:10px; display:inline-block; border-radius:15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);">
                    <img id="crypto-qr-img" src="" style="width:180px; height:180px; display:block;">
                </div>

                <!-- Amount (Clickable Copy) -->
                <div class="ios-group" style="margin-bottom:10px;">
                    <div class="ios-row clickable" onclick="copyCryptoAmount()" style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                        <div style="display:flex; align-items:center;">
                            <span style="color:var(--text-secondary); font-size:13px;" data-key="pay_sum_label">Amount to send:</span>
                            <span id="amount-copy-hint" style="font-size:10px; color:var(--accent); margin-left:8px; opacity:0; transition:opacity 0.3s;">COPIED!</span>
                        </div>
                        <span id="crypto-amount" style="font-weight:800; font-size:18px; color:var(--accent); display:flex; align-items:center; gap:6px;">
                            0.00 USDT <span style="font-size:14px; opacity:0.6;">📋</span>
                        </span>
                    </div>
                </div>

                <!-- Address Copy -->
                <div class="ios-group" style="margin-bottom:15px;">
                    <div class="ios-row clickable" onclick="copyCryptoAddress()" style="display:block; padding:15px; text-align:center;">
                        <div style="font-size:11px; color:var(--text-secondary); text-transform:uppercase; margin-bottom:5px;" data-key="pay_copy_addr">Tap to Copy Address</div>
                        <div id="crypto-address" style="font-family:monospace; font-size:13px; word-break:break-all; font-weight:600;">...</div>
                    </div>
                </div>

                <!-- Toggle Guide Link -->
                <div style="margin-bottom:10px;">
                    <span style="font-size:12px; color:var(--accent); text-decoration:underline; cursor:pointer;" onclick="toggleCryptoView('guide')" data-key="pay_how_to">Don't have crypto? How to pay</span>
                </div>

                <!-- Loading Spinner -->
                <div id="payment-status-box">
                    <div class="thinking-spinner" style="width:24px; height:24px; border-width:3px; margin:0 auto 10px auto;"></div>
                    <div style="font-size:13px; font-weight:600; color:var(--text-secondary); animation: pulse 2s infinite;" data-key="pay_waiting">Waiting for payment...</div>
                </div>
                <div id="crypto-timer" style="margin-top:10px; font-size:11px; color:var(--text-secondary); opacity:0.5;">--:--</div>

                <!-- КНОПКА "НЕ ЗАСЧИТАЛСЯ ПЛАТЕЖ?" -->
                <div style="margin-top:20px; padding-top:10px; border-top:1px solid var(--border);">
                    <span style="font-size:11px; color:var(--text-secondary); text-decoration:underline; cursor:pointer; opacity:0.7;" onclick="toggleCryptoView('problem')" data-key="pay_problem_link">Payment not credited?</span>
                </div>
            </div>

            <!-- GUIDE VIEW -->
            <div id="crypto-guide-view" style="display:none; text-align:left;">
                <div style="font-weight:700; font-size:16px; margin-bottom:15px; text-align:center;" data-key="guide_title">How to pay with Crypto</div>
                
                <div style="font-size:13px; line-height:1.6; color:var(--text-secondary);">
                    <p style="margin-bottom:10px;" data-key="guide_step_1"></p>
                    <p style="margin-bottom:10px;" data-key="guide_step_2"></p>
                    <p style="margin-bottom:10px; font-size:12px; opacity:0.8;">
                        ⚠️ <span data-key="guide_warning">Important: Select <b>TRON (TRC20)</b> network.</span>
                    </p>
                </div>

                <button class="btn-gen secondary" onclick="toggleCryptoView('main')" style="margin-top:15px; width:100%; padding:10px;" data-key="btn_back">Back</button>
            </div>

            <!-- PROBLEM VIEW -->
            <div id="crypto-problem-view" style="display:none; text-align:left; animation: fadeIn 0.3s ease;">
                <div style="font-weight:700; font-size:16px; margin-bottom:15px; text-align:center; color:var(--highlight-red);" data-key="pay_problem_title">Where is my subscription?</div>
                
                <div style="font-size:13px; line-height:1.5; color:var(--text-secondary);">
                    <p style="margin-bottom:15px;" data-key="pay_prob_desc">If status didn't update in 10 mins:</p>
                    
                    <ul style="padding-left:20px; margin-bottom:20px; list-style-type: disc;">
                        <li style="margin-bottom:8px;" data-key="pay_prob_reason_1">Wrong Amount</li>
                        <li style="margin-bottom:8px;" data-key="pay_prob_reason_2">Network Fee deducted</li>
                        <li style="margin-bottom:8px;" data-key="pay_prob_reason_3">Wrong Network</li>
                    </ul>

                    <p style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; border:1px dashed var(--border);" data-key="pay_prob_solution">
                        Don't worry! Send TxID to support.
                    </p>
                </div>

                <!-- Ссылка на Tally форму -->
                <button class="btn-gen" onclick="window.open('https://tally.so/r/Y50280', '_blank')" style="margin-top:20px; width:100%; padding:12px; background:var(--text-main); color:var(--bg-color);" data-key="btn_contact_support">Contact Support</button>

                <button class="btn-gen secondary" onclick="toggleCryptoView('main')" style="margin-top:10px; width:100%; padding:10px;" data-key="btn_back">Back</button>
            </div>

            <!-- SUCCESS VIEW -->
            <div id="payment-success-msg" style="display:none; margin-top:20px; animation: popIn 0.5s ease;">
                <div style="font-size:50px; margin-bottom:10px;">✅</div>
                <h3 style="color:var(--highlight-green); margin:0 0 10px 0;" data-key="pay_success_title">Payment Received!</h3>
                <p style="font-size:13px; color:var(--text-secondary);" data-key="pay_success_desc">Subscription activated.</p>
                <a id="btn-discord-join" href="#" target="_blank" class="btn-gen" style="display:none; margin-top:15px; background:#5865F2; color:#fff; text-decoration:none; align-items:center; justify-content:center; gap:8px;">
                    <span style="font-size:20px;">💬</span> Join Discord
                </a>
                <button class="btn-gen" onclick="location.reload()" style="margin-top:15px; width:100%;" data-key="pay_reload">Reload Page</button>
            </div>

        </div>
    </div>
</div>

<!-- PANIC SETTINGS MODAL -->
<div class="modal-overlay" id="modal-panic-settings" onclick="closePanicSettings(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="panic_title">Emergency Mode</span>
            <span onclick="closePanicSettings(null, true)">✕</span>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="sos.png" style="width:60px; height:60px; margin-bottom:15px; filter: invert(1);">
                <p style="font-size:14px; color:var(--text-secondary); line-height:1.5;" data-key="panic_desc">
                    Enable a stealth mode to quickly hide content. Trigger it by <b>Double Tapping</b> anywhere or pressing <b>Spacebar twice</b>.
                </p>
            </div>

            <div class="ios-group">
                <div class="ios-row">
                    <div class="ios-row-left">
                        <span data-key="panic_enable">Enable Trigger</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="panic-toggle-input" onchange="togglePanicSetting(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- VPN & ADS WARNING MODAL -->
<div class="modal-overlay" id="modal-vpn-overlay">
    <div class="modal" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <span style="color:var(--accent);">⚠️ <span data-key="vpn_title">Notice</span></span>
        </div>
        
        <div class="modal-body">
            <!-- Часть 1: Общее предупреждение -->
            <p style="font-size:14px; color:var(--text-main); margin-bottom:15px; line-height:1.5;" data-key="vpn_text_1">
                Must warn you...
            </p>

            <!-- Часть 2: Только для PWA (скрыто по умолчанию) -->
            <div id="vpn-pwa-text" style="display:none; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; margin-bottom:15px; font-size:13px; color:var(--text-secondary); border:1px dashed var(--border);">
                <span data-key="vpn_text_pwa">PWA Hint...</span>
            </div>

            <!-- Часть 3: ВПН -->
            <p style="font-size:15px; font-weight:700; color:var(--accent); margin-bottom:25px;" data-key="vpn_text_2">
                Don't forget VPN!
            </p>

            <button class="btn-gen" id="btn-vpn-go" style="width:100%; padding:14px; font-size:16px;">
                <span data-key="vpn_btn">Let's go</span>
            </button>
        </div>
    </div>
</div>

<!-- TIPS MODAL -->
<div class="modal-overlay" id="modal-tips-overlay" onclick="closeTipsModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="tips_title">Knowledge Base</span>
            <span onclick="closeTipsModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body" style="padding: 0 20px 30px 20px;">
            
            <!-- VIEW 1: СПИСОК КАРТОЧЕК -->
            <div id="tips-view-list">
                <!-- Маленький серый заголовок -->
                <div class="tips-guru-text" data-key="tips_guru_title">
                    Become a Guru 😈
                </div>

                <!-- Сетка карточек -->
                <div class="tips-grid" id="tips-list-container">
                    <!-- JS сгенерирует здесь карточки -->
                </div>
            </div>

            <!-- VIEW 2: ДЕТАЛИ (ОСТАВЛЯЕМ ТЕМ ЖЕ, НО НЕМНОГО УЛУЧШИМ) -->
            <div id="tips-view-detail" style="display:none; animation: fadeIn 0.3s ease;">
                <div style="background:var(--ios-card); padding:20px; border-radius:24px; border:1px solid var(--border);">
                    <div id="tip-detail-icon" style="font-size:50px; text-align:center; margin-bottom:15px;"></div>
                    <h3 id="tip-detail-title" style="text-align:center; margin-bottom:20px; color:var(--text-main); font-size:20px;"></h3>
                    
                    <div id="tip-detail-content" style="font-size:14px; line-height:1.6; color:var(--text-secondary); margin-bottom:20px;"></div>
                </div>

                <button class="btn-gen" onclick="backToTipsList()" style="width:100%; padding:14px; margin-top:20px; border-radius:50px;">
                    <span data-key="btn_got_it">Got it</span>
                </button>
            </div>

        </div>
    </div>
</div>

<!-- EXPLORED CATEGORIES MODAL -->
<div class="modal-overlay" id="modal-explored-overlay" onclick="closeExploredModal(event)">
    <div class="modal">
        <div class="modal-header" style="border-bottom: none; padding-bottom: 5px;">
            <span data-key="explored_label">Explored</span>
            <span onclick="closeExploredModal(null, true)">✕</span>
        </div>
        
        <div class="modal-subtitle" data-key="explored_subtitle" style="text-align: center; color: var(--text-secondary); font-size: 13px; padding: 0 20px 20px 20px; line-height: 1.4; font-weight: 500;">
            Here are the achievements you need to get "Platinum" 😈
        </div>
        
        <div class="modal-body" style="padding: 0 15px 20px 15px;">
            <div id="explored-grid" class="explored-grid">
            </div>
        </div>
    </div>
</div>

<!-- LIMIT REACHED MODAL -->
<div class="modal-overlay" id="modal-limit-overlay" onclick="closeLimitModal(event)">
    <div class="modal" style="max-width: 340px; text-align: center;">
        <!-- Заголовок не нужен, используем крупную иконку -->
        <div class="modal-body" style="padding: 30px 20px 20px 20px; display: flex; flex-direction: column; align-items: center;">
            
            <div style="font-size: 50px; margin-bottom: 15px;">✋</div>
            
            <h3 style="margin-bottom: 10px; color: var(--text-main);" data-key="limit_title">
                Limit Reached
            </h3>

            <p id="limit-custom-text" style="font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px;">
                That's enough for today, buddy. Come back tomorrow, or join Pro and watch until you turn blue 😏
            </p>

            <!-- Маленькая подпись с временем сброса -->
            <div id="limit-reset-time" style="font-size: 11px; background: var(--nav-bg); padding: 4px 10px; border-radius: 8px; margin-bottom: 25px; opacity: 0.8;">
                Reset: 00:00
            </div>

            <!-- Кнопка купить -->
            <button class="btn-gen" onclick="closeLimitModal(null, true); openSubModal();" style="width: 100%; margin-bottom: 10px; background: var(--accent); color: #000;">
                <span data-key="btn_get_pro">Get Pro</span>
            </button>

            <!-- Кнопка закрыть -->
            <button class="btn-gen secondary" onclick="closeLimitModal(null, true)" style="width: 100%;">
                <span data-key="btn_close">Close</span>
            </button>

        </div>
    </div>
</div>

<!-- CHANGELOG MODAL -->
<div class="modal-overlay" id="modal-changelog-overlay" onclick="closeChangelogModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="changelog_title">What's New</span>
            <span onclick="closeChangelogModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body" id="changelog-container" style="padding: 20px 25px;">
            <!-- JS сгенерирует историю здесь -->
        </div>
    </div>
</div>

<!-- PROMO TIPS MODAL -->
<div class="modal-overlay" id="modal-promo-tips-overlay">
    <div class="modal" style="max-width: 360px; text-align: center;">
        
        <div class="modal-header">
            <span style="color:var(--accent);">💡 <span data-key="pt_title">Did you know?</span></span>
        </div>
        
        <div class="modal-body" style="padding-bottom: 25px;">
            <p style="font-size:14px; color:var(--text-main); line-height:1.5; margin-bottom:25px;" data-key="pt_desc">
                If you want to learn how to completely disable ads in videos or not get caught at the right moment, read the Knowledge Base here, you won't be disappointed 🌚
            </p>

            <!-- Кнопка перехода к Базе знаний -->
            <button class="btn-gen" onclick="openTipsFromPromo()" style="width:100%; padding:14px; font-size:15px; margin-bottom: 15px;">
                <span data-key="pt_btn_go">Open Knowledge Base</span>
            </button>

            <!-- Кнопка пропуска -->
            <div style="text-align:center;">
                <span style="font-size:13px; color:var(--text-secondary); text-decoration:underline; cursor:pointer; opacity: 0.7;" onclick="closePromoTips()" data-key="onb_skip">Skip</span>
            </div>
        </div>
    </div>
</div>

<!-- THEME PREVIEW FLOATING BAR -->
<div id="preview-floating-bar">
    
    <div style="display:flex; flex-direction:column; align-items: center; text-align: center; flex: 1;">
        
        <span style="font-size:13px; font-weight:800; color:var(--text-main); letter-spacing: 0.5px;" data-key="theme_preview_mode">
            Preview Mode
        </span>
        
        <span style="font-size:10px; color:var(--text-secondary); opacity:0.8; margin-top: 3px;" data-key="theme_tap_cancel">
            Tap anywhere to cancel
        </span>
        
    </div>

    <button class="btn-gen" onclick="buyFromPreview(event)" style="flex-shrink: 0; width:auto; padding: 10px 24px; border-radius: 40px; font-size:13px; margin:0; background: var(--accent); color: #000; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <span data-key="btn_unlock_theme">Unlock</span>
    </button>
    
</div>

<div id="wrapped-mount" class="wrapped-overlay"></div>

<!-- FIREBASE INTEGRATION -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, serverTimestamp, writeBatch, query, where, collection, deleteField, Timestamp, limit, 
        initializeFirestore, persistentLocalCache 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC94QWRaFu0o60kDSU8Uz0VJAcXwaDWjlI",
        authDomain: "xfetishhub.firebaseapp.com",
        projectId: "xfetishhub",
        storageBucket: "xfetishhub.firebasestorage.app",
        messagingSenderId: "617015941952",
        appId: "1:617015941952:web:4f75df1239b0c114d8f8a5"
    };

    const ADMIN_UID = "Tqk5aauZ8JVzQ4Bs7Z0BCT5dZKf1";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    window.auth = auth;
    const db = initializeFirestore(app, {
        localCache: persistentLocalCache()
    });
    const provider = new GoogleAuthProvider();

    let syncTimeout = null;

    let cachedUserProfile = null;
    let lastProfileReadTime = 0;
    const PROFILE_CACHE_TTL = 60000; 

    // Глобальное состояние входа
    window.isUserLoggedIn = false;

    // === ФУНКЦИИ ВХОДА/ВЫХОДА (Доступны глобально) ===
    
    window.loginWithGoogle = async function() {
        try {
            await signInWithPopup(auth, provider);
            // Состояние обновится в onAuthStateChanged
        } catch (error) {
            console.error("Login failed:", error);
        }
    };

   window.logout = async function() {
        const user = auth.currentUser;
        
        // Попытка сохранить данные перед выходом
        if (user) {
            const btnText = document.getElementById('sync-btn-text');
            if(btnText) btnText.innerText = "Saving...";
            try {
                await window.syncToCloud(true);
            } catch (e) { console.error(e); }
        }

        try {
            await signOut(auth);
            
            // === ПОЛНАЯ ОЧИСТКА ДАННЫХ ПОДПИСКИ ===
            localStorage.removeItem('xch_last_sync_ts');
            localStorage.removeItem('xch_sub_level'); // УДАЛЯЕМ ПОДПИСКУ
            
            // Сбрасываем переменную в памяти
            subscriptionLevel = 'free';
            
            console.log("Logged out. Local subscription data cleared.");
            
            // Перезагрузка страницы применит Free тариф (т.к. в localStorage ничего нет)
            location.reload(); 
        } catch (error) {
            console.error("Logout failed:", error);
        }
    };

    // === АКТИВАЦИЯ ПРОМОКОДА ===
    window.activatePromoCode = async function(code) {
        const user = auth.currentUser;
        // Ссылки на документы
        const codeRef = doc(db, "promocodes", code);
        const userRef = doc(db, "users", user.uid);

        try {
            // 1. Сначала читаем код, чтобы убедиться, что он есть (как и раньше)
            const codeSnap = await getDoc(codeRef);
            if (!codeSnap.exists() || !codeSnap.data().active) {
                alert("Invalid code");
                return;
            }
            const promoData = codeSnap.data();

            // 2. Создаем ПАКЕТ (Batch)
            const batch = writeBatch(db);

            // Операция А: Сжигаем код
            batch.update(codeRef, {
                active: false,
                usedBy: user.uid,
                usedAt: serverTimestamp()
            });

            // Операция Б: Обновляем юзера
            batch.set(userRef, {
                subscription: promoData.type, // 'pro' или 'beast'
                expiresAt: new Date(Date.now() + (promoData.days * 86400000)),
                lastUsedCode: code 
            }, { merge: true });

            // 3. Отправляем всё вместе. Если хоть одно правило запретит, отменится ВСЁ.
            await batch.commit();

            alert("Success!");
            location.reload();

        } catch (error) {
            console.error("Hacking attempt failed:", error);
            alert("Error activating code.");
        }
    };

    // === 1. ФУНКЦИЯ КЛИКА ПО АККАУНТУ ===
    window.handleLoginClick = function() {
        if (window.isUserLoggedIn) {
            openSyncInfoModal();
        } else {
            openLoginModal();
        }
    };

    // === 2. ОТКРЫТИЕ ОКНА И ПОДГРУЗКА СТАТИСТИКИ ===
    window.openSyncInfoModal = async function() {
        const user = auth.currentUser;
        if (!user) return;

        // 1. Блокируем прокрутку фона и ставим класс
        document.body.classList.add('modal-open');
        document.getElementById('modal-sync-info-overlay').classList.add('open');
        
        // 2. Заполняем Email
        const emailEl = document.getElementById('sync-email-display');
        if(emailEl) emailEl.innerText = user.email;

        // 3. Сбрасываем значения на "..." перед загрузкой
        const ids = ['cloud-fav-count', 'cloud-wl-count', 'cloud-explored-count', 'cloud-ban-count'];
        const subValue = document.getElementById('sync-sub-value');
        const subDesc = document.getElementById('sync-sub-desc');
        const subCard = document.getElementById('sync-sub-card');

        if(subValue) subValue.innerText = "...";
        if(subDesc) subDesc.innerText = "Checking...";
        
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerText = "...";
        });

        // 4. Загрузка данных
        const now = Date.now();
        let d = cachedUserProfile;
        const PROFILE_CACHE_TTL = 60000; 

        // Грузим из сети, если кеш старый
        if (!d || (now - lastProfileReadTime > PROFILE_CACHE_TTL)) {
            try {
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    d = docSnap.data();
                    cachedUserProfile = d;
                    lastProfileReadTime = now;
                } else {
                    d = null; 
                }
            } catch (e) {
                console.error("Sync error:", e);
                if(subValue) subValue.innerText = "Error";
                return;
            }
        }

        // 5. Отображение данных
        if(subCard) subCard.classList.remove('is-free', 'is-pro', 'is-beast', 'is-bestie');

        const currentLang = localStorage.getItem('xch_lang') || 'en';
        const t = (window.langData && window.langData[currentLang]) ? window.langData[currentLang] : (window.langData ? window.langData['en'] : {});

        if (d) {
            // Подписка
            const plan = d.subscription || 'free';
            if(subValue) {
                subValue.innerText = plan.toUpperCase();
                
                if (plan === 'pro') subValue.style.color = '#ff9900';
                else if (plan === 'beast') subValue.style.color = '#9b59b6';
                else if (plan === 'bestie') subValue.style.color = '#00d2ff';
                else subValue.style.color = 'var(--text-main)';
            }

            if(subCard) {
                if (plan === 'pro') subCard.classList.add('is-pro');
                else if (plan === 'beast') subCard.classList.add('is-beast');
                else if (plan === 'bestie') subCard.classList.add('is-bestie');
                else subCard.classList.add('is-free');
            }

            if(subDesc) {
                if (plan === 'free') {
                    subDesc.innerText = (currentLang === 'ru' ? "Нажми, чтобы улучшить" : "Tap to Upgrade");
                    subDesc.style.color = "var(--accent)";
                } else if (plan === 'bestie') {
                    subDesc.innerHTML = "♾️ Lifetime Access";
                    subDesc.style.color = "var(--text-secondary)";
                } else {
                    if (d.expiresAt) {
                        const dateObj = d.expiresAt.toDate(); 
                        const daysLeft = Math.ceil((dateObj - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysLeft > 0) {
                            subDesc.innerText = `${t.sub_exp || "Exp:"} ${daysLeft}${t.time_d || "d"}`;
                            subDesc.style.color = "var(--text-secondary)";
                        } else {
                            subDesc.innerText = t.sub_expired || "Expired"; 
                            subDesc.style.color = "var(--highlight-red)";
                        }
                    } else {
                        subDesc.innerText = "Active";
                    }
                }
            }

            // Счетчики (используем только innerText, чтобы не дублировать HTML)
            if(document.getElementById('cloud-fav-count')) 
                document.getElementById('cloud-fav-count').innerText = d.favorites ? d.favorites.length : 0;
            
            if(document.getElementById('cloud-wl-count')) 
                document.getElementById('cloud-wl-count').innerText = d.watchLater ? d.watchLater.length : 0;
            
            if(document.getElementById('cloud-ban-count')) 
                document.getElementById('cloud-ban-count').innerText = d.blacklist ? d.blacklist.length : 0;
            
            let exCount = d.exploredCount || 0;
            if (exCount === 0 && d.activityLog) {
                const unique = new Set(d.activityLog.map(i => i.id));
                exCount = unique.size;
            }
            if(document.getElementById('cloud-explored-count'))
                document.getElementById('cloud-explored-count').innerText = exCount;

        } else {
            // Новый юзер
            if(subValue) subValue.innerText = "FREE";
            if(subCard) subCard.classList.add('is-free');
            if(subDesc) subDesc.innerText = (currentLang === 'ru' ? "Нажми, чтобы улучшить" : "Tap to Upgrade");
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerText = "0";
            });
        }
        
        applyLanguage();
    };

    window.closeSyncInfoModal = function(e, force) {
        if (force || e.target.id === 'modal-sync-info-overlay') {
            document.getElementById('modal-sync-info-overlay').classList.remove('open');
            document.body.classList.remove('modal-open');
        }
    };

    // === 3. РУЧНАЯ СИНХРОНИЗАЦИЯ (MERGE) ===
    window.performManualSync = async function() {
        const user = auth.currentUser;
        if (!user) return;

        const btn = document.getElementById('btn-manual-sync');
        const btnText = document.getElementById('sync-btn-text');
        const originalText = btnText.innerText;
        
        // Получаем перевод для успеха
        const t = langData[currentLang] || langData['en'];
        const successText = t.sync_btn_success || "✅ Done! Reloading...";

        // Блокируем кнопку и включаем спиннер
        btn.disabled = true;
        btnText.innerHTML = `<span class="spinning-icon">↻</span> Syncing...`;
        
        try {
            await loadUserData(user); 

            // УСПЕХ
            btnText.innerHTML = successText;
            btn.style.background = "var(--highlight-green)"; // Зеленый цвет
            btn.style.color = "#fff";

            // АВТОМАТИЧЕСКАЯ ПЕРЕЗАГРУЗКА ЧЕРЕЗ 1.5 СЕК
            setTimeout(() => {
                location.reload();
            }, 1500);

        } catch (e) {
            console.error("Manual sync failed:", e);
            btnText.innerText = "❌ Error";
            setTimeout(() => {
                btnText.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        }
    };

    // === СЛУШАТЕЛЬ АВТОРИЗАЦИИ (Главная точка входа) ===
    onAuthStateChanged(auth, async (user) => {
        const btnText = document.getElementById('login-btn-text');
        
        // Получаем текущие переводы
        const currentLang = localStorage.getItem('xch_lang') || 'en';
        const t = (typeof langData !== 'undefined' && langData[currentLang]) ? langData[currentLang] : langData['en'];

        if (user) {
            // === ПОЛЬЗОВАТЕЛЬ ВОШЕЛ ===
            window.isUserLoggedIn = true;
            console.log("Authorized:", user.email);
            
            // 1. Обновляем текст кнопки
            if(btnText) {
                const activeText = t.personal_account || "Personal Account";
                const shortEmail = user.email.split('@')[0];
                // Просто текст и email серым цветом
                btnText.innerHTML = `${activeText} <span style="font-size:13px; color:var(--text-secondary); font-weight:400; margin-left:6px;">${shortEmail}</span>`;
            }

            // 2. Обновляем дату синхронизации и грузим данные
            if (window.updateLastSyncUI) window.updateLastSyncUI();
            await loadUserData(user); 

            // 3. Проверка промокода в URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                await window.activatePromoCode(code);
            }
        } else {
            // === ПОЛЬЗОВАТЕЛЬ ВЫШЕЛ ===
            window.isUserLoggedIn = false;
            
            // Возвращаем исходный текст
            const btnText = document.getElementById('login-btn-text');
            if(btnText) btnText.innerText = t.login_text || "Sync / Login";
            
            if (window.updateLastSyncUI) window.updateLastSyncUI();
        }

        // Кнопка админа
        if (user && user.uid === ADMIN_UID) {
            const btn = document.getElementById('btn-admin-trigger');
            if(btn) btn.style.display = 'flex';
        }
    });
    
    // 2. Генерация промокода
    window.adminGenerateCode = async function() {
        const user = auth.currentUser;
        if (!user || user.uid !== ADMIN_UID) return;

        const type = document.getElementById('admin-code-type').value;
        const days = parseInt(document.getElementById('admin-code-days').value);
        
        // Генерируем читаемый код (XF-TYPE-XXXX)
        const randomPart = Math.random().toString(36).substr(2, 5).toUpperCase();
        const code = `XF-${type.toUpperCase()}-${randomPart}`;

        try {
            await setDoc(doc(db, "promocodes", code), {
                active: true,
                type: type,
                days: days,
                createdAt: serverTimestamp(),
                createdBy: "admin_ui"
            });
            document.getElementById('admin-code-result').innerText = code;
            alert(`Code created: ${code}`);
        } catch (e) {
            alert("Error: " + e.message);
        }
    };

    // 3. Выдача подписки по Email
    window.adminGiftSub = async function() {
        const user = auth.currentUser;
        if (!user || user.uid !== ADMIN_UID) return;

        const targetEmail = document.getElementById('admin-gift-email').value.trim();
        const type = document.getElementById('admin-gift-type').value;
        const days = parseInt(document.getElementById('admin-gift-days').value);

        if (!targetEmail) { alert("Enter email!"); return; }

        const btn = event.target;
        btn.innerText = "Searching...";
        btn.disabled = true;

        try {
            // Ищем пользователя в базе по полю email
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", targetEmail));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("User not found in Database. Ask them to Login/Sync first.");
                btn.innerText = "Activate Sub";
                btn.disabled = false;
                return;
            }

            // Берем первого найденного 
            let targetUserDoc = null;
            querySnapshot.forEach((doc) => { targetUserDoc = doc; });

            // Вычисляем дату
            const now = new Date();
            const expireDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));

            // Обновляем документ ЧУЖОГО пользователя
            await updateDoc(targetUserDoc.ref, {
                subscription: type,
                expiresAt: Timestamp.fromDate(expireDate)
            });

            alert(`Success! ${targetEmail} is now ${type} for ${days} days.`);
            document.getElementById('admin-gift-email').value = "";

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            btn.innerText = "Activate Sub";
            btn.disabled = false;
        }
    };

    // 4. Сброс подписки до FREE по Email
    window.adminResetSub = async function() {
        const user = auth.currentUser;
        
        if (!user || user.uid !== "Tqk5aauZ8JVzQ4Bs7Z0BCT5dZKf1") return; 

        const targetEmail = document.getElementById('admin-reset-email').value.trim();

        if (!targetEmail) { alert("Enter email!"); return; }
        if (!confirm(`Are you sure you want to RESET subscription for ${targetEmail}?`)) return;

        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "Processing...";
        btn.disabled = true;

        try {
            // 1. Ищем пользователя по Email
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", targetEmail));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("User not found via Email.");
                return;
            }

            // Берем первого найденного
            let targetUserDoc = null;
            querySnapshot.forEach((doc) => { targetUserDoc = doc; });

            // 2. Сбрасываем подписку (Удаляем поля)
            await updateDoc(targetUserDoc.ref, {
                subscription: "free",       // Явно ставим free
                expiresAt: deleteField(),   // Удаляем поле даты окончания
                lastPaymentId: deleteField() // Удаляем ID последнего платежа
            });

            alert(`Done! ${targetEmail} is now Free in Database.\nUser needs to click 'Synchronize' to see changes.`);
            document.getElementById('admin-reset-email').value = "";

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    };
    
    // Флаг: есть ли несохраненные изменения?
    window.unsavedChanges = false;
    let saveInterval = null;

    // Функция, которую вызываем при ЛЮБОМ изменении (свайп, лайк, настройка)
    window.markDirty = function() {
        window.unsavedChanges = true;
        // Можно добавить визуальную индикацию, если хочешь (например, точка в углу)
    };

    // 1. Слушатель ухода с вкладки (Сворачивание / Закрытие)
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') {
            if (window.isUserLoggedIn && window.unsavedChanges) {
                console.log("App hidden, forcing save...");
                window.syncToCloud(true);
            }
        }
    });

    // 2. Таймер: сохраняем раз в 3 минуты (180 секунд), если есть изменения
    if (saveInterval) clearInterval(saveInterval);
    saveInterval = setInterval(() => {
        if (window.isUserLoggedIn && window.unsavedChanges) {
            console.log("Auto-saving by timer...");
            window.syncToCloud(true);
        }
    }, 180 * 1000); // 180 секунд = 3 минуты

    // === ЗАГРУЗКА И СЛИЯНИЕ ДАННЫХ (СЕРДЦЕ СИНХРОНИЗАЦИИ) ===
    async function loadUserData(user) {
        const userRef = doc(db, "users", user.uid);
        
        try {
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                cachedUserProfile = cloudData;
                lastProfileReadTime = Date.now();
                
                console.log("Cloud data received. Merging...");

                // --- 1. СИНХРОНИЗАЦИЯ ПОДПИСКИ ---
                const cloudSub = cloudData.subscription || 'free';
                
                // Перезаписываем локальные данные
                localStorage.setItem('xch_sub_level', cloudSub);
                subscriptionLevel = cloudSub; // Обновляем глобальную переменную
                
                // Мгновенно обновляем интерфейс (карточки планов)
                if (window.updateSubscriptionUI) window.updateSubscriptionUI();

                // --- 2. СЛИЯНИЕ СПИСКОВ (Избранное, ЧС, Watch Later) ---
                const localFav = JSON.parse(localStorage.getItem('xch_favorites')) || [];
                const cloudFav = cloudData.favorites || [];
                const mergedFav = [...new Set([...localFav, ...cloudFav])];

                const localBan = JSON.parse(localStorage.getItem('xch_blacklist')) || [];
                const cloudBan = cloudData.blacklist || [];
                const mergedBan = [...new Set([...localBan, ...cloudBan])];

                const localWL = JSON.parse(localStorage.getItem('xch_watch_later')) || [];
                const cloudWL = cloudData.watchLater || [];
                const mergedWL = [...new Set([...localWL, ...cloudWL])];

                // --- 3. СЛИЯНИЕ ИСТОРИИ И ЛОГОВ ---
                // История (топ-50)
                const localHist = JSON.parse(localStorage.getItem('xch_history')) || [];
                const cloudHist = cloudData.history || [];
                const combinedHistMap = new Map();
                [...localHist, ...cloudHist].forEach(item => combinedHistMap.set(item.id, item));
                const mergedHistory = Array.from(combinedHistMap.values())
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 50);

                // Активность (для статистики)
                const localLog = JSON.parse(localStorage.getItem('xch_activity_log')) || [];
                const cloudLog = cloudData.activityLog || [];
                const combinedLogMap = new Map();
                // Ключ уникальности: ts + id
                [...localLog, ...cloudLog].forEach(item => combinedLogMap.set((item.ts || 0) + "_" + item.id, item));
                const mergedActivityLog = Array.from(combinedLogMap.values())
                    .sort((a, b) => a.ts - b.ts)
                    .slice(-5000);

                // --- 4. ВЕСА ТЕГОВ ---
                const localScores = JSON.parse(localStorage.getItem('xch_tag_scores')) || {};
                const cloudScores = cloudData.tagScores || {};
                const mergedScores = { ...cloudScores };
                for (const [tag, score] of Object.entries(localScores)) {
                    if (Math.abs(score) > Math.abs(mergedScores[tag] || 0)) {
                        mergedScores[tag] = score;
                    }
                }

                // --- 5. ПРИМЕНЕНИЕ (СОХРАНЕНИЕ В ПАМЯТЬ) ---
                window.favorites = mergedFav;
                window.blacklist = mergedBan;
                window.watchLater = mergedWL;
                window.historyData = mergedHistory;
                window.activityLog = mergedActivityLog;
                window.tagScores = mergedScores;

                localStorage.setItem('xch_favorites', JSON.stringify(mergedFav));
                localStorage.setItem('xch_blacklist', JSON.stringify(mergedBan));
                localStorage.setItem('xch_watch_later', JSON.stringify(mergedWL));
                localStorage.setItem('xch_history', JSON.stringify(mergedHistory));
                localStorage.setItem('xch_activity_log', JSON.stringify(mergedActivityLog));
                localStorage.setItem('xch_tag_scores', JSON.stringify(mergedScores));

                // --- 6. ФИНАЛ ---
                const now = Date.now();
                localStorage.setItem('xch_last_sync_ts', now);
                
                if (window.updateLastSyncUI) window.updateLastSyncUI();
                if (typeof updateCounts === 'function') updateCounts();
                if (typeof renderHistory === 'function') renderHistory();
                if (typeof updateActionButtons === 'function') updateActionButtons();
                
                console.log(`Sync complete. Subscription is: ${cloudSub}`);
                
                window.unsavedChanges = false;

            } else {
                // === СЦЕНАРИЙ: ДОКУМЕНТ УДАЛЕН (СБРОС ПОДПИСКИ) ===
                console.log("User document not found in Cloud. Resetting subscription to Free.");
                
                // Сбрасываем подписку
                localStorage.setItem('xch_sub_level', 'free');
                subscriptionLevel = 'free';
                if (window.updateSubscriptionUI) window.updateSubscriptionUI();

                // Создаем новый чистый документ для юзера
                window.syncToCloud(true);
            }
        } catch (error) {
            console.error("Error loading data:", error);
        }
    }

    // === АВТО-СОХРАНЕНИЕ В ОБЛАКО ===
    window.syncToCloud = async function(immediate = false) {
        const user = auth.currentUser;
        if (!user) return; 

        // ОПТИМИЗАЦИЯ: Если это не принудительное сохранение И нет изменений, выходим
        if (!immediate && !window.unsavedChanges) {
            return;
        }

        const userRef = doc(db, "users", user.uid);
        const currentPlatform = document.getElementById('platform') ? document.getElementById('platform').value : 'xh';
        
        // Берем только последние записи для экономии трафика
        const fullLog = window.activityLog || [];
        const fullHistory = window.historyData || [];
        const cloudLog = fullLog.slice(-300); 
        const cloudHistory = fullHistory.slice(-100);

        const dataToSave = {
            favorites: JSON.parse(localStorage.getItem('xch_favorites')) || [],
            blacklist: JSON.parse(localStorage.getItem('xch_blacklist')) || [],
            watchLater: JSON.parse(localStorage.getItem('xch_watch_later')) || [],
            tagScores: JSON.parse(localStorage.getItem('xch_tag_scores')) || {},
            
            history: cloudHistory,
            activityLog: cloudLog,
            watchHistory: (window.watchHistory || []).slice(-100),
            
            platform: currentPlatform,
            subscription: localStorage.getItem('xch_sub_level') || 'free', 
            email: user.email,
            lastUpdated: serverTimestamp(),
            modifiersPool: window.userModifiersPool || [],
            exploredCount: window.permanentExplored ? window.permanentExplored.size : 0
        };

        try {
            // merge: true позволяет обновлять только измененные поля (экономия операций записи)
            await setDoc(userRef, dataToSave, { merge: true });
            
            const now = Date.now();
            localStorage.setItem('xch_last_sync_ts', now);
            
            // ВАЖНО: Сбрасываем флаг изменений после успешного сохранения
            window.unsavedChanges = false;
            
            // Обновляем UI кнопки в настройках
            const btnText = document.getElementById('sync-btn-text');
            if(btnText) {
                const originalText = btnText.innerText;
                btnText.innerHTML = "✅ Saved";
                setTimeout(() => { if(btnText) btnText.innerHTML = "🔄 Synchronize Device"; }, 2000);
            }
            
            console.log(`☁️ Cloud Save Success (Writes saved via batching!)`);
        } catch (e) {
            console.error("Auto-save error:", e);
        }
    };
</script>

<script>
    let currentLang = 'en';
    let subscriptionLevel = localStorage.getItem('xch_sub_level') || 'free';
    let currentOrientation = localStorage.getItem('xch_orientation') || 'hetero';
    let cooldownList = [];
    const COOLDOWN_SIZE = 20;
    const TAG_DECAY_RATE = 0.98;
    const WRAPPED_THRESHOLD = 30;
    let data = [];
    let onbFoundLikes = [];    
    let onbFoundDislikes = [];

    let cryptoPollInterval = null;
    let cryptoTimerInterval = null;
    let currentBillingCycle = '1'; 

    let originalThemeId = null;
    let previewThemeId = null;
    let isPreviewActive = false;

    let isPanicEnabled = localStorage.getItem('xch_panic_enabled') !== 'false';
    let panicKey = localStorage.getItem('xch_panic_key') || 'Escape';
    let panicDouble = localStorage.getItem('xch_panic_is_double') !== 'false';
    let isRecordingKey = false; // Флаг записи клавиши

    let wrappedTimerInterval = null;

    let pendingOutboundUrl = '';

    const earlySponsors = [
        { name: "Alex M.", date: "Jan 2026" },
        { name: "CryptoWhale", date: "Jan 2026" }
    ];

    const TAG_ICONS = {

        'general': ['deco9.png'], 

        // 1. ANAL & ASS (Самые частые)
        'anal': ['anal1.png', 'anal2.png', 'anal3.png'],
        'ass': ['anal1.png', 'anal2.png'],
        'booty': ['anal1.png', 'anal2.png'],
        'big-ass': ['anal1.png', 'anal2.png'],

        // 2. BREASTS (Грудь)
        'big-tits': ['tits1.png', 'tits2.png'],
        'boobs': ['tits1.png', 'tits2.png'],
        'breasts': ['tits1.png', 'tits2.png'],
        'tit-fucking': ['tits1.png', 'tits2.png'],

        // 3. BDSM & ROUGH (Жесткое)
        'bdsm': ['bdsm1.png', 'bdsm2.png'],
        'bondage': ['bondage1.png', 'bondage2.png'],
        'rough': ['bdsm1.png', 'bdsm2.png'],
        'submission': ['bdsm1.png', 'bondage1.png'],
        'domination': ['bdsm2.png'],

        // 4. ORAL (Оральный)
        'oral': ['oral1.png', 'oral2.png'],
        'blowjob': ['oral1.png', 'oral2.png'],
        'deepthroat': ['oral1.png', 'oral2.png'],
        'licking': ['oral2.png'],

        // 5. CUM (Финал)
        'cum': ['cum1.png', 'cum2.png'],
        'creampie': ['cum1.png', 'cum2.png'],
        'cumshot': ['cum1.png', 'cum2.png'],
        'facial': ['cum1.png'],

        // 6. FEET (Ноги)
        'foot-fetish': ['feet1.png', 'feet2.png'],
        'feet': ['feet1.png', 'feet2.png'],
        'foot-worship': ['feet1.png', 'feet2.png'],

        // 7. GROUP (Групповое)
        'group': ['group1.png', 'group2.png', 'group3.png'],
        'threesome': ['group1.png', 'group2.png'],
        'gangbang': ['group3.png'],
        'orgy': ['group3.png'],

        // 8. LESBIAN (Лесби)
        'lesbian': ['lesbian1.png', 'lesbian2.png'],
        'tribadism': ['lesbian1.png', 'lesbian2.png'],
        'scissoring': ['lesbian3.png'],

        // 9. MILF (Зрелые)
        'milf': ['milf1.png', 'milf2.png'],
        'mature': ['milf1.png', 'milf2.png'],
        'mom': ['milf1.png'],

        'body-part': ['body1.png'],  
        'hentai': ['hentai1.png'],

        // 10. SOLO (Соло)
        'masturbation': ['solo1.png', 'solo2.png'],
        'solo': ['solo1.png', 'solo2.png'],
        'fingering': ['solo1.png', 'solo2.png'],

        // 11. PUBLIC/OUTDOOR (Улица)
        'public': ['public1.png', 'public2.png'],
        'outdoor': ['public1.png', 'public2.png'],
        'risky': ['public1.png'],

        // 12. ROLEPLAY/UNIFORM (Ролевые)
        'roleplay': ['roleplay1.png', 'roleplay2.png'],
        'uniform': ['roleplay1.png', 'roleplay2.png'],
        'maid': ['roleplay1.png'],
        'nurse': ['roleplay2.png'],
        'teacher': ['roleplay2.png'],

        // 13. TOYS (Игрушки)
        'toys': ['toys1.png', 'toys2.png'],
        'dildo': ['toys1.png', 'toys2.png'],
        'vibrator': ['toys1.png'],

        // 14. YOUNG/SCHOOL (Молодые)
        'schoolgirl': ['young1.png', 'young2.png'],
        'teen': ['young1.png', 'young2.png'],
        'student': ['young1.png'],

        // 15. TRANS (Транс)
        'trans': ['trans1.png', 'trans2.png', 'trans3.png'],
        'shemale': ['trans1.png', 'trans2.png'],
        'ladyboy': ['trans3.png'],

        // 16. INTERRACIAL (Межрасовое)
        'interracial': ['interracial1.png'],
        'bbc': ['interracial1.png'],
        'ebony': ['interracial1.png'],

        // 17. BBW (Пышки)
        'bbw': ['bbw1.png'],
        'fat': ['bbw1.png'],
        'chubby': ['bbw1.png'],

        // 18. LEGS/STOCKINGS (Чулки/Ноги)
        'stockings': ['legs1.png', 'legs2.png'],
        'legs': ['legs1.png', 'legs2.png'],
        'pantyhose': ['legs1.png', 'legs2.png'],
        'high-heels': ['legs2.png'],

        // 19. HARDCORE (Жесть)
        'hardcore': ['hardcore1.png'],
        'extreme': ['hardcore1.png'],
        'rough-sex': ['hardcore1.png'],

        // 20. ROMANCE (Романтика)
        'romance': ['romantic1.png', 'romantic2.png'],
        'passionate': ['romantic1.png', 'romantic2.png'],
        'kissing': ['romantic1.png']
    };

    const NEUTRAL_DECOS = [
        'deco1.png', 'deco2.png', 'deco3.png', 'deco4.png', 'deco5.png',
        'deco6.png', 'deco7.png', 'deco9.png', 'deco10.png', 'deco11.png'
    ];

    const EXPLORED_GROUPS = [
        // 1. Основа
        { 
            id: 'general', 
            iconTag: 'general',
            tags: ['general', 'specific', 'softcore', 'vanilla', 'romantic', 'sensual'] 
        },
        // 2. Соло и Руки
        { 
            id: 'solo', 
            iconTag: 'solo', 
            tags: ['solo', 'masturbation', 'fingering', 'autofellatio', 'handjob', 'hands', 'suck-off'] 
        },
        // 3. Анал
        { 
            id: 'anal', 
            iconTag: 'anal', 
            tags: ['anal', 'ass', 'booty', 'gap', 'rimming', 'prostate-massage', 'anal-training', 'asshole', 'fisting', 'gaping', 'pegging'] 
        },
        // 4. Грудь и Молоко
        { 
            id: 'breasts', 
            iconTag: 'big-tits', 
            tags: ['tits', 'big-tits', 'small-tits', 'nipples', 'lactation', 'breast-expansion', 'tit-fucking', 'breastfeeding'] 
        },
        // 5. Оральный
        { 
            id: 'oral', 
            iconTag: 'oral', 
            tags: ['oral', 'blowjob', 'cunnilingus', 'deepthroat', 'face-fucking', 'spitting', 'gagging', 'throat', 'licking', 'tongue'] 
        },
        // 6. Хардкор и БДСМ
        { 
            id: 'hardcore', 
            iconTag: 'bdsm', 
            tags: ['hardcore', 'bdsm', 'kinky', 'rough', 'pain', 'choking', 'bondage', 'rope', 'slave', 'domination', 'submission', 'spanking', 'whip', 'torture', 'humiliation', 'femdom', 'cbt'] 
        },
        // 7. ЛГБТ+ (Все вместе)
        { 
            id: 'lgbt', 
            iconTag: 'lesbian', 
            tags: ['gay', 'lesbian', 'trans', 'bi', 'shemale', 'futanari', 'crossdresser', 't4t', 'ladyboy', 'sissy', 'trap', 'yuri', 'yaoi'] 
        },
        // 8. Группа и Социум
        { 
            id: 'group', 
            iconTag: 'group', 
            tags: ['group', 'threesome', 'gangbang', 'orgy', 'cuckold', 'sharing', 'swingers', 'double-penetration', 'bukkake'] 
        },
        // 9. Ноги и Фут-фетиш
        { 
            id: 'feet', 
            iconTag: 'feet', 
            tags: ['feet', 'foot-fetish', 'legs', 'toes', 'stockings', 'shoes', 'boots', 'socks', 'pantyhose', 'high-heels', 'soles'] 
        },
        // 10. Ролевые и Костюмы
        { 
            id: 'roleplay', 
            iconTag: 'roleplay', 
            tags: ['roleplay', 'uniform', 'costume', 'teacher', 'nurse', 'cosplay', 'maid', 'cheerleader', 'police', 'military', 'office', 'secretary'] 
        },
        // 11. Публичное и Табу
        { 
            id: 'public', 
            iconTag: 'public', 
            tags: ['public', 'outdoor', 'risky', 'taboo', 'voyeur', 'exhibitionism', 'incest', 'family', 'step-mom', 'step-sister', 'car', 'beach'] 
        },
        // 12. Тело и Внешность
        { 
            id: 'body', 
            iconTag: 'body-part', 
            tags: ['body-type', 'body-part', 'bbw', 'skinny', 'muscle', 'face', 'hair', 'tattoo', 'piercing', 'chubby', 'fat', 'hairy', 'redhead', 'blonde', 'brunette', 'milf', 'teen', 'interracial'] 
        },
        // 13. Игрушки и Машины
        { 
            id: 'toys', 
            iconTag: 'toys', 
            tags: ['toys', 'dildo', 'vibrator', 'machine', 'plug', 'strap-on', 'sybian', 'doll'] 
        },
        // 14. Жидкости и Грязь
        { 
            id: 'mess', 
            iconTag: 'cum', 
            tags: ['cum', 'creampie', 'mess', 'squirting', 'facial', 'wet', 'piss', 'scat', 'vomit', 'sweat', 'mud', 'oil', 'slime'] 
        },
        // 15. Фантазия и Арт
        { 
            id: 'fantasy', 
            iconTag: 'hentai', 
            tags: ['fantasy', 'hentai', 'anime', 'art', 'visual', 'cartoon', 'monster', 'alien', 'giantess', 'vore', 'furry', 'transformation'] 
        },
        // 16. Одежда и Материалы
        { 
            id: 'clothing', 
            iconTag: 'legs', // Чулки как символ одежды
            tags: ['clothing', 'latex', 'leather', 'lingerie', 'spandex', 'nylon', 'satin', 'dress', 'skirt', 'underwear', 'panties', 'bikini'] 
        }
    ];

    const CHANGELOG_DATA = [
        {
            ver: "0.1",
            date: "Jan 2026",
            changes: {
                en: ["I was born 👶. First public release."],
                ru: ["Я родился 👶. Первый публичный релиз."],
                es: ["Nací 👶. Primer lanzamiento público."],
                de: ["Ich wurde geboren 👶. Erste öffentliche Veröffentlichung."]
            }
        }
    ];

    let watchStartTime = 0; // Время ухода с сайта

    let permanentExplored = new Set(JSON.parse(localStorage.getItem('xch_permanent_explored')) || []);

    let achievementDates = JSON.parse(localStorage.getItem('xch_achievement_dates')) || {};

    // Слушатель возвращения на вкладку
    document.addEventListener("visibilitychange", () => {
        // Если вкладка стала видимой И мы засекали время
        if (document.visibilityState === "visible" && watchStartTime > 0) {
            calculateWatchTime();
        }
    });

    const DAILY_LIMIT = 50;
    let currentItem = null;
    let lastGeneratedItem = null; 
    let hasInteractedWithCurrent = false;

    let suggestedFavId = null;
    let suggestedNewId = null; 

    let pendingPlan = null;

    let activeMods = new Set();
    let isGenerating = false;
    let isFirstGen = true;
    let hasWatchedCurrentItem = false;
    let currentIntensity = 1; 
    
    // STATS STATE
    let currentStatsTab = 'tags';
    let currentStatsTimeframe = 'all';

    // Tinder
    let startX = 0, startY = 0;
    let currentX = 0, currentY = 0;
    let isDragging = false;
    const card = document.getElementById('card-block');
    const overlayLike = document.querySelector('.overlay-like');
    const overlayNope = document.querySelector('.overlay-nope');

    let sessionHistoryStack = [];

    let onboardingSelectedIds = [];

    let currentSlideIndex = 0;
    let slideInterval;
    let itemBeingWatched = null; 
    let currentHistoryTab = 'swipes';

    let currentAppMode = 'explore';
    let aiContextTokens = [];
    let isModeSelectActive = false; 

    let viewedTips = JSON.parse(localStorage.getItem('xch_viewed_tips')) || [];

    const API_BASE_URL = "https://api.fetishback.site";

    const STORAGE = {
        THEME: 'xch_theme',
        LANG: 'xch_lang',
        BLACKLIST: 'xch_blacklist',
        FAVORITES: 'xch_favorites',
        WATCH_LATER: 'xch_watch_later',
        INTENSITY: 'xch_intensity',
        TAG_SCORES: 'xch_tag_scores',
        HISTORY: 'xch_history',
        ACTIVITY_LOG: 'xch_activity_log',
        WATCH_HISTORY: 'xch_watch_history'
    };

    const APP_THEMES = [
        // === BASIC (Row 1) ===
        { id: 'dark', name: 'Dark (Cyber)', type: 'free', isLight: false, preview: '#ff00cc', accent: null },
        { id: 'light', name: 'Light (Sakura)', type: 'free', isLight: true, preview: '#ffeef8', accent: null },
        
        // === PREMIUM ===
        { 
            id: 'noir', name: 'Noir', type: 'pro', isLight: false, preview: '#000000',
            colors: { bg: '#000000', sidebar: '#0a0a0a', card: '#141414', nav: '#141414', border: '#333333' },
            accent: '#ffffff', accentLight: '#cccccc'
        },
        { 
            id: 'blue-dark', name: 'Midnight', type: 'pro', isLight: false, preview: '#0a192f',
            colors: { bg: '#020c1b', sidebar: '#0a192f', card: '#112240', nav: '#112240', border: '#233554' },
            accent: '#64ffda', accentLight: '#94ffea'
        },
        { 
            id: 'green-dark', name: 'Forest', type: 'pro', isLight: false, preview: '#051405',
            colors: { bg: '#020a02', sidebar: '#051405', card: '#0f290f', nav: '#0f290f', border: '#1a401a' },
            accent: '#2ecc71', accentLight: '#58d68d'
        },
        { 
            id: 'red-dark', name: 'Vampire', type: 'pro', isLight: false, preview: '#1a0000',
            colors: { bg: '#0d0000', sidebar: '#1a0000', card: '#330000', nav: '#330000', border: '#4d0000' },
            accent: '#e74c3c', accentLight: '#ff6b6b'
        },
        { 
            id: 'gold-dark', name: 'Luxury', type: 'pro', isLight: false, preview: '#141100',
            colors: { bg: '#0a0900', sidebar: '#141100', card: '#292200', nav: '#292200', border: '#4d4000' },
            accent: '#f1c40f', accentLight: '#f4d03f'
        },
        { 
            id: 'purple-dark', name: 'Amethyst', type: 'pro', isLight: false, preview: '#3b005e',
            colors: { bg: '#0d0014', sidebar: '#180026', card: '#240038', nav: '#240038', border: '#4a0072' },
            accent: '#9d00ff', accentLight: '#c466ff'
        },
        { 
            id: 'orange-dark', name: 'Magma', type: 'pro', isLight: false, preview: '#331a00',
            colors: { bg: '#0f0700', sidebar: '#1f0f00', card: '#331a00', nav: '#331a00', border: '#663300' },
            accent: '#ff6600', accentLight: '#ff9933'
        },
        { 
            id: 'old-money', 
            name: 'Old Money', 
            type: 'pro', 
            isLight: false, 
            preview: '#1a0505', // Темный квадрат для превью
            colors: { bg: '#1a0505', sidebar: '#260909', card: '#2e0b0b', nav: '#2e0b0b', border: '#4a1919' },
            accent: '#c5a059', 
            accentLight: '#e6c98c'
        }
    ];

    let blacklist = JSON.parse(localStorage.getItem(STORAGE.BLACKLIST)) || [];
    let favorites = JSON.parse(localStorage.getItem(STORAGE.FAVORITES)) || [];
    let itemScores = JSON.parse(localStorage.getItem('xch_item_scores')) || {};
    let watchLater = JSON.parse(localStorage.getItem(STORAGE.WATCH_LATER)) || [];
    let tagScores = JSON.parse(localStorage.getItem(STORAGE.TAG_SCORES)) || {};
    let historyData = JSON.parse(localStorage.getItem(STORAGE.HISTORY)) || [];
    let watchHistory = JSON.parse(localStorage.getItem(STORAGE.WATCH_HISTORY)) || [];
    let activityLog = JSON.parse(localStorage.getItem(STORAGE.ACTIVITY_LOG)) || [];

    const modifiersData = [
        { key: 'Amateur', en: 'Amateur', ru: 'Любительское', es: 'Amateur', de: 'Amateur' },
        { key: 'POV', en: 'POV', ru: 'POV', es: 'POV', de: 'POV' },
        { key: 'Hardcore', en: 'Hardcore', ru: 'Жесткое', es: 'Hardcore', de: 'Hardcore' },
        { key: 'Homemade', en: 'Homemade', ru: 'Домашнее', es: 'Casero', de: 'Hausgemacht' },
        { key: 'Oiled', en: 'Oiled', ru: 'В масле', es: 'Aceite', de: 'Eingeölt' },
        { key: 'Gay', en: 'Gay', ru: 'Геи', es: 'Gay', de: 'Schwul' },
        { key: 'BBW', en: 'BBW', ru: 'BBW', es: 'BBW', de: 'BBW' },
        { key: 'Lesbian', en: 'Lesbian', ru: 'Лесби', es: 'Lesbianas', de: 'Lesbisch' },
        { key: 'Trans', en: 'Trans', ru: 'Транс', es: 'Trans', de: 'Trans' },
        { key: 'Orgy', en: 'Orgy', ru: 'Оргия', es: 'Orgía', de: 'Orgie' },
        { key: 'VR', en: 'VR', ru: 'VR', es: 'RV (VR)', de: 'VR' },
        { key: 'Compilation', en: 'Compilation', ru: 'Сборник', es: 'Compilación', de: 'Kompilation' },
        { key: 'Vintage', en: 'Vintage', ru: 'Ретро', es: 'Vintage', de: 'Vintage' },
        { key: 'Solo', en: 'Solo', ru: 'Соло', es: 'Solo', de: 'Solo' },
        { key: 'AI', en: 'AI', ru: 'ИИ', es: 'IA', de: 'KI' },
        { key: 'Squirt', en: 'Squirt', ru: 'Сквирт', es: 'Squirt', de: 'Squirt' },
        { key: 'Uncensored', en: 'Uncensored', ru: 'Без цензуры', es: 'Sin censura', de: 'Unzensiert' }
    ];

    // Дефолтный пул
    const DEFAULT_MODS_POOL = []; 

    // 1. Загружаем то, что сохранено. Если нет — пустой массив.
    let savedPool = [];
    try {
        savedPool = JSON.parse(localStorage.getItem('xch_user_mods'));
    } catch (e) {
        console.error("Error parsing user mods", e);
    }

    // Если в памяти ничего нет — начинаем с нуля
    let userModifiersPool = Array.isArray(savedPool) ? savedPool : [];

    localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));

    const STOP_WORDS = [
        "i", "want", "need", "show", "me", "some", "video", "porn", "please", "today", "now", "like", "love", "looking", "for",
        "surprise", "give", "find", "search", "something", "about", "with",
        "я", "хочу", "покажи", "мне", "что-то", "сегодня", "сейчас", "люблю", "нравится", "нужен", "нужна", "посоветуй",
        "удиви", "дай", "найди", "поиск", "какой-нибудь", "про", "с", "на", "тему", "типа", "наподобие",
        "quiero", "ver", "dame", "algo", "hoy", "ahora", "gusta", "necesito", "sorprendeme", "busca",
        "ich", "will", "möchte", "zeig", "mir", "heute", "jetzt", "überrasch", "suche"
    ];

    const CLEAN_PHRASES = [
        "связанное с", "относящееся к", "похожее на", // RU
        "related to", "connected with", "similar to", // EN
        "relacionado con", "parecido a", // ES
        "ähnlich wie", "verbunden mit", "bezogen auf" // DE
    ];

    const NEGATIVES = [
        "no ", "without ", "not ", "except ", // EN
        "без ", "не ", "кроме ", // RU
        "sin ", "no ", "excepto ", // ES
        "ohne ", "kein ", "außer " // DE
    ];

    const SPECIAL_COMMANDS = {
        surprise: {
            en: ["surprise", "random", "lucky"],
            ru: ["удиви", "случайно", "рандом", "что угодно"],
            es: ["sorprende", "aleatorio", "suerte"],
            de: ["überrasch", "zufall", "glück"]
        },
        yesterday: {
            en: ["yesterday", "last time", "again"],
            ru: ["вчера", "прошлый раз", "повтори", "как раньше"],
            es: ["ayer", "ultima vez", "otra vez"],
            de: ["gestern", "letztes mal", "wieder"]
        }
    };

    const welcomePhrases = {
        en: [
            "Thought you wouldn't come back 😁",
            "You come here often, don't you? 😏",
            "Let's skip the foreplay 🌚",
            "Ready to sin? 😈",
            "I missed you... barely.",
            "Back for more? I knew it.",
            "Your incognito tab missed you.",
            "Let's find something dirty.",
            "Bored or horny? Let's fix both.",
            "Don't tell anyone you're here 🤫"
        ],
        ru: [
            "Думал, ты больше не вернёшься 😁",
            "Как-то ты часто здесь появляешься 😏",
            "Давай без прелюдий 🌚",
            "Твой режим инкогнито скучал по мне.",
            "Снова здесь? Я так и знал.",
            "Скучно или одиноко? Сейчас исправим.",
            "Только никому не говори, что ты здесь 🤫",
            "Готов согрешить? 😈",
            "Ищем что-то новенькое или как обычно?",
            "Надеюсь, ты в наушниках..."
        ],
        es: [
            "Pensé que no volverías 😁",
            "Vienes muy seguido por aquí 😏",
            "Saltemos los juegos previos 🌚",
            "¿Listo para pecar? 😈",
            "Tu modo incógnito te extrañaba.",
            "¿De nuevo aquí? Lo sabía.",
            "No le digas a nadie que estás aquí 🤫",
            "¿Aburrido o caliente? Arreglemos eso.",
            "Busquemos algo sucio.",
            "Espero que tengas audífonos..."
        ],
        de: [
            "Dachte, du kommst nicht zurück 😁",
            "Du bist aber oft hier 😏",
            "Lass uns das Vorspiel überspringen 🌚",
            "Bereit zu sündigen? 😈",
            "Dein Inkognito-Tab hat dich vermisst.",
            "Schon wieder hier? Wusste ich es doch.",
            "Erzähl niemandem, dass du hier bist 🤫",
            "Langeweile oder Lust? Lösen wir beides.",
            "Lass uns etwas Schmutziges finden.",
            "Hoffentlich hast du Kopfhörer auf..."
        ]
    };

    const firstTimePhrase = {
        en: "Glad to see more people here 😏",
        ru: "Рад видеть ещё людей здесь 😏",
        es: "Me alegra ver más gente aquí 😏",
        de: "Schön, mehr Leute hier zu sehen 😏"
    };

    function setWelcomeMessage() {
        const statusEl = document.getElementById('status-text');
        if(!statusEl) return;
        
        // Проверяем первый вход через LocalStorage
        const isReturningUser = localStorage.getItem('xch_has_visited');
        
        let text = "";
        
        if (!isReturningUser) {
            // ПЕРВЫЙ ВХОД
            text = firstTimePhrase[currentLang] || firstTimePhrase.en;
            // Запоминаем пользователя
            localStorage.setItem('xch_has_visited', 'true');
        } else {
            // ПОВТОРНЫЙ ВХОД
            const phrases = welcomePhrases[currentLang] || welcomePhrases.en;
            text = phrases[Math.floor(Math.random() * phrases.length)];
        }

        // Устанавливаем текст и цвет
        statusEl.innerText = text;
        statusEl.style.color = "var(--accent)"; 
        statusEl.style.fontWeight = "700";
    }

    const wlReminderPhrases = {
        en: [
            "Seems like you wanted to watch this... 👀",
            "You saved this for later. Is 'later' now? 😏",
            "A reminder from your personal stash 📂",
            "Don't let this wait forever 🔥",
            "Your past self had good taste ✨"
        ],
        ru: [
            "Кажется, ты хотел это посмотреть... 👀",
            "Ты отложил это на потом. 'Потом' наступило? 😏",
            "Напоминание из твоей личной коллекции 📂",
            "Не заставляй это ждать вечно 🔥",
            "У твоего прошлого 'я' был отличный вкус ✨"
        ],
        es: [
            "Parece que querías ver esto... 👀",
            "Guardaste esto para luego. ¿Es ahora? 😏",
            "Un recordatorio de tu colección personal 📂",
            "No lo hagas esperar para siempre 🔥",
            "Tu yo del pasado tenía buen gusto ✨"
        ],
        de: [
            "Scheint, als wolltest du das sehen... 👀",
            "Du hast das für später gespeichert. Ist jetzt 'später'? 😏",
            "Eine Erinnerung aus deiner Sammlung 📂",
            "Lass es nicht ewig warten 🔥",
            "Dein früheres Ich hatte guten Geschmack ✨"
        ]
    };

    const favReminderPhrases = {
        en: [
            "Let's remember this gem? 💎",
            "A classic from your collection ✨",
            "Ready for round two? 🔄",
            "You loved this one. Still do? 😏",
            "Oldie but goldie 🔥"
        ],
        ru: [
            "Давай вспомним это ещё раз? 💎",
            "Классика твоей коллекции ✨",
            "Готов ко второму раунду? 🔄",
            "Тебе это нравилось. Всё ещё? 😏",
            "Старый друг лучше новых двух 🔥"
        ],
        es: [
            "¿Recordamos esta joya? 💎",
            "Un clásico de tu colección ✨",
            "¿Listo para la segunda ronda? 🔄",
            "Te encantó esto. ¿Aún te gusta? 😏",
            "Viejo pero bueno 🔥"
        ],
        de: [
            "Erinnern wir uns an dieses Juwel? 💎",
            "Ein Klassiker aus deiner Sammlung ✨",
            "Bereit für Runde zwei? 🔄",
            "Du hast das geliebt. Immer noch? 😏",
            "Alt aber gold 🔥"
        ]
    };

    const banReminderPhrases = {
        en: [
            "Maybe give it another shot? 🤔",
            "Tastes change... do yours? 🤨",
            "Are you sure you hate this? 🧐",
            "Everyone deserves a second chance 👻",
            "Risky click of the day 🎲"
        ],
        ru: [
            "Может дашь ещё шанс? 🤔",
            "Вкусы меняются... а твои? 🤨",
            "Точно уверен, что не нравится? 🧐",
            "Все заслуживают второй шанс 👻",
            "Рискнём ещё разок? 🎲"
        ],
        es: [
            "¿Quizás darle otra oportunidad? 🤔",
            "Los gustos cambian... ¿los tuyos? 🤨",
            "¿Seguro que odias esto? 🧐",
            "Todos merecen una segunda oportunidad 👻",
            "El riesgo del día 🎲"
        ],
        de: [
            "Vielleicht noch eine Chance geben? 🤔",
            "Geschmäcker ändern sich... deiner auch? 🤨",
            "Sicher, dass du das hasst? 🧐",
            "Jeder verdient eine zweite Chance 👻",
            "Risiko des Tages 🎲"
        ]
    };

    const animationPhrases = {
        en: ["Finding your fetish...", "Scanning the hub...", "What will it be?", "Looking for spicy stuff..."],
        ru: ["Ищем твой фетиш...", "Сканируем хаб...", "Что же выпадет?", "Подбираем погорячее..."],
        es: ["Buscando tu fetiche...", "Escaneando el hub...", "¿Qué será?", "Buscando algo picante..."],
        de: ["Suche deinen Fetisch...", "Scanne den Hub...", "Was wird es sein?", "Suche etwas Scharfes..."]
    };

    const resultComments = {
        en: ["Like it? Go watch 😈", "Not bad, huh? 😏", "Enjoy your time 🔥", "Go for it! 😀"],
        ru: ["Заинтересовало? Иди и смотри 😈", "Неплохой фетиш, а? 😏", "Приятного просмотра 🔥", "Ну всё, беги смотреть! 😀"],
        es: ["¿Te gusta? Ve a verlo 😈", "Nada mal, ¿eh? 😏", "Disfruta tu tiempo 🔥", "¡Ve por ello! 😀"],
        de: ["Gefällt es dir? Schau es an 😈", "Nicht schlecht, oder? 😏", "Viel Spaß 🔥", "Tu es! 😀"]
    };

    const langData = {
        en: {
            // --- 1. General & Navigation ---
            subtitle: "Your home for adult preferences",
            lang_label: "Language",
            nav_home: "Home",
            nav_settings: "Settings",
            nav_account: "Account",
            header_prefs: "Preferences",
            header_filters: "Filters",  
            mode_label: "Mode", 
            ori_label: "Orientation",
            ori_hetero: "Hetero",
            ori_gay: "Gay",
            ori_trans: "Trans",
            ori_pan: "Pansexual",
            header_extras: "Extras",
            header_community: "Community",
            header_features: "Features",
            header_legal: "Legal",
            theme_label: "Appearance",
            theme_title: "Choose Theme",
            theme_basic: "Basic",
            theme_premium: "Premium Colors",
            btn_start: "Let's Go",
            btn_pass: "Other",
            btn_like: "Similar",
            btn_upgrade_short: "Upgrade ⇧",
            btn_return: "Return",
            watch_later: "Watch Later",
            empty_wl: "No saved items yet",
            sync_label: "Synced: ",
            expl_undo: "Changed your mind? 😏",
            expl_hist: "From Archives 📜",
            deco_label: "Show Decorations",

            mod_add_custom: "Add Custom Tag",
            mod_input_ph: "e.g. Redhead, Latex...",
            mod_add_btn: "Add",

            cat_tips_tech: "Tech & Features",
            cat_tips_info: "Info & 18+ Knowledge",

            tip_sites_title: "Site Guide 2026",
            tip_sites_desc: "Pros, cons, and which to pick",
            tip_sites_text: `
                <b>xVideos</b> — The People's Choice.<br>
                ✅ <b>Pros:</b> Largest library, loads instantly, tons of amateur/niche content.<br>
                ❌ <b>Cons:</b> Lower video quality, lots of ads and spam.<br>
                👉 <i>Best for maximum variety and rare niches.</i><br><br>

                <b>Pornhub</b> — Premium Experience.<br>
                ✅ <b>Pros:</b> Best UI, great recommendations, verified models, lots of 4K.<br>
                ❌ <b>Cons:</b> Geo-blocked in some US states (VPN needed), aggressive Premium ads.<br>
                👉 <i>Best for quality, convenience, and community.</i><br><br>

                <b>xHamster</b> — Amateur Heaven.<br>
                ✅ <b>Pros:</b> Clean design, focus on real amateur videos, photos, and cams. Less censorship.<br>
                ❌ <b>Cons:</b> Fewer professional studio videos.<br>
                👉 <i>Best for "real" sex fans and VR.</i><br><br>

                <b>SpankBang</b> — Connoisseur's Choice.<br>
                ✅ <b>Pros:</b> Lots of free HD/4K, great "similar" algorithms, user playlists.<br>
                ❌ <b>Cons:</b> Frequent duplicates, fewer categories.<br>
                👉 <i>Best for high quality for free.</i><br><br>

                <b>YouPorn / RedTube</b> — The Classics.<br>
                ✅ <b>Pros:</b> Stable quality, simple interface (part of PH network).<br>
                ❌ <b>Cons:</b> Less unique content, essentially PH's "little brothers".<br>
                👉 <i>Simple alternatives without clutter.</i>
            `,

            // 1. ALGORITHM
            tip_algo_title: "How the Algorithm Works",
            tip_algo_desc: "Training xFetishHub secrets",
            tip_algo_text: `
                xFetishHub is not just a randomizer. It's a neural network of your arousal.<br><br>
                <b>👍 Swipe Right (Like):</b><br>
                You tell the system: "I want more of this." We remember the tags (e.g., <i>Milf, Stockings</i>) and boost their weight. They will appear more often.<br><br>
                <b>👎 Swipe Left (Dislike):</b><br>
                You say: "Take this away." Tag weights drop. If you dislike <i>BDSM</i> often, the system will stop suggesting it.<br><br>
                <b>💡 Tip:</b><br>
                Don't be afraid to dislike what turns you off. The more honest you are, the better the recommendations in <b>"Pleasure"</b> mode become.
            `,

            // 2. GLOSSARY
            tip_dict_title: "Fetish Glossary",
            tip_dict_desc: "POV, PMV, JOI and others",
            tip_dict_text: `
                Confused by acronyms? Here is a breakdown of the most popular ones:<br><br>
                <b>POV (Point Of View):</b> Filmed from the first-person perspective. You see through the actor's eyes.<br>
                <b>PMV (Porn Music Video):</b> Clips edited to music. Aesthetic and rhythmic.<br>
                <b>JOI (Jerk Off Instruction):</b> The model tells you exactly what to do and when.<br>
                <b>BBW (Big Beautiful Woman):</b> Plus-size women. More than just "chubby".<br>
                <b>PAWG (Phat Ass White Girl):</b> Self-explanatory. A cult favorite.<br>
                <b>SPH (Small Penis Humiliation):</b> A popular niche involving teasing sizes.<br>
                <b>CBT (Cock and Ball Torture):</b> Hardcore fetish involving pain to genitals.<br>
                <b>Creampie:</b> Finishing inside. A timeless classic.
            `,

            // 3. PSYCHOTYPES
            tip_psycho_title: "All Psychotypes",
            tip_psycho_desc: "Badges you can earn",
            tip_psycho_text: `
                In your weekly <b>Fetish Wrapped</b>, you get a psychotype based on your history. Here are the rarest ones:<br><br>
                👑 <b>The Dark Lord:</b><br>You love BDSM, Humiliation, and Taboo. You explore the deepest shadows.<br><br>
                🎭 <b>The Performer:</b><br>Frequent Public and Roleplay tags. Life is a stage for you.<br><br>
                🕯️ <b>The Idolater:</b><br>Focus on body parts (Feet, Hands) and Clothing (Latex, Stockings). You worship the form.<br><br>
                🧠 <b>The Manipulator:</b><br>Psychological play, JOI, Hypno. You play with souls, not just bodies.<br><br>
                🍇 <b>The Caligula:</b><br>Group sex + Hardcore. Chaos and pleasure intertwined.<br><br>
                🍦 <b>The Classic:</b><br>Vanilla, Romantic, Standard. Simplicity is the ultimate sophistication.
            `,

            tip_pwa_title: "Turn Site into App",
            tip_pwa_desc: "Fullscreen, Private Browser & Forever History",
            tip_pwa_text: `
                Did you know xFetishHub is designed to be an App?<br><br>
                <b>Why install?</b><br>
                ✅ <b>It looks gorgeous:</b> Fullscreen, no ugly browser bars.<br>
                ✅ <b>Built-in Private Browser:</b> When you click 'Watch', videos open <i>inside</i> the app. Your main browser history (Safari/Chrome) stays clean!<br>
                ✅ <b>Eternal Memory:</b> Browsers often delete data after 7 days. The App keeps your history and preferences forever.<br><br>
                <b>How to install:</b><br>
                🍎 <b>iOS (Safari):</b> Tap 'Share' (square with arrow) → Scroll down → 'Add to Home Screen'.<br>
                🤖 <b>Android (Chrome):</b> Tap Menu (3 dots) → 'Install App' or 'Add to Home Screen'.
            `,

            tip_mods_title: "Power of Modifiers",
            tip_mods_desc: "How to refine your search",
            tip_mods_text: `
                The <b>+</b> button under the card is your best friend.<br><br>
                <b>How it works:</b><br>
                Modifiers work <i>on top</i> of the generated genre. They act like an additional filter.<br><br>
                <b>Example:</b><br>
                1. You roll "Anal".<br>
                2. You add the modifier "POV".<br>
                3. Result: The app searches for <b>"Anal + POV"</b>.<br><br>
                <b>Pro Tip:</b><br>
                You can now add <b>Custom Modifiers</b>! Want "Redhead"? Or specific "Latex"? Just type it in the modifiers menu, and it will apply to every search.
            `,

            pt_title: "Did you know?",
            pt_desc: "If you want to learn how to completely disable ads in videos or not get caught at the right moment, read the Knowledge Base here, you won't be disappointed 🌚",
            pt_btn_go: "Open Knowledge Base",

            theme_preview_mode: "Preview",
            btn_unlock_theme: "Unlock Theme 🔒",
            theme_tap_cancel: "Tap anywhere to cancel",

            site_random: "Random",

            btn_version: "Version",
            changelog_title: "Version History",

            limit_title: "Limit Reached",
            limit_desc_fun: "That's enough for today, buddy. Come back tomorrow, or join Pro and watch until you turn blue 😏",

            act_time: "Time",

            unlocked_on: "Unlocked:",
            explored_subtitle: "Here are the achievements you need to get 'Platinum' 😈",
            cat_general: "General & Basic",
            cat_solo: "Solo & Hands",
            cat_anal: "Anal & Ass",
            cat_breasts: "Breasts & Milk",
            cat_oral: "Oral Pleasure",
            cat_hardcore: "Hardcore & BDSM",
            cat_lgbt: "LGBTQ+",
            cat_group: "Group & Social",
            cat_feet: "Feet & Legs",
            cat_roleplay: "Roleplay & Uniforms",
            cat_public: "Public & Taboo",
            cat_body: "Body & Appearance",
            cat_toys: "Toys & Machines",
            cat_mess: "Fluids & Mess",
            cat_fantasy: "Fantasy & Art",
            cat_clothing: "Clothing & Fetish",

            panic_active_phrases: ["Nothing suspicious here 😇", "Just a hobby", "Pure innocence", "Productivity boost 📈", "Stay hydrated 💧"],

            val_safe: "Safe & Chill",
            val_spicy: "Spicy 🔥",
            val_extreme: "EXTREME 💀",

            share_caption: "Discover yourself",

            mode_greeting_hint: [
                "Explore 🔭, Enjoy 🥰, or a Wish ✨?",
                "Trust the dice 🔭, your history 🥰, or AI ✨?",
                "Something new 🔭, familiar 🥰, or specific ✨?",
                "Roll the dice 🔭, replay hits 🥰, or describe a fantasy ✨?"
            ],
            mode_greeting_dynamic: [
                "In the mood for<br><b>{fav}</b> 🥰<br>or maybe check something new like<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Or type specific ✨, I won't disappoint 😏</span>",
                "Back to<br><b>{fav}</b> 🥰<br>or take a risk with<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>You can also describe a fantasy ✨</span>",
                "Missed<br><b>{fav}</b> 🥰?<br>Or let's explore<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>Or just ask me, I'll find it ✨</span>"
            ],
            mode_explore: "Explore",
            mode_pleasure: "Pleasure",
            mode_ai: "AI Agent",

            info_header: "Information",
            hist_tab_swipes: "Swipes",
            hist_tab_watch: "Time",
            hist_empty_watch: "No watch data yet. Go watch something! 😏",
            hist_watched: "WATCHED",

            status_wl: "In Watch Later",
            status_fav: "Liked",
            status_ban: "Disliked",

            stats_no_data: "No data yet",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Make {n} more moves to unlock your personal summary",
            
            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amethyst",
            "theme_purple-light": "Lavender",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Peach",
            "theme_old-money": "Old Money",
    

            plan_bestie_sub: "Lifetime",
            plan_bestie_price: "/ once",
            badge_limited: "LIMITED OFFER",
            limit_burn: "🔥 ALMOST GONE",
            limit_claimed: "claimed",
            feat_lifetime: "♾️ <b>Lifetime Access</b>",
            feat_onetime: "💸 One-time payment",
            btn_get_bestie: "Get Forever",

            // --- Sponsors ---
            btn_early_sponsors: "Early Sponsors",
            sponsors_title: "Wall of Fame",
            sponsors_desc: "These legends supported xFetishHub at the very beginning by purchasing the Bestie plan. Forever grateful! 💙",

            return_phrases: [
                "A whole {t}. You acted surely 😏",
                "Back after {t}. Did you enjoy it? 🔥",
                "{t}... Quite a session! 😅",
                "You were gone for {t}. Hope it was worth it.",
                "Wow, {t}! Seems like a good choice."
            ],
            return_phrase_short: "Only {t}? That was quick... ⚡",

            reset_phrases: [
                "Sometimes everyone needs a break 🧘",
                "Let's start over...",
                "System reboot 🔄",
                "Peace and quiet...",
                "Clean slate ✨"
            ],

            auth_title: "Sync & Backup",
            auth_p1: "Store history and preferences on all devices",
            auth_p2: "Activate Pro / Beast status",
            auth_p3: "Anonymous storage on Google servers",
            btn_google_signin: "Continue with Google",
            auth_security_note: "The developer doesn't have access to the data. But if you're worried, you can use a second account. 😏",
            btn_cancel: "Cancel",

            pay_header: "USDT (TRC20) Payment",
            pay_instruction: "Send the <b>EXACT amount</b> (including decimals!) via <b>Tron (TRC20)</b>.",
            pay_fee_warn: "⚠️ Network fee is NOT included. Do not send from exchange if fee is deducted from amount!",
            pay_sum_label: "Amount to send:",
            pay_copy_addr: "Tap to Copy Address",
            pay_how_to: "Don't have crypto? How to pay",
            pay_waiting: "Waiting for payment...",
            pay_success_title: "Payment Received!",
            pay_success_desc: "Subscription activated successfully.",
            pay_reload: "Reload Page",
            guide_title: "How to pay with Crypto",
            guide_warning: "Important: Select <b>TRON (TRC20)</b> network when sending.",
            btn_back: "Back",

            pay_problem_link: "Payment not credited?",
            pay_problem_title: "Where is my subscription?",
            pay_prob_desc: "If you sent money but the status hasn't changed within 10 minutes, here are common reasons:",
            pay_prob_reason_1: "<b>Wrong Amount:</b> You sent slightly less or more than required.",
            pay_prob_reason_2: "<b>Network Fee:</b> The exchange deducted the fee from the amount sent.",
            pay_prob_reason_3: "<b>Wrong Network:</b> You used BEP20 instead of TRC20.",
            pay_prob_solution: "Don't worry! Your money is safe. Send us your <b>TxID (Transaction Hash)</b> via support form, and we will activate it manually.",
            btn_contact_support: "Contact Support",
            
            // ПЕРЕВОДЫ ДЛЯ ГАЙДА (Guide View)
            guide_step_1: "<b>1. Telegram Wallet:</b><br>Open <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Buy USDT via P2P (Bank Card). Click 'Send' → 'External Wallet' → paste address.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Download app. Buy USDT (TRC20) with card. Send to our address.",

            info_header: "Information",
            lbl_support_email: "Support Email",
            doc_terms: "Terms of Use",
            doc_privacy: "Privacy Policy",
            doc_refund: "Refund Policy",

            
            btn_roadmap: "Roadmap",
            roadmap_title: "Roadmap",
            roadmap_desc: "With your active support via subscriptions, xFetishHub will evolve. Here is what we are building:",
            rm_global_title: "Global Intelligence",
            rm_global_desc: "Aggregation of anonymous data to create the smartest recommendation engine. Plus, view global 'Most Loved' and 'Most Hated' charts.",
            rm_coop_title: "Co-op Mode",
            rm_coop_desc: "Invite a partner or friend. They will see what genres you roll in real-time. Perfect for distant couples.",
            rm_content_title: "5000+ Categories",
            rm_content_desc: "Massive database expansion. Every specific micro-fetish and niche genre will be indexed.",
            rm_actors_title: "Actor Selector",
            rm_actors_desc: "A dedicated mode to find pornstars based on your visual preferences and body type filters.",
            rm_support_btn: "Support Development 🚀",

            ai_prompt: [
                "What do you desire today? 😏",
                "Describe your fantasy...",
                "What are you in the mood for?",
                "Tell me, what turns you on right now?"
            ],
            ai_placeholder: [
                "e.g. big tits, no anal...",
                "I want something passionate...",
                "Surprise me with redhead...",
                "Hardcore, outdoor, maybe spitting..."
            ],
            ai_thinking: "Searching the hub...",
            ai_btn_go: "Find It",
            ai_phrases_success: [
                "As you requested:",
                "Found exactly what you need.",
                "Your wish is my command.",
                "This matches your vibe perfectly.",
                "I think this is it.",
                "Straight from the database to you."
            ],
            ai_phrases_fail: [
                "That's a bit specific, but try this instead:",
                "I couldn't find an exact match, but you'll love this:",
                "My database is stumped, but here is a top pick:",
                "Tricky request... how about this?",
                "I didn't quite catch that, so here is something safe:"
            ],

            panic_btn: "Emergency Mode",
            panic_title: "Emergency Mode",
            panic_desc: "Enable a stealth mode to quickly hide content. Trigger it by <b>Double Tapping</b> anywhere or pressing <b>ESC twice</b>.",
            panic_enable: "Enable Trigger",
            
            // Safe Mode UI
            safe_subtitle: "Your home for favorite hobbies",
            safe_btn_start: "Start Hobby",
            safe_status: "Time to relax 😌",
            
            // Settings Masquerade
            safe_label_site: "Time",
            safe_label_ori: "Location",
            safe_label_int: "Difficulty",
            safe_opt_morn: "Morning", safe_opt_day: "Day", safe_opt_eve: "Evening",
            safe_opt_home: "Home", safe_opt_work: "Work", safe_opt_park: "Park",

            // Post-Panic Phrases
            post_panic_phrases: ["Hope you didn't get caught 😁", "That was close...", "Safe now 😮‍💨", "Back to business 😏"],

            vpn_title: "Just a heads up",
            vpn_text_1: "Must warn you: you are leaving for an 18+ site with adult content and ads. Just in case 😊.",
            vpn_text_pwa: "If the video doesn't play, try restarting it, or open it in a regular browser as a last resort.",
            vpn_text_2: "And don't forget VPN! Enjoy watching 😏",
            vpn_btn: "Let's go",

            tips_btn: "Useful Tips",
            tips_title: "Knowledge Base",
            tips_guru_title: "Become a Watching Guru 😈",
            btn_got_it: "Got it",

            tip_ads_title: "How to remove ads",
            tip_ads_desc: "Tricks for clean viewing in App",
            tip_ads_text: "There are NO ads in xFetishHub itself. However, when you click 'Watch', you go to 18+ sites which have ads.<br><br><b>Lifehack for App (PWA):</b><br>If you use the installed app on iPhone/Android, it uses your system browser engine (Safari/Chrome).<br>1. Install an Ad-Blocker (e.g., AdGuard) in Safari or Chrome.<br>2. Enable it in browser settings.<br>3. It will automatically work inside xFetishHub App!",

            tip_video_title: "Video won't play?",
            tip_video_desc: "Black screen or loading issues",
            tip_video_text: "Due to PWA (Progressive Web App) technology limitations on some devices, external video players might sometimes fail to load or show a black screen.<br><br><b>Solution:</b><br>1. Try refreshing the page.<br>2. If that doesn't help, open xFetishHub in a regular browser instead of the App.",

            tip_pay_title: "How to pay?",
            tip_pay_desc: "Why crypto & how to use it",
            tip_pay_text: "Currently, we only accept Cryptocurrency (USDT). Why? Because traditional payment systems (Stripe, Apple Pay) block adult-oriented projects.<br><br><b>New to Crypto? It's easy:</b><br>1. Open <b>@wallet</b> in Telegram.<br>2. Verify your account.<br>3. Buy USDT via P2P (Bank Card).<br>4. Send USDT to our address using TRC20 network.",

            tip_bug_title: "Report a Problem",
            tip_bug_desc: "Help improve the project",
            tip_bug_text: "This project is built by one person and launched recently, so bugs are inevitable. Your feedback is crucial!<br><br>To help, please go to the <b>Extras</b> section and click <b>'Report Issue'</b>.<br>Fill out the form describing what went wrong. I read every report and fix bugs ASAP!",

            tip_panic_title: "How not to get caught",
            tip_panic_desc: "Stealth mode secrets",
            tip_panic_text: "The app features a <b>Panic Mode</b>. Activate it by <b>Double Tapping</b> anywhere (or using hotkeys on PC).<br><br>It switches to a neutral interface where nothing embarrassing is visible.<br>To exit: click the main 'Start' button or use the same activation gesture.",

            tip_layout_title: "Overlapping phrases",
            tip_layout_desc: "Fixing layout bugs",
            tip_layout_text: "Due to PWA specifics on some mobile devices, the card might move too high, causing phrases to overlap with the logo capsule.<br><br><b>The Fix:</b><br>Simply rotate your phone to <b>landscape</b> mode and back to <b>portrait</b>. The layout will reset and look perfect again.",

            tip_int_title: "Intensity Levels",
            tip_int_desc: "What exactly changes?",
            tip_int_text: `
                <b>🛡️ SAFE (Level 1):</b><br>
                Vanilla, romantic, and standard sex. Completely filters out BDSM, fetish, and any rough content. Safe for work (almost).<br><br>
                <b>🔥 SPICY (Level 2):</b><br>
                Unlocks <b>BDSM & Kink</b>. Adds bondage, spanking, domination, submission, and fetishes. Filters out bodily fluids and pain.<br><br>
                <b>💀 EXTREME (Level 3):</b><br>
                Unlocks <b>Hardcore & Mess</b>. Adds what was hidden: watersports, scat, fisting, pain, and extreme fetishes. No filters.
            `,

            tip_modes_title: "Game Modes",
            tip_modes_desc: "Explore vs Pleasure vs AI",
            tip_modes_text: `
                <b>🔭 Explore (Default):</b><br>
                Balanced randomness. Uses your history slightly but prioritizes discovering new tags. Perfect when you don't know what you want.<br><br>
                <b>🥰 Pleasure:</b><br>
                Strictly follows your preferences. Uses "Liked" tags heavily and avoids experiments. Ideal for a quick guaranteed hit.<br><br>
                <b>🤖 AI Agent:</b><br>
                Activates when you use text or voice search. It understands context ("harder", "something new") and searches for specific scenarios.
            `,

            // --- 2. Generator (Main Tab) ---
            generate: "Random Genre",
            generate_again: "Different Genre",
            btn_similar: "Similar",
            watch: "Watch",
            search: "Search", // For Google mode
            related_header: "You may also like:",
            mod_manage: "Manage Modifiers",
            mod_title: "Modifiers",
            mod_active_sec: "Active (Visible)",
            mod_inactive_sec: "Inactive (Hidden)",
            mod_limit_reached: "Limit reached (Max 10)!",
            add_genre: "Add to genre:",
            search_en_label: "Search EN",
            site_label: "Site",
            exploration_mode: "Safety Level",
            
            // --- 3. Subscription (Premium) ---
            sub_title: "Premium Access",
            sub_intro: "xFetishHub is a one-of-a-kind project that helps you discover and analyze your adult preferences in one cozy, ad-free place. By subscribing, you ensure the project's survival, and in return, I'll give you significantly more features:",
            
            // Plans Features
            feat_limit: "🎲 50 Generations / day",
            feat_stats_basic: "📊 Basic Statistics",
            feat_filters: "✔️ Standard Filters",
            btn_current: "Current Plan",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / week",
            feat_wrapped_unlim: "✨ <b>Unlimited</b> Fetish Wrapped",

            lbl_subscription: "Subscription",
            limit_text_full: "🎲 50 Generations / day (left: {n}/50)",

            feat_unlim: "🔥 Unlimited Generations",
            feat_stats_adv: "📈 Advanced Stats & History",
            feat_custom: "🎨 Deep Customization",
            feat_early: "🚀 Early Access features",
            btn_get_pro: "Get Pro",

            feat_all_pro: "👑 All Pro Features",
            feat_all_beast: "🦁 <b>All Beast Features</b>",
            feat_sponsors: "💎 Listed in Sponsors",
            feat_discord: "💬 Discord with Developer",
            feat_vote: "🗳️ Vote on Roadmap",
            btn_get_beast: "Unleash Beast",

            bill_monthly: "Monthly",
            bill_yearly: "Yearly",

            btn_lower_tier: "You deserve better",

            pay_desc: "Select a payment method. You will receive an activation code instantly.",
            pay_stars: "Telegram Stars",
            pay_card: "Card (World)",
            pay_crypto: "Crypto (Anonymous)",
            pay_boosty: "Boosty (RF Cards)",
            pay_code_label: "If you paid, enter code here:",
            pay_code_placeholder: "Activation code...",

            lbl_current_plan: "Current Plan",
            login_alert: "Please log in to manage subscriptions!",

            // --- 4. Account & Data ---
            login_text: "Sync / Login",
            logout_text: "Logout",
            login_required: "Please log in (Sync Data) first so we can identify you!",
            sync_success: "Data synced successfully!",
            btn_open_stats: "Statistics",

            personal_account: "Personal Account",
            
            "theme_blue-dark": "Midnight",
            "theme_green-dark": "Forest",
            "theme_red-dark": "Vampire",
            "theme_gold-dark": "Luxury",
            "theme_noir": "Noir",
            "theme_blue-light": "Sky",
            "theme_green-light": "Mint",
            "theme_red-light": "Rose",
            "theme_gold-light": "Sand",
            "theme_dark": "Dark",
            "theme_light": "Light",

            history_title: "History",
            
            btn_reset: "Reset Data",
            confirm_reset: "Are you sure? This will delete your history, statistics, and preferences learning. This cannot be undone.",
            reset_done: "Data has been reset.",
            
            explored_label: "Explored",
            explored_txt: "{n} / {t} categories",
            report_issue: "Report Issue",

            sync_title: "Cloud Storage",
            sync_desc: "Data stored safely on Google servers",
            sync_tip: "Click 'Synchronize' to merge. <b>Page will reload to apply changes.</b>",
            sync_btn_success: "✅ Done! Reloading...",
            btn_sync: "🔄 Synchronize Device",
            sub_exp: "exp:",
            sub_expired: "Expired",
            time_d: "d",
            
            // --- 5. Lists (Favorites/Blacklist) ---
            favorites_catalog: "Liked",
            blacklist_catalog: "Disliked",
            btn_fav_add: "Favorite",
            btn_fav_remove: "In Favorites",
            btn_ban_add: "Block",
            btn_ban_remove: "Unblock",
            empty: "List is empty (Check filters)!",
            
            // --- 6. Filters ---
            filter_include: "Include",
            filter_exclude: "Exclude",
            tag_fav: "Favorites",
            tag_straight: "Straight", 
            tag_gay: "Gay", 
            tag_lesbian: "Lesbian", 
            tag_trans: "Trans",

            // --- 7. Statistics ---
            btn_stats: "Statistics",
            stats_header: "Your Favorite Categories",
            stats_prefs: "Preferences",
            stats_activity: "Activity",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Come back in a week. Or if you want stats every day, Pro subscription is your best friend.",
            btn_close: "Close",
            search_liked: "Search liked...",
            search_disliked: "Search disliked...",
            hist_empty: "History is empty",
            limit_reset: "Reset:",
            
            tf_week: "Week", 
            tf_month: "Month", 
            tf_year: "Year", 
            tf_all: "All time",
            
            act_gen: "Generations", 
            act_watch: "Watched",
            chart_prefs_x: "Preferences",
            chart_points_y: "Points",
            chart_count_y: "Count",
            share_btn: "Share",

            legend_watch: "Watch (+10)",
            legend_like: "Like / Similar (+5)",
            legend_dislike: "Other / Dislike (-10)",
            act_actions: "Swipes",
            act_watches: "Watches",

            // --- 8. Explanations (Why did I get this?) ---
            expl_fav: "Because you like ",
            expl_sim: "Related to previous",
            expl_rand: "Fate",
            expl_score: "Because you liked ",
            expl_tag_click: "You chose tag: ",

            // --- 9. Badges & Tooltips ---
            badge_extreme: "Extreme",
            badge_desc_extreme: "⚠️ <b>High Intensity</b><br>This category contains rough, intense, or hardcore elements. Not suitable for vanilla preferences.",
            
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>LGBTQ+ Content</b><br>Includes same-sex relationships (Gay/Lesbian) or Transgender content.",
            
            badge_niche: "Niche",
            badge_desc_niche: "🔍 <b>Specific Fetish</b><br>A distinct interest that focuses on specific body parts, objects, or scenarios rather than general sex.",
            
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM & Kink</b><br>Involves bondage, dominance, submission, or sensation play.",

            // --- 10. Modals (Age Gate, Onboarding) ---
            age_title: "Age Verification",
            age_desc: "This website contains age-restricted materials. Are you 18 years or older?",
            age_yes: "Yes, I am 18+",
            age_no: "No, Exit",
            age_block_msg: "This website is only for users over 18 years of age.",

            // Окно установки
            install_title: "Install App",
            install_desc: "Install app for full-screen mode. Plus, watch videos in the built-in browser to keep your main browser history clean!",
            install_continue: "Continue in Browser",

            btn_install_phone: "Install on Phone",
            qr_title: "Scan to Install",
            qr_desc: "Scan this QR code with your phone camera to open the site, then follow the instructions below:",
            
            inst_ios_1: "Tap the <b>Share</b> button",
            inst_ios_2: "Scroll down and tap",
            inst_ios_btn: "Add to Home Screen",
            inst_ios_3: "Tap <b>Add</b>.",
            
            inst_and_1: "Tap the <b>Menu</b> (3 dots)",
            inst_and_2: "Select",
            inst_and_btn: "Install App / Add to Home",

            onb_title: "Quick Setup",
            onb_desc: "Write what you like or dislike so we can get straight to what you love 😈.",
            onb_placeholder: "e.g. I love blowjob and anal, but hate foot fetish and outdoor...",
            onb_btn_check: "Find Categories",
            onb_found: "We found:",
            onb_btn_confirm: "Add to Favorites",
            onb_skip: "Skip setup",

            lbl_about: "About Project",
            
            terms_text: `
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing and using xFetishHub (the "Service"), you confirm that you are at least 18 years of age (or the age of majority in your jurisdiction) and agree to be bound by these Terms. If you do not agree, you must exit the Service immediately.</p>
                
                <h3>2. Nature of Service</h3>
                <p>xFetishHub is a search aggregator and recommendation engine. <b>We do not host, upload, or control any video content.</b> All links generated by the Service lead to third-party websites (e.g., xHamster, Pornhub). We serve as a conduit for finding content available publicly on the internet.</p>
                
                <h3>3. Third-Party Content</h3>
                <p>We have no control over, and assume no responsibility for, the content, privacy policies, or practices of any third-party websites. You acknowledge and agree that xFetishHub shall not be responsible or liable, directly or indirectly, for any damage or loss caused by your use of any third-party content.</p>
                
                <h3>4. User Accounts & Subscriptions</h3>
                <p>Some features require a paid subscription ("Pro" or "Beast"). Payment processing is handled by third-party providers (e.g., Telegram Stars, Lava, Cryptomus). We do not store your payment credentials. We reserve the right to terminate accounts that violate these Terms.</p>
                
                <h3>5. Disclaimer of Warranties</h3>
                <p>The Service is provided on an "AS IS" and "AS AVAILABLE" basis. We do not warrant that the results generated will meet your requirements or be free of errors.</p>
            `,

            privacy_text: `
                <h3>1. Introduction</h3>
                <p>Your privacy is our priority. This policy explains how we handle your data. We aim to collect the absolute minimum amount of information required to provide our Service.</p>
                
                <h3>2. Data We Collect</h3>
                <ul>
                    <li><b>Authentication Data:</b> When you login via Google, we receive your email address and UID to synchronize your preferences. We do not see your password.</li>
                    <li><b>Usage Data:</b> We store your generated history, favorite tags, and preferences ("liked" or "disliked" categories) locally on your device and encrypted in our database to provide the Service.</li>
                    <li><b>Local Storage:</b> We use browser local storage to save your settings (theme, language, platform preference) without cookies.</li>
                </ul>

                <h3>3. How We Use Data</h3>
                <p>Your data is used solely to:</p>
                <ul>
                    <li>Synchronize your progress across devices.</li>
                    <li>Verify your subscription status.</li>
                    <li>Train the personalization algorithm to improve suggestions.</li>
                </ul>
                <p><b>We do not sell, trade, or rent your personal identification information to others.</b></p>

                <h3>4. Data Deletion</h3>
                <p>You may request full deletion of your account and data at any time by contacting support or using the "Reset Data" button within the app (for local data).</p>
            `,

            refund_text: `
                <h3>1. Digital Goods Policy</h3>
                <p>Due to the nature of digital content, all sales of activation codes and subscriptions for xFetishHub are generally <b>final and non-refundable</b> once the code has been delivered or the subscription activated.</p>
                
                <h3>2. Exceptions</h3>
                <p>We may offer a refund or replacement at our sole discretion under the following circumstances:</p>
                <ul>
                    <li><b>Technical Error:</b> The activation code provided was invalid or defective.</li>
                    <li><b>Non-Delivery:</b> You paid but did not receive the service/code within 24 hours.</li>
                    <li><b>Double Billing:</b> You were charged twice for the same billing period due to a technical glitch.</li>
                </ul>

                <h3>3. How to Request</h3>
                <p>To request a refund, please contact support via the "Report Issue" button or email. Include your transaction ID and the date of purchase. Requests must be made within 14 days of purchase.</p>
            `
        },

        ru: {
            // --- 1. Общее и Навигация ---
            subtitle: "Твой дом для взрослых предпочтений",
            lang_label: "Язык",
            nav_home: "Главная",
            nav_settings: "Настройки",
            nav_account: "Аккаунт",
            header_prefs: "Предпочтения",
            header_filters: "Фильтры",
            mode_label: "Режим",
            ori_label: "Ориентация",
            ori_hetero: "Гетеро",
            ori_gay: "Гей",
            ori_trans: "Транс",
            ori_pan: "Пансексуал",
            header_extras: "Дополнительно",
            header_community: "Сообщество",
            header_features: "Возможности",
            header_legal: "Юридическое",
            theme_label: "Оформление",
            theme_title: "Выбор темы",
            theme_basic: "Базовые",
            theme_premium: "Премиум цвета",
            btn_start: "Поехали",
            btn_pass: "Другое",
            btn_like: "Похожее",
            btn_upgrade_short: "Улучш... ⇧",
            btn_return: "Вернуться",
            watch_later: "Смотреть позже",
            empty_wl: "Список пуст",
            sync_label: "Синхр: ",
            expl_undo: "Передумал? 😏",
            expl_hist: "Из архивов 📜",
            deco_label: "Показывать декор",

            mod_add_custom: "Вписать своё",
            mod_input_ph: "напр. Рыжие, Чулки...",
            mod_add_btn: "Добавить",

            cat_tips_tech: "Техническое и Функции",
            cat_tips_info: "Инфо и 18+ Знания",

            tip_sites_title: "Гид по сайтам 2026",
            tip_sites_desc: "Плюсы, минусы и кого выбрать",
            tip_sites_text: `
                <b>xVideos</b> — Народный выбор.<br>
                ✅ <b>Плюсы:</b> Самая большая библиотека, грузится мгновенно даже с плохим интернетом, много любительского и нишевого контента.<br>
                ❌ <b>Минусы:</b> Качество видео часто ниже среднего, много рекламы и спама.<br>
                👉 <i>Для тех, кто ищет максимальное разнообразие и редкости.</i><br><br>

                <b>Pornhub</b> — Премиум опыт.<br>
                ✅ <b>Плюсы:</b> Лучший интерфейс, отличные рекомендации, верифицированные модели, много 4K.<br>
                ❌ <b>Минусы:</b> Блокировки в США (нужен VPN), агрессивная реклама Premium.<br>
                👉 <i>Для ценителей удобства, качества и живого сообщества.</i><br><br>

                <b>xHamster</b> — Любительский рай.<br>
                ✅ <b>Плюсы:</b> Чистый дизайн, фокус на реальных любительских видео, фото и камерах. Меньше цензуры.<br>
                ❌ <b>Минусы:</b> Чуть меньше профессиональных студийных роликов.<br>
                👉 <i>Для фанатов "реального" секса и VR.</i><br><br>

                <b>SpankBang</b> — Выбор гурманов.<br>
                ✅ <b>Плюсы:</b> Много HD/4K бесплатно, отличные алгоритмы "похожего", пользовательские плейлисты.<br>
                ❌ <b>Минусы:</b> Часто встречаются дубликаты, меньше категорий.<br>
                👉 <i>Если нужно хорошее качество бесплатно.</i><br><br>

                <b>YouPorn / RedTube</b> — Классика.<br>
                ✅ <b>Плюсы:</b> Стабильное качество, простой интерфейс (часть сети Pornhub).<br>
                ❌ <b>Минусы:</b> Меньше уникального контента, по сути "младшие братья" PH.<br>
                👉 <i>Простая альтернатива без лишних наворотов.</i>
            `,

            // 1. АЛГОРИТМ
            tip_algo_title: "Как работает умная лента",
            tip_algo_desc: "Секреты обучения xFetishHub",
            tip_algo_text: `
                xFetishHub — это не просто рандомайзер. Это нейросеть твоего возбуждения.<br><br>
                <b>👍 Свайп вправо (Лайк):</b><br>
                Ты говоришь системе: "Хочу больше такого". Мы запоминаем теги этого видео (например, <i>Milf, Stockings</i>) и повышаем их вес. В следующий раз они выпадут с большей вероятностью.<br><br>
                <b>👎 Свайп влево (Дизлайк):</b><br>
                Ты говоришь: "Убери это". Вес тегов снижается. Если ты часто дизлайкаешь <i>BDSM</i>, система перестанет его предлагать.<br><br>
                <b>💡 Совет:</b><br>
                Не бойся дизлайкать то, что тебе не по душе. Чем честнее ты свайпаешь, тем точнее становятся рекомендации в режиме <b>"Наслаждение"</b>.
            `,

            // 2. СЛОВАРЬ
            tip_dict_title: "Словарь терминов",
            tip_dict_desc: "POV, PMV, JOI и другие",
            tip_dict_text: `
                Часто встречаешь непонятные аббревиатуры? Вот расшифровка самых популярных:<br><br>
                <b>POV (Point Of View):</b> Съемка от первого лица. Ты видишь всё глазами актера.<br>
                <b>PMV (Porn Music Video):</b> Нарезка кадров под музыку. Эстетично и ритмично.<br>
                <b>JOI (Jerk Off Instruction):</b> Инструкции для мастурбации. Модель говорит тебе, что и как делать.<br>
                <b>BBW (Big Beautiful Woman):</b> Пышные дамы. Больше, чем просто "толстушка".<br>
                <b>PAWG (Phat Ass White Girl):</b> Белая девушка с очень большой попой.<br>
                <b>SPH (Small Penis Humiliation):</b> Унижение маленького члена. Популярный фетиш.<br>
                <b>CBT (Cock and Ball Torture):</b> Пытки гениталий. Жесткий фетиш для любителей боли.<br>
                <b>Creampie:</b> Финал внутрь. Классика.
            `,

            // 3. ПСИХОТИПЫ
            tip_psycho_title: "Все Психотипы",
            tip_psycho_desc: "Какие статусы можно получить",
            tip_psycho_text: `
                В конце недели ты получаешь <b>Fetish Wrapped</b>, где тебе присваивается психотип на основе твоих действий. Вот самые редкие из них:<br><br>
                👑 <b>The Dark Lord (Тёмный Лорд):</b><br>Любишь БДСМ, унижение и Табу. Ты исследуешь самые темные уголки.<br><br>
                🎭 <b>The Performer (Артист):</b><br>Часто смотришь Public (на улице) и Ролевые игры. Жизнь для тебя — сцена.<br><br>
                🕯️ <b>The Idolater (Идолопоклонник):</b><br>Фокус на частях тела (ноги, руки) и одежде (чулки, латекс). Ты ценишь детали.<br><br>
                🧠 <b>The Manipulator (Манипулятор):</b><br>Психологическое доминирование, JOI, гипноз. Тебя возбуждают игры разума.<br><br>
                🍇 <b>The Caligula (Калигула):</b><br>Групповой секс + БДСМ. Хаос и наслаждение переплетены.<br><br>
                🍦 <b>The Classic (Классик):</b><br>Ваниль, романтика, традиционный секс. Простота — залог успеха.
            `,

            tip_pwa_title: "Преврати сайт в Приложение",
            tip_pwa_desc: "Полный экран, Встроенный браузер и Вечная память",
            tip_pwa_text: `
                Ты знал, что xFetishHub создан работать как Приложение?<br><br>
                <b>Зачем устанавливать?</b><br>
                ✅ <b>Это красиво:</b> Полный экран, никаких панелей браузера.<br>
                ✅ <b>Встроенный Приватный Браузер:</b> Когда ты жмешь 'Смотреть', видео открываются <i>внутри</i> приложения. История твоего основного Safari или Chrome остается чистой!<br>
                ✅ <b>Вечная память:</b> Браузеры часто удаляют данные через 7 дней. Приложение хранит твою историю и настройки вечно.<br><br>
                <b>Как установить:</b><br>
                🍎 <b>iOS (Safari):</b> Нажми 'Поделиться' (квадрат со стрелкой) → Прокрути вниз → 'На экран Домой'.<br>
                🤖 <b>Android (Chrome):</b> Нажми Меню (3 точки) → 'Установить приложение' или 'На гл. экран'.
            `,

            tip_mods_title: "Сила Модификаторов",
            tip_mods_desc: "Как уточнить поиск",
            tip_mods_text: `
                Кнопка <b>+</b> под карточкой — твой лучший друг.<br><br>
                <b>Как это работает:</b><br>
                Модификаторы накладываются <i>поверх</i> выпавшего жанра. Это дополнительный фильтр.<br><br>
                <b>Пример:</b><br>
                1. Тебе выпал "Анал".<br>
                2. Ты добавляешь модификатор "POV".<br>
                3. Итог: Приложение ищет <b>"Анал + POV"</b>.<br><br>
                <b>Pro Совет:</b><br>
                Теперь ты можешь добавлять <b>Свои Модификаторы</b>! Хочешь "Рыжих"? Или "Латекс"? Просто впиши это в меню модификаторов, и фильтр применится к каждому поиску.
            `,

            pt_title: "Ты знал?",
            pt_desc: "Если хочешь узнать как полностью отключить рекламу в видео или не спалиться в нужный момент, то прочитай здешнюю Базу знаний, точно не разочаруешься 🌚",
            pt_btn_go: "Открыть Базу Знаний",

            theme_preview_mode: "Предпросмотр",
            btn_unlock_theme: "Разблокировать тему 🔒",
            theme_tap_cancel: "Нажми куда угодно для отмены",

            site_random: "Случайный",

            btn_version: "Версия",
            changelog_title: "История версий",

            limit_title: "Лимит исчерпан",
            limit_desc_fun: "На сегодня хватит, дружище. Возвращайся завтра, либо присоединяйся к Pro, и смотри хоть до посинения 😏",
            
            act_time: "Время",

            unlocked_on: "Получено:",
            explored_subtitle: "Вот тебе ачивки, которые нужно получить для достижения «Платины» 😈",
            cat_general: "База",
            cat_solo: "Соло и Руки",
            cat_anal: "Анал и Попа",
            cat_breasts: "Грудь и Молоко",
            cat_oral: "Оральный секс",
            cat_hardcore: "Хардкор и БДСМ",
            cat_lgbt: "ЛГБТ+",
            cat_group: "Групповое",
            cat_feet: "Ноги и Фут-фетиш",
            cat_roleplay: "Ролевые и Костюмы",
            cat_public: "Публичное и Табу",
            cat_body: "Тело и Внешность",
            cat_toys: "Игрушки",
            cat_mess: "Жидкости и Грязь",
            cat_fantasy: "Фантазия и Арт",
            cat_clothing: "Одежда и Латекс",

            panic_active_phrases: ["Ничего подозрительного 😇", "Просто хобби", "Сама невинность", "Минутка продуктивности 📈", "Пейте воду 💧"],

            val_safe: "Безопасно",
            val_spicy: "Горячо 🔥",
            val_extreme: "ЭКСТРИМ 💀",

            share_caption: "Узнай себя",

            mode_greeting_hint: [
                "Поиск 🔭, Любимое 🥰 или Желание ✨?",
                "Доверься случаю 🔭, опыту 🥰 или Магии ✨?",
                "Что-то новое 🔭, знакомое 🥰 или конкретная фантазия ✨?",
                "Рискнем 🔭, повторим 🥰 или загадаешь сам ✨?"
            ],
            mode_greeting_dynamic: [
                "Настроен на<br><b>{fav}</b> 🥰<br>или может посмотрим что-то новое, например<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Либо пиши что конкретно ✨, не разочарую 😏</span>",
                "Вернемся к<br><b>{fav}</b> 🥰<br>или рискнем с<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Можешь просто описать фантазию ✨</span>",
                "Соскучился по<br><b>{fav}</b> 🥰?<br>Или изучим жанр<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>А лучше спроси меня, я найду ✨</span>"
            ],

            mode_explore: "Исследование",
            mode_pleasure: "Наслаждение",
            mode_ai: "ИИ Агент",

            info_header: "Информация",
            hist_tab_swipes: "Свайпы",
            hist_tab_watch: "Время",
            hist_empty_watch: "Данных о просмотрах нет. Иди глянь что-нибудь! 😏",
            hist_watched: "ПРОСМОТРЕНО",

            status_wl: "Смотреть позже",
            status_fav: "В Избранном",
            status_ban: "Не нравится",

            stats_no_data: "Пока нет данных",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Сделай ещё {n} действий, чтобы открыть личную сводку",

            "theme_pink-dark": "Кибер",
            "theme_pink-light": "Сакура",
            "theme_purple-dark": "Аметист",
            "theme_purple-light": "Лаванда",
            "theme_orange-dark": "Магма",
            "theme_orange-light": "Персик",
            "theme_old-money": "Old Money",

            plan_bestie_sub: "Навсегда",
            plan_bestie_price: "/ разово",
            badge_limited: "ОГРАНИЧЕНО",
            limit_burn: "🔥 СКОРО РАЗБЕРУТ",
            limit_claimed: "забрали",
            feat_lifetime: "♾️ <b>Доступ навсегда</b>",
            feat_onetime: "💸 Разовый платёж",
            btn_get_bestie: "Купить навсегда",

            // --- Sponsors ---
            btn_early_sponsors: "Ранние спонсоры",
            sponsors_title: "Зал Славы",
            sponsors_desc: "Эти легенды поддержали xFetishHub в самом начале, купив тариф Bestie. Бесконечно благодарен! 💙",

            return_phrases: [
                "Целых {t}. Ты действовал наверняка 😏",
                "С возвращением спустя {t}. Понравилось? 🔥",
                "{t}... Неплохой марафон! 😅",
                "Тебя не было {t}. Надеюсь, оно того стоило.",
                "Ого, {t}! Кажется, это был отличный выбор."
            ],
            return_phrase_short: "Всего {t}? Быстро ты... ⚡",

            reset_phrases: [
                "Порой всем нужен отдых 🧘",
                "Давай начнём сначала...",
                "Перезагрузка системы 🔄",
                "Тишина и спокойствие...",
                "Чистый лист ✨"
            ],

            auth_title: "Синхронизация",
            auth_p1: "Хранение истории и предпочтений на всех устройствах",
            auth_p2: "Активация Pro / Beast статуса",
            auth_p3: "Анонимное хранение на серверах Google",
            btn_google_signin: "Войти через Google",
            auth_security_note: "Разработчик не имеет доступа к данным. Но если боишься, то можешь использовать второй аккаунт. 😏",
            btn_cancel: "Отмена",

            pay_header: "Оплата USDT (TRC20)",
            pay_instruction: "Отправьте <b>ТОЧНУЮ сумму</b> (вплоть до копеек) через сеть <b>Tron (TRC20)</b>.",
            pay_fee_warn: "⚠️ Комиссия сети НЕ включена. Не отправляйте с биржи, если комиссия вычитается из суммы!",
            pay_sum_label: "Сумма:",
            pay_copy_addr: "Нажми, чтобы скопировать",
            pay_how_to: "Нет крипты? Как оплатить?",
            pay_waiting: "Ожидаем оплату...",
            pay_success_title: "Оплата прошла!",
            pay_success_desc: "Подписка активирована.",
            pay_reload: "Обновить страницу",
            guide_title: "Как оплатить криптой",
            guide_warning: "Важно: При отправке выбирайте сеть <b>TRON (TRC20)</b>.",
            btn_back: "Назад к оплате",

            pay_problem_link: "Не засчитался платёж?",
            pay_problem_title: "Где моя подписка?",
            pay_prob_desc: "Если вы отправили деньги, но статус не изменился в течение 10 минут, вот частые причины:",
            pay_prob_reason_1: "<b>Неверная сумма:</b> Отправлено чуть меньше или больше требуемого.",
            pay_prob_reason_2: "<b>Комиссия:</b> Биржа вычла комиссию из суммы перевода.",
            pay_prob_reason_3: "<b>Не та сеть:</b> Выбрали BEP20 или ERC20 вместо TRC20.",
            pay_prob_solution: "Не волнуйтесь! Деньги не пропали. Пришлите нам <b>TxID (Хеш транзакции)</b> в поддержку, и мы активируем вручную.",
            btn_contact_support: "Написать в поддержку",

            guide_step_1: "<b>1. Telegram Wallet:</b><br>Откройте <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Купите USDT через P2P (с карты). Нажмите «Отправить» → «Внешний кошелек» → вставьте адрес.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Скачайте приложение. Купите USDT (TRC20) с карты. Отправьте на наш адрес.",

            info_header: "Информация",
            lbl_support_email: "Почта поддержки",
            doc_terms: "Польз. соглашение",
            doc_privacy: "Политика конф-ти",
            doc_refund: "Политика возвратов",

            btn_roadmap: "Дорожная карта",
            roadmap_title: "Планы развития",
            roadmap_desc: "Благодаря твоей поддержке и подпискам, проект будет развиваться. Вот что мы планируем добавить:",
            rm_global_title: "Глобальный Разум",
            rm_global_desc: "Улучшение рекомендаций на основе анонимной статистики всех пользователей. Топы самых любимых и ненавистных жанров мира.",
            rm_coop_title: "Совместный режим",
            rm_coop_desc: "Пригласи партнера по ссылке. Он будет видеть твои результаты в реальном времени. Идеально для пар на расстоянии.",
            rm_content_title: "5000+ Категорий",
            rm_content_desc: "Масштабное расширение базы. Каждый микро-фетиш и нишевый жанр будет добавлен в поиск.",
            rm_actors_title: "Поиск Актёров",
            rm_actors_desc: "Отдельный режим для подбора порнозвезд и моделей на основе твоих визуальных предпочтений.",
            rm_support_btn: "Поддержать развитие 🚀",

            ai_prompt: [
                "Что хочешь посмотреть сегодня? 😏",
                "Опиши свою фантазию...",
                "Какое настроение?",
                "Расскажи, что тебя заводит прямо сейчас?"
            ],
            ai_placeholder: [
                "напр. большая грудь, без анала...",
                "Хочу что-то страстное...",
                "Удиви меня рыжими...",
                "Жестко, на улице, может быть плевки..."
            ],
            ai_thinking: "Анализирую...",
            ai_btn_go: "Найти",
            ai_phrases_success: [
                "Как ты и просил:",
                "Нашел специально для тебя.",
                "Твой запрос услышан.",
                "Это идеально подходит под описание.",
                "Думаю, это то, что нужно.",
                "Из недр базы — прямо тебе."
            ],
            ai_phrases_fail: [
                "Сложный запрос. Но давай попробуем это:",
                "Точного совпадения нет, но это тебе зайдет:",
                "Я в замешательстве, но вот отличный вариант:",
                "Не совсем понял, поэтому держи проверенное:",
                "В базе такого нет, но как насчет этого?"
            ],

            panic_btn: "Экстренный режим",
            panic_title: "Экстренный режим",
            panic_desc: "Скрытый режим для быстрой маскировки контента. Активируется <b>Двойным тапом</b> по экрану или <b>Двойным ESC</b>.",
            panic_enable: "Включить триггер",
            
            // Safe Mode UI
            safe_subtitle: "Твой дом для любимых хобби",
            safe_btn_start: "Начать",
            safe_status: "Время расслабиться 😌",
            
            // Settings Masquerade
            safe_label_site: "Время",
            safe_label_ori: "Место",
            safe_label_int: "Сложность",
            safe_opt_morn: "Утро", safe_opt_day: "День", safe_opt_eve: "Вечер",
            safe_opt_home: "Дом", safe_opt_work: "Работа", safe_opt_park: "Парк",

            // Post-Panic Phrases
            post_panic_phrases: ["Надеюсь, не спалился 😁", "Пронесло...", "Фух, вроде чисто 😮‍💨", "Возвращаемся к делу 😏"],

            vpn_title: "Предупреждение",
            vpn_text_1: "Должен предупредить: ты переходишь на 18+ сайт, где сам понимаешь какой контент, к тому же есть реклама. Это на всякий случай 😊.",
            vpn_text_pwa: "И если у тебя вдруг не запускается видео, то попробуй перезапустить его, либо на крайний случай открой его в браузере.",
            vpn_text_2: "И про ВПН не забудь! Приятного просмотра 😏",
            vpn_btn: "Пошли",

            tips_btn: "Полезности",
            tips_title: "База знаний",
            tips_guru_title: "Стань гуру просмотра 😈",
            btn_got_it: "Понятно",

            tip_ads_title: "Как убрать рекламу",
            tip_ads_desc: "Секрет чистого просмотра в приложении",
            tip_ads_text: "В самом xFetishHub рекламы НЕТ. Но при переходе на сайты 18+ она появится — это неизбежно.<br><br><b>Лайфхак для Приложения (PWA):</b><br>Если ты смотришь через установленное приложение:<br>1. Скачай Ад-блокер (например, AdGuard) для Safari или Chrome.<br>2. Включи его в настройках браузера.<br>3. Он автоматически заработает внутри приложения xFetishHub!",

            tip_video_title: "Не грузит видео?",
            tip_video_desc: "Черный экран или ошибки",
            tip_video_text: "Из-за особенностей технологии PWA (веб-приложение), на некоторых устройствах плееры сторонних сайтов могут не запускаться с первого раза.<br><br><b>Решение:</b><br>1. Попробуй перезагрузить страницу.<br>2. Если не помогает — открой сайт в обычном браузере, а не в приложении.",

            tip_pay_title: "Как оплатить?",
            tip_pay_desc: "Почему крипта и как ей платить",
            tip_pay_text: "Сейчас доступна только оплата в криптовалюте (USDT). Из-за тематики сайта (18+) трудно договориться с банками и Apple/Google Pay.<br><br><b>Ни разу не платил криптой?</b><br>1. Открой <b>@wallet</b> в Telegram.<br>2. Купи USDT через P2P (с карты).<br>3. Нажми Отправить -> Внешний кошелек -> Вставь наш адрес (сеть TRC20).",

            tip_bug_title: "Сообщить о проблеме",
            tip_bug_desc: "Помоги улучшить проект",
            tip_bug_text: "Сайт создан недавно одним человеком, поэтому ошибки неизбежны. Твоя помощь очень важна!<br><br>Зайди в блок <b>«Дополнительно»</b> -> <b>«Сообщить о проблеме»</b>.<br>Опиши, что именно не так. Я реагирую на отзывы и исправляю баги максимально быстро.",

            tip_panic_title: "Как не спалиться",
            tip_panic_desc: "Секретный режим",
            tip_panic_text: "На сайте есть режим паники. Активируй его <b>двумя тапами</b> по экрану (или клавишами на ПК).<br><br>Он включает нейтральный интерфейс, где не видно ничего, что может поставить в неловкое положение.<br>Выйти можно нажатием на кнопку действия или тем же способом, как вошли.",

            tip_layout_title: "Перекрывающиеся фразы",
            tip_layout_desc: "Исправление верстки",
            tip_layout_text: "Из-за особенностей PWA иногда карточка на мобильных может уходить слишком вверх, и фразы перекрываются капсулой с логотипом.<br><br><b>Решение:</b><br>Смени ориентацию телефона на <b>горизонтальную</b> и верни её в <b>вертикальную</b>. Проблема решится, и всё встанет на места.",

            tip_int_title: "Уровни Откровенности",
            tip_int_desc: "Что именно меняется?",
            tip_int_text: `
                <b>🛡️ БЕЗОПАСНО (Ур. 1):</b><br>
                Ваниль, романтика и классика. Полностью блокирует БДСМ, фетиши и любую грубость. Максимально "чистый" контент.<br><br>
                <b>🔥 ГОРЯЧО (Ур. 2):</b><br>
                Открывает <b>БДСМ и Кинки</b>. Добавляет связывание, порку, доминирование и фетиши. Но всё ещё блокирует "грязь" и боль.<br><br>
                <b>💀 ЭКСТРИМ (Ур. 3):</b><br>
                Открывает <b>Хардкор и Треш</b>. Добавляет то, что было скрыто: туалетную тему, фистинг, боль и жидкости. Без фильтров.
            `,

            tip_modes_title: "Режимы Игры",
            tip_modes_desc: "Исследование vs Наслаждение",
            tip_modes_text: `
                <b>🔭 Исследование (Explore):</b><br>
                Баланс случайности. Учитывает историю, но приоритет отдается поиску новых жанров. Идеально, когда не знаешь, чего хочешь.<br><br>
                <b>🥰 Наслаждение (Pleasure):</b><br>
                Строго следует твоим вкусам. Часто предлагает то, что содержит твои любимые теги. Минимум экспериментов, максимум гарантии.<br><br>
                <b>🤖 ИИ Агент (AI):</b><br>
                Включается при текстовом или голосовом поиске. Понимает контекст («пожестче», «что-то новое») и ищет конкретные сценарии.
            `,

            // --- 2. Генератор ---
            generate: "Случайный жанр",
            generate_again: "Другой жанр",
            btn_similar: "Похожий",
            watch: "Смотреть",
            search: "Найти",
            related_header: "Вам также может понравиться:",
            mod_manage: "Настроить модификаторы",
            mod_title: "Модификаторы",
            mod_active_sec: "Активные (В карточке)",
            mod_inactive_sec: "Неактивные (Скрыты)",
            mod_limit_reached: "Лимит достигнут (Макс 10)!",
            add_genre: "Добавить к жанру:",
            search_en_label: "Поиск на Англ.",
            site_label: "Сайт",
            exploration_mode: "Откровенность",

            // --- 3. Подписка (Premium) ---
            sub_title: "Премиум доступ",
            sub_intro: "xFetishHub — это единственный в своём роде проект, который помогает тебе узнать и проанализировать твои взрослые предпочтения в одном уютном месте без рекламы. Если оплатишь подписку, то проект и дальше сможет существовать, а взамен я тебе дам ощутимо больше возможностей:",
            
            // Планы
            feat_limit: "🎲 50 Генераций / день",
            feat_stats_basic: "📊 Базовая статистика",
            feat_filters: "✔️ Стандартные фильтры",
            btn_current: "Текущий план",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / неделю",
            feat_wrapped_unlim: "✨ <b>Безлимитный</b> Wrapped",

            lbl_subscription: "Подписка",
            limit_text_full: "🎲 50 Генераций / день (осталось: {n}/50)",

            feat_unlim: "🔥 Безлимитные генерации",
            feat_stats_adv: "📈 Расширенные сводки",
            feat_custom: "🎨 Кастомизация",
            feat_early: "🚀 Ранний доступ к функциям",
            btn_get_pro: "Купить Pro",

            feat_all_pro: "👑 Всё, что есть в Pro",
            feat_all_beast: "🦁 <b>Всё, что есть в Beast</b>",
            feat_sponsors: "💎 Имя во вкладке Спонсоры",
            feat_discord: "💬 Discord с разработчиком",
            feat_vote: "🗳️ Влияние на развитие",
            btn_get_beast: "Стать Зверем",

            bill_monthly: "Ежемесячно",
            bill_yearly: "Ежегодно",

            btn_lower_tier: "Ты достоен большего",
            pay_desc: "Выбери способ оплаты. Ты получишь код активации мгновенно после оплаты.",
            pay_stars: "Telegram Stars",
            pay_card: "Карта (Весь мир)",
            pay_crypto: "Крипта (Анонимно)",
            pay_boosty: "Boosty (Карты РФ)",
            pay_code_label: "Если оплатил, введи код сюда:",
            pay_code_placeholder: "Код активации...",

            lbl_current_plan: "Текущий план",
            login_alert: "Пожалуйста, войди в аккаунт для управления подпиской!",

            // --- 4. Аккаунт и Данные ---
            login_text: "Вход / Синхронизация",
            personal_account: "Личный кабинет",

            "theme_blue-dark": "Полночь",
            "theme_green-dark": "Лес",
            "theme_red-dark": "Вампир",
            "theme_gold-dark": "Роскошь",
            "theme_noir": "Нуар",
            "theme_blue-light": "Небо",
            "theme_green-light": "Мята",
            "theme_red-light": "Роза",
            "theme_gold-light": "Песок",
            "theme_dark": "Тёмная",
            "theme_light": "Светлая",

            history_title: "История",


            logout_text: "Выйти",
            login_required: "Пожалуйста, войди в аккаунт, чтобы мы могли активировать подписку!",
            sync_success: "Данные синхронизированы!",

            btn_open_stats: "Статистика",

            btn_reset: "Сброс данных",
            confirm_reset: "Вы уверены? Это удалит историю, статистику и обучение алгоритма. Это действие нельзя отменить.",
            reset_done: "Данные сброшены.",

            explored_label: "Открыто",
            explored_txt: "{n} из {t} категорий",
            report_issue: "Сообщить о проблеме",

            sync_title: "Облачное хранилище",
            sync_desc: "Данные безопасно хранятся на серверах Google",
            sync_tip: "Нажми «Синхронизировать» для объединения. <b>Страница перезагрузится.</b>",
            sync_btn_success: "✅ Готово! Перезагрузка...",
            btn_sync: "🔄 Синхронизировать",
            sub_exp: "ист:",
            sub_expired: "Истекла",
            time_d: "д",

            // --- 5. Списки ---
            favorites_catalog: "Понравившиеся",
            blacklist_catalog: "Не понравившиеся",
            btn_fav_add: "В Избранное",
            btn_fav_remove: "В Избранном",
            btn_ban_add: "В ЧС",
            btn_ban_remove: "Убрать из ЧС",
            empty: "Пусто (Проверь фильтры)!",

            // --- 6. Фильтры ---
            filter_include: "Включить",
            filter_exclude: "Исключить",
            tag_fav: "Избранное",
            tag_straight: "Гетеро", 
            tag_gay: "Гей", 
            tag_lesbian: "Лесби", 
            tag_trans: "Транс",

            // --- 7. Статистика ---
            btn_stats: "Статистика",
            stats_header: "Твои любимые категории",
            stats_prefs: "Предпочтения",
            stats_activity: "Активность",
            
            tf_week: "Неделя", 
            tf_month: "Месяц", 
            tf_year: "Год", 
            tf_all: "Всё время",
            
            act_gen: "Генераций", 
            act_watch: "Просмотров",
            chart_prefs_x: "Предпочтения",
            chart_points_y: "Очки",
            chart_count_y: "Кол-во",
            share_btn: "Поделиться",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Приходи сюда снова через неделю. Либо если хочешь статистику каждый день, то Pro подписка будет твоим лучшим другом.",
            btn_close: "Закрыть",
            search_liked: "Поиск любимых...",
            search_disliked: "Поиск нелюбимых...",
            hist_empty: "История пуста",
            limit_reset: "Сброс:",

            legend_watch: "Просмотр (+10)",
            legend_like: "Лайк / Похожее (+5)",
            legend_dislike: "Другое / Дизлайк (-10)",
            act_actions: "Свайпы",
            act_watches: "Просмотры",

            // --- 8. Объяснения ---
            expl_fav: "Потому что ты любишь: ",
            expl_sim: "Похоже на прошлое",
            expl_rand: "Судьба",
            expl_score: "Потому что тебе зашло: ",
            expl_tag_click: "Выбрана категория: ",

            // --- 9. Бейджи ---
            badge_extreme: "Экстрим",
            badge_desc_extreme: "⚠️ <b>Высокая интенсивность</b><br>Категория содержит жесткие или специфические практики. Не для любителей 'ванильного' контента.",
            
            badge_lgbt: "ЛГБТ",
            badge_desc_lgbt: "🏳️‍🌈 <b>ЛГБТ+ Контент</b><br>Включает однополые отношения (Гей/Лесби) или Транс-тематику.",
            
            badge_niche: "Нишевое",
            badge_desc_niche: "🔍 <b>Специфичный фетиш</b><br>Узконаправленный интерес, фокусирующийся на определенных частях тела, предметах или сценариях.",
            
            badge_bdsm: "БДСМ",
            badge_desc_bdsm: "⛓️ <b>БДСМ и Фетиш</b><br>Связывание, доминирование, подчинение и игры с ощущениями.",

            // --- 10. Модальные окна ---
            age_title: "Проверка возраста",
            age_desc: "Этот сайт содержит материалы для взрослых. Вам уже исполнилось 18 лет?",
            age_yes: "Да, мне 18+",
            age_no: "Нет, выйти",
            age_block_msg: "Этот сайт предназначен только для пользователей старше 18 лет.",

        
            install_title: "Установить приложение",
            install_desc: "Установи приложение для полного экрана. Плюс, смотри видео во встроенном браузере, чтобы не засорять историю основного браузера!",
            install_continue: "Продолжить в браузере",

            btn_install_phone: "Установить на телефон",
            qr_title: "Сканируй для установки",
            qr_desc: "Наведи камеру телефона на QR-код, чтобы открыть сайт, затем следуй инструкции:",
            
            inst_ios_1: "Нажми кнопку <b>Поделиться</b>",
            inst_ios_2: "Пролистай вниз и выбери",
            inst_ios_btn: "На экран «Домой»",
            inst_ios_3: "Нажми <b>Добавить</b>.",
            
            inst_and_1: "Нажми <b>Меню</b> (3 точки)",
            inst_and_2: "Выбери",
            inst_and_btn: "Установить / Добавить на экран",


            onb_title: "Быстрая настройка",
            onb_desc: "Напиши, что тебе нравится или не нравится, чтобы мы сразу могли приступить к тому, что ты любишь 😈.",
            onb_placeholder: "Например: люблю минет и анал, но ненавижу фут-фетиш и улицу...",
            onb_btn_check: "Найти категории",
            onb_found: "Мы нашли:",
            onb_btn_confirm: "Добавить в избранное",
            onb_skip: "Пропустить",

            lbl_about: "О проекте",
            
            terms_text: `
                <h3>1. Принятие условий</h3>
                <p>Используя сервис xFetishHub, вы подтверждаете, что вам исполнилось 18 лет (или больше, в зависимости от законов вашей страны), и вы соглашаетесь с данными условиями. Если вы не согласны, пожалуйста, покиньте сайт.</p>
                
                <h3>2. Суть сервиса</h3>
                <p>xFetishHub является поисковым агрегатором и системой рекомендаций. <b>Мы не храним, не загружаем и не контролируем видеоконтент.</b> Все ссылки ведут на сторонние ресурсы (xHamster, Pornhub и др.). Мы лишь помогаем найти контент, который и так доступен в публичном доступе.</p>
                
                <h3>3. Сторонние ресурсы</h3>
                <p>Мы не несем ответственности за содержание, политику конфиденциальности или действия сторонних сайтов. Переходя по ссылкам, вы действуете на свой страх и риск. Мы не отвечаем за любой ущерб, связанный с использованием внешних ресурсов.</p>
                
                <h3>4. Аккаунты и Подписки</h3>
                <p>Некоторые функции доступны по подписке ("Pro" или "Beast"). Обработка платежей производится сторонними шлюзами (Lava, Cryptomus и др.). Мы не храним данные ваших карт. Мы оставляем за собой право блокировать аккаунты при нарушении правил.</p>
                
                <h3>5. Отказ от ответственности</h3>
                <p>Сервис предоставляется по принципу "КАК ЕСТЬ". Мы не гарантируем, что результаты поиска будут всегда соответствовать вашим ожиданиям или работать без сбоев.</p>
            `,

            privacy_text: `
                <h3>1. Введение</h3>
                <p>Конфиденциальность — наш приоритет. Мы собираем абсолютный минимум данных, необходимый для работы синхронизации.</p>
                
                <h3>2. Сбор данных</h3>
                <ul>
                    <li><b>Авторизация:</b> При входе через Google мы получаем ваш Email и UID для привязки настроек. Мы не видим ваш пароль.</li>
                    <li><b>Данные использования:</b> Мы храним историю генераций, лайки, дизлайки и веса тегов. Это нужно исключительно для работы алгоритма рекомендаций.</li>
                    <li><b>Локальное хранилище:</b> Мы используем LocalStorage браузера для сохранения темы и языка.</li>
                </ul>

                <h3>3. Использование данных</h3>
                <p>Ваши данные используются только для:</p>
                <ul>
                    <li>Синхронизации прогресса между устройствами.</li>
                    <li>Проверки статуса подписки.</li>
                    <li>Обучения алгоритма под ваши вкусы.</li>
                </ul>
                <p><b>Мы не продаем и не передаем ваши данные третьим лицам.</b></p>

                <h3>4. Удаление данных</h3>
                <p>Вы можете в любой момент сбросить данные в приложении ("Сброс данных") или написать в поддержку для полного удаления аккаунта с серверов.</p>
            `,

            refund_text: `
                <h3>1. Политика цифровых товаров</h3>
                <p>В связи с природой цифрового контента, все продажи кодов активации и подписок являются <b>окончательными и не подлежат возврату</b> после доставки кода или активации услуги.</p>
                
                <h3>2. Исключения</h3>
                <p>Мы можем рассмотреть возврат в индивидуальном порядке в следующих случаях:</p>
                <ul>
                    <li><b>Техническая ошибка:</b> Выданный код оказался нерабочим.</li>
                    <li><b>Недоставка:</b> Вы оплатили, но услуга не была предоставлена в течение 24 часов.</li>
                    <li><b>Двойное списание:</b> Из-за сбоя оплата прошла дважды.</li>
                </ul>

                <h3>3. Запрос возврата</h3>
                <p>Для запроса свяжитесь с поддержкой через кнопку "Сообщить о проблеме" или по Email. Укажите ID транзакции. Запросы принимаются в течение 14 дней с момента покупки.</p>
            `
        },

        es: {
            // --- General ---
            subtitle: "Tu hogar para preferencias adultas",
            lang_label: "Idioma",
            nav_home: "Inicio",
            nav_settings: "Ajustes",
            nav_account: "Cuenta",
            header_prefs: "Preferencias",
            header_filters: "Filtros",
            mode_label: "Modo",
            ori_label: "Orientación",
            ori_hetero: "Hetero",
            ori_gay: "Gay",
            ori_trans: "Trans",
            ori_pan: "Pansexual",
            header_extras: "Extras",
            header_community: "Comunidad",
            header_features: "Funciones",
            header_legal: "Legal",
            theme_label: "Apariencia",
            theme_title: "Elegir Tema",
            theme_basic: "Básico",
            theme_premium: "Colores Premium",
            btn_return: "Volver",
            watch_later: "Ver más tarde",
            empty_wl: "Lista vacía",
            sync_label: "Sinc: ",
            expl_undo: "¿Cambiaste de opinión? 😏",
            expl_hist: "De los archivos 📜",
            deco_label: "Mostrar decoración",

            mod_add_custom: "Añadir Propio",
            mod_input_ph: "ej. Pelirroja...",
            mod_add_btn: "Añadir",

            cat_tips_tech: "Técnico y Funciones",
            cat_tips_info: "Info y Conocimiento +18",

            tip_sites_title: "Guía de Sitios 2026",
            tip_sites_desc: "Pros, contras y cuál elegir",
            tip_sites_text: `
                <b>xVideos</b> — La elección popular.<br>
                ✅ <b>Pros:</b> Biblioteca enorme, carga rápido, mucho contenido amateur/nicho.<br>
                ❌ <b>Contras:</b> Menor calidad, muchos anuncios.<br>
                👉 <i>Para máxima variedad y rarezas.</i><br><br>

                <b>Pornhub</b> — Experiencia Premium.<br>
                ✅ <b>Pros:</b> Mejor interfaz, modelos verificadas, mucho 4K.<br>
                ❌ <b>Contras:</b> Bloqueado en algunos lugares, muchos anuncios Premium.<br>
                👉 <i>Para calidad y comodidad.</i><br><br>

                <b>xHamster</b> — Paraíso Amateur.<br>
                ✅ <b>Pros:</b> Diseño limpio, enfoque en amateur real y VR. Menos censura.<br>
                ❌ <b>Contras:</b> Menos contenido de estudio profesional.<br>
                👉 <i>Para fans del sexo "real".</i><br><br>

                <b>SpankBang</b> — Elección experta.<br>
                ✅ <b>Pros:</b> Mucho HD/4K gratis, grandes algoritmos, listas de usuarios.<br>
                ❌ <b>Contras:</b> Duplicados frecuentes, menos categorías.<br>
                👉 <i>Para alta calidad gratis.</i>
            `,

            tip_algo_title: "Cómo funciona el Algoritmo",
            tip_algo_desc: "Secretos de xFetishHub",
            tip_algo_text: `
                <b>👍 Deslizar Derecha (Like):</b> Aumenta el peso de las etiquetas (ej. Milf). Aparecerán más seguido.<br><br>
                <b>👎 Deslizar Izquierda (Dislike):</b> Disminuye el peso. El sistema dejará de sugerirlo.<br><br>
                <b>💡 Consejo:</b> Sé honesto con tus swipes para mejorar el modo <b>"Placer"</b>.
            `,

            tip_dict_title: "Glosario Fetiche",
            tip_dict_desc: "Qué significa POV, BBW, etc.",
            tip_dict_text: `
                <b>POV:</b> Punto de vista (primera persona).<br>
                <b>PMV:</b> Video musical porno.<br>
                <b>JOI:</b> Instrucciones de masturbación.<br>
                <b>BBW:</b> Mujeres grandes y hermosas.<br>
                <b>PAWG:</b> Chica blanca con trasero grande.<br>
                <b>CBT:</b> Tortura genital (Hardcore).
            `,

            tip_psycho_title: "Todos los Psicotipos",
            tip_psycho_desc: "Insignias desbloqueables",
            tip_psycho_text: `
                👑 <b>Señor Oscuro:</b> Amas el BDSM y Tabú.<br>
                🎭 <b>El Artista:</b> Público y Juegos de Rol.<br>
                🕯️ <b>El Idólatra:</b> Partes del cuerpo y Ropa.<br>
                🍇 <b>Calígula:</b> Orgia + Hardcore.<br>
                🍦 <b>El Clásico:</b> Vainilla y Romántico.
            `,

            tip_pwa_title: "Convertir sitio en App",
            tip_pwa_desc: "Pantalla completa, Navegador privado e Historial eterno",
            tip_pwa_text: `
                ¿Sabías que xFetishHub está diseñado para ser una App?<br><br>
                <b>¿Por qué instalar?</b><br>
                ✅ <b>Se ve genial:</b> Pantalla completa, sin barras de navegador.<br>
                ✅ <b>Navegador Privado Integrado:</b> Al hacer clic en 'Ver', los videos se abren <i>dentro</i> de la app. ¡Tu historial de Safari/Chrome permanece limpio!<br>
                ✅ <b>Memoria Eterna:</b> Los navegadores borran datos tras 7 días. La App guarda tu historial y preferencias para siempre.<br><br>
                <b>Cómo instalar:</b><br>
                🍎 <b>iOS (Safari):</b> Toca 'Compartir' (cuadrado con flecha) → Baja y selecciona → 'Añadir a Inicio'.<br>
                🤖 <b>Android (Chrome):</b> Toca Menú (3 puntos) → 'Instalar aplicación' o 'Añadir a pantalla de inicio'.
            `,

            tip_mods_title: "Poder de Modificadores",
            tip_mods_desc: "Cómo refinar tu búsqueda",
            tip_mods_text: `
                El botón <b>+</b> debajo de la tarjeta es tu mejor amigo.<br><br>
                <b>Cómo funciona:</b><br>
                Los modificadores funcionan <i>encima</i> del género generado.<br><br>
                <b>Ejemplo:</b><br>
                1. Obtienes "Anal".<br>
                2. Añades el modificador "POV".<br>
                3. Resultado: La app busca <b>"Anal + POV"</b>.<br><br>
                <b>Consejo Pro:</b><br>
                ¡Ahora puedes añadir <b>Modificadores Personalizados</b>! ¿Quieres "Pelirroja"? ¿O "Látex"? Escríbelo en el menú y se aplicará a cada búsqueda.
            `,

            pt_title: "¿Sabías qué?",
            pt_desc: "Si quieres saber cómo desactivar completamente los anuncios en videos o no ser descubierto en el momento justo, lee la Base de Conocimientos aquí, no te decepcionará 🌚",
            pt_btn_go: "Abrir Base de Conocimientos",

            theme_preview_mode: "Avance",
            btn_unlock_theme: "Desbloquear Tema 🔒",
            theme_tap_cancel: "Toca donde sea para cancelar",

            site_random: "Aleatorio",

            btn_version: "Versión",
            changelog_title: "Historial de versiones",

            limit_title: "Límite Alcanzado",
            limit_desc_fun: "Suficiente por hoy, amigo. Vuelve mañana o únete a Pro y mira hasta que te pongas azul 😏",


            act_time: "Tiempo",

            unlocked_on: "Desbloqueado:",
            explored_subtitle: "Aquí están los logros que necesitas para obtener el 'Platino' 😈",
            cat_general: "General",
            cat_solo: "Solo y Manos",
            cat_anal: "Anal y Trasero",
            cat_breasts: "Pechos y Leche",
            cat_oral: "Placer Oral",
            cat_hardcore: "Hardcore y BDSM",
            cat_lgbt: "LGBTQ+",
            cat_group: "Grupo y Social",
            cat_feet: "Pies y Piernas",
            cat_roleplay: "Juego de Rol",
            cat_public: "Público y Tabú",
            cat_body: "Cuerpo y Apariencia",
            cat_toys: "Juguetes",
            cat_mess: "Fluidos y Desorden",
            cat_fantasy: "Fantasía y Arte",
            cat_clothing: "Ropa y Fetiche",

            panic_active_phrases: ["Nada sospechoso aquí 😇", "Solo un hobby", "Pura inocencia", "Productividad 📈", "Bebe agua 💧"],

            val_safe: "Tranquilo",
            val_spicy: "Picante 🔥",
            val_extreme: "EXTREMO 💀",

            share_caption: "Descúbrete",

            mode_greeting_hint: [
                "¿Explorar 🔭, Disfrutar 🥰 o una Fantasía ✨?",
                "¿Confiar en el azar 🔭, tu historia 🥰 o la Magia ✨?",
                "¿Algo nuevo 🔭, familiar 🥰 o específico ✨?"
            ],
            mode_greeting_dynamic: [
                "¿Con ganas de<br><b>{fav}</b> 🥰<br>o tal vez algo nuevo como<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>O escribe tu deseo ✨, no te decepcionaré 😏</span>",
                "¿Volvemos a<br><b>{fav}</b> 🥰<br>o nos arriesgamos con<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>También puedes describir una fantasía ✨</span>",
                "¿Extrañas<br><b>{fav}</b> 🥰?<br>O exploremos<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>O simplemente pregúntame ✨</span>"
            ],

            mode_explore: "Explorar",
            mode_pleasure: "Placer",
            mode_ai: "Agente IA",

            info_header: "Información",
            hist_tab_swipes: "Deslizamientos",
            hist_tab_watch: "Tiempo",
            hist_empty_watch: "Aún no hay datos de visualización. ¡Ve a ver algo! 😏",
            hist_watched: "VISTO",

            status_wl: "Ver más tarde",
            status_fav: "Me gusta",
            status_ban: "No me gusta",

            stats_no_data: "Aún no hay datos",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Haz {n} movimientos más para desbloquear tu resumen",

            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amatista",
            "theme_purple-light": "Lavanda",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Melocotón",
            "theme_old-money": "Old Money",

            plan_bestie_sub: "De por vida",
            plan_bestie_price: "/ una vez",
            badge_limited: "OFERTA LIMITADA",
            limit_burn: "🔥 CASI AGOTADO",
            limit_claimed: "reclamados",
            feat_lifetime: "♾️ <b>Acceso de por vida</b>",
            feat_onetime: "💸 Pago único",
            btn_get_bestie: "Obtener para siempre",

            // --- Sponsors ---
            btn_early_sponsors: "Patrocinadores",
            sponsors_title: "Muro de la Fama",
            sponsors_desc: "Estas leyendas apoyaron xFetishHub al principio comprando el plan Bestie. ¡Eternamente agradecido! 💙",

            return_phrases: [
                "Todo un {t}. Fuiste a lo seguro 😏",
                "De vuelta tras {t}. ¿Te gustó? 🔥",
                "{t}... ¡Vaya sesión! 😅",
                "Te fuiste por {t}. Espero que valiera la pena.",
                "¡Wow, {t}! Parece una buena elección."
            ],
            return_phrase_short: "¿Solo {t}? Qué rápido... ⚡",

            reset_phrases: [
                "A veces todos necesitamos un descanso 🧘",
                "Empecemos de nuevo...",
                "Reinicio del sistema 🔄",
                "Paz y tranquilidad...",
                "Borrón y cuenta nueva ✨"
            ],

            auth_title: "Sincronización",
            auth_p1: "Historial y preferencias en todos los dispositivos",
            auth_p2: "Activar estado Pro / Beast",
            auth_p3: "Almacenamiento anónimo en servidores de Google",
            btn_google_signin: "Continuar con Google",
            auth_security_note: "El desarrollador no tiene acceso a los datos. Pero si te preocupa, puedes usar una segunda cuenta. 😏",
            btn_cancel: "Cancelar",

            pay_header: "Pago USDT (TRC20)",
            pay_instruction: "Envía la <b>cantidad exacta</b> (incluyendo decimales) vía red <b>Tron (TRC20)</b>.",
            pay_fee_warn: "⚠️ La comisión de la red NO está incluida. ¡No envíes desde un exchange si la comisión se deduce del monto!",
            pay_sum_label: "Monto a enviar:",
            pay_copy_addr: "Toca para copiar dirección",
            pay_how_to: "¿No tienes cripto? ¿Cómo pagar?",
            pay_waiting: "Esperando pago...",
            pay_success_title: "¡Pago Recibido!",
            pay_success_desc: "Suscripción activada.",
            pay_reload: "Recargar Página",
            guide_title: "Cómo pagar con Cripto",
            guide_warning: "Importante: Selecciona la red <b>TRON (TRC20)</b> al enviar.",
            btn_back: "Volver",

            pay_problem_link: "¿Pago no acreditado?",
            pay_problem_title: "¿Dónde está mi suscripción?",
            pay_prob_desc: "Si enviaste dinero pero el estado no cambió en 10 minutos:",
            pay_prob_reason_1: "<b>Monto incorrecto:</b> Enviaste un poco menos o más.",
            pay_prob_reason_2: "<b>Comisión:</b> El exchange descontó la comisión del total.",
            pay_prob_reason_3: "<b>Red incorrecta:</b> Usaste BEP20 en lugar de TRC20.",
            pay_prob_solution: "¡Tranquilo! Envíanos tu <b>TxID (Hash)</b> y lo activaremos manualmente.",
            btn_contact_support: "Contactar Soporte",

            guide_step_1: "<b>1. Telegram Wallet:</b><br>Abre <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Compra USDT vía P2P. Toca 'Enviar' → 'Wallet Externa' → pega la dirección.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Descarga la app. Compra USDT (TRC20). Envía a nuestra dirección.",

            info_header: "Información",
            lbl_support_email: "Correo de soporte",
            doc_terms: "Términos de Uso",
            doc_privacy: "Privacidad",
            doc_refund: "Reembolsos",
            btn_close: "Cerrar",

            btn_roadmap: "Hoja de Ruta",
            roadmap_title: "Planes Futuros",
            roadmap_desc: "Con tu apoyo activo, xFetishHub evolucionará. Esto es lo que estamos construyendo:",
            rm_global_title: "Inteligencia Global",
            rm_global_desc: "Estadísticas anónimas de todos los usuarios para mejorar recomendaciones. Ver los fetiches más amados y odiados.",
            rm_coop_title: "Modo Cooperativo",
            rm_coop_desc: "Invita a tu pareja. Verán lo que generas en tiempo real. Perfecto para parejas a distancia.",
            rm_content_title: "5000+ Categorías",
            rm_content_desc: "Expansión masiva de la base de datos. Cada micro-fetiche será indexado.",
            rm_actors_title: "Selector de Actores",
            rm_actors_desc: "Un modo dedicado para encontrar estrellas porno basado en tus preferencias visuales.",
            rm_support_btn: "Apoyar Desarrollo 🚀",

            ai_prompt: [
                "¿Qué deseas ver hoy? 😏",
                "Describe tu fantasía...",
                "¿De qué tienes ganas?",
                "Dime, ¿qué te excita ahora mismo?"
            ],
            ai_placeholder: [
                "ej. pechos grandes, sin anal...",
                "Quiero algo apasionado...",
                "Sorpréndeme con pelirrojas...",
                "Duro, al aire libre..."
            ],
            ai_thinking: "Pensando...",
            ai_btn_go: "Buscar",
            ai_phrases_success: [
                "Como pediste:",
                "Encontré exactamente lo que necesitas.",
                "Tus deseos son órdenes.",
                "Esto encaja perfectamente.",
                "Creo que esto es.",
                "Directo de la base de datos para ti."
            ],
            ai_phrases_fail: [
                "Eso es muy específico, pero prueba esto:",
                "No encontré una coincidencia exacta, pero te gustará esto:",
                "Mi base de datos está perpleja, pero aquí tienes una opción top:",
                "Solicitud difícil... ¿qué tal esto?",
                "No entendí bien, así que aquí hay algo seguro:"
            ],

            search_liked: "Buscar favoritos...",
            search_disliked: "Buscar bloqueados...",
            hist_empty: "Historial vacío",
            limit_reset: "Reinicio:",

            panic_btn: "Modo Emergencia",
            panic_title: "Modo Emergencia",
            panic_desc: "Modo sigiloso para ocultar contenido. Actívalo con <b>Doble Toque</b> o <b>Doble ESC</b>.",
            panic_enable: "Activar atajo",
            
            // Safe Mode UI
            safe_subtitle: "Tu hogar para pasatiempos favoritos",
            safe_btn_start: "Comenzar",
            safe_status: "Hora de relajarse 😌",
            
            // Settings Masquerade
            safe_label_site: "Hora",
            safe_label_ori: "Ubicación",
            safe_label_int: "Dificultad",
            safe_opt_morn: "Mañana", safe_opt_day: "Día", safe_opt_eve: "Noche",
            safe_opt_home: "Casa", safe_opt_work: "Trabajo", safe_opt_park: "Parque",

            // Post-Panic Phrases
            post_panic_phrases: ["Espero que no te hayan pillado 😁", "Estuvo cerca...", "A salvo 😮‍💨", "De vuelta al negocio 😏"],

            vpn_title: "Aviso",
            vpn_text_1: "Debo advertirte: vas a un sitio +18 con contenido adulto y anuncios. Por si acaso 😊.",
            vpn_text_pwa: "Si el video no se reproduce, intenta reiniciarlo o ábrelo en el navegador.",
            vpn_text_2: "¡Y no olvides la VPN! Disfruta 😏",
            vpn_btn: "Vamos",

            tips_btn: "Consejos Útiles",
            tips_title: "Base de Conocimiento",
            tips_guru_title: "Sé un Gurú del Video 😈",
            btn_got_it: "Entendido",

            tip_ads_title: "Cómo quitar anuncios",
            tip_ads_desc: "Trucos para la App",
            tip_ads_text: "NO hay anuncios en xFetishHub. Pero los sitios externos sí tienen.<br><br><b>Truco para la App (PWA):</b><br>Instala un bloqueador de anuncios (ej. AdGuard) en Safari/Chrome. ¡Funcionará automáticamente dentro de nuestra App!",

            tip_video_title: "¿No carga el video?",
            tip_video_desc: "Pantalla negra o errores",
            tip_video_text: "Debido a la tecnología PWA, a veces los videos no cargan en la App.<br><br><b>Solución:</b><br>1. Recarga la página.<br>2. Si falla, abre el sitio en el navegador normal.",

            tip_pay_title: "¿Cómo pagar?",
            tip_pay_desc: "Cripto y cómo usarlo",
            tip_pay_text: "Solo aceptamos Cripto (USDT) debido a las restricciones de contenido adulto.<br><br><b>¿Nuevo en Cripto?</b><br>1. Abre <b>@wallet</b> en Telegram.<br>2. Compra USDT vía P2P.<br>3. Envía a nuestra dirección (red TRC20).",

            tip_bug_title: "Reportar Problema",
            tip_bug_desc: "Ayuda a mejorar",
            tip_bug_text: "Un solo desarrollador creó esto. Los errores pasan.<br><br>Usa el botón <b>'Reportar Problema'</b> en Extras. ¡Leo y arreglo todo!",

            tip_panic_title: "Cómo no ser descubierto",
            tip_panic_desc: "Modo sigilo",
            tip_panic_text: "La app tiene un <b>Modo Pánico</b>. Actívalo con <b>Doble Toque</b> (o teclas en PC).<br><br>Cambia a una interfaz neutral sin contenido comprometedor.<br>Para salir: pulsa el botón principal o usa el mismo gesto.",

            tip_layout_title: "Frases superpuestas",
            tip_layout_desc: "Arreglar diseño",
            tip_layout_text: "Debido a la PWA, a veces la tarjeta sube demasiado y el logo tapa el texto.<br><br><b>Solución:</b><br>Gira el teléfono a <b>horizontal</b> y vuelve a <b>vertical</b>. El diseño se arreglará automáticamente.",

            tip_int_title: "Niveles de Intensidad",
            tip_int_desc: "¿Qué cambia exactamente?",
            tip_int_text: `
                <b>🛡️ TRANQUILO (Nivel 1):</b><br>
                Vainilla y romance. Bloquea completamente BDSM y fetiches. Contenido "limpio".<br><br>
                <b>🔥 PICANTE (Nivel 2):</b><br>
                Desbloquea <b>BDSM y Kink</b>. Añade bondage, nalgadas, dominación y fetiches. Aún bloquea fluidos y dolor.<br><br>
                <b>💀 EXTREMO (Nivel 3):</b><br>
                Desbloquea <b>Hardcore</b>. Añade lo prohibido: lluvia dorada, scat, fisting, dolor y fetiches extremos. Sin filtros.
            `,

            tip_modes_title: "Modos de Juego",
            tip_modes_desc: "Explorar vs Placer vs IA",
            tip_modes_text: `
                <b>🔭 Explorar:</b><br>
                Aleatoriedad equilibrada. Prioriza descubrir nuevos géneros. Perfecto cuando no sabes qué quieres.<br><br>
                <b>🥰 Placer:</b><br>
                Sigue estrictamente tus gustos. Usa tus etiquetas favoritas. Ideal para un éxito garantizado.<br><br>
                <b>🤖 Agente IA:</b><br>
                Se activa con búsqueda de texto o voz. Entiende el contexto ("más duro", "algo nuevo").
            `,

            // --- Generator ---
            generate: "Género Aleatorio",
            generate_again: "Otro Género",
            btn_similar: "Similar",
            watch: "Ver",
            search: "Buscar",
            related_header: "También te puede interesar:",
            mod_manage: "Gestionar Mods",
            mod_title: "Modificadores",
            mod_active_sec: "Activos",
            mod_inactive_sec: "Inactivos",
            mod_limit_reached: "¡Límite alcanzado!",
            add_genre: "Añadir al género:",
            search_en_label: "Buscar en EN",
            site_label: "Sitio",
            exploration_mode: "Intensidad",


            btn_start: "¡Vamos!",
            btn_pass: "Otro",
            btn_like: "Similar",
            btn_upgrade_short: "Mejorar ⇧",

            // --- Subscription ---
            sub_title: "Acceso Premium",
            sub_intro: "xFetishHub es un proyecto único en su tipo que te ayuda a descubrir y analizar tus preferencias adultas en un lugar acogedor y sin publicidad. Al suscribirte aseguras la supervivencia del proyecto, y a cambio te daré muchas más funciones:",
            
            feat_limit: "🎲 50 Generaciones / día",
            feat_stats_basic: "📊 Estadísticas Básicas",
            feat_filters: "✔️ Filtros Estándar",
            btn_current: "Plan Actual",

            feat_wrapped_limited: "🎁 1 Fetish Wrapped / semana",
            feat_wrapped_unlim: "✨ Fetish Wrapped <b>Ilimitado</b>",

            lbl_subscription: "Suscripción",
            limit_text_full: "🎲 50 Generaciones / día (quedan: {n}/50)",

            feat_unlim: "🔥 Generaciones Ilimitadas",
            feat_stats_adv: "📈 Estadísticas Avanzadas",
            feat_custom: "🎨 Personalización",
            feat_early: "🚀 Acceso Anticipado",
            btn_get_pro: "Obtener Pro",

            feat_all_pro: "👑 Todo lo de Pro",
            feat_all_beast: "🦁 <b>Todo lo de Beast</b>",
            feat_sponsors: "💎 En Patrocinadores",
            feat_discord: "💬 Discord con el desarrollador",
            feat_vote: "🗳️ Votar Futuro",
            btn_get_beast: "Modo Bestia",

            bill_monthly: "Mensual",
            bill_yearly: "Anual",

            btn_lower_tier: "Mereces algo mejor",

            pay_desc: "Selecciona un método de pago. Recibirás un código de activación al instante.",
            pay_stars: "Estrellas Telegram",
            pay_card: "Tarjeta (Mundial)",
            pay_crypto: "Cripto (Anónimo)",
            pay_boosty: "Boosty (Tarjetas)",
            pay_code_label: "Si ya pagaste, ingresa el código:",
            pay_code_placeholder: "Código de activación...",

            lbl_current_plan: "Plan Actual",
            login_alert: "¡Inicia sesión para gestionar suscripciones!",

            // --- Account ---
            login_text: "Entrar / Sincronizar",
            personal_account: "Cuenta Personal",
            btn_open_stats: "Estadísticas",

            // ТЕМЫ
            "theme_blue-dark": "Medianoche",
            "theme_green-dark": "Bosque",
            "theme_red-dark": "Vampiro",
            "theme_gold-dark": "Lujo",
            "theme_noir": "Noir",
            "theme_blue-light": "Cielo",
            "theme_green-light": "Menta",
            "theme_red-light": "Rosa",
            "theme_gold-light": "Arena",
            "theme_dark": "Oscuro",
            "theme_light": "Claro",

            history_title: "Historial",

            logout_text: "Cerrar sesión",
            login_required: "¡Por favor inicia sesión para activar tu suscripción!",
            sync_success: "¡Datos sincronizados!",
            
            btn_reset: "Restablecer datos",
            confirm_reset: "¿Estás seguro? Esto borrará tu historial y estadísticas. No se puede deshacer.",
            reset_done: "Datos restablecidos.",
            
            explored_label: "Explorado",
            explored_txt: "{n} / {t} categorías",
            report_issue: "Reportar Problema",

            sync_title: "Nube",
            sync_desc: "Datos guardados seguros en Google",
            sync_tip: "Haz clic en 'Sincronizar'. <b>La página se recargará.</b>",
            sync_btn_success: "✅ ¡Hecho! Recargando...",
            btn_sync: "🔄 Sincronizar",
            sub_exp: "exp:",
            sub_expired: "Vencido",
            time_d: "d",

            // --- Lists ---
            favorites_catalog: "Me Gusta",
            blacklist_catalog: "No Me Gusta",
            btn_fav_add: "A Favoritos",
            btn_fav_remove: "En Favoritos",
            btn_ban_add: "Bloquear",
            btn_ban_remove: "Desbloquear",
            empty: "¡Lista vacía (Filtros)!",

            // --- Filters ---
            filter_include: "Incluir",
            filter_exclude: "Excluir",
            tag_fav: "Favoritos",
            tag_straight: "Hetero", tag_gay: "Gay", tag_lesbian: "Lesbiana", tag_trans: "Trans",

            // --- Stats ---
            btn_stats: "Estadísticas",
            stats_header: "Tus Categorías",
            stats_prefs: "Preferencias",
            stats_activity: "Actividad",
            tf_week: "Semana", tf_month: "Mes", tf_year: "Año", tf_all: "Todo el tiempo",
            act_gen: "Generaciones", act_watch: "Vistas",
            chart_prefs_x: "Preferencias",
            chart_points_y: "Puntos",
            chart_count_y: "Cantidad",
            share_btn: "Compartir",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Vuelve en una semana. O si quieres estadísticas diarias, la suscripción Pro es tu mejor amiga.",

            legend_watch: "Ver (+10)",
            legend_like: "Me gusta (+5)",
            legend_dislike: "Otro / No me gusta (-10)",
            act_actions: "Desliza",
            act_watches: "Vistas", 

            // --- Explain ---
            expl_fav: "Porque te gusta ",
            expl_sim: "Relacionado",
            expl_rand: "Destino",
            expl_score: "Porque te gustó ",
            expl_tag_click: "Elegiste etiqueta: ",

            // --- Badges ---
            badge_extreme: "Extremo",
            badge_desc_extreme: "⚠️ <b>Alta Intensidad</b><br>Contenido rudo o intenso.",
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>Contenido LGBTQ+</b><br>Relaciones del mismo sexo o Trans.",
            badge_niche: "Nicho",
            badge_desc_niche: "🔍 <b>Fetiche Específico</b><br>Interés particular no convencional.",
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM</b><br>Bondage, dominación y sumisión.",

            // --- Modals ---
            age_title: "Verificación de edad",
            age_desc: "Este sitio web contiene material para adultos. ¿Tienes 18 años o más?",
            age_yes: "Sí, tengo 18+",
            age_no: "No, Salir",
            age_block_msg: "Este sitio web es solo para usuarios mayores de 18 años.",
        
            install_title: "Instalar App",
            install_desc: "Instala la app para pantalla completa. ¡Además, mira videos en el navegador integrado para mantener limpio tu historial principal!",
            install_continue: "Continuar en navegador",

            btn_install_phone: "Instalar en móvil",
            qr_title: "Escanear para instalar",
            qr_desc: "Escanea este código QR con tu cámara para abrir el sitio, luego sigue las instrucciones:",
            
            inst_ios_1: "Toca el botón <b>Compartir</b>",
            inst_ios_2: "Baja y selecciona",
            inst_ios_btn: "Añadir a Inicio",
            inst_ios_3: "Toca <b>Añadir</b>.",
            
            inst_and_1: "Toca el <b>Menú</b> (3 puntos)",
            inst_and_2: "Selecciona",
            inst_and_btn: "Instalar Aplicación",

            onb_title: "Configuración rápida",
            onb_desc: "Escribe lo que te gusta o no te gusta para que podamos ir directo a lo que amas 😈.",
            onb_placeholder: "ej. amo mamada y anal, pero odio fetiche de pies y exterior...",
            onb_btn_check: "Buscar Categorías",
            onb_found: "Encontramos:",
            onb_btn_confirm: "Añadir a Favoritos",
            onb_skip: "Saltar configuración",

            lbl_about: "Sobre el proyecto",
            
            terms_text: `
                <h3>1. Aceptación de los Términos</h3>
                <p>Al acceder y utilizar xFetishHub, confirma que tiene al menos 18 años de edad (o la mayoría de edad en su jurisdicción) y acepta estar sujeto a estos términos. Si no está de acuerdo, debe abandonar el servicio inmediatamente.</p>
                
                <h3>2. Naturaleza del Servicio</h3>
                <p>xFetishHub es un agregador de búsqueda y motor de recomendaciones. <b>No alojamos, subimos ni controlamos ningún contenido de video.</b> Todos los enlaces generados conducen a sitios web de terceros (por ejemplo, xHamster, Pornhub). Servimos como un conducto para encontrar contenido disponible públicamente en Internet.</p>
                
                <h3>3. Contenido de Terceros</h3>
                <p>No tenemos control ni asumimos responsabilidad por el contenido, las políticas de privacidad o las prácticas de sitios web de terceros. Usted reconoce y acepta que xFetishHub no será responsable, directa o indirectamente, por ningún daño o pérdida causada por su uso de cualquier contenido de terceros.</p>
                
                <h3>4. Cuentas y Suscripciones</h3>
                <p>Algunas funciones requieren una suscripción paga ("Pro" o "Beast"). El procesamiento de pagos es manejado por proveedores externos. No almacenamos sus credenciales de pago. Nos reservamos el derecho de cancelar cuentas que violen estos términos.</p>
                
                <h3>5. Renuncia de Garantías</h3>
                <p>El servicio se proporciona "TAL CUAL" y "SEGÚN DISPONIBILIDAD". No garantizamos que los resultados generados cumplan con sus requisitos o estén libres de errores.</p>
            `,

            privacy_text: `
                <h3>1. Introducción</h3>
                <p>Su privacidad es nuestra prioridad. Esta política explica cómo manejamos sus datos. Nuestro objetivo es recopilar la cantidad mínima absoluta de información requerida para proporcionar nuestro servicio.</p>
                
                <h3>2. Datos que Recopilamos</h3>
                <ul>
                    <li><b>Datos de Autenticación:</b> Al iniciar sesión a través de Google, recibimos su correo electrónico y UID para sincronizar sus preferencias. No vemos su contraseña.</li>
                    <li><b>Datos de Uso:</b> Almacenamos su historial generado, etiquetas favoritas y preferencias localmente en su dispositivo y encriptados en nuestra base de datos para el funcionamiento del algoritmo.</li>
                    <li><b>Almacenamiento Local:</b> Utilizamos el almacenamiento local del navegador para guardar sus configuraciones (tema, idioma) sin cookies de rastreo.</li>
                </ul>

                <h3>3. Cómo Usamos los Datos</h3>
                <p>Sus datos se utilizan únicamente para:</p>
                <ul>
                    <li>Sincronizar su progreso entre dispositivos.</li>
                    <li>Verificar el estado de su suscripción.</li>
                    <li>Entrenar el algoritmo de personalización para mejorar las sugerencias.</li>
                </ul>
                <p><b>No vendemos, intercambiamos ni alquilamos su información de identificación personal a terceros.</b></p>

                <h3>4. Eliminación de Datos</h3>
                <p>Puede solicitar la eliminación completa de su cuenta y datos en cualquier momento contactando al soporte o utilizando el botón "Restablecer datos" dentro de la aplicación.</p>
            `,

            refund_text: `
                <h3>1. Política de Bienes Digitales</h3>
                <p>Debido a la naturaleza del contenido digital, todas las ventas de códigos de activación y suscripciones para xFetishHub son generalmente <b>finales y no reembolsables</b> una vez que el código ha sido entregado o la suscripción activada.</p>
                
                <h3>2. Excepciones</h3>
                <p>Podemos ofrecer un reembolso o reemplazo a nuestra entera discreción bajo las siguientes circunstancias:</p>
                <ul>
                    <li><b>Error Técnico:</b> El código de activación proporcionado no era válido o estaba defectuoso.</li>
                    <li><b>No Entrega:</b> Pagó pero no recibió el servicio/código dentro de las 24 horas.</li>
                    <li><b>Doble Facturación:</b> Se le cobró dos veces por el mismo período debido a un fallo técnico.</li>
                </ul>

                <h3>3. Cómo Solicitar</h3>
                <p>Para solicitar un reembolso, contacte al soporte a través del botón "Reportar Problema". Incluya su ID de transacción y la fecha de compra. Las solicitudes deben realizarse dentro de los 14 días posteriores a la compra.</p>
            `
        },

        de: {
            // --- General ---
            subtitle: "Dein Zuhause für Erwachsenen-Vorlieben",
            lang_label: "Sprache",
            nav_home: "Start",
            nav_settings: "Einstell.",
            nav_account: "Konto",
            header_prefs: "Präferenzen",
            header_filters: "Filter",
            mode_label: "Modus",
            ori_label: "Orientierung",
            ori_hetero: "Hetero",
            ori_gay: "Schwul",
            ori_trans: "Trans",
            ori_pan: "Pansexuell",
            header_extras: "Extras",
            header_community: "Gemeinschaft",
            header_features: "Funktionen",
            header_legal: "Rechtliches",
            theme_label: "Aussehen",
            theme_title: "Thema wählen",
            theme_basic: "Basis",
            theme_premium: "Premium Farben",
            btn_return: "Zurück",
             watch_later: "Später ansehen",
            empty_wl: "Liste leer",
            sync_label: "Sync: ",
            expl_undo: "Meinung geändert? 😏",
            expl_hist: "Aus dem Archiv 📜",
            deco_label: "Dekoration anzeigen",

            mod_add_custom: "Eigenes hinzufügen",
            mod_input_ph: "z.B. Rothaarige...",
            mod_add_btn: "Hinzufügen",

            cat_tips_tech: "Technik & Funktionen",
            cat_tips_info: "Info & 18+ Wissen",

            tip_sites_title: "Seiten-Guide 2026",
            tip_sites_desc: "Vor- & Nachteile im Vergleich",
            tip_sites_text: `
                <b>xVideos</b> — Die Wahl des Volkes.<br>
                ✅ <b>Vorteile:</b> Riesige Bibliothek, lädt sofort, viel Amateur/Nischen.<br>
                ❌ <b>Nachteile:</b> Geringere Qualität, viel Werbung.<br>
                👉 <i>Für maximale Vielfalt.</i><br><br>

                <b>Pornhub</b> — Premium-Erlebnis.<br>
                ✅ <b>Vorteile:</b> Beste UI, verifizierte Modelle, viel 4K.<br>
                ❌ <b>Nachteile:</b> Regionale Sperren, aggressive Premium-Werbung.<br>
                👉 <i>Für Qualität und Komfort.</i><br><br>

                <b>xHamster</b> — Amateur-Himmel.<br>
                ✅ <b>Vorteile:</b> Sauberes Design, Fokus auf echtes Amateur und VR.<br>
                ❌ <b>Nachteile:</b> Weniger professionelle Studio-Videos.<br>
                👉 <i>Für Fans von "echtem" Sex.</i><br><br>

                <b>SpankBang</b> — Kenner-Wahl.<br>
                ✅ <b>Vorteile:</b> Viel HD/4K kostenlos, tolle Algorithmen.<br>
                ❌ <b>Nachteile:</b> Häufige Duplikate, weniger Kategorien.<br>
                👉 <i>Für hohe Qualität kostenlos.</i>
            `,

            tip_algo_title: "Wie der Algorithmus funktioniert",
            tip_algo_desc: "Training von xFetishHub",
            tip_algo_text: `
                <b>👍 Rechts (Like):</b> Erhöht die Gewichtung von Tags. Sie erscheinen öfter.<br><br>
                <b>👎 Links (Dislike):</b> Verringert die Gewichtung. Das System schlägt es seltener vor.<br><br>
                <b>💡 Tipp:</b> Sei ehrlich, um den <b>"Genuss"</b>-Modus zu verbessern.
            `,

            tip_dict_title: "Fetisch-Glossar",
            tip_dict_desc: "POV, BBW und mehr erklärt",
            tip_dict_text: `
                <b>POV:</b> Perspektive der ersten Person.<br>
                <b>PMV:</b> Porno-Musikvideo.<br>
                <b>JOI:</b> Wichsanleitung.<br>
                <b>BBW:</b> Große schöne Frauen.<br>
                <b>PAWG:</b> Weiße Frau mit großem Hintern.<br>
                <b>CBT:</b> Genitalfolter (Hardcore).
            `,

            tip_psycho_title: "Alle Psychotypen",
            tip_psycho_desc: "Freischaltbare Abzeichen",
            tip_psycho_text: `
                👑 <b>Dunkler Lord:</b> Du liebst BDSM und Tabus.<br>
                🎭 <b>Der Performer:</b> Öffentlich und Rollenspiel.<br>
                🕯️ <b>Der Götzendiener:</b> Körperteile und Kleidung.<br>
                🍇 <b>Caligula:</b> Gruppe + Hardcore.<br>
                🍦 <b>Der Klassiker:</b> Vanille und Romantik.
            `,

            tip_pwa_title: "Website in App verwandeln",
            tip_pwa_desc: "Vollbild, Privater Browser & Ewiger Verlauf",
            tip_pwa_text: `
                Wusstest du, dass xFetishHub als App konzipiert ist?<br><br>
                <b>Warum installieren?</b><br>
                ✅ <b>Es sieht toll aus:</b> Vollbild, keine Browserleisten.<br>
                ✅ <b>Integrierter Privater Browser:</b> Wenn du auf 'Ansehen' klickst, öffnen sich Videos <i>in</i> der App. Dein Safari/Chrome-Verlauf bleibt sauber!<br>
                ✅ <b>Ewiger Speicher:</b> Browser löschen Daten oft nach 7 Tagen. Die App behält deinen Verlauf für immer.<br><br>
                <b>Wie installieren:</b><br>
                🍎 <b>iOS (Safari):</b> Tippe auf 'Teilen' (Quadrat mit Pfeil) → Runterscrollen → 'Zum Home-Bildschirm'.<br>
                🤖 <b>Android (Chrome):</b> Tippe auf Menü (3 Punkte) → 'App installieren' oder 'Zum Startbildschirm'.
            `,

            tip_mods_title: "Macht der Modifikatoren",
            tip_mods_desc: "Suche verfeinern",
            tip_mods_text: `
                Der <b>+</b> Button unter der Karte ist dein bester Freund.<br><br>
                <b>Wie es funktioniert:</b><br>
                Modifikatoren wirken <i>zusätzlich</i> zum generierten Genre.<br><br>
                <b>Beispiel:</b><br>
                1. Du würfelst "Anal".<br>
                2. Du fügst "POV" hinzu.<br>
                3. Ergebnis: Die App sucht nach <b>"Anal + POV"</b>.<br><br>
                <b>Profi-Tipp:</b><br>
                Du kannst jetzt <b>Eigene Modifikatoren</b> hinzufügen! Willst du "Rothaarige"? Oder "Latex"? Schreib es einfach ins Menü.
            `,

            pt_title: "Wusstest du?",
            pt_desc: "Wenn du wissen willst, wie man Werbung in Videos komplett deaktiviert oder im richtigen Moment nicht erwischt wird, lies die Wissensdatenbank hier, du wirst nicht enttäuscht sein 🌚",
            pt_btn_go: "Wissensdatenbank öffnen",

            theme_preview_mode: "Vorschau",
            btn_unlock_theme: "Thema freischalten 🔒",
            theme_tap_cancel: "Tippe irgendwo zum Abbrechen",

            site_random: "Zufällig",

            btn_version: "Version",
            changelog_title: "Versionsverlauf",

            limit_title: "Limit erreicht",
            limit_desc_fun: "Das reicht für heute, Kumpel. Komm morgen wieder oder hol dir Pro und schau bis du blau wirst 😏",

            act_time: "Zeit",

            unlocked_on: "Freigeschaltet:",
            explored_subtitle: "Hier sind die Erfolge, die du für 'Platin' brauchst 😈",
            cat_general: "Allgemein",
            cat_solo: "Solo & Hände",
            cat_anal: "Anal & Po",
            cat_breasts: "Brüste & Milch",
            cat_oral: "Orale Lust",
            cat_hardcore: "Hardcore & BDSM",
            cat_lgbt: "LGBTQ+",
            cat_group: "Gruppe & Sozial",
            cat_feet: "Füße & Beine",
            cat_roleplay: "Rollenspiel",
            cat_public: "Öffentlich & Tabu",
            cat_body: "Körper & Aussehen",
            cat_toys: "Spielzeug",
            cat_mess: "Flüssigkeiten",
            cat_fantasy: "Fantasie & Kunst",
            cat_clothing: "Kleidung & Fetisch",

            panic_active_phrases: ["Nichts Verdächtiges 😇", "Nur ein Hobby", "Reine Unschuld", "Produktivität 📈", "Wasser trinken 💧"],

            val_safe: "Sicher",
            val_spicy: "Würzig 🔥",
            val_extreme: "EXTREM 💀",

            share_caption: "Entdecke dich selbst",

            mode_greeting_hint: [
                "Erkunden 🔭, Genießen 🥰 oder ein Wunsch ✨?",
                "Zufall 🔭, Geschichte 🥰 oder Magie ✨?",
                "Etwas Neues 🔭, Bekanntes 🥰 oder Spezifisches ✨?"
            ],
            mode_greeting_dynamic: [
                "Lust auf<br><b>{fav}</b> 🥰<br>oder vielleicht etwas Neues wie<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Oder schreib deinen Wunsch ✨</span>",
                "Zurück zu<br><b>{fav}</b> 🥰<br>oder ein Risiko eingehen mit<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Du kannst auch eine Fantasie beschreiben ✨</span>",
                "Vermisst du<br><b>{fav}</b> 🥰?<br>Oder erkunden wir<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>Oder frag mich einfach ✨</span>"
            ],
            mode_explore: "Erkunden",
            mode_pleasure: "Genießen",
            mode_ai: "KI-Agent",

            info_header: "Informationen",
            hist_tab_swipes: "Swipes",
            hist_tab_watch: "Zeit",
            hist_empty_watch: "Noch keine Daten. Schau dir was an! 😏",
            hist_watched: "GESEHEN",

            status_wl: "Später ansehen",
            status_fav: "Gefällt mir",
            status_ban: "Gefällt nicht",

            stats_no_data: "Noch keine Daten",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Mache noch {n} Aktionen, um deine Zusammenfassung freizuschalten",

            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amethyst",
            "theme_purple-light": "Lavendel",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Pfirsich",
            "theme_old-money": "Old Money",

            plan_bestie_sub: "Lebenslang",
            plan_bestie_price: "/ einmalig",
            badge_limited: "LIMITIERTES ANGEBOT",
            limit_burn: "🔥 FAST WEG",
            limit_claimed: "beansprucht",
            feat_lifetime: "♾️ <b>Lebenslanger Zugriff</b>",
            feat_onetime: "💸 Einmalzahlung",
            btn_get_bestie: "Für immer holen",

            // --- Sponsors ---
            btn_early_sponsors: "Frühe Sponsoren",
            sponsors_title: "Ruhmeshalle",
            sponsors_desc: "Diese Legenden haben xFetishHub von Anfang an mit dem Bestie-Plan unterstützt. Ewig dankbar! 💙",

            return_phrases: [
                "Ganze {t}. Du warst dir sicher 😏",
                "Zurück nach {t}. Hat es dir gefallen? 🔥",
                "{t}... Was für eine Sitzung! 😅",
                "Du warst {t} weg. Hoffentlich war es das wert.",
                "Wow, {t}! Scheint eine gute Wahl zu sein."
            ],
            return_phrase_short: "Nur {t}? Das ging schnell... ⚡",

            reset_phrases: [
                "Manchmal braucht jeder eine Pause 🧘",
                "Lass uns neu anfangen...",
                "Systemneustart 🔄",
                "Ruhe und Frieden...",
                "Ein neuer Anfang ✨"
            ],

            auth_title: "Synchronisierung",
            auth_p1: "Verlauf und Vorlieben auf allen Geräten speichern",
            auth_p2: "Pro / Beast Status aktivieren",
            auth_p3: "Anonyme Speicherung auf Google-Servern",
            btn_google_signin: "Weiter mit Google",
            auth_security_note: "Der Entwickler hat keinen Zugriff auf die Daten. Falls Sie dennoch Bedenken haben, können Sie ein zweites Konto verwenden. 😏",
            btn_cancel: "Abbrechen",

            pay_header: "Zahlung USDT (TRC20)",
            pay_instruction: "Sende den <b>exakten Betrag</b> (einschließlich Dezimalstellen) über das <b>Tron (TRC20)</b> Netzwerk.",
            pay_fee_warn: "⚠️ Netzwerkgebühr ist NICHT enthalten. Sende nicht von einer Börse, wenn die Gebühr vom Betrag abgezogen wird!",
            pay_sum_label: "Betrag:",
            pay_copy_addr: "Tippen zum Kopieren",
            pay_how_to: "Keine Krypto? Wie zahlen?",
            pay_waiting: "Warte auf Zahlung...",
            pay_success_title: "Zahlung erhalten!",
            pay_success_desc: "Abonnement aktiviert.",
            pay_reload: "Seite neu laden",
            guide_title: "Wie man mit Krypto zahlt",
            guide_warning: "Wichtig: Wähle das <b>TRON (TRC20)</b> Netzwerk.",
            btn_back: "Zurück",

            pay_problem_link: "Zahlung nicht erhalten?",
            pay_problem_title: "Wo ist mein Abo?",
            pay_prob_desc: "Wenn sich der Status nach 10 Minuten nicht ändert:",
            pay_prob_reason_1: "<b>Falscher Betrag:</b> Du hast etwas zu wenig/viel gesendet.",
            pay_prob_reason_2: "<b>Gebühr:</b> Die Börse hat die Gebühr abgezogen.",
            pay_prob_reason_3: "<b>Falsches Netz:</b> BEP20 statt TRC20 verwendet.",
            pay_prob_solution: "Keine Sorge! Sende uns deinen <b>TxID (Hash)</b> und wir aktivieren es manuell.",
            btn_contact_support: "Support kontaktieren",

            guide_step_1: "<b>1. Telegram Wallet:</b><br>Öffne <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Kaufe USDT per P2P. Klicke 'Senden' → 'Externe Wallet'.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Lade die App. Kaufe USDT (TRC20). Sende an unsere Adresse.",

            info_header: "Informationen",
            lbl_support_email: "Support-E-Mail",
            doc_terms: "Nutzungsbedingungen",
            doc_privacy: "Datenschutz",
            doc_refund: "Rückerstattung",

            btn_roadmap: "Roadmap",
            roadmap_title: "Zukunftspläne",
            roadmap_desc: "Mit deiner Unterstützung wird sich xFetishHub weiterentwickeln. Das bauen wir:",
            rm_global_title: "Globale Intelligenz",
            rm_global_desc: "Verbesserte Empfehlungen basierend auf anonymen Daten aller Nutzer. Siehe globale 'Top' und 'Flop' Listen.",
            rm_coop_title: "Koop-Modus",
            rm_coop_desc: "Lade einen Partner ein. Er sieht in Echtzeit, was du generierst. Perfekt für Fernbeziehungen.",
            rm_content_title: "5000+ Kategorien",
            rm_content_desc: "Massive Erweiterung der Datenbank. Jeder Mikro-Fetisch wird indexiert.",
            rm_actors_title: "Darsteller-Suche",
            rm_actors_desc: "Ein Modus zum Finden von Pornostars basierend auf deinen visuellen Vorlieben.",
            rm_support_btn: "Entwicklung unterstützen 🚀",

            ai_prompt: [
                "Was möchtest du heute sehen? 😏",
                "Beschreibe deine Fantasie...",
                "Wonach ist dir heute?",
                "Sag mir, was dich gerade anmacht?"
            ],
            ai_placeholder: [
                "z.B. große Brüste, kein Anal...",
                "Ich will etwas Leidenschaftliches...",
                "Überrasch mich...",
                "Hart, draußen..."
            ],
            ai_thinking: "Nachdenken...",
            ai_btn_go: "Finden",
            ai_phrases_success: [
                "Wie gewünscht:",
                "Genau das gefunden, was du brauchst.",
                "Dein Wunsch ist mir Befehl.",
                "Das passt perfekt.",
                "Ich glaube, das ist es.",
                "Direkt aus der Datenbank für dich."
            ],
            ai_phrases_fail: [
                "Das ist etwas spezifisch, aber versuch das:",
                "Keine exakte Übereinstimmung, aber das wirst du mögen:",
                "Datenbank ist ratlos, aber hier ist ein Top-Tipp:",
                "Schwierige Anfrage... wie wäre es damit?",
                "Nicht ganz verstanden, hier ist etwas Sicheres:"
            ],

            btn_start: "Los geht's",
            btn_pass: "Andere",
            btn_like: "Ähnlich",
            btn_upgrade_short: "Upgrade ⇧",

            panic_btn: "Notfallmodus",
            panic_title: "Notfallmodus",
            panic_desc: "Stealth-Modus zum Verstecken. Aktivierung durch <b>Doppeltippen</b> oder <b>Doppel-ESC</b>.",
            panic_enable: "Auslöser aktivieren",
            
            // Safe Mode UI
            safe_subtitle: "Dein Zuhause für Lieblingshobbys",
            safe_btn_start: "Starten",
            safe_status: "Zeit zum Entspannen 😌",
            
            // Settings Masquerade
            safe_label_site: "Zeit",
            safe_label_ori: "Ort",
            safe_label_int: "Schwierigkeit",
            safe_opt_morn: "Morgen", safe_opt_day: "Tag", safe_opt_eve: "Abend",
            safe_opt_home: "Zuhause", safe_opt_work: "Arbeit", safe_opt_park: "Park",

            // Post-Panic Phrases
            post_panic_phrases: ["Hoffentlich wurdest du nicht erwischt 😁", "Das war knapp...", "Jetzt sicher 😮‍💨", "Zurück zum Geschäft 😏"],

            vpn_title: "Hinweis",
            vpn_text_1: "Muss dich warnen: Du gehst auf eine 18+ Seite mit Werbung. Nur für den Fall 😊.",
            vpn_text_pwa: "Falls das Video nicht läuft, starte es neu oder öffne es im Browser.",
            vpn_text_2: "VPN nicht vergessen! Viel Spaß 😏",
            vpn_btn: "Los geht's",

            tips_btn: "Nützliche Tipps",
            tips_title: "Wissensdatenbank",
            tips_guru_title: "Werde ein Video-Guru 😈",
            btn_got_it: "Verstanden",

            tip_ads_title: "Werbung entfernen",
            tip_ads_desc: "Tricks für die App",
            tip_ads_text: "xFetishHub selbst hat KEINE Werbung. Externe Seiten schon.<br><br><b>Tipp für die App (PWA):</b><br>Installiere einen Ad-Blocker (z.B. AdGuard) in Safari/Chrome. Er funktioniert automatisch auch in der App!",

            tip_video_title: "Video läuft nicht?",
            tip_video_desc: "Schwarzer Bildschirm",
            tip_video_text: "Wegen der PWA-Technologie laden Videos in der App manchmal nicht.<br><br><b>Lösung:</b><br>1. Seite neu laden.<br>2. Im normalen Browser öffnen.",

            tip_pay_title: "Wie bezahlen?",
            tip_pay_desc: "Warum Krypto & Anleitung",
            tip_pay_text: "Wir akzeptieren nur Krypto (USDT) wegen der Erwachsenen-Inhalte.<br><br><b>Neu bei Krypto?</b><br>1. Öffne <b>@wallet</b> in Telegram.<br>2. Kaufe USDT via P2P.<br>3. Sende an unsere Adresse (Netzwerk TRC20).",

            tip_bug_title: "Problem melden",
            tip_bug_desc: "Hilf uns",
            tip_bug_text: "Ein Entwickler, neues Projekt. Fehler passieren.<br><br>Nutze <b>'Problem melden'</b> im Extras-Menü. Ich reagiere schnell!",

            tip_panic_title: "Nicht erwischt werden",
            tip_panic_desc: "Stealth-Modus",
            tip_panic_text: "Die App hat einen <b>Panikmodus</b>. Aktiviere ihn durch <b>Doppeltippen</b> (oder Tasten am PC).<br><br>Er zeigt eine neutrale Oberfläche ohne peinliche Inhalte.<br>Beenden: Klicke auf den Hauptbutton oder nutze die gleiche Geste.",

            tip_layout_title: "Überlappende Sätze",
            tip_layout_desc: "Layout korrigieren",
            tip_layout_text: "Wegen PWA-Eigenheiten rutscht die Karte manchmal zu hoch und Text wird verdeckt.<br><br><b>Lösung:</b><br>Drehe das Handy ins <b>Querformat</b> und zurück ins <b>Hochformat</b>. Das Layout wird korrigiert.",

            tip_int_title: "Intensitätsstufen",
            tip_int_desc: "Was genau ändert sich?",
            tip_int_text: `
                <b>🛡️ SICHER (Stufe 1):</b><br>
                Vanille und Romantik. Blockiert BDSM und Fetische komplett. "Sauberer" Inhalt.<br><br>
                <b>🔥 WÜRZIG (Stufe 2):</b><br>
                Schaltet <b>BDSM & Kink</b> frei. Fügt Fesselspiele, Spanking und Dominanz hinzu. Blockiert noch Körperflüssigkeiten.<br><br>
                <b>💀 EXTREM (Stufe 3):</b><br>
                Schaltet <b>Hardcore</b> frei. Fügt hinzu, was verborgen war: Natursekt, Scat, Fisting und Schmerz. Keine Filter.
            `,

            tip_modes_title: "Spielmodi",
            tip_modes_desc: "Erkunden vs Genuss vs KI",
            tip_modes_text: `
                <b>🔭 Erkunden:</b><br>
                Ausgewogener Zufall. Priorisiert das Entdecken neuer Genres. Perfekt, wenn du unentschlossen bist.<br><br>
                <b>🥰 Genuss:</b><br>
                Folgt streng deinen Vorlieben. Nutzt deine "Likes". Ideal für einen garantierten Treffer.<br><br>
                <b>🤖 KI-Agent:</b><br>
                Aktiviert bei Text- oder Sprachsuche. Versteht Kontext ("härter", "etwas Neues").
            `,

            // --- Generator ---
            generate: "Zufallsgenre",
            generate_again: "Anderes Genre",
            btn_similar: "Ähnlich",
            watch: "Ansehen",
            search: "Suchen",
            related_header: "Das könnte Ihnen auch gefallen:",
            mod_manage: "Mods verwalten",
            mod_title: "Modifikatoren",
            mod_active_sec: "Aktiv",
            mod_inactive_sec: "Inaktiv",
            mod_limit_reached: "Limit erreicht!",
            add_genre: "Zum Genre:",
            search_en_label: "Suche auf EN",
            site_label: "Webseite",
            exploration_mode: "Intensität",

            // --- Subscription ---
            sub_title: "Premium Zugang",
            sub_intro: "xFetishHub ist ein einzigartiges Projekt, das dir hilft, deine Vorlieben an einem gemütlichen, werbefreien Ort zu entdecken und zu analysieren. Mit einem Abo sicherst du den Fortbestand des Projekts, und im Gegenzug biete ich dir deutlich mehr Funktionen:",
            
            feat_limit: "🎲 50 Generationen / Tag",
            feat_stats_basic: "📊 Basis-Statistik",
            feat_filters: "✔️ Standardfilter",
            btn_current: "Aktueller Plan",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / Woche",
            feat_wrapped_unlim: "✨ <b>Unbegrenztes</b> Wrapped",

            lbl_subscription: "Abonnement",
            limit_text_full: "🎲 50 Generationen / Tag (übrig: {n}/50)",

            feat_unlim: "🔥 Unbegrenzte Generationen",
            feat_stats_adv: "📈 Erweiterte Statistik",
            feat_custom: "🎨 Tiefe Anpassung",
            feat_early: "🚀 Frühzugang",
            btn_get_pro: "Pro holen",

            feat_all_pro: "👑 Alle Pro-Funktionen",
            feat_all_beast: "🦁 <b>Alle Beast-Funktionen</b>",
            feat_sponsors: "💎 In Sponsorenliste",
            feat_discord: "💬 Discord mit dem Entwickler",
            feat_vote: "🗳️ Abstimmung",
            btn_get_beast: "Beast werden",

            bill_monthly: "Monatlich",
            bill_yearly: "Jährlich",

            btn_lower_tier: "Du verdienst Besseres",

            pay_desc: "Wähle eine Zahlungsmethode. Du erhältst sofort einen Aktivierungscode.",
            pay_stars: "Telegram Stars",
            pay_card: "Karte (Weltweit)",
            pay_crypto: "Krypto (Anonym)",
            pay_boosty: "Boosty (Karten)",
            pay_code_label: "Wenn bezahlt, Code hier eingeben:",
            pay_code_placeholder: "Aktivierungscode...",

            lbl_current_plan: "Aktueller Plan",
            login_alert: "Bitte anmelden, um Abos zu verwalten!",

            // --- Account ---
            login_text: "Anmelden / Sync",
            personal_account: "Persönliches Konto",
            btn_open_stats: "Statistik",

            // ТЕМЫ
            "theme_blue-dark": "Mitternacht",
            "theme_green-dark": "Wald",
            "theme_red-dark": "Vampir",
            "theme_gold-dark": "Luxus",
            "theme_noir": "Noir",
            "theme_blue-light": "Himmel",
            "theme_green-light": "Minze",
            "theme_red-light": "Rose",
            "theme_gold-light": "Sand",
            "theme_dark": "Dunkel",
            "theme_light": "Hell",

            history_title: "Verlauf",

            logout_text: "Abmelden",
            login_required: "Bitte melde dich an, um das Abo zu aktivieren!",
            sync_success: "Daten synchronisiert!",
            
            btn_reset: "Daten zurücksetzen",
            confirm_reset: "Bist du sicher? Dies löscht Verlauf und Statistiken. Kann nicht rückgängig gemacht werden.",
            reset_done: "Daten zurückgesetzt.",
            
            explored_label: "Erforscht",
            explored_txt: "{n} / {t} Kategorien",
            report_issue: "Problem melden",

            sync_title: "Cloud-Speicher",
            sync_desc: "Daten sicher auf Google-Servern gespeichert",
            sync_tip: "Klicke auf 'Synchronisieren'. <b>Seite wird neu geladen.</b>",
            sync_btn_success: "✅ Fertig! Wird neu geladen...",
            btn_sync: "🔄 Synchronisieren",
            sub_exp: "abl:",
            sub_expired: "Abgelaufen",
            time_d: "t",

            // --- Lists ---
            favorites_catalog: "Gefällt mir",
            blacklist_catalog: "Gefällt mir nicht",
            btn_fav_add: "Favorit",
            btn_fav_remove: "In Favoriten",
            btn_ban_add: "Blockieren",
            btn_ban_remove: "Entblocken",
            empty: "Liste leer (Filter)!",

            // --- Filters ---
            filter_include: "Einschließen",
            filter_exclude: "Ausschließen",
            tag_fav: "Favoriten",
            tag_straight: "Hetero", tag_gay: "Schwul", tag_lesbian: "Lesbisch", tag_trans: "Trans",

            // --- Stats ---
            btn_stats: "Statistik",
            stats_header: "Deine Favoriten",
            stats_prefs: "Vorlieben",
            stats_activity: "Aktivität",
            tf_week: "Woche", tf_month: "Monat", tf_year: "Jahr", tf_all: "Gesamtzeit",
            act_gen: "Generationen", act_watch: "Angeschaut",
            chart_prefs_x: "Vorlieben",
            chart_points_y: "Punkte",
            chart_count_y: "Anzahl",
            share_btn: "Teilen",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Komm in einer Woche wieder. Oder wenn du tägliche Statistiken willst, ist das Pro-Abo dein bester Freund.",
            btn_close: "Schließen",
            search_liked: "Favoriten suchen...",
            search_disliked: "Blockierte suchen...",
            hist_empty: "Verlauf leer",
            limit_reset: "Reset:",

            legend_watch: "Ansehen (+10)",
            legend_like: "Like (+5)",
            legend_dislike: "Andere / Dislike (-10)",
            act_actions: "Swipes",
            act_watches: "Angeschaut",

            // --- Explain ---
            expl_fav: "Weil du magst: ",
            expl_sim: "Ähnlich wie voriges",
            expl_rand: "Schicksal",
            expl_score: "Weil du mochtest: ",
            expl_tag_click: "Tag gewählt: ",

            // --- Badges ---
            badge_extreme: "Extrem",
            badge_desc_extreme: "⚠️ <b>Hohe Intensität</b><br>Raue oder intensive Inhalte.",
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>LGBTQ+ Inhalt</b><br>Gleichgeschlechtliche oder Trans-Inhalte.",
            badge_niche: "Nische",
            badge_desc_niche: "🔍 <b>Spezifischer Fetisch</b><br>Besondere Interessen, kein Mainstream.",
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM</b><br>Fesselspiele, Dominanz und Unterwerfung.",

            // --- Modals ---
            age_title: "Altersprüfung",
            age_desc: "Diese Website enthält Material für Erwachsene. Sind Sie 18 Jahre oder älter?",
            age_yes: "Ja, ich bin 18+",
            age_no: "Nein, Verlassen",
            age_block_msg: "Diese Website ist nur für Nutzer über 18 Jahre bestimmt.",
        
            install_title: "App installieren",
            install_desc: "Installiere die App für Vollbild. Plus: Schaue Videos im integrierten Browser, um deinen Hauptverlauf sauber zu halten!",
            install_continue: "Im Browser fortfahren",

            btn_install_phone: "Auf Handy installieren",
            qr_title: "Scannen zum Installieren",
            qr_desc: "Scanne diesen QR-Code mit deiner Kamera, dann befolge die Anweisungen:",
            
            inst_ios_1: "Tippe auf <b>Teilen</b>",
            inst_ios_2: "Scrolle runter und wähle",
            inst_ios_btn: "Zum Home-Bildschirm",
            inst_ios_3: "Tippe auf <b>Hinzufügen</b>.",
            
            inst_and_1: "Tippe auf <b>Menü</b> (3 Punkte)",
            inst_and_2: "Wähle",
            inst_and_btn: "App installieren",

            onb_title: "Schnelleinrichtung",
            onb_desc: "Schreib, was du magst oder nicht magst, damit wir direkt zu dem kommen, was du liebst 😈.",
            onb_placeholder: "z.B. Ich liebe Blowjob und Anal, hasse aber Fußfetisch und Outdoor...",
            onb_btn_check: "Kategorien suchen",
            onb_found: "Wir haben gefunden:",
            onb_btn_confirm: "Zu Favoriten",
            onb_skip: "Überspringen",

            lbl_about: "Über das Projekt",
            
            terms_text: `
                <h3>1. Annahme der Bedingungen</h3>
                <p>Durch den Zugriff auf xFetishHub bestätigen Sie, dass Sie mindestens 18 Jahre alt sind (oder das gesetzliche Mindestalter in Ihrer Gerichtsbarkeit erreicht haben) und stimmen diesen Bedingungen zu. Wenn Sie nicht zustimmen, müssen Sie den Dienst sofort verlassen.</p>
                
                <h3>2. Art des Dienstes</h3>
                <p>xFetishHub ist ein Suchaggregator und eine Empfehlungsmaschine. <b>Wir hosten, laden hoch oder kontrollieren keine Videoinhalte.</b> Alle vom Dienst generierten Links führen zu Websites Dritter (z. B. xHamster, Pornhub). Wir dienen lediglich als Vermittler zum Auffinden von Inhalten, die öffentlich im Internet verfügbar sind.</p>
                
                <h3>3. Inhalte Dritter</h3>
                <p>Wir haben keine Kontrolle über und übernehmen keine Verantwortung für die Inhalte, Datenschutzrichtlinien oder Praktiken von Websites Dritter. Sie erkennen an, dass xFetishHub weder direkt noch indirekt für Schäden oder Verluste haftbar gemacht werden kann, die durch Ihre Nutzung von Inhalten Dritter verursacht werden.</p>
                
                <h3>4. Benutzerkonten & Abonnements</h3>
                <p>Einige Funktionen erfordern ein kostenpflichtiges Abonnement ("Pro" oder "Beast"). Die Zahlungsabwicklung erfolgt durch Drittanbieter. Wir speichern Ihre Zahlungsdaten nicht. Wir behalten uns das Recht vor, Konten zu kündigen, die gegen diese Bedingungen verstoßen.</p>
                
                <h3>5. Gewährleistungsausschluss</h3>
                <p>Der Dienst wird "WIE BESEHEN" (AS IS) bereitgestellt. Wir garantieren nicht, dass die generierten Ergebnisse Ihren Anforderungen entsprechen oder fehlerfrei sind.</p>
            `,

            privacy_text: `
                <h3>1. Einführung</h3>
                <p>Ihre Privatsphäre ist unsere Priorität. Diese Richtlinie erklärt, wie wir mit Ihren Daten umgehen. Unser Ziel ist es, nur die absolut notwendigen Informationen zu sammeln, die für den Dienst erforderlich sind.</p>
                
                <h3>2. Datenerfassung</h3>
                <ul>
                    <li><b>Authentifizierungsdaten:</b> Wenn Sie sich über Google anmelden, erhalten wir Ihre E-Mail-Adresse und UID, um Ihre Einstellungen zu synchronisieren. Wir sehen Ihr Passwort nicht.</li>
                    <li><b>Nutzungsdaten:</b> Wir speichern Ihren generierten Verlauf, Favoriten und Präferenzen lokal auf Ihrem Gerät und verschlüsselt in unserer Datenbank, um den Algorithmus zu betreiben.</li>
                    <li><b>Lokaler Speicher:</b> Wir verwenden den lokalen Browserspeicher, um Ihre Einstellungen (Thema, Sprache) ohne Tracking-Cookies zu speichern.</li>
                </ul>

                <h3>3. Verwendung der Daten</h3>
                <p>Ihre Daten werden ausschließlich verwendet für:</p>
                <ul>
                    <li>Synchronisierung Ihres Fortschritts über Geräte hinweg.</li>
                    <li>Überprüfung Ihres Abonnementstatus.</li>
                    <li>Training des Personalisierungsalgorithmus zur Verbesserung von Vorschlägen.</li>
                </ul>
                <p><b>Wir verkaufen, handeln oder vermieten Ihre persönlichen Identifikationsdaten nicht an Dritte.</b></p>

                <h3>4. Datenlöschung</h3>
                <p>Sie können jederzeit die vollständige Löschung Ihres Kontos und Ihrer Daten beantragen, indem Sie den Support kontaktieren oder die Schaltfläche "Daten zurücksetzen" in der App verwenden.</p>
            `,

            refund_text: `
                <h3>1. Richtlinie für digitale Güter</h3>
                <p>Aufgrund der Natur digitaler Inhalte sind alle Verkäufe von Aktivierungscodes und Abonnements für xFetishHub in der Regel <b>endgültig und nicht erstattungsfähig</b>, sobald der Code geliefert oder das Abonnement aktiviert wurde.</p>
                
                <h3>2. Ausnahmen</h3>
                <p>Wir können nach eigenem Ermessen unter folgenden Umständen eine Rückerstattung oder einen Ersatz anbieten:</p>
                <ul>
                    <li><b>Technischer Fehler:</b> Der bereitgestellte Aktivierungscode war ungültig oder defekt.</li>
                    <li><b>Nichtlieferung:</b> Sie haben bezahlt, aber den Dienst/Code nicht innerhalb von 24 Stunden erhalten.</li>
                    <li><b>Doppelbuchung:</b> Aufgrund eines technischen Fehlers wurde Ihnen derselbe Zeitraum zweimal berechnet.</li>
                </ul>

                <h3>3. Anforderung</h3>
                <p>Um eine Rückerstattung zu beantragen, kontaktieren Sie bitte den Support über die Schaltfläche "Problem melden". Geben Sie Ihre Transaktions-ID und das Kaufdatum an. Anfragen müssen innerhalb von 14 Tagen nach dem Kauf gestellt werden.</p>
            `
        }
    };

    const tipsData = [
    { 
        id: 'ads', 
        icon: '🛡️', 
        titleKey: 'tip_ads_title', 
        descKey: 'tip_ads_desc', 
        textKey: 'tip_ads_text',
        gradient: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' // Синий
    },
    { 
        id: 'video', 
        icon: '▶️', 
        titleKey: 'tip_video_title', 
        descKey: 'tip_video_desc', 
        textKey: 'tip_video_text',
        gradient: 'linear-gradient(135deg, #ec4899 0%, #be185d 100%)' // Розовый
    },
    { 
        id: 'pay', 
        icon: '💸', 
        titleKey: 'tip_pay_title', 
        descKey: 'tip_pay_desc', 
        textKey: 'tip_pay_text',
        gradient: 'linear-gradient(135deg, #10b981 0%, #059669 100%)' // Изумрудный
    },
    { 
        id: 'bug', 
        icon: '🐛', 
        titleKey: 'tip_bug_title', 
        descKey: 'tip_bug_desc', 
        textKey: 'tip_bug_text',
        gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' // Оранжевый
    },
    { 
        id: 'panic', 
        icon: '🚨', 
        titleKey: 'tip_panic_title', 
        descKey: 'tip_panic_desc', 
        textKey: 'tip_panic_text',
        gradient: 'linear-gradient(135deg, #ef4444 0%, #b91c1c 100%)' // Красный
    },
    { 
        id: 'layout', 
        icon: '📱', 
        titleKey: 'tip_layout_title', 
        descKey: 'tip_layout_desc', 
        textKey: 'tip_layout_text',
        gradient: 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)' // Фиолетовый
    },
    { 
        id: 'intensity', 
        icon: '🌶️', 
        titleKey: 'tip_int_title', 
        descKey: 'tip_int_desc', 
        textKey: 'tip_int_text',
        gradient: 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)' // Желто-оранжевый
    },
    { 
        id: 'modes', 
        icon: '🎛️', 
        titleKey: 'tip_modes_title', 
        descKey: 'tip_modes_desc', 
        textKey: 'tip_modes_text',
        gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' // Сине-фиолетовый
    },
    { 
        id: 'sites_guide', 
        icon: '🌐', 
        titleKey: 'tip_sites_title', 
        descKey: 'tip_sites_desc', 
        textKey: 'tip_sites_text',
        gradient: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)' // Голубой градиент
    },
    { 
        id: 'algo_secrets', 
        icon: '🧠', 
        titleKey: 'tip_algo_title', 
        descKey: 'tip_algo_desc', 
        textKey: 'tip_algo_text',
        gradient: 'linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%)' // Фиолетовый (Интеллект)
    },
    { 
        id: 'glossary', 
        icon: '🎓', 
        titleKey: 'tip_dict_title', 
        descKey: 'tip_dict_desc', 
        textKey: 'tip_dict_text',
        gradient: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' // Изумрудный (Знания)
    },
    { 
        id: 'psychotypes', 
        icon: '🎭', 
        titleKey: 'tip_psycho_title', 
        descKey: 'tip_psycho_desc', 
        textKey: 'tip_psycho_text',
        gradient: 'linear-gradient(135deg, #f2994a 0%, #f2c94c 100%)' // Золотой (Ачивки)
    },
    { 
        id: 'install_guide', 
        icon: '📲', 
        titleKey: 'tip_pwa_title', 
        descKey: 'tip_pwa_desc', 
        textKey: 'tip_pwa_text',
        gradient: 'linear-gradient(135deg, #00f260 0%, #0575E6 100%)' // Яркий Cyan-Blue градиент
    },
    { 
        id: 'mods_guide', 
        icon: '⚙️', 
        titleKey: 'tip_mods_title', 
        descKey: 'tip_mods_desc', 
        textKey: 'tip_mods_text',
        gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' // Фиолетовый
    },
];
    
    const TIPS_CATS = {
        // Техническое: Приложение, оплата, баги, интерфейс, режимы
        tech: ['install_guide', 'mods_guide', 'ads', 'video', 'pay', 'bug', 'panic', 'layout', 'modes', 'sites_guide'],
        // Инфо: Алгоритмы, словари, психология, советы
        info: ['algo_secrets', 'glossary', 'psychotypes', 'intensity']
    };

    // --- WRAPPED DATA & TEXTS ---
    const WRAPPED_CONFIG = {
        badges: {
            en: { daily: "Daily", weekly: "Weekly", monthly: "Monthly", yearly: "Yearly" },
            ru: { daily: "За день", weekly: "Неделя", monthly: "Месяц", yearly: "Итоги года" },
            es: { daily: "Diario", weekly: "Semanal", monthly: "Mensual", yearly: "Anual" },
            de: { daily: "Täglich", weekly: "Wöchentlich", monthly: "Monatlich", yearly: "Jährlich" }
        },
        // Фразы для слайдов (Intro)
        phrases: {
            daily: {
                en: ["Quick check-in? Let's see.", "Another day, another stats.", "Your daily dose of data."],
                ru: ["Быстрая проверка? Смотрим.", "Новый день, новые цифры.", "Твоя дневная доза данных."],
                es: ["¿Chequeo rápido? Veamos.", "Otro día, otras estadísticas.", "Tu dosis diaria de datos."],
                de: ["Kurzer Check? Mal sehen.", "Neuer Tag, neue Daten.", "Deine tägliche Dosis."]
            },
            weekly: {
                en: ["It's been a busy week.", "Seven days of secrets.", "Your week in review."],
                ru: ["Неделька была насыщенной.", "Семь дней секретов.", "Обзор твоей недели."],
                es: ["Ha sido una semana ocupada.", "Siete días de secretos.", "Tu semana en revisión."],
                de: ["Eine arbeitsreiche Woche.", "Sieben Tage voller Geheimnisse.", "Dein Wochenrückblick."]
            },
            monthly: {
                en: ["The month is over. The stats are in.", "30 days of desires.", "Let's look at the bigger picture."],
                ru: ["Месяц позади. Данные собраны.", "30 дней твоих желаний.", "Взглянем на картину целиком."],
                es: ["El mes ha terminado.", "30 días de deseos.", "Miremos el panorama general."],
                de: ["Der Monat ist vorbei.", "30 Tage deiner Wünsche.", "Das große Ganze."]
            },
            yearly: {
                en: ["Your year defined.", "365 days of you.", "The ultimate summary."],
                ru: ["Твой год в цифрах.", "365 дней тебя.", "Финальный отчёт."],
                es: ["Tu año definido.", "365 días de ti.", "El resumen definitivo."],
                de: ["Dein Jahr definiert.", "365 Tage von dir.", "Die ultimative Zusammenfassung."]
            }
        },
        // Достижения (Значки)
        achievements: {
            // Время суток
            morning: { 
                icon: "🌅", 
                en: "Early Bird", ru: "Ранняя пташка", es: "Madrugador", de: "Frühaufsteher",
                desc_en: "You start your day with pleasure.", desc_ru: "Ты начинаешь день с удовольствия.", desc_es: "Empiezas el día con placer.", desc_de: "Du beginnst den Tag mit Vergnügen."
            },
            day: { 
                icon: "☀️", 
                en: "Day Walker", ru: "Дневной житель", es: "Diurno", de: "Tagwanderer",
                desc_en: "Active during business hours.", desc_ru: "Активен в рабочее время.", desc_es: "Activo en horario laboral.", desc_de: "Aktiv während der Geschäftszeiten."
            },
            night: { 
                icon: "🦇", 
                en: "Night Owl", ru: "Полуночник", es: "Nocturno", de: "Nachteule",
                desc_en: "You thrive in the dark.", desc_ru: "Ты расцветаешь в темноте.", desc_es: "Brillas en la oscuridad.", desc_de: "Du blühst im Dunkeln auf."
            },
            // Тип активности
            binger: { 
                icon: "🍿", 
                en: "The Binger", ru: "Зритель", es: "Espectador", de: "Zuschauer",
                desc_en: "High watch time. You love content.", desc_ru: "Много просмотров. Ты любишь контент.", desc_es: "Mucho tiempo viendo.", desc_de: "Viel Zeit beim Zuschauen."
            },
            picky: { 
                icon: "🧐", 
                en: "The Critic", ru: "Критик", es: "Crítico", de: "Kritiker",
                desc_en: "Lots of swipes, few watches.", desc_ru: "Много свайпов, мало просмотров.", desc_es: "Muchos swipes, pocas vistas.", desc_de: "Viele Swipes, wenig angesehen."
            },
            // Стиль (На основе разнообразия тегов)
            explorer: { 
                icon: "🔭", 
                en: "The Explorer", ru: "Исследователь", es: "Explorador", de: "Entdecker",
                desc_en: "You constantly seek new genres.", desc_ru: "Ты постоянно ищешь новые жанры.", desc_es: "Buscas nuevos géneros.", desc_de: "Du suchst ständig neue Genres."
            },
            hedonist: { 
                icon: "🥰", 
                en: "The Hedonist", ru: "Гедонист", es: "Hedonista", de: "Hedonist",
                desc_en: "You stick to what you love.", desc_ru: "Ты верен своим любимым темам.", desc_es: "Te apegas a lo que amas.", desc_de: "Du bleibst bei dem, was du liebst."
            }
        }
    };

    // === КОНФИГУРАЦИЯ ПСИХОТИПОВ ===
    const PSYCHO_TYPES = {
        // 1. По доминирующей оси (10 шт)
        'bdsm': {
            en: "The Kink Master", ru: "Мастер Кинка", es: "Amo del Kink", de: "Kink-Meister",
            desc_en: "Control and sensation are your currency.", desc_ru: "Контроль и ощущения — твоя валюта."
        },
        'roleplay': {
            en: "The Shapeshifter", ru: "Перевертыш", es: "Camaleón", de: "Gestaltwandler",
            desc_en: "You can be anyone for the sake of pleasure.", desc_ru: "Ты можешь быть кем угодно ради удовольствия."
        },
        'humiliation': {
            en: "The Devotee", ru: "Поклонник", es: "Devoto", de: "Der Hingebungsvolle",
            desc_en: "You find strength in surrender.", desc_ru: "Ты находишь силу в капитуляции."
        },
        'public': {
            en: "The Exhibitionist", ru: "Эксгибиционист", es: "Exhibicionista", de: "Exhibitionist",
            desc_en: "The world is your stage.", desc_ru: "Весь мир — твоя сцена."
        },
        'clothing': {
            en: "The Fetishista", ru: "Фетишиста", es: "Fetichista", de: "Fetischista",
            desc_en: "Material matters more than flesh.", desc_ru: "Материал важнее, чем плоть."
        },
        'sensory': {
            en: "The Sensorium", ru: "Сенсорик", es: "Sensorial", de: "Sensoriker",
            desc_en: "Feeling is believing.", desc_ru: "Чувствовать — значит верить."
        },
        'psychological': {
            en: "The Psychonaut", ru: "Психонавт", es: "Psiconauta", de: "Psychonaut",
            desc_en: "It's all in the mind.", desc_ru: "Всё происходит в голове."
        },
        'taboo': {
            en: "The Deviant", ru: "Девиант", es: "Desviado", de: "Abweichler",
            desc_en: "Rules are meant to be broken.", desc_ru: "Правила созданы, чтобы их нарушать."
        },
        'group': {
            en: "The Party Animal", ru: "Тусовщик", es: "Fiestero", de: "Partylöwe",
            desc_en: "The more, the merrier.", desc_ru: "Чем больше, тем веселее."
        },
        'body-part': {
            en: "The Anatomist", ru: "Анатом", es: "Anatomista", de: "Anatom",
            desc_en: "You appreciate the specific details.", desc_ru: "Ты ценишь конкретные детали."
        },

        // 2. Комбинации (10 шт)
        'dark_lord': { // BDSM + Taboo/Humiliation
            en: "The Dark Lord", ru: "Темный Лорд", es: "Señor Oscuro", de: "Dunkler Lord",
            desc_en: "You explore the deepest shadows.", desc_ru: "Ты исследуешь самые глубокие тени."
        },
        'performer': { // Public + Roleplay
            en: "The Performer", ru: "Артист", es: "Artista", de: "Performer",
            desc_en: "Life is a performance.", desc_ru: "Жизнь — это представление."
        },
        'worshipper': { // Body-part + Clothing
            en: "The Idolater", ru: "Идолопоклонник", es: "Idólatra", de: "Götzendiener",
            desc_en: "Specific forms deserve worship.", desc_ru: "Формы заслуживают поклонения."
        },
        'brainwasher': { // Psychological + Humiliation
            en: "The Manipulator", ru: "Манипулятор", es: "Manipulador", de: "Manipulator",
            desc_en: "You play with souls, not bodies.", desc_ru: "Ты играешь с душами, а не телами."
        },
        'risk_taker': { // Public + Taboo
            en: "Adrenaline Junkie", ru: "Адреналинщик", es: "Adicto a Adrenalina", de: "Adrenalin-Junkie",
            desc_en: "Danger is the best spice.", desc_ru: "Опасность — лучшая приправа."
        },
        'orgy_master': { // Group + BDSM/Public
            en: "The Caligula", ru: "Калигула", es: "Calígula", de: "Caligula",
            desc_en: "Chaos and pleasure intertwined.", desc_ru: "Хаос и удовольствие переплетены."
        },
        'immersionist': { // Roleplay + Sensory
            en: "The Immersionist", ru: "Иммерсив", es: "Inmersivo", de: "Immersionist",
            desc_en: "Deep dive into alternate realities.", desc_ru: "Глубокое погружение в иную реальность."
        },
        'collector': { // Разнообразие (много разных)
            en: "The Collector", ru: "Коллекционер", es: "Coleccionista", de: "Sammler",
            desc_en: "You want to try everything once.", desc_ru: "Ты хочешь попробовать всё."
        },
        
        // 3. Дефолтные
        'vanilla': {
            en: "The Classic", ru: "Классик", es: "Clásico", de: "Klassiker",
            desc_en: "Simplicity is the ultimate sophistication.", desc_ru: "Простота — высшая форма утонченности."
        }
    };

    // 10 психологических осей
    const PSYCHO_AXES = [
        'bdsm', 'roleplay', 'humiliation', 'public', 'clothing', 
        'sensory', 'psychological', 'taboo', 'group', 'body-part'
    ];

    // Переводы для графика
    const PSYCHO_LABELS = {
        'bdsm': {en:'BDSM', ru:'БДСМ', es:'BDSM', de:'BDSM'},
        'roleplay': {en:'Roleplay', ru:'Ролевые', es:'Rol', de:'Rollenspiel'},
        'humiliation': {en:'Humiliation', ru:'Унижение', es:'Humillación', de:'Demütigung'},
        'public': {en:'Public', ru:'Публика', es:'Público', de:'Öffentlich'},
        'clothing': {en:'Clothing', ru:'Одежда', es:'Ropa', de:'Kleidung'},
        'sensory': {en:'Sensory', ru:'Сенсорика', es:'Sensorial', de:'Sensorik'},
        'psychological': {en:'Mind', ru:'Психо', es:'Mente', de:'Psyche'},
        'taboo': {en:'Taboo', ru:'Табу', es:'Tabú', de:'Tabu'},
        'group': {en:'Group', ru:'Группа', es:'Grupo', de:'Gruppe'},
        'body-part': {en:'Body', ru:'Тело', es:'Cuerpo', de:'Körper'}
    };

    // Функция локализации для Wrapped
    function getWText(key, subkey) {
        const lang = WRAPPED_CONFIG.badges[currentLang] ? currentLang : 'en';
        if(key === 'badge') return WRAPPED_CONFIG.badges[lang][subkey];
        return "Text";
    }

    const KEYWORD_ALIASES = {
        'redhead': ['ginger', 'firecrotch', 'рыжая', 'рыжие', 'рыжих', 'рыжими', 'pelirroja', 'rothaarige', 'red', 'рыженькая'],
        'blonde': ['blond', 'fair', 'блондинка', 'блондинки', 'блондинок', 'блондинками', 'беленькая', 'rubia', 'blondine'],
        'brunette': ['brown', 'dark hair', 'брюнетка', 'брюнетки', 'черненькая', 'темненькая', 'morena', 'brünette'],
        'anal': ['ass', 'butt', 'анал', 'жопа', 'culo', 'trasero', 'arsch', 'hintern', 'anal'],
        'milf': ['mom', 'mother', 'мамка', 'мать', 'madre', 'mama', 'mutter', 'reif'],
        'teen': ['school', 'student', 'young', '18', 'школьница', 'студентка', 'joven', 'estudiante', 'jung', 'schülerin'],
        'group': ['orgy', 'gangbang', 'threesome', 'групповой', 'оргия', 'trio', 'orgía', 'grupo', 'orgie', 'groupsex', 'dreier'],
        'bdsm': ['rough', 'hard', 'slave', 'bondage', 'жестко', 'грубо', 'бдсм', 'duro', 'esclava', 'hart', 'fesseln', 'domina'],
        'tits': ['big-tits', 'boobs', 'busty', 'сиськи', 'грудь', 'tetas', 'pechos', 'titten', 'große'],
        'feet': ['foot', 'toes', 'ноги', 'ступни', 'pies', 'patas', 'füße', 'fuss'],
        'lesbian': ['girl-on-girl', 'tribadism', 'лесби', 'ножницы', 'lesbiana', 'tijeras', 'lesbisch'],
        'cum': ['creampie', 'facial', 'сперма', 'кончил', 'leche', 'corrida', 'sperma', 'besamung']
    };

    const CONTEXT_TRIGGERS = {
        'harder': [
            'harder', 'rougher', 'extreme', 'more intense', // EN
            'жестче', 'грубее', 'сильнее', 'пожестче', // RU
            'mas duro', 'más fuerte', 'intenso', 'violento', // ES
            'härter', 'stärker', 'intensiver', 'wilder' // DE
        ],
        'softer': [
            'softer', 'gentle', 'vanilla', 'less intense', // EN
            'мягче', 'нежнее', 'ваниль', 'полегче', // RU
            'suave', 'lento', 'cariñoso', 'mas suave', // ES
            'sanfter', 'weicher', 'zärtlich', 'ruhiger' // DE
        ],
        'more': [
            'more', 'another', 'else', 'similar', // EN
            'еще', 'другое', 'похожее', // RU
            'mas', 'otro', 'quiero mas', // ES
            'mehr', 'noch eins', 'anderes' // DE
        ]
    };
    
    const THINKING_STEPS = {
        en: ["Analyzing preferences...", "Checking history...", "Filtering tags...", "Selecting best match..."],
        ru: ["Анализирую вкусы...", "Сверяю с историей...", "Отсеиваю лишнее...", "Выбираю лучшее..."],
        es: ["Analizando gustos...", "Revisando historial...", "Filtrando etiquetas...", "Seleccionando..."],
        de: ["Analysiere...", "Prüfe Verlauf...", "Filtere Tags...", "Wähle aus..."]
    };

    window.openLegal = function(type) {
        // 1. Берем текущие переводы из langData
        const t = langData[currentLang] || langData['en'];

        let titleText = "Document";
        let bodyHTML = "<p>Loading...</p>";

        // 2. Выбираем текст в зависимости от типа
        if (type === 'terms') {
            titleText = t.doc_terms;
            bodyHTML = t.terms_text;
        } 
        else if (type === 'privacy') {
            titleText = t.doc_privacy;
            bodyHTML = t.privacy_text;
        } 
        else if (type === 'refund') {
            titleText = t.doc_refund;
            bodyHTML = t.refund_text;
        }

        // 3. Заполняем модальное окно
        const titleEl = document.getElementById('legal-modal-title');
        const contentEl = document.getElementById('legal-modal-content');
        
        if (titleEl) titleEl.innerText = titleText;
        if (contentEl) contentEl.innerHTML = bodyHTML;

        // 4. Открываем
        const modal = document.getElementById('modal-legal-overlay');
        if(modal) {
            modal.classList.add('open');
            modal.style.display = 'flex';
        }
    };

    window.closeLegal = function(e, force) {
        if (force || e.target.id === 'modal-legal-overlay') {
            const modal = document.getElementById('modal-legal-overlay');
            if(modal) {
                modal.classList.remove('open');
                modal.style.display = 'none';
            }
        }
    };

    const EXTREME_TAGS = ['extreme', 'blood', 'scat', 'piss', 'pain', 'torture', 'vomit', 'enema', 'fisting', 'needle-play'];
    const SPICY_TAGS = ['bdsm', 'kinky', 'fetish', 'bondage', 'domination', 'submission', 'spanking'];
    const LGBT_TAGS = ['gay', 'trans', 'shemale', 'bi', 'crossdresser'];

    const filterCats = [
        { id: 'straight', key: 'tag_straight' },
        { id: 'gay', key: 'tag_gay' },
        { id: 'lesbian', key: 'tag_lesbian' },
        { id: 'trans', key: 'tag_trans' }
    ];

    window.onload = async () => {
        initLanguage();
        initTheme();
        initIntensity();
        initDecoSettings();
        randomizeDecorations();
        renderModifiers();
        renderHistory();
        updateCounts();
        syncScoresFromLists(); 
        
        // 2. Инициализация систем
        initAgeGate();
        initSwipeCards();

        const wrapper = document.getElementById('card-anim-wrapper');
            if (wrapper) {
                wrapper.style.opacity = '0'; // Скрываем всю обертку
                
                const cardBlock = document.getElementById('card-block');
                if(cardBlock) cardBlock.classList.add('card-content-hidden');
            }
        
        // 3. Установка платформы
        const savedPlatform = localStorage.getItem('xch_platform');
        if (savedPlatform) {
            const platformSelect = document.getElementById('platform');
            if (platformSelect) platformSelect.value = savedPlatform;
        }
        updateLink();

        // 4. Текст и Анимация слота
        setWelcomeMessage(); 
        
        // Сброс флага первой генерации
        isFirstGen = true; 
        
        // Запуск "холостого хода" слота (бегущая строка)
        initIdleSlot(); 

        updateSubscriptionUI();
        
        // 5. Инициализация Ориентации
        const oriSelect = document.getElementById('orientation-select');
        if (oriSelect) oriSelect.value = currentOrientation;

        // 6. Верстка (в самом конце, чтобы всё уже было готово)
        checkLayout(); 
        window.addEventListener('resize', checkLayout);
        
        // Принудительно ставим класс для мобильной шапки
        document.body.classList.add('tab-home-active');

       const bar = document.getElementById('loader-bar');
        const text = document.getElementById('loader-phrase');
        if (bar) bar.style.width = '100%';
        if (text) text.innerText = "Ready.";

        if (window.loaderIntervals) {
            clearInterval(window.loaderIntervals.phrase);
            clearInterval(window.loaderIntervals.progress);
        }

        // Задержка перед исчезновением экрана (600мс)
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            
            if (overlay) {
                // 1. Лоадер исчезает
                overlay.classList.add('hidden');
                setTimeout(() => overlay.style.display = 'none', 500);
                
                // 2. ЗАПУСК АНИМАЦИИ КАРТОЧКИ (через 100мс после начала исчезновения лоадера)
                setTimeout(() => {
                    const wrapper = document.getElementById('card-anim-wrapper');
                    const cardBlock = document.getElementById('card-block');
                    
                    if (wrapper) {
                        wrapper.style.opacity = '1'; // Показываем обертку
                        wrapper.classList.add('anim-initial-pop'); // Карточка выпрыгивает
                    }

                    // 3. ЗАПУСК ВНУТРЕННИХ ЭЛЕМЕНТОВ (Stagger)
                    if (cardBlock) {
                        // Убираем класс скрытия, чтобы сработали CSS animation-delay (stagger-item)
                        cardBlock.classList.remove('card-content-hidden');
                        
                        // Перезапускаем анимации stagger-item вручную для надежности
                        const elements = cardBlock.querySelectorAll('.stagger-item');
                        elements.forEach(el => {
                            el.style.animation = 'none';
                            el.offsetHeight; /* trigger reflow */
                            el.style.animation = ''; 
                        });
                    }
                }, 100);
            }
        }, 600);
    };

    async function loadData() {
        try {
            // Пытаемся загрузить JSON файл (1200+ фетишей)
            const response = await fetch('data.json');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Парсим JSON в переменную data
            data = await response.json();
            console.log(`Успешно загружено ${data.length} категорий.`);

            // 3. Запускаем инициализацию приложения ТОЛЬКО после загрузки данных
            initApp();

        } catch (error) {
            console.error('Ошибка загрузки data.json:', error);
            document.body.innerHTML = '<h2 style="color:white;text-align:center;margin-top:50px;">Error loading data.json. Check console.</h2>';
        }
    }

    function initApp() {
        // Инициализация данных
        initLanguage();
        initTheme();
        initIntensity();
        randomizeDecorations(); 
        renderModifiers();
        renderHistory();
        updateCounts();
        
        // Инициализация систем
        initAgeGate();
        initSwipeCards();
        initModes();
        updateNavIcons('home');
        
        // Установка платформы
        const savedPlatform = localStorage.getItem('xch_platform');
        if (savedPlatform) {
            const platformSelect = document.getElementById('platform');
            if (platformSelect) platformSelect.value = savedPlatform;
        }
        updateLink();

        // Текст и Анимация слота
        setWelcomeMessage(); 
        
        isFirstGen = true; 
        
        // Запуск "холостого хода"
        initIdleSlot(); 

        updateSubscriptionUI();

        checkTipIcons();
        
        // Инициализация Ориентации
        const oriSelect = document.getElementById('orientation-select');
        if (oriSelect) oriSelect.value = currentOrientation;

        // Верстка
        checkLayout(); 
        window.addEventListener('resize', checkLayout);

        if (permanentExplored.size === 0 && activityLog.length > 0) {
            // Миграция: Заполняем вечную память из существующего лога
            activityLog.forEach(log => permanentExplored.add(log.id));
            localStorage.setItem('xch_permanent_explored', JSON.stringify([...permanentExplored]));
        }
        
        document.body.classList.add('tab-home-active');
        setTimeout(() => {
            document.getElementById('loading-overlay').classList.add('hidden');
        }, 500); 
    }

    window.onload = loadData;

    function setWelcomeMessage() {
        const statusEl = document.getElementById('status-text');
        if(!statusEl) return;
        
        const phrases = welcomePhrases[currentLang];
        // Ставим случайную фразу и делаем цвет акцентным
        statusEl.innerText = phrases[Math.floor(Math.random() * phrases.length)];
        statusEl.style.color = "var(--accent)"; 
    }

    function logActivity(type, itemId, tags) {
        const logEntry = {
            type: type,
            id: itemId,
            tags: tags || [],
            ts: Date.now()
        };
        
        // 1. Старый лог (последние 5000 действий)
        activityLog.push(logEntry);
        if (activityLog.length > 5000) activityLog = activityLog.slice(-5000);
        localStorage.setItem(STORAGE.ACTIVITY_LOG, JSON.stringify(activityLog));
        
        // 2. ВЕЧНАЯ ПАМЯТЬ (Только ID, никогда не удаляем)
        if (!permanentExplored.has(itemId)) {
            permanentExplored.add(itemId);
            // Преобразуем Set в Array для сохранения
            localStorage.setItem('xch_permanent_explored', JSON.stringify([...permanentExplored]));
            updateExploredCount(); // Обновляем цифры на кнопке
        }
        
        markDayActive();
        if (window.markDirty) window.markDirty(); 
    }

    // 1. Обновленная функция подсчета (только цифры на кнопке)
    function updateExploredCount() {
        const total = (typeof data !== 'undefined') ? data.length : 0;
        // Считаем размер вечного сета
        const uniqueExplored = permanentExplored.size;
        
        const displayEl = document.getElementById('ex-total-display');
        if (displayEl) {
            displayEl.innerText = `${uniqueExplored} / ${total}`;
        }
    }

    // 2. Открытие модального окна и рендер карточек
    function openExploredModal() {
        const grid = document.getElementById('explored-grid');
        grid.innerHTML = '';
        
        const t = langData[currentLang] || langData['en'];
        
        const subTitleEl = document.querySelector('#modal-explored-overlay .modal-subtitle');
        if (subTitleEl) {
            subTitleEl.innerText = t.explored_subtitle || "Here are the achievements you need to get 'Platinum' 😈";
        }

        const exploredIds = permanentExplored; 

        // ЭТАП 1: Подготовка данных (Считаем проценты и даты для всех групп)
        const groupsWithStats = EXPLORED_GROUPS.map(group => {
            // 1. Ищем все видео группы
            const groupItems = data.filter(item => 
                item.tags.some(tag => group.tags.includes(tag))
            );
            
            const totalCount = groupItems.length;
            // Если в группе нет видео (на всякий случай), возвращаем нули
            if (totalCount === 0) return { ...group, percent: 0, count: 0, total: 0, dateTs: Infinity, dateStr: "" };

            // 2. Считаем прогресс
            const exploredCount = groupItems.filter(item => exploredIds.has(item.id)).length;
            const percent = Math.round((exploredCount / totalCount) * 100);
            
            // 3. Логика даты (для сортировки и отображения)
            let dateStr = "";
            let dateTs = Infinity; // По умолчанию "бесконечность", чтобы незавершенные были в конце при сортировке по дате

            if (percent === 100) {
                // Пробуем достать дату из памяти
                if (achievementDates[group.id]) {
                    dateStr = achievementDates[group.id];
                } else {
                    // Если даты нет, но 100% — сохраняем текущую
                    const now = new Date();
                    dateStr = now.toLocaleDateString();
                    achievementDates[group.id] = dateStr;
                    localStorage.setItem('xch_achievement_dates', JSON.stringify(achievementDates));
                }

                // Пытаемся превратить дату "DD.MM.YYYY" в число для правильной сортировки
                // Если формат другой (зависит от локали), Date.parse может справиться или нет
                // Для надежности пробуем разбить по точкам (формат RU/DE)
                const parts = dateStr.split('.');
                if (parts.length === 3) {
                    // new Date(year, monthIndex, day)
                    dateTs = new Date(parts[2], parts[1] - 1, parts[0]).getTime();
                } else {
                    // Фоллбэк на стандартный парсинг
                    dateTs = Date.parse(dateStr) || Date.now();
                }
            }

            return {
                ...group,
                percent,
                count: exploredCount,
                total: totalCount,
                dateStr,
                dateTs
            };
        });

        // ЭТАП 2: Сортировка
        groupsWithStats.sort((a, b) => {
            // Правило 1: "general" (База) ВСЕГДА первая
            if (a.id === 'general') return -1;
            if (b.id === 'general') return 1;

            const aDone = a.percent === 100;
            const bDone = b.percent === 100;

            // Правило 2: Завершенные (100%) выше незавершенных
            if (aDone && !bDone) return -1;
            if (!aDone && bDone) return 1;

            // Правило 3: Если ОБА завершены -> Сортируем по дате (кто раньше, тот выше)
            if (aDone && bDone) {
                return a.dateTs - b.dateTs; // От меньшего (старого) к большему (новому)
            }

            // Правило 4: Если ОБА НЕ завершены -> Сортируем по проценту (наиболее заполненные выше)
            return b.percent - a.percent;
        });

        // ЭТАП 3: Отрисовка
        groupsWithStats.forEach(stats => {
            if (stats.total === 0) return; // Пропускаем пустые группы

            // Иконка
            let iconSrc = 'logo_icon.png';
            if (TAG_ICONS[stats.iconTag] && TAG_ICONS[stats.iconTag][0]) {
                iconSrc = TAG_ICONS[stats.iconTag][0];
            } else if (TAG_ICONS['general'] && TAG_ICONS['general'][0]) {
                iconSrc = TAG_ICONS['general'][0];
            }

            // Название
            const displayTitle = t['cat_' + stats.id] || stats.id.toUpperCase();
            const unlockedLabel = t.unlocked_on || "Unlocked:"; 
            const isCompleted = stats.percent === 100;

            // HTML Карточки
            const card = document.createElement('div');
            card.className = `ex-card ${isCompleted ? 'completed' : ''}`;
            
            card.innerHTML = `
                <img src="${iconSrc}" class="ex-card-icon" alt="${stats.id}">
                <div class="ex-card-title">${displayTitle}</div>
                
                <div class="ex-progress-track">
                    <div class="ex-progress-fill" style="width: ${stats.percent}%"></div>
                </div>
                
                <div class="ex-card-stats">
                    ${stats.count} / ${stats.total} (${stats.percent}%)
                </div>
                
                <!-- БЛОК С ДАТОЙ -->
                <div class="ex-date">
                    ${isCompleted ? `🏆 ${unlockedLabel} ${stats.dateStr}` : ''}
                </div>
            `;
            
            card.onclick = () => {
                closeExploredModal(null, true);
                if (typeof searchByTag === 'function') searchByTag(stats.iconTag);
            };

            grid.appendChild(card);
        });

        document.getElementById('modal-explored-overlay').classList.add('open');
    }

    function closeExploredModal(e, force) {
        if (force || e.target.id === 'modal-explored-overlay') {
            document.getElementById('modal-explored-overlay').classList.remove('open');
        }
    }

    function adjustTagScoresByTags(tags, delta) {
        if (!tags) return;
        
        // Time Decay
        for (let key in tagScores) {
            if (tagScores[key] > 0) tagScores[key] *= TAG_DECAY_RATE;
        }

        const ignore = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd', 'kinky', 'fetish'];
        
        tags.forEach(tag => {
            if (ignore.includes(tag)) return;

            if (!tagScores[tag]) tagScores[tag] = 0;
            
            // Добавляем вес
            tagScores[tag] += delta;

            // Кэппинг
            if (tagScores[tag] > 100) tagScores[tag] = 100;
            if (tagScores[tag] < -100) tagScores[tag] = -100;
        });

        localStorage.setItem(STORAGE.TAG_SCORES, JSON.stringify(tagScores));
    }

    function adjustTagScores(item, delta) {
        if (!item) return;
        const tags = getCombinedTags(item);
        adjustTagScoresByTags(tags, delta);
    }

    function calculateItemWeight(item) {
        // 1. Базовые проверки (ЧС и Кулдаун)
        if (blacklist.includes(item.id)) return 0;
        if (cooldownList.includes(item.id)) return 0.1;

        let score = 50; 
        
        // Определяем тип контента
        const isGeneral = item.tags.includes('general');
        const isSpecific = item.tags.includes('specific');

        // Считаем общее количество действий пользователя (лайки + дизлайки)
        const totalInteractions = favorites.length + blacklist.length;

        // === ЛОГИКА ВОРОНКИ ===

        if (isGeneral) {
            // Базовый буст для общих категорий
            score += 100; 

            // Если пользователь новичок (< 30 действий), сильно пушим General,
            // чтобы быстрее понять его вкусы
            if (totalInteractions < 30) {
                score += 200;
            }
        }

        // Считаем совпадения по тегам из истории
        let historyScore = 0;
        let knownTagsCount = 0;

        item.tags.forEach(tag => {
            // Игнорируем технические теги при подсчете очков
            if (['general', 'specific'].includes(tag)) return;

            if (tagScores[tag]) {
                historyScore += tagScores[tag];
                if (tagScores[tag] > 5) knownTagsCount++; // Тег, который пользователю точно нравится
            }
        });

        score += historyScore;

        // ЛОГИКА SPECIFIC:
        // Если это специфичный фетиш, но мы НЕ знаем, нравятся ли пользователю входящие в него теги,
        // мы занижаем вероятность. (Например, не показывать "Fisting", если мы не знаем, нравится ли "Anal")
        if (isSpecific) {
            if (knownTagsCount === 0) {
                // Если нет ни одного "любимого" тега внутри этого Specific -> штрафуем
                score -= 150;
            } else {
                // Если есть совпадения, Specific получает бонус, так как это точное попадание
                score += 50;
            }
        }

        // === РЕЖИМЫ ===
        if (currentAppMode === 'pleasure') {
            if (favorites.includes(item.id)) score += 1000;
            // В режиме удовольствия Specific ценится выше, если он совпадает со вкусами
            if (isSpecific && knownTagsCount > 0) score += 200; 
            score += (historyScore * 2); // Усиливаем влияние истории
        } 
        else if (currentAppMode === 'ai') {
            // Логика AI контекста 
            if (aiContextTokens.length > 0) {
                const itemString = [item.name, item.slug, ...item.tags].join(" ").toLowerCase();
                aiContextTokens.forEach(token => {
                    if (itemString.includes(token)) score += 500;
                });
            }
            if (favorites.includes(item.id)) score += 200;
            score += historyScore;
        }
        else {
            // Режим Explore (по умолчанию)
            if (favorites.includes(item.id)) score = 1; // Убираем уже лайкнутое
            score += Math.random() * 50; // Немного рандома
        }

        // === ОРИЕНТАЦИЯ ===
        if (currentOrientation === 'gay' && item.tags.includes('gay')) score += 100;
        if (currentOrientation === 'trans' && item.tags.some(t => ['trans', 'shemale', 'crossdresser'].includes(t))) score += 100;
        if (currentOrientation === 'lesbian' && item.tags.includes('lesbian')) score += 100;
        
        // Жесткий штраф за несовпадение ориентации
        if (currentOrientation === 'gay' && item.tags.includes('straight')) score -= 5000;
        if (currentOrientation === 'hetero' && (item.tags.includes('gay') || item.tags.includes('shemale'))) score -= 5000;

        return Math.max(1, score);
    }

    function getWeightedRandom(items) {
        // Шаг 1: Считаем веса
        let weightedItems = items.map(item => {
            return { item: item, weight: calculateItemWeight(item) };
        });

        // Шаг 2: Убираем совсем неподходящие (вес <= 1)
        // Но оставляем хотя бы что-то, если все отфильтровались
        let candidates = weightedItems.filter(i => i.weight > 1);
        if (candidates.length === 0) candidates = weightedItems;

        // Шаг 3: Exploration vs Exploitation (Исследование или Использование)
        // С шансом 20% мы игнорируем веса и берем случайное из топа 50% (чтобы подкинуть новое)
        const isExploration = Math.random() < 0.2; 

        if (isExploration && candidates.length > 5) {
            // Берем случайный из первой половины списка (но не обязательно лучший)
            // Сортируем по весу
            candidates.sort((a, b) => b.weight - a.weight);
            // Отрезаем топ 50%
            const sliceIndex = Math.floor(candidates.length / 2);
            const pool = candidates.slice(0, sliceIndex);
            return pool[Math.floor(Math.random() * pool.length)].item;
        }

        // Шаг 4: Классическая рулетка (Exploitation)
        let totalWeight = candidates.reduce((sum, i) => sum + i.weight, 0);
        let random = Math.random() * totalWeight;
        
        for (const candidate of candidates) {
            if (random < candidate.weight) return candidate.item;
            random -= candidate.weight;
        }

        return candidates[0].item;
    }

    function resetControls() {
        document.querySelector('.gen-controls').classList.remove('visually-hidden');
        document.getElementById('mods-block').classList.remove('visually-hidden');
        document.getElementById('card-block').classList.remove('is-spinning');
    }

    function getExplanationText(mode) {
        const t = langData[currentLang];
        let reason = null;

        if (mode === 'panic') {
            // Берем нейтральные фразы
            const phrases = t.panic_active_phrases || ["Nothing to see here 😇"];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }

        // 1. Напоминание посмотреть/повторить/одуматься
        else if (mode === 'wl_reminder') {
            const phrases = wlReminderPhrases[currentLang] || wlReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        else if (mode === 'fav_reminder') {
            const phrases = favReminderPhrases[currentLang] || favReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        else if (mode === 'ban_reminder') {
            const phrases = banReminderPhrases[currentLang] || banReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        // 2. Возврат (Кнопка Undo)
        else if (mode === 'undo') {
            reason = t.expl_undo; 
        }
        // 3. История (Клик из списка)
        else if (mode === 'history') {
            reason = t.expl_hist;
        }
        // 4. Похожее (Кнопка Similar)
        else if (mode === 'similar') {
            reason = t.expl_sim;
        } 
        // 5. Клик по тегу (В каталоге)
        else if (mode === 'tag_click') {
            reason = t.expl_tag_click; 
        } 
        // 6. Обычная генерация (Smart / Random)
        else {
            // === УМНЫЙ ПОИСК ПРИЧИНЫ ===
            let bestTag = null;
            let maxScore = 0;
            
            const ignoreTags = ['universal', 'straight', 'gay', 'lesbian', 'trans', 'bi', 'male', 'female'];
            
            currentItem.tags.forEach(tag => {
                if (!ignoreTags.includes(tag) && tagScores[tag] && tagScores[tag] > 5) {
                    if (tagScores[tag] > maxScore) {
                        maxScore = tagScores[tag];
                        bestTag = tag;
                    }
                }
            });
            
            if (bestTag) {
                // Ищем В ИСТОРИИ или ЛАЙКАХ предмет с этим тегом
                let sourceItem = null;
                if (favorites.length > 0) {
                    const favItem = favorites.map(id => data.find(x => x.id === id)).find(item => item && item.tags.includes(bestTag));
                    if (favItem) sourceItem = favItem;
                }
                
                if (!sourceItem && historyData.length > 0) {
                    const histItem = historyData.map(h => data.find(x => x.id === h.id)).find(item => item && item.id !== currentItem.id && item.tags.includes(bestTag));
                    if (histItem) sourceItem = histItem;
                }

                if (sourceItem) {
                    const reasonName = getLocalizedName(sourceItem);
                    reason = t.expl_score + reasonName; 
                } else {
                    let displayTag = bestTag.charAt(0).toUpperCase() + bestTag.slice(1);
                    reason = t.expl_score + displayTag; 
                }
            }
            else if (favorites.includes(currentItem.id)) {
                reason = t.expl_fav; // "Потому что ты любишь это"
            }
        }
        return reason;
    }

    function prepareElementsForFadeIn() {
        // Убрали старые ID, добавили status-text
        const ids = ['result-desc', 'status-text', 'related-block']; 
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('fade-visible');
                el.classList.add('fade-hidden');
            }
        });
    }

    function finishGeneration(item, mode) {
        isGenerating = false;

        // Проверяем текущую настройку
        const currentPlatformPref = document.getElementById('platform') ? document.getElementById('platform').value : 'xh';
        
        // Если стоит "Random" и у предмета еще нет закрепленного сайта
        if (currentPlatformPref === 'random' && !item.assignedPlatform) {
            const sites = ['xh', 'ph', 'xv', 'sb', 'yp', 'rt'];
            item.assignedPlatform = sites[Math.floor(Math.random() * sites.length)];
        }
        
        if (isPanicMode || mode === 'panic') {
            const card = document.getElementById('card-block');
            if(card) card.classList.add('has-results');
            updateCardStatusVisuals(); 
            renderResultUI(item, mode);
            return;
        }

        addToHistory(item); 

        cooldownList.push(item.id);
        if (cooldownList.length > COOLDOWN_SIZE) {
            cooldownList.shift();
        }

        logActivity('gen', item.id, item.tags);
        
        const card = document.getElementById('card-block');
        if(card) {
            card.classList.add('has-results');
        }

        renderResultUI(item, mode);
    }

    function forceShowResult(item, mode = 'history', customStatus = null) {
    if (mode !== 'ai_request') {
        activeMods.clear();
        
        if (currentOrientation === 'gay') activeMods.add('Gay');
        else if (currentOrientation === 'trans') activeMods.add('Trans');
    } 
        isGenerating = false;
        
        // 1. ОТКЛЮЧАЕМ СТАРТОВЫЙ РЕЖИМ
        isFirstGen = false; 
        hasInteractedWithCurrent = false; 
        hasWatchedCurrentItem = false; 
        // Важно: отключаем режим выбора, чтобы свайпы работали как Лайк/Дизлайк
        isModeSelectionActive = false; 

        // === ОЧИСТКА НАЧАЛЬНОГО ЭКРАНА ===
        const startOverlay = document.getElementById('mode-start-overlay');
        const assistantUI = document.getElementById('assistant-ui');
        const thinkingUI = document.getElementById('thinking-ui');
        const startBtn = document.getElementById('start-btn-container');

        // Жестко скрываем оверлей с треугольником
        if (startOverlay) {
            startOverlay.classList.add('hidden');
            startOverlay.style.display = 'none'; // Принудительно
            startOverlay.style.opacity = '0';
            startOverlay.style.pointerEvents = 'none';
        }
        
        // Скрываем UI ассистента и думания (на случай если остались)
        if (assistantUI) assistantUI.classList.remove('visible');
        if (thinkingUI) thinkingUI.style.display = 'none';

        // Скрываем старую кнопку "Поехали"
        if (startBtn) {
            startBtn.classList.add('hidden-initial');
            startBtn.style.display = 'none';
        }
        // ========================================================

        // 2. СБРОС СЛОТ-МАШИНЫ (Убираем бегущую строку Idle)
        const reel = document.getElementById('slot-reel');
        if (reel) {
            reel.className = 'slot-reel'; // Убираем класс 'idle'
            reel.style.transform = '';    // Сбрасываем позицию
            reel.innerHTML = '';          // Очищаем старый текст
        }

        // 3. АНИМАЦИЯ ПОЯВЛЕНИЯ КАРТОЧКИ
        const wrapper = document.getElementById('card-anim-wrapper');
        if(wrapper) {
            wrapper.style.transform = '';
            wrapper.style.opacity = '1';
            
            // Если это не прямой ввод (а например из истории), делаем анимацию
            if (mode !== 'ai_request') {
                wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
                void wrapper.offsetWidth; // Триггер перерисовки
                wrapper.classList.add('anim-fly-left');
            }
        }

        // 4. СКРОЛЛ НАВЕРХ
        const mainContent = document.querySelector('.main-content') || document.querySelector('.tab-content.active');
        if(mainContent) mainContent.scrollTop = 0;
        
        // Логика истории
        addToHistory(item);
        logActivity('gen', item.id, item.tags);

        // 5. РЕНДЕР
        renderResultUI(item, mode, customStatus);
        
        // Снимаем класс анимации через секунду
        setTimeout(() => {
            if(wrapper) wrapper.classList.remove('anim-fly-left');
        }, 800);
    }

    function renderBadges() {
        const badgeWrapper = document.getElementById('badge-wrapper');
        badgeWrapper.innerHTML = '';
        const t = langData[currentLang];
        
        const safetyTags = ['straight', 'universal', 'vanilla'];
        const isSafe = currentItem.tags.some(t => safetyTags.includes(t));
        const isExtreme = currentItem.tags.some(t => EXTREME_TAGS.includes(t));
        const isBDSM = currentItem.tags.includes('bdsm') || currentItem.tags.includes('bondage');
        const hasLgbtTag = currentItem.tags.some(t => ['gay','trans','shemale','lesbian', 'bi'].includes(t));
        const showLgbt = hasLgbtTag && !isSafe;
        const isNiche = currentItem.tags.includes('fetish') || currentItem.tags.includes('scat');

        // Функция для создания HTML бейджа с тултипом
        const createBadge = (className, label, desc) => {
            return `
                <div class="warning-badge ${className}" style="position:relative; overflow:visible; cursor:help;">
                    ${label}
                    <div class="badge-tooltip">${desc}</div>
                </div>
            `;
        };

        // Логика добавления бейджей (теперь с тултипами внутри)
        // Добавляем класс 'has-tooltip' для обработки кликов на мобильных (опционально через CSS :hover)
        
        if(isExtreme) { 
            badgeWrapper.innerHTML += createBadge('badge-extreme', t.badge_extreme, t.badge_desc_extreme);
        }
        else if(isBDSM) { 
            badgeWrapper.innerHTML += createBadge('', t.badge_bdsm, t.badge_desc_bdsm); // Default dark style
            // Добавим стиль для BDSM если его нет в CSS
            badgeWrapper.lastElementChild.style.background = "#333";
        }
        else if(showLgbt) { 
            badgeWrapper.innerHTML += createBadge('badge-lgbt', t.badge_lgbt, t.badge_desc_lgbt);
        }
        else if(isNiche) {
            badgeWrapper.innerHTML += createBadge('badge-niche', t.badge_niche, t.badge_desc_niche);
        }
    }

    function renderExplanation(mode) {
        const explText = document.getElementById('explanation-text');
        const t = langData[currentLang];
        let reason = "";

        if (mode === 'similar') {
            reason = t.expl_sim;
        } else if (mode === 'tag_click') {
            reason = t.expl_tag_click; 
        } else {
            let bestTag = null;
            let maxScore = 0;
            currentItem.tags.forEach(tag => {
                if (tagScores[tag] && tagScores[tag] > 5) {
                    if (tagScores[tag] > maxScore) {
                        maxScore = tagScores[tag];
                        bestTag = tag;
                    }
                }
            });
            if (bestTag) reason = t.expl_score + bestTag;
            else if (favorites.includes(currentItem.id)) reason = t.expl_fav;
        }
        explText.innerText = reason;
    }

    function renderRelatedItems() {
        const relatedEl = document.getElementById('related-tags');
        const relatedBlock = document.getElementById('related-block');
        const btnSimilar = document.getElementById('btn-similar');
        
        relatedEl.innerHTML = '';

        if (isPanicMode) {
            // Если мы в панике, берем теги из текущего безопасного задания
            if (currentItem && currentItem.tags) {
                currentItem.tags.forEach(tag => {
                    const btn = document.createElement('div');
                    btn.className = 'related-item-btn';
                    btn.innerText = tag;
                    // Клик генерирует новую БЕЗОПАСНУЮ карточку
                    btn.onclick = () => generatePanicCard('next');
                    relatedEl.appendChild(btn);
                });
            }
            
            // Показываем блок
            relatedBlock.classList.remove('hidden-initial');
            relatedBlock.classList.add('fade-visible');
            
            // Скрываем кнопку "Похожее" из нижней панели (если она там есть), 
            // так как в панике мы используем только теги
            if(btnSimilar) btnSimilar.style.display = 'none';
            
            return;
        }
        
        // 1. Хелпер для токенов (слов)
        const getTokens = (text) => {
            if (!text) return [];
            const stopWords = [
                'the', 'and', 'or', 'of', 'in', 'on', 'at', 'to', 'a', 'an', 'is', 'are', 
                'for', 'with', 'by', 'from', 'using', 'being', 'getting', 'into', 'over', 'sex',
                'video', 'movie', 'porn', 'compilation'
            ];
            return text.toLowerCase()
                      .split(/[\s/\-(),.]+/g)
                      .filter(w => w.length > 2 && !stopWords.includes(w));
        };

        const currentTokens = new Set([
            ...getTokens(currentItem.name),
            ...getTokens(currentItem.desc_en)
        ]);

        // 2. Определение пола текущего предмета (Гендерный щит)
        const maleTags = ['gay', 'male', 'man', 'boy', 'bear', 'twink', 'jock', 'dick', 'cock', 'father', 'grandpa'];
        const femaleTags = ['female', 'woman', 'girl', 'lesbian', 'milf', 'mom', 'sister', 'pussy', 'tits', 'boobs', 'vagina'];
        
        const isCurrentMale = currentItem.tags.some(t => maleTags.includes(t));
        const isCurrentFemale = currentItem.tags.some(t => femaleTags.includes(t));

        let candidates = data.map(item => {
            if (item.id === currentItem.id) return null;

            // === БАЗОВЫЕ ФИЛЬТРЫ (Как и раньше) ===
            if (currentIntensity === 1) { 
                if (item.tags.some(t => EXTREME_TAGS.includes(t) || SPICY_TAGS.includes(t))) return null;
            } else if (currentIntensity === 2) { 
                if (item.tags.some(t => EXTREME_TAGS.includes(t))) return null;
            }

            // === ФИЛЬТР ОРИЕНТАЦИИ ДЛЯ ПОХОЖИХ ===
            // Если мы в режиме Гей, не показываем Лесби/Гетеро в похожих, даже если теги совпадают
            const itemIsGay = item.tags.includes('gay');
            const itemIsStraight = item.tags.includes('straight');
            const itemIsLesbian = item.tags.includes('lesbian');
            
            if (currentOrientation === 'gay' && !itemIsGay) return null;
            if (currentOrientation === 'hetero' && itemIsGay) return null;

            // === ГЕНДЕРНЫЙ ЩИТ (Gender Guard) ===
            // Если текущий предмет МУЖСКОЙ (напр. Bear), штрафуем ЖЕНСКИЕ (напр. SSBBW), даже если у них общий тег "Fat"
            const itemIsMale = item.tags.some(t => maleTags.includes(t));
            const itemIsFemale = item.tags.some(t => femaleTags.includes(t));

            if (isCurrentMale && !isCurrentFemale && itemIsFemale) return null; // Ищем мужское, убираем женское
            if (isCurrentFemale && !isCurrentMale && itemIsMale) return null; // Ищем женское, убираем мужское

            // === ПОДСЧЕТ ОЧКОВ ===
            let score = 0;

            // А. Текст (вес: 5)
            const candidateTokens = [...getTokens(item.name), ...getTokens(item.desc_en)];
            let textMatches = 0;
            candidateTokens.forEach(token => {
                if (currentTokens.has(token)) textMatches++;
            });
            score += textMatches * 5;

            // Б. Теги (Вес: 10 за редкие, 0 за мусорные)
            const trashTags = [
                'general', 'specific',
                'universal', 'straight', 'gay', 'lesbian', 'bi', 'male', 'female', 'adult', 
                'roleplay', 'video', 'hd', 'soft', 'hardcore', 'fetish', 'kinky', 'fantasy',
                'body-part', 'action', 'hair'
            ];

            item.tags.forEach(tag => {
                if (currentItem.tags.includes(tag)) {
                    if (!trashTags.includes(tag)) {
                        score += 15; // Увеличили вес совпадения специфичных тегов
                    }
                }
            });

            // Если очков мало - это случайное совпадение, убираем
            if (score < 5) return null;

            return { item: item, score: score };
        }).filter(x => x !== null);

        candidates.sort((a, b) => b.score - a.score);
        const topCandidates = candidates.slice(0, 5);

        if (topCandidates.length > 0) {
            topCandidates.forEach(cand => {
                const item = cand.item;
                const name = getLocalizedName(item);
                const btn = document.createElement('div');
                btn.className = 'related-item-btn';
                btn.innerText = name;
                
                btn.onclick = () => {
                    // Сначала проверяем лимит
                    if (checkGenerationLimit()) {
                        // Если ок — открываем
                        forceShowResult(item, 'similar');
                    }
                };
                
                relatedEl.appendChild(btn);
            });
            relatedBlock.classList.remove('hidden-initial');
            relatedBlock.classList.add('fade-visible');
            if(btnSimilar) {
                btnSimilar.classList.remove('hidden-initial');
                btnSimilar.style.display = 'flex';
            }
        } else {
            relatedBlock.classList.add('hidden-initial'); 
            if(btnSimilar) btnSimilar.style.display = 'none'; 
        }
    }

    function savePlatform(val) {
        // Сохраняем локально
        localStorage.setItem('xch_platform', val);
        
        // Обновляем цвета и ссылку (твоя старая функция)
        updateLink(); 
    }

    function getCombinedTags(item) {
        if (!item || !item.tags) return [];
        
        // Берем теги жанра
        const combined = [...item.tags];
        
        // Добавляем активные модификаторы (приводим к нижнему регистру)
        activeMods.forEach(modKey => {
            const tag = modKey.toLowerCase();
            if (!combined.includes(tag)) {
                combined.push(tag);
            }
        });
        
        return combined;
    }

    function handleOutboundClick(e) {
        if (isPanicMode) {
            if(e) e.preventDefault();
            togglePanicMode();
            return;
        }

        // Проверяем, показывали ли мы предупреждение раньше
        const hasWarned = localStorage.getItem('xch_vpn_warned');
        
        if (!hasWarned) {
            if (e) e.preventDefault(); // Останавливаем переход
            
            // Получаем ссылку, куда юзер хотел пойти
            const btn = document.getElementById('btn-t-watch');
            pendingOutboundUrl = btn ? btn.href : '#';
            
            openVpnModal(); // Открываем модалку
            return; // Прерываем выполнение, пока юзер не нажмет кнопку в модалке
        }

        if(!currentItem) return;
        
        watchStartTime = Date.now();
        itemBeingWatched = currentItem;

        if(!hasWatchedCurrentItem) {
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, 3); 
            logActivity('watch', currentItem.id, fullTags);
            hasWatchedCurrentItem = true;
            hasInteractedWithCurrent = true;
        }
    }

    function openVpnModal() {
        const modal = document.getElementById('modal-vpn-overlay');
        const pwaText = document.getElementById('vpn-pwa-text');
        const btn = document.getElementById('btn-vpn-go');

        // Проверка PWA и Мобильного устройства
        const isMobile = window.innerWidth < 768;
        const isPWA = (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);

        // Показываем текст про перезапуск видео ТОЛЬКО если это PWA на мобильном
        if (isMobile && isPWA) {
            pwaText.style.display = 'block';
        } else {
            pwaText.style.display = 'none';
        }

        // Навешиваем событие на кнопку "Пошли"
        btn.onclick = () => {
            // 1. Запоминаем, что предупреждение показано
            localStorage.setItem('xch_vpn_warned', 'true');
            
            // 2. Закрываем окно
            modal.classList.remove('open');
            
            // 3. Открываем ссылку
            if (pendingOutboundUrl && pendingOutboundUrl !== '#') {
                window.open(pendingOutboundUrl, '_blank');
                
                handleOutboundClick(null); 
            }
        };

        modal.classList.add('open');
    }

    function addToHistory(item) {
        const entry = { id: item.id, timestamp: Date.now() };
        historyData = historyData.filter(x => x.id !== item.id);
        historyData.unshift(entry);
        if(historyData.length > 30) historyData.pop();
        localStorage.setItem(STORAGE.HISTORY, JSON.stringify(historyData));
        renderHistory();
        updateExploredCount();
        if (window.markDirty) window.markDirty();
    }
    
    function getLocalizedName(item) {
        if (!item) return "";
        if (currentLang === 'ru' && item.name_ru) return item.name_ru;
        if (currentLang === 'es' && item.name_es) return item.name_es;
        if (currentLang === 'de' && item.name_de) return item.name_de;
        return item.name; // По умолчанию английский
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (historyData.length === 0) {
            list.innerHTML = `<div class="ios-row" style="justify-content:center; color:var(--text-secondary); font-size:14px;">${t.hist_empty}</div>`;
            return;
        }

        historyData.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;
            const div = document.createElement('div');
            div.className = 'history-item-ios'; 
            
            const name = getLocalizedName(item);
            
            div.innerHTML = `<span>${name}</span><span style="color:var(--accent); font-size:18px;">↺</span>`;
            div.onclick = () => { switchTab('home'); forceShowResult(item, 'history'); };
            list.appendChild(div);
        });
    }

    function filterData() {
        // Обновленный список безопасных тегов
        const SAFETY_NET = ['straight', 'general', 'vanilla']; 
        const recentIds = historyData.slice(0, 50).map(entry => entry.id);

        let candidates = data.filter(item => {
            // 1. Черный список и История (без изменений)
            if (blacklist.includes(item.id)) return false;
            if (recentIds.includes(item.id)) return false;

            // 2. Интенсивность (без изменений)
            if (currentIntensity === 1) {
                if (item.tags.some(t => EXTREME_TAGS.includes(t) || SPICY_TAGS.includes(t))) return false;
            }
            if (currentIntensity === 2) {
                if (item.tags.some(t => EXTREME_TAGS.includes(t))) return false;
            }

            // 3. Ориентация (без изменений)
            const isGay = item.tags.includes('gay');
            const isTrans = item.tags.some(t => ['trans', 'shemale', 'futanari', 'crossdresser'].includes(t));
            const isLesbian = item.tags.includes('lesbian');
            const isStraight = item.tags.includes('straight');
            const isBi = item.tags.includes('bi');
            
            const isLgbtForHetero = isGay || isTrans || isBi; 

            if (currentOrientation === 'hetero') {
                if (isLgbtForHetero && !isLesbian) return false;
            }
            else if (currentOrientation === 'gay') {
                if (isStraight && !isGay) return false;
            }
            else if (currentOrientation === 'trans') {
                if (isStraight && !isTrans) return false;
            }

            return true;
        });

        // Fallback: Если фильтры слишком жесткие, возвращаем хотя бы General контент
        if (candidates.length < 3) {
            candidates = data.filter(item => 
                !blacklist.includes(item.id) && 
                item.tags.includes('general') // Показываем только General в случае нехватки
            );
        }
        
        return candidates;
    }

    function renderResultName() {
        if (!currentItem) return;
        
        // 1. Получаем базовое название (на нужном языке)
        const displayName = getLocalizedName(currentItem);
        
        // 2. Формируем HTML для модификаторов (точно так же, как при генерации результата)
        let modifiersHtml = "";
        
        if (activeMods.size > 0) {
            // Проходим по активным модам и ищем их перевод
            const modNames = Array.from(activeMods).map(key => {
                const m = modifiersData.find(x => x.key === key);
                if (m) {
                    if (currentLang === 'ru') return m.ru;
                    if (currentLang === 'es') return m.es;
                    if (currentLang === 'de') return m.de;
                    return m.en;
                }
                return key;
            });
            
            // Собираем строку: + POV + Hardcore
            if (modNames.length > 0) {
                // Важно: span с opacity создает эффект "второстепенного" текста
                modifiersHtml = ` <span style="color:var(--accent); font-weight:300; opacity:0.9;">+ ${modNames.join(" + ")}</span>`;
            }
        }

        // 3. Обновляем элемент на странице
        const titleEl = document.getElementById('result-text');
        if (titleEl) {
            // Используем innerHTML, чтобы отобразился цветной span, а не просто текст тегов
            titleEl.innerHTML = `${displayName}${modifiersHtml}`;
        }
        
        // 4. Обновляем описание (на всякий случай, если язык менялся)
        let desc = currentItem.desc_en;
        if (currentLang === 'ru' && currentItem.desc_ru) desc = currentItem.desc_ru;
        else if (currentLang === 'es' && currentItem.desc_es) desc = currentItem.desc_es;
        else if (currentLang === 'de' && currentItem.desc_de) desc = currentItem.desc_de;

        const descEl = document.getElementById('result-desc');
        if (descEl) descEl.innerText = desc || "";
    }

    function updateLink() {
        const btnWatch = document.getElementById('btn-t-watch');
        
        if (isPanicMode) {
            if(btnWatch) {
                btnWatch.removeAttribute('href');
                btnWatch.removeAttribute('target');
            }
            return;
        }

        // 1. Получаем то, что выбрал ПОЛЬЗОВАТЕЛЬ в настройках
        const userSelectedPlatform = document.getElementById('platform') ? document.getElementById('platform').value : 'xh';
        
        // 2. Определяем реальную платформу для ссылки (внутренняя логика)
        let targetPlatform = userSelectedPlatform;

        // Если стоит "Random", но у предмета уже есть закрепленный сайт -> используем его для ССЫЛКИ
        if (userSelectedPlatform === 'random' && currentItem && currentItem.assignedPlatform) {
            targetPlatform = currentItem.assignedPlatform;
        }
        else if (userSelectedPlatform === 'random') {
            targetPlatform = 'xh'; // Фолбек
        }

        const root = document.documentElement;
        const currentThemeId = localStorage.getItem('xch_theme_id') || 'dark';
        const currentTheme = APP_THEMES.find(t => t.id === currentThemeId);

        // Цвета конкретных сайтов
        const colors = {
            'xh': ['#9b59b6', '#b07cc6'],
            'ph': ['#ff9900', '#ffbd55'],
            'xv': ['#de2828', '#ff6b6b'],
            'sb': ['#ffd700', '#ffe666'],
            'yp': ['#ff3366', '#ff668a'],
            'rt': ['#ff0000', '#ff4d4d'],
            'google': ['#4285F4', '#7aaafc'],
            // Дефолтные цвета (App Brand Colors)
            'default': ['#ff00cc', '#CB53F0'] 
        };
        
        // Если пользователь выбрал "Random", мы показываем ДЕФОЛТНЫЕ цвета, чтобы не палить контору.
        // Если выбран конкретный сайт, показываем цвета сайта.
        let colorKey = (userSelectedPlatform === 'random') ? 'default' : targetPlatform;
        
        const [platMain, platLight] = colors[colorKey] || colors['xh'];

        // Применяем цвета, только если тема не имеет своих жестких акцентов (как в премиум темах)
        if (!currentTheme || !currentTheme.accent) {
            root.style.setProperty('--accent', platMain);
            root.style.setProperty('--accent-light', platLight);
        }

        if(!currentItem) return;
        
        const forceEn = document.getElementById('force-en').checked;
        const useRu = (currentLang === 'ru' && !forceEn);
        
        let queryName = useRu ? (currentItem.name_ru || currentItem.name) : currentItem.name;
        let queryParts = [queryName];
        
        if (typeof activeMods !== 'undefined') {
            activeMods.forEach(key => {
                const mod = modifiersData.find(m => m.key === key);
                queryParts.push(useRu ? mod.ru : mod.en);
            });
        }
        
        let plusQuery = queryParts.join("+").toLowerCase();
        let url = "";
        
        // Генерируем ссылку на основе РЕАЛЬНОЙ платформы (targetPlatform)
        if (targetPlatform === 'google') {
            url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(queryParts.join(" ") + " porn")}`;
        } else {
            switch(targetPlatform) {
                case 'xh': url = `https://xhamster.com/search/${plusQuery}`; break;
                case 'ph': url = `https://www.pornhub.com/video/search?search=${plusQuery}`; break;
                case 'xv': url = `https://www.xvideos.com/?k=${plusQuery}`; break;
                case 'sb': url = `https://spankbang.com/s/${plusQuery}/`; break;
                case 'yp': url = `https://www.youporn.com/search/?query=${plusQuery}`; break;
                case 'rt': url = `https://www.redtube.com/?search=${plusQuery}`; break;
                default: url = `https://xhamster.com/search/${plusQuery}`; break;
            }
        }
        
        if(btnWatch) {
            btnWatch.href = url;
            btnWatch.target = "_blank";
        }
    }

    function saveLists() {
        localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
        localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
    }

    function updateCounts() { 
        document.getElementById('count-fav').innerText = favorites.length; 
        
        const banBadge = document.getElementById('count-ban');
        if(banBadge) banBadge.innerText = blacklist.length;
        
        const wlBadge = document.getElementById('count-wl');
        if(wlBadge) wlBadge.innerText = watchLater.length;
        
        updateExploredCount(); // Вызов соседней функции
    }

    function exportData() {
        const exportObj = {
            // Добавляем activityLog в экспорт
            activityLog: activityLog, 
            blacklist, 
            favorites, 
            tagScores, 
            history: historyData,
            settings: { 
                lang: currentLang, 
                theme: localStorage.getItem(STORAGE.THEME), 
                intensity: currentIntensity,
                platform: localStorage.getItem('xch_platform') || 'xh',
            sub: subscriptionLevel
            }
        };
        // Используем clipboard API для удобства, если поддерживается, или prompt
        const dataStr = JSON.stringify(exportObj);
        
        try {
            navigator.clipboard.writeText(dataStr).then(() => {
                alert("Data copied to clipboard!");
            }).catch(() => {
                prompt("Copy this data:", dataStr);
            });
        } catch (e) {
            prompt("Copy this data:", dataStr);
        }
    }

    function importData() {
        const str = prompt("Paste data here:");
        if(!str) return;
        try {
            const obj = JSON.parse(str);
            
            // Восстанавливаем все поля
            if(obj.blacklist) blacklist = obj.blacklist;
            if(obj.favorites) favorites = obj.favorites;
            if(obj.tagScores) tagScores = obj.tagScores;
            if(obj.history) historyData = obj.history;
            if(obj.activityLog) activityLog = obj.activityLog; // Восстанавливаем лог
            
            // Настройки
            if(obj.settings) {
                if (obj.settings.intensity) currentIntensity = obj.settings.intensity;
                if (obj.settings.platform) localStorage.setItem('xch_platform', obj.settings.platform);
                if (obj.settings.lang) localStorage.setItem(STORAGE.LANG, obj.settings.lang);
            }

            if (obj.settings && obj.settings.sub) {
                localStorage.setItem('xch_sub_level', obj.settings.sub);
                subscriptionLevel = obj.settings.sub;
            }
            
            // Сохраняем в память браузера
            saveLists();
            localStorage.setItem(STORAGE.TAG_SCORES, JSON.stringify(tagScores));
            localStorage.setItem(STORAGE.HISTORY, JSON.stringify(historyData));
            localStorage.setItem(STORAGE.ACTIVITY_LOG, JSON.stringify(activityLog)); // Сохраняем лог
            localStorage.setItem(STORAGE.INTENSITY, currentIntensity);
            
            alert("Import successful! Reloading page..."); 
            location.reload();
        } catch(e) { 
            console.error(e);
            alert("Error parsing data! Check format."); 
        }
    }

    function initIntensity() {
            const saved = localStorage.getItem(STORAGE.INTENSITY);
            currentIntensity = saved ? parseInt(saved) : 1;
            
            // Синхронизируем позицию ползунка (на случай, если HTML сбросился)
            const slider = document.getElementById('intensity-slider');
            if (slider) slider.value = currentIntensity;

            updateIntensity(currentIntensity);
        }
    
    let intensityTextTimeout = null;

    function updateIntensity(val) {
        currentIntensity = parseInt(val);
        localStorage.setItem(STORAGE.INTENSITY, currentIntensity);
        
        const slider = document.getElementById('intensity-slider');
        const mainIcon = document.getElementById('main-intensity-icon');
        const labelText = document.getElementById('intensity-value-label');

        if (!slider || !mainIcon) return;

        slider.value = currentIntensity;

        const t = langData[currentLang] || langData['en'];
        const isNoir = document.body.getAttribute('data-theme') === 'noir';
        const colorBg = 'var(--border)'; 
        
        // Конфигурация уровней
        let config = {};
        if (currentIntensity === 1) {
            config = {
                icon: 'safe.png', key: 'val_safe', color: '#2ecc71', emoji: "🛡️",
                bg: colorBg,
                filter: isNoir ? (document.body.classList.contains('light-theme') ? "invert(0)" : "invert(1)") : "invert(68%) sepia(61%) saturate(452%) hue-rotate(97deg) brightness(89%) contrast(85%)"
            };
        } else if (currentIntensity === 2) {
            config = {
                icon: 'spicy.png', key: 'val_spicy', color: isNoir ? '#ffffff' : '#f39c12', emoji: "🔥",
                bg: `linear-gradient(to right, ${isNoir ? '#fff' : '#f39c12'} 0%, ${isNoir ? '#fff' : '#f39c12'} 50%, ${colorBg} 50%, ${colorBg} 100%)`,
                filter: isNoir ? (document.body.classList.contains('light-theme') ? "invert(0)" : "invert(1)") : "invert(77%) sepia(33%) saturate(5427%) hue-rotate(357deg) brightness(101%) contrast(90%)"
            };
        } else {
            config = {
                icon: 'extreme.png', key: 'val_extreme', color: isNoir ? '#ffffff' : '#e74c3c', emoji: "💀",
                bg: isNoir ? '#ffffff' : '#e74c3c',
                filter: isNoir ? (document.body.classList.contains('light-theme') ? "invert(0)" : "invert(1)") : "invert(43%) sepia(97%) saturate(1874%) hue-rotate(338deg) brightness(96%) contrast(89%)"
            };
        }

        // 1. Иконка
        if (mainIcon.src.indexOf(config.icon) === -1) {
            mainIcon.style.transform = "scale(0.8)";
            setTimeout(() => {
                mainIcon.src = config.icon;
                mainIcon.style.filter = config.filter;
                mainIcon.style.transform = "scale(1.1)";
                setTimeout(() => mainIcon.style.transform = "scale(1)", 150);
            }, 100);
        } else {
            mainIcon.style.filter = config.filter;
        }

        // 2. Слайдер
        slider.style.background = config.bg;

        const infoIcon = document.getElementById('intensity-info-icon');

        // 3. Обновляем текст
        if (labelText) {
            // Сбрасываем инлайн-стили
            labelText.style.opacity = "";
            labelText.style.transform = ""; 
            labelText.style.transition = ""; 

            if (intensityTextTimeout) clearTimeout(intensityTextTimeout);

            // Формируем текст
            let rawText = t[config.key] || "Level " + currentIntensity;
            rawText = rawText.replace(config.emoji, '').trim(); 
            
            labelText.innerText = rawText + " " + config.emoji;
            labelText.style.color = config.color;

            // ПОКАЗЫВАЕМ ТЕКСТ -> СКРЫВАЕМ ИКОНКУ
            requestAnimationFrame(() => {
                labelText.classList.add('visible');
                if(infoIcon) {
                    infoIcon.style.opacity = '0'; // Исчезает
                    infoIcon.style.pointerEvents = 'none'; // Нельзя нажать пока не видно
                }
            });

            // Таймер исчезновения
            intensityTextTimeout = setTimeout(() => {
                labelText.classList.remove('visible');
                
                // СКРЫВАЕМ ТЕКСТ -> ПОКАЗЫВАЕМ ИКОНКУ
                if(infoIcon) {
                    infoIcon.style.opacity = '0.5'; // Возвращается (полупрозрачная)
                    infoIcon.style.pointerEvents = 'auto';
                }
            }, 1200);
        }
        
        if(navigator.vibrate) navigator.vibrate(15);
    }

    function initIdleSlot() {
        const reel = document.getElementById('slot-reel');
        if (!reel) return;

        // Берем 30 случайных элементов
        const sample = [...data].sort(() => 0.5 - Math.random()).slice(0, 30);
        
        // Дублируем список 4 раза для бесшовности
        let html = '';
        // Генерируем HTML один раз
        const itemsHtml = sample.map(item => `<div class="slot-item">${getLocalizedName(item)}</div>`).join('');
        
        // Вставляем 4 копии
        reel.innerHTML = itemsHtml + itemsHtml + itemsHtml + itemsHtml;

        reel.className = 'slot-reel idle'; 
        reel.style.transform = ''; 
        reel.style.transition = ''; 
    }

    function checkLayout() {
        const isPC = window.innerWidth > 768;
        
        // 1. Исходные блоки
        const bPrefs = document.getElementById('block-prefs');    
        const bAccount = document.getElementById('block-account'); 
        const bExtras = document.getElementById('block-extras');
        
        // 2. Целевые контейнеры
        const sidebar = document.getElementById('pc-settings-mount'); 
        
        const mPrefs = document.getElementById('mount-prefs');     
        const mAccount = document.getElementById('mount-account'); 

        if (isPC) {
            // === ПК РЕЖИМ (ВСЁ В САЙДБАРЕ) ===
            if (sidebar) {
                if(bPrefs) sidebar.appendChild(bPrefs);
                if(bAccount) sidebar.appendChild(bAccount);
                if(bExtras) sidebar.appendChild(bExtras);
            }
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const homeTab = document.getElementById('tab-home');
            if(homeTab) homeTab.classList.add('active');

        } else {
            // === МОБИЛЬНЫЙ РЕЖИМ ===
            
            // 1. Настройки
            if(mPrefs && bPrefs) mPrefs.appendChild(bPrefs);
            
            // 2. Ссылки (Extras) в Settings
            if(mPrefs && bExtras) {
                mPrefs.appendChild(bExtras);
            }

            // 3. Аккаунт
            if(mAccount && bAccount) mAccount.appendChild(bAccount);
        }
    }

    function toggleModifiers(e) {
        if (e && e.target.classList.contains('tag')) return;

        const capsule = document.getElementById('mods-capsule');
        capsule.classList.toggle('open');
        
        // Вибрация
        if(navigator.vibrate) navigator.vibrate(10);
    }

    function switchTab(tab) {
        // Скрываем все табы
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        // Показываем нужный
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('nav-' + tab).classList.add('active');

        // === Управление классами body для мобильной шапки ===
        document.body.classList.remove('tab-home-active', 'tab-settings-active', 'tab-account-active');
        document.body.classList.add('tab-' + tab + '-active');

        // ОБНОВЛЕНИЕ ИКОНОК (FILL / OUTLINE)
        updateNavIcons(tab);
    }

    function updateNavIcons(activeTab) {
        const tabs = ['home', 'settings', 'account'];
        
        tabs.forEach(t => {
            // Находим картинку внутри кнопки навигации
            const img = document.querySelector(`#nav-${t} .nav-icon-img`);
            if (img) {
                // Если таб активен — ставим _fill, иначе _outline
                const suffix = (t === activeTab) ? '_fill' : '_outline';
                // Меняем src. Убедитесь, что файлы с такими именами существуют!
                img.src = `${t}${suffix}.png`;
            }
        });
    }

    function initTheme() {
        let savedId = localStorage.getItem('xch_theme_id') || 'dark';
        
        // ЗАЩИТА: Проверка прав на тему при загрузке
        // Если подписка Free, проверяем, не является ли сохраненная тема платной
        if (subscriptionLevel === 'free') {
            const themeObj = APP_THEMES.find(t => t.id === savedId);
            // Если тема Pro (или её нет в списке), принудительно ставим Dark
            if (!themeObj || themeObj.type === 'pro') {
                console.log("Free user detected with Premium theme. Resetting to Dark.");
                savedId = 'dark';
                localStorage.setItem('xch_theme_id', 'dark');
            }
        }

        applyTheme(savedId);
    }
    
    function initLanguage() {
        const saved = localStorage.getItem(STORAGE.LANG);
        currentLang = saved || 'en';

        document.getElementById('lang-select').value = currentLang;
        
        const ageGateSelect = document.querySelector('#age-gate select');
        if (ageGateSelect) ageGateSelect.value = currentLang;
        applyLanguage();
        updateToggleLabels();
    }
    
    function changeLanguage(val) {
        currentLang = val;
        localStorage.setItem(STORAGE.LANG, currentLang);
        const s1 = document.getElementById('lang-select');
        const s2 = document.querySelector('#age-gate select');
        if (s1) s1.value = val;
        if (s2) s2.value = val;
        applyLanguage();
        randomizeModeGreeting();
        if (window.updateLastSyncUI) window.updateLastSyncUI(); 
        renderHistory();
        renderModifiers();
        updateThemeLabel();
        if(currentItem) { renderResultUI(currentItem, null); updateLink(); } 
        updateToggleLabels();
        updateExploredCount();
    }
    
    function updateToggleLabels() {
        const isRu = (currentLang === 'ru');
        document.getElementById('comp-search').style.display = isRu ? 'flex' : 'none';
    }
   
    function applyLanguage() {
        const t = langData[currentLang];
        
        // Перевод текстов
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if(t[key]) {
                if (key.startsWith('inst_') || key.startsWith('badge_') || key.startsWith('feat_') || key.startsWith('pay_') || key.startsWith('guide_') || key === 'sync_tip') {
                    el.innerHTML = t[key];
                } else {
                    el.innerText = t[key];
                }
            }
        });

        // Перевод плейсхолдеров
        const onbInput = document.getElementById('onb-input');
        if(onbInput && t.onb_placeholder) onbInput.placeholder = t.onb_placeholder;

        const promoInput = document.getElementById('promo-input-field');
        if(promoInput && t.pay_code_placeholder) promoInput.placeholder = t.pay_code_placeholder;
        
        updateExploredCount();
        updateSubscriptionUI(); 
    }

    function submitPromoFromInput() {
        const input = document.getElementById('promo-input-field');
        const code = input.value.trim();
        
        if (!code) {
            // Визуальная тряска или красная рамка (опционально)
            input.style.borderColor = "var(--highlight-red)";
            setTimeout(() => input.style.borderColor = "var(--border)", 1000);
            return;
        }

        // Вызываем существующую логику активации
        window.activatePromoCode(code);
        
        // Очищаем поле
        input.value = "";
        
        closePaymentModal(null, true);
        closeSubModal(null, true);
    }

    function openFavoritesCatalog() {
        renderListModal('fav');
    }

    function openBlacklistCatalog() {
        renderListModal('ban');
    }

    function renderListModal(type) {
        let modalId, bodyId, listData, placeholder;
        const t = langData[currentLang] || langData['en']; // Получаем переводы

        if (type === 'fav') {
            modalId = 'modal-overlay'; bodyId = 'modal-catalog-body'; listData = favorites;
            placeholder = t.search_liked; // Локализованный плейсхолдер
        } else if (type === 'ban') {
            modalId = 'modal-blacklist-overlay'; bodyId = 'modal-blacklist-body'; listData = blacklist;
            placeholder = t.search_disliked; // Локализованный плейсхолдер
        } else if (type === 'wl') {
            modalId = 'modal-overlay'; 
            bodyId = 'modal-catalog-body'; 
            listData = watchLater;
            
            const header = document.querySelector(`#${modalId} .modal-header span`);
            if(header) header.innerText = t.watch_later;
        }

        const modal = document.getElementById(modalId);
        const body = document.getElementById(bodyId);
        
        body.innerHTML = '';
        body.style.display = 'block';
        body.style.padding = '15px';

        // 1. ПОЛЕ ПОИСКА (Только если это НЕ Watch Later)
        if (type !== 'wl') {
            const searchBox = document.createElement('div');
            searchBox.className = 'modal-search-box';
            searchBox.innerHTML = `
                <input type="text" class="modal-search-input" placeholder="${placeholder}" id="search-${type}">
                <div class="modal-suggestions" id="suggest-${type}"></div>
            `;
            body.appendChild(searchBox);
        }

        // 2. Контейнер тегов
        const tagsContainer = document.createElement('div');
        tagsContainer.style.display = 'flex';
        tagsContainer.style.flexWrap = 'wrap';
        tagsContainer.style.gap = '8px';
        body.appendChild(tagsContainer);

        // 3. Рендер тегов
        renderCurrentTags(type, listData, tagsContainer);

        // 4. Логика поиска (Только если поле создано)
        if (type !== 'wl') {
            const input = document.getElementById(`search-${type}`);
            const suggestBox = document.getElementById(`suggest-${type}`);

            input.oninput = (e) => {
                const val = e.target.value.toLowerCase().trim();
                if (val.length < 2) { suggestBox.style.display = 'none'; return; }

                const matches = data.filter(item => {
                    if (listData.includes(item.id)) return false;
                    const terms = [item.name, item.name_ru || "", item.name_es || "", item.name_de || "", item.slug].map(x => x.toLowerCase());
                    return terms.some(term => term.includes(val));
                }).slice(0, 10);

                suggestBox.innerHTML = '';
                if (matches.length > 0) {
                    suggestBox.style.display = 'flex';
                    matches.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'suggestion-row';
                        row.innerHTML = `${getLocalizedName(item)} <span>+</span>`;
                        
                        row.onclick = () => {
                            if (type === 'fav') {
                                favorites.push(item.id);
                                if (blacklist.includes(item.id)) blacklist = blacklist.filter(x => x !== item.id);
                                adjustTagScores(item, 5);
                                logActivity('like', item.id, item.tags);
                            } else if (type === 'ban') {
                                blacklist.push(item.id);
                                if (favorites.includes(item.id)) favorites = favorites.filter(x => x !== item.id);
                                adjustTagScores(item, -5);
                                logActivity('dislike', item.id, item.tags);
                            } 
                            
                            localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
                            localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
                            
                            updateCounts();
                            if (window.markDirty) window.markDirty();
                            
                            input.value = ''; 
                            suggestBox.style.display = 'none';
                            renderListModal(type);
                            if(currentItem && currentItem.id === item.id) updateActionButtons();
                        };
                        suggestBox.appendChild(row);
                    });
                } else {
                    suggestBox.style.display = 'none';
                }
            };
        }

        // Возврат заголовка для Fav при закрытии (или при следующем открытии Fav само исправится)
        if (type === 'fav') {
             const header = document.querySelector(`#${modalId} .modal-header span`);
             if(header) header.innerText = t.favorites_catalog;
        }

        modal.classList.add('open');
    }

    function renderCurrentTags(type, listIds, container) {
        container.innerHTML = '';
        const t = langData[currentLang];
        
        if (listIds.length === 0) {
            container.innerHTML = `<div style="width:100%; text-align:center; color:var(--text-secondary); margin-top:20px; font-size:14px;">${t.empty_wl || "List is empty"}</div>`;
            return;
        }

        const sortedIds = [...listIds].sort((a, b) => {
            const itemA = data.find(x => x.id === a);
            const itemB = data.find(x => x.id === b);
            if (!itemA || !itemB) return 0;
            return getLocalizedName(itemA).localeCompare(getLocalizedName(itemB));
        });

        sortedIds.forEach(id => {
            const item = data.find(x => x.id === id);
            if (!item) return;

            const div = document.createElement('div');
            // ОПРЕДЕЛЕНИЕ КЛАССА
            let className = 'catalog-item';
            if (type === 'fav') className += ' active';
            else if (type === 'ban') className += ' ban-active';
            else if (type === 'wl') className += ' wl-active'; // СИНИЙ
            
            div.className = className;
            div.innerHTML = `${getLocalizedName(item)} <span class="catalog-remove-btn">✕</span>`;

            div.querySelector('.catalog-remove-btn').onclick = (e) => {
                e.stopPropagation();
                
                if (type === 'fav') favorites = favorites.filter(x => x !== id);
                else if (type === 'ban') blacklist = blacklist.filter(x => x !== id);
                else if (type === 'wl') watchLater = watchLater.filter(x => x !== id);
                
                localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
                localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
                localStorage.setItem(STORAGE.WATCH_LATER, JSON.stringify(watchLater));
                
                updateCounts();
                if (window.markDirty) window.markDirty();
                
                div.style.opacity = '0';
                div.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    renderCurrentTags(type, type === 'fav' ? favorites : (type === 'ban' ? blacklist : watchLater), container);
                }, 200);

                if(currentItem && currentItem.id === id) updateActionButtons();
            };
            
            // Клик по самому тегу открывает его (как в истории)
            div.onclick = (e) => {
                if(e.target.classList.contains('catalog-remove-btn')) return;
                closeList(null, true);
                closeBlacklist(null, true);
                switchTab('home');
                forceShowResult(item, 'history');
            }

            container.appendChild(div);
        });
    }

    function closeList(e, force) {
        if (force || e.target.id === 'modal-overlay') {
            document.getElementById('modal-overlay').classList.remove('open');
        }
    }
    
    function closeBlacklist(e, force) {
        if (force || e.target.id === 'modal-blacklist-overlay') {
            document.getElementById('modal-blacklist-overlay').classList.remove('open');
        }
    }

    function searchByTag(tag) {
        const candidates = data.filter(item => item.tags.includes(tag));
        if (candidates.length === 0) return; 
        const selected = getWeightedRandom(candidates); 
        forceShowResult(selected, 'tag_click');
    }

    function openStatistics() {
        const t = langData[currentLang];
        // Локализация табов
        if (document.getElementById('tf-week')) document.getElementById('tf-week').innerText = t.tf_week;
        if (document.getElementById('tf-month')) document.getElementById('tf-month').innerText = t.tf_month;
        if (document.getElementById('tf-year')) document.getElementById('tf-year').innerText = t.tf_year;
        if (document.getElementById('tf-all')) document.getElementById('tf-all').innerText = t.tf_all;

        updateStatsLocks(); // Обновляем замочки на табах

        // === ЛОГИКА WRAPPED КНОПКИ И БЕЙДЖА ===
        const wBtn = document.getElementById('btn-wrapped-trigger');
        const isPaid = subscriptionLevel !== 'free';
        const daysActive = activeDaysSet.size;
        
        // Удаляем старый прогресс-бар (лок), если он есть
        const oldProgress = document.getElementById('wrapped-progress-ui');
        if (oldProgress) oldProgress.remove();

        // Очищаем старый интервал таймера
        if (wrappedTimerInterval) clearInterval(wrappedTimerInterval);

        // 1. Проверяем, есть ли НЕПРОЧИТАННЫЕ (New)
        const unreadItems = wrappedArchive.filter(w => !w.viewed).sort((a,b) => b.timestamp - a.timestamp);
        let hasNew = unreadItems.length > 0;

        // 2. Проверяем доступность НОВОГО отчета ПРЯМО СЕЙЧАС
        let readyToGenerate = false;
        if (isPaid) {
            // Для платных: если сегодня еще не генерировали
            const todayStr = new Date().toLocaleDateString();
            const lastDaily = wrappedArchive.find(w => w.type === 'daily' && new Date(w.timestamp).toLocaleDateString() === todayStr);
            if (!lastDaily) readyToGenerate = true;
        } else {
            // Для бесплатных: если накопилось 7 дней
            if (daysActive >= 7) readyToGenerate = true;
        }

        // РЕШАЕМ: Показывать кнопку или нет
        // Кнопку показываем, если: Есть новые, Есть старые (Архив), или Готов новый к генерации
        const showButton = hasNew || readyToGenerate || wrappedArchive.length > 0;

        if (showButton) {
            if(wBtn) wBtn.style.display = 'flex';

            // ОПРЕДЕЛЕНИЕ ТЕКСТА БЕЙДЖА (Справа)
            let badgeHTML = "";

            if (hasNew) {
                // Если есть непрочитанное - приоритет NEW
                const type = unreadItems[0].type;
                const typeText = WRAPPED_CONFIG.badges[currentLang][type] || type.toUpperCase();
                badgeHTML = `<span style="color:#fff; margin-right:4px;">●</span>
                             <span style="background:var(--accent); color:#000; font-size:10px; font-weight:800; padding:3px 8px; border-radius:6px; text-transform:uppercase;">${typeText}</span>`;
            } 
            else if (readyToGenerate) {
                // Если готово к генерации
                const readyText = isPaid ? "DAILY READY" : "WEEKLY READY";
                badgeHTML = `<span style="background:#2ecc71; color:#000; font-size:10px; font-weight:800; padding:3px 8px; border-radius:6px; text-transform:uppercase;">${readyText}</span>`;
            } 
            else {
                // === РЕЖИМ ОЖИДАНИЯ (TIMER / PROGRESS) ===
                // Отчет сгенерирован, ждем следующего периода
                
                // Создаем элемент для таймера
                const timerId = 'wrapped-countdown-' + Date.now();
                
                if (isPaid) {
                    // Платный: Таймер до полуночи
                    badgeHTML = `<span id="${timerId}" style="background:rgba(255,255,255,0.15); color:#fff; font-size:10px; font-weight:700; padding:3px 8px; border-radius:6px; font-variant-numeric: tabular-nums;">--:--:--</span>`;
                    
                    // Запуск таймера
                    const updateTimer = () => {
                        const el = document.getElementById(timerId);
                        if (!el) return;
                        
                        const now = new Date();
                        const tomorrow = new Date(now);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        tomorrow.setHours(0, 0, 0, 0);
                        
                        const diff = tomorrow - now;
                        if (diff <= 0) {
                            // Время пришло -> перезапускаем окно
                            openStatistics();
                            return;
                        }
                        
                        const h = Math.floor(diff / 3600000);
                        const m = Math.floor((diff % 3600000) / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        
                        el.innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                    };
                    
                    // Запускаем сразу и в интервал
                    setTimeout(updateTimer, 0);
                    wrappedTimerInterval = setInterval(updateTimer, 1000);
                } 
                else {
                    // Бесплатный: Прогресс дней (3/7)
                    // Используем перевод слова "days"
                    const daysWord = currentLang === 'ru' ? 'дн.' : 'd';
                    badgeHTML = `<span style="background:rgba(255,255,255,0.15); color:#fff; font-size:10px; font-weight:700; padding:3px 8px; border-radius:6px;">${daysActive} / 7 ${daysWord}</span>`;
                }
            }

            const btnTitle = t.wrapped_btn || "Fetish Wrapped ✨";
            
            // Вставляем HTML в кнопку
            wBtn.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <span>${btnTitle}</span>
                    <div style="display:flex; align-items:center;">
                        ${badgeHTML}
                    </div>
                </div>
            `;

        } else {
            // Если кнопка скрыта (совсем новичок Free) -> Показываем большой прогресс-бар
            if(wBtn) wBtn.style.display = 'none';
            
            const percent = Math.min(100, (daysActive / 7) * 100);
            const left = 7 - daysActive;
            const titleTxt = t.wrapped_lock_title || "FETISH WRAPPED 🔒";
            
            let daysWord = currentLang === 'ru' ? 'дней' : 'days';
            const descTxt = (t.wrapped_lock_desc || "Activity needed: {n}").replace('{n}', `${left} ${daysWord}`);

            const progressHTML = `
                <div id="wrapped-progress-ui" class="wrapped-lock-container" style="margin: 0 10px 20px 10px;">
                    <div class="wrapped-lock-title">${titleTxt}</div>
                    <div class="wrapped-lock-desc">${descTxt}</div>
                    <div class="w-progress-track">
                        <div class="w-progress-fill" style="width: ${percent}%"></div>
                    </div>
                    <div class="w-progress-text">${daysActive} / 7 ${daysWord}</div>
                </div>
            `;
            const modalBody = document.getElementById('modal-stats-body');
            if(modalBody) modalBody.insertAdjacentHTML('beforebegin', progressHTML);
        }

        const modal = document.getElementById('modal-stats-overlay');
        if (modal) {
            modal.classList.add('open');
            currentStatsTimeframe = 'week'; 
            currentStatsTab = 'tags';
            document.querySelectorAll('.stats-tf-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tf-week').classList.add('active');
            document.getElementById('stat-nav-tags').classList.add('active');
            document.getElementById('stat-nav-activity').classList.remove('active');
            renderStatsContent();
        }
    }

    function switchStatsTab(tab) {
        
        currentStatsTab = tab;
        
        // Переключаем классы
        document.getElementById('stat-nav-tags').classList.toggle('active', tab === 'tags');
        document.getElementById('stat-nav-activity').classList.toggle('active', tab === 'activity');
        
        // Если пользователь бесплатный, принудительно переключаем на 'week' при смене вкладки,
        if (subscriptionLevel === 'free' && currentStatsTimeframe !== 'week') {
            switchTimeframe('week'); 
        } else {
            renderStatsContent();
        }
    }

    function switchTimeframe(tf) {
        // NERF: Блокируем всё кроме "Week" для бесплатных
        if (tf !== 'week' && subscriptionLevel === 'free') {
            openSubModal();
            return;
        }

        currentStatsTimeframe = tf;
        document.querySelectorAll('.stats-tf-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tf-' + tf).classList.add('active');
        renderStatsContent();
    }

    function updateStatsLocks() {
        const isFree = subscriptionLevel === 'free';
        
        const idsToLock = ['tf-month', 'tf-year', 'tf-all'];
        
        idsToLock.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            
            // Сначала чистим старые замки
            const existingLock = el.querySelector('.lock-icon-small');
            if (existingLock) existingLock.remove();
            
            // Сбрасываем прозрачность
            el.style.opacity = '1';
            
            // Если тариф бесплатный — добавляем замок и прозрачность
            if (isFree) {
                el.style.opacity = '0.6';
                const lockSpan = document.createElement('span');
                lockSpan.className = 'lock-icon-small';
                lockSpan.innerText = ' 🔒';
                lockSpan.style.fontSize = '10px';
                el.appendChild(lockSpan);
            }
        });
        
        const actBtn = document.getElementById('stat-nav-activity');
        if (actBtn) {
            const lock = actBtn.querySelector('.lock-icon-small');
            if(lock) lock.remove();
            actBtn.style.opacity = '1';
        }
    }

    function renderStatsContent() {
        const body = document.getElementById('modal-stats-body');
        body.innerHTML = '';
        const t = langData[currentLang];

        // --- ВАРИАНТ А: ТЕГИ (PREFERENCES) ---
        if (currentStatsTab === 'tags') {
            const tempScores = {};
            const IGNORED_TAGS = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd'];
            
            activityLog.forEach(log => {
                if (log.tags) {
                    let weight = 0;
                    if (log.type === 'watch') weight = 10;
                    else if (log.type === 'like' || log.type === 'similar') weight = 5;
                    else if (log.type === 'dislike') weight = -5;

                    if (weight !== 0) {
                        log.tags.forEach(tag => {
                            if(!IGNORED_TAGS.includes(tag)) {
                                tempScores[tag] = (tempScores[tag] || 0) + weight;
                            }
                        });
                    }
                }
            });

            const sortedTags = Object.entries(tempScores)
                .sort((a, b) => b[1] - a[1])
                .filter(x => x[1] > 0)
                .slice(0, 15); 
            
            let html = `<div class="chart-wrapper"><div class="chart-scroll-view" id="chart-source-el">`;

            if(sortedTags.length === 0) {
                html += `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                const maxVal = Math.max(...sortedTags.map(x => x[1]));
                sortedTags.forEach(([tag, score]) => {
                    const height = Math.max(10, (score / maxVal) * 85);
                    let displayTag = tag.charAt(0).toUpperCase() + tag.slice(1);
                    if (displayTag.length > 9) displayTag = displayTag.substring(0, 7) + '..';

                    html += `
                        <div class="pref-col">
                            <div class="chart-value-y">${score}</div>
                            <div class="chart-bar" style="height:${height}%;"></div>
                            <div class="chart-label-x" title="${tag}">${displayTag}</div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            
            // Легенда Тегов
            html += `
                <div class="stats-legend-row">
                    <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> ${t.legend_watch}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--text-main)"></div> ${t.legend_like}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--highlight-red)"></div> ${t.legend_dislike}</div>
                </div>
            `;
            
            body.innerHTML = html;
        } 
        
        // --- ВАРИАНТ Б: АКТИВНОСТЬ (ACTIVITY) ---
        else {
            const aggregated = {};
            const now = new Date();
            now.setHours(23, 59, 59, 999);
            const nowTs = now.getTime();
            const oneDay = 86400000;
            let cutoffTime = 0;
            
            if (currentStatsTimeframe === 'week') cutoffTime = nowTs - (7 * oneDay);
            else if (currentStatsTimeframe === 'month') cutoffTime = nowTs - (30 * oneDay);
            else if (currentStatsTimeframe === 'year') cutoffTime = nowTs - (365 * oneDay);
            else cutoffTime = 0; 

            const getDateKey = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') return `${d.getFullYear()}-${d.getMonth()}`;
                return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            };

            const getLabel = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') {
                    return d.toLocaleDateString(currentLang, { month: 'short' }).replace('.', '');
                }
                return d.toLocaleDateString(currentLang, { day: 'numeric', month: 'numeric' });
            };

            activityLog.forEach(log => {
                if (log.ts < cutoffTime) return;
                const key = getDateKey(log.ts);
                if (!aggregated[key]) aggregated[key] = { gen: 0, watch: 0, time: 0, label: getLabel(log.ts), sort: log.ts };
                if (['like', 'gen', 'pass', 'dislike'].includes(log.type)) aggregated[key].gen++;
                if (log.type === 'watch') aggregated[key].watch++;
            });

            watchHistory.forEach(entry => {
                if (entry.timestamp < cutoffTime) return;
                const key = getDateKey(entry.timestamp);
                if (!aggregated[key]) aggregated[key] = { gen: 0, watch: 0, time: 0, label: getLabel(entry.timestamp), sort: entry.timestamp };
                aggregated[key].time += entry.seconds;
                if (aggregated[key].watch === 0) aggregated[key].watch++;
            });

            const chartData = Object.values(aggregated).sort((a, b) => a.sort - b.sort);
            
            let html = `<div class="chart-wrapper"><div class="chart-scroll-view" id="chart-source-el" style="justify-content: flex-start; padding-left: 5px;">`;

            if (chartData.length === 0) {
                html += `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                let maxGen = 0, maxWatch = 0, maxTime = 0;
                chartData.forEach(d => {
                    if (d.gen > maxGen) maxGen = d.gen;
                    if (d.watch > maxWatch) maxWatch = d.watch;
                    if (d.time > maxTime) maxTime = d.time;
                });
                
                if (maxGen < 5) maxGen = 5;
                if (maxWatch < 3) maxWatch = 3; 
                if (maxTime < 300) maxTime = 300; 

                // --- НАСТРОЙКИ ГРАДИЕНТОВ ДЛЯ АКТИВНОСТИ ---
                // 1. Серый (Свайпы)
                const gradGrey = `linear-gradient(180deg, #95a5a6 0%, #34495e 100%)`;
                // 2. Акцент (Просмотры - берет цвета темы)
                const gradAccent = `linear-gradient(180deg, var(--accent-light) 0%, var(--accent) 100%)`;
                // 3. Фиолетовый (Время)
                const gradPurple = `linear-gradient(180deg, #d2b4de 0%, #8e44ad 100%)`;

                chartData.forEach(d => {
                    const hGen = (d.gen / maxGen) * 100;
                    const hWatch = (d.watch / maxWatch) * 100;
                    const hTime = (d.time / maxTime) * 100;
                    const timeMin = Math.round(d.time / 60);

                    html += `
                        <div class="act-col">
                            <div class="act-bars-group">
                                <!-- 1. Свайпы (Серый градиент) -->
                                <div class="act-bar" style="background:${gradGrey}; height:${Math.max(5, hGen)}%; opacity:0.6;"></div>
                                
                                <!-- 2. Просмотры (Акцентный градиент) -->
                                <div class="act-bar" style="background:${gradAccent}; height:${Math.max(5, hWatch)}%;"></div>
                                
                                <!-- 3. Время (Фиолетовый градиент) -->
                                <div class="act-bar" style="background:${gradPurple}; height:${Math.max(5, hTime)}%;"></div>
                            </div>

                            <div class="act-values-row">
                                <span class="act-val" style="color:var(--text-secondary); opacity:0.7;">${d.gen}</span>
                                <span class="act-val" style="color:var(--text-main);">${d.watch}</span>
                                <span class="act-val" style="color:#9b59b6;">${timeMin}</span>
                            </div>

                            <div class="chart-label-x">${d.label}</div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;

            let legendUnit = currentLang === 'ru' ? 'мин' : 'min';
            html += `
                <div class="stats-legend-row" style="margin-top:10px;">
                    <div class="legend-item"><div class="legend-dot" style="background:var(--text-secondary)"></div> ${t.act_actions}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> ${t.act_watches}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#9b59b6"></div> ${t.act_time} (${legendUnit})</div>
                </div>
            `;

            body.innerHTML = html;
        }
    }

    function shareStats() {
        if(navigator.vibrate) navigator.vibrate(50);

        // 1. СОБИРАЕМ ОБЩИЕ ДАННЫЕ
        const t = langData[currentLang] || langData['en'];
        const themeId = localStorage.getItem('xch_theme_id') || 'dark';
        const logoSrc = getThemeLogoSrc(themeId); 
        
        const slogan = t.share_caption || "Discover yourself";
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&data=${encodeURIComponent(window.location.origin)}`;
        
        const now = new Date();
        const pad = (n) => n < 10 ? '0'+n : n;
        const formatDate = (d) => `${pad(d.getDate())}.${pad(d.getMonth()+1)}`;
        let rangeStr = "";
        
        if (currentStatsTimeframe === 'all') rangeStr = "ALL TIME";
        else {
            let days = 7;
            if (currentStatsTimeframe === 'month') days = 30;
            if (currentStatsTimeframe === 'year') days = 365;
            rangeStr = `${formatDate(new Date(now.getTime() - (days * 86400000)))} - ${formatDate(now)}`;
        }

        let chartHtml = '';
        let subTitleText = "";

        // === ВЕТВЛЕНИЕ: ПРЕДПОЧТЕНИЯ ИЛИ АКТИВНОСТЬ ===

        if (currentStatsTab === 'tags') {
            // --- ЛОГИКА ДЛЯ ПРЕДПОЧТЕНИЙ (TAGS) ---
            subTitleText = `TOP 5 ${t.stats_prefs}`;

            const tempScores = {};
            const IGNORED_TAGS = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd'];
            
            activityLog.forEach(log => {
                if (log.tags) {
                    let weight = 0;
                    if (log.type === 'watch') weight = 10;
                    else if (log.type === 'like' || log.type === 'similar') weight = 5;
                    else if (log.type === 'dislike') weight = -5;

                    if (weight !== 0) {
                        log.tags.forEach(tag => {
                            if(!IGNORED_TAGS.includes(tag)) {
                                tempScores[tag] = (tempScores[tag] || 0) + weight;
                            }
                        });
                    }
                }
            });

            const sortedTags = Object.entries(tempScores)
                .sort((a, b) => b[1] - a[1])
                .filter(x => x[1] > 0)
                .slice(0, 5); 

            if(sortedTags.length === 0) {
                chartHtml = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                const maxVal = Math.max(...sortedTags.map(x => x[1]));
                chartHtml = `<div style="display:flex; width:100%; height:100%; align-items:flex-end; justify-content: space-between; padding: 0 10px;">`;
                
                sortedTags.forEach(([tag, score]) => {
                    const height = Math.max(10, (score / maxVal) * 85);
                    let displayTag = tag.charAt(0).toUpperCase() + tag.slice(1);
                    if (displayTag.length > 8) displayTag = displayTag.substring(0, 6) + '..';

                    chartHtml += `
                        <div class="pref-col" style="flex:1; max-width:18%; display:flex; flex-direction:column; align-items:center; justify-content:flex-end;">
                            <div class="chart-value-y" style="margin-bottom:4px; font-weight:800; font-size:12px; color:#fff;">${score}</div>
                            <div class="chart-bar" style="height:${height}%; width:100%; border-radius: 6px 6px 0 0; background:var(--accent); min-height:4px;"></div>
                            <div class="chart-label-x" style="margin-top:6px; font-size:11px; font-weight:600; color:var(--text-secondary);">${displayTag}</div>
                        </div>
                    `;
                });
                chartHtml += `</div>`;
            }

        } else {
            // --- ЛОГИКА ДЛЯ АКТИВНОСТИ (ACTIVITY - EXPORT) ---
            subTitleText = (currentLang === 'ru' ? "ИСТОРИЯ АКТИВНОСТИ" : "ACTIVITY HISTORY");

            const aggregated = {};
            const exportLimit = 7; // Берем последние 7 точек
            
            // Используем ту же логику агрегации, но без фильтра времени (берем всё)
            const getDateKey = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') return `${d.getFullYear()}-${d.getMonth()}`;
                return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            };
            const getLabel = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') return d.toLocaleDateString(currentLang, { month: 'short' });
                return d.toLocaleDateString(currentLang, { day: 'numeric', month: 'numeric' });
            };

            activityLog.forEach(log => {
                const key = getDateKey(log.ts);
                if (!aggregated[key]) aggregated[key] = { gen: 0, watch: 0, time: 0, label: getLabel(log.ts), sort: log.ts };
                if (['like', 'gen', 'pass', 'dislike'].includes(log.type)) aggregated[key].gen++;
                if (log.type === 'watch') aggregated[key].watch++;
            });

            watchHistory.forEach(entry => {
                const key = getDateKey(entry.timestamp);
                if (!aggregated[key]) aggregated[key] = { gen: 0, watch: 0, time: 0, label: getLabel(entry.timestamp), sort: entry.timestamp };
                aggregated[key].time += entry.seconds;
                if (aggregated[key].watch === 0) aggregated[key].watch++;
            });

            const chartData = Object.values(aggregated).sort((a, b) => a.sort - b.sort).slice(-exportLimit);

            if (chartData.length === 0) {
                chartHtml = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                let maxGen = 5, maxWatch = 3, maxTime = 300;
                chartData.forEach(d => {
                    if (d.gen > maxGen) maxGen = d.gen;
                    if (d.watch > maxWatch) maxWatch = d.watch;
                    if (d.time > maxTime) maxTime = d.time;
                });

                chartHtml = `<div style="display:flex; width:100%; height:100%; align-items:flex-end; justify-content: space-between; padding: 0 10px;">`;

                chartData.forEach(d => {
                    const hGen = (d.gen / maxGen) * 100;
                    const hWatch = (d.watch / maxWatch) * 100;
                    const hTime = (d.time / maxTime) * 100;
                    const timeMin = Math.round(d.time/60);
                    
                    chartHtml += `
                        <div style="flex:1; max-width:13%; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; margin:0 2px;">
                            
                            <!-- График (3 столбика) -->
                            <div style="display:flex; align-items:flex-end; gap:2px; height:75%; width:100%; border-bottom:1px solid rgba(128,128,128,0.2);">
                                <div style="flex:1; background:var(--text-secondary); height:${Math.max(5, hGen)}%; opacity:0.3; border-radius:2px 2px 0 0;"></div>
                                <div style="flex:1; background:var(--accent); height:${Math.max(5, hWatch)}%; border-radius:2px 2px 0 0;"></div>
                                <div style="flex:1; background:#9b59b6; height:${Math.max(5, hTime)}%; border-radius:2px 2px 0 0;"></div>
                            </div>
                            
                            <!-- Цифры -->
                            <div style="display:flex; justify-content:space-between; width:100%; margin-top:2px; font-size:8px; font-weight:700;">
                                <span style="color:var(--text-secondary); opacity:0.7;">${d.gen}</span>
                                <span style="color:var(--text-main);">${d.watch}</span>
                                <span style="color:#9b59b6;">${timeMin}</span>
                            </div>

                            <div class="chart-label-x" style="margin-top:2px; font-size:9px; font-weight:600; color:var(--text-secondary);">${d.label}</div>
                        </div>
                    `;
                });
                chartHtml += `</div>`;
            }
        }

        // 3. СОЗДАЕМ СКРЫТЫЙ КОНТЕЙНЕР (Карточка)
        const exportContainer = document.createElement('div');
        exportContainer.id = 'export-stats-card'; // Использует CSS стили
        
        const headerHTML = `
            <div class="export-header">
                <div style="display:flex; flex-direction:column;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <img src="${logoSrc}" style="height:32px;">
                        <div style="font-size:24px; font-weight:900; color:var(--text-main); line-height:1;">
                            x<span style="color:var(--accent); background:none; -webkit-text-fill-color:initial;">Fetish</span>Hub
                        </div>
                    </div>
                    <div style="font-size:10px; text-transform:uppercase; color:var(--text-secondary); margin-left:42px; letter-spacing:1.5px; margin-top:4px;">${slogan}</div>
                </div>
                <div style="background:#fff; padding:4px; border-radius:8px; width:54px; height:54px; display:flex; align-items:center; justify-content:center;">
                    <img src="${qrUrl}" style="width:100%; height:100%; display:block;">
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:-5px;">
                <span style="font-size:12px; color:var(--text-secondary); font-weight:700;">${rangeStr}</span>
                <span style="font-size:12px; color:var(--accent); font-weight:800; text-transform:uppercase;">
                    ${subTitleText}
                </span>
            </div>
            
            <div class="chart-wrapper" style="height:220px; border:none; margin:0; padding:0; display:flex; align-items:flex-end;">
                ${chartHtml}
            </div>
        `;

        exportContainer.innerHTML = headerHTML;
        document.body.appendChild(exportContainer);

        // 4. ДЕЛАЕМ СКРИНШОТ
        html2canvas(exportContainer, {
            backgroundColor: null,
            scale: 2,
            useCORS: true,
            allowTaint: true
        }).then(canvas => {
            document.body.removeChild(exportContainer);
            const link = document.createElement('a');
            link.download = `xfetish-stats-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }).catch(e => {
            console.error(e);
            if(document.body.contains(exportContainer)) document.body.removeChild(exportContainer);
            alert("Error creating image");
        });
    }

    function openSupportModal() {
        const t = langData[currentLang];
        const contentDiv = document.getElementById('support-content');
        
        contentDiv.innerHTML = `
            <p>${t.support_intro}</p>
            <p>${t.support_why}</p>
            <h4 style="color:var(--text-main); margin:15px 0 10px 0;">${t.support_roadmap_title}</h4>
            <ul style="padding-left:20px; margin:0;">
                ${t.support_roadmap_list}
            </ul>
        `;
        
        document.getElementById('modal-support-overlay').classList.add('open');
    }
    
    function closeSupport(e, force) {
        if (force || e.target.id === 'modal-support-overlay') {
            document.getElementById('modal-support-overlay').classList.remove('open');
        }
    }

    function closeStats(e, force) {
        if (force || e.target.id === 'modal-stats-overlay') {
            document.getElementById('modal-stats-overlay').classList.remove('open');
            if (wrappedTimerInterval) {
                clearInterval(wrappedTimerInterval);
                wrappedTimerInterval = null;
            }
        }
    }

    function initAgeGate() {
        const isVerified = localStorage.getItem('xch_age_verified');

        if (!isVerified) {
            // Если возраст не подтвержден - показываем Age Gate
            document.getElementById('age-gate').classList.add('open');
        } else {
            // Если подтвержден - запускаем цепочку проверок
            runStartupChecks();
        }
    }

    function passAgeGate() {
        localStorage.setItem('xch_age_verified', 'true');
        document.getElementById('age-gate').classList.remove('open');
        runStartupChecks();
    }

    function runStartupChecks() {
        const isMobile = window.innerWidth < 768; // Проверка на мобильность
        const isInstalled = isAppInstalled();
        const isSkipped = sessionStorage.getItem('xch_install_skipped'); // Проверка, пропускали ли в этой сессии

        // ЦЕПОЧКА:
        // 1. Мобилка? НЕ установлено? НЕ пропускали? -> Показать Install Modal
        // 2. Иначе -> Проверить Onboarding Preferences

        if (isMobile && !isInstalled && !isSkipped) {
            document.getElementById('modal-install-overlay').classList.add('open');
        } else {
            checkOnboarding();
        }
    }

    function blockAccess() {
        document.getElementById('age-block').style.display = 'flex';
        // На всякий случай блокируем скролл и всё остальное
        document.body.style.overflow = 'hidden';
    }

    function skipOnboarding() {
        localStorage.setItem('xch_onboarding_done', 'true');
        document.getElementById('onboarding-overlay').classList.remove('open');
        
        setTimeout(() => {
            document.getElementById('modal-promo-tips-overlay').classList.add('open');
        }, 300);
    }

    function processOnboardingText() {
        const inputField = document.getElementById('onb-input');
        // Очищаем от лишних пробелов и знаков препинания
        let text = inputField.value.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ");
        
        if (!text.trim()) return;

        const container = document.getElementById('onb-tags-container');
        container.innerHTML = ''; 
        document.getElementById('onb-results').style.display = 'flex';

        // 1. ТРИГГЕРЫ НАСТРОЕНИЯ
        const triggers = {
            negative: ["hate", "dislike", "no ", "don't", "except", "ненавижу", "не люблю", "без ", "кроме", "фу", "не хочу", "не нрав", "odio", "no me gusta", "sin ", "hasse", "ohne", "kein"],
            positive: ["like", "love", "want", "prefer", "enjoy", "люблю", "хочу", "нравится", "обожаю", "давай", "amo", "quiero", "me gusta", "mag", "liebe", "will"]
        };

        // Временные сеты для избежания дубликатов в рамках одного запуска
        let foundLikes = new Set();
        let foundDislikes = new Set();
        let totalCount = 0;
        const MAX_TOTAL_RESULTS = 10;

        // Разбиваем ввод на слова (токены)
        const tokens = text.split(/\s+/).filter(w => w.length > 2);

        // --- ЛОГИКА ПОИСКА ПО СЛОВАМ ---
        tokens.forEach((token, index) => {
            // Если лимит превышен, прекращаем поиск
            if (totalCount >= MAX_TOTAL_RESULTS) return;

            // 1. Определяем настроение для текущего слова
            // Смотрим на предыдущие 2 слова, нет ли там триггера
            let mood = 'like';
            const contextStr = tokens.slice(Math.max(0, index - 2), index + 1).join(" ");
            
            if (triggers.negative.some(neg => contextStr.includes(neg))) {
                mood = 'dislike';
            }

            // 2. Поиск кандидатов для ЭТОГО слова
            let candidates = [];

            // Проверяем все предметы в базе
            data.forEach(item => {
                let matchScore = 0;

                // А. Проверка названия (Точное совпадение = высокий балл)
                const names = [item.name, item.name_ru, item.name_es, item.name_de, item.slug].filter(n => n);
                if (names.some(n => n.toLowerCase() === token)) matchScore = 100; // Точное совпадение
                else if (names.some(n => isFuzzyMatch(token, n))) matchScore = 50; // Нечеткое совпадение названия

                // Б. Проверка алиасов (Пышки -> BBW)
                if (matchScore === 0) {
                    for (const [key, aliases] of Object.entries(KEYWORD_ALIASES)) {
                        // Если токен похож на алиас (например "пышек" ~ "пышки")
                        if (key === token || aliases.some(alias => isFuzzyMatch(token, alias))) {
                            // И если этот предмет содержит этот ключевой тег или слово в названии
                            if (item.tags.includes(key) || names.some(n => n.toLowerCase().includes(key))) {
                                matchScore = 40; 
                            }
                        }
                    }
                }

                // В. Проверка тегов (низкий приоритет, чтобы "Anal" не выводил всё подряд)
                if (matchScore === 0 && item.tags.includes(token)) {
                    matchScore = 20;
                }

                if (matchScore > 0) {
                    candidates.push({ item: item, score: matchScore });
                }
            });

            // 3. Сортировка и Лимит для слова
            // Берем только топ-2 результата для этого слова
            candidates.sort((a, b) => b.score - a.score);
            const topMatches = candidates.slice(0, 2);

            // 4. Добавление в результаты
            topMatches.forEach(match => {
                if (totalCount >= MAX_TOTAL_RESULTS) return;

                const id = match.item.id;
                
                // Проверка на дубликаты (чтобы не добавить то, что уже есть в глобальных массивах)
                if (onbFoundLikes.includes(id) || onbFoundDislikes.includes(id) || foundLikes.has(id) || foundDislikes.has(id)) return;

                if (mood === 'like') {
                    onbFoundLikes.push(id);
                    foundLikes.add(id);
                } else {
                    onbFoundDislikes.push(id);
                    foundDislikes.add(id);
                }
                totalCount++;
            });
        });

        // --- РЕНДЕР ---
        onbFoundLikes.forEach(id => {
            const item = data.find(x => x.id === id);
            if(item) renderOnbTag(item, container, 'like');
        });
        
        onbFoundDislikes.forEach(id => {
            const item = data.find(x => x.id === id);
            if(item) renderOnbTag(item, container, 'dislike');
        });

        if (onbFoundLikes.length === 0 && onbFoundDislikes.length === 0) {
             container.innerHTML = '<span class="onb-error" style="color:var(--text-secondary); font-size:13px; width:100%; text-align:center; padding:10px;">Nothing found. Try simpler words.</span>';
        }
        
        inputField.value = "";
    }

    function renderOnbTag(item, container, type) {
        const name = getLocalizedName(item);
        const div = document.createElement('div');
        
        // Добавляем класс типа (like/dislike)
        div.className = `onb-tag ${type}`;
        
        // Добавляем иконку
        const icon = type === 'like' ? '💚' : '⛔';
        
        div.innerHTML = `
            ${icon} ${name}
            <span class="onb-tag-remove" style="cursor:pointer; opacity:0.6; margin-left:5px;" onclick="removeOnbTag(${item.id}, '${type}', this)">✕</span>
        `;
        container.appendChild(div);
    }

    function removeOnbTag(id, type, el) {
        if (type === 'like') {
            onbFoundLikes = onbFoundLikes.filter(x => x !== id);
        } else {
            onbFoundDislikes = onbFoundDislikes.filter(x => x !== id);
        }
        el.parentElement.remove();
    }

    function finishOnboarding() {
        let changed = false;

        if (typeof onbFoundLikes !== 'undefined' && onbFoundLikes.length > 0) {
            onbFoundLikes.forEach(id => {
                if (!favorites.includes(id)) {
                    favorites.push(id);
                    blacklist = blacklist.filter(x => x !== id);
                    const item = data.find(x => x.id === id);
                    if (item) {
                        adjustTagScores(item, 5);
                        logActivity('like', item.id, item.tags);
                    }
                }
            });
            changed = true;
        }

        if (typeof onbFoundDislikes !== 'undefined' && onbFoundDislikes.length > 0) {
            onbFoundDislikes.forEach(id => {
                if (!blacklist.includes(id)) {
                    blacklist.push(id);
                    favorites = favorites.filter(x => x !== id);
                    const item = data.find(x => x.id === id);
                    if (item) {
                        adjustTagScores(item, -10);
                        logActivity('dislike', item.id, item.tags);
                    }
                }
            });
            changed = true;
        }
        
        if (changed) {
            saveLists();
            updateCounts();
            if (window.markDirty) window.markDirty();
        }
        
        // Сохраняем флаг, что онбординг пройден
        localStorage.setItem('xch_onboarding_done', 'true');
        
        // Закрываем окно онбординга
        document.getElementById('onboarding-overlay').classList.remove('open');

        // Делаем небольшую задержку (300мс) для плавности
        setTimeout(() => {
            document.getElementById('modal-promo-tips-overlay').classList.add('open');
        }, 300);
    }

    function resetAppHistory() {
        const t = langData[currentLang] || langData['en'];
        
        if (confirm(t.confirm_reset)) {
            // 1. ОЧИСТКА LOCAL STORAGE
            const keysToRemove = [
                STORAGE.HISTORY, 
                STORAGE.ACTIVITY_LOG, 
                STORAGE.TAG_SCORES, 
                STORAGE.BLACKLIST, 
                STORAGE.FAVORITES, 
                STORAGE.WATCH_LATER, 
                STORAGE.WATCH_HISTORY,
                'xch_permanent_explored', // Счетчик открытых фетишей
                'xch_active_days',        // Прогресс Wrapped (дни)
                'xch_wrapped_archive',    // Архив Wrapped
                'xch_achievement_dates',  // Даты ачивок
                'xch_viewed_tips',        // Прочитанные советы
                'xch_last_archive_check'
            ];
            
            keysToRemove.forEach(k => localStorage.removeItem(k));
            
            // 2. СБРОС ГЛОБАЛЬНЫХ ПЕРЕМЕННЫХ (В ПАМЯТИ)
            historyData = [];
            activityLog = [];
            tagScores = {};
            blacklist = [];
            favorites = [];
            watchLater = [];
            watchHistory = [];
            
            // Важные сбросы
            permanentExplored = new Set(); // Сброс счетчика фетишей
            activeDaysSet = new Set();     // Сброс прогресса дней
            wrappedArchive = [];           // Сброс архива
            achievementDates = {};
            viewedTips = [];               // Сброс подсказок
            
            // 3. ОБНОВЛЕНИЕ ИНТЕРФЕЙСА
            updateCounts();
            updateExploredCount(); // Обновляет цифру "0 / 1200"
            renderHistory();
            checkTipIcons();       // Возвращает знаки вопроса (?)
            
            // Сброс UI статистики и Wrapped
            const progressUI = document.getElementById('wrapped-progress-ui');
            if (progressUI) progressUI.remove();
            
            const wBtn = document.getElementById('btn-wrapped-trigger');
            if (wBtn) wBtn.style.display = 'none';

            // Если открыто окно статистики, обновляем его содержимое (чтобы исчез график)
            const statsBody = document.getElementById('modal-stats-body');
            if (statsBody && document.getElementById('modal-stats-overlay').classList.contains('open')) {
                renderStatsContent();
                openStatistics(); // Перерисовываем прогресс-бар (покажет 0/7)
            }

            // 4. СИНХРОНИЗАЦИЯ С ОБЛАКОМ (Отправляем пустые данные)
            if (window.isUserLoggedIn) {
                // Принудительная отправка немедленно
                window.syncToCloud(true);
            }
            
            alert(t.reset_done);
        }
    }

    function openSubModal() {
        // 1. Находим кнопки
        const btnFree = document.querySelector('.plan-card:nth-child(1) .plan-btn'); 
        const btnPro = document.querySelector('.plan-card.pro .plan-btn');
        const btnBeast = document.querySelector('.plan-card.beast .plan-btn');
        const btnBestie = document.querySelector('.plan-card.bestie .plan-btn');

        // 2. Получаем переводы
        const t = langData[currentLang] || langData['en'];

        const tCurrent = t.btn_current || "Current Plan";
        const tExtend = currentLang === 'ru' ? "Продлить" : "Extend"; // Текст для продления
        const tUpgrade = currentLang === 'ru' ? "Улучшить" : "Upgrade"; // Текст для апгрейда
        
        const tPro = t.btn_get_pro || "Get Pro";
        const tBeast = t.btn_get_beast || "Unleash Beast";
        const tBestie = t.btn_get_bestie || "Get Forever"; 

        // Helper: Настройка кнопки
        const configureBtn = (btn, state, buyText, planType) => {
            if (!btn) return; 
            btn.onclick = null;
            btn.classList.remove('current', 'pro-btn', 'beast-btn', 'bestie-btn');
            btn.disabled = false; // По умолчанию активна
            
            if (state === 'current') {
                // ТЕПЕРЬ ТЕКУЩИЙ ПЛАН МОЖНО ПРОДЛИТЬ
                // (Кроме Bestie, он навсегда)
                if (planType === 'bestie') {
                    btn.disabled = true;
                    btn.classList.add('current');
                    btn.innerText = "Purchased";
                } else {
                    // Это Pro или Beast — даем продлить
                    if (btn.closest('.pro')) btn.classList.add('pro-btn');
                    if (btn.closest('.beast')) btn.classList.add('beast-btn');
                    btn.innerText = tExtend; // "Extend"
                    btn.onclick = () => openPaymentSelection(planType);
                }
            } 
            else if (state === 'lower') {
                btn.disabled = true;
                btn.classList.add('current'); 
                btn.innerText = "Included"; // Или галочка       
            } 
            else { // 'buy' или 'upgrade'
                if (btn.closest('.pro')) btn.classList.add('pro-btn');
                if (btn.closest('.beast')) btn.classList.add('beast-btn');
                if (btn.closest('.bestie')) btn.classList.add('bestie-btn');
                
                // Если это апгрейд, пишем Upgrade, иначе стандартный текст
                btn.innerText = state === 'upgrade' ? tUpgrade : buyText;
                btn.onclick = () => openPaymentSelection(planType);
            }
        };

        // ЛОГИКА ОТОБРАЖЕНИЯ
        if (subscriptionLevel === 'bestie') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'lower', null, null);
            configureBtn(btnBeast, 'lower', null, null);
            configureBtn(btnBestie, 'current', null, 'bestie');
        }
        else if (subscriptionLevel === 'beast') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'lower', null, null);
            configureBtn(btnBeast, 'current', null, 'beast'); // Можно продлить
            configureBtn(btnBestie, 'upgrade', tBestie, 'bestie'); 
        } 
        else if (subscriptionLevel === 'pro') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'current', null, 'pro'); // Можно продлить
            configureBtn(btnBeast, 'upgrade', tBeast, 'beast'); // Апгрейд
            configureBtn(btnBestie, 'upgrade', tBestie, 'bestie');
        } 
        else {
            // Free user
            configureBtn(btnFree, 'current', null, null);
            if(btnFree) { btnFree.disabled = true; btnFree.innerText = tCurrent; }

            configureBtn(btnPro, 'buy', tPro, 'pro');
            configureBtn(btnBeast, 'buy', tBeast, 'beast');
            configureBtn(btnBestie, 'buy', tBestie, 'bestie');
        }

        document.getElementById('modal-sub-overlay').classList.add('open');
    }

    function toggleCryptoView(viewName) {
        const main = document.getElementById('crypto-main-view');
        const guide = document.getElementById('crypto-guide-view');
        const problem = document.getElementById('crypto-problem-view');
        const success = document.getElementById('payment-success-msg');

        // Скрываем всё сначала
        main.style.display = 'none';
        guide.style.display = 'none';
        problem.style.display = 'none';
        success.style.display = 'none';

        // Показываем нужное
        if (viewName === 'guide') {
            guide.style.display = 'block';
        } else if (viewName === 'problem') {
            problem.style.display = 'block';
        } else if (viewName === 'success') {
            success.style.display = 'block';
        } else {
            // Default 'main'
            main.style.display = 'block';
        }
    }

    function switchBilling(cycle) {
        const btnMon = document.getElementById('btn-billing-monthly');
        const btnYear = document.getElementById('btn-billing-yearly');
        
        const pricePro = document.getElementById('price-pro');
        const priceBeast = document.getElementById('price-beast');

        if (cycle === 'monthly') {
            currentBillingCycle = '1';
            
            // Переключаем классы активности (используем стили stats-nav-item)
            btnMon.classList.add('active');
            btnYear.classList.remove('active');
            
            // Цены Месяц
            if(pricePro) pricePro.innerHTML = `$2.99 <span style="font-size:12px">/ mo</span>`;
            if(priceBeast) priceBeast.innerHTML = `$4.99 <span style="font-size:12px">/ mo</span>`;
        } 
        else {
            currentBillingCycle = '12';
            
            btnYear.classList.add('active');
            btnMon.classList.remove('active');
            
            // Цены Год (скидка)
            if(pricePro) pricePro.innerHTML = `$29.99 <span style="font-size:12px">/ year</span>`;
            if(priceBeast) priceBeast.innerHTML = `$49.99 <span style="font-size:12px">/ year</span>`;
        }
    }

    async function openPaymentSelection(type) {
        if (!window.isUserLoggedIn) {
            openLoginModal();
            return;
        }

        let finalPlanId = type;
        
        // Добавляем суффикс, если нужно
        if (type === 'pro' || type === 'beast') {
            finalPlanId = `${type}_${currentBillingCycle}`;
        }

        // Ищем кнопку безопасно. Если type кривой, querySelector не упадет с ошибкой.
        let btn = null;
        try {
            // Убеждаемся, что type существует и является допустимым
            if (type && /^[a-zA-Z0-9_-]+$/.test(type)) {
                btn = document.querySelector(`.plan-btn.${type}-btn`);
            }
        } catch (err) {
            console.warn("Кнопка не найдена или селектор неверен:", type);
        }

        const oldText = btn ? btn.innerText : '';
        if(btn) { btn.innerText = "Creating..."; btn.disabled = true; }

        try {
            const response = await fetch(`${API_BASE_URL}/create-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    uid: window.auth.currentUser.uid,
                    plan: finalPlanId
                })
            });

            if (!response.ok) {
                // Пытаемся прочитать текст ошибки от сервера
                const errText = await response.text();
                throw new Error(`Server Error: ${response.status} ${errText}`);
            }

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            showCryptoModal(data);
            closeSubModal(null, true);

        } catch (e) {
            console.error(e);
            alert("Ошибка соединения: " + e.message);
        } finally {
            if(btn) { btn.innerText = oldText; btn.disabled = false; }
        }
    }

    function showCryptoModal(data) {
        const modal = document.getElementById('modal-crypto-payment');
        
        // Форматируем сумму (оставляем 6 знаков после запятой, если они есть)
        // parseFloat уберет лишние нули на конце (например, 5.000000 -> 5)
        const amountStr = parseFloat(data.amount.toFixed(6));
        
        // Вставляем сумму
        const amountEl = document.getElementById('crypto-amount');
        
        // СОХРАНЯЕМ ЧИСТОЕ ЗНАЧЕНИЕ ДЛЯ КОПИРОВАНИЯ В АТРИБУТ
        amountEl.setAttribute('data-val', amountStr);
        
        // Добавляем иконку копирования визуально
        amountEl.innerHTML = `${amountStr} <span style="font-size:14px">USDT</span> <span style="font-size:14px; opacity:0.6;">📋</span>`;
        amountEl.style.color = "#ff9900"; 

        // --- ДОБАВЛЯЕМ ПРЕДУПРЕЖДЕНИЕ О КОМИССИИ ---
        let warnEl = document.getElementById('fee-warning-box');
        if (!warnEl) {
            warnEl = document.createElement('div');
            warnEl.id = 'fee-warning-box';
            warnEl.style.cssText = "font-size:11px; color:#e74c3c; margin-top:5px; line-height:1.2; padding:0 15px; text-align:right;";
            amountEl.parentNode.parentNode.appendChild(warnEl);
        }
        const t = langData[currentLang] || langData['en'];
        warnEl.innerHTML = t.pay_fee_warn || "⚠️ Fee not included!";
        // -------------------------------------------
        
        document.getElementById('crypto-address').innerText = data.address;
        
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&margin=10&data=${data.address}`;
        document.getElementById('crypto-qr-img').src = qrUrl;

        document.getElementById('payment-status-box').style.display = 'block';
        document.getElementById('payment-success-msg').style.display = 'none';
        toggleCryptoView('main');
        
        modal.classList.add('open');

        startCryptoTimer(data.expiresAt);
        startCryptoPolling(data.invoiceId);
    }

    window.closeCryptoModal = function(e, force) {
        if (force || (e && e.target.id === 'modal-crypto-payment')) {
            const modal = document.getElementById('modal-crypto-payment');
            if (modal) modal.classList.remove('open');
            
            // Очистка таймеров
            if (cryptoPollInterval) clearInterval(cryptoPollInterval);
            if (cryptoTimerInterval) clearInterval(cryptoTimerInterval);
        }
    };

    function copyCryptoAddress() {
        const text = document.getElementById('crypto-address').innerText;
        navigator.clipboard.writeText(text).then(() => {
            // Визуальный эффект
            const el = document.getElementById('crypto-address');
            const oldColor = el.style.color;
            el.style.color = "var(--highlight-green)";
            setTimeout(() => el.style.color = oldColor, 300);
            
            // Можно вибрацию добавить на мобильных
            if(navigator.vibrate) navigator.vibrate(50);
        });
    }

    function copyCryptoAmount() {
        const el = document.getElementById('crypto-amount');
        // Берем чистое число из атрибута, который мы установили в showCryptoModal
        const val = el.getAttribute('data-val'); 
        
        if (!val) return;

        navigator.clipboard.writeText(val).then(() => {
            // 1. Вибрация (для мобильных)
            if(navigator.vibrate) navigator.vibrate(50);

            // 2. Визуальный эффект на тексте суммы
            const originalHTML = el.innerHTML;
            const originalColor = el.style.color;
            
            el.style.color = "var(--highlight-green)"; // Зеленый цвет при успехе
            el.style.transform = "scale(1.05)";
            el.style.transition = "all 0.2s";

            // 3. Показываем подсказку "COPIED!"
            const hint = document.getElementById('amount-copy-hint');
            if (hint) {
                hint.style.opacity = '1';
            }

            // Возврат в исходное состояние через 1 сек
            setTimeout(() => {
                el.style.color = originalColor;
                el.style.transform = "scale(1)";
                if (hint) hint.style.opacity = '0';
            }, 1000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert("Copy failed manually select text.");
        });
    }

    function startCryptoPolling(invoiceId) {
        if (cryptoPollInterval) clearInterval(cryptoPollInterval);

        cryptoPollInterval = setInterval(async () => {
            try {
                // Запрос к серверу
                const res = await fetch(`${API_BASE_URL}/check-status/${invoiceId}`);
                const json = await res.json();

                if (json.status === 'paid' || json.status === 'processed') {
                    clearInterval(cryptoPollInterval);
                    clearInterval(cryptoTimerInterval);
                    
                    // Показываем экран успеха
                    document.getElementById('payment-status-box').style.display = 'none';
                    document.getElementById('payment-success-msg').style.display = 'block';
                    document.getElementById('crypto-timer').style.display = 'none';
                    
                    // === БЕЗОПАСНАЯ ВЫДАЧА ССЫЛКИ ===
                    // Если сервер прислал ссылку (значит, проверка на сервере прошла успешно)
                    if (json.discordLink) {
                        const discordBtn = document.getElementById('btn-discord-join');
                        if (discordBtn) {
                            discordBtn.href = json.discordLink; // Вставляем ссылку динамически
                            discordBtn.style.display = 'flex';  // Показываем кнопку
                        }
                    }
                }
                
                if (json.status === 'expired') {
                    clearInterval(cryptoPollInterval);
                    clearInterval(cryptoTimerInterval);
                    alert("Время оплаты истекло. Создайте новый платеж.");
                    closeCryptoModal();
                }
            } catch (e) { console.error("Poll error", e); }
        }, 5000); 
    }

    function startCryptoTimer(expiresAt) {
        if (cryptoTimerInterval) clearInterval(cryptoTimerInterval);
        
        const timerEl = document.getElementById('crypto-timer');
        timerEl.style.display = 'block';

        const update = () => {
            const now = Date.now();
            const diff = expiresAt - now;

            if (diff <= 0) {
                timerEl.innerText = "Expired";
                clearInterval(cryptoTimerInterval);
                return;
            }

            const min = Math.floor(diff / 60000);
            const sec = Math.floor((diff % 60000) / 1000);
            timerEl.innerText = `Expires in ${min}:${sec < 10 ? '0'+sec : sec}`;
        };

        update();
        cryptoTimerInterval = setInterval(update, 1000);
    }

    function closePaymentModal(e, force) {
        if (force || e.target.id === 'modal-payment-overlay') {
            document.getElementById('modal-payment-overlay').classList.remove('open');
        }
    }

    function promptPromoCode() {
        const code = prompt("Enter your activation code (received after payment):");
        if (code) {
            // Вызываем существующую функцию активации
            window.activatePromoCode(code.trim());
            closePaymentModal(null, true);
            closeSubModal(null, true);
        }
    }

    function closeSubModal(e, force) {
        if (force || e.target.id === 'modal-sub-overlay') {
            document.getElementById('modal-sub-overlay').classList.remove('open');
        }
    }

    function checkGenerationLimit(onlyCheck = false) {
        if (subscriptionLevel !== 'free') return true; 

        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        
        // Читаем сохраненные данные
        let count = parseInt(localStorage.getItem('xch_limit_count') || '0');
        let startTime = parseInt(localStorage.getItem('xch_limit_start') || '0');

        // Логика сброса: Если прошло 24 часа с момента старта отсчета — сбрасываем
        if (startTime > 0 && (now - startTime > oneDay)) {
            if (!onlyCheck) {
                count = 0;
                startTime = 0;
                localStorage.setItem('xch_limit_count', '0');
                localStorage.setItem('xch_limit_start', '0');
            } else {
                count = 0; 
            }
        }

        // Если лимит исчерпан
        if (count >= DAILY_LIMIT) {
            
            // Вычисляем время сброса для отображения
            const resetTime = startTime > 0 ? startTime + oneDay : now + oneDay;
            const resetDate = new Date(resetTime);
            
            const dateStr = resetDate.toLocaleString(currentLang, { 
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });

            // --- ОТКРЫВАЕМ ОКНО ---
            if (!onlyCheck) {
                openLimitModal(dateStr); 
            }
            
            // Обновляем кнопку подписки (красная)
            updateSubscriptionUI();
            
            return false;
        }

        if (onlyCheck) return true; 

        // Списание
        if (count === 0 || startTime === 0) {
            localStorage.setItem('xch_limit_start', now);
        }

        count++;
        localStorage.setItem('xch_limit_count', count);
        
        updateSubscriptionUI(); 
        
        return true;
    }

    function updateSubscriptionUI() {
        // Данные
        subscriptionLevel = localStorage.getItem('xch_sub_level') || 'free';
        const t = langData[currentLang] || langData['en'];

        // --- ОБНОВЛЕНИЕ КНОПКИ В С АЙДБАРЕ ---
        const loginBtnText = document.getElementById('login-btn-text');
        
        if (loginBtnText) {
            if (window.isUserLoggedIn) {
                // Если залогинен: "Account • PRO"
                const planLabel = subscriptionLevel.toUpperCase();
                // Цвет для плана
                let colorStyle = 'color:var(--text-secondary);';
                if (subscriptionLevel === 'pro') colorStyle = 'color:#ff9900; font-weight:800;';
                if (subscriptionLevel === 'beast') colorStyle = 'color:#9b59b6; font-weight:800;';
                if (subscriptionLevel === 'bestie') colorStyle = 'color:#00d2ff; font-weight:800;';

                const accText = t.personal_account || "Personal Account";
                loginBtnText.innerHTML = `${accText} <span style="font-size:13px; margin-left:6px; ${colorStyle}">• ${planLabel}</span>`;
            } else {
                // Если не залогинен: "Sync / Login"
                loginBtnText.innerText = t.login_text || "Sync / Login";
            }
        }

        // --- ОБНОВЛЕНИЕ СЧЕТЧИКА ЛИМИТОВ (Карточка Free в модалке) ---
        const freeLimitRow = document.getElementById('free-limit-row');
        const count = parseInt(localStorage.getItem('xch_limit_count') || '0');
        const remaining = Math.max(0, DAILY_LIMIT - count);

        if (freeLimitRow) {
            if (subscriptionLevel === 'free') {
                let text = t.limit_text_full || `🎲 ${DAILY_LIMIT} Generations / day (left: {n}/${DAILY_LIMIT})`;
                text = text.replace('{n}', remaining);
                freeLimitRow.innerHTML = text;
                freeLimitRow.style.color = remaining === 0 ? "var(--highlight-red)" : "";
            } else {
                freeLimitRow.innerHTML = t.feat_limit || `🎲 ${DAILY_LIMIT} Generations / day`;
                freeLimitRow.style.color = ""; 
            }
        }

        // --- НАСТРОЙКА КНОПОК ПОКУПКИ (Pro/Beast/Bestie) ---
        const configureBtn = (btn, state, buyText, planType) => {
            if (!btn) return;
            btn.onclick = null;
            btn.classList.remove('current', 'pro-btn', 'beast-btn', 'bestie-btn');
            btn.disabled = false;
            btn.style.opacity = "1";

            const tCurrent = t.btn_current || "Current Plan";
            const tExtend = currentLang === 'ru' ? "Продлить" : "Extend"; 
            const tUpgrade = currentLang === 'ru' ? "Улучшить" : "Upgrade";
            const tLower = t.btn_lower_tier || "Included";

            if (state === 'current') {
                if (planType === 'bestie') {
                    btn.disabled = true; btn.classList.add('current'); btn.innerText = "Purchased";
                } else {
                    if (btn.closest('.pro')) btn.classList.add('pro-btn');
                    if (btn.closest('.beast')) btn.classList.add('beast-btn');
                    btn.innerText = tExtend; 
                    btn.onclick = () => openPaymentSelection(planType);
                }
            } else if (state === 'lower') {
                btn.disabled = true; 
                btn.classList.add('current'); 
                
                btn.innerText = t.btn_lower_tier || "You deserve better"; 
                
                btn.style.opacity = "0.6";
            } else { 
                if (btn.closest('.pro')) btn.classList.add('pro-btn');
                if (btn.closest('.beast')) btn.classList.add('beast-btn');
                if (btn.closest('.bestie')) btn.classList.add('bestie-btn');
                btn.innerText = state === 'upgrade' ? tUpgrade : buyText;
                btn.onclick = () => openPaymentSelection(planType);
            }
        };

        const btnFree = document.querySelector('.plan-card:nth-child(1) .plan-btn'); 
        const btnPro = document.querySelector('.plan-card.pro .plan-btn');
        const btnBeast = document.querySelector('.plan-card.beast .plan-btn');
        const btnBestie = document.querySelector('.plan-card.bestie .plan-btn');
        const tPro = t.btn_get_pro || "Get Pro";
        const tBeast = t.btn_get_beast || "Unleash Beast";
        const tBestie = t.btn_get_bestie || "Get Forever"; 

        if (subscriptionLevel === 'bestie') {
            configureBtn(btnFree, 'lower'); configureBtn(btnPro, 'lower'); configureBtn(btnBeast, 'lower'); configureBtn(btnBestie, 'current', null, 'bestie');
        } else if (subscriptionLevel === 'beast') {
            configureBtn(btnFree, 'lower'); configureBtn(btnPro, 'lower'); configureBtn(btnBeast, 'current', null, 'beast'); configureBtn(btnBestie, 'upgrade', tBestie, 'bestie');
        } else if (subscriptionLevel === 'pro') {
            configureBtn(btnFree, 'lower'); configureBtn(btnPro, 'current', null, 'pro'); configureBtn(btnBeast, 'upgrade', tBeast, 'beast'); configureBtn(btnBestie, 'upgrade', tBestie, 'bestie');
        } else {
            configureBtn(btnFree, 'current'); if(btnFree){btnFree.disabled=true; btnFree.innerText=t.btn_current;}
            configureBtn(btnPro, 'buy', tPro, 'pro'); configureBtn(btnBeast, 'buy', tBeast, 'beast'); configureBtn(btnBestie, 'buy', tBestie, 'bestie');
        }
    }

    function openBoosty(url) {
        if (!window.isUserLoggedIn) {
            // Если не залогинен - требуем вход
            alert(langData[currentLang].login_required || "Please log in (Sync Data) first so we can activate your subscription!");
            
            // Скроллим к кнопке входа и подсвечиваем её (опционально)
            switchTab('account');
            const loginBtn = document.getElementById('login-capsule');
            if(loginBtn) {
                loginBtn.style.border = "1px solid var(--accent)";
                setTimeout(() => loginBtn.style.border = "none", 1000);
            }
            return;
        }
        // Если залогинен - открываем
        window.open(url, '_blank');
    }

    function openThemeModal() {
        if (!isPreviewActive) {
            originalThemeId = localStorage.getItem('xch_theme_id') || 'dark';
        }
        
        renderThemes();
        document.getElementById('modal-theme-overlay').classList.add('open');
    }

    function closeThemeModal(e, force) {
        if (force || e.target.id === 'modal-theme-overlay') {
            document.getElementById('modal-theme-overlay').classList.remove('open');
        }
    }

    function openLimitModal(resetTimeStr) {
        const modal = document.getElementById('modal-limit-overlay');
        const textEl = document.getElementById('limit-custom-text');
        const timeEl = document.getElementById('limit-reset-time');
        
        // Берем перевод фразы
        const t = langData[currentLang] || langData['en'];
        if (textEl) textEl.innerText = t.limit_desc_fun;
        
        // Обновляем время сброса
        if (timeEl) {
            const label = currentLang === 'ru' ? "Сброс:" : "Reset:";
            timeEl.innerText = `${label} ${resetTimeStr}`;
        }

        modal.classList.add('open');
    }

    function closeLimitModal(e, force) {
        if (force || e.target.id === 'modal-limit-overlay') {
            document.getElementById('modal-limit-overlay').classList.remove('open');
        }
    }

    function renderThemes() {
        const basicCont = document.getElementById('theme-list-basic');
        const premCont = document.getElementById('theme-list-premium');
        
        // Активная тема (если превью - показываем её, иначе сохраненную)
        const currentId = document.body.getAttribute('data-theme') || 'dark';
        
        const t = langData[currentLang] || langData['en'];
        
        basicCont.innerHTML = '';
        premCont.innerHTML = '';

        APP_THEMES.forEach(theme => {
            const isLocked = (theme.type === 'pro' && subscriptionLevel === 'free');
            const isActive = (currentId === theme.id);
            
            const themeKey = 'theme_' + theme.id;
            const localizedName = (t && t[themeKey]) ? t[themeKey] : theme.name;
            
            let typeText = theme.isLight ? 'Light' : 'Dark';
            // (Локализация типа - оставьте свой старый код здесь если есть)

            // ИКОНКА СТАТУСА:
            // Если активно -> Галочка
            // Если закрыто -> "PRO"
            // Иначе -> пусто
            let statusIcon = '';
            if (isActive) {
                statusIcon = '<span class="lock-icon" style="color:var(--accent)">✓</span>';
            } else if (isLocked) {
                statusIcon = '<span class="pro-badge-icon">PRO</span>';
            }

            const div = document.createElement('div');
            // Убираем класс locked, чтобы не было прозрачности (пользователь должен хотеть нажать)
            div.className = `theme-item ${isActive ? 'active' : ''}`;
            
            div.innerHTML = `
                <div class="theme-preview-box" style="background: ${theme.preview}; border: 1px solid var(--border);">
                    <span style="font-size:10px; font-weight:700; color:${theme.isLight ? '#000' : '#fff'}">Aa</span>
                </div>
                <div class="theme-info">
                    <span class="theme-name">${localizedName}</span>
                    <span class="theme-type" style="color: ${theme.type==='pro' ? 'var(--accent)' : 'var(--text-secondary)'}">
                        ${typeText}
                    </span>
                </div>
                ${statusIcon}
            `;

            div.onclick = () => selectTheme(theme);
            
            if (theme.type === 'free') basicCont.appendChild(div);
            else premCont.appendChild(div);
        });
    }

    function selectTheme(theme) {
        const isLocked = (theme.type === 'pro' && subscriptionLevel === 'free');

        if (isLocked) {
            // == ЗАПУСК ПРЕДПРОСМОТРА ==
            startPreview(theme.id);
        } else {
            // == ОБЫЧНЫЙ ВЫБОР ==
            applyTheme(theme.id, true); // Сохраняем
            originalThemeId = theme.id; // Обновляем оригинал
            renderThemes(); // Обновляем галочки
        }
    }

    function startPreview(themeId) {
        isPreviewActive = true;

        // 1. Применяем тему визуально (без сохранения)
        applyTheme(themeId, false);

        // 2. Закрываем окно тем
        document.getElementById('modal-theme-overlay').classList.remove('open');

        // 3. Переходим на главную (если мобилка), чтобы было видно красоту
        if (window.innerWidth < 768) {
            switchTab('home');
            // Скроллим наверх
            const home = document.getElementById('tab-home');
            if(home) home.scrollTop = 0;
        }

        // 4. Показываем плашку снизу
        const bar = document.getElementById('preview-floating-bar');
        bar.classList.add('visible');

        // 5. Добавляем слушатель клика "в никуда" для отмены
        // Делаем небольшую задержку, чтобы текущий клик не сработал сразу
        setTimeout(() => {
            document.addEventListener('click', handlePreviewOutsideClick);
        }, 100);
    }

    function handlePreviewOutsideClick(e) {
        const bar = document.getElementById('preview-floating-bar');
        
        // Если кликнули ВНУТРИ плашки (кнопка Unlock), ничего не делаем (там свой onclick)
        if (bar.contains(e.target)) return;

        // Если кликнули МИМО -> Отмена
        cancelPreview();
    }

    // Отмена предпросмотра (возврат)
    function cancelPreview() {
        if (!isPreviewActive) return;
        isPreviewActive = false;

        // 1. Возвращаем старую тему
        if (originalThemeId) {
            applyTheme(originalThemeId, true);
        }

        // 2. Скрываем плашку
        document.getElementById('preview-floating-bar').classList.remove('visible');

        // 3. Удаляем слушатель кликов
        document.removeEventListener('click', handlePreviewOutsideClick);

        // 4. Открываем окно тем обратно
        openThemeModal();
    }

    // Покупка из режима предпросмотра
    function buyFromPreview(e) {
        // Останавливаем всплытие, чтобы не сработал handlePreviewOutsideClick
        if(e) e.stopPropagation();

        // 1. Убираем слушатель отмены (чтобы не моргало)
        document.removeEventListener('click', handlePreviewOutsideClick);
        
        // 2. Возвращаем тему (пока не купил) - опционально, но безопаснее
        applyTheme(originalThemeId, true);
        isPreviewActive = false;
        
        // 3. Скрываем плашку
        document.getElementById('preview-floating-bar').classList.remove('visible');

        // 4. Открываем окно оплаты
        openSubModal();
    }

    function buyCurrentPreview() {
        closeThemeModal(null, true);
        openSubModal();
    }

    function getThemeLogoSrc(themeId) {
        const logoMap = {
            // Фиолетовая
            'purple-dark': 'amethyst_icon.png',
            'purple-light': 'amethyst_icon.png',
            
            // Зеленая
            'green-dark': 'forest_icon.png',
            'green-light': 'forest_icon.png',
            
            // Золотая
            'gold-dark': 'gold_icon.png',
            'gold-light': 'gold_icon.png',
            
            // Оранжевая
            'orange-dark': 'magma_icon.png',
            'orange-light': 'magma_icon.png',
            
            // Синяя
            'blue-dark': 'midnight_icon.png', 
            'blue-light': 'midnight_icon.png',
            
            // Красная
            'red-dark': 'vampire_icon.png',
            'red-light': 'vampire_icon.png',
            
            // Нуар
            'noir': 'noir_icon.png',

            // Old Money 
            'old-money': 'oldmoney_icon.png', 
        };

        // Если темы нет в списке (например, 'dark' или 'light'), возвращаем дефолт
        return logoMap[themeId] || 'logo.png';
    }

    function updateGlobalLogos(themeId) {
        // Получаем правильную картинку через новую функцию
        const newSrc = getThemeLogoSrc(themeId);

        // --- 1. ОБНОВЛЕНИЕ ЛОГОТИПОВ ВНУТРИ САЙТА ---
        document.querySelectorAll('.logo-img').forEach(img => {
            img.src = newSrc;
        });
        
        // Лого в окне установки приложения
        const installLogo = document.querySelector('#modal-install-overlay img');
        if (installLogo && installLogo.src.includes('logo')) {
            installLogo.src = newSrc;
        }
        
        // Лого в финальной карточке Wrapped 
        const wrappedLogo = document.querySelector('.sum-logo-img');
        if (wrappedLogo) {
            wrappedLogo.src = newSrc;
        }

        // --- 2. ОБНОВЛЕНИЕ ФАВИКОНОК ---
        const faviconSrc = (themeId === 'dark' || themeId === 'light') ? 'logo_icon.png' : newSrc;

        let linkIcon = document.querySelector("link[rel~='icon']");
        if (!linkIcon) {
            linkIcon = document.createElement('link');
            linkIcon.rel = 'icon';
            document.head.appendChild(linkIcon);
        }
        linkIcon.href = faviconSrc;

        let linkApple = document.querySelector("link[rel~='apple-touch-icon']");
        if (!linkApple) {
            linkApple = document.createElement('link');
            linkApple.rel = 'apple-touch-icon';
            document.head.appendChild(linkApple);
        }
        linkApple.href = faviconSrc;
    }

    function applyTheme(themeId, save = true) {
        // Если сохраняем, пишем в память
        if (save) {
            localStorage.setItem('xch_theme_id', themeId);
        }
        
        const root = document.documentElement;
        
        // Устанавливаем атрибут для CSS
        document.body.setAttribute('data-theme', themeId);

        updateGlobalLogos(themeId); 

        const theme = APP_THEMES.find(t => t.id === themeId);
        if (!theme) return;
        
        document.body.classList.toggle('light-theme', theme.isLight);
        
        const props = ['--bg-color', '--sidebar-bg', '--card-bg', '--nav-bg', '--border', '--ios-card', '--ios-bg', '--card-gradient'];
        props.forEach(p => root.style.removeProperty(p));
        
        if (theme.colors) {
            if (theme.colors.bg) {
                root.style.setProperty('--bg-color', theme.colors.bg);
                root.style.setProperty('--ios-bg', theme.colors.bg);
            }
            if (theme.colors.sidebar) root.style.setProperty('--sidebar-bg', theme.colors.sidebar);
            if (theme.colors.card) {
                root.style.setProperty('--card-bg', theme.colors.card);
                root.style.setProperty('--ios-card', theme.colors.card);
                root.style.setProperty('--card-gradient', `linear-gradient(165deg, ${theme.colors.card}, ${theme.colors.bg})`);
            }
            if (theme.colors.nav) root.style.setProperty('--nav-bg', theme.colors.nav);
            if (theme.colors.border) {
                root.style.setProperty('--border', theme.colors.border);
                root.style.setProperty('--ios-separator', theme.colors.border);
            }
        }

        if (theme.accent) {
            root.style.setProperty('--accent', theme.accent);
            root.style.setProperty('--accent-light', theme.accentLight || theme.accent);
        } else {
            updateLink(); // Для дефолтных тем пересчитываем цвета из платформы
        }

        // Обновляем текст в кнопке настроек
        updateThemeLabel(theme.id);
    }
    
    //  функция обновления текста в кнопке
    function updateThemeLabel(themeId) {
        // 1. Если ID не передан, пытаемся найти текущий активный (из атрибута body или памяти)
        if (!themeId) {
            themeId = document.body.getAttribute('data-theme') || localStorage.getItem('xch_theme_id') || 'dark';
        }
        
        // 2. Берем текущий словарь переводов
        const t = langData[currentLang] || langData['en'];
        const label = document.getElementById('current-theme-name');
        
        if (label) {
            // Формируем ключ (например, theme_blue-dark)
            const key = 'theme_' + themeId;
            
            // 3. ПРИОРИТЕТ: Ищем в переводах
            if (t && t[key]) {
                label.innerText = t[key];
            } else {
                // Фолбек: Ищем в массиве тем (там английские названия)
                const themeObj = APP_THEMES.find(x => x.id === themeId);
                label.innerText = themeObj ? themeObj.name : themeId;
            }
        }
    }

    function initSwipeCards() {
        const card = document.getElementById('card-block');
        const overlay = document.querySelector('.swipe-overlay'); 
        
        // Элементы декора (Иконки)
        const iconLeft = document.querySelector('.icon-left');
        const iconRight = document.querySelector('.icon-right');
        const statusText = document.getElementById('status-text');

        // Элементы, которые нужно размывать
        const blurTargets = [
            document.getElementById('slot-reel'),
            document.getElementById('result-desc'),
            document.getElementById('badge-wrapper'),
            document.getElementById('related-block'),
            document.getElementById('tinder-controls') 
        ];

        if (!card) return;

        // Базовые углы наклона иконок
        const leftBaseRot = -20;
        const rightBaseRot = 15;

        // --- 1. START (Начало касания) ---
        card.addEventListener('touchstart', (e) => {
            // 1. ИГНОРИРУЕМ СКРОЛЛРУЕМЫЕ ЭЛЕМЕНТЫ
            if (e.target.closest('.related-tags') || e.target.closest('#related-tags')) {
                return;
            }

            // 2. Игнорируем другие интерактивные элементы
            if (e.target.closest('button') || 
                e.target.closest('.related-item-btn') || 
                e.target.closest('.capsule-trigger') || 
                e.target.closest('.tag')) return;
            
            if (isGenerating) return;

            // ПРОВЕРКА ЛИМИТА
            if (typeof checkGenerationLimit === 'function' && !checkGenerationLimit(true)) return;

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            currentX = startX;
            currentY = startY;
            isDragging = true;
            
            // Отключаем плавность для мгновенной реакции
            card.style.transition = 'none';
            if (statusText) statusText.style.transition = 'none';
            if (overlay) overlay.style.transition = 'none';
            
            // Пауза анимации иконок
            if(iconLeft) {
                iconLeft.style.transition = 'none';
                iconLeft.style.animation = 'none'; 
            }
            if(iconRight) {
                iconRight.style.transition = 'none';
                iconRight.style.animation = 'none'; 
            }
            
        }, {passive: false});

        // --- 2. MOVE ---
        card.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;
            let deltaX = currentX - startX;
            let deltaY = currentY - startY; 

            // Блокируем скролл страницы, если тянем карточку
            if (Math.abs(deltaX) > 10 && e.cancelable) e.preventDefault();

            // А. ДВИЖЕНИЕ КАРТОЧКИ
            let rotate = deltaX * 0.05;
            card.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;

            // Б. ДВИЖЕНИЕ ТЕКСТА (Над карточкой)
            if (statusText) {
                statusText.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;
            }

            // В. ПАРАЛЛАКС ИКОНОК (Если они есть)
            if (iconLeft) {
                iconLeft.style.transform = `translate(${deltaX * 1.2}px, ${deltaY * 0.6}px) rotate(${leftBaseRot + (deltaX * 0.1)}deg)`;
            }
            if (iconRight) {
                iconRight.style.transform = `translate(${deltaX * 0.7}px, ${deltaY * 0.3}px) rotate(${rightBaseRot - (deltaX * 0.05)}deg)`;
            }

            // Г. ЭФФЕКТЫ (ЦВЕТ + БЛЮР) - Самое важное!
            const progress = Math.min(Math.abs(deltaX) / 150, 1); // 0...1 (1 = полный свайп)
            
            // Заливка цветом
            if (overlay) {
                const alpha = progress * 0.85; // Максимум 85% непрозрачности
                if (deltaX > 0) {
                    // Вправо (Зеленый)
                    overlay.style.backgroundColor = `rgba(46, 204, 113, ${alpha})`; 
                } else {
                    // Влево (Красный)
                    overlay.style.backgroundColor = `rgba(231, 76, 60, ${alpha})`; 
                }
            }

            // Блюр контента
            const blurAmount = progress * 8; // Максимум 8px блюра
            blurTargets.forEach(el => { 
                if(el) el.style.filter = `blur(${blurAmount}px)`; 
            });

        }, {passive: false});

        // --- 3. END ---
        card.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            
            let deltaX = currentX - startX;
            const threshold = window.innerWidth * 0.25; // Свайпнуть нужно на 25% ширины экрана

            if (Math.abs(deltaX) > threshold) {
                // === УЛЕТАЕТ ===
                const direction = deltaX > 0 ? 'right' : 'left';

                if (isModeSelectionActive) {
                    // Анимация улета карточки
                    card.style.transition = 'transform 0.3s ease-out';
                    card.style.transform = `translateX(${direction === 'right' ? 500 : -500}px)`;

                    setTimeout(() => {
                        // Возврат
                        card.style.transition = 'none';
                        card.style.transform = '';
                        
                        // Логика
                        if (direction === 'right') {
                            setAppModeAndStart('pleasure'); // Вправо -> Привычное (Наслаждение)
                        } else {
                            setAppModeAndStart('explore');  // Влево -> Новое (Исследование)
                        }
                    }, 300);
                    return;
                }

                const endX = deltaX > 0 ? window.innerWidth + 200 : -window.innerWidth - 200;
                
                // Запускаем анимацию вылета
                card.style.transition = 'transform 0.3s ease-out';
                card.style.transform = `translateX(${endX}px) rotate(${endX * 0.05}deg)`;

                // Текст тоже улетает
                if (statusText) {
                    statusText.style.transition = 'transform 0.3s ease-out';
                    statusText.style.transform = `translateX(${endX}px) rotate(${endX * 0.05}deg)`;
                }

                // Иконки улетают
                if(iconLeft) {
                    iconLeft.style.transition = 'transform 0.3s ease-out, opacity 0.3s';
                    iconLeft.style.opacity = '0';
                    iconLeft.style.transform = `translate(${endX}px, -50px)`;
                }
                if(iconRight) {
                    iconRight.style.transition = 'transform 0.3s ease-out, opacity 0.3s';
                    iconRight.style.opacity = '0';
                    iconRight.style.transform = `translate(${endX}px, -20px)`;
                }

                // Вызываем логику
                setTimeout(() => {
                    handleSwipeAction(direction);
                }, 300);

            } else {
                // === ВОЗВРАТ НА МЕСТО (Отмена свайпа) ===
                
                // Убираем блюр плавно
                blurTargets.forEach(el => { 
                    if(el) { 
                        el.style.transition = 'filter 0.3s ease'; 
                        el.style.filter = 'none'; 
                    } 
                });

                // Убираем цвет оверлея плавно
                if (overlay) { 
                    overlay.style.transition = 'background-color 0.3s ease'; 
                    overlay.style.backgroundColor = 'transparent'; 
                }

                // Возвращаем карточку
                card.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                card.style.transform = 'translateX(0) rotate(0)';

                // Возвращаем текст
                if (statusText) {
                    statusText.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    statusText.style.transform = 'translateX(0) rotate(0)';
                }

                // Возвращаем иконки
                if(iconLeft) {
                    iconLeft.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    iconLeft.style.transform = `translate(0px, 0px) rotate(${leftBaseRot}deg)`;
                    setTimeout(() => { iconLeft.style.animation = ''; }, 400); // Возвращаем парение
                }
                if(iconRight) {
                    iconRight.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    iconRight.style.transform = `translate(0px, 0px) rotate(${rightBaseRot}deg)`;
                    setTimeout(() => { iconRight.style.animation = ''; }, 400);
                }
            }
        });
    }

    function handleSwipeAction(direction) {
        // 1. Проверка лимита
        if (typeof checkGenerationLimit === 'function' && !checkGenerationLimit(true)) return;

        if (isGenerating) return;
        if (currentItem) sessionHistoryStack.push(currentItem);

        const wrapper = document.getElementById('card-anim-wrapper');
        const card = document.getElementById('card-block');
        const btnUndo = document.getElementById('btn-t-undo');
        
        // Элементы для эффектов (Те же, что и в свайпах)
        const overlay = document.querySelector('.swipe-overlay');
        const blurTargets = [
            document.getElementById('slot-reel'),
            document.getElementById('result-desc'),
            document.getElementById('badge-wrapper'),
            document.getElementById('related-block'),
            document.getElementById('tinder-controls')
        ];

        if(btnUndo) btnUndo.disabled = true;

        if (direction === 'right') toggleFavorite(true); 
        else toggleBlacklist(true);

        // Проверяем, сдвинута ли карточка пальцем
        // Если transform == 'none', значит карточка стоит в центре -> это клик по кнопке
        const currentTransform = getComputedStyle(card).transform;
        const isCardCentered = currentTransform === 'none' || currentTransform === 'matrix(1, 0, 0, 1, 0, 0)';

        if (isCardCentered && wrapper) {
            // === ЭТО КЛИК ПО КНОПКЕ ===
            
            // 1. Применяем цвет и блюр (Визуальный отклик)
            if (overlay) {
                overlay.style.transition = 'background-color 0.2s ease';
                if (direction === 'right') {
                    overlay.style.backgroundColor = 'rgba(46, 204, 113, 0.8)'; // Зеленый
                } else {
                    overlay.style.backgroundColor = 'rgba(231, 76, 60, 0.8)'; // Красный
                }
            }

            blurTargets.forEach(el => {
                if(el) {
                    el.style.transition = 'filter 0.2s ease';
                    el.style.filter = 'blur(5px)'; // Блюрим контент
                }
            });

            // 2. Анимируем улет всей ОБЁРТКИ
            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.opacity = '0';
            
            if (direction === 'right') {
                wrapper.style.transform = 'translateX(150%) rotate(10deg)';
            } else {
                wrapper.style.transform = 'translateX(-150%) rotate(-10deg)';
            }

            setTimeout(() => {
                startGeneration(
                    direction === 'right' ? 'similar' : 'random', 
                    direction === 'right' ? 'like' : 'dislike'
                );
            }, 300);
        } else {
            // === ЭТО БЫЛ СВАЙП ПАЛЬЦЕМ (Эффекты уже применены в touchmove) ===
            startGeneration(
                direction === 'right' ? 'similar' : 'random', 
                direction === 'right' ? 'like' : 'dislike'
            );
        }
    }

    function animateSwipeEnd(moveX, direction) {
        const card = document.getElementById('card-block');
        card.style.transition = 'transform 0.3s ease-out';
        card.style.transform = `translateX(${moveX}px) rotate(${moveX * 0.05}deg)`;
        
        // Ждем окончания анимации вылета, затем запускаем логику
        setTimeout(() => {
            handleSwipeAction(direction);
        }, 300);
    }

    function undoLastAction() {
        // Если стек пуст, возвращаемся на стартовый экран
        if (sessionHistoryStack.length === 0) {
            resetToHome();
            return;
        }

        // Иначе выполняем стандартный откат
        const prevItem = sessionHistoryStack.pop();
        const card = document.getElementById('card-block');
        
        card.classList.remove('restore-anim', 'anim-fly-left', 'anim-fly-right');
        card.style.transform = 'none';
        void card.offsetWidth; 
        
        card.classList.add('has-results');
        card.classList.add('anim-fly-right');

        setTimeout(() => {
            forceShowResult(prevItem, 'undo'); 
            setTimeout(() => card.classList.remove('anim-fly-right'), 700);
        }, 50);

        // После отката проверяем кнопку снова (визуально можно сделать её ярче или тусклее, 
        // но теперь она всегда активна, т.к. ведет домой)
        const undoBtn = document.getElementById('btn-t-undo');
        if(undoBtn) undoBtn.disabled = false;
    }

    function startGeneration(mode, direction = 'next', specificId = null) {
        // 1. Проверки состояния
        if (isPanicMode) {
            generatePanicCard(direction);
            return;
        }
        if (!checkGenerationLimit()) return; 
        if (isGenerating) return;

        randomizeDecorations();

        // 2. Сброс модификаторов (базовый)
        activeMods.clear(); 
        if (currentOrientation === 'gay') activeMods.add('Gay');
        else if (currentOrientation === 'trans') activeMods.add('Trans');
        
        // === ЛОГИКА 1: КОНКРЕТНЫЙ ПРЕДМЕТ (из приветствия или истории) ===
        if (mode === 'specific' && specificId) {
            const targetItem = data.find(i => i.id === specificId);
            
            if (targetItem) {
                // Сразу запускаем анимацию с этим предметом
                // Используем mode='random', чтобы сработала стандартная логика объяснения ("Судьба" или "Потому что ты любишь")
                launchAnimation(targetItem, 'random', direction);
                return;
            }
            // Если предмет не найден (удален из базы), проваливаемся в обычный рандом
        }

        // === ЛОГИКА 2: ВБРОСЫ (INJECTIONS) - WL / Favs / Ban ===
        if (mode === 'random') {
            const roll = Math.random(); 
            const depth = sessionHistoryStack.length; 

            const isValidInjection = (item) => {
                if (!item) return false;
                if (cooldownList.includes(item.id)) return false; 
                if (currentOrientation === 'gay' && !item.tags.includes('gay')) return false;
                if (currentOrientation === 'hetero' && item.tags.includes('gay')) return false;
                if (currentOrientation === 'trans' && !item.tags.some(t=>['trans','shemale'].includes(t))) return false;
                return true;
            };

            let targetItem = null;
            let injectionMode = null;

            // 1. WATCH LATER (12%)
            if (roll < 0.12 && watchLater.length > 0 && depth > 2) {
                const candidate = data.find(x => x.id === watchLater[Math.floor(Math.random() * watchLater.length)]);
                if (isValidInjection(candidate)) { targetItem = candidate; injectionMode = 'wl_reminder'; }
            }
            // 2. FAVORITES (4%)
            else if (roll >= 0.12 && roll < 0.16 && favorites.length > 0 && depth > 5) {
                const candidate = data.find(x => x.id === favorites[Math.floor(Math.random() * favorites.length)]);
                if (isValidInjection(candidate)) { targetItem = candidate; injectionMode = 'fav_reminder'; }
            }
            // 3. BLACKLIST (1.5%)
            else if (roll >= 0.16 && roll < 0.175 && blacklist.length > 0 && depth > 10) {
                const candidate = data.find(x => x.id === blacklist[Math.floor(Math.random() * blacklist.length)]);
                if (isValidInjection(candidate)) { targetItem = candidate; injectionMode = 'ban_reminder'; }
            }

            // Если вброс сработал
            if (targetItem && injectionMode) {
                console.log(`Injection Triggered: ${injectionMode}`);
                // Запускаем анимацию вброса
                launchAnimation(targetItem, injectionMode, direction);
                return; 
            }
        }

        // === ЛОГИКА 3: СТАНДАРТНЫЙ РАНДОМ И ФИЛЬТРАЦИЯ ===
        
        // Корректировка весов на основе предыдущего действия (если это рандом)
        if (mode === 'random' && currentItem && !hasInteractedWithCurrent) {
            if (watchLater.includes(currentItem.id)) adjustTagScores(currentItem, 1);
            else adjustTagScores(currentItem, -1);
        }
        if (mode === 'similar' && currentItem) adjustTagScores(currentItem, 1);

        // Фильтрация
        let filtered = filterData();
        
        // Если режим "Похожее"
        if (mode === 'similar' && lastGeneratedItem) {
            const subset = filtered.filter(item => {
                if (item.id === lastGeneratedItem.id) return false;
                const intersection = item.tags.filter(t => lastGeneratedItem.tags.includes(t));
                return intersection.length >= 2;
            });
            if (subset.length > 0) filtered = subset;
        }

        // Если пусто
        if (filtered.length === 0) {
            const reel = document.getElementById('slot-reel');
            reel.innerHTML = `<div class="slot-item" style="color:var(--highlight-red);">List Empty</div>`;
            document.getElementById('tinder-controls').classList.remove('hidden-initial');
            return;
        }

        // Выбор победителя
        const finalItem = getWeightedRandom(filtered);

        // Запуск анимации
        launchAnimation(finalItem, mode, direction);
    }

    function launchAnimation(finalItem, mode, direction) {
        // 1. Блокируем интерфейс
        isGenerating = true;
        hasInteractedWithCurrent = false;
        hasWatchedCurrentItem = false;

        // 2. Обновляем UI модификаторов (рендерим те, что есть по дефолту)
        renderModifiers();

        // 3. Очистка старого контента карточки
        const descEl = document.getElementById('result-desc');
        if(descEl) descEl.style.display = 'none';
        const statusText = document.getElementById('status-text');
        if(statusText) statusText.innerText = ''; 
        document.getElementById('badge-wrapper').innerHTML = '';
        
        document.getElementById('mods-capsule').classList.remove('open');
        const modContainer = document.getElementById('mod-container');
        if (modContainer) modContainer.classList.remove('open');
        
        // Скрываем кнопки управления
        const uiToHide = ['tinder-controls', 'mods-block', 'related-block'];
        uiToHide.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('hidden-initial'); 
            }
        });

        // 4. Сброс стилей карточки
        const card = document.getElementById('card-block');
        const wrapper = document.getElementById('card-anim-wrapper');
        const overlay = document.querySelector('.swipe-overlay');
        const iconLeft = document.querySelector('.icon-left');
        const iconRight = document.querySelector('.icon-right');

        if (wrapper) {
            wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
            wrapper.style.transform = '';
            wrapper.style.transition = '';
            wrapper.style.opacity = '1';
        }

        if(card) {
            card.classList.remove('status-wl', 'status-fav', 'status-ban');
            card.classList.remove('flash-active', 'has-results'); 
            card.style.transform = ''; 
            card.style.transition = '';
            card.style.opacity = '1'; 
            card.style.backgroundColor = '';
            card.style.borderColor = '';
            card.style.filter = '';
            
            if (overlay) {
                overlay.style.transition = 'none';
                overlay.style.backgroundColor = 'transparent';
                overlay.style.opacity = ''; 
            }
            
            // Сброс блюра
            const blurTargets = [
                document.getElementById('slot-reel'), 
                document.getElementById('result-desc'), 
                document.getElementById('badge-wrapper'), 
                document.getElementById('related-block'),
                document.getElementById('tinder-controls')
            ];
            blurTargets.forEach(el => { 
                if(el) { el.style.transition = 'none'; el.style.filter = 'none'; }
            });
            
            void card.offsetWidth; // Force reflow
        }

        // Сброс иконок
        if(iconLeft) {
            iconLeft.style.transition = 'none'; iconLeft.style.opacity = ''; iconLeft.style.transform = ''; iconLeft.style.animation = ''; 
        }
        if(iconRight) {
            iconRight.style.transition = 'none'; iconRight.style.opacity = ''; iconRight.style.transform = ''; iconRight.style.animation = '';
        }

        const reel = document.getElementById('slot-reel');

        // === СЦЕНАРИЙ 1: ПЕРВЫЙ ЗАПУСК (СЛОТ-МАШИНА) ===
        if (isFirstGen) {
            // Генерируем фейковые имена для прокрутки
            // (Используем filterData или просто берем случайные из data, если filter пуст)
            let spinCandidates = filterData();
            if (spinCandidates.length === 0) spinCandidates = data; // Fallback

            const spinCount = 10;
            let html = '';
            
            for (let i = 0; i < spinCount - 1; i++) {
                const randomItem = spinCandidates[Math.floor(Math.random() * spinCandidates.length)];
                html += `<div class="slot-item">${getLocalizedName(randomItem)}</div>`;
            }
            
            const winnerName = getLocalizedName(finalItem);
            html += `<div class="slot-item" id="result-text">${winnerName}</div>`;
            
            reel.className = 'slot-reel spinning'; 
            reel.innerHTML = html;
            reel.querySelectorAll('.slot-item').forEach(el => el.classList.add('shrunk'));
            reel.style.transform = 'translateY(0)';
            
            // Влет обёртки
            if(wrapper) wrapper.classList.add('anim-fly-left'); 

            setTimeout(() => {
                isFirstGen = false;
                const isPC = window.innerWidth > 768;
                const itemHeight = isPC ? 450 : 300; // Примерная высота элемента
                const realHeight = reel.firstElementChild ? reel.firstElementChild.offsetHeight : itemHeight;
                const targetIndex = 9; 
                const targetY = -(targetIndex * realHeight);
                
                requestAnimationFrame(() => {
                    reel.style.transition = 'transform 1.2s cubic-bezier(0.25, 1, 0.5, 1)';
                    reel.style.transform = `translateY(${targetY}px)`;
                });
                
                setTimeout(() => { finishGeneration(finalItem, mode); }, 1200);
            }, 300);

        } 
        // === СЦЕНАРИЙ 2: ОБЫЧНАЯ ГЕНЕРАЦИЯ (СВАЙП) ===
        else {
            if(wrapper) wrapper.style.opacity = '0'; 
            
            finishGeneration(finalItem, mode);

            if(wrapper) {
                wrapper.style.transform = '';
                void wrapper.offsetWidth; 
                wrapper.style.opacity = '1';

                // Определение направления анимации
                let animClass = 'anim-fly-left'; 
                if (direction === 'entry-right') animClass = 'anim-fly-right';
                else if (direction === 'entry-left') animClass = 'anim-fly-left';
                else if (direction === 'like') animClass = 'anim-fly-left';
                else if (direction === 'dislike') animClass = 'anim-fly-right';

                wrapper.classList.add(animClass);

                setTimeout(() => {
                    wrapper.classList.remove('anim-fly-right', 'anim-fly-left');
                    wrapper.style.transform = '';
                }, 800);
            }
        }
    }

    function startNewSession(exitDirection = 'right', targetId = null) {
        if (!checkGenerationLimit(true)) return;
        
        const wrapper = document.getElementById('card-anim-wrapper');
        const startBtn = document.getElementById('start-btn-container');
        
        if(startBtn) {
            startBtn.classList.add('hidden-initial');
            startBtn.style.display = 'none';
        }

        if(wrapper) {
            const moveX = exitDirection === 'left' ? -150 : 150;
            const rotate = exitDirection === 'left' ? -15 : 15;

            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.opacity = '0';
            wrapper.style.transform = `translateX(${moveX}%) rotate(${rotate}deg)`; 
        }

        setTimeout(() => {
            sessionHistoryStack = []; 
            isFirstGen = false; 
            
            const entryAnimation = exitDirection === 'left' ? 'entry-right' : 'entry-left';
            
            // ПЕРЕДАЕМ targetId в startGeneration
            const mode = targetId ? 'specific' : 'random';
            
            startGeneration(mode, entryAnimation, targetId); 
        }, 350);
    }

    function updateCardStatusVisuals() {
        const card = document.getElementById('card-block');
        const notch = document.getElementById('card-notch');
        if (card) card.classList.remove('status-wl', 'status-fav', 'status-ban');
        if (notch) notch.classList.remove('visible');

        // В панике выходим сразу, не проверяя списки
        if (isPanicMode || !currentItem) return;

        const notchText = document.getElementById('card-notch-text');
        
        if (!card || !notch || !currentItem) return;

        // Сброс классов
        card.classList.remove('status-wl', 'status-fav', 'status-ban');
        notch.classList.remove('visible');

        const t = langData[currentLang];
        let activeStatus = null;

        // Проверяем статус (приоритет: Бан -> Лайк -> WL)
        // Но обычно WL и Лайк не пересекаются, так что порядок не критичен.
        
        if (blacklist.includes(currentItem.id)) {
            activeStatus = 'ban';
            notchText.innerText = t.status_ban;
        } 
        else if (favorites.includes(currentItem.id)) {
            activeStatus = 'fav';
            notchText.innerText = t.status_fav;
        }
        else if (watchLater.includes(currentItem.id)) {
            activeStatus = 'wl';
            notchText.innerText = t.status_wl;
        }

        // Применяем
        if (activeStatus) {
            card.classList.add('status-' + activeStatus);
            
            // Небольшая задержка для чёлки, чтобы она выезжала после появления карточки
            // Если это первый рендер
            setTimeout(() => {
                notch.classList.add('visible');
            }, 50);
        }
    }

    function renderResultUI(item, mode, customReason = null) {
        currentItem = item;
        lastGeneratedItem = item;
        
        // 1. Сброс анимаций элементов
        const elementsToReset = document.querySelectorAll('.stagger-item');
        elementsToReset.forEach(el => {
            el.style.animation = 'none';
            el.offsetHeight; /* trigger reflow */
            el.style.animation = ''; 
            // Убираем классы скрытия, чтобы элементы могли появиться
            el.classList.remove('hidden-initial', 'visually-hidden', 'fade-hidden');
        });

        let baseName = getLocalizedName(item);
        let finalHtml = baseName;

        // 2. Название (Слот)
        let displayName = getLocalizedName(item);
    
        // Формируем HTML с модификаторами
        let modifiersHtml = "";
        if (activeMods.size > 0) {
            const modNames = Array.from(activeMods).map(key => {
                const m = modifiersData.find(x => x.key === key);
                if (m) {
                    if (currentLang === 'ru') return m.ru;
                    if (currentLang === 'es') return m.es;
                    if (currentLang === 'de') return m.de;
                    return m.en;
                }
                return key;
            });
            
            // Добавляем красивый спан с плюсом
            if (modNames.length > 0) {
                modifiersHtml = ` <span style="color:var(--accent); font-weight:300; opacity:0.9;">+ ${modNames.join(" + ")}</span>`;
            }
        }

        const reel = document.getElementById('slot-reel');
        reel.removeAttribute('style');
        reel.className = 'slot-reel';
        
        // Используем innerHTML и вставляем переменную modifiersHtml
        reel.innerHTML = `<div class="slot-item final-result" id="result-text" style="color:var(--text-main); font-weight:900;">
            ${displayName}${modifiersHtml}
        </div>`;
        
        // 3. Описание
        const descEl = document.getElementById('result-desc');
        let desc = item.desc_en; 
        if (currentLang === 'ru' && item.desc_ru) desc = item.desc_ru;
        else if (currentLang === 'es' && item.desc_es) desc = item.desc_es;
        else if (currentLang === 'de' && item.desc_de) desc = item.desc_de;
        
        if(descEl) {
            descEl.innerText = desc || "";
            descEl.style.display = 'block'; 
        }

        // 4. Фраза сверху
        const statusEl = document.getElementById('status-text');
        if(statusEl) {
            statusEl.style.display = 'flex'; 
            statusEl.classList.remove('hidden-initial'); 
            
            if (customReason) {
                statusEl.innerHTML = customReason;
                statusEl.style.color = "var(--accent)";
            } 
            else {
                const explanation = getExplanationText(mode);
                
                if (explanation) {
                    statusEl.innerText = explanation;
                    
                    if (mode === 'panic') {
                        // В панике цвет нейтральный или зеленый
                        statusEl.style.color = "var(--text-main)"; 
                    } else {
                        // В обычном режиме - акцентный
                        statusEl.style.color = "var(--accent)";
                    }
                    
                } else {
                    const comments = resultComments[currentLang];
                    statusEl.innerText = comments[Math.floor(Math.random() * comments.length)];
                    statusEl.style.color = "var(--text-secondary)";
                }
            }
        }

        // 5. Карточка (Эффекты)
        const card = document.getElementById('card-block');
        if(card) {
            card.classList.remove('is-spinning');
            card.classList.add('has-results');
            
            // Вспышка
            card.classList.add('flash-active'); 
            setTimeout(() => card.classList.remove('flash-active'), 300);
            
            // Сброс позиций и цветов
            card.style.transform = 'translate(0, 0) rotate(0)';
            card.style.backgroundColor = '';
            card.style.borderColor = '';
            card.style.filter = '';
            card.style.transition = 'none';
        }

        // 6. ПЕРЕКЛЮЧЕНИЕ КНОПОК
        
        // А. Скрываем кнопку "Поехали"
        const startBtnContainer = document.getElementById('start-btn-container');
        if (startBtnContainer) {
            startBtnContainer.classList.add('hidden-initial'); // Добавляем класс
            startBtnContainer.style.display = 'none'; // Дублируем инлайном для надежности
        }

        // Б. Показываем игровые кнопки, моды и "Похожее"
        const idsToShow = ['tinder-controls', 'mods-block', 'related-block'];
        idsToShow.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('hidden-initial', 'visually-hidden');
                el.style.display = 'flex'; // Принудительно ставим flex
                
                // Перезапуск анимации появления
                el.style.animation = 'none';
                el.offsetHeight;
                el.style.animation = '';
            }
        });

        // 7. Кнопка Undo
        const btnUndo = document.getElementById('btn-t-undo');
        if (btnUndo) {
            if (sessionHistoryStack && sessionHistoryStack.length > 0) {
                btnUndo.disabled = false;
                btnUndo.style.opacity = "1";
            } else {
                btnUndo.disabled = true;
                btnUndo.style.opacity = "0.3";
            }
        }

        updateLink();
        renderBadges();
        renderRelatedItems();
        updateActionButtons();
        updateCardStatusVisuals();
        randomizeDecorations(item);
    }

    function updateActionButtons() {
        if(!currentItem) return;
        
        const btnPass = document.getElementById('btn-t-pass'); // Крестик
        const btnLike = document.getElementById('btn-t-like'); // Сердце
        const btnWL = document.getElementById('btn-t-wl');     // Звезда

        // Сброс стилей (убираем inline стили фона/бордера, оставляем классы)
        if (btnPass) btnPass.style.background = "";
        if (btnLike) btnLike.style.background = "";
        if (btnWL) btnWL.classList.remove('active');

        // Ставим стили для активных
        if (blacklist.includes(currentItem.id)) {
            if (btnPass) btnPass.style.background = "#e74c3c"; // Красный фон
            if (btnPass) btnPass.style.color = "#fff";
        } 
        if (favorites.includes(currentItem.id)) {
            if (btnLike) btnLike.style.background = "#2ecc71"; // Зеленый фон
            if (btnLike) btnLike.style.color = "#fff";
        }
        if (watchLater.includes(currentItem.id)) {
            if (btnWL) btnWL.classList.add('active'); // Добавляет синий
        } else {
            if (btnWL) btnWL.classList.remove('active'); // Убирает синий (становится серым)
        }
    }

    function updateItemScore(id, delta) {
        // Если записи нет, создаем (0)
        if (!itemScores[id]) itemScores[id] = 0;

        // Изменяем счет
        itemScores[id] += delta;

        // Логика распределения по спискам
        if (itemScores[id] > 0) {
            // Баланс положительный -> В Избранное
            if (!favorites.includes(id)) favorites.push(id);
            // Убираем из ЧС, если было
            blacklist = blacklist.filter(x => x !== id);
        } 
        else if (itemScores[id] < 0) {
            // Баланс отрицательный -> В ЧС
            if (!blacklist.includes(id)) blacklist.push(id);
            // Убираем из Избранного, если было
            favorites = favorites.filter(x => x !== id);
        } 
        else {
            // Баланс НОЛЬ -> Нейтрально (убираем отовсюду)
            favorites = favorites.filter(x => x !== id);
            blacklist = blacklist.filter(x => x !== id);
            // Удаляем ключ, чтобы не засорять память
            delete itemScores[id];
        }

        // Сохраняем всё
        saveLists();
        localStorage.setItem('xch_item_scores', JSON.stringify(itemScores));
        
        // Обновляем UI
        updateActionButtons(); 
        updateCounts();
        updateCardStatusVisuals();
        if (window.markDirty) window.markDirty();
    }

    function syncScoresFromLists() {
        let changed = false;
        // Если есть в Избранном, но нет счета — ставим +1
        favorites.forEach(id => {
            if (!itemScores[id] || itemScores[id] <= 0) {
                itemScores[id] = 1;
                changed = true;
            }
        });
        // Если есть в ЧС, но нет счета — ставим -1
        blacklist.forEach(id => {
            if (!itemScores[id] || itemScores[id] >= 0) {
                itemScores[id] = -1;
                changed = true;
            }
        });
        if (changed) {
            localStorage.setItem('xch_item_scores', JSON.stringify(itemScores));
        }
    }

    function toggleFavorite(silent = false) {
        if (isPanicMode) return;
        if (!currentItem) return;
        const id = currentItem.id;
        
        // Добавляем +1 к карме видео
        updateItemScore(id, 1);

        if (!silent) {
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, 5); // Бустим теги
            hasInteractedWithCurrent = true;
            logActivity('like', id, fullTags);
        }
    }

    function toggleBlacklist(silent = false) {
        if (isPanicMode) return;
        if (!currentItem) return;
        const id = currentItem.id;

        if (watchLater.includes(id)) return;

        // Отнимаем -1 от кармы видео
        updateItemScore(id, -1);

        if (!silent) {
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, -5); // Понижаем теги
            logActivity('dislike', id, fullTags);
        }
    }

    function toggleWatchLater() {
        if (isPanicMode) return;
        if(!currentItem) return;
        const id = currentItem.id;
        const btn = document.getElementById('btn-t-wl');

        if (watchLater.includes(id)) {
            watchLater = watchLater.filter(x => x !== id);
            if(btn) btn.classList.remove('active');
        } else {
            watchLater.push(id);
            if(btn) btn.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(50);
        }
        
        localStorage.setItem(STORAGE.WATCH_LATER, JSON.stringify(watchLater));
        updateCounts(); 
        if (window.markDirty) window.markDirty();
    }

    function openWatchLaterCatalog() {
        renderListModal('wl');
    }

    function openWrapped() {
        triggerWrappedBtn();
    }

    function startSlideTimer(total, duration = 9000) {
        clearInterval(slideInterval);
        
        const show = (idx) => {
            document.querySelectorAll('.wrapped-slide').forEach(el => el.classList.remove('active-slide'));
            document.querySelectorAll('.wrapped-slide')[idx].classList.add('active-slide');
            
            for(let i=0; i<total; i++) {
                const bar = document.getElementById('bar-'+i);
                if(i < idx) { 
                    bar.style.width = '100%'; 
                    bar.style.transition = 'none'; 
                }
                else if(i > idx) { 
                    bar.style.width = '0%'; 
                    bar.style.transition = 'none'; 
                }
                else {
                    bar.style.width = '0%';
                    bar.style.transition = 'none';
                    setTimeout(() => {
                        // Используем linear для плавного заполнения
                        bar.style.transition = `width ${duration}ms linear`;
                        bar.style.width = '100%';
                    }, 50);
                }
            }
        };

        show(currentSlideIndex);

        slideInterval = setInterval(() => {
            if (currentSlideIndex < total - 1) {
                currentSlideIndex++;
                show(currentSlideIndex);
            } else {
                clearInterval(slideInterval); 
            }
        }, duration);
    }

    function nextSlide() {
        const total = document.querySelectorAll('.wrapped-slide').length;
        if (currentSlideIndex < total - 1) {
            currentSlideIndex++;
            startSlideTimer(total);
        } else {
            closeWrapped();
        }
    }

    function prevSlide() {
        const total = document.querySelectorAll('.wrapped-slide').length;
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            startSlideTimer(total);
        }
    }

    function closeWrapped() {
        clearInterval(slideInterval);
        document.getElementById('wrapped-mount').classList.remove('active');
    }

    function toggleInstallInstruct(platform) {
        const el = document.getElementById('instruct-' + platform);
        const isVisible = el.style.display === 'block';
        
        // Скрываем все
        document.getElementById('instruct-ios').style.display = 'none';
        document.getElementById('instruct-android').style.display = 'none';
        
        // Показываем нужный, если он был скрыт
        if (!isVisible) {
            el.style.display = 'block';
        }
    }

    function isAppInstalled() {
        // iOS Standalone или стандартный display-mode
        return (window.navigator.standalone === true) || (window.matchMedia('(display-mode: standalone)').matches);
    }

    function skipInstall() {
        document.getElementById('modal-install-overlay').classList.remove('open');
        // Помечаем, что видели (на эту сессию или навсегда - решать вам)
        sessionStorage.setItem('xch_install_skipped', 'true'); 
        
        // Переходим к следующему шагу (Онбординг предпочтений)
        checkOnboarding(); 
    }

    function checkOnboarding() {
        const isOnboarded = localStorage.getItem('xch_onboarding_done');
        if (!isOnboarded) {
            document.getElementById('onboarding-overlay').classList.add('open');
        }
    }

    function openLoginModal() {
        document.getElementById('modal-login-overlay').classList.add('open');
    }

    function closeLoginModal(e, force) {
        if (force || e.target.id === 'modal-login-overlay') {
            document.getElementById('modal-login-overlay').classList.remove('open');
        }
    }

    function performGoogleLogin() {
        // Закрываем модалку
        document.getElementById('modal-login-overlay').classList.remove('open');
        // Вызываем оригинальную функцию из модуля Firebase
        window.loginWithGoogle();
    }

    function changeOrientation(val) {
        currentOrientation = val;
        localStorage.setItem('xch_orientation', val);
    }

    function openRoadmap() {
        document.getElementById('modal-roadmap-overlay').classList.add('open');
    }

    function closeRoadmap(e, force) {
        if (force || e.target.id === 'modal-roadmap-overlay') {
            document.getElementById('modal-roadmap-overlay').classList.remove('open');
        }
    }

    function openQRModal() {
        // Генерируем ссылку на текущий URL
        const currentUrl = window.location.href;
        // Используем API для генерации QR
        const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=10&data=${encodeURIComponent(currentUrl)}`;
        
        document.getElementById('qr-code-img').src = qrApi;
        document.getElementById('modal-qr-overlay').classList.add('open');
    }

    function closeQRModal(e, force) {
        if (force || e.target.id === 'modal-qr-overlay') {
            document.getElementById('modal-qr-overlay').classList.remove('open');
        }
    }

    function initDecoSettings() {
        // По умолчанию true (показывать), если в памяти нет записи
        const saved = localStorage.getItem('xch_show_deco');
        const isEnabled = saved !== 'false'; // Если null или 'true', то true

        // Обновляем состояние чекбокса
        const toggle = document.getElementById('deco-toggle');
        if (toggle) toggle.checked = isEnabled;

        // Применяем класс
        applyDecoState(isEnabled);
    }

    function toggleDecoIcons(isChecked) {
        localStorage.setItem('xch_show_deco', isChecked);
        applyDecoState(isChecked);
    }

    function applyDecoState(isEnabled) {
        if (isEnabled) {
            document.body.classList.remove('no-deco');
        } else {
            document.body.classList.add('no-deco');
        }
    }

    function randomizeDecorations(item = null) {
        const leftImg = document.getElementById('deco-left');
        const rightImg = document.getElementById('deco-right');
        
        if (!leftImg || !rightImg) return;

        let selectedIcons = [];

        // ШАГ 1: Пытаемся найти специфичные иконки, если передан предмет
        if (item && item.tags) {
            // Проходим по всем тегам предмета
            item.tags.forEach(tag => {
                if (TAG_ICONS[tag]) {
                    // Добавляем все иконки, связанные с этим тегом
                    selectedIcons.push(...TAG_ICONS[tag]);
                }
            });
        }

        // Убираем дубликаты (если один файл прописан в разных тегах)
        selectedIcons = [...new Set(selectedIcons)];
        
        // Перемешиваем найденные специфичные иконки
        selectedIcons.sort(() => 0.5 - Math.random());

        // ШАГ 2: Заполняем пропуски нейтральными
        // Нам нужно ровно 2 иконки (левая и правая)
        
        // Если специфичных нет вообще -> берем две нейтральные
        if (selectedIcons.length === 0) {
            selectedIcons.push(getRandomNeutral());
            selectedIcons.push(getRandomNeutral(selectedIcons[0])); // Передаем первую, чтобы вторая не совпала
        } 
        // Если есть только одна специфичная -> добавляем к ней одну нейтральную
        else if (selectedIcons.length === 1) {
            selectedIcons.push(getRandomNeutral());
        }
        // Если специфичных 2 или больше -> массив уже заполнен (лишние обрежутся ниже)

        // ШАГ 3: Применяем
        leftImg.src = selectedIcons[0];
        rightImg.src = selectedIcons[1];
    }

    function getRandomNeutral(excludeSrc = null) {
        let pool = NEUTRAL_DECOS;
        if (excludeSrc) {
            pool = pool.filter(src => src !== excludeSrc);
        }
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function calculateWatchTime() {
        // Проверка: было ли начало просмотра и есть ли сохраненный предмет
        if (watchStartTime === 0 || !itemBeingWatched) return;

        const now = Date.now();
        const diffInSeconds = Math.floor((now - watchStartTime) / 1000);
        
        watchStartTime = 0; 

        // Игнорируем меньше 5 сек
        if (diffInSeconds < 5) return;

        // Если больше 30 минут (1800 сек), ставим заглушку
        let timeString = "";
        const minLabel = currentLang === 'ru' ? 'мин' : 'min';
        const secLabel = currentLang === 'ru' ? 'сек' : 'sec';

        if (diffInSeconds > 1800) {
            timeString = `30+ ${minLabel}`;
        } else {
            const minutes = Math.floor(diffInSeconds / 60);
            const seconds = diffInSeconds % 60;
            
            if (minutes > 0) {
                timeString = `${minutes} ${minLabel} ${seconds} ${secLabel}`;
            } else {
                timeString = `${seconds} ${secLabel}`;
            }
        }

        // === СОХРАНЕНИЕ В ИСТОРИЮ ===
        const historyEntry = {
            id: itemBeingWatched.id,
            timestamp: Date.now(),
            durationStr: timeString,
            seconds: diffInSeconds
        };
        
        // Добавляем в начало
        watchHistory.unshift(historyEntry);
        // Храним последние 100 записей
        if (watchHistory.length > 100) watchHistory.pop();
        
        localStorage.setItem(STORAGE.WATCH_HISTORY, JSON.stringify(watchHistory));
        
        // Обновляем облако
        if (window.markDirty) window.markDirty();
        // ======================================

        // Показ сообщения
        const t = langData[currentLang] || langData['en'];
        let phraseTemplate = "";
        
        // Если смотрел долго (или сработала заглушка 30+)
        if (diffInSeconds > 1800) {
             phraseTemplate = (currentLang === 'ru') ? "Долгое погружение... 🌊" : "Deep dive... 🌊";
             // Перезаписываем timeString в шаблоне, если нужно, или просто выводим фразу
        } else if (diffInSeconds < 40) {
            phraseTemplate = t.return_phrase_short || "Only {t}...";
        } else {
            const phrases = t.return_phrases || ["{t} passed."];
            phraseTemplate = phrases[Math.floor(Math.random() * phrases.length)];
        }
        
        // Если phraseTemplate не содержит {t}, просто выводим её
        const finalPhrase = phraseTemplate.includes("{t}") ? phraseTemplate.replace("{t}", timeString) : phraseTemplate;

        const statusEl = document.getElementById('status-text');
        if (statusEl) {
            statusEl.style.opacity = '0';
            setTimeout(() => {
                statusEl.innerText = finalPhrase;
                statusEl.style.color = "var(--text-main)";
                statusEl.style.opacity = '1';
            }, 200);
        }
    }

    function resetToHome() {

        const homeTab = document.getElementById('tab-home');
        if (!homeTab || !homeTab.classList.contains('active')) {
            return; 
        }

        // Если идет генерация — не прерываем
        if (isGenerating) return;

        const wrapper = document.getElementById('card-anim-wrapper');
        const card = document.getElementById('card-block');
        
        // 1. АНИМАЦИЯ УХОДА ТЕКУЩЕЙ КАРТОЧКИ
        if (wrapper) {
            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.transform = 'translateX(-150%) rotate(-10deg)';
            wrapper.style.opacity = '0';
        }

        // Ждем окончания анимации (350мс)
        setTimeout(() => {
            // 2. СБРОС ДАННЫХ
            currentItem = null;
            lastGeneratedItem = null;
            isFirstGen = true; 
            sessionHistoryStack = []; 

            // 3. СБРОС ИНТЕРФЕЙСА РЕЗУЛЬТАТОВ
            const uiToHide = ['result-desc', 'tinder-controls', 'mods-block', 'related-block'];
            uiToHide.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.add('hidden-initial'); 
                    el.style.display = 'none'; 
                }
            });

            // Очищаем бейджи и статус
            document.getElementById('badge-wrapper').innerHTML = '';
            const statusEl = document.getElementById('status-text');
            if(statusEl) statusEl.innerText = ''; 

            // Сброс классов карточки
            if(card) {
                card.classList.remove('has-results', 'flash-active', 'status-wl', 'status-fav', 'status-ban');
                card.style.transform = ''; 
                card.style.filter = 'none';
                
                const notch = document.getElementById('card-notch');
                if(notch) notch.classList.remove('visible');
            }

            initIdleSlot();
            randomizeDecorations();

            // Сброс декоративных иконок
            const iconLeft = document.querySelector('.icon-left');
            const iconRight = document.querySelector('.icon-right');
            [iconLeft, iconRight].forEach(icon => {
                if(icon) {
                    icon.style.transition = 'none';
                    icon.style.opacity = '';
                    icon.style.transform = '';
                    icon.style.animation = ''; 
                }
            });

            // === 4. ВОССТАНОВЛЕНИЕ НАЧАЛЬНОГО ЭКРАНА (FIXED) ===
            const totalInteractions = favorites.length + blacklist.length;
            const startBtn = document.getElementById('start-btn-container');
            const overlay = document.getElementById('mode-start-overlay');
            
            // Сброс UI ассистента
            document.getElementById('assistant-ui').classList.remove('visible');
            document.getElementById('thinking-ui').style.display = 'none';
            document.getElementById('ai-input').value = '';

            // Элементы внутри оверлея
            const startText = document.getElementById('mode-start-text');
            const modeBtns = document.getElementById('mode-buttons-container');

            // ПРИНУДИТЕЛЬНЫЙ СБРОС СТИЛЕЙ (Убираем последствия анимаций)
            if(startText) {
                startText.classList.remove('fade-out-up');
                startText.style.opacity = '1';
                startText.style.display = 'block';
                startText.style.transform = 'translate(0,0)';
            }
            if(modeBtns) {
                modeBtns.classList.remove('fade-out-up');
                modeBtns.style.opacity = '1';
                modeBtns.style.pointerEvents = 'auto';
                modeBtns.style.display = 'flex';
                modeBtns.style.transform = 'translate(0,0)';
            }

            if (totalInteractions >= 10) {
                // Опытный: Показываем оверлей режимов
                randomizeModeGreeting(); 

                if(overlay) {
                    overlay.classList.remove('hidden');
                    overlay.style.display = 'flex'; 
                    overlay.style.opacity = '1';
                    overlay.style.pointerEvents = 'auto';
                    overlay.style.transform = 'scale(1)';
                }
                
                isModeSelectionActive = true; 
                
                if(startBtn) {
                    startBtn.classList.add('hidden-initial');
                    startBtn.style.display = 'none';
                }

            } else {
                // Новичок: Показываем кнопку "Let's Go"
                if(overlay) {
                    overlay.classList.add('hidden');
                    overlay.style.display = 'none';
                }
                isModeSelectionActive = false;

                if(startBtn) {
                    startBtn.classList.remove('hidden-initial');
                    startBtn.style.display = 'flex';
                    startBtn.style.opacity = '1';
                }
            }

            // 5. ВОЗВРАЩЕНИЕ КАРТОЧКИ
            if (wrapper) {
                wrapper.style.transition = 'none';
                wrapper.style.transform = 'scale(0.95)'; 
                void wrapper.offsetWidth; 
                wrapper.style.transition = 'opacity 0.5s ease, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                wrapper.style.opacity = '1';
                wrapper.style.transform = 'scale(1)';
            }

        }, 350);
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') {
            // Если пользователь залогинен, форсируем сохранение (immediate = true)
            if (window.isUserLoggedIn) {
                console.log("App hidden, forcing save...");
                window.syncToCloud(true);
            }
        }
    });

    function openSponsorsModal() {
        const list = document.getElementById('sponsors-list');
        list.innerHTML = '';

        earlySponsors.forEach(person => {
            const row = document.createElement('div');
            row.className = 'ios-row';
            row.style.cursor = 'default'; // Не кликабельно
            row.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:18px;">💎</span>
                    <span style="font-weight:600; color:var(--text-main);">${person.name}</span>
                </div>
                <span style="font-size:12px; color:var(--text-secondary);">${person.date}</span>
            `;
            list.appendChild(row);
        });

        document.getElementById('modal-sponsors-overlay').classList.add('open');
    }

    function closeSponsorsModal(e, force) {
        if (force || e.target.id === 'modal-sponsors-overlay') {
            document.getElementById('modal-sponsors-overlay').classList.remove('open');
        }
    }

    function openHistoryModal() {
        document.getElementById('modal-history-overlay').classList.add('open');
        // Рендерим текущую вкладку
        switchHistoryTab(currentHistoryTab);
    }

    function closeHistoryModal(e, force) {
        if (force || e.target.id === 'modal-history-overlay') {
            const modal = document.getElementById('modal-history-overlay');
            modal.classList.remove('open');
        }
    }

    function switchHistoryTab(tab) {
        currentHistoryTab = tab;

        // 1. Получаем ссылки на кнопки
        const navs = {
            swipes: document.getElementById('hist-nav-swipes'),
            watch: document.getElementById('hist-nav-watch'),
            wrapped: document.getElementById('hist-nav-wrapped')
        };

        // 2. Получаем ссылки на списки
        const lists = {
            swipes: document.getElementById('hist-list-swipes'),
            watch: document.getElementById('hist-list-watch'),
            wrapped: document.getElementById('hist-list-wrapped')
        };

        // 3. Сбрасываем активные классы и скрываем списки
        Object.values(navs).forEach(el => { if(el) el.classList.remove('active'); });
        Object.values(lists).forEach(el => { if(el) el.style.display = 'none'; });

        // 4. Активируем нужную вкладку
        if (navs[tab]) navs[tab].classList.add('active');
        if (lists[tab]) lists[tab].style.display = 'block';

        // 5. Рендерим содержимое
        if (tab === 'wrapped') {
            if(typeof renderWrappedArchive === 'function') renderWrappedArchive();
        } else if (tab === 'swipes') {
            if(typeof renderSwipesHistoryList === 'function') renderSwipesHistoryList();
        } else if (tab === 'watch') {
            if(typeof renderWatchHistoryList === 'function') renderWatchHistoryList();
        }
    }

    function renderSwipesHistoryList() {
        const list = document.getElementById('hist-list-swipes');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (historyData.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">${t.hist_empty}</div>`;
            return;
        }

        historyData.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;
            
            // 1. Форматирование даты и времени
            const dateObj = new Date(entry.timestamp);
            const now = new Date();
            const isToday = dateObj.toDateString() === now.toDateString();
            
            // Время (ЧЧ:ММ)
            const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Дата (ДД.ММ), если не сегодня
            let dateDisplay = "";
            if (!isToday) {
                const day = dateObj.getDate().toString().padStart(2, '0');
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                dateDisplay = `${day}.${month}`;
            } else {
                dateDisplay = currentLang === 'ru' ? "Сегодня" : "Today";
            }

            // 2. Определение статуса (Иконка)
            let statusIcon = '⚪'; // По умолчанию (пропуск)
            let statusOpacity = '0.3'; // Для нейтрального статуса
            let statusColor = 'var(--text-secondary)';

            // Проверяем текущее состояние (Live status)
            if (blacklist.includes(item.id)) {
                statusIcon = '⛔'; // Дизлайк
                statusOpacity = '1';
                statusColor = 'var(--highlight-red)';
            } 
            else if (favorites.includes(item.id)) {
                statusIcon = '💚'; // Лайк
                statusOpacity = '1';
                statusColor = 'var(--accent)';
            } 
            else if (watchLater.includes(item.id)) {
                statusIcon = '⏰'; // WL
                statusOpacity = '1';
                statusColor = '#3498db';
            } 
            else {
                // Проверка на просмотр (если нет в списках, но смотрел)
                const isWatched = watchHistory.some(w => w.id === item.id);
                if (isWatched) {
                    statusIcon = '👁️';
                    statusOpacity = '0.8';
                    statusColor = 'var(--text-main)';
                }
            }

            const div = document.createElement('div');
            div.className = 'ios-row clickable';
            div.style.padding = '10px 20px'; 
            
            const name = getLocalizedName(item);

            div.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <div style="font-weight:600; font-size:15px; color:var(--text-main);">${name}</div>
                    <div style="font-size:11px; color:var(--text-secondary);">
                        ${dateDisplay}, ${timeStr}
                    </div>
                </div>
                
                <div style="display:flex; align-items:center; gap:15px;">
                    <!-- Иконка статуса -->
                    <div style="font-size:16px; opacity:${statusOpacity}; color:${statusColor};" title="Status">
                        ${statusIcon}
                    </div>
                    
                    <!-- Кнопка повтора -->
                    <div style="color:var(--accent); font-size:20px; opacity:0.8;">↺</div>
                </div>
            `;
            
            div.onclick = () => { 
                closeHistoryModal(null, true);
                switchTab('home'); 
                forceShowResult(item, 'history'); 
            };
            list.appendChild(div);
        });
    }

    function renderWatchHistoryList() {
        const list = document.getElementById('hist-list-watch');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (watchHistory.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">${t.hist_empty_watch}</div>`;
            return;
        }

        watchHistory.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;

            const div = document.createElement('div');
            div.className = 'ios-row clickable';
            div.style.padding = '12px 20px';

            const name = getLocalizedName(item);
            const d = new Date(entry.timestamp);
            const dateStr = d.toLocaleDateString() === new Date().toLocaleDateString() 
                ? d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                : d.toLocaleDateString([], {day:'numeric', month:'numeric'}) + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            div.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div style="font-weight:600;">${name}</div>
                    <div style="font-size:11px; color:var(--text-secondary);">${dateStr}</div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
                    <span style="font-weight:700; color:var(--text-main); font-size:15px;">${entry.durationStr}</span>
                    <span style="font-size:10px; color:var(--accent);">${t.hist_watched}</span>
                </div>
            `;
            
            div.onclick = () => {
                closeHistoryModal(null, true);
                switchTab('home');
                forceShowResult(item, 'history');
            };
            
            list.appendChild(div);
        });
    }

    window.openAdminModal = function() {
        document.getElementById('modal-admin-overlay').classList.add('open');
    };

    window.closeAdminModal = function(e, force) {
        if (force || e.target.id === 'modal-admin-overlay') {
            document.getElementById('modal-admin-overlay').classList.remove('open');
        }
    };

    function initModes() {
        const totalInteractions = favorites.length + blacklist.length;
        const hasEnoughData = totalInteractions >= 10;

        const capsules = document.querySelectorAll('.mode-capsule-wrapper');
        const startOverlay = document.getElementById('mode-start-overlay');
        const startBtn = document.getElementById('start-btn-container');

        if (hasEnoughData) {
            randomizeModeGreeting();
            // 1. Показываем капсулы (CSS media query решит, какую именно)
            capsules.forEach(el => el.style.display = 'block');
            
            // 2. Показываем Оверлей выбора в карточке
            if(startOverlay) {
                startOverlay.classList.remove('hidden');
                isModeSelectionActive = true;
            }

            // 3. Скрываем старую кнопку "Поехали" (она нам не нужна)
            if(startBtn) {
                startBtn.classList.add('hidden-initial'); // Скрываем через класс
                startBtn.style.display = 'none'; // И на всякий случай инлайном
            }
            
            // Обновляем текст в капсулах
            updateCapsuleUI();

        } else {
            // Если мало действий — скрываем всё новое, работаем как раньше
            capsules.forEach(el => el.style.display = 'none');
            if(startOverlay) startOverlay.classList.add('hidden');
            isModeSelectionActive = false;
            
            // Убеждаемся, что кнопка старта видна
            if(startBtn) {
                startBtn.classList.remove('hidden-initial');
                startBtn.style.display = 'flex';
            }
        }
    }

    function randomizeModeGreeting() {
        const el = document.getElementById('mode-start-text');
        if (!el) return;
        
        suggestedFavId = null;
        suggestedNewId = null;
        
        const t = langData[currentLang] || langData['en'];
        let finalPhrase = "";
        let favName = null;
        let newName = null;

        // --- 1. ИЩЕМ ЛЮБИМОЕ (Для режима Pleasure) ---
        const ignoreTags = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd', 'kinky', 'fetish', 'fantasy', 'action', 'body-part'];
        
        const topTags = Object.entries(tagScores)
            .filter(([tag, score]) => score > 10 && !ignoreTags.includes(tag))
            .sort((a, b) => b[1] - a[1]) 
            .slice(0, 5) 
            .map(x => x[0]);

        if (typeof data !== 'undefined' && topTags.length > 0) {
            const randomTag = topTags[Math.floor(Math.random() * topTags.length)];
            const candidates = data.filter(item => item.tags.includes(randomTag) && !blacklist.includes(item.id));

            if (candidates.length > 0) {
                const winnerItem = candidates[Math.floor(Math.random() * candidates.length)];
                favName = getLocalizedName(winnerItem);
                suggestedFavId = winnerItem.id; // СОХРАНЯЕМ ID
            }
        }

        // --- 2. ИЩЕМ НОВОЕ (Для режима Explore) ---
        if (typeof data !== 'undefined' && data.length > 0) {
            const randomPool = data
                .sort(() => 0.5 - Math.random())
                .slice(0, 50)
                .filter(item => 
                    !blacklist.includes(item.id) && 
                    !favorites.includes(item.id) && 
                    item.name !== favName
                );
            
            if (randomPool.length > 0) {
                const randomNewItem = randomPool[0];
                newName = getLocalizedName(randomNewItem);
                suggestedNewId = randomNewItem.id; // СОХРАНЯЕМ ID
            }
        }

        // --- 3. ФОРМИРУЕМ ФРАЗУ ---
        if (favName && newName && t.mode_greeting_dynamic && t.mode_greeting_dynamic.length > 0) {
            const templates = t.mode_greeting_dynamic;
            const template = templates[Math.floor(Math.random() * templates.length)];
            
            finalPhrase = template
                .replace('{fav}', `<span style="color:var(--accent);">${favName}</span>`)
                .replace('{new}', `<span style="color:#00d2ff;">${newName}</span>`);
        } 
        else {
            const phrases = Array.isArray(t.mode_greeting_hint) 
                ? t.mode_greeting_hint 
                : [t.mode_greeting_hint];
            finalPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            
        }
            
        el.innerHTML = finalPhrase;
    }

    function toggleModeDropdown(type) {
        const id = type === 'pc' ? 'mode-capsule-pc' : 'mode-capsule-mobile';
        const wrapper = document.getElementById(id);
        
        // Закрываем другую, если открыта (опционально)
        document.querySelectorAll('.mode-capsule-wrapper').forEach(el => {
            if(el.id !== id) el.classList.remove('open');
        });

        wrapper.classList.toggle('open');
    }

    function setAppMode(mode) {
        currentAppMode = mode;
        updateCapsuleUI();
        
        const startOverlay = document.getElementById('mode-start-overlay');
        if (startOverlay && !startOverlay.classList.contains('hidden')) {
        }

        console.log("Mode set to:", mode);
    }

    function setAppModeAndStart(mode) {
        setAppMode(mode);
        
        const overlay = document.getElementById('mode-start-overlay');
        if(overlay) {
            overlay.style.transition = 'opacity 0.3s, transform 0.3s';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
        
        isModeSelectionActive = false;
        
        const direction = (mode === 'explore') ? 'left' : 'right';
        
        // ОПРЕДЕЛЯЕМ ЦЕЛЕВОЙ ID
        let specificId = null;
        if (mode === 'pleasure' && suggestedFavId) {
            specificId = suggestedFavId;
        } else if (mode === 'explore' && suggestedNewId) {
            specificId = suggestedNewId;
        }
        
        // Передаем ID дальше
        startNewSession(direction, specificId);
    }

    function updateCapsuleUI() {
        const select = document.getElementById('app-mode-select');
        if (!select) return;

        const t = langData[currentLang] || langData['en'];
        
        // Проверяем, есть ли уже опция AI
        let aiOption = select.querySelector('option[value="ai"]');

        if (currentAppMode === 'ai') {
            // Если режим AI активен, но опции нет -> добавляем
            if (!aiOption) {
                aiOption = document.createElement('option');
                aiOption.value = 'ai';
                aiOption.innerText = "🤖 " + (t.mode_ai || "AI Agent");
                select.appendChild(aiOption);
            }
            // Выбираем её
            select.value = 'ai';
        } else {
            if (aiOption) {
                aiOption.remove();
            }
            select.value = currentAppMode;
        }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.mode-capsule-wrapper')) {
            document.querySelectorAll('.mode-capsule-wrapper').forEach(el => el.classList.remove('open'));
        }
    });

    function getEditDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;

        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1, // замена
                        Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1) // вставка/удаление
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    function isFuzzyMatch(token, targetWord) {
        token = token.toLowerCase();
        targetWord = targetWord.toLowerCase();

        // А. Если одно содержится в другом (стандартный поиск)
        if (targetWord.includes(token)) return true;

        // Б. Проверка корня (для русского языка очень полезно)
        // Если слова длиннее 4 букв и первые 4 буквы совпадают (рыжими - рыжие)
        if (token.length >= 4 && targetWord.length >= 4) {
            if (token.substring(0, 4) === targetWord.substring(0, 4)) return true;
        }

        // В. Расстояние Левенштейна (для опечаток и коротких слов)
        // Считаем % сходства
        const len = Math.max(token.length, targetWord.length);
        if (len === 0) return false;
        
        const dist = getEditDistance(token, targetWord);
        const similarity = 1 - (dist / len);

        // Если совпадение больше 70% (0.7)
        return similarity >= 0.7; 
    }

    function analyzeUserRequest(text) {
    const rawText = text.toLowerCase();
    
    // --- 0. ПРЕДВАРИТЕЛЬНАЯ ОЧИСТКА ---
    // Убираем "связанное с", "хочу" и т.д.
    let cleanText = rawText;
    CLEAN_PHRASES.forEach(phrase => cleanText = cleanText.split(phrase).join(" "));
    STOP_WORDS.forEach(word => cleanText = cleanText.replace(new RegExp(`\\b${word}\\b`, 'g'), " "));
    
    // Сжимаем пробелы
    cleanText = cleanText.replace(/\s+/g, " ").trim();

    // === 1. ПРОВЕРКА СПЕЦИАЛЬНЫХ КОМАНД ===
    
    // А. "УДИВИ МЕНЯ" (Surprise)
    const surpriseKw = SPECIAL_COMMANDS.surprise[currentLang] || SPECIAL_COMMANDS.surprise.en;
    if (surpriseKw.some(kw => rawText.includes(kw))) {
        // Берем случайное из базы (но не из ЧС)
        const randomPool = data.filter(x => !blacklist.includes(x.id));
        const item = randomPool[Math.floor(Math.random() * randomPool.length)];
        
        const reasons = {
            en: "Fate decided! 🎲",
            ru: "Судьба решила! 🎲",
            es: "¡El destino decidió! 🎲",
            de: "Das Schicksal hat entschieden! 🎲"
        };
        return { item: item, reason: reasons[currentLang] || reasons.en, detectedMods: [] };
    }

    // Б. "КАК ВЧЕРА" (Yesterday)
    const yesterKw = SPECIAL_COMMANDS.yesterday[currentLang] || SPECIAL_COMMANDS.yesterday.en;
    if (yesterKw.some(kw => rawText.includes(kw))) {
        if (watchHistory.length > 0) {
            // Берем последний просмотренный
            const lastId = watchHistory[0].id;
            const item = data.find(x => x.id === lastId);
            if (item) {
                const reasons = {
                    en: "As you requested: Like last time ↺",
                    ru: "Как ты и просил: Повтор прошлого ↺",
                    es: "Como pediste: Como la última vez ↺",
                    de: "Wie gewünscht: Wie beim letzten Mal ↺"
                };
                return { item: item, reason: reasons[currentLang] || reasons.en, detectedMods: [] };
            }
        }
    }

    // === 2. ПОИСК МОДИФИКАТОРОВ ===
    let detectedMods = [];
    modifiersData.forEach(mod => {
        const keywords = [mod.key, mod.en, mod.ru, mod.es, mod.de].filter(k => k).map(k => k.toLowerCase());
        // Ищем целые слова или части слов (fuzzy)
        const found = cleanText.split(" ").some(userWord => {
            return userWord.length > 2 && keywords.some(keyword => isFuzzyMatch(userWord, keyword));
        });
        if (found) detectedMods.push(mod.key);
    });

    // === 3. ОБРАБОТКА "СМЕСЬ X И Y" (Mix) ===
    const foundCategories = [];
    
    // Хелпер для поиска категории в тексте
    const findCatInText = (textSource) => {
        const results = [];
        // Проверяем каждое слово юзера на совпадение с именем категории
        const userWords = textSource.split(" ").filter(w => w.length > 3);
        
        // Оптимизация: Сначала проверяем избранное
        favorites.forEach(id => {
            const item = data.find(x => x.id === id);
            if (item) checkItemMatch(item, userWords, results);
        });
        
        // Если мало нашли, ищем по всей базе (лимит 500 популярных, чтобы не висло)
        if (results.length < 2) {
            data.slice(0, 500).forEach(item => {
                if (!favorites.includes(item.id)) checkItemMatch(item, userWords, results);
            });
        }
        return results;
    };

    const checkItemMatch = (item, words, results) => {
        if (results.some(r => r.id === item.id)) return; // Уже нашли
        const names = [item.name, item.name_ru, item.name_es, item.name_de, item.slug].filter(n => n);
        
        // Проверяем совпадение
        const match = names.some(n => {
            return words.some(w => isFuzzyMatch(w, n.toLowerCase()));
        });
        
        if (match) results.push(item);
    };

    const mixMatches = findCatInText(cleanText);

    // Если нашли 2 и более категорий — делаем МИКС
    if (mixMatches.length >= 2) {
        const mainItem = mixMatches[0]; // Берем первый как базу
        const secondaryItem = mixMatches[1]; // Второй как донор тегов
        
        // Добавляем уникальные теги второго предмета в detectedMods
        secondaryItem.tags.forEach(t => {
            const modMatch = modifiersData.find(m => m.key.toLowerCase() === t || m.en.toLowerCase() === t);
            if (modMatch) detectedMods.push(modMatch.key);
            else {
            }
        });

        // Формируем причину
        const n1 = getLocalizedName(mainItem);
        const n2 = getLocalizedName(secondaryItem);
        
        const reasons = {
            en: `Mix: ${n1} + ${n2} 🍸`,
            ru: `Микс: ${n1} + ${n2} 🍸`,
            es: `Mezcla: ${n1} + ${n2} 🍸`,
            de: `Mix: ${n1} + ${n2} 🍸`
        };

        return { 
            item: mainItem, 
            reason: reasons[currentLang] || reasons.en, 
            detectedMods: [...new Set(detectedMods)] // Убираем дубли
        };
    }

    // === 4. ОБЫЧНЫЙ ПОИСК (С учетом отрицаний) ===
    
    // Парсинг отрицаний ("без анала")
    let positiveQuery = rawText;
    let negativeTerms = [];

    NEGATIVES.forEach(neg => {
        if (positiveQuery.includes(neg)) {
            const parts = positiveQuery.split(neg);
            // Берем всё, что после слова "без"
            if (parts.length > 1) {
                // Пытаемся взять слово или фразу после отрицания
                const blockedPart = parts[1].trim().split(/[.,!?;]|\s+(and|и|y|und)\s+/)[0]; 
                if (blockedPart.length > 2) {
                    negativeTerms.push(blockedPart.trim());
                }
            }
        }
    });

    // Разбиваем на токены (слова)
    let rawTokens = positiveQuery
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "")
        .split(/\s+/)
        .filter(w => w.length > 2 && !STOP_WORDS.includes(w) && !negativeTerms.some(n => w.includes(n)));

    // Проверяем контекст (Жестче/Мягче)
    let tokens = [];
    let contextMode = null; 

    rawTokens.forEach(token => {
        let found = false;
        if (CONTEXT_TRIGGERS.harder.includes(token)) contextMode = 'harder';
        else if (CONTEXT_TRIGGERS.softer.includes(token)) contextMode = 'softer';
        else if (CONTEXT_TRIGGERS.more.includes(token)) contextMode = 'more';
        
        // Синонимы
        for (const [key, aliases] of Object.entries(KEYWORD_ALIASES)) {
            if (key === token || aliases.some(alias => isFuzzyMatch(token, alias))) {
                tokens.push(key);
                found = true;
                break;
            }
        }
        if (!found) tokens.push(token);
    });

    // Применяем контекст интенсивности
    if (contextMode === 'harder') {
        if (currentIntensity < 3) updateIntensity(3);
        tokens.push(...['extreme', 'rough', 'bdsm']);
    } else if (contextMode === 'softer') {
        if (currentIntensity > 1) updateIntensity(1);
        tokens.push(...['romantic', 'soft', 'vanilla']);
    } else if (contextMode === 'more' && lastGeneratedItem) {
        tokens.push(...lastGeneratedItem.tags.slice(0, 2)); 
    }

    // Если ничего не нашли
    if (tokens.length === 0 && !contextMode && detectedMods.length === 0) return null;

    // СКОРИНГ (Поиск кандидатов)
    let candidates = data.map(item => {
        let score = 0;
        
        // Строка для проверки банов
        const fullString = [item.name, item.name_ru, item.name_es, item.name_de, item.slug, ...item.tags].join(" ").toLowerCase();
        
        // ШТРАФ ЗА ОТРИЦАНИЯ
        const isBanned = negativeTerms.some(neg => {
            // Проверяем, содержится ли запрещенное слово в описании предмета
            return isFuzzyMatch(neg, item.name.toLowerCase()) || 
                   isFuzzyMatch(neg, (item.name_ru||"").toLowerCase()) ||
                   item.tags.some(t => isFuzzyMatch(neg, t));
        });

        if (isBanned) return { item, score: -5000 }; // Моментальный бан

        // Стандартный поиск
        const targetWords = [];
        const addWords = (str) => { if(str) str.toLowerCase().split(/[\s-]+/).forEach(w => targetWords.push(w)); };
        
        addWords(item.name);
        addWords(item.name_ru);
        addWords(item.name_es);
        addWords(item.slug);
        item.tags.forEach(t => targetWords.push(t));

        tokens.forEach(token => {
            if (item.slug === token) score += 60;
            else {
                const bestMatch = targetWords.find(word => isFuzzyMatch(token, word));
                if (bestMatch) score += 40;
            }
        });

        // Бонусы
        if (score > 0) {
            if (favorites.includes(item.id)) score += 10;
            if (cooldownList.includes(item.id)) score -= 30; 
            score += Math.random() * 5;
        }

        return { item, score };
    });

    candidates.sort((a, b) => b.score - a.score);

    // Возврат победителя
    if (candidates.length > 0 && candidates[0].score > 0) {
        const winner = candidates[0].item;
        const localizedName = getLocalizedName(winner);
        
        const AI_RESPONSES = {
            en: { harder: "Spiced it up 🔥", softer: "Something gentler ✨", mention: "You mentioned: " },
            ru: { harder: "Добавил перчинки 🔥", softer: "Что-то понежнее ✨", mention: "Ты упомянул: " },
            es: { harder: "Más picante 🔥", softer: "Algo más suave ✨", mention: "Mencionaste: " },
            de: { harder: "Etwas Schärfe 🔥", softer: "Etwas Sanftes ✨", mention: "Du sagtest: " }
        };

        const phrases = AI_RESPONSES[currentLang] || AI_RESPONSES['en'];
        let reasonText = "";
        
        if (contextMode === 'harder') reasonText = phrases.harder;
        else if (contextMode === 'softer') reasonText = phrases.softer;
        else {
            reasonText = phrases.mention + `<span style="color:var(--accent); font-weight:700;">${localizedName}</span>`;
        }

        return { 
            item: winner, 
            reason: reasonText, 
            tokens: winner.reasons,
            detectedMods: [...new Set(detectedMods)]
        };
    }

    return null;
}

    function getTranslation(key) {
        const t = langData[currentLang] || langData['en'];
        return t[key] || "";
    }

    function processAiRequest() {
        const input = document.getElementById('ai-input');
        const text = input.value.trim();
        if (!text) return;

        // 1. UI: Скрываем ввод, показываем спиннер
        document.getElementById('assistant-ui').classList.remove('visible');
        document.getElementById('thinking-ui').style.display = 'flex';
        
        const thinkTxt = document.getElementById('ai-thinking-text');
        
        // 2. АНИМАЦИЯ МЫШЛЕНИЯ
        const steps = THINKING_STEPS[currentLang] || THINKING_STEPS['en'];
        let stepIndex = 0;
        thinkTxt.innerText = steps[0];

        const thinkInterval = setInterval(() => {
            stepIndex = (stepIndex + 1) % steps.length;
            thinkTxt.innerText = steps[stepIndex];
        }, 450);

        // 3. ОБРАБОТКА
        setTimeout(() => {
            clearInterval(thinkInterval);
            
            const result = analyzeUserRequest(text); 
            
            const overlay = document.getElementById('mode-start-overlay');
            overlay.classList.add('hidden'); 
            
            // Сброс UI
            setTimeout(() => {
                document.getElementById('thinking-ui').style.display = 'none';
                document.getElementById('ai-input').value = '';
                document.getElementById('btn-ai-go').classList.remove('visible');
                document.getElementById('mode-start-text').style.opacity = '1';
                document.getElementById('mode-buttons-container').style.opacity = '1';
                document.getElementById('mode-buttons-container').style.pointerEvents = 'auto';
                randomizeModeGreeting();
            }, 500);

            const statusEl = document.getElementById('status-text');
            const t = langData[currentLang] || langData['en'];
            const failPhrases = t.ai_phrases_fail || ["Try this instead:"];
            const randomFail = failPhrases[Math.floor(Math.random() * failPhrases.length)];

            if (result) {
                // УСПЕХ
                aiContextTokens = result.tokens || [];
                setAppMode('ai');

                // === СБРОС ПРЕДЫДУЩИХ МОДОВ ===
                activeMods.clear();
                // ====================================

                // === УМНОЕ ДОБАВЛЕНИЕ МОДОВ ===
                if (result.detectedMods && result.detectedMods.length > 0) {
                    
                    // Подготовка данных для проверки дубликатов
                    const winnerTags = result.item.tags.map(t => t.toLowerCase()); // Теги категории
                    const winnerName = result.item.name.toLowerCase(); // Имя (EN)
                    const winnerNameRu = (result.item.name_ru || "").toLowerCase(); // Имя (RU)
                    const winnerSlug = result.item.slug.toLowerCase();

                    result.detectedMods.forEach(modKey => {
                        const tagToCheck = modKey.toLowerCase();

                        // ПРОВЕРКА: Если модификатор уже есть в категории — НЕ добавляем его
                        // 1. Есть ли такой тег у категории? (trans -> trans)
                        const hasTag = winnerTags.includes(tagToCheck);
                        // 2. Есть ли это слово в названии? (Shemale Fucks Shemale -> trans нет, но по тегу поймали выше)
                        const inName = winnerName.includes(tagToCheck) || winnerNameRu.includes(tagToCheck);
                        // 3. Есть ли в слаге?
                        const inSlug = winnerSlug.includes(tagToCheck);

                        // Добавляем ТОЛЬКО если модификатор приносит что-то новое
                        if (!hasTag && !inName && !inSlug) {
                            activeMods.add(modKey);

                            // Добавляем в пул пользователя (визуально вниз)
                            if (!userModifiersPool.includes(modKey)) {
                                if (userModifiersPool.length >= 10) userModifiersPool.shift();
                                userModifiersPool.push(modKey);
                            }
                        }
                    });
                    
                    // Сохраняем пул и обновляем UI
                    localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
                    renderModifiers(); 
                }
                // ===============================================

                forceShowResult(result.item, 'ai_request', result.reason);
                
                // Анимация
                const wrapper = document.getElementById('card-anim-wrapper');
                if(wrapper) {
                    wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
                    void wrapper.offsetWidth; 
                    wrapper.classList.add('anim-fly-left');
                }

            } else {
                // НЕУДАЧА
                if(statusEl) {
                    statusEl.innerText = randomFail;
                    statusEl.style.color = "var(--text-secondary)";
                }
                setAppModeAndStart('pleasure');
            }

        }, 1800);
    }

    function openAssistantUI() {
        initAiRollingPrompts()
        // 1. Анимируем уход старых элементов (Текст и Кнопки)
        const startText = document.getElementById('mode-start-text');
        const modeBtns = document.getElementById('mode-buttons-container');
        
        // Добавляем класс, который уводит их вверх и делает прозрачными
        if(startText) startText.classList.add('fade-out-up');
        if(modeBtns) modeBtns.classList.add('fade-out-up');

        // 2. Открываем интерфейс ассистента с задержкой (чтобы старое успело начать исчезать)
        setTimeout(() => {
            const ui = document.getElementById('assistant-ui');
            ui.classList.add('visible'); // Сработает CSS анимация scale + opacity
            
            // --- РАНДОМИЗАЦИЯ ТЕКСТА (Как и было) ---
            const t = langData[currentLang] || langData['en'];
            
            const prompts = Array.isArray(t.ai_prompt) ? t.ai_prompt : [t.ai_prompt];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.querySelector('.assistant-prompt').innerText = randomPrompt;

            const placeholders = Array.isArray(t.ai_placeholder) ? t.ai_placeholder : [t.ai_placeholder];
            const randomPlaceholder = placeholders[Math.floor(Math.random() * placeholders.length)];
            
            const input = document.getElementById('ai-input');
            input.placeholder = randomPlaceholder;
            input.value = "";
            
            const btnText = document.querySelector('#btn-ai-go span');
            if(btnText) btnText.innerText = t.ai_btn_go || "Find It";

            // Фокус чуть позже, когда анимация закончится
            setTimeout(() => input.focus(), 300);

            // Логика ввода
            input.oninput = (e) => {
                const btn = document.getElementById('btn-ai-go');
                if (e.target.value.trim().length > 0) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            };
            input.onkeydown = (e) => {
                if (e.key === 'Enter') processAiRequest();
            };
        }, 50); // Небольшая задержка для наложения анимаций
    }

    function closeAssistantUI() {
        const ui = document.getElementById('assistant-ui');
        
        // 1. Скрываем интерфейс ассистента
        ui.classList.remove('visible');
        
        // 2. Возвращаем кнопки и текст (убираем класс ухода)
        const startText = document.getElementById('mode-start-text');
        const modeBtns = document.getElementById('mode-buttons-container');
        
        // Ждем пока поле исчезнет, потом возвращаем кнопки
        setTimeout(() => {
            if(startText) {
                startText.classList.remove('fade-out-up');
                // Сброс инлайновых стилей на всякий случай
                startText.style.opacity = ''; 
                startText.style.transform = '';
            }
            if(modeBtns) {
                modeBtns.classList.remove('fade-out-up');
                modeBtns.style.opacity = '';
                modeBtns.style.transform = '';
                modeBtns.style.pointerEvents = 'auto';
            }
        }, 200);
        
        document.getElementById('ai-input').value = '';
        document.getElementById('btn-ai-go').classList.remove('visible');
    }

    function toggleVoiceInput() {
        const btn = document.getElementById('btn-mic');
        
        if (!('webkitSpeechRecognition' in window)) {
            alert("Voice input not supported in this browser.");
            return;
        }

        if (window.recognition && window.isListening) {
            window.recognition.stop();
            return;
        }

        const recognition = new webkitSpeechRecognition();
        window.recognition = recognition;
        
        // Выбираем язык распознавания на основе текущего языка приложения
        const langMap = { 'en': 'en-US', 'ru': 'ru-RU', 'es': 'es-ES', 'de': 'de-DE' };
        recognition.lang = langMap[currentLang] || 'en-US';
        
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            window.isListening = true;
            btn.classList.add('listening');
            document.getElementById('ai-input').placeholder = "Listening...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            const input = document.getElementById('ai-input');
            input.value = transcript;
            document.getElementById('btn-ai-go').classList.add('visible');
            // Не отправляем сразу, даем пользователю проверить текст
        };

        recognition.onend = () => {
            window.isListening = false;
            btn.classList.remove('listening');
            document.getElementById('ai-input').placeholder = getTranslation("ai_placeholder");
        };

        recognition.start();
    }

    function openModifiersSettings() {
        renderModifiersModal();
        document.getElementById('modal-mods-overlay').classList.add('open');
    }

    function closeModifiersSettings(e, force) {
        if (force || e.target.id === 'modal-mods-overlay') {
            document.getElementById('modal-mods-overlay').classList.remove('open');
        }
    }

    function toggleModInPool(key) {
        const index = userModifiersPool.indexOf(key);
        
        if (index > -1) {
            // Если есть -> удаляем (переносим в неактивные)
            userModifiersPool.splice(index, 1);
        } else {
            // Если нет -> добавляем, но проверяем лимит
            if (userModifiersPool.length >= 10) {
                const t = langData[currentLang] || langData['en'];
                alert(t.mod_limit_reached || "Max 10 modifiers!");
                return;
            }
            userModifiersPool.push(key);
        }
        
        // Сохраняем локально
        localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
        renderModifiersModal(); // Перерисовываем окно
        
        // Обновляем список в карточке реального времени, если она открыта
        if (currentItem) renderModifiersInCard(); 
    }

    function renderModifiersModal() {
        const activeContainer = document.getElementById('mods-list-active');
        const inactiveContainer = document.getElementById('mods-list-inactive');
        const counter = document.getElementById('mods-counter');
        const modalBody = document.querySelector('#modal-mods-overlay .modal-body');
        
        if (!activeContainer || !inactiveContainer) return;

        // Очистка
        activeContainer.innerHTML = '';
        inactiveContainer.innerHTML = '';
        
        // Обновляем счетчик
        if (counter) {
            counter.innerText = `${userModifiersPool.length} / 20`;
            counter.style.color = userModifiersPool.length >= 20 ? 'var(--highlight-red)' : 'var(--text-secondary)';
        }

        // Если пусто — пишем подсказку
        if (userModifiersPool.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.width = "100%";
            emptyMsg.style.textAlign = "center";
            emptyMsg.style.color = "var(--text-secondary)";
            emptyMsg.style.fontSize = "13px";
            emptyMsg.style.padding = "20px 0";
            emptyMsg.innerText = currentLang === 'ru' ? "Список пуст. Добавьте свои теги ниже." : "List empty. Add tags below.";
            inactiveContainer.appendChild(emptyMsg);
        }

        // Рендеринг чипов
        userModifiersPool.forEach(modKey => {
            const isActive = activeMods.has(modKey);
            const systemMod = modifiersData.find(x => x.key === modKey);
            const isCustom = !systemMod;
            
            let label = modKey;
            if (systemMod) {
                const langKey = ['en', 'ru', 'es', 'de'].includes(currentLang) ? currentLang : 'en';
                label = systemMod[langKey] || systemMod.en;
            }

            const btn = document.createElement('div');
            btn.className = isActive ? 'mod-chip active' : 'mod-chip inactive';
            
            // Если кастомный — пунктир
            if (isCustom && !isActive) btn.style.borderStyle = "dashed";

            // HTML
            let iconsHtml = isActive ? `<span style="font-size:12px; font-weight:800; margin-left:6px;">✓</span>` : '';
            // Крестик удаления есть У ВСЕХ теперь (чтобы можно было очистить список полностью)
            iconsHtml += `<span class="custom-mod-del" title="Delete" style="margin-left:8px; opacity:0.6;">✕</span>`;

            btn.innerHTML = `${label}${iconsHtml}`;
            
            // Удаление
            const delBtn = btn.querySelector('.custom-mod-del');
            if (delBtn) {
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteCustomMod(modKey);
                };
            }
            
            // Переключение
            btn.onclick = (e) => {
                if (e.target.classList.contains('custom-mod-del')) return;
                if (activeMods.has(modKey)) activeMods.delete(modKey);
                else activeMods.add(modKey);
                renderModifiersModal();
                if (currentItem) {
                    renderModifiersInCard();
                    renderResultName();
                    updateLink();
                }
            };
            
            if (isActive) activeContainer.appendChild(btn);
            else inactiveContainer.appendChild(btn);
        });

        // Форма ввода (без изменений, просто убедитесь что она есть)
        let addForm = document.getElementById('custom-mod-form');
        if (!addForm && modalBody) {
            addForm = document.createElement('div');
            addForm.id = 'custom-mod-form';
            addForm.style.marginTop = "20px";
            addForm.style.borderTop = "1px solid var(--border)";
            addForm.style.paddingTop = "15px";
            modalBody.appendChild(addForm);
            
            const t = (typeof langData !== 'undefined' && langData[currentLang]) ? langData[currentLang] : {};
            
            addForm.innerHTML = `
                <div id="btn-show-custom-input" class="ios-row clickable" onclick="toggleCustomInput(true)" style="justify-content:center; color:var(--accent); font-weight:700; background:rgba(255,255,255,0.05); border-radius:12px;">
                    + ${t.mod_add_custom || "Add Custom"}
                </div>
                
                <div id="custom-input-container" style="display:none; gap:10px;">
                    <input type="text" id="custom-mod-input" class="promo-input" placeholder="${t.mod_input_ph || "e.g. Redhead..."}" style="font-size:14px; padding:10px;">
                    <button class="btn-gen" onclick="submitCustomMod()" style="width:auto; padding:0 20px; font-size:14px; min-width:80px; height: 42px;">
                        ${t.mod_add_btn || "Add"}
                    </button>
                </div>
            `;
        }
    }

    function submitCustomMod() {
        const input = document.getElementById('custom-mod-input');
        if (!input) return;
        
        let val = input.value.trim();
        if (!val) return;
        
        // Валидация
        if (val.length > 20) {
            alert("Too long! Max 20 chars.");
            return;
        }
        
        // Форматирование (Первая буква заглавная)
        val = val.charAt(0).toUpperCase() + val.slice(1);

        // Проверка на дубликаты
        if (userModifiersPool.includes(val)) {
            alert("Already exists!");
            return;
        }
        
        // Лимит
        if (userModifiersPool.length >= 20) {
            alert("Limit reached (Max 20). Delete some first.");
            return;
        }

        // Добавляем в пул
        userModifiersPool.push(val);
        
        // Сразу делаем активным для удобства пользователя
        activeMods.add(val); 
        
        // Сохраняем в память
        localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
        
        // Сброс UI
        input.value = '';
        toggleCustomInput(false); 
        
        // Перерисовка
        renderModifiersModal(); 
        
        // Обновляем карточку на фоне
        if (typeof currentItem !== 'undefined' && currentItem) {
            renderModifiersInCard();
            renderResultName();
            updateLink();
        }
    }

    function deleteCustomMod(key) {
        if (confirm(`Remove "${key}"?`)) {
            // Удаляем из пула
            userModifiersPool = userModifiersPool.filter(k => k !== key);
            // Удаляем из активных, если он там был
            activeMods.delete(key);
            
            // Сохраняем
            localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
            
            // Перерисовываем
            renderModifiersModal();
            
            // Обновляем карточку
            if (typeof currentItem !== 'undefined' && currentItem) {
                renderModifiersInCard();
                renderResultName();
                updateLink();
            }
        }
    }

    function toggleCustomInput(show) {
        const btn = document.getElementById('btn-show-custom-input');
        const container = document.getElementById('custom-input-container');
        const input = document.getElementById('custom-mod-input');
        
        if (show) {
            if(btn) btn.style.display = 'none';
            if(container) {
                container.style.display = 'flex';
                if(input) input.focus();
            }
        } else {
            if(btn) btn.style.display = 'flex';
            if(container) container.style.display = 'none';
        }
    }
    
    document.addEventListener('keydown', function(event) {
        if (event.key === "Enter" && document.getElementById('custom-mod-input') === document.activeElement) {
            submitCustomMod();
        }
    });

    function renderModifiersInCard() {
        const container = document.getElementById('mod-container'); 
        if (!container) return;
        
        container.innerHTML = '';
        const t = langData[currentLang] || langData['en'];

        // 1. Если список ПУСТ -> Показываем кнопку "Добавить"
        if (!userModifiersPool || userModifiersPool.length === 0) {
            const addBtn = document.createElement('div');
            // Используем стили тега, но делаем его акцентным (пунктир)
            addBtn.className = 'tag';
            addBtn.style.border = '1px dashed var(--text-secondary)';
            addBtn.style.color = 'var(--accent)';
            addBtn.style.fontWeight = '700';
            
            // Текст кнопки
            const btnText = currentLang === 'ru' ? "+ Добавить моды" : "+ Add Modifiers";
            addBtn.innerText = btnText;
            
            // При клике открываем настройки
            addBtn.onclick = (e) => {
                e.stopPropagation(); // Чтобы не закрылась капсула
                openModifiersSettings();
            };
            
            container.appendChild(addBtn);
            return;
        }
        
        // 2. Если список НЕ пуст -> Рисуем как обычно
        
        // Заголовок "Добавить к жанру:"
        const header = document.createElement('div');
        header.className = 'mods-header';
        header.innerText = t.add_genre;
        container.appendChild(header);

        // Сбор тегов текущей карточки для фильтрации (умный фильтр)
        const itemTags = currentItem ? currentItem.tags : [];
        const itemName = currentItem ? currentItem.name.toLowerCase() : "";

        userModifiersPool.forEach(modKey => {
            const modObj = modifiersData.find(m => m.key === modKey);
            // Если это кастомный мод, создаем заглушку объекта
            const label = modObj ? (modObj[currentLang] || modObj.en) : modKey;

            // SMART FILTER: Пропускаем, если тег/название уже есть в карточке
            if (itemTags.includes(modKey.toLowerCase())) return;
            if (itemName.includes(modKey.toLowerCase())) return;

            const tag = document.createElement('div'); 
            tag.className = 'tag';
            if(activeMods.has(modKey)) tag.classList.add('selected');
            
            tag.innerText = label;
            
            tag.onclick = (e) => {
                e.stopPropagation();
                if(activeMods.has(modKey)) activeMods.delete(modKey); 
                else activeMods.add(modKey);
                
                renderModifiersInCard();
                renderResultName(); 
                updateLink();
            };
            container.appendChild(tag);
        });
    }

    function renderModifiers() {
        renderModifiersInCard();
    }

    // Генерация умных подсказок
    function getAiSuggestions() {
        const t = langData[currentLang] || langData['en'];
        const prompts = [];

        // 1. "Как вчера" (если есть история просмотров)
        if (watchHistory.length > 0) {
            prompts.push(currentLang === 'ru' ? "Хочу как вчера..." : "Like yesterday...");
        }

        // 2. "Пожестче"
        prompts.push(currentLang === 'ru' ? "Давай пожёстче..." : "Make it rougher...");

        // 3. "Удиви меня"
        prompts.push(currentLang === 'ru' ? "Удиви меня..." : "Surprise me...");

        // 4. "Любимое без X" (берем 1 любимый и 1 нелюбимый)
        if (favorites.length > 0 && blacklist.length > 0) {
            const favItem = data.find(x => x.id === favorites[0]);
            const banItem = data.find(x => x.id === blacklist[0]);
            if (favItem && banItem) {
                const fName = getLocalizedName(favItem);
                const bName = getLocalizedName(banItem);
                prompts.push(currentLang === 'ru' 
                    ? `${fName}, но без ${bName}` 
                    : `${fName} without ${bName}`);
            }
        }

        // 5. "Смесь X и Y" (берем 2 любимых)
        if (favorites.length >= 2) {
            // Берем случайные 2
            const shuffled = favorites.sort(() => 0.5 - Math.random()).slice(0, 2);
            const item1 = data.find(x => x.id === shuffled[0]);
            const item2 = data.find(x => x.id === shuffled[1]);
            if (item1 && item2) {
                const n1 = getLocalizedName(item1);
                const n2 = getLocalizedName(item2);
                prompts.push(currentLang === 'ru' 
                    ? `Смесь: ${n1} и ${n2}` 
                    : `Mix ${n1} and ${n2}`);
            }
        }

        // 6. "Без X и Y" (берем 2 из блэклиста)
        if (blacklist.length >= 2) {
            const item1 = data.find(x => x.id === blacklist[0]);
            const item2 = data.find(x => x.id === blacklist[1]);
            if (item1 && item2) {
                const n1 = getLocalizedName(item1);
                const n2 = getLocalizedName(item2);
                prompts.push(currentLang === 'ru' 
                    ? `Только без ${n1} и ${n2}` 
                    : `Anything but ${n1} and ${n2}`);
            }
        }

        // Заполнитель, если пусто
        if (prompts.length < 3) {
            prompts.push("Anal...");
            prompts.push("BDSM...");
            prompts.push("Romantic...");
        }

        return prompts.slice(0, 5); // Берем топ 5
    }

    function initAiRollingPrompts() {
        const container = document.getElementById('ai-rolling-list');
        const input = document.getElementById('ai-input');
        const overlay = document.getElementById('ai-rolling-container');
        
        if (!container) return;

        const suggestions = getAiSuggestions();
        
        container.innerHTML = suggestions.map(s => `<div class="rolling-item">${s}</div>`).join('');
        
        // Пересчитываем анимацию под количество элементов
        const count = suggestions.length;
        container.classList.add('animate-scroll');
        
        // Логика скрытия при вводе
        input.onfocus = () => overlay.classList.add('hidden');
        input.onblur = () => {
            if(input.value.trim() === '') overlay.classList.remove('hidden');
        };
        input.oninput = () => overlay.classList.add('hidden');
    }

    let wrappedArchive = JSON.parse(localStorage.getItem('xch_wrapped_archive')) || [];
    let activeDaysSet = new Set(JSON.parse(localStorage.getItem('xch_active_days')) || []);

    // 1. Отметка активности (Вызывать при каждом свайпе/просмотре)
    function markDayActive() {
        const today = new Date().toISOString().split('T')[0];
        if (!activeDaysSet.has(today)) {
            activeDaysSet.add(today);
            localStorage.setItem('xch_active_days', JSON.stringify([...activeDaysSet]));
            
            // При новом дне проверяем, не пора ли что-то заархивировать
            checkAutomaticArchiving();
        }
    }

    // 2. Автоматическая проверка периодов
    function checkAutomaticArchiving() {
        const now = new Date();
        const lastCheck = parseInt(localStorage.getItem('xch_last_archive_check') || '0');
        
        // Ограничение: проверяем не чаще раза в час
        if (Date.now() - lastCheck < 3600000) return; 
        localStorage.setItem('xch_last_archive_check', Date.now());

        // --- A. YEARLY CHECK (Смена года) ---
        const lastYearly = wrappedArchive.find(w => w.type === 'yearly' && w.isLatest);
        const lastYearlyYear = lastYearly ? new Date(lastYearly.timestamp).getFullYear() : 0;
        if (now.getFullYear() > lastYearlyYear && lastYearlyYear !== 0) {
            // Год сменился -> генерируем за прошлый год
            generateAndSaveWrapped('yearly');
        }

        // --- B. MONTHLY CHECK (Смена месяца) ---
        const lastMonthly = wrappedArchive.find(w => w.type === 'monthly' && w.isLatest);
        const lastMonthlyMonth = lastMonthly ? new Date(lastMonthly.timestamp).getMonth() : -1;
        if (now.getMonth() !== lastMonthlyMonth && lastMonthlyMonth !== -1) {
            // Месяц сменился -> генерируем за прошлый месяц
            generateAndSaveWrapped('monthly');
        }

        // --- C. WEEKLY CHECK (Накопление 7 дней) ---
        // Если накоплено 7+ дней активности, закрываем неделю
        if (activeDaysSet.size >= 7) {
            generateAndSaveWrapped('weekly');
            
            // СБРОС СЧЕТЧИКА ДНЕЙ ПОСЛЕ НЕДЕЛЬНОГО ОТЧЕТА
            activeDaysSet.clear();
            // Добавляем сегодняшний день обратно, так как он уже начался
            activeDaysSet.add(now.toISOString().split('T')[0]);
            localStorage.setItem('xch_active_days', JSON.stringify([...activeDaysSet]));
        }
    }

    // 3. Основная функция генерации
    function generateAndSaveWrapped(type) {
        const now = Date.now();
        const oneDay = 86400000;
        let startTime = 0;

        if (type === 'daily') startTime = now - oneDay;
        else if (type === 'weekly') startTime = now - (7 * oneDay);
        else if (type === 'monthly') startTime = now - (30 * oneDay);
        else if (type === 'yearly') startTime = now - (365 * oneDay);

        const relevantLogs = activityLog.filter(l => l.ts >= startTime);
        const relevantWatch = watchHistory.filter(w => w.timestamp >= startTime);

        if (relevantLogs.length < 5 && type !== 'daily') return null;

        const stats = calculateDeepStats(relevantLogs, relevantWatch);

        // Сравнение с прошлым
        const duration = now - startTime;
        const prevStartTime = startTime - duration;
        const prevLogs = activityLog.filter(l => l.ts >= prevStartTime && l.ts < startTime);
        const prevWatches = watchHistory.filter(w => w.timestamp >= prevStartTime && w.timestamp < startTime);
        
        const prevStats = calculateDeepStats(prevLogs, prevWatches);
        
        stats.deltaActions = stats.totalActions - prevStats.totalActions;
        stats.deltaWatchTime = stats.totalWatchTime - prevStats.totalWatchTime;
        
        // Сохраняем топы прошлого периода для слайда сравнения
        stats.prevTopTags = prevStats.topTags || [];

        // Сохраняем психо-счетчики прошлого периода для диаграммы
        stats.prevPsychoCounts = prevStats.psychoCounts || {};

        const wrappedObj = {
            id: Date.now(),
            type: type,
            timestamp: now,
            rangeStr: getRangeString(startTime, now, type),
            stats: stats,
            viewed: false,
            isLatest: true
        };

        wrappedArchive.forEach(w => { if(w.type === type) w.isLatest = false; });
        wrappedArchive.unshift(wrappedObj);
        localStorage.setItem('xch_wrapped_archive', JSON.stringify(wrappedArchive));
        
        return wrappedObj;
    }

    // 4. Глубокий анализ статистики 
    function calculateDeepStats(logs, watches) {
        let totalActions = 0;
        let watchCount = 0;
        let swipeCount = 0;
        let likeCount = 0;     
        let dislikeCount = 0;  
        
        const tagCounts = {};
        const itemCounts = {};
        
        // --- НОВАЯ ЛОГИКА ДЛЯ ДИАГРАММЫ ---
        const psychoCounts = {};
        PSYCHO_AXES.forEach(key => psychoCounts[key] = 0);
        // ----------------------------------

        const hours = new Array(24).fill(0);
        const IGNORED_TAGS = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd'];

        logs.forEach(l => {
            totalActions++;
            const h = new Date(l.ts).getHours();
            hours[h]++;

            if (l.type === 'watch') watchCount++;
            else swipeCount++;

            if (l.type === 'like') likeCount++;
            else if (l.type === 'dislike' || l.type === 'pass') dislikeCount++;

            // Вес действия для диаграммы
            let weight = 1;
            if (l.type === 'watch') weight = 3;      // Просмотр важнее
            if (l.type === 'like') weight = 2;       // Лайк средний
            if (l.type === 'dislike') weight = 0;    // Дизлайк не учитываем в профиле желаний

            if (l.tags) {
                l.tags.forEach(t => {
                    if (IGNORED_TAGS.includes(t)) return;
                    tagCounts[t] = (tagCounts[t] || 0) + 1;

                    // --- ЗАПОЛНЕНИЕ ДИАГРАММЫ ---
                    // Проверяем, входит ли тег в наши 10 осей
                    if (PSYCHO_AXES.includes(t)) {
                        psychoCounts[t] += weight;
                    }
                });
            }
            if (l.id) itemCounts[l.id] = (itemCounts[l.id] || 0) + 1;
        });

        const totalWatchTime = watches.reduce((sum, w) => sum + w.seconds, 0);

        const topTags = Object.entries(tagCounts)
            .sort((a,b) => b[1]-a[1])
            .slice(0, 10).map(x => x[0]);
        
        const topItems = Object.entries(itemCounts)
            .sort((a,b) => b[1]-a[1])
            .slice(0, 3).map(x => x[0]);

        const morning = hours.slice(5, 12).reduce((a,b)=>a+b,0);
        const day = hours.slice(12, 20).reduce((a,b)=>a+b,0);
        const night = hours.slice(20, 24).reduce((a,b)=>a+b,0) + hours.slice(0, 5).reduce((a,b)=>a+b,0);
        
        let peakTime = 'day';
        if (night > day && night > morning) peakTime = 'night';
        else if (morning > day && morning > night) peakTime = 'morning';

        let achievement = 'day';
        if (peakTime === 'night') achievement = 'night';
        else if (peakTime === 'morning') achievement = 'morning';
        
        const ratio = watchCount / (swipeCount || 1);
        if (ratio > 0.4) achievement = 'binger';
        else if (ratio < 0.05 && totalActions > 20) achievement = 'picky';
        else {
            const uniqueTags = Object.keys(tagCounts).length;
            if (uniqueTags / (totalActions || 1) > 0.8) achievement = 'explorer';
            else achievement = 'hedonist';
        }

        return {
            totalActions, watchCount, swipeCount, totalWatchTime,
            likeCount, dislikeCount,
            topTags, topItems, peakTime, achievement,
            psychoCounts
        };
    }

    function calculatePsychotype(psychoCounts) {
        // Превращаем объект в массив [ключ, значение] и сортируем
        const sorted = Object.entries(psychoCounts).sort((a, b) => b[1] - a[1]);
        
        const top1 = sorted[0];
        const top2 = sorted[1];
        
        // 1. Если активности почти нет
        if (top1[1] < 2) return 'vanilla';

        // 2. Проверка на "Коллекционера" (если топ-3 близки друг к другу и высоки)
        const top3 = sorted[2];
        if (top3 && top3[1] > 5 && (top1[1] - top3[1] < 3)) return 'collector';

        const k1 = top1[0];
        const k2 = top2[0];

        // 3. Комбинации (приоритет)
        const has = (key) => (k1 === key || (k2 === key && top2[1] > top1[1] * 0.6)); // Второй тег должен быть значимым

        if (has('bdsm') && (has('taboo') || has('humiliation'))) return 'dark_lord';
        if (has('public') && has('roleplay')) return 'performer';
        if (has('body-part') && has('clothing')) return 'worshipper';
        if (has('psychological') && has('humiliation')) return 'brainwasher';
        if (has('public') && has('taboo')) return 'risk_taker';
        if (has('group') && (has('bdsm') || has('public'))) return 'orgy_master';
        if (has('roleplay') && has('sensory')) return 'immersionist';

        // 4. Если комбинаций нет, возвращаем доминирующую ось
        return k1; // Вернет 'bdsm', 'roleplay' и т.д.
    }

    // Форматирование даты
    function getRangeString(start, end, type) {
        if (type === 'daily') return new Date(end).toLocaleDateString();
        
        const d1 = new Date(start);
        const d2 = new Date(end);
        const m1 = d1.getMonth() + 1;
        const m2 = d2.getMonth() + 1;
        
        // Формат: 19.01 - 26.01
        const pad = (n) => n < 10 ? '0'+n : n;
        return `${pad(d1.getDate())}.${pad(m1)} - ${pad(d2.getDate())}.${pad(m2)}`;
    }

    // 5. Кнопка запуска (Trigger)
    function triggerWrappedBtn() {
        const isPaid = subscriptionLevel !== 'free';
        const now = new Date();

        // 1. Проверяем наличие АРХИВНЫХ отчетов (Непросмотренных)
        // Сортируем по иерархии: Year > Month > Week
        const unread = wrappedArchive.filter(w => !w.viewed).sort((a,b) => {
            const priorities = { yearly: 3, monthly: 2, weekly: 1, daily: 0 };
            return priorities[b.type] - priorities[a.type];
        });

        if (unread.length > 0) {
            openWrappedUI(unread[0]);
            return;
        }

        
        if (activeDaysSet.size >= 7) {
            // Если накоплена неделя — форсируем закрытие недели
            const snapshot = generateAndSaveWrapped('weekly');
            
            // Сброс счетчика
            activeDaysSet.clear();
            activeDaysSet.add(now.toISOString().split('T')[0]);
            localStorage.setItem('xch_active_days', JSON.stringify([...activeDaysSet]));
            
            if (snapshot) openWrappedUI(snapshot);
        } 
        else if (isPaid) {
            // Платные могут смотреть Daily в любой момент
            const snapshot = generateAndSaveWrapped('daily');
            if (snapshot) openWrappedUI(snapshot);
            else alert("Not enough activity today!");
        } 
        else {
            // Free user без недели
            const daysLeft = 7 - activeDaysSet.size;
            const msg = currentLang === 'ru' ? 
                `Нужно еще ${daysLeft} активных дней для Weekly!` : 
                `Need ${daysLeft} more active days for Weekly!`;
            alert(msg);
        }
    }

    function createRadarChartSVG(currentData, prevData) {
        const size = 340; // Увеличили размер холста
        const center = size / 2;
        const radius = 100; // Радиус остался тем же, чтобы было место для текста
        const levels = 3;

        let maxVal = 0;
        PSYCHO_AXES.forEach(key => {
            maxVal = Math.max(maxVal, currentData[key] || 0, prevData ? (prevData[key] || 0) : 0);
        });
        if (maxVal === 0) maxVal = 5; // Дефолт, чтобы график не был точкой

        const getCoords = (value, index) => {
            const angle = (Math.PI * 2 * index) / 10 - (Math.PI / 2);
            // Ограничиваем радиус, чтобы график не вылезал за пределы
            const r = (Math.min(value, maxVal) / maxVal) * radius;
            const x = center + r * Math.cos(angle);
            const y = center + r * Math.sin(angle);
            return [x, y];
        };

        // Сетка
        let gridSVG = '';
        for (let i = 1; i <= levels; i++) {
            let levelPoints = [];
            const r = (radius / levels) * i;
            for (let j = 0; j < 10; j++) {
                const angle = (Math.PI * 2 * j) / 10 - (Math.PI / 2);
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                levelPoints.push(`${x},${y}`);
            }
            gridSVG += `<polygon points="${levelPoints.join(' ')}" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>`;
        }

        // Оси и Текст
        let axesSVG = '';
        let labelsSVG = '';
        const langKey = ['en','ru','es','de'].includes(currentLang) ? currentLang : 'en';

        PSYCHO_AXES.forEach((key, i) => {
            const angle = (Math.PI * 2 * i) / 10 - (Math.PI / 2);
            const x = center + radius * Math.cos(angle);
            const y = center + radius * Math.sin(angle);
            
            axesSVG += `<line x1="${center}" y1="${center}" x2="${x}" y2="${y}" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>`;

            // Текст подальше от края (radius + 20)
            const labelR = radius + 25; 
            const lx = center + labelR * Math.cos(angle);
            const ly = center + labelR * Math.sin(angle);
            
            const labelText = PSYCHO_LABELS[key][langKey].toUpperCase();
            
            // Умное выравнивание
            let anchor = 'middle';
            let dominantBaseline = 'middle';
            
            if (i === 0) { anchor = 'middle'; dominantBaseline = 'auto'; } // Верх
            else if (i === 5) { anchor = 'middle'; dominantBaseline = 'hanging'; } // Низ
            else if (i > 0 && i < 5) { anchor = 'start'; } // Справа
            else { anchor = 'end'; } // Слева

            labelsSVG += `<text x="${lx}" y="${ly}" text-anchor="${anchor}" dominant-baseline="${dominantBaseline}" fill="#ffffff" font-size="10" font-family="sans-serif" font-weight="700" style="text-shadow:0 1px 3px rgba(0,0,0,0.8);">${labelText}</text>`;
        });

        // Данные
        let prevPoints = [];
        if (prevData) {
            PSYCHO_AXES.forEach((key, i) => {
                const val = prevData[key] || 0;
                const [x, y] = getCoords(val, i);
                prevPoints.push(`${x},${y}`);
            });
        }
        const prevPoly = prevPoints.length > 0 
            ? `<polygon points="${prevPoints.join(' ')}" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1" stroke-dasharray="4"/>` 
            : '';

        let currPoints = [];
        PSYCHO_AXES.forEach((key, i) => {
            const val = currentData[key] || 0;
            const [x, y] = getCoords(val, i);
            currPoints.push(`${x},${y}`);
        });
        // Заливка цветом темы
        const currPoly = `<polygon points="${currPoints.join(' ')}" fill="var(--accent)" fill-opacity="0.5" stroke="var(--accent)" stroke-width="2"/>`;
        
        let dotsSVG = '';
        currPoints.forEach(p => {
            const [px, py] = p.split(',');
            dotsSVG += `<circle cx="${px}" cy="${py}" r="3" fill="#fff"/>`;
        });

        return `
            <svg viewBox="0 0 ${size} ${size}" width="100%" height="100%" style="overflow:visible;">
                ${gridSVG}
                ${axesSVG}
                ${prevPoly}
                ${currPoly}
                ${dotsSVG}
                ${labelsSVG}
            </svg>
        `;
    }

    // 6. Отрисовка UI (Слайды)
    function openWrappedUI(dataObj) {
        const overlay = document.getElementById('wrapped-mount');
        overlay.innerHTML = '';
        overlay.classList.add('active');
        
        const slides = [];
        const stats = dataObj.stats;
        const type = dataObj.type;
        
        // Определяем язык
        const langKey = ['en','ru','es','de'].includes(currentLang) ? currentLang : 'en';
        
        // --- 1. ПЕРЕВОДЫ ---
        const TXT = {
            title: {en:"Fetish<br><span style='color:var(--accent)'>Wrapped</span>", ru:"Итоги<br><span style='color:var(--accent)'>Фетишей</span>", es:"Resumen<br><span style='color:var(--accent)'>Fetichista</span>", de:"Fetisch<br><span style='color:var(--accent)'>Rückblick</span>"},
            since: {en:"Since Last Time", ru:"С прошлого раза", es:"Desde la última vez", de:"Seit dem letzten Mal"},
            act: {en:"Swipes", ru:"Свайпов", es:"Deslizamientos", de:"Swipes"},
            watch: {en:"Watch Time", ru:"Время просмотра", es:"Tiempo visto", de:"Zeit"},
            period_daily: {en: "Last 24 Hours", ru: "За последние 24ч", es: "Últimas 24h", de: "Letzte 24h"},
            period_weekly: {en: "This Week", ru: "За эту неделю", es: "Esta semana", de: "Diese Woche"},
            period_monthly: {en: "This Month", ru: "За этот месяц", es: "Este mes", de: "Diesen Monat"},
            period_yearly: {en: "This Year", ru: "За этот год", es: "Este año", de: "Dieses Jahr"},
            vibe: {en:"Your Vibe", ru:"Твой Вайб", es:"Tu Vibra", de:"Deine Stimmung"},
            evol: {en:"Taste Evolution", ru:"Эволюция Вкусов", es:"Evolución", de:"Entwicklung"},
            evol_sub: {en:"Vs Previous Period", ru:"Сравнение с прошлым", es:"Vs periodo anterior", de:"Vs letztes Mal"},
            obsess: {en:"Your Obsessions", ru:"Твои Одержимости", es:"Tus Obsesiones", de:"Deine Obsessionen"},
            cmp_more: {en:"more", ru:"больше", es:"más", de:"mehr"},
            cmp_less: {en:"less", ru:"меньше", es:"menos", de:"weniger"},
            cmp_same: {en:"same", ru:"также", es:"igual", de:"gleich"},
            
            // Финальная карточка
            sum_watch: {en:"Videos Watched", ru:"Видео просмотрено", es:"Videos vistos", de:"Angeschaut"},
            sum_time: {en:"Total Time", ru:"Общее время", es:"Tiempo Total", de:"Gesamtzeit"},
            sum_psycho: {en:"YOUR PSYCHOTYPE", ru:"ТВОЙ ПСИХОТИП", es:"TU PSICOTIPO", de:"DEIN PSYCHOTYP"},
            top_genre: {en:"Top Genre", ru:"Топ Жанр", es:"Top Género", de:"Top Genre"},
            
            btn_done: {en:"Done", ru:"Готово", es:"Listo", de:"Fertig"},
            caption: {en:"Discover yourself", ru:"Узнай себя", es:"Descúbrete", de:"Entdecke dich"},
            
            // Слайд диаграммы
            radar_title: {en: "Your Psycho-Profile", ru: "Твой психо-портрет", es: "Tu Psico-Perfil", de: "Dein Psycho-Profil"},
            radar_curr: {en: "Current", ru: "Сейчас", es: "Ahora", de: "Aktuell"},
            radar_prev: {en: "Previous", ru: "Прошлое", es: "Anterior", de: "Vorher"},

            badge_new: {en:"NEW", ru:"NEW", es:"NUEVO", de:"NEU"},
            badge_up: {en:"UP", ru:"UP", es:"SUBIÓ", de:"HOCH"},
            badge_down: {en:"DOWN", ru:"DOWN", es:"BAJÓ", de:"RUNTER"}
        };
        
        const t = (k) => (TXT[k] && TXT[k][langKey]) ? TXT[k][langKey] : (TXT[k] ? TXT[k].en : "");

        const badgeText = WRAPPED_CONFIG.badges[langKey][type] || type.toUpperCase();
        const phrases = WRAPPED_CONFIG.phrases[type] || WRAPPED_CONFIG.phrases.daily;
        const introText = phrases[langKey][Math.floor(Math.random() * phrases[langKey].length)];
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&data=${encodeURIComponent(window.location.origin)}`;

        const psychoKey = calculatePsychotype(stats.psychoCounts);
        const psychoData = PSYCHO_TYPES[psychoKey] || PSYCHO_TYPES['vanilla'];
        const psychoName = psychoData[langKey].toUpperCase();
        const psychoDesc = psychoData['desc_' + langKey];

        // --- СЛАЙД 1: ВСТУПЛЕНИЕ ---
        slides.push(`
            <div class="wrapped-slide bg-dark active-slide">
                <div class="w-badge ${type}" style="transform:scale(1.5); margin-bottom:30px; box-shadow:0 10px 30px rgba(0,0,0,0.5);">${badgeText}</div>
                <div class="wrapped-big-text" style="font-size:46px;">${t('title')}</div>
                <div class="wrapped-sub-text" style="opacity:0.8; margin-top:20px; font-family:monospace;">${dataObj.rangeStr}</div>
                <div class="wrapped-sub-text" style="margin-top:40px; font-weight:700; max-width:80%;">${introText}</div>
            </div>
        `);

        // --- СЛАЙД 2: СРАВНЕНИЕ ---
        if (type !== 'daily' || Math.abs(stats.deltaActions) > 0) {
        
            // 1. Выбираем правильный заголовок
            let periodHeader = t('period_' + type); 
            if (!periodHeader) periodHeader = t('since'); // Фолбек

            // 2. Логика сравнения (vs prev)
            const getTrendHTML = (delta, labelKey) => {
                if (delta === 0) return `<span style="opacity:0.6">= ${t('cmp_same')}</span>`;
                const isPos = delta > 0;
                const color = isPos ? "#2ecc71" : "#e74c3c";
                const sign = isPos ? "+" : "";
                // Пример: "+50 больше, чем в прошлый раз"
                // Для краткости просто: "+50 vs prev" или локализовать "vs prev"
                return `<span style="color:${color}">${sign}${delta}</span> <span style="opacity:0.6">vs prev</span>`;
            };

            const htmlActTrend = getTrendHTML(stats.deltaActions);
            const htmlTimeTrend = getTrendHTML(Math.round(stats.deltaWatchTime/60));

            // Абсолютные значения
            const absActions = stats.totalActions;
            const absTimeMin = Math.round(stats.totalWatchTime / 60);

            slides.push(`
                <div class="wrapped-slide bg-fire">
                    <!-- Динамический заголовок -->
                    <div class="wrapped-sub-text" style="text-transform:uppercase; letter-spacing:2px; font-size:14px; margin-bottom:40px; font-weight:800; color:rgba(255,255,255,0.9); border-bottom:1px solid rgba(255,255,255,0.3); padding-bottom:10px;">
                        ${periodHeader}
                    </div>
                    
                    <!-- Блок 1: Действия -->
                    <div style="margin-bottom:50px; width:100%; display:flex; flex-direction:column; align-items:center;">
                        <div class="wrapped-big-text" style="font-size:80px; margin-bottom:0; line-height:1;">${absActions}</div>
                        <div class="wrapped-sub-text" style="font-weight:700; margin-bottom:10px;">${t('act')}</div>
                        
                        <!-- Сравнение (выезжает) -->
                        <div class="reveal-delayed delay-1500" style="background:rgba(0,0,0,0.3); padding:5px 15px; border-radius:20px; font-size:15px; font-weight:600; border:1px solid rgba(255,255,255,0.1);">
                            ${htmlActTrend}
                        </div>
                    </div>

                    <!-- Блок 2: Время -->
                    <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:40px; width:80%; display:flex; flex-direction:column; align-items:center;">
                        <div class="wrapped-big-text" style="font-size:80px; margin-bottom:0; line-height:1;">${absTimeMin}<span style="font-size:30px">m</span></div>
                        <div class="wrapped-sub-text" style="font-weight:700; margin-bottom:10px;">${t('watch')}</div>
                        
                        <!-- Сравнение (выезжает) -->
                        <div class="reveal-delayed delay-1500" style="background:rgba(0,0,0,0.3); padding:5px 15px; border-radius:20px; font-size:15px; font-weight:600; border:1px solid rgba(255,255,255,0.1);">
                            ${htmlTimeTrend}
                        </div>
                    </div>
                </div>
            `);
        }

        // --- СЛАЙД 3: ЭВОЛЮЦИЯ ---
        let hasEvolutionSlide = false;
        if (stats.prevTopTags && stats.prevTopTags.length > 0) {
            let evolutionHtml = '';
            stats.topTags.slice(0, 5).forEach((tag, i) => {
                const prevIndex = stats.prevTopTags.indexOf(tag);
                let statusBadge = '';
                if (prevIndex === -1) statusBadge = `<span style="font-size:10px; background:#2ecc71; color:#000; padding:2px 6px; border-radius:4px; margin-left:10px; font-weight:800;">${t('badge_new')}</span>`;
                else if (prevIndex > i) statusBadge = `<span style="font-size:10px; background:#f1c40f; color:#000; padding:2px 6px; border-radius:4px; margin-left:10px; font-weight:800;">${t('badge_up')}</span>`;
                else if (prevIndex < i) statusBadge = `<span style="font-size:10px; background:rgba(255,255,255,0.2); color:#fff; padding:2px 6px; border-radius:4px; margin-left:10px; font-weight:800;">${t('badge_down')}</span>`;

                let displayTag = tag.toUpperCase();
                const modMatch = modifiersData.find(m => m.key.toLowerCase() === tag.toLowerCase());
                if (modMatch && modMatch[langKey]) displayTag = modMatch[langKey].toUpperCase();

                evolutionHtml += `<div style="display:flex; align-items:center; justify-content:center; margin-bottom:15px;"><span style="font-size:24px; font-weight:800;">${i+1}. ${displayTag}</span>${statusBadge}</div>`;
            });

            slides.push(`
                <div class="wrapped-slide" style="background:linear-gradient(45deg, #1cb5e0 0%, #000851 100%);">
                    <div class="wrapped-sub-text" style="text-transform:uppercase; margin-bottom:10px;">${t('evol')}</div>
                    <div class="wrapped-sub-text" style="font-size:12px; opacity:0.6; margin-bottom:30px;">${t('evol_sub')}</div>
                    <div>${evolutionHtml}</div>
                </div>
            `);
            hasEvolutionSlide = true;
        }

        // === СЛАЙД 4: ПСИХОЛОГИЧЕСКИЙ ПОРТРЕТ (ДИАГРАММА) ===
        const prevPsycho = stats.prevPsychoCounts || {}; 
        const radarSVG = createRadarChartSVG(stats.psychoCounts, prevPsycho);

        slides.push(`
            <div class="wrapped-slide" style="background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); justify-content: flex-start; padding-top: 60px;">
                <div class="wrapped-sub-text" style="text-transform:uppercase; margin-bottom:30px; font-weight:800; letter-spacing:1px;">${t('radar_title')}</div>
                
                <!-- График -->
                <div style="width:340px; height:340px; margin-bottom:30px; position:relative; flex-shrink:0;">
                    ${radarSVG}
                </div>

                <!-- Легенда (Сразу видно) -->
                <div style="display:flex; gap:20px; font-size:12px; font-weight:600; margin-bottom:30px;">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:10px; height:10px; background:var(--accent); border-radius:50%;"></div>
                        <span style="color:var(--text-main)">${t('radar_curr')}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:10px; height:10px; background:rgba(255,255,255,0.3); border:1px dashed #fff; border-radius:50%;"></div>
                        <span style="color:var(--text-secondary)">${t('radar_prev')}</span>
                    </div>
                </div>

                <!-- ПСИХОТИП С ИНТРИГОЙ (Появляется через 3 секунды) -->
                <div class="reveal-delayed delay-3000" style="text-align:center; width:90%; background:rgba(255,255,255,0.05); padding:20px; border-radius:20px; border:1px solid var(--accent); box-shadow: 0 0 30px rgba(255,0,204, 0.2);">
                    <div style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; margin-bottom:5px;">${t('sum_psycho')}</div>
                    <div style="font-size:28px; font-weight:900; color:#fff; margin-bottom:5px; line-height:1.1; text-shadow: 0 0 10px var(--accent); text-transform:uppercase;">
                        ${psychoName}
                    </div>
                    <div style="font-size:13px; font-style:italic; opacity:0.8;">
                        "${psychoDesc}"
                    </div>
                </div>
            </div>
        `);

        // --- СЛАЙД 5: ОДЕРЖИМОСТИ (Если эволюции не было) ---
        if (!hasEvolutionSlide) {
            const translatedTagsHtml = stats.topTags.slice(0, 5).map((t, i) => {
                let displayTag = t.toUpperCase();
                const modMatch = modifiersData.find(m => m.key.toLowerCase() === t.toLowerCase());
                if (modMatch && modMatch[langKey]) displayTag = modMatch[langKey].toUpperCase();
                return `<div style="font-size:${36 - i*4}px; font-weight:800; margin:10px 0; color:${i===0?'var(--accent)':'#fff'}; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">#${i+1} ${displayTag}</div>`;
            }).join('');

            slides.push(`
                <div class="wrapped-slide" style="background:#111;">
                    <div class="wrapped-sub-text" style="margin-bottom:40px; color:var(--text-secondary);">${t('obsess')}</div>
                    ${translatedTagsHtml}
                </div>
            `);
        }

        // === СЛАЙД 6: ФИНАЛ (ОБНОВЛЕННЫЙ) ===
        const planColor = subscriptionLevel === 'free' ? '#fff' : '#9b59b6';
        
        // Определяем Топ Жанр
        let topGenre = stats.topTags[0] ? stats.topTags[0].toUpperCase() : '---';
        const genreMatch = modifiersData.find(m => m.key.toLowerCase() === topGenre.toLowerCase());
        if (genreMatch && genreMatch[langKey]) topGenre = genreMatch[langKey].toUpperCase();

        // Логотип
        const currentThemeId = localStorage.getItem('xch_theme_id') || 'dark';
        const logoSrc = getThemeLogoSrc(currentThemeId);

        slides.push(`
            <div class="wrapped-slide bg-dark">
                <div class="sum-card-new" id="wrapped-summary-card">
                    
                    <div class="sum-header">
                        <div class="sum-header-left">
                            <div class="sum-logo-row">
                                <img src="${logoSrc}" class="sum-logo-img">
                                <div class="sum-logo-text">x<span class="grad">Fetish</span>Hub</div>
                            </div>
                            <div class="sum-caption">${t('caption')}</div>
                        </div>
                        <div class="sum-qr-box">
                            <img src="${qrUrl}" class="sum-qr-img">
                        </div>
                    </div>

                    <div class="sum-meta-row">
                        <span>${dataObj.rangeStr}</span>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span class="w-badge ${type}" style="font-size:9px;">${badgeText}</span>
                            <span style="color:${planColor}; font-weight:700;">${subscriptionLevel.toUpperCase()}</span>
                        </div>
                    </div>

                    <div class="sum-grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- Ряд 1: Видео и Время -->
                        <div class="sum-stat-box">
                            <div class="sum-stat-val">${stats.watchCount}</div>
                            <div class="sum-stat-lbl">${t('sum_watch')}</div>
                        </div>
                        <div class="sum-stat-box">
                            <div class="sum-stat-val">${Math.round(stats.totalWatchTime/60)}m</div>
                            <div class="sum-stat-lbl">${t('sum_time')}</div>
                        </div>

                        <!-- Ряд 2: ПСИХОТИП (На всю ширину, заменяет лайки/дизлайки) -->
                        <div class="sum-stat-box" style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid var(--accent); padding: 15px 10px;">
                            <div class="sum-stat-lbl" style="color:var(--accent); font-weight:800; letter-spacing:1px; margin-bottom:5px;">${t('sum_psycho')}</div>
                            <div style="font-size:22px; font-weight:900; color:#fff; text-transform:uppercase; line-height:1.1;">
                                ${psychoName}
                            </div>
                            <div style="font-size:10px; color:rgba(255,255,255,0.6); margin-top:5px; font-style:italic;">
                                "${psychoDesc}"
                            </div>
                        </div>
                    </div>

                    <div style="text-align:center; margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                        <div class="sum-stat-lbl" style="margin-bottom:5px;">${t('top_genre')}</div>
                        <div style="font-size:24px; font-weight:900; color:var(--accent); letter-spacing:1px;">
                            ${topGenre}
                        </div>
                    </div>
                </div>

                <!-- Кнопки под карточкой -->
                <div style="margin-top:30px; display:flex; gap:15px; align-items:center; z-index: 1000;">
                    <button onclick="closeWrapped()" class="btn-gen" style="width:auto; padding:12px 40px; font-size:16px; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); backdrop-filter:blur(10px);">
                        ${t('btn_done')}
                    </button>
                    <div class="btn-round-share" onclick="shareWrappedCard()">
                        <img src="share.png" alt="Share">
                    </div>
                </div>
            </div>
        `);

        // Рендер прогресс-баров
        let barsHtml = '';
        slides.forEach((_, i) => barsHtml += `<div class="wrapped-progress-bar"><div class="wrapped-progress-fill" id="bar-${i}"></div></div>`);
        
        overlay.innerHTML = `
            <div class="wrapped-progress-container">${barsHtml}</div>
            <div class="wrapped-close" onclick="closeWrapped()">✕</div>
            <div class="wrapped-nav-area nav-left" onclick="prevSlide()"></div>
            <div class="wrapped-nav-area nav-right" onclick="nextSlide()"></div>
            ${slides.join('')}
        `;
        
        // Логика переключения
        if (dataObj.viewed) {
            currentSlideIndex = slides.length - 1;
            // Если уже смотрели, сразу закрашиваем все бары
            setTimeout(() => { 
                for (let i = 0; i < slides.length; i++) { 
                    const bar = document.getElementById('bar-' + i); 
                    if(bar) { bar.style.width = '100%'; bar.style.transition = 'none'; }
                } 
            }, 50);
        } else {
            currentSlideIndex = 0;
        }
        
        startSlideTimerNew(slides.length, 6000); 
        
        // Обработчики событий (пауза и клики)
        const isInteractive = (e) => {
            return e.target.closest('button') || 
                e.target.closest('.wrapped-close') || 
                e.target.closest('.btn-round-share') ||
                e.target.closest('.wrapped-nav-area');
        };

        const handlePause = (e) => { 
            if (isInteractive(e)) return;
            if(e.cancelable) e.preventDefault(); 
            overlay.classList.add('paused'); 
            window.isWrappedPaused = true; 
        };

        const handleResume = (e) => { 
            if (isInteractive(e)) return;
            if(e.cancelable) e.preventDefault(); 
            overlay.classList.remove('paused'); 
            window.isWrappedPaused = false; 
        };

        overlay.addEventListener('mousedown', handlePause);
        overlay.addEventListener('touchstart', handlePause, {passive: false});
        overlay.addEventListener('mouseup', handleResume);
        overlay.addEventListener('touchend', handleResume, {passive: false});
        overlay.addEventListener('mouseleave', handleResume);

        dataObj.viewed = true;
        localStorage.setItem('xch_wrapped_archive', JSON.stringify(wrappedArchive));
        openStatistics(); 
        overlay.classList.add('active');
    }

    // ТАЙМЕР (С поддержкой паузы)
    function startSlideTimerNew(total, duration = 6000) {
        clearInterval(slideInterval);
        
        const show = (idx) => {
            // Переключаем слайды
            document.querySelectorAll('.wrapped-slide').forEach(el => el.classList.remove('active-slide'));
            document.querySelectorAll('.wrapped-slide')[idx].classList.add('active-slide');
            
            // Обновляем прогресс-бары
            for(let i=0; i<total; i++) {
                const bar = document.getElementById('bar-'+i);
                if (!bar) continue;

                // СБРОС ВСЕХ АНИМАЦИЙ И ПЕРЕХОДОВ
                bar.classList.remove('animating');
                bar.style.transition = 'none'; // Важно! Убираем плавность для мгновенного переключения состояний
                bar.style.animationDuration = '0ms';

                if (i < idx) { 
                    // ПРОШЛЫЕ СЛАЙДЫ: Полностью закрашены
                    bar.style.width = '100%'; 
                }
                else if (i > idx) { 
                    // БУДУЩИЕ СЛАЙДЫ: Пустые
                    bar.style.width = '0%'; 
                }
                else {
                    // ТЕКУЩИЙ СЛАЙД: Сначала 0, потом анимация
                    bar.style.width = '0%';
                    
                    // Трюк с reflow для перезапуска CSS-анимации
                    void bar.offsetWidth; 
                    
                    bar.style.animationDuration = `${duration}ms`;
                    bar.classList.add('animating'); // CSS класс сделает остальное
                }
            }
        };

        // Показываем текущий слайд сразу
        show(currentSlideIndex);

        // Таймер
        let elapsed = 0;
        const step = 100;
        window.isWrappedPaused = false;

        slideInterval = setInterval(() => {
            if (currentSlideIndex >= total - 1) {
                clearInterval(slideInterval);
                return;
            }

            if (!window.isWrappedPaused) {
                elapsed += step;
                if (elapsed >= duration) {
                    elapsed = 0;
                    currentSlideIndex++;
                    if (currentSlideIndex < total) {
                        show(currentSlideIndex);
                    } else {
                        clearInterval(slideInterval);
                    }
                }
            }
        }, step);
    }

    // 7. Рендер списка в Истории (Archive Tab)
    function renderWrappedArchive() {
        const list = document.getElementById('hist-list-wrapped');
        list.innerHTML = '';
        
        // Сортировка: новые сверху
        const items = wrappedArchive.sort((a,b) => b.timestamp - a.timestamp);
        const isPaid = subscriptionLevel !== 'free';

        if (items.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.5;">Archive empty</div>`;
            return;
        }

        items.forEach(w => {
            // Скрываем Daily от бесплатных пользователей в архиве
            if (w.type === 'daily' && !isPaid) return;

            const dateObj = new Date(w.timestamp);
            const dateStr = dateObj.toLocaleDateString();
            
            const lang = WRAPPED_CONFIG.badges[currentLang] ? currentLang : 'en';
            const badgeLabel = WRAPPED_CONFIG.badges[lang][w.type];
            
            const div = document.createElement('div');
            div.className = 'wrapped-archive-item';
            div.onclick = () => {
                closeHistoryModal(null, true); // Закрываем модалку истории
                openWrappedUI(w); // Открываем Wrapped
            };
            
            // Точка если не прочитано
            const dot = !w.viewed ? `<span style="color:var(--accent); font-size:20px; margin-right:8px;">●</span>` : ``;

            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    ${dot}
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:700; color:var(--text-main); font-size:15px;">${dateStr}</span>
                        <span style="font-size:11px; color:var(--text-secondary); margin-top:2px;">${w.type === 'daily' ? 'Snapshot' : w.rangeStr}</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span class="w-badge ${w.type}">${badgeLabel}</span>
                    <span style="color:var(--text-secondary); margin-left:10px;">›</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // Генератор QR URL
    function getQrUrl(url) {
        return `https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=5&data=${encodeURIComponent(url)}`;
    }

    // Создание HTML хедера (лого + подпись + QR)
    function createScreenshotHeader() {
        const t = langData[currentLang] || langData['en'];
        const caption = t.share_caption || "Discover yourself";
        const qrUrl = getQrUrl(window.location.origin); // Ссылка на главную

        const header = document.createElement('div');
        header.className = 'screenshot-header';
        header.innerHTML = `
            <div class="screenshot-logo-area">
                <div class="screenshot-logo">x<span>Fetish</span>Hub</div>
                <div class="screenshot-caption">${caption}</div>
            </div>
            <div class="screenshot-qr">
                <img src="${qrUrl}" style="width:100%; height:100%; display:block;">
            </div>
        `;
        return header;
    }

    function shareWrappedCard() {
        // 1. Находим исходную карточку
        const originalCard = document.getElementById('wrapped-summary-card');
        if (!originalCard) return;

        if (navigator.vibrate) navigator.vibrate(50);

        // 2. Создаем контейнер-клон (вне экрана)
        // Используем id или класс, который мы прописали в CSS выше
        const exportContainer = document.createElement('div');
        exportContainer.className = 'export-clone-container';
        
        // 3. Клонируем карточку
        const cloneCard = originalCard.cloneNode(true);
        
        // Находим спан с классом .grad внутри клона
        const gradSpan = cloneCard.querySelector('.sum-logo-text span.grad');
        if (gradSpan) {
            // Принудительно ставим сплошной цвет
            gradSpan.style.background = 'none';
            gradSpan.style.webkitTextFillColor = 'var(--accent)'; 
            gradSpan.style.color = 'var(--accent)';
            // Убираем любые маски
            gradSpan.style.webkitBackgroundClip = 'border-box';
            gradSpan.style.backgroundClip = 'border-box';
        }

        // Добавляем клон в контейнер, а контейнер в body
        exportContainer.appendChild(cloneCard);
        document.body.appendChild(exportContainer);

        // 4. Генерируем скриншот с клона
        html2canvas(exportContainer, {
            backgroundColor: null, // Прозрачный фон (или цвет из CSS контейнера)
            scale: 2, // Высокое качество
            useCORS: true,
            allowTaint: true,
            logging: false
        }).then(canvas => {
            // 5. Убираем клон
            document.body.removeChild(exportContainer);

            // 6. Скачивание
            const link = document.createElement('a');
            link.download = `fetish-wrapped-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(e => {
            console.error("Screenshot error:", e);
            if (document.body.contains(exportContainer)) document.body.removeChild(exportContainer);
            alert("Error creating image");
        });
    }

    // Закрытие всех модалок по ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            
            // 1. ЕСЛИ АКТИВЕН ПРЕДПРОСМОТР ТЕМЫ -> ОТМЕНЯЕМ ЕГО
            if (typeof isPreviewActive !== 'undefined' && isPreviewActive) {
                cancelPreview();
                return; // Прерываем, чтобы не закрыть открывшуюся модалку тем
            }

            // 2. Иначе закрываем модалки (стандартное поведение)
            const openModals = document.querySelectorAll('.modal-overlay.open');
            openModals.forEach(modal => {
                modal.classList.remove('open');
            });
        }
    });

   // =========================================
    // PANIC MODE (EMERGENCY SWITCH)
    // =========================================

    let isPanicMode = false;
    let lastTapTime = 0;
    let lastEscTime = 0;

    // Инициализация тумблера при загрузке
    document.addEventListener("DOMContentLoaded", () => {
        const toggle = document.getElementById('panic-toggle-input');
        if (toggle) toggle.checked = isPanicEnabled;
    });

    // Хранилище состояний (чтобы вернуть всё как было)
    let savedSettingsState = {
        platformHTML: '', platformVal: '', 
        oriHTML: '', oriVal: '', 
        decoSrc: '', oriIconSrc: '', 
        themeId: ''
    };

    // Задания для безопасного режима
    const SAFE_TASKS = [
        { en: { name: "Wash Dishes", desc: "The sink is full. It's time to be a hero and clean those plates.", tags: ["Cleaning", "Kitchen", "Water"] }, ru: { name: "Помыть посуду", desc: "Раковина полна. Пришло время стать героем и отмыть эти тарелки.", tags: ["Уборка", "Кухня", "Вода"] }, es: { name: "Lavar los platos", desc: "El fregadero está lleno.", tags: ["Limpieza", "Cocina"] }, de: { name: "Geschirr spülen", desc: "Die Spüle ist voll.", tags: ["Reinigung", "Küche"] } },
        { en: { name: "Pet the Cat", desc: "Find a cat. Pet the cat. Listen to the purr. Relax.", tags: ["Animals", "Relax", "Soft"] }, ru: { name: "Погладить кота", desc: "Найди кота. Погладь кота. Слушай мурчание. Расслабься.", tags: ["Животные", "Релакс", "Мягко"] }, es: { name: "Acariciar al gato", desc: "Encuentra un gato.", tags: ["Animales", "Relax"] }, de: { name: "Katze streicheln", desc: "Finde eine Katze.", tags: ["Tiere", "Entspannung"] } },
        { en: { name: "Drink Water", desc: "Stay hydrated. Your body needs H2O to function properly.", tags: ["Health", "Liquid", "Life"] }, ru: { name: "Выпить воды", desc: "Поддерживай водный баланс. Твоему телу нужен H2O.", tags: ["Здоровье", "Жидкость", "Жизнь"] }, es: { name: "Beber agua", desc: "Mantente hidratado.", tags: ["Salud", "Vida"] }, de: { name: "Wasser trinken", desc: "Bleib hydriert.", tags: ["Gesundheit", "Leben"] } },
        { en: { name: "Read a Book", desc: "Expand your mind. Pick up that book you bought 3 years ago.", tags: ["Education", "Quiet", "Paper"] }, ru: { name: "Почитать книгу", desc: "Развивай разум. Возьми ту книгу, которую купил 3 года назад.", tags: ["Обучение", "Тишина", "Бумага"] }, es: { name: "Leer un libro", desc: "Expande tu mente.", tags: ["Educación", "Silencio"] }, de: { name: "Buch lesen", desc: "Erweitere deinen Geist.", tags: ["Bildung", "Ruhe"] } },
        { en: { name: "Go for a Walk", desc: "Touch some grass. Breathing fresh air is highly recommended.", tags: ["Outdoor", "Sport", "Nature"] }, ru: { name: "Сходить погулять", desc: "Потрогай траву. Свежий воздух крайне рекомендован.", tags: ["Улица", "Спорт", "Природа"] }, es: { name: "Ir a caminar", desc: "Toca el pasto.", tags: ["Exterior", "Deporte"] }, de: { name: "Spazieren gehen", desc: "Berühre Gras.", tags: ["Draußen", "Sport"] } }
    ];

    // --- ФУНКЦИИ УПРАВЛЕНИЯ НАСТРОЙКАМИ ---

    function openPanicSettings() {
        const modal = document.getElementById('modal-panic-settings');
        const body = modal.querySelector('.modal-body');
        const t = langData[currentLang] || langData['en'];
        const isPC = window.innerWidth > 768;

        // Очищаем старое содержимое
        body.innerHTML = '';

        // --- ОБЩАЯ КАРТИНКА ---
        const iconHtml = `
            <div style="text-align:center; margin-bottom:15px;">
                <img src="sos.png" style="width:60px; height:60px; filter: invert(1);">
            </div>
        `;

        // --- ЛОГИКА ДЛЯ МОБИЛЬНЫХ ---
        if (!isPC) {
            const descMobile = currentLang === 'ru' 
                ? "Быстрый вход/выход: <b>Двойной тап</b> по экрану.<br>Выход также возможен кнопкой <b>Начать</b>."
                : "Quick toggle: <b>Double Tap</b> anywhere.<br>Exit also via <b>Start</b> button.";

            body.innerHTML = `
                ${iconHtml}
                <div class="panic-note">${descMobile}</div>
                
                <div class="ios-group">
                    <div class="ios-row">
                        <div class="ios-row-left">
                            <span>${t.panic_enable}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" ${isPanicEnabled ? 'checked' : ''} onchange="togglePanicSetting(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            `;
        } 
        
        // --- ЛОГИКА ДЛЯ ПК ---
        else {
            const keyName = panicKey === ' ' ? 'Space' : panicKey.toUpperCase();
            const descPC = currentLang === 'ru' 
                ? `Вход/Выход: Нажатие клавиши <b>${keyName}</b>.<br>Выход также кнопкой <b>Начать</b>.`
                : `Toggle: Press <b>${keyName}</b>.<br>Exit also via <b>Start</b> button.`;

            const lblBinding = currentLang === 'ru' ? "Назначить клавишу" : "Key Binding";
            const lblTap = currentLang === 'ru' ? "Нажми, чтобы изменить" : "Click to change";
            const lblDouble = currentLang === 'ru' ? "Двойное нажатие" : "Double Press";

            body.innerHTML = `
                ${iconHtml}
                <div class="panic-note" id="panic-pc-desc">${descPC}</div>

                <div class="ios-group" style="margin-bottom: 20px;">
                    <div class="ios-row">
                        <div class="ios-row-left">
                            <span>${t.panic_enable}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" ${isPanicEnabled ? 'checked' : ''} onchange="togglePanicSetting(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Зона настройки клавиш -->
                <div style="padding: 0 5px;">
                    <div style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:8px; text-transform:uppercase;">
                        ${lblBinding}
                    </div>
                    
                    <div class="panic-key-box" id="panic-key-box" onclick="startKeyRecording()">
                        <div class="panic-key-label" id="panic-key-label">${lblTap}</div>
                        <div class="panic-key-value" id="panic-key-display">${keyName}</div>
                    </div>

                    <div class="ios-group">
                        <div class="ios-row">
                            <div class="ios-row-left">
                                <span>${lblDouble}</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" ${panicDouble ? 'checked' : ''} onchange="togglePanicDouble(this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        modal.classList.add('open');
    }

    function closePanicSettings(e, force) {
        if (force || e.target.id === 'modal-panic-settings') {
            document.getElementById('modal-panic-settings').classList.remove('open');
        }
    }

    function togglePanicSetting(isChecked) {
        isPanicEnabled = isChecked;
        localStorage.setItem('xch_panic_enabled', isChecked);
    }

    // --- ЛОГИКА ПЕРЕКЛЮЧЕНИЯ ---

    function togglePanicMode() {
        if (!isPanicEnabled && !isPanicMode) return;

        if (!isPanicMode) {
            savedSettingsState.themeId = localStorage.getItem('xch_theme_id') || 'dark';
        }

        isPanicMode = !isPanicMode;
        
        const t = langData[currentLang] || langData['en'];
        const langKey = ['en', 'ru', 'es', 'de'].includes(currentLang) ? currentLang : 'en';
        
        const logoTextDivs = document.querySelectorAll('.logo');
        const decoIcons = document.querySelectorAll('.deco-icon');
        const subtitles = document.querySelectorAll('.subtitle');
        const startBtnContainer = document.getElementById('start-btn-container');
        const relatedBlock = document.getElementById('related-block');
        const relatedTitle = relatedBlock ? relatedBlock.querySelector('.related-title') : null;

        const unsafeElements = [
            document.getElementById('badge-wrapper'),
            document.getElementById('mods-block'),
            document.getElementById('mode-start-overlay'),
            document.querySelector('.card-notch')
        ];

        if (isPanicMode) {
            // === 🚨 ВКЛЮЧЕНИЕ ПАНИКИ ===
            console.log("⚠️ PANIC MODE ACTIVATED");

            const isLight = document.body.classList.contains('light-theme');
            applyTheme(isLight ? 'green-light' : 'green-dark');

            decoIcons.forEach(el => el.style.display = 'none');

            logoTextDivs.forEach(div => {
                div.innerHTML = `<img src="funny_icon.png" class="logo-img" alt="F" style="height:45px; margin-right:5px;">FunnyHub`;
            });

            subtitles.forEach(el => el.innerText = t.safe_subtitle);

            unsafeElements.forEach(el => {
                if(el) { el.classList.add('panic-hidden'); el.style.setProperty('display', 'none', 'important'); }
            });

            const controls = document.getElementById('tinder-controls');
            if(controls) {
                controls.classList.remove('hidden-initial');
                controls.style.display = 'flex';
            }

            if (startBtnContainer) {
                startBtnContainer.classList.remove('hidden-initial');
                startBtnContainer.style.display = 'flex';
                startBtnContainer.innerHTML = `
                    <button class="btn-start-capsule" onclick="startGeneration('random')" style="background: linear-gradient(to right, #2ecc71, #27ae60); box-shadow: 0 10px 40px -5px #2ecc71;">
                        <span style="font-size:20px; margin-right:8px;">🥗</span> ${t.safe_btn_start}
                    </button>`;
            }

            if (relatedTitle) {
                relatedTitle.innerText = (langKey === 'ru') ? "Похожие хобби:" : "Similar hobbies:";
            }

            if (!currentItem || !currentItem.isPanicItem) {
                generatePanicCard();
            }

        } else {
            // === ✅ ВЫКЛЮЧЕНИЕ ПАНИКИ (ВОЗВРАТ) ===
            console.log("✅ PANIC MODE DEACTIVATED");

            // 1. ВОЗВРАТ ТЕМЫ
            // Берем сохраненный ID темы
            const themeToRestore = savedSettingsState.themeId || 'dark';
            
            // Применяем тему
            applyTheme(themeToRestore);
            
            // Если пользователь бесплатный, а тема почему-то восстановилась премиумная, сбрасываем
            const restoredThemeObj = APP_THEMES.find(th => th.id === themeToRestore);
            if (subscriptionLevel === 'free' && restoredThemeObj && restoredThemeObj.type === 'pro') {
                applyTheme('dark');
            }

            // Возвращаем декорации
            decoIcons.forEach(el => el.style.display = '');

            const iconSrc = getThemeLogoSrc(themeToRestore);

            // И вставляем эту картинку в HTML
            logoTextDivs.forEach(div => {
                div.innerHTML = `<img src="${iconSrc}" alt="X" class="logo-img">x<span>Fetish</span>Hub`;
            });

            subtitles.forEach(el => el.innerText = t.subtitle);

            if (startBtnContainer) {
                if (sessionHistoryStack.length > 0) {
                    startBtnContainer.style.display = 'none';
                } else {
                    startBtnContainer.innerHTML = `<button class="btn-start-capsule" onclick="startNewSession()">🔥 <span data-key="btn_start">${t.btn_start}</span></button>`;
                }
            }

            unsafeElements.forEach(el => { 
                if(el) { el.classList.remove('panic-hidden'); el.style.display = ''; } 
            });

            if (relatedTitle) relatedTitle.innerText = t.related_header;

            const phrases = t.post_panic_phrases || ["That was close..."];
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            
            resetToHome();
            setTimeout(() => {
                const statusEl = document.getElementById('status-text');
                if(statusEl) {
                    statusEl.innerText = randomPhrase;
                    statusEl.style.color = "var(--text-secondary)";
                    statusEl.style.opacity = "1";
                }
            }, 400);
        }
    }

    function generatePanicCard(direction = 'next') {
        const langKey = ['en', 'ru', 'es', 'de'].includes(currentLang) ? currentLang : 'en';
        
        // Берем случайное задание
        const task = SAFE_TASKS[Math.floor(Math.random() * SAFE_TASKS.length)][langKey];
        
        // Создаем фейковый объект Item
        const fakeItem = {
            id: 'safe_' + Date.now(),
            name: task.name,
            name_ru: task.name, 
            name_es: task.name,
            name_de: task.name,
            
            // Описание
            desc_en: task.desc,
            desc_ru: task.desc,
            desc_es: task.desc,
            desc_de: task.desc,
            
            tags: task.tags || [],
            isPanicItem: true // Флаг, чтобы отличать
        };

        // Запускаем стандартную анимацию смены карточки
        isGenerating = true;
        
        // Скрываем кнопку старта, если это первый клик
        const startBtn = document.getElementById('start-btn-container');
        if(startBtn) startBtn.style.display = 'none';

        // Анимация вылета старой
        const wrapper = document.getElementById('card-anim-wrapper');
        if(wrapper) wrapper.style.opacity = '0';

        setTimeout(() => {
            // Вызываем финиш, но в режиме "panic"
            finishGeneration(fakeItem, 'panic');
            
            if(wrapper) {
                wrapper.style.transform = '';
                void wrapper.offsetWidth; 
                wrapper.style.opacity = '1';
                
                // Анимация влета
                const animClass = (direction === 'dislike' || direction === 'entry-right') ? 'anim-fly-right' : 'anim-fly-left';
                wrapper.classList.add(animClass);
                
                setTimeout(() => {
                    wrapper.classList.remove('anim-fly-right', 'anim-fly-left');
                }, 800);
            }
        }, 300); // Короткая задержка для смены
    }

    // Сохранение режима двойного нажатия
    function togglePanicDouble(isChecked) {
        panicDouble = isChecked;
        localStorage.setItem('xch_panic_is_double', isChecked);
    }

    // Старт записи клавиши
    function startKeyRecording() {
        const box = document.getElementById('panic-key-box');
        const label = document.getElementById('panic-key-label');
        const display = document.getElementById('panic-key-display');
        
        isRecordingKey = true;
        box.classList.add('recording');
        
        const txtWaiting = currentLang === 'ru' ? "Нажми любую клавишу..." : "Press any key...";
        label.innerText = txtWaiting;
        display.style.opacity = '0.5';
    }

    // Сохранение клавиши
    function savePanicKey(code) {
        // Запрещенные клавиши (чтобы не сломать навигацию)
        if (code === 'Enter') return; 

        panicKey = code;
        localStorage.setItem('xch_panic_key', code);
        isRecordingKey = false;

        // Обновляем UI
        const box = document.getElementById('panic-key-box');
        const label = document.getElementById('panic-key-label');
        const display = document.getElementById('panic-key-display');
        const desc = document.getElementById('panic-pc-desc');

        if(box) {
            box.classList.remove('recording');
            label.innerText = currentLang === 'ru' ? "Нажми, чтобы изменить" : "Click to change";
            
            const displayCode = code === ' ' ? 'Space' : code.replace('Key', '').replace('Digit', '').toUpperCase();
            display.innerText = displayCode;
            display.style.opacity = '1';

            // Обновляем текст описания сверху
            if(desc) {
                desc.innerHTML = currentLang === 'ru' 
                ? `Вход/Выход: Нажатие клавиши <b>${displayCode}</b>.<br>Выход также кнопкой <b>Начать</b>.`
                : `Toggle: Press <b>${displayCode}</b>.<br>Exit also via <b>Start</b> button.`;
            }
        }
    }

    // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

    // A. Клавиатура (Двойной ESC)
    document.addEventListener('keydown', (e) => {
        
        // 1. Если идет запись клавиши в настройках
        if (isRecordingKey) {
            e.preventDefault();
            e.stopPropagation();
            let code = e.code;
            savePanicKey(code);
            return;
        }

        // 2. Закрытие модалок по ESC (стандартное поведение)
        if (e.code === 'Escape') {
            const openModals = document.querySelectorAll('.modal-overlay.open');
            if (openModals.length > 0) {
                openModals.forEach(modal => modal.classList.remove('open'));
                return; // Если закрыли окно, панику не трогаем (если только ESC не назначен на панику)
            }
        }

        // 3. Игнорируем ввод текста
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // 4. ПРОВЕРКА КЛАВИШИ ПАНИКИ
        // Сравниваем e.code с сохраненным panicKey
        if (e.code === panicKey) {
            
            // Если включен режим двойного нажатия
            if (panicDouble) {
                const now = new Date().getTime();
                if (now - lastEscTime < 400) {
                    e.preventDefault(); 
                    togglePanicMode();
                    lastEscTime = 0; 
                } else {
                    lastEscTime = now;
                }
            } 
            // Если одиночное нажатие
            else {
                e.preventDefault();
                togglePanicMode();
            }
        }
    });

    // B. Двойной Тап по карточке (для мобильных)
    document.addEventListener('touchend', (e) => {
        const now = new Date().getTime();
        const timeDiff = now - lastTapTime;

        // 1. Находим саму карточку
        const card = document.getElementById('card-block');

        // 2. ПРОВЕРКА: Если клик НЕ внутри карточки -> выходим
        if (!card || !card.contains(e.target)) {
            // Если тапнули мимо карточки, просто обновляем время (чтобы не сработало, 
            // если первый тап был по карте, а второй мимо)
            lastTapTime = 0; 
            return;
        }

        // 3. Игнорируем интерактивные элементы ВНУТРИ карточки
        if (e.target.closest('button') || 
            e.target.closest('.t-circle-btn') || 
            e.target.closest('.related-item-btn') ||
            e.target.closest('.btn-start-capsule') ||
            e.target.closest('.mode-circle-btn')) {
            lastTapTime = 0;
            return;
        }

        // 4. Логика активации (Двойной тап < 400мс)
        if (timeDiff < 400 && timeDiff > 0) {
            e.preventDefault(); // Предотвращаем зум или выделение
            togglePanicMode();
            lastTapTime = 0; // Сброс
        } else {
            lastTapTime = now;
        }
    });

    function openTipsModal() {
        renderTipsList();
        // Показываем список, скрываем детали
        document.getElementById('tips-view-list').style.display = 'block';
        document.getElementById('tips-view-detail').style.display = 'none';
        
        document.getElementById('modal-tips-overlay').classList.add('open');
    }

    function closeTipsModal(e, force) {
        if (force || e.target.id === 'modal-tips-overlay') {
            document.getElementById('modal-tips-overlay').classList.remove('open');
        }
    }

    function openSpecificTip(id) {
        // 1. Открываем саму модалку (чтобы инициализировать список)
        openTipsModal();
        
        // 2. Ищем нужный тип в базе
        const tip = tipsData.find(t => t.id === id);
        if (tip) {
            // 3. Сразу показываем детали
            showTipDetail(tip);
        }
    }

    function renderTipsList() {
        const viewList = document.getElementById('tips-view-list');
        const t = langData[currentLang] || langData['en'];
        
        // Заголовок окна
        let html = `
            <div class="tips-guru-text" data-key="tips_guru_title" style="margin-bottom:20px;">
                ${t.tips_guru_title || "Become a Guru 😈"}
            </div>
        `;

        const generateRow = (catKey, titleKey) => {
            const title = t[titleKey];
            const ids = TIPS_CATS[catKey];
            
            // Получаем объекты
            let items = ids.map(id => tipsData.find(x => x.id === id)).filter(Boolean);
            if (items.length === 0) return '';

            // 1. Сортировка: Непрочитанные -> Прочитанные
            items.sort((a, b) => {
                const aViewed = viewedTips.includes(a.id);
                const bViewed = viewedTips.includes(b.id);
                return aViewed - bViewed;
            });

            // 2. Генерация HTML (БЕЗ ДУБЛИРОВАНИЯ)
            const cardsHTML = items.map(tip => {
                const isViewed = viewedTips.includes(tip.id);
                return `
                    <div class="tip-card ${isViewed ? 'viewed' : ''}" onclick="openSpecificTip('${tip.id}')">
                        <div class="tip-card-header" style="background: ${tip.gradient};"></div>
                        <div class="tip-card-body">
                            <div class="tip-card-icon">${tip.icon}</div>
                            <div class="tip-card-title">${t[tip.titleKey]}</div>
                            <div class="tip-card-desc">${t[tip.descKey]}</div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="tips-category-title" style="text-align:left; padding-left:20px; margin-bottom:10px;">${title}</div>
                <div class="tips-scroll-row" id="scroll-row-${catKey}">
                    ${cardsHTML}
                </div>
            `;
        };

        html += generateRow('tech', 'cat_tips_tech');
        html += generateRow('info', 'cat_tips_info');

        viewList.innerHTML = html;
        
    }

    function initInfiniteRoulette(containerId) {
        return; 
    }

    function showTipDetail(tip) {
        const t = langData[currentLang] || langData['en'];
        
        if (!viewedTips.includes(tip.id)) {
            viewedTips.push(tip.id);
            localStorage.setItem('xch_viewed_tips', JSON.stringify(viewedTips));
            
            // Скрываем вопросики сразу же
            checkTipIcons();
        }
        
        document.getElementById('tip-detail-icon').innerText = tip.icon;
        document.getElementById('tip-detail-title').innerText = t[tip.titleKey];
        document.getElementById('tip-detail-content').innerHTML = t[tip.textKey];

        document.getElementById('tips-view-list').style.display = 'none';
        document.getElementById('tips-view-detail').style.display = 'block';
    }

    function backToTipsList() {
        document.getElementById('tips-view-detail').style.display = 'none';
        document.getElementById('tips-view-list').style.display = 'block';
        
        renderTipsList();
    }

    function openChangelogModal() {
        const container = document.getElementById('changelog-container');
        container.innerHTML = '';
        
        // Определяем текущий язык
        const langKey = ['en','ru','es','de'].includes(currentLang) ? currentLang : 'en';

        CHANGELOG_DATA.forEach(item => {
            // Берем текст
            const text = item.changes[langKey] || item.changes['en'];

            const div = document.createElement('div');
            div.className = 'version-card';
            
            div.innerHTML = `
                <!-- СЛЕВА: Версия -->
                <div class="v-ver-badge">v${item.ver}</div>
                
                <!-- ЦЕНТР: Текст -->
                <div class="v-content">${text}</div>
                
                <!-- СПРАВА: Дата -->
                <div class="v-date">${item.date}</div>
            `;
            container.appendChild(div);
        });

        document.getElementById('modal-changelog-overlay').classList.add('open');
    }

    function closeChangelogModal(e, force) {
        if (force || e.target.id === 'modal-changelog-overlay') {
            document.getElementById('modal-changelog-overlay').classList.remove('open');
        }
    }

    function checkTipIcons() {
        // 1. Иконка Интенсивности (существующая)
        const intIcon = document.getElementById('intensity-info-icon');
        if (intIcon) {
            intIcon.style.display = viewedTips.includes('intensity') ? 'none' : 'block';
        }

        // 2. Иконка Режимов (новая)
        const modeIcon = document.getElementById('tip-icon-modes');
        if (modeIcon) {
            modeIcon.style.display = viewedTips.includes('modes') ? 'none' : 'block';
        }
    }

    function closePromoTips() {
        document.getElementById('modal-promo-tips-overlay').classList.remove('open');
    }

    function openTipsFromPromo() {
        // 1. Закрываем окно промо
        document.getElementById('modal-promo-tips-overlay').classList.remove('open');
        
        // 2. Через мгновение открываем Базу Знаний (Tips)
        setTimeout(() => {
            openTipsModal();
        }, 250);
    }

</script>

<!-- SEO CONTEXT BLOCK -->
<div class="seo-context">
    <h2>xFetishHub: The Ultimate Adult Preference Ecosystem</h2>
    <p>
        xFetishHub is not just a randomizer; it is your personal <strong>adult preference tracker</strong> and discovery platform. 
        Unlike simple tube sites, we provide a smart environment where you can <strong>analyze your sexual tastes</strong> through detailed charts and statistics.
    </p>
    <h3>Why use xFetishHub?</h3>
    <ul>
        <li>
            <strong>Smart Discovery:</strong> Learn about new genres and fetishes you didn't know existed. Our database covers 1000+ tags from vanilla to niche.
        </li>
        <li>
            <strong>Taste Analytics:</strong> Track what you like and dislike. View your "Fetish Wrapped" and understand your own psychology better with visual graphs.
        </li>
        <li>
            <strong>Private Browser Experience:</strong> On mobile devices, xFetishHub acts as a <strong>secure browser</strong>. Watch content from xHamster, Pornhub, and xVideos directly within our app without cluttering your main browser history.
        </li>
        <li>
            <strong>Personalized Feed:</strong> The more you use it, the better it gets. Our algorithm learns from your swipes to recommend content that truly matches your interests.
        </li>
    </ul>
    <p>
        Whether you are looking for a <strong>porn history tracker</strong>, a safe way to explore new kinks, or simply a better way to browse adult content, xFetishHub is your private home for digital intimacy.
    </p>
</div>

</body>
</html>
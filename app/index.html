<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Primary Meta Tags -->
    <title>xFetishHub — Discover, Analyze & Watch. Your Private Adult Guide.</title>
    <meta name="title" content="xFetishHub — Discover, Analyze & Watch. Your Private Adult Guide.">
    
    <!-- Описание -->
    <meta name="description" content="More than a generator. Your intelligent home for adult preferences. Analyze your tastes with charts, discover 1000+ genres, and watch videos securely via the built-in private browser.">
    
    <!-- Ключевые слова -->
    <meta name="keywords" content="adult preference analyzer, porn tracker, fetish statistics, private porn browser, sex taste analysis, porn discovery, fetish encyclopedia, smart porn guide, xxx recommendation engine, porn roulette, fetishhub, safe adult browsing">
    
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="language" content="English">
    <meta name="author" content="xFetishHub">
    <meta name="rating" content="adult">
    <meta name="age-rating" content="18">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.xfetishhub.site/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.xfetishhub.site/">
    <meta property="og:title" content="xFetishHub — Your Intelligent Adult Guide">
    <meta property="og:description" content="Analyze your tastes, track history, and discover new desires in a secure, private environment.">
    <meta property="og:image" content="https://www.xfetishhub.site/og-image.jpg">
    <meta property="og:site_name" content="xFetishHub">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.xfetishhub.site/">
    <meta property="twitter:title" content="xFetishHub — Discover Your Desires">
    <meta property="twitter:description" content="The all-in-one platform for adult discovery, statistics, and private viewing.">
    <meta property="twitter:image" content="https://www.xfetishhub.site/og-image.jpg">

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo_icon.png">
    <link rel="apple-touch-icon" href="logo_icon.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FetishHub">
    <meta name="theme-color" content="#050505">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- SCHEMA.ORG: Позиционируем как ПРИЛОЖЕНИЕ (SoftwareApplication), а не просто веб-страницу -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "xFetishHub",
      "url": "https://www.xfetishhub.site/",
      "description": "An intelligent platform for tracking adult preferences, analyzing sexual statistics, and discovering new content categories securely.",
      "applicationCategory": "LifestyleApplication",
      "operatingSystem": "Web, iOS, Android",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": "Preference Analytics, Private Browser, Content Discovery, Fetish Tracker"
    }
    </script>
    
    <style>
        /* === LOADER === */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999999;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            background-color: #12000b;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        #loading-overlay.hidden {
            opacity: 0; visibility: hidden; pointer-events: none;
        }

        .loader-logo {
            width: 70px; height: 70px;
            object-fit: contain;
            margin-bottom: 25px;
            opacity: 0.9;
            animation: breathe 2.5s infinite ease-in-out;
        }

        .loader-text {
            font-size: 13px; font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-align: center;
            min-height: 20px; /* Чтобы текст не прыгал */
            margin-bottom: 15px;
            opacity: 0.7;
        }

        /* Прогресс бар */
        .loader-progress-container {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .loader-progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent, #ff00cc); /* Использует цвет темы или дефолтный розовый */
            border-radius: 4px;
            transition: width 0.2s ease-out;
            box-shadow: 0 0 10px var(--accent, #ff00cc);
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.95); opacity: 0.6; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        /* =========================================
        1. VARIABLES & RESET & THEMES
        ========================================= */
        :root {
            --bg-color: #12000b;
            --sidebar-bg: #1a0010;
            --card-bg: #2b001b;
            --nav-bg: #2b001b;
            
            --text-main: #ffffff;
            --text-secondary: #888888;
            
            /* PINK ACCENTS ONLY */
            --accent: #ff00cc; 
            --accent-light: #ff66e0;
            
            --border: #4d0030;
            --highlight-green: #2ecc71;
            --highlight-red: #e74c3c;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --modal-bg: rgba(18, 0, 11, 0.95);
            
            /* iOS Style Colors */
            --ios-bg: #12000b;
            --ios-card: #2b001b;
            --ios-separator: #4d0030;
            --ios-header: #8E8E93; 

            --card-gradient: linear-gradient(165deg, #2b001b 0%, #1a0010 100%);
        }

        body.light-theme {
            --bg-color: #ffeef8;
            --sidebar-bg: #fff5fb; 
            --card-bg: #ffffff;
            --nav-bg: #ffffff;
            
            --text-main: #000000;
            --text-secondary: #666666; 
            
            --border: #fbcfe8;
            --modal-bg: rgba(255, 255, 255, 0.95);
            
            --accent: #db2777;
            --accent-light: #f472b6;

            --ios-bg: #ffeef8;
            --ios-card: #ffffff;
            --ios-separator: #e5e7eb;
            --ios-header: #6D6D72; 

            --card-gradient: linear-gradient(165deg, #ffffff 0%, #ffeef8 100%);
        }

        body[data-theme="noir"] {
            --accent: #ffffff;
            --accent-light: #cccccc;
            --accent-alt: #888888; 
            
            --highlight-green: #bbbbbb; /* Светло-серый вместо зеленого */
            --highlight-red: #444444;   /* Темно-серый вместо красного */
            --ios-separator: #333333;
            --border: #333333;
        }

        body[data-theme="noir"] .mode-greeting-text b {
            color: #ffffff !important; /* Названия категорий всегда белые */
        }

        /* Заменяем голубой цвет Bestie в нуарной теме */
        body[data-theme="noir"] .plan-card.bestie {
            border-color: #ffffff !important;
            background: linear-gradient(165deg, #333 0%, #000 100%) !important;
            box-shadow: 0 0 20px rgba(255,255,255,0.1) !important;
        }

        body[data-theme="noir"] .plan-card.bestie .plan-title,
        body[data-theme="noir"] .bestie-badge {
            background: #ffffff !important;
            color: #000000 !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: initial !important;
        }

        body[data-theme="noir"] .plan-btn.bestie-btn {
            background: #ffffff !important;
            color: #000000 !important;
        }

        /* Статус подписки в окне синхронизации */
        body[data-theme="noir"] #sync-sub-value {
            color: #ffffff !important;
        }

        body[data-theme="noir"] .limit-fill {
            background: linear-gradient(90deg, #888, #fff) !important;
            box-shadow: 0 0 10px #ffffff;
        }

        /* Градиент для кнопок в нуаре */
        body[data-theme="noir"] .btn-start-capsule {
            background: linear-gradient(to right, #666, #999) !important;
            box-shadow: 0 10px 30px -5px rgba(255,255,255,0.2) !important;
        }

        /* 1. Кнопки управления (Tinder-style) */
        body[data-theme="noir"] .t-circle-btn {
            background: #000000 !important;
            border: 1px solid #ffffff !important;
            color: #ffffff !important;
            box-shadow: none !important;
            background-image: none !important;
        }

        /* Активное состояние кнопок (инверсия) */
        body[data-theme="noir"] .t-circle-btn:active,
        body[data-theme="noir"] .t-circle-btn.active,
        body[data-theme="noir"] .t-circle-btn.wl.active {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #ffffff !important;
        }

        /* 2. Большая кнопка генерации/старта */
        body[data-theme="noir"] .btn-gen,
        body[data-theme="noir"] .btn-start-capsule,
        body[data-theme="noir"] .btn-watch {
            background: #000000 !important;
            border: 1px solid #ffffff !important;
            color: #ffffff !important;
            box-shadow: 0 4px 15px rgba(255,255,255,0.1) !important;
            background-image: none !important;
        }
        
        body[data-theme="noir"] .btn-gen:active,
        body[data-theme="noir"] .btn-start-capsule:active {
            background: #ffffff !important;
            color: #000000 !important;
        }

        /* 3. Тумблеры (Switch) */
        body[data-theme="noir"] input:checked + .slider {
            background-color: #ffffff !important;
        }
        body[data-theme="noir"] input:checked + .slider:before {
            background-color: #000000 !important;
            transform: translateX(20px);
        }
        body[data-theme="noir"] .slider {
            background-color: #333333;
        }

        /* 4. Бейджи (Extreme, LGBT...) */
        body[data-theme="noir"] .warning-badge {
            background: #000000 !important;
            border: 1px solid #ffffff !important;
            color: #ffffff !important;
        }

        /* 5. Иконки в настройках и навбаре */
        body[data-theme="noir"] .nav-item.active .nav-icon {
            color: #ffffff !important;
        }
        
        /* 6. Активные элементы списков */
        body[data-theme="noir"] .theme-item.active {
            border-color: #ffffff !important;
        }
        body[data-theme="noir"] .lock-icon {
            color: #ffffff !important;
        }

        /* 7. График статистики */
        body[data-theme="noir"] .chart-bar {
            background: #ffffff !important;
        }
        
        /* 8. Логотип (Fetish часть) */
        body[data-theme="noir"] .logo span {
            background: #ffffff !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* 9. Кнопки выбора режима (Start Screen) */
        body[data-theme="noir"] .mode-circle-btn {
            background: #000000 !important;      
            border: 1px solid #ffffff !important; 
            box-shadow: none !important;         
            color: #ffffff !important;           
        }
        
        body[data-theme="noir"] .mode-circle-btn:active {
            background: #ffffff !important;       
            color: #000000 !important;
        }

        body[data-theme="noir"] .ai-icon-img {
            filter: invert(1) !important; 
        }
        body[data-theme="noir"] .mode-circle-btn:active .ai-icon-img {
            filter: invert(0) !important; 
        }

        /* === THEME: OLD MONEY (Mahogany & Gold) === */
        body[data-theme="old-money"] {
            --bg-color: #1a0505;
            --sidebar-bg: #260909;
            --card-bg: #2e0b0b;
            --nav-bg: #3d0e0e;
            
            --text-main: #f0e6d2; /* Папирус */
            --text-secondary: #a38970; /* Медь */
            
            --accent: #c5a059; /* Старое золото */
            --accent-light: #e6c98c; /* Светлое золото */
            
            --border: #4a1919;
            --ios-card: #2e0b0b;
            --ios-bg: #1a0505;
            --ios-separator: #4a1919;
            --ios-header: #8a6a4b;

            --card-gradient: linear-gradient(165deg, #2e0b0b 0%, #1a0505 100%);
            --modal-bg: rgba(26, 5, 5, 0.95);
        }

        /* 1. ЛОГОТИП (Золотой градиент) */
        body[data-theme="old-money"] .logo span,
        body[data-theme="old-money"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #f9f1d8 0%, #c5a059 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-shadow: 0 2px 10px rgba(197, 160, 89, 0.2);
        }

        /* 2. ИКОНКИ В ИНТЕРФЕЙСЕ (Золотой фильтр) */
        body[data-theme="old-money"] .nav-icon-img,
        body[data-theme="old-money"] .settings-icon,
        body[data-theme="old-money"] .share-icon-img,
        body[data-theme="old-money"] .ex-card-icon {
            filter: invert(75%) sepia(26%) saturate(677%) hue-rotate(357deg) brightness(89%) contrast(88%) drop-shadow(0 2px 5px rgba(0,0,0,0.3)) !important;
            opacity: 1;
        }

        /* 3. ДЕКОРАЦИИ (Летающие иконки) - ЗОЛОТОЙ ГРАДИЕНТ/ОТЛИВ */
        body[data-theme="old-money"] .deco-icon {
            /* Фильтр, превращающий белое/черное в золото + тень для объема */
            filter: invert(68%) sepia(35%) saturate(735%) hue-rotate(2deg) brightness(110%) contrast(100%) drop-shadow(0 4px 0px #3d1515) !important;
            opacity: 0.9;
        }

        /* =========================================
           4. КНОПКИ УПРАВЛЕНИЯ (TINDER) - ИСПРАВЛЕНИЕ
           ========================================= */
        
        /* ОБЩИЙ СТИЛЬ для кнопок: Undo, Pass, Like, WL */
        body[data-theme="old-money"] .t-circle-btn.undo,
        body[data-theme="old-money"] .t-circle-btn.dislike,
        body[data-theme="old-money"] .t-circle-btn.like,
        body[data-theme="old-money"] .t-circle-btn.wl {
            background: #260909 !important; /* Темный фон (Махагон) */
            border: 1px solid #5c2424 !important; /* Рамка */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important; /* Тень */
        }

        /* ИКОНКИ ВНУТРИ ЭТИХ КНОПОК -> ДЕЛАЕМ ЗОЛОТЫМИ */
        body[data-theme="old-money"] .t-circle-btn.undo .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.dislike .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.like .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.wl .action-icon-img {
            /* Золотой фильтр (#c5a059) */
            filter: invert(75%) sepia(26%) saturate(677%) hue-rotate(357deg) brightness(89%) contrast(88%) !important;
        }

        /* АКТИВНОЕ СОСТОЯНИЕ (При нажатии) */
        body[data-theme="old-money"] .t-circle-btn:active,
        body[data-theme="old-money"] .t-circle-btn.wl.active {
            background: #f0e6d2 !important; /* Светлая вспышка */
            border-color: #fff !important;
        }
        /* При нажатии иконка темнеет */
        body[data-theme="old-money"] .t-circle-btn:active .action-icon-img,
        body[data-theme="old-money"] .t-circle-btn.wl.active .action-icon-img {
            filter: brightness(0.2) !important; 
        }

        /* ОСОБЫЙ СТИЛЬ ДЛЯ КНОПКИ WATCH (Центральная) */
        body[data-theme="old-money"] .t-circle-btn.watch {
            /* Яркий золотой градиент */
            background: linear-gradient(135deg, #c5a059 0%, #8a6a4b 100%) !important;
            border: 1px solid #f0e6d2 !important; 
            box-shadow: 0 0 25px rgba(197, 160, 89, 0.4) !important;
        }
        /* Иконка внутри Watch -> ТЕМНАЯ (для контраста с золотом) */
        body[data-theme="old-money"] .t-circle-btn.watch .action-icon-img {
            filter: brightness(0.15) !important; 
        }

        /* 5. КНОПКИ НА СТАРТОВОМ ЭКРАНЕ (Start Screen) */
        body[data-theme="old-money"] .mode-circle-btn {
            background: #260909 !important;
            border: 1px solid #5c2424 !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6) !important;
        }
        /* Иконки внутри - БЕЛЫЕ */
        body[data-theme="old-money"] .mode-circle-btn .side-icon-img,
        body[data-theme="old-money"] .mode-circle-btn .ai-icon-img {
            filter: brightness(0) invert(1) !important; 
            opacity: 1 !important;
            drop-shadow: 0 0 10px rgba(197, 160, 89, 0.5) !important;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden; /* Скролл только внутри контейнеров */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        button, select, input { font-family: inherit; outline: none; }
        a { text-decoration: none; color: inherit; }

        /* === CUSTOMIZATION === */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 колонки */
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-item {
            background: var(--ios-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            overflow: hidden;
        }

        .theme-item.active {
            border-color: var(--accent);
            background: var(--nav-bg);
        }
        
        .theme-item.locked {
            opacity: 0.6;
        }

        /* Квадраты предпросмотра */
        .theme-preview-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(128,128,128,0.2);
            position: relative;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Кружок цвета внутри квадрата */
        .theme-preview-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .theme-info {
            display: flex;
            flex-direction: column;
        }
        
        .theme-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .theme-type {
            font-size: 10px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .lock-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        /* Стили для элемента темы в режиме предпросмотра */
        .theme-item.previewing {
            border-color: var(--accent) !important;
            background: var(--nav-bg);
        }

        /* Убираем прозрачность для заблокированных тем, чтобы их было видно при клике */
        .theme-item.locked.previewing {
            opacity: 1 !important;
        }

        .pro-badge-icon {
            font-size: 10px;
            font-weight: 800;
            background: var(--accent); /* Цвет темы */
            color: #000; /* Контрастный текст */
            padding: 3px 6px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        /* 2. Плавающая панель "Unlock" (внизу экрана) */
        #preview-floating-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(120px); /* Спрятана внизу */
            width: 90%;
            max-width: 380px; /* Чуть компактнее */
            
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            
            padding: 10px 10px 10px 20px; /* Больше воздуха */
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px; /* Гарантированный отступ между текстом и кнопкой */
            
            z-index: 30000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            pointer-events: auto;
        }

        /* Состояние "Видно" */
        #preview-floating-bar.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Светлая тема для плашки */
        body.light-theme #preview-floating-bar {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Прозрачный щит-перехватчик */
        #preview-overlay-shield {
            display: none; /* Скрыт по умолчанию */
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 29000; /* Перекрывает всё, кроме плашки Unlock */
            background: transparent; /* Невидимый */
            -webkit-tap-highlight-color: transparent;
        }

        /* Когда активен — блокирует всё */
        #preview-overlay-shield.active {
            display: block;
        }

        /* =========================================
        2. MAIN LAYOUT (Sidebar & Content)
        ========================================= */
        .app-layout { display: flex; height: 100%; width: 100%; }

        .sidebar {
            width: 340px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .main-content {
            flex: 1;
            position: relative;
            height: 100%;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: hidden !important;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            overflow-x: visible;
            -webkit-overflow-scrolling: touch; 
            padding: 20px 15px;
            padding-bottom: 120px;
            padding-top: 110px; /* Место под хедер на мобильных */
            width: 100%;
            box-sizing: border-box;
        }

        .tab-content.active { display: flex; }

        .center-wrapper {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 auto;
        }

        /* =========================================
        3. HEADERS, LOGO & MASKS
        ========================================= */
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 0;
            letter-spacing: -1px;
            cursor: pointer;
            line-height: 1;
        }
        .logo span { 
            /* Градиент: Сверху #CB53F0, Снизу цвет темы */
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            position: relative;
            z-index: 1;
        }

        .logo-img {
            height: 45px;
            width: auto;
            display: block;
            object-fit: contain;
            transform: translateY(0);
            margin-right: 2px;
        }

        body.tab-home-active .mobile-header .subtitle {
            display: none !important; /* Скрываем подзаголовок */
        }

        body.tab-home-active .mobile-header {
            min-width: auto;
            width: auto;
            padding: 8px 20px;
            border-radius: 50px;
            min-height: 50px; 
        }

        body.tab-home-active .mobile-header .logo {
            font-size: 22px;
            margin: 0;
        }

        body.tab-home-active .mobile-header .logo-img {
            height: 35px;
            transform: translateY(0);
        }

        body.tab-home-active #tab-home {
            padding-top: 80px !important; 
        }

        /* 1. Скрываем подзаголовок на ВСЕХ вкладках */
        body.tab-home-active .mobile-header .subtitle,
        body.tab-settings-active .mobile-header .subtitle,
        body.tab-account-active .mobile-header .subtitle {
            display: none !important;
        }

        /* 2. Превращаем хедер в компактную капсулу на ВСЕХ вкладках */
        body.tab-home-active .mobile-header,
        body.tab-settings-active .mobile-header,
        body.tab-account-active .mobile-header {
            min-width: auto;
            width: auto;
            padding: 8px 20px;      /* Компактные отступы */
            border-radius: 50px;    /* Полная капсула */
            min-height: 50px;
            flex-direction: row;    /* Элементы в строку */
        }

        /* 3. Уменьшаем размер шрифта логотипа */
        body.tab-home-active .mobile-header .logo,
        body.tab-settings-active .mobile-header .logo,
        body.tab-account-active .mobile-header .logo {
            font-size: 22px;
            margin: 0;
        }

        /* 4. Уменьшаем картинку логотипа */
        body.tab-home-active .mobile-header .logo-img,
        body.tab-settings-active .mobile-header .logo-img,
        body.tab-account-active .mobile-header .logo-img {
            height: 35px;
            transform: translateY(0);
        }

        /* 5. Корректируем отступ контента сверху (так как шапка стала меньше) */
        body.tab-settings-active #tab-settings,
        body.tab-account-active #tab-account {
            padding-top: 90px !important; /* Было 110px, уменьшаем под размер капсулы */
        }
        
        .subtitle {
            font-size: 11px; 
            color: var(--text-secondary); 
            text-transform: uppercase;
            letter-spacing: 1px; 
            text-align: center; 
            
            margin-top: -5px !important;   /* Тянем вверх к логотипу */
            margin-bottom: 25px !important; /* Отступ снизу до меню */
            
            font-weight: 600; 
            opacity: 0.7; 
            max-width: 240px; 
            margin-left: auto; /* Центрирование */
            margin-right: auto;
            line-height: 1.4;
        }

        /* Градиентные маски для скролла */
        .top-gradient-mask {
            display: none;
            position: fixed; top: -50px; left: 0; width: 100%; height: 160px;
            z-index: 9000; pointer-events: none;
            background: linear-gradient(to bottom, var(--bg-color) 40%, transparent 100%);
        }
        .bottom-gradient-mask {
            display: none; 
            position: fixed; bottom: -50px; left: 0; width: 100%; height: 160px;
            z-index: 9000; pointer-events: none;
            background: linear-gradient(to top, var(--bg-color) 40%, transparent 100%);
        }

        @keyframes cardPopIn {
            0% { 
                opacity: 0;
                transform: scale(0.8) translateY(30px);
            }
            60% {
                opacity: 1;
                transform: scale(1.02) translateY(-5px); /* Легкий перелет */
            }
            100% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .anim-initial-pop {
            animation: cardPopIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
        }

        /* Скрываем элементы карточки до начала анимации */
        .card-content-hidden .stagger-item {
            opacity: 0;
            animation: none !important;
        }

        /* === 1. СКРЫВАЕМ ШАПКУ НА ГЛАВНОЙ === */
        body.tab-home-active .mobile-header {
            display: none !important; /* Полностью убираем */
        }

        /* Корректируем отступ контента на главной */
        body.tab-home-active #tab-home {
            /* Оставляем отступ только под статус-бар/челку телефона */
            padding-top: max(20px, env(safe-area-inset-top)) !important; 
        }

        /* === 2. ЧЕРНЫЙ ЭКРАН ПРИВАТНОСТИ (PWA) === */
        #pwa-privacy-screen {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh; /* Используем vw/vh для гарантии */
            background-color: var(--bg-color); 
            z-index: 2147483647 !important; /* Максимальный Z-index с приоритетом */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            
            /* Оптимизация рендеринга для iOS */
            transform: translate3d(0, 0, 0); 
            -webkit-transform: translate3d(0, 0, 0);
            will-change: opacity, display;
            pointer-events: none; /* Чтобы не мешал кликам, когда скрыт (если display глючит) */
        }

        /* Класс для мгновенного показа */
        #pwa-privacy-screen.active {
            display: flex !important;
            pointer-events: auto;
        }

        /* =========================================
        4. GENERATOR CARD & SLOT MACHINE
        ========================================= */
        .animation-text-box { text-align: center; min-height: 20px; margin-bottom: 5px; width: 100%; }
        .animation-text { font-size: 14px; font-weight: 700; color: var(--accent); text-transform: uppercase; opacity: 0; transition: opacity 0.2s; }
        .animation-text.visible { opacity: 1; }

        .status-text-combined {
            /* Позиционирование НАД карточкой */
            position: absolute;
            bottom: 100%; /* Приклеиваем к верху контейнера */
            left: 0;
            width: 100%;
            margin-bottom: 15px; /* Отступ от карточки */
            z-index: 15; 
            
            /* Стили текста */
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 16px; 
            font-weight: 700; 
            color: var(--text-main);
            text-transform: uppercase; 
            letter-spacing: 1px;
            line-height: 1.3; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            
            transform-origin: 50% 400px; /* Примерно центр низа карточки */
            will-change: transform;
            pointer-events: none; /* Чтобы текст не мешал свайпать */
        }

        .card {
            position: relative; 
            display: flex !important;
            flex-direction: column !important;
            justify-content: space-between !important; 
            
            width: 100%;
            min-height: 60vh; 
            height: auto;
            
            background: var(--card-gradient);
            border: 1px solid var(--border);
            border-radius: 28px;
            overflow: hidden; 
            padding: 0 !important; 
            
            transition: transform 0.1s linear; 
            z-index: 5;
        }

        body.light-theme .card {
            background: var(--card-gradient);
            border: 1px solid rgba(0,0,0,0.04) !important;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.08) !important;
        }

        body.light-theme .mobile-header {
            background: rgba(255, 255, 255, 0.85) !important;
            border: 1px solid rgba(0, 0, 0, 0.05) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        body.light-theme .bottom-nav {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        }

        body.light-theme .ios-group,
        body.light-theme .capsule-btn,
        body.light-theme .mode-capsule-btn {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .voice-icon-img,
        body.light-theme .ai-icon-img {
            filter: invert(0) drop-shadow(0 2px 5px rgba(0, 0, 0, 0.05));
            opacity: 0.6;
        }

        .card.has-results {
            min-height: inherit !important;
            height: auto !important;
            padding-top: 15px !important; 
            padding-bottom: 15px !important;
            justify-content: flex-start !important;
            gap: 5px; 
        }

        @keyframes flyInSmooth {
            0% { 
                transform: translateX(100px) scale(0.9); /* Слегка справа и меньше */
                opacity: 0; 
                filter: blur(10px);
            }
            100% { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
                filter: blur(0);
            }
        }

        .anim-slow-enter {
            /* 0.8s - медленнее и плавнее, чем обычный свайп */
            animation: flyInSmooth 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }
        
        /* Slot Window */
        .slot-window {
            width: 100%;
            /* На мобильных высота авто, чтобы не занимать лишнее место */
            height: auto !important; 
            min-height: 100px;
            
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            
            /* Маска для красивого исчезновения текста */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
        }

        /* На совсем маленьких экранах (iPhone SE и т.д.) чуть уменьшаем */
        @media (max-height: 650px) {
            .slot-window {
                height: 180px !important;
            }
        }

        .card.has-results .slot-window {
            height: auto !important;
            margin: 0 !important;
            overflow: visible !important;
            -webkit-mask-image: none !important;
            mask-image: none !important;
        }

        .slot-reel {
            display: flex; flex-direction: column; align-items: center;
            transform: translateY(0); width: 100%;
            will-change: transform;
        }

        .slot-item {
            height: auto !important; 
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            padding: 0 10px;
            font-size: clamp(32px, 8vw, 60px) !important;
            font-weight: 800;
            color: var(--text-main);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .card.has-results .slot-item {
            height: auto !important;
            padding: 0 10px !important;
            margin-bottom: 5px;
            font-size: clamp(28px, 6vw, 42px) !important;
            
            display: block !important; 
            text-align: center !important;
            white-space: normal !important; 
            line-height: 1.2 !important;
        }

        .slot-item span {
            font-weight: 600;
            margin-left: 6px; 
            display: inline; 
        }

        .card > div:last-child {
            z-index: 20; 
            flex: 0 0 auto; 
            width: 100%;
            padding-bottom: 20px;
            margin-top: auto; 
            background: transparent; 
        }

        
        /* Animations & Effects */
        .slot-item.shrunk { transform: scale(0.8); opacity: 0.7; }
        .slot-item.zoomed { transform: scale(1.2); color: var(--accent); text-shadow: 0 0 20px rgba(255, 153, 0, 0.4); }
        
        .card.flash-active { background-color: #fff !important; border-color: #fff !important; transform: scale(1.02); }
        
        .result-description { 
            font-size: 19px !important; 
            font-weight: 500 !important;
            color: var(--text-secondary) !important;
            line-height: 1.5 !important;
            max-width: 90%; 
            margin: 0 auto; 
            text-align: center;
            opacity: 0.2;
        }
        .result-description.fade-visible:not(:empty) { display: block; }

        /* Idle Animation */
        @keyframes scrollIdle { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
        .slot-reel.idle { animation: scrollIdle 60s linear infinite; filter: blur(5px); opacity: 0.6; }
        .slot-reel.spinning { filter: blur(0); opacity: 1; }

        /* === АНИМАЦИИ FLY IN === */
        
        /* Карточка вылетает СЛЕВА (для "Другое" / Свайп влево / Вернуться) */
        @keyframes flyInLeft {
            0% { 
                transform: translateX(-150%) rotate(-15deg); /* Чуть дальше вылет */
                opacity: 0; 
                filter: blur(20px); /* Сильный блюр в начале */
            }
            50% {
                opacity: 1;
                filter: blur(10px); /* Блюр в середине */
            }
            100% { 
                transform: translateX(0) rotate(0); 
                opacity: 1; 
                filter: blur(0); /* Четкость в конце */
            }
        }

        /* Карточка вылетает СПРАВА (для "Похожее" / Свайп вправо) */
        @keyframes flyInRight {
            0% { 
                transform: translateX(150%) rotate(15deg); 
                opacity: 0; 
                filter: blur(20px); 
            }
            50% {
                opacity: 1;
                filter: blur(10px);
            }
            100% { 
                transform: translateX(0) rotate(0); 
                opacity: 1; 
                filter: blur(0); 
            }
        }

        /* Классы для JS */
        .anim-fly-left {
            animation: flyInLeft 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }

        .anim-fly-right {
            animation: flyInRight 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }

        /* =========================================
        5. BUTTONS & CONTROLS
        ========================================= */
        .btn-gen, .btn-watch, .related-item-btn, .btn-action { border-radius: 22px; outline: none; border: none; cursor: pointer; }
        
        .gen-controls { display: flex; gap: 10px; width: 100%; margin-bottom: 15px; transition: opacity 0.3s; }
        .btn-gen { flex: 1; padding: 22px; background: var(--text-main); color: var(--bg-color); font-size: 18px; font-weight: 900; text-transform: uppercase; box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .btn-gen.secondary { background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border); font-size: 16px; flex: 0.8; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .btn-watch { flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 15px; text-transform: uppercase; background: var(--accent); color: #000; }

        .card-actions { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-action { 
            flex: 1; padding: 15px; border-radius: 18px; border: 1px solid var(--border); 
            background: transparent; color: var(--text-secondary); font-size: 24px;
            font-weight: 700; transition: all 0.2s; max-width: 80px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-action.ban:hover, .btn-action.ban.active { border-color: var(--highlight-red); background: rgba(231, 76, 60, 0.15); color: var(--highlight-red); transform: scale(1.05); }
        .btn-action.fav:hover, .btn-action.fav.active { border-color: var(--highlight-green); background: rgba(46, 204, 113, 0.15); color: var(--highlight-green); transform: scale(1.05); }

        .btn-watch-later {
            width: 54px;
            flex-shrink: 0;
            border-radius: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-watch-later:active {
            transform: scale(0.95);
        }

        /* Активное состояние кнопки (когда добавлено) - Синий цвет */
        .btn-watch-later.active {
            background: #3498db; /* Синий */
            color: #ffffff;
            border-color: #3498db;
        }

        /* Стиль тега в списке "Смотреть позже" (Синий) */
        .catalog-item.wl-active { 
            background: rgba(52, 152, 219, 0.2); 
            color: #3498db; 
            border: 1px solid #3498db; 
        }

        /* Related & Tags */
        .related-section { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 35px !important;
            margin-bottom: 20px; 
            text-align: center; 
        }
        .related-tags {
            display: flex;
            flex-wrap: wrap;       /* Разрешаем перенос на следующую строку */
            justify-content: center; /* Центрируем теги */
            gap: 10px;             /* Расстояние между тегами */
            width: 100%;
        }
        .related-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; opacity: 0.8; }
        .related-item-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; color: var(--text-main); transition: 0.2s; }

        /* Utility */
        .visually-hidden { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .fade-hidden { opacity: 0; transform: translateY(10px); transition: opacity 0.5s ease, transform 0.5s ease; display: none; }
        .fade-visible { opacity: 1; transform: translateY(0); display: flex; }

        /* --- ИКОНКИ ИНТЕНСИВНОСТИ --- */
        .intensity-selector-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px; /* Отступы по бокам для иконок */
            margin-top: 5px;
        }

        .intensity-btn {
            width: 45px;  /* Размер иконки */
            height: 45px;
            object-fit: contain;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            
            /* Неактивное состояние: серое и полупрозрачное */
            filter: grayscale(100%);
            opacity: 0.3; 
        }

        /* Активное состояние: цветное, яркое, чуть увеличено */
        .intensity-btn.active {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.15);
        }

        /* --- ОБНОВЛЕНИЕ ДЛЯ СТАТУСА ПОДПИСКИ --- */
        #settings-plan-status {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-secondary);
        }
        /* Цвет для PRO/BEAST */
        #settings-plan-status.premium {
            color: var(--accent) !important;
            font-weight: 800;
        }

        #intensity-value-label {
            font-size: 14px; 
            font-weight: 800; 
            text-transform: uppercase; 
            margin-right: 2px;
            
            /* По умолчанию скрыт и смещен немного вниз */
            opacity: 0;
            transform: translateY(5px);
            
            /* Плавная анимация для всех свойств */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Класс для показа */
        #intensity-value-label.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* =========================================
        6. IOS SETTINGS & COMPONENTS
        ========================================= */
        .ios-group {
            background: var(--ios-card); border-radius: 22px; overflow: hidden; margin-bottom: 20px; width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .ios-header {
            margin: 25px 0 8px 20px; font-size: 13px; color: var(--ios-header);
            text-transform: uppercase; display: flex; justify-content: space-between;
        }
        .ios-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; background: var(--ios-card); min-height: 44px; position: relative;
        }
        .ios-row:not(:last-child)::after {
            content: ""; 
            position: absolute; 
            bottom: 0; 
            left: 48px; 
            right: 16px;
            height: 1px;
            background-color: var(--ios-separator); 
            transform: scaleY(0.5);
        }
        .ios-row.clickable { cursor: pointer; transition: background 0.2s; }
        .ios-row.clickable:active { background: var(--nav-bg); }
        
        .capsule-btn {
            background: var(--ios-card); border-radius: 22px; padding: 5px 20px;
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            min-height: 55px; cursor: pointer; transition: transform 0.2s, background 0.2s; border: none;
        }
        .capsule-btn:active { transform: scale(0.98); background: var(--nav-bg); }
        .capsule-btn span { font-weight: 600; font-size: 16px; color: var(--text-main); }
        .capsule-btn select { font-weight: 700; color: var(--accent) !important; font-size: 17px; background: transparent; border: none; text-align: right; appearance: none; -webkit-appearance: none; }

        .platform-select, .ios-row select {
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
            border: none;
            font-size: 16px;
            color: var(--text-secondary);
            text-align: right;
            direction: rtl;
            padding-right: 0;
            font-weight: 400;
            cursor: pointer;
            font-family: inherit;
        }

        /* Account Elements */
        .sync-date { font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 10px; margin-bottom: 20px; opacity: 0.6; }
        
        /* Switches & Sliders */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; margin: 0 5px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .range-slider { width: 100%; cursor: pointer; }
        .intensity-labels { display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px; }
        .intensity-label { font-size: 12px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; }
        .intensity-label.active { color: var(--accent); font-weight: 700; }

        /* Accordion */
        .accordion { background: transparent !important; }
        .accordion-head { padding: 16px !important; font-size: 17px !important; color: var(--text-main) !important; display: flex; justify-content: space-between; }
        .accordion-body { display: none; padding: 0 16px 16px; flex-wrap: wrap; gap: 8px; }
        .accordion-body.open { display: flex; }
        
        /* Tags */
        .capsule-accordion-head { background: var(--card-bg); border: 1px solid var(--border); border-radius: 50px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; width: auto; max-width: 200px; margin: 0 auto 15px auto; cursor: pointer; font-size: 13px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; }

        /* =========================================
        7. MOBILE BOTTOM NAV
        ========================================= */
        .bottom-nav {
            display: flex; 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 85%; 
            max-width: 350px; 
            height: 65px;
            background: var(--ios-card); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 50px;
            z-index: 9999; 
            
            /* ИСПРАВЛЕНИЕ: Равномерный отступ со всех сторон */
            padding: 5px; 
            
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            justify-content: space-between; 
            align-items: center;
            box-sizing: border-box;
        }


        body.light-theme .bottom-nav { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.1); }
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            font-weight: 600; 
            color: var(--text-secondary); 
            
            flex: 1; 
            height: 100%;
            cursor: pointer; 
            transition: all 0.2s; 
            z-index: 2; 
            position: relative;

            /* Отключает системное меню (копировать/сохранить) на iOS */
            -webkit-touch-callout: none; 
            /* Отключает выделение синим цветом */
            -webkit-user-select: none;   
            user-select: none;           
            /* Убирает серую подсветку при тапе (если она не нужна) */
            -webkit-tap-highlight-color: transparent; 
        }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active .nav-icon { transform: translateY(-2px); color: var(--accent); }
        .nav-icon { font-size: 22px; margin-bottom: 2px; transition: transform 0.2s; }

        @media (min-width: 769px) {
            .bottom-nav {
                display: none !important;
            }
        }

        .nav-icon-img {
            height: 24px;
            width: 24px;
            object-fit: contain;
            margin-bottom: 4px;
            transition: filter 0.3s, transform 0.2s;
            filter: invert(1);

            /* === ФИКС КАРТИНКИ === */
            pointer-events: none; 
            
            /* Запрещает перетаскивание картинки (призрак) */
            -webkit-user-drag: none; 
            user-drag: none;
        }

        /* Светлая тема */
        body.light-theme .nav-icon-img {
            filter: invert(0);
            opacity: 0.6;
        }

        /* Активное состояние (светлая тема) */
        body.light-theme .nav-item.active .nav-icon-img {
            filter: invert(0);
            opacity: 1;
        }

        .nav-item.active .nav-icon-img {
            transform: scale(1.1);
        }

        .nav-active-pill {
            position: absolute;
            top: 5px;
            bottom: 5px;
            
            left: 5px; 
            
            width: calc((100% - 10px) / 3); 
            
            background: rgba(255, 255, 255, 0.15);
            border-radius: 40px;
            z-index: 1; /* Таблетка под текстом */
            transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1);
            will-change: transform;
        }

        body.light-theme .nav-active-pill {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Нуарная тема */
        body[data-theme="noir"] .nav-active-pill {
            background: #ffffff;
        }
        body[data-theme="noir"] .nav-item.active {
            color: #000 !important;
        }
        body[data-theme="noir"] .nav-item.active .nav-icon-img {
            filter: invert(0) !important;
        }

        /* Убираем старую анимацию с контента, чтобы она не мешала быстрому слайдингу */
        .tab-content.active .center-wrapper {
            animation: tabPremiumIn 0.3s cubic-bezier(0.2, 0, 0.2, 1) forwards;
        }

        /* =========================================
        8. MODALS (GENERAL)
        ========================================= */
        .modal-overlay {
            /* Фиксация позиции и слоя */
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important;
            z-index: 20000 !important;
            
            /* Фон и блюр */
            background: rgba(0, 0, 0, 0.6) !important;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            
            /* Flex для позиционирования окна */
            display: flex !important;
            flex-direction: column !important;
            
            /* СКРЫТО ПО УМОЛЧАНИЮ (Анимация через opacity) */
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            transition: opacity 0.3s ease, visibility 0.3s !important;
        }

        /* СОСТОЯНИЕ "ОТКРЫТО" - ЭТОТ КЛАСС ДОБАВЛЯЕТ JS */
        .modal-overlay.open {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        /* 2. САМО ОКНО (MODAL) */
        .modal {
            /* Сброс старых размеров и отступов */
            margin: 0 !important;
            max-width: none !important;
            max-height: none !important;
            position: relative !important;
            
            /* Фон и тени */
            background: var(--sidebar-bg) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            
            /* Плавная анимация появления */
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1) !important;
        }

        /* 3. ШАПКА (HEADER) */
        .modal-header {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important; /* Центрируем заголовок */
            position: relative !important;
            min-height: 60px !important;
            padding: 0 !important;
            background: transparent !important;
            margin-bottom: 0 !important;
        }

        .modal-header {
            border-bottom: none !important;
            min-height: 60px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            position: relative !important;
        }

        .modal-header > span:not(.modal-close-btn):not(.modal-header-actions) {
            position: absolute !important;
            left: 0;
            right: 0;
            text-align: center !important;
            width: 100% !important;
            margin: 0 !important;
            background: transparent !important; /* Убираем любой фон */
            box-shadow: none !important;        /* Убираем любые тени */
            
            font-size: 17px !important;
            font-weight: 800 !important;
            text-transform: uppercase !important;
            color: var(--text-main) !important;
            pointer-events: none;
            z-index: 1;
        }



        /* Кнопка закрытия (Крестик) - Всегда справа */
        .modal-header > span:last-child {
            position: absolute !important;
            right: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            
            width: 32px !important; height: 32px !important;
            border-radius: 50% !important;
            background: rgba(128, 128, 128, 0.15) !important;
            color: var(--text-secondary) !important;
            
            align-items: center !important; justify-content: center !important;
            font-size: 16px !important; cursor: pointer !important;
            z-index: 10 !important;
        }

        /* 4. ТЕЛО (BODY) */
        .modal-body {
            flex: 1 !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            padding: 0 20px 30px 20px !important;
        }

        #sub-status-btn {
            background: var(--card-bg); 
            border: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }

       @media (min-width: 769px) {
            .modal-overlay {
                justify-content: center !important;
                align-items: center !important;
            }

            .modal {
                width: 550px !important;       /* Фиксированная ширина */
                max-width: 90% !important;
                height: auto !important;
                max-height: 85vh !important;   /* Не на весь экран */
                
                border-radius: 24px !important;
                
                /* Анимация: Легкое увеличение */
                transform: scale(0.95) !important;
            }

            .modal-overlay.open .modal {
                transform: scale(1) !important;
            }
        }

        /* --- МОБИЛЬНАЯ ВЕРСИЯ (Узкий экран) --- */
        @media (max-width: 768px) {
            .modal-overlay {
                justify-content: flex-end !important; /* Прижать к низу */
                align-items: center !important;
            }

            .modal {
                width: 100% !important;
                height: auto !important;
                max-height: 85vh !important; /* Шторка не на весь экран */
                min-height: 300px !important;
                
                /* Скругление только сверху */
                border-radius: 28px 28px 0 0 !important;
                border-bottom: none !important;
                border-left: none !important;
                border-right: none !important;
                
                padding-bottom: 0 !important;
                
                /* Анимация: Выезд снизу */
                transform: translateY(100%) !important;
            }

            .modal-overlay.open .modal {
                transform: translateY(0) !important;
            }

            /* "Ручка" шторки (серая полоска) */
            .modal-header::before {
                content: "";
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: rgba(128, 128, 128, 0.4);
                border-radius: 10px;
            }
            
            /* Добавляем плавность для возврата шторки на место */
            .modal.swiping {
                transition: none !important; /* Отключаем анимацию во время перетаскивания */
            }
            
            .modal {
                transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1) !important;
                will-change: transform;
            }
            
            /* Сдвигаем заголовок чуть ниже из-за ручки */
            .modal-header {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important; /* Строго по центру */
                padding: 15px 20px !important;      /* Уменьшили отступ сверху */
                min-height: 60px !important;
                position: relative !important;
                
                /* Жирный текст */
                font-weight: 900 !important; 
                font-size: 18px !important;
                color: var(--text-main) !important;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .modal-header::before {
                top: 6px !important; /* Чуть выше */
            }
        }



        modal-header .modal-close-btn,
        .modal-header #mods-counter,
        .modal-header > span:not(.modal-close-btn):not(.modal-header-actions) {
            position: absolute !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            margin: 0 !important; 
            padding: 0 !important;
            line-height: 1 !important; /* Убираем влияние высоты строки */
            display: flex !important;
            align-items: center !important;
        }

        /* 3. Уточнение позиций сторон */
        .modal-header .modal-close-btn {
            left: 20px !important;
        }

        #mods-counter {
            right: 20px !important;
            left: auto !important;
        }

        /* 4. Заголовок (центр) */
        .modal-header > span:not(.modal-close-btn):not(.modal-header-actions) {
            left: 0;
            right: 0;
            width: 100%;
            justify-content: center !important;
            pointer-events: none;
            font-size: 18px !important;
            font-weight: 900 !important;
        }

        /* 5. Дополнительная правка для ПК (размер кнопки) */
        @media (min-width: 769px) {
            .modal-close-btn {
                width: 14px !important;
                height: 14px !important;
                min-width: 14px !important;
                max-width: 14px !important;
                background: #ff5f56 !important;
                border-radius: 50% !important;
            }
            
            /* Прячем стрелку */
            .modal-close-icon {
                display: none !important;
            }
        }

        #modal-stats-body {
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important; 
            min-height: 0 !important;
        }

        .modal-header::before,
        .modal-header::after {
            content: none !important;
            display: none !important;
        }


        /* Catalog Search */
        .modal-search-box { width: 100%; margin-bottom: 15px; position: relative; }
        .modal-search-input { width: 100%; background: var(--ios-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; font-size: 16px; color: var(--text-main); }
        .modal-suggestions { display: none; flex-direction: column; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; margin-top: 5px; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .suggestion-row { padding: 10px 15px; border-bottom: 1px solid var(--border); font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; }
        
        .catalog-item { padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: default; display: inline-flex; align-items: center; gap: 8px; margin: 3px; }
        .catalog-item.active { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
        .catalog-item.ban-active { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
        .catalog-remove-btn { cursor: pointer; opacity: 0.6; padding: 0 4px; }

        /* =========================================
        9. STATS & CHARTS
        ========================================= */
        .axis-label-y { position: absolute; left: -15px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 10px; color: var(--text-secondary); }
        .axis-label-x-title { position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-secondary); }
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 250px; width: 100%; border-bottom: 1px solid var(--border); border-left: 1px solid var(--border); position: relative; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; flex: 1; height: 100%; position: relative; }
        .chart-bar.secondary { background: var(--text-secondary); margin-right: 2px; }
        .bar-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 2px; height: 100%; }
        .chart-value-y {
            font-size: 10px; 
            font-weight: 700; 
            color: var(--text-main);
            margin-bottom: 4px; 
            text-align: center;
            width: 100%;
        }

        .stats-tf-capsule, .stats-nav-capsule { background: var(--ios-card); border: 1px solid var(--border); border-radius: 50px; display: flex; padding: 3px; width: 100%; }
        .stats-tf-capsule { height: 36px; margin-bottom: 8px; }
        .stats-nav-capsule { height: 50px; }
        .stats-tf-item, .stats-nav-item { flex: 1; display: flex; align-items: center; justify-content: center; border-radius: 40px; font-size: 11px; font-weight: 700; color: var(--text-secondary); cursor: pointer; text-transform: uppercase; }
        .stats-tf-item.active, .stats-nav-item.active { background: var(--nav-bg); color: var(--text-main); }
        .stats-tf-item {
            position: relative !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: visible !important;
        }

        .tf-anchor {
            position: relative !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* =========================================
        10. SUBSCRIPTION MODAL (RESPONSIVE)
        ========================================= */
        .plan-card {
            flex: 1 !important;
            min-width: 0 !important; 
            background: var(--ios-card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 20px !important;
            padding: 20px !important;
            margin: 0 !important; 
        }
        .plan-card {
            position: relative !important; 
            overflow: hidden !important;  
            display: flex !important;
            flex-direction: column !important;
            background: var(--ios-card) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05) !important;
        }
        .plan-card.pro { border-color: #ff9900; box-shadow: 0 0 20px rgba(255, 153, 0, 0.1); }
        .plan-card.beast { border-color: #9b59b6; background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), transparent); box-shadow: 0 0 20px rgba(155, 89, 182, 0.15); }
        
        .plan-title { font-size: 22px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; }
        .plan-card.pro .plan-title { color: #ff9900; }
        .plan-card.beast .plan-title { color: #9b59b6; }
        .plan-price { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 15px; }
        
        .plan-features { list-style: none; padding: 0; margin: 0 0 20px 0; }
        .plan-features li { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 20px; position: relative; }
        .plan-features li::before { content: "•"; position: absolute; left: 0; color: var(--text-main); }
        
        .plan-btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; text-transform: uppercase; font-size: 14px; margin-top: auto; }
        .plan-btn.current { background: var(--nav-bg); color: var(--text-secondary); opacity: 0.7; }
        .plan-btn.pro-btn { background: #ff9900; color: #000; box-shadow: 0 4px 15px rgba(255, 153, 0, 0.3); }
        .plan-btn.beast-btn { background: #9b59b6; color: #fff; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); }

        /* Mobile Default Layout for Plans */
        .plans-container {
            display: flex !important;
            flex-direction: column !important; 
            gap: 15px !important;
            padding-bottom: 20px !important;
        }
        #modal-sub-overlay .modal { width: 90%; max-width: 400px; max-height: 90vh; }

        /* =========================================
        11. Tinder Logic
        ========================================= */
        .tinder-actions {
            margin-top: auto; 
            padding-top: 10px;
            border-top: none;
            width: 100%;
            display: flex;
            gap: 10px;
        }

        .result-description {
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-secondary);
        }

        .related-section {
            margin-top: 5px !important;
            margin-bottom: 15px;
        }

        .btn-tinder {
            flex: 1;
            padding: 18px 10px;
            border-radius: 50px; /* Полностью круглые края */
            border: none;
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-tinder:active { transform: scale(0.95); }

        .btn-pass {
            background:transparent;
            border: 2px solid var(--highlight-red);
            color: var(--highlight-red);
        }
        
        .btn-like {
            background: var(--highlight-green) !important;
            color: #fff !important; /* Белый текст для контраста */
            border: 2px solid var(--highlight-green) !important;
        }

        .btn-like:active, .btn-like.active-state {
            background: rgba(46, 204, 113, 0.2) !important;
            color: var(--highlight-green) !important;
        }

        /* === 3. КНОПКА НАЗАД (UNDO) === */
        .undo-container {
            margin-top: 5px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .btn-undo {
            width: auto !important;
            height: auto !important;
            border-radius: 50px !important;
            padding: 8px 24px !important; 
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 13px !important;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-undo:active {
            background: var(--nav-bg);
            transform: scale(0.96);
        }

        /* === 4. СВАЙПЫ (Карточка) === */
        .card {
            position: relative; 
            overflow: hidden;
            touch-action: none; /* Важно для свайпов на мобильных */
            transform-origin: 50% 100%;
            will-change: transform, opacity;
            justify-content: space-between;
            margin-bottom: 10px !important; 
        }

        .card-reject {
            background: rgba(231, 76, 60, 0.9) !important; /* Красный */
            border-color: #c0392b !important;
            filter: blur(5px) grayscale(0.5); /* Блюр */
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.6) !important;
        }

        .card-like {
            background: rgba(46, 204, 113, 0.9) !important; /* Зеленый */
            border-color: #27ae60 !important;
            filter: blur(5px) grayscale(0.5); /* Блюр */
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6) !important;
        }

        /* --- 3. Начальная кнопка (Капсула внутри карточки) --- */
        #start-btn-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: auto;
            padding-bottom: 15px;
            
            flex-shrink: 0 !important; 
            min-height: 70px;
            
            position: relative;
            z-index: 30; 
        }

        .btn-start-capsule {
            /* Градиент темы: Слева светлее, Справа основной цвет */
            background: linear-gradient(to right, var(--accent-light), var(--accent));
            
            color: white; /* Текст всегда белый для контраста */
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 18px 40px;
            border-radius: 50px;
            border: none;
            
            /* Свечение (тень) в цвет темы */
            box-shadow: 0 10px 40px -5px var(--accent);
            
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            
            flex-shrink: 0; 
            z-index: 30;
        }

        .btn-start-capsule:active {
            transform: scale(0.95);
            /* Уменьшаем тень при нажатии */
            box-shadow: 0 5px 20px -5px var(--accent);
        }

        /* --- 4. Анимация "Вишенка на торте" (Staggered Fade Up) --- */
        @keyframes fadeInUpSmooth {
            from {
                opacity: 0;
                transform: translateY(20px);
                filter: blur(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }
        }

        /* Базовый класс для элементов, которые должны появляться плавно */
        .stagger-item {
            opacity: 0; /* Скрыты по умолчанию */
            animation: fadeInUpSmooth 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* Задержки (Очередь появления) */
        .delay-1 { animation-delay: 0.1s; } /* Заголовок (почти сразу после вспышки) */
        .delay-2 { animation-delay: 0.3s; } /* Описание */
        .delay-3 { animation-delay: 0.5s; } /* Похожие */
        .delay-4 { animation-delay: 0.7s; } /* Кнопки (Watch/Like) */
        .delay-5 { animation-delay: 1.0s; } /* Объяснение (Вишенка) */

        /* Фикс для заголовка (слота), чтобы он не конфликтовал со скриптом барабана */
        .slot-reel .slot-item.final-result {
            opacity: 0;
            animation: fadeInUpSmooth 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards 0.1s;
        }

        /* Активные состояния для новых кнопок */
        .btn-tinder.active-state {
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.3);
            transform: scale(0.98);
        }
        .btn-like.active-state { 
            background: #fff !important; 
            color: var(--accent) !important; 
            border-color: #fff !important;
        }
        .btn-pass.active-state { 
            background: var(--highlight-red) !important; 
            color: #fff !important; 
        }

        .restore-anim { animation: flyInLeft 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* 1. Скрываем старые кнопки по ID, а не по классу, чтобы не задеть кнопку старта */
        #btn-gen, #btn-similar { 
            display: none !important; 
        }

        /* 2. Принудительно показываем контейнер старта, если у него нет класса hidden-initial */
        #start-btn-container:not(.hidden-initial) {
            display: flex !important;
        }

        /* 3. Гарантируем, что новые кнопки будут Flex, когда мы уберем скрывающий класс */
        #main-actions:not(.hidden-initial) {
            display: flex !important;
        }

        .hidden-initial, .visually-hidden {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        #start-btn-container {
            transition: opacity 0.3s ease;
        }
        
        /* Адаптация под мобильные */
        @media (max-width: 768px) {
            
            /* 1. ГЛОБАЛЬНЫЕ СКРЫТИЯ */
            .sidebar, .tinder-actions, .btn-group, .undo-container, .badge-tooltip { display: none !important; }
            .mobile-header, .bottom-nav, .top-gradient-mask, .bottom-gradient-mask { display: flex !important; }
            .main-content { padding: 0 !important; }

            /* 2. КОНТЕЙНЕР */
            #tab-home .center-wrapper {
                height: 100vh !important;
                height: 100dvh !important;
                padding-top: 65px !important; 
                padding-bottom: 90px !important; 
                display: flex;
                flex-direction: column;
                justify-content: flex-start !important;
                overflow: hidden !important; 
                width: 100% !important;
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* 3. КАРТОЧКА */
            .card, .card.has-results {
                flex-grow: 1 !important;
                height: 100% !important;
                margin-bottom: 0 !important;
                width: 100% !important;
                padding: 10px 5px !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
                overflow: hidden !important;
            }

            /* === ВНУТРЕННИЕ БЛОКИ === */
            .card > div:nth-child(1) { flex: 0 0 auto !important; min-height: 25px !important; } /* Бейджи */
            
            /* ЦЕНТР (Возвращено space-evenly) */
            .card > div:nth-child(2) {
                flex: 1 1 auto !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-evenly !important; 
                align-items: center !important;
                overflow: hidden !important; 
                padding: 10px 0 !important;
            }

            .card > div:last-child { flex: 0 0 auto !important; margin-top: 5px !important; width: 100%; } /* Кнопки */

            /* --- ЭЛЕМЕНТЫ КОНТЕНТА --- */
            
            .slot-window {
                width: 100%;
                height: auto !important;
                flex: 0 1 auto !important;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .slot-item { 
                font-size: clamp(26px, 9vw, 48px) !important;
                line-height: 1.1 !important;
            }

            /* === ОПИСАНИЕ === */
             #result-desc {
                max-height: none !important; 
                overflow-y: visible !important;
                
                flex-shrink: 0 !important; 
                
                font-size: 15px !important;
                line-height: 1.35 !important;
                margin: 10px 0 15px 0 !important;
                white-space: normal !important; 
                
                display: -webkit-box;
                -webkit-line-clamp: 6; /* Показать максимум 6 строк */
                -webkit-box-orient: vertical;
                overflow: hidden !important; 
            }
            
            /* === ПОХОЖИЕ (ТЕГИ) === */
            .related-section {
                margin-top: 0 !important; /* Отступ уже задан в margin-bottom описания */
                margin-bottom: 5px !important;
                width: 100%;
                display: flex !important;
                flex-direction: column;
                align-items: center;
            }
            
            .related-tags { 
                display: flex !important;
                flex-wrap: nowrap !important; /* Запрещаем перенос строк */
                overflow-x: auto !important;  /* Разрешаем горизонтальный скролл */
                justify-content: flex-start !important; /* Выравнивание по началу */
                width: 100%;
                padding-bottom: 5px;
                gap: 6px !important;
                
                scrollbar-width: none; 
                -ms-overflow-style: none;
                
                mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
                -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            }
            .related-tags::-webkit-scrollbar { 
                display: none; 
            }
            
            .related-item-btn { 
                flex-shrink: 0 !important; /* Запрещаем кнопкам сжиматься */
                white-space: nowrap !important; 
                font-size: 12px; 
                padding: 8px 14px; 
            }

            /* --- КНОПКИ --- */
            .tinder-nav-row {
                gap: 8px !important; margin-bottom: 5px !important;
                justify-content: space-between !important; padding: 0 5px !important;
            }
            .t-circle-btn.small { width: 38px !important; height: 38px !important; font-size: 18px !important; }
            .t-circle-btn.medium { width: 50px !important; height: 50px !important; font-size: 24px !important; }
            .t-circle-btn.large { width: 64px !important; height: 64px !important; font-size: 28px !important; }

            #start-btn-container { min-height: 50px !important; }
            .btn-start-capsule { padding: 12px 30px !important; font-size: 16px !important; }

            #tab-settings .center-wrapper, #tab-account .center-wrapper { 
                padding: 40px 15px 120px 15px !important; height: auto !important; display: block !important;
            }
        }

        /* Зеленый тег (Лайк) */
        .onb-tag.like {
            background: rgba(46, 204, 113, 0.2); 
            color: #2ecc71; 
            border: 1px solid #2ecc71;
        }

        /* Красный тег (Дизлайк) */
        .onb-tag.dislike {
            background: rgba(231, 76, 60, 0.2); 
            color: #e74c3c; 
            border: 1px solid #e74c3c;
        }

        /* Общий стиль */
        .onb-tag {
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            animation: popIn 0.3s ease;
            cursor: default;
        }

        #tab-settings #mobile-mode-mount {
            margin-top: 0 !important;
            margin-bottom: 20px !important;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        #tab-settings .mode-capsule-btn {
            width: 100%; 
            max-width: 200px;
            justify-content: center;
            background: var(--ios-card);
            height: 44px;
        }

        .capsule-trigger {
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px; /* Полная капсула */
            padding: 8px 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            margin: 0 auto; /* Центрируем кнопку */
        }
        
        .capsule-trigger:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.98);
        }

        body.light-theme .capsule-trigger {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        /* === 4. ИКОНКА ЧАСОВ === */
        .t-circle-btn.wl {
            font-size: 26px; 
            padding-top: 2px; 
        }

        /* =========================================
        12. OTHER COMPONENTS (Badges, History)
        ========================================= */

        .warning-badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; color: #fff; cursor: help; }
        .badge-extreme { background: var(--highlight-red); }
        .badge-lgbt { background: #9b59b6; }
        .badge-niche { background: #34495e; }
        .badge-wrapper { display: flex; justify-content: center; gap: 6px; margin-bottom: 2px; margin-top: 5px; width: 100%; position: relative; z-index: 5; }
        
        .badge-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: #fff; padding: 12px; border-radius: 14px; font-size: 13px; line-height: 1.4;
            width: 220px; text-align: left; pointer-events: none; opacity: 0; transition: opacity 0.2s;
            margin-bottom: 10px; border: 1px solid var(--border); z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .warning-badge:hover .badge-tooltip { opacity: 1; pointer-events: auto; }

        .history-item-ios {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--ios-card); font-size: 16px; color: var(--text-main);
            position: relative; cursor: pointer; transition: background 0.2s;
        }
        .history-item-ios:active { background: var(--nav-bg); }
        .history-item-ios:not(:last-child)::after {
            content: ""; 
            position: absolute; 
            bottom: 0; 
            left: 16px; 
            right: 16px;
            height: 1px;
            background-color: var(--ios-separator); 
            transform: scaleY(0.5);
        }

        /* Onboarding & Age Gate */
        .onb-tag { background: var(--accent); color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #age-gate .logo { font-size: 40px; margin-bottom: 20px; }
        #age-gate .logo-img { height: 70px; margin-right: 10px; }

        .mobile-header {
            display: none; position: fixed; top: calc(10px + env(safe-area-inset-top)); 
            left: 50%; transform: translateX(-50%); width: auto; min-width: 260px; max-width: 90%;
            background: var(--ios-card) !important; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border) !important; border-radius: 35px; z-index: 9999;
            padding: 12px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-main);
        }
        body.light-theme .mobile-header { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.1); }
        .mobile-header .logo { font-size: 20px; margin-bottom: 0; }
        .mobile-header .logo-img { height: 40px; }

        /* === 12. PREMIUM STATS === */
        .locked-feature {
            position: relative;
            opacity: 0.5;
            pointer-events: none;
            filter: blur(2px);
        }
        .lock-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            pointer-events: auto; /* Чтобы клик проходил на оверлей */
        }
        .lock-badge {
            background: var(--accent); color: #000;
            padding: 5px 10px; border-radius: 12px;
            font-weight: 800; font-size: 12px; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .lock-badge-custom {
            position: absolute !important;
            top: 50% !important;
            right: -14px !important; 
            transform: translateY(-60%) !important; 
            
            font-size: 10px !important;
            line-height: 1 !important;
            pointer-events: none !important;
            opacity: 0.9;
        }

        /* === WRAPPED / SUMMARY UI (Spotify Style) === */
        .wrapped-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 25000; background: #000;
            display: none; flex-direction: column;
        }
        .wrapped-overlay.active { display: flex; animation: fadeIn 0.3s ease; }

        /* Динамические фоны для слайдов */
        .wrapped-slide {
            flex: 1; display: none; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 40px; text-align: center;
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
        }
        .wrapped-slide.active-slide { display: flex; }

        /* Градиенты для разных настроений */
        .bg-fire { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); }
        .bg-dark { background: linear-gradient(-45deg, #000000, #434343, #1a1a1a); }
        .bg-toxic { background: linear-gradient(-45deg, #11998e, #38ef7d, #000000); }
        .bg-passion { background: linear-gradient(-45deg, #8E2DE2, #4A00E0, #ff00cc); }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .wrapped-big-text {
            font-size: clamp(40px, 10vw, 80px);
            font-weight: 900; line-height: 1; margin-bottom: 20px;
            color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }
        .wrapped-sub-text {
            font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.9);
            line-height: 1.5; max-width: 400px;
        }
        .wrapped-stat-box {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px;
            margin: 20px 0; border: 1px solid rgba(255,255,255,0.3);
        }
        .wrapped-highlight { color: #ffe600; font-weight: 800; }

        .wrapped-nav-area {
            position: absolute; top: 0; height: 100%; width: 30%; z-index: 10;
        }
        .nav-left { left: 0; }
        .nav-right { right: 0; }
        .wrapped-close {
            position: absolute; top: 20px; right: 20px;
            font-size: 24px; color: rgba(255,255,255,0.5); z-index: 30; cursor: pointer;
        }

        /* Анимация заполнения бара */
        @keyframes fillBarAnim {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* Класс для запуска анимации */
        .wrapped-progress-fill.animating {
            animation: fillBarAnim linear forwards;
        }

        /* Класс для паузы (добавляется JS-ом при удержании) */
        .wrapped-overlay.paused .wrapped-progress-fill {
            animation-play-state: paused !important;
        }

        /*  финальная карточка */
        .sum-row.detail-row {
            font-size: 11px; 
            color: var(--text-secondary);
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        #share-header-overlay {
            display: none; 
            width: 100%;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .share-qr-box {
            background: #fff;
            padding: 5px;
            border-radius: 8px;
            height: 60px;
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-logo-text {
            font-weight: 900;
            font-size: 24px;
            color: #fff;
            line-height: 1;
        }
        .share-logo-text span {
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .share-caption {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* Стиль для иконки Share в шапке модалки */
        .share-icon-img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            filter: invert(1); /* Белая для темной темы */
            opacity: 0.8;
        }

        /* Для светлой темы */
        body.light-theme .share-icon-img {
            filter: invert(0); /* Черная */
        }

        /* Контейнер для генерации скриншота (скрыт от глаз, но виден для скрипта) */
        #export-stats-container {
            position: fixed;
            top: 0;
            left: -9999px; /* Убираем за пределы экрана */
            z-index: -1;
            width: 360px; /* Фиксированная ширина как у Wrapped */
            /* Используем стили Wrapped карточки */
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: none;
        }

        /* Принудительные стили для графика внутри скриншота, чтобы он влез */
        #export-stats-container .chart-container, 
        #export-stats-container .chart-wrapper {
            height: 180px !important; 
            border: none !important;
            margin: 0 !important;
        }

        /* --- Кнопка Share в Wrapped (Круглая) --- */
        .btn-round-share {
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.15); 
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-round-share:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }
        .btn-round-share img {
            width: 24px; 
            height: 24px; 
            filter: invert(1); /* Белая иконка */
        }

        /* --- QR Header для скриншотов --- */
        /* Этот блок скрыт в UI, но появляется на картинке */
        .screenshot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
            background: transparent;
        }

        .screenshot-logo-area {
            display: flex;
            flex-direction: column;
        }

        .screenshot-logo {
            font-size: 28px;
            font-weight: 900;
            color: #fff;
            line-height: 1;
        }
        .screenshot-logo span {
            color: var(--accent) !important; 
            background: none !important; 
            -webkit-text-fill-color: initial !important;
        }

        .screenshot-caption {
            font-size: 12px;
            text-transform: uppercase;
            color: #ccc;
            letter-spacing: 2px;
            margin-top: 5px;
            font-weight: 600;
        }

        .screenshot-qr {
            background: #fff;
            padding: 5px;
            border-radius: 10px;
            height: 70px;
            width: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wrapped-progress-container {
            position: absolute; 
            top: 15px; 
            left: 0; 
            width: 100%;
            padding: 0 15px; 
            display: flex; 
            gap: 4px; 
            z-index: 9999; /* Поверх всего */
            pointer-events: none; 
        }
        .wrapped-progress-bar {
            height: 3px; 
            flex: 1; 
            background: rgba(255,255,255,0.3);
            border-radius: 2px; 
            overflow: hidden;
        }
        .wrapped-progress-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            box-shadow: 0 0 8px rgba(255,255,255,0.8);
        }

        /* --- ДИЗАЙН СТАТИСТИКИ (CARD UI) --- */
        .stats-card-ui {
            background: var(--ios-card); /* Или темный фон как в Wrapped */
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        /* Адаптация заголовка внутри карточки */
        .stats-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 5px;
        }

        .stats-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 700;
        }

        /* QR код внутри статистики */
        .stats-qr-box {
            background: #fff;
            padding: 4px;
            border-radius: 8px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* --- СТИЛИ ДЛЯ ЛЕГЕНДЫ (В интерфейсе) --- */
        .stats-legend-row {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-dot {
            width: 8px; 
            height: 8px; 
            border-radius: 2px;
        }

        /* --- СТИЛЬ ДЛЯ ЭКСПОРТА (СКРИНШОТА) --- */
        /* Это то, как будет выглядеть картинка */
        #export-stats-card {
            position: fixed;
            left: -9999px; /* Скрываем за экраном */
            top: 0;
            z-index: -9999;
            
            width: 375px; /* Фиксированная ширина как у мобильника */
            background: var(--sidebar-bg); /* Темный фон */
            border: 1px solid var(--border);
            border-radius: 24px; /* Закругления */
            padding: 30px; /* Отступы внутри */
            
            display: flex;
            flex-direction: column;
            gap: 20px;
            font-family: var(--font-main);
        }

        /* Логотип в экспорте */
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(128,128,128,0.2);
            padding-bottom: 20px;
        }

        /* Убедимся, что при экспорте карточка ведет себя нормально */
        .export-clone-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            z-index: -100;
            /* Фиксированная ширина для красивой картинки, чтобы не была узкой */
            width: 600px !important; 
            max-width: none !important;
            background: #12000b; /* Фон подложки, если прозрачность глючит */
            padding: 40px !important; /* Больше отступов для красоты */
            border-radius: 0 !important; /* Квадратные края для картинки или скругленные, как угодно */
        }

        /* Принудительно растягиваем внутреннюю карточку при экспорте */
        .export-clone-container .sum-card-new {
            width: 100% !important;
            max-width: 100% !important;
            box-shadow: none !important;
            margin: 0 !important;
        }

        /* Фикс для переносов в психотипе */
        .sum-stat-box {
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
        }

        /* === STATS UPDATE === */
        /* Контейнер графика */
        .chart-wrapper {
            flex-shrink: 0 !important;
            height: 220px !important; /* Фиксированная высота */
            margin-bottom: 20px !important;
            width: 100% !important;
        }

        /* Скролл-контейнер для предпочтений */
        .chart-scroll-view {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            height: 100%;
            align-items: flex-end;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            padding-bottom: 5px; /* Отступ для скролла */
        }
        .chart-scroll-view::-webkit-scrollbar { display: none; }

        /* Колонка предпочтений (5 + немного 6-ая колонка) */
        .pref-col {
            min-width: 17%; 
            max-width: 17%;
            height: 100%; 
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 0 4px;
        }

        /* Колонка активности */
        .act-col {
            min-width: 45px; 
            margin-right: 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            height: 100%;
        }

        /* Контейнер для трех столбиков */
        .act-bars-group {
            display: flex;
            align-items: flex-end;
            gap: 3px; /* Расстояние между столбиками */
            height: 70%; /* Высота зоны столбиков */
            width: 100%;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(128,128,128,0.1);
        }

        .act-bar {
            flex: 1;
            border-radius: 2px 2px 0 0;
            min-height: 2px;
            transition: height 0.3s ease;
        }

        /* Сами бары */
        .chart-bar {
            width: 100%; 
            /* Градиент сверху вниз: от светлого акцента к основному цвету */
            background: linear-gradient(180deg, var(--accent-light) 0%, var(--accent) 100%) !important;
            border-radius: 6px 6px 0 0; /* Скругляем только верх */
            transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 4px;
            position: relative;
            margin: 0;
            /* Легкое свечение для красоты */
            box-shadow: 0 -2px 10px rgba(var(--accent), 0.3); 
        }

        /* Подписи под графиком */
        .chart-label-x {
            margin-top: 5px;
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .act-values-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 4px;
            padding: 0 2px;
        }

        .act-val {
            font-size: 8px;
            font-weight: 700;
            text-align: center;
            flex: 1;
        }

        .chart-label-x {
            margin-top: 4px;
            font-size: 9px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Цифры для активности (ПОД графиком) */
        .act-values {
            display: flex;
            gap: 5px;
            font-size: 9px;
            font-weight: 700;
            margin-top: 2px;
            color: var(--text-main);
        }

        /* === 13. PAYMENT MODAL STYLES === */
        .pay-desc {
            padding: 15px 20px 10px;
            color: var(--text-secondary);
            font-size: 13px;
            text-align: center;
            line-height: 1.4;
        }

        /* Секция промокода */
        .promo-container {
            margin: 10px 15px 20px 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .promo-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            margin-left: 5px;
        }

        .promo-input-group {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .promo-input {
            flex: 1;
            background: var(--ios-bg); /* Цвет фона как у страницы */
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            font-size: 15px;
            color: var(--text-main);
            outline: none;
            transition: border-color 0.2s;
        }

        .promo-input:focus {
            border-color: var(--accent);
        }

        .promo-btn {
            width: 44px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        .promo-btn:active {
            transform: scale(0.95);
        }

        /* === 14. LOGIN MODAL === */
        .auth-benefits {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .auth-benefits li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-main);
        }

        .auth-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--nav-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .auth-note {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 15px;
            line-height: 1.4;
            opacity: 0.7;
        }

        .btn-google {
            width: 100%;
            background: #FFFFFF;
            color: #1f1f1f;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 14px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-google:active { transform: scale(0.98); }

        /* 15. SYNC MODAL STYLES */
        .sync-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .sync-stat-item.full-width {
            grid-column: span 2;
            width: 100%;
            
            display: flex;
            flex-direction: column;
            align-items: center !important; 
            justify-content: center !important;
            text-align: center !important;
            
            padding: 20px 15px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            background: var(--ios-card);
            border-radius: 16px;
        }

        .sync-stat-item.full-width:active {
            background: var(--nav-bg);
            transform: scale(0.98);
        }

        .sync-stat-item {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .sync-stat-val {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .sync-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Анимация вращения для кнопки синхронизации */
        @keyframes spinIcon { 100% { transform: rotate(360deg); } }
        .spinning-icon { animation: spinIcon 1s linear infinite; display: inline-block; }


        /* Fetish Wrapped */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .wrapped-lock-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px dashed var(--border);
        }
        .wrapped-lock-title {
            font-size: 16px; font-weight: 800; margin-bottom: 5px;
            background: linear-gradient(45deg, #FF9900, #9B59B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }
        .wrapped-lock-desc {
            font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;
        }
        .w-progress-track {
            height: 8px; width: 100%; background: rgba(255,255,255,0.1);
            border-radius: 4px; overflow: hidden; margin-bottom: 8px;
        }
        .w-progress-fill {
            height: 100%; background: linear-gradient(90deg, #FF9900, #9B59B6);
            width: 0%; transition: width 0.5s ease;
        }
        .w-progress-text {
            font-size: 11px; font-weight: 700; color: var(--text-main);
        }

        /* WRAPPED ARCHIVE (Вкладка истории) */
        .wrapped-archive-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: var(--ios-card); margin-bottom: 1px;
            cursor: pointer; position: relative;
        }
        .wrapped-archive-item:active { background: var(--nav-bg); }
        .w-badge {
            font-size: 10px; font-weight: 800; text-transform: uppercase;
            padding: 4px 8px; border-radius: 6px; color: #000; margin-left: 10px;
        }
        .w-badge.daily { background: #bdc3c7; } /* Серый */
        .w-badge.weekly { background: #2ecc71; } /* Зеленый */
        .w-badge.monthly { background: #f1c40f; } /* Золотой */
        .w-badge.yearly { background: linear-gradient(45deg, #FF9900, #9B59B6); color: #fff; }

        /* ФИНАЛЬНАЯ КАРТОЧКА */
        .sum-card-new {
            background: rgba(20, 20, 20, 0.95); 
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 24px; 
            padding: 25px;
            width: 90%; 
            max-width: 360px;
            display: flex; 
            flex-direction: column; 
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            position: relative; 
            overflow: hidden;
        }
        .sum-logo-new { font-weight: 900; font-size: 24px; color: #fff; letter-spacing: -1px; }
        .sum-logo-new span.grad { 
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .sum-logo-new span.neutral { color: #fff; }

        .sum-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .sum-stat-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center; }
        .sum-stat-val { font-size: 22px; font-weight: 800; color: #fff; }
        .sum-stat-lbl { font-size: 10px; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 4px; }

        /* Значки достижений */
        .achievement-badge {
            width: 120px; height: 120px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
            border: 4px solid rgba(255,255,255,0.1);
        }

        /* Финальная сводка (Summary Card) */
        .summary-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            padding: 25px;
            width: 90%;
            max-width: 340px;
            text-align: left;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 0; 
            transform: translateY(20px);
            animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards 0.5s;
        }
        @keyframes slideUpFade {
            to { opacity: 1; transform: translateY(0); }
        }
        .sum-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding-bottom: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.15);
            margin-bottom: 5px;
        }
        .sum-header-left {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Логотип: Картинка + Текст */
        .sum-logo-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .sum-logo-img {
            height: 32px; 
            width: auto;
            object-fit: contain;
        }

        .sum-logo-text { 
            font-weight: 900; 
            font-size: 20px; 
            color: #fff; 
            letter-spacing: -0.5px;
            line-height: 1;
        }

        /* Цветные буквы (если не нуар) */
        .sum-logo-text span.grad { 
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Важно для некоторых браузеров */
            display: inline-block; /* Чтобы градиент не ломался */
        }

        /* Нуарная тема: всё белое */
        body[data-theme="noir"] .sum-logo-text span.grad {
            background: none !important;
            -webkit-background-clip: border-box !important;
            background-clip: border-box !important;
            -webkit-text-fill-color: #ffffff !important;
            color: #ffffff !important;
        }

        /* Подпись "Узнай себя" */
        .sum-caption {
            font-size: 10px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            font-weight: 600;
            letter-spacing: 1px;
            margin-left: 2px; /* Чуть подвинуть под текст */
        }

        /* QR Код */
        .sum-qr-box {
            background: #fff;
            padding: 4px;
            border-radius: 8px;
            width: 64px;
            height: 64px;
            flex-shrink: 0; /* Чтобы не сжимался */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sum-qr-img {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Бейджик периода в карточке */
        .sum-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            margin-top: -10px; 
        }
        .sum-logo { font-weight: 900; font-size: 18px; color: #fff; }
        .sum-date { font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; text-align: right; }
        .sum-row { display: flex; justify-content: space-between; align-items: center; }
        .sum-label { font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; font-weight: 600; }
        .sum-val { font-size: 18px; font-weight: 800; color: #fff; }
        .sum-big-val { font-size: 28px; font-weight: 900; color: #ffe600; text-shadow: 0 0 20px rgba(255, 230, 0, 0.3); }
        .sum-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .sum-tag { 
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); 
            padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #fff; font-weight: 600; 
        }

        /* --- Анимация для отложенного появления (Интрига) --- */
        @keyframes fadeInUpReveal {
            from { opacity: 0; transform: translateY(15px); filter: blur(5px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .reveal-delayed {
            opacity: 0; /* Скрыто по умолчанию */
            animation: fadeInUpReveal 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .delay-1500 { animation-delay: 1.5s; } /* Задержка 1.5 сек (для слайда сравнения) */
        .delay-3000 { animation-delay: 3.0s; } /* Задержка 3.0 сек (для психотипа) */

        /* --- Исправление переноса текста в финальной карточке --- */
        .sum-stat-box {
            /* Разрешаем перенос длинных слов */
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            
            /* Включаем расстановку дефисов (если поддерживается браузером) */
            -webkit-hyphens: auto;
            -ms-hyphens: auto;
            hyphens: auto;
            
            /* Разрешаем блоку растягиваться по высоте */
            height: auto !important; 
            min-height: 80px; /* Минимальная высота для красоты */
            
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Убеждаемся, что заголовок внутри бокса тоже не ломает верстку */
        .sum-stat-box div[style*="font-size:22px"] {
            line-height: 1.2 !important;
            margin-bottom: 5px;
        }

        /* === TINDER STYLE CONTROLS === */
        .tinder-nav-row {
            display: flex;
            align-items: center;
            justify-content: space-evenly;
            width: 100%;
            margin-top: auto;
            margin-bottom: 10px;
            gap: 15px; /* Чуть больше расстояние */
            padding: 0 5px;
        }

        .t-circle-btn {
            border: none; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: #fff !important; 
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
            
            /* Тонкая рамка для стиля */
            border: 1px solid rgba(255,255,255,0.1); 
        }

        .t-circle-btn:active {
            transform: scale(0.92);
            filter: brightness(0.9);
        }

        /* Размеры */
        .t-circle-btn.small { width: 44px; height: 44px; font-size: 20px; }
        .t-circle-btn.medium { width: 58px; height: 58px; font-size: 26px; }
        .t-circle-btn.large { width: 72px; height: 72px; font-size: 32px; }

        /* Цвета */
        .t-circle-btn.undo {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        /* 2. DISLIKE (Красный градиент) */
        .t-circle-btn.dislike {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4);
        }

        /* 3. WATCH (Цвет темы + Свечение) */
        .t-circle-btn.watch {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
            
            /* Мощное свечение */
            box-shadow: 0 0 20px var(--accent), 
                        0 0 40px var(--accent-light),
                        inset 0 0 10px rgba(255,255,255,0.5);
            
            animation: pulseGlow 2s infinite;
            z-index: 2; /* Чуть выше остальных */
            border: 1px solid rgba(255,255,255,0.3);
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 20px var(--accent); transform: scale(1); }
            50% { box-shadow: 0 0 35px var(--accent); transform: scale(1.05); }
            100% { box-shadow: 0 0 20px var(--accent); transform: scale(1); }
        }

        /* 4. LIKE (Зеленый градиент) */
        .t-circle-btn.like {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        /* 5. WATCH LATER (серый) */
        .t-circle-btn.wl {
            background: rgba(255, 255, 255, 0.15); /* Полупрозрачный серый */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary) !important;
            box-shadow: none; /* Без свечения */
            transition: all 0.2s ease;
        }

        /* При наведении или нажатии чуть светлее */
        .t-circle-btn.wl:active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* АКТИВНОЕ СОСТОЯНИЕ (Синий градиент) */
        .t-circle-btn.wl.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
            border-color: transparent !important;
            color: #ffffff !important;
            box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3);
        }

        body.light-theme .t-circle-btn.wl {
            background: rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.1);
            color: #666 !important;
        }
        body.light-theme .t-circle-btn.wl.active {
            color: #ffffff !important; 
        }

        /* Нажатие */
        .t-circle-btn:active {
            transform: scale(0.92) !important; /* Перебивает анимацию пульса */
            filter: brightness(1.1);
        }
        
        /* Disabled */
        .t-circle-btn:disabled {
            background: #bdc3c7; /* Серый */
            box-shadow: none;
            opacity: 0.7;
            cursor: default;
            transform: none !important;
        }

        /* Скрываем старые элементы, которые мы заменили */
        .tinder-actions, .btn-group, .undo-container {
            display: none !important;
        }
        
        /* Карточка должна быть Flex-колонкой для правильного размещения */
        .card {
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important;
            padding-bottom: 10px !important;
        }
        
        /* Адаптация описания, чтобы не прилипало */
        .result-description {
            margin-bottom: 20px;
        }

        /* ROADMAP STYLES */
        .roadmap-container {
            display: flex !important;
            flex-direction: column !important;
            gap: 0 !important;
            padding-bottom: 20px;
        }

        .roadmap-item {
            display: flex !important;
            gap: 15px !important;
            padding-bottom: 0 !important; 
            position: relative !important;
        }

        .roadmap-item:last-child {
            padding-bottom: 0;
        }

        /* Колонка с иконкой и линией */
        .rm-visual-col {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            width: 40px !important;
            flex-shrink: 0 !important;
        }

        /* Иконка */
        .rm-icon-box {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.05);
            z-index: 2; /* Поверх линии */
            background: var(--card-bg); /* Чтобы не просвечивала */
        }

        /* Линия-соединитель */
        .rm-line {
            width: 2px !important;
            background: var(--border) !important;
            flex-grow: 1 !important;
            min-height: 20px !important;
            margin-top: -5px !important;
            margin-bottom: -5px !important;
        }

        .roadmap-item:last-child .rm-line {
            display: none !important;
        }


        /* Контент */
        .rm-content {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 25px !important;
        }

        .rm-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 5px;
        }

        .rm-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 5px !important;
        }

        /* Кнопка-капсула с плюсом */
        .btn-capsule-plus {
            width: 60%; /* Ширина как у второстепенных кнопок */
            max-width: 200px;
            height: 44px;
            border-radius: 22px;
            background: transparent;
            border: 1px solid var(--border); /* Тонкая обводка */
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 auto;
            padding-bottom: 4px; /* Выравнивание плюса */
        }

        /* Активное состояние кнопки (когда открыто) */
        .btn-capsule-plus.active {
            background: var(--nav-bg);
            border-color: var(--accent);
            color: var(--accent);
            transform: scale(0.98);
        }

        /* Анимация иконки плюса */
        .btn-capsule-plus span {
            transition: transform 0.3s ease;
            display: block;
            line-height: 1;
        }

        /* Поворот плюса в крестик */
        .btn-capsule-plus.active span {
            transform: rotate(45deg);
        }

        /* Контейнер с модификаторами */
        #mod-container {
            width: 100%;
            max-height: 0; /* Высота 0 скрывает контент */
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 0;
            padding: 0 10px; /* Немного отступа по бокам */
            visibility: hidden; /* Скрываем от кликов */
        }

        .mods-wrapper-expanded.open #mod-container {
            max-height: 500px; 
            opacity: 1;
            margin-top: 40px; 
            padding-bottom: 15px;
            visibility: visible;
        }

        /* Состояние "Открыто" */
        #mod-container.open {
            max-height: 300px; /* Достаточно для всех тегов */
            opacity: 1;
            margin-top: 15px;
            padding-bottom: 10px;
        }

        #mods-block {
            width: 100%;
            padding: 0 15px; 
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }


        .mods-wrapper-expanded {
            position: relative;
            width: 60px; 
            height: 44px; 
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            margin: 10px auto 0 auto;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 10;
        }

        /* Иконка (Плюс -> Крестик) */
        .mods-icon-plus {
            position: absolute;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 300;
            color: var(--text-secondary);
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            
            /* ЦЕНТР (Закрыто) */
            top: 50%;
            right: 50%;
            transform: translate(50%, -50%);
        }

        /* Контент тегов (Список) */
        .mods-content {
            opacity: 0;
            width: 100%;
            padding: 45px 15px 20px 15px; /* Сверху отступ под крестик */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            transform: translateY(20px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none; /* Чтобы не кликалось в закрытом */
            visibility: hidden; /* Скрываем полностью */
        }

        /* === СОСТОЯНИЕ OPEN (ОТКРЫТО) === */
        .mods-wrapper-expanded.open {
            width: 100% !important; 
            max-width: 100%; 
            height: auto;
            min-height: 160px;
            background: var(--ios-card);
            border-color: var(--accent);
            border-radius: 24px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            margin-top: 5px;
        }

        /* Крестик улетает в угол */
        .mods-wrapper-expanded.open .mods-icon-plus {
            color: var(--highlight-red);
            top: 15px;
            right: 15px;
            left: auto; 
            transform: rotate(45deg);
        }

        .mods-wrapper-expanded.open .mods-content {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }

        /* Заголовок в выпадающем окне карточки */
        .mods-header {
            width: 100%;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            opacity: 0.7;
        }

        /* Чипы в модальном окне настроек */
        .mod-chip {
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border: 1px solid transparent;
            
            /* Flex для красивого выравнивания иконок */
            display: inline-flex; 
            align-items: center;
            gap: 6px; /* Отступ между текстом и иконками */
        }

        .custom-mod-del:hover {
            color: #fff !important;
            transform: scale(1.2);
        }

        /* Активные (Зеленые) */
        .mod-chip.active {
            background: rgba(46, 204, 113, 0.15);
            color: #2ecc71;
            border-color: rgba(46, 204, 113, 0.3) !important;
        }

        .mod-chip.active::after {
            content: none !important;
        }

        /* Неактивные (Серые) */
        .mod-chip.inactive {
            background: var(--ios-card);
            color: var(--text-secondary);
            border-color: var(--border);
            opacity: 0.8;
        }
        .mod-chip.inactive:hover {
            opacity: 1;
            background: var(--nav-bg);
        }

        .custom-mod-del {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.1);
            color: var(--highlight-red);
            font-size: 10px;
            margin-left: 4px;
            transition: all 0.2s;
        }

        .custom-mod-del:hover {
            background: var(--highlight-red);
            color: #fff;
            transform: scale(1.2);
        }

        /* Обновленный стиль тегов */
        .tag {
            padding: 8px 14px;
            border-radius: 12px;
            background: var(--bg-color);
            border: 1px solid var(--border);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: 0.2s;
            cursor: pointer;
            user-select: none;
        }
        .tag:active {
            transform: scale(0.95);
        }
        .tag.selected {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .swipe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            
            /* Лежит поверх всего контента */
            z-index: 50 !important; 
            
            /* Скругляем углы под карточку */
            border-radius: 28px;
            
            pointer-events: none; 
            opacity: 1 !important; /* Управляем цветом через RGBA, а не opacity */
            background-color: transparent; /* По умолчанию прозрачный */
            transition: background-color 0.1s linear;
        }

        /* Верхняя часть (Бейджи) */
        .card > div:nth-child(2) { 
            z-index: 15; 
            padding-top: 20px;
            flex: 0 0 auto; /* Не сжимать */
        }

        /* ЦЕНТРАЛЬНАЯ ЧАСТЬ (Слот + Описание) */
        .card > div:nth-child(3) {
            z-index: 15;
            flex: 1 1 auto; /* Резиновая: может сжиматься и расти */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Чтобы длинное описание не ломало верстку */
            padding: 0 15px;
        }

        #onb-input {
            flex-shrink: 0 !important; /* Запрещаем сжимать поле ввода */
        }
        
        #onb-tags-container {
            max-height: 25vh; /* Ограничиваем высоту списка тегов */
            overflow-y: auto; /* Добавляем прокрутку, если тегов много */
            padding: 5px;
        }
        
        /* Скрываем скроллбар для красоты */
        #onb-tags-container::-webkit-scrollbar { display: none; }

        .version-tag {
                font-size: 11px;
                font-weight: 500;
                
                /* Сброс градиента */
                background: none !important;
                -webkit-text-fill-color: var(--text-secondary) !important; 
                color: var(--text-secondary) !important;
                
                opacity: 0.5;
                margin-left: 6px;
                
                /* Выравнивание */
                position: relative;
                top: 5px; /* Сдвигаем вниз от центральной линии */
            }

        /* Общий стиль для иконок */
        .deco-icon {
            position: absolute;
            z-index: 99 !important; 
            pointer-events: none; /* Клики проходят сквозь них */
            will-change: transform;
            transition: filter 0.3s ease; /* Плавная смена цвета при смене темы */
        }

        /* --- 1. ТЁМНАЯ ТЕМА (По умолчанию) --- */
        /* Исходники черные -> инвертируем в белые + белая тень */
        .deco-icon {
            /* invert(1) делает черное белым */
            filter: invert(1) drop-shadow(0 0 10px rgba(255, 255, 255, 0.4));
            opacity: 0.9;
        }

        /* --- 2. СВЕТЛАЯ ТЕМА --- */
        /* Исходники черные -> оставляем черными (invert 0) + темная тень */
        body.light-theme .deco-icon {
            filter: invert(0) drop-shadow(0 5px 15px rgba(0, 0, 0, 0.15));
            opacity: 0.8; 
        }

        /* АНИМАЦИИ ПАРЕНИЯ */
        @keyframes floatLeft {
            0% { transform: translate3d(0, 0, 0) rotate(-20deg) scale(1); }
            50% { transform: translate3d(-8px, -12px, 0) rotate(-15deg) scale(1.05); }
            100% { transform: translate3d(0, 0, 0) rotate(-20deg) scale(1); }
        }

        @keyframes floatRight {
            0% { transform: translate3d(0, 0, 0) rotate(15deg) scale(1); }
            50% { transform: translate3d(8px, -12px, 0) rotate(20deg) scale(1.05); }
            100% { transform: translate3d(0, 0, 0) rotate(15deg) scale(1); }
        }

        .icon-left {
            width: 140px;
            top: -40px; 
            left: -20px;
            animation: floatLeft 6s ease-in-out infinite;
        }

        .icon-right {
            width: 110px;
            top: -20px;
            right: -10px;
            animation: floatRight 7s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .icon-left {
                width: 75px !important;  
                top: 5px !important;    
                left: -5px !important;  
            }

            .icon-right {
                width: 60px !important;  
                top: 15px !important;   
                right: 0px !important;  
            }
        }

        body.no-deco .deco-icon {
            display: none !important;
        }

        /* === BESTIE PLAN STYLES === */
        .plan-card.bestie {
            border: 2px solid #00d2ff; /* Яркий голубой бордюр */
            background: linear-gradient(165deg, rgba(0, 210, 255, 0.1), rgba(58, 123, 213, 0.05));
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.15);
            order: -1; /* На мобильных ставим его первым, чтобы заметили */
        }

        @media (min-width: 769px) {
            .plan-card.bestie { order: 0; }
        }

        .plan-card.bestie .plan-title {
            background: linear-gradient(to right, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #00d2ff;
        }

        .bestie-badge {
            position: absolute;
            top: 0; right: 0;
            background: #00d2ff;
            color: #000;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-bottom-left-radius: 12px;
        }

        .modal-header-actions {
            position: absolute !important;
            right: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            z-index: 20 !important;
        }

        /* Общий стиль для круглых кнопок (Крестик и Поделиться) */
        .icon-btn-round {
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            background: rgba(128, 128, 128, 0.15) !important;
            color: var(--text-secondary) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 16px !important;
            cursor: pointer !important;
            transition: background 0.2s !important;
        }

        .icon-btn-round:hover {
            background: var(--nav-bg) !important;
            color: var(--text-main) !important;
        }

        /* Стили для счетчика (Scarcity Bar) */
        .limit-container {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .limit-labels {
            display: flex; 
            justify-content: space-between; 
            font-size: 11px; 
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .limit-track {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .limit-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            width: 94%; /* 47 из 50 */
            box-shadow: 0 0 10px #00d2ff;
            animation: pulseBar 2s infinite;
        }

        @keyframes pulseBar {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .plan-btn.bestie-btn {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        }

        /* === NOTCH & BORDER STYLES === */

        /* Базовый стиль чёлки */
        .card-notch {
            position: absolute;
            top: 12px; /* Отступ от верхнего края карточки */
            left: 50%;
            /* В скрытом состоянии она чуть меньше и прозрачная */
            transform: translateX(-50%) scale(0.8);
            opacity: 0;
            
            padding: 4px 14px;
            border-radius: 50px; /* Полная капсула */
            
            font-size: 10px; /* Чуть компактнее текст */
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #fff;
            
            z-index: 40;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            
            /* Плавное появление (масштаб + прозрачность) */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s ease, 
                        background-color 0.2s;
            pointer-events: none;
        }

        /* Класс для показа чёлки */
        .card-notch.visible {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }

        /* --- ВАРИАНТ 1: WATCH LATER (Синий) --- */
        .card.status-wl {
            border: 2px solid #3498db !important;
            box-shadow: 0 0 25px rgba(52, 152, 219, 0.15) !important;
        }
        .card.status-wl .card-notch {
            background: #3498db;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        /* --- ВАРИАНТ 2: FAVORITE (Зеленый) --- */
        .card.status-fav {
            border: 2px solid #2ecc71 !important;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.15) !important;
        }
        .card.status-fav .card-notch {
            background: #2ecc71;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }

        /* --- ВАРИАНТ 3: DISLIKED (Красный) - на случай просмотра истории --- */
        .card.status-ban {
            border: 2px solid #e74c3c !important;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.15) !important;
        }
        .card.status-ban .card-notch {
            background: #e74c3c;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        /* === 1. MODE CAPSULE (DROPDOWN STYLE) === */
        .mode-capsule-wrapper {
            position: relative;
            z-index: 100;
            display: none; /* Скрыто по умолчанию (пока нет 10 действий) */
        }

        /* Стиль самой кнопки-капсулы */
        .mode-capsule-btn {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .mode-capsule-btn:active, .mode-capsule-wrapper.open .mode-capsule-btn {
            background: var(--nav-bg);
            color: var(--text-main);
            border-color: var(--accent);
        }

        /* Выпадающий список */
        .mode-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            width: 160px;
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 6px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mode-capsule-wrapper.open .mode-dropdown {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(5px);
        }

        .mode-item {
            padding: 10px 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .mode-item:hover, .mode-item:active {
            background: var(--nav-bg);
            color: var(--text-main);
        }

        .mode-item.active {
            background: rgba(155, 89, 182, 0.1); /* Акцент */
            color: var(--accent);
        }

        /* === 2. START SCREEN (CARD OVERLAY) === */
        .mode-start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-gradient);
            z-index: 50; /* Перекрывает всё внутри карточки */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between !important;
            padding: 40px 20px 30px 20px !important;
            transition: opacity 0.3s;
        }

        .mode-start-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .mode-greeting-text {
            font-size: clamp(24px, 5vw, 36px) !important; 
            font-weight: 800 !important;
            line-height: 1.2 !important; 
            text-align: center;
            color: var(--text-main);
            
            margin-top: auto; 
            margin-bottom: auto;
            max-width: 95%; 
            
            transition: opacity 0.3s ease;
        }

        .mode-buttons-circle-row {
            display: flex;
            justify-content: center;
            gap: 25px;
            width: 100%;
            margin-top: auto; 
            margin-bottom: 10px;
        }

        .mode-circle-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            border: none !important;
            font-size: 32px;
            
            /* Тень и позиционирование */
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            color: #fff; /* Эмодзи всегда яркие */
            
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .mode-circle-btn:active {
            transform: scale(0.92);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* === 3. РАСПОЛОЖЕНИЕ КАПСУЛЫ (PC vs MOBILE) === */

        /* По умолчанию (Mobile): Капсула под хедером */
        #mobile-mode-mount {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: -15px !important; 
            margin-bottom: 25px !important;
            position: relative;
            z-index: 60;
        }

        #pc-mode-mount {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 15px; 
            border-top: none !important;
            padding-top: 0 !important;
        }

        /* PC ВЕРСИЯ */
        @media (min-width: 769px) {
            #mobile-mode-mount {
                display: none !important; /* Скрываем мобильную версию */
            }

            #pc-mode-mount {
                display: flex;
                width: 100%;
                margin-top: auto; /* Прижимаем к низу сайдбара (или куда вам нужно) */
                padding-top: 20px;
                border-top: 1px solid var(--border);
            }
            
            /* Капсула на ПК растягивается или имеет свой стиль */
            #pc-mode-mount .mode-capsule-btn {
                width: auto; 
                min-width: 140px;
                justify-content: center;
            }
        }

        /* === AI ASSISTANT MODE STYLES === */

        .mode-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px; 
            width: 100%;
            margin-top: auto;
            margin-bottom: 20px;
        }

        .mode-circle-btn {
            border-radius: 50%;
            border: none !important; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            transition: transform 0.1s, background 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .mode-circle-btn:active {
            transform: scale(0.92);
        }

        .mode-circle-btn.center-btn {
            width: 85px;
            height: 85px;
            font-size: 40px;
            z-index: 10;
            /* Градиент по умолчанию */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 10px 30px rgba(118, 75, 162, 0.5);
        }

        .mode-circle-btn.side-btn {
            width: 60px;
            height: 60px;
            font-size: 26px;
            z-index: 5;
        }

        .mode-circle-btn.explore {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }

        .mode-circle-btn.pleasure {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
        }

        

        /* UI ВВОДА ЗАПРОСА (Скрыт по умолчанию) */
        .assistant-ui {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: var(--card-gradient);
            z-index: 60;
            padding: 20px;
            opacity: 0;
            transform: scale(0.9) translateY(20px); 
            transition: 
                opacity 0.4s ease,
                transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            
            pointer-events: none;
        }

        .assistant-ui.visible {
            display: flex;
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }

        .fade-out-up {
            opacity: 0 !important;
            transform: translateY(-30px) scale(0.9) !important;
            pointer-events: none !important;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .assistant-prompt {
            font-size: 24px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-main);
            line-height: 1.2;
        }

        .assistant-input-group {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            width: 100%;
            
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 5px 5px 5px 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .assistant-input {
            flex: 1; 
            background: transparent !important;
            border: none;
            outline: none;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            padding: 10px 0;
            margin-right: 10px; 
        }
        .assistant-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .btn-mic-trigger {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; 
        }
        .btn-mic-trigger.listening {
            background: #e74c3c;
            animation: pulseMic 1.5s infinite;
        }

        @keyframes pulseMic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .btn-ai-confirm {
            background: #fff;
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            
            opacity: 0;
            pointer-events: none;
            transform: translateY(15px);
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .btn-ai-confirm.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .btn-ai-confirm:active {
            transform: translateY(10px) scale(0.95) !important;
        }

        .btn-ai-cancel {
            margin-top: 20px;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-ai-cancel:active {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }


        /* АНИМАЦИЯ "ДУМАЮ..." */
        .thinking-ui {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 70;
            background: var(--card-gradient);
        }
        .thinking-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .ai-icon-img {
            width: 45px;
            height: 45px;
            object-fit: contain;
            pointer-events: none; /* Чтобы клик проходил сквозь картинку на кнопку */
            
            /* По умолчанию (Темная тема) -> Инвертируем черный в белый */
            filter: invert(1) drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease;
        }

        .ai-hint-text {
            display: block;
            margin-top: 15px; /* Отступ сверху побольше */
            font-size: 14px;  /* Было ~10px (0.65em), стало крупнее */
            font-weight: 600; /* Жирнее */
            opacity: 0.9;     /* Ярче (было 0.8) */
            line-height: 1.4;
            color: var(--text-secondary);
        }

        /* Светлая тема -> Оставляем черным */
        body.light-theme .ai-icon-img {
            filter: invert(0) drop-shadow(0 0 2px rgba(0, 0, 0, 0.1));
        }

        .mode-circle-btn.center-btn.ai-assist {
            /* Адаптивный градиент темы */
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%) !important;
            
            /* Тонкая белая обводка для контраста */
            border: 2px solid rgba(255, 255, 255, 0.4) !important;
            
            /* Начальная тень */
            box-shadow: 0 0 20px var(--accent), 
                        0 0 40px var(--accent-light);
            
            /* Анимация пульсации */
            animation: aiPulseGlow 2s infinite ease-in-out;
            z-index: 10;
        }

        .rolling-input-overlay {
            position: absolute;
            top: 0;
            left: 15px; 
            height: 100%;
            width: 80%;
            pointer-events: none;
            display: flex;
            align-items: center;
            overflow: hidden;
            opacity: 0.6;
            transition: opacity 0.2s;
            z-index: 1;
        }

        /* Скрываем подсказки, когда пользователь печатает */
        .assistant-input:focus + .rolling-input-overlay,
        .assistant-input:not(:placeholder-shown) ~ .rolling-input-overlay, 
        .rolling-input-overlay.hidden {
            opacity: 0 !important;
        }

        .assistant-input:focus ~ .rolling-input-overlay {
            opacity: 0;
        }

        .rolling-list {
            display: flex;
            flex-direction: column;
        }

        .rolling-item {
            height: 50px; 
            display: flex;
            align-items: center;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            font-style: italic;
        }

        /* Анимация прокрутки */
        @keyframes scrollPrompts {
            0%, 15% { transform: translateY(0); }
            20%, 35% { transform: translateY(-50px); }
            40%, 55% { transform: translateY(-100px); }
            60%, 75% { transform: translateY(-150px); }
            80%, 95% { transform: translateY(-200px); }
            100% { transform: translateY(-250px); } 
        }

        .animate-scroll {
            animation: scrollPrompts 12s cubic-bezier(0.6, 0.0, 0.4, 1.0) infinite;
        }


        /* Анимация свечения (масштаб + тень) */
        @keyframes aiPulseGlow {
            0% {
                box-shadow: 0 0 15px var(--accent);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 35px var(--accent), 0 0 50px var(--accent-light);
                transform: scale(1.05); /* Легкое увеличение */
            }
            100% {
                box-shadow: 0 0 15px var(--accent);
                transform: scale(1);
            }
        }

        /* При нажатии чуть уменьшаем, но сохраняем градиент */
        .mode-circle-btn.center-btn.ai-assist:active {
            transform: scale(0.95) !important;
            animation: none; /* Пауза анимации при клике */
        }

        /* Спец. стиль для темы NOIR (Черно-белая) */
        body[data-theme="noir"] .mode-circle-btn.center-btn.ai-assist {
            background: #000000 !important;
            border: 2px solid #ffffff !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5) !important;
        }

        /* иконка для боковых кнопок (scope.png, favorite.png) */
        .side-icon-img {
            width: 32px;  /* Чуть меньше, чем центральная (45px) */
            height: 32px;
            object-fit: contain;
            pointer-events: none;
            
            /* Темная тема (Default): Инвертируем черный в белый + тень */
            filter: invert(1) drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease;
        }

        .mode-circle-btn.explore .side-icon-img {
            transform: scaleX(-1);
        }

        /* Стили для иконок внутри кнопок действий */
        .action-icon-img {
            width: 50%;
            height: 50%;
            object-fit: contain;
            pointer-events: none;
            
            /* Темная тема (Default): Инвертируем черный в белый */
            filter: invert(1);
            transition: filter 0.3s ease;
        }

        /* Кнопка WATCH: Всегда белая иконка (т.к. фон цветной) */
        .t-circle-btn.watch .action-icon-img {
            filter: brightness(0) invert(1) !important;
            width: 45%; /* Чуть меньше для Play */
            height: 45%;
            margin-left: 2px; /* Визуальная коррекция для треугольника */
        }

        /* Светлая тема: Иконки черные (кроме Watch) */
        body.light-theme .action-icon-img {
            filter: invert(0);
        }
        body.light-theme .t-circle-btn.watch .action-icon-img {
            filter: brightness(0) invert(1) !important; /* Оставляем белой */
        }

        /* Watch Later ACTIVE: Когда кнопка синяя, иконка должна быть белой */
        .t-circle-btn.wl.active .action-icon-img {
            filter: brightness(0) invert(1) !important;
        }

        /* Тема NOIR */
        body[data-theme="noir"] .action-icon-img {
            filter: invert(1) !important;
        }
        /* В Noir при нажатии фон белый, иконка должна стать черной */
        body[data-theme="noir"] .t-circle-btn:active .action-icon-img,
        body[data-theme="noir"] .t-circle-btn.active .action-icon-img {
            filter: invert(0) !important;
        }

        body.light-theme .side-icon-img {
            filter: invert(0) drop-shadow(0 0 2px rgba(0, 0, 0, 0.1));
        }

        body[data-theme="noir"] .side-icon-img {
            filter: invert(1) !important;
        }
        body[data-theme="noir"] .mode-circle-btn:active .side-icon-img {
            filter: invert(0) !important;
        }

        .voice-icon-img {
            width: 24px; /* Чуть меньше кнопки */
            height: 24px;
            object-fit: contain;
            pointer-events: none;
            
            /* Темная тема (Default): Инвертируем черный в белый */
            filter: invert(1) drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease, transform 0.2s;
        }

        /* Светлая тема: Оставляем черным */
        body.light-theme .voice-icon-img {
            filter: invert(0) opacity(0.7);
        }

        /* Анимация при записи (Красное свечение) */
        .btn-mic-trigger.listening .voice-icon-img {
            filter: invert(1) drop-shadow(0 0 8px #e74c3c) !important;
            transform: scale(1.1);
        }

        /* =========================================
        ИКОНКИ НАСТРОЕК И СТРЕЛКИ
        ========================================= */

        /* Стили для иконок слева (png) */
        .settings-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-right: 12px; /* Отступ от иконки до текста */
            flex-shrink: 0;
            
            /* По умолчанию (Темная тема): Инвертируем черные PNG в белые */
            filter: invert(1);
            opacity: 0.9;
            transition: filter 0.3s, opacity 0.3s;
        }

        /* Светлая тема: Оставляем черными (как в оригинале) */
        body.light-theme .settings-icon {
            filter: invert(0);
            opacity: 0.65;
        }

        /* Обертка для левой части (Иконка + Текст), чтобы они стояли в ряд */
        .ios-row-left {
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* --- CSS СТРЕЛКА (Вместо эмодзи ›) --- */
        .chevron {
            width: 8px;
            height: 8px;
            border-top: 2px solid var(--text-secondary);
            border-right: 2px solid var(--text-secondary);
            transform: rotate(45deg);
            margin-left: 8px;
            opacity: 0.6;
        }

        /* Стрелка вниз (для выпадающих списков, если нужно) */
        .chevron-down {
            width: 8px;
            height: 8px;
            border-bottom: 2px solid var(--text-secondary);
            border-right: 2px solid var(--text-secondary);
            transform: rotate(45deg);
            margin-left: 8px;
            opacity: 0.6;
            margin-bottom: 3px;
        }

        /* Убираем старые эмодзи в тексте, если они где-то остались в HTML */
        .ios-row span {
            display: inline-flex;
            align-items: center;
        }

        /* --- INTENSITY TOAST POPUP --- */
        #intensity-toast {
            position: absolute;
            top: 45px;
            left: 0;
            width: 100%; 
            padding: 0 5px;
            
            font-size: 11px; 
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            
            pointer-events: none;
            opacity: 0;
            white-space: nowrap;
            z-index: 20;
            
            transition: opacity 0.2s; 
        }

        /* Цвета и свечение (Neon Text) */
        .toast-safe {
            color: #2ecc71; /* Зеленый */
            text-shadow: 0 0 15px rgba(46, 204, 113, 0.6), 0 0 30px rgba(46, 204, 113, 0.2);
        }

        .toast-spicy {
            color: #f1c40f; /* Желто-оранжевый */
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.6), 0 0 30px rgba(241, 196, 15, 0.2);
        }

        .toast-extreme {
            color: #ff004c; /* Агрессивный красный */
            text-shadow: 0 0 15px rgba(255, 0, 76, 0.8), 0 0 40px rgba(255, 0, 76, 0.4);
        }

        /* Новая анимация: Появление снизу-вверх и растворение */
        @keyframes floatUpSimple {
            0% {
                opacity: 0;
                transform: translateY(5px) scale(0.9); /* Чуть ниже и меньше */
            }
            20% {
                opacity: 1;
                transform: translateY(0) scale(1);     /* Нормальная позиция */
            }
            80% {
                opacity: 1;
                transform: translateY(0) scale(1);     /* Пауза */
            }
            100% {
                opacity: 0;
                transform: translateY(-10px) scale(1); /* Улетает вверх */
            }
        }

        .anim-toast {
            animation: floatUpSimple 1.0s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        #intensity-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            outline: none;
            cursor: pointer;
            background: var(--border);
            display: block;
        }

        #intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            margin-top: -1px;
        }

        .slider-container {
            width: 100%;
            padding: 0 5px;
            position: relative;
            margin-top: 5px !important; 
            margin-bottom: 0px;
        }

        .slider-narrow-wrapper {
            width: 85%;
            margin: 5px auto 5px auto !important; 
            position: relative;
            overflow: visible; 
            padding: 0 !important; 
            height: auto !important;
        }

        /* Иконки под слайдером */
        .intensity-labels-icons {
            display: flex;
            justify-content: space-between;
            padding: 0 2px;
        }

        /* Боксы иконок */
        .int-icon-box {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .int-icon-wrapper {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .int-icon-wrapper:active {
            transform: scale(0.9);
        }

        .int-icon {
            width: 20px; 
            height: 20px;
            object-fit: contain;
            transition: all 0.3s ease;
            
            filter: invert(1);
            opacity: 0.3;
        }

        body.light-theme .int-icon {
            filter: invert(0);
            opacity: 0.8;
        }

        body[data-theme="noir"] .int-icon.active-safe,
        body[data-theme="noir"] .int-icon.active-spicy,
        body[data-theme="noir"] .int-icon.active-extreme {
            filter: invert(1) !important;
            opacity: 1;
            transform: scale(1.15);
        }

        /* --- ИКОНКА СБРОСА (КРАСНАЯ) --- */
        .settings-icon.red-icon {
            filter: invert(36%) sepia(83%) saturate(1963%) hue-rotate(339deg) brightness(96%) contrast(87%) !important;
            opacity: 1 !important;
        }

        /* --- ЦВЕТА ДЛЯ АКТИВНЫХ ИКОНОК --- */

        /* 1. SAFE (Зеленый #2ecc71) */
        .int-icon.active-safe {
            filter: invert(68%) sepia(61%) saturate(452%) hue-rotate(97deg) brightness(89%) contrast(85%) !important;
            opacity: 1;
            transform: scale(1.2);
        }

        /* 2. SPICY (Оранжевый #f39c12) */
        .int-icon.active-spicy {
            filter: invert(77%) sepia(33%) saturate(5427%) hue-rotate(357deg) brightness(101%) contrast(90%) !important;
            opacity: 1;
            transform: scale(1.2);
        }

        /* 3. EXTREME (Красный #e74c3c) */
        .int-icon.active-extreme {
            filter: invert(43%) sepia(97%) saturate(1874%) hue-rotate(338deg) brightness(96%) contrast(89%) !important;
            opacity: 1;
            transform: scale(1.2);
        }

        #hist-list-swipes .ios-row, 
        #hist-list-watch .ios-row,
        #hist-list-wrapped .wrapped-archive-item {
            border-radius: 16px !important;
            margin-bottom: 8px !important; /* Отступ между карточками */
            border: 1px solid var(--border) !important; /* Легкая обводка для красоты */
        }

        /* Убираем линию-разделитель, так как теперь у нас отдельные карточки */
        #hist-list-swipes .ios-row::after,
        #hist-list-watch .ios-row::after {
            display: none !important;
        }

        /* 2. РОАДМАП (Выравнивание и отступы) */
        .roadmap-item {
            align-items: center !important; /* Иконки по центру вертикально */
            margin-bottom: 25px !important; /* Отступ между пунктами */
        }

        .rm-content {
            display: flex !important;
            flex-direction: column !important;
            gap: 6px !important; /* Отступ между Заголовком и Описанием */
        }

        .rm-line {
            display: none !important;
        }

        /* 3. ЗАЛ СЛАВЫ (Отступы) */
        #sponsors-list {
            margin-right: 15px !important; /* Добавляем отступ справа */
            width: auto !important;
        }

        /* PANIC SETTINGS STYLES */
        .panic-key-box {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.2s;
            user-select: none;
        }
        .panic-key-box:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-secondary);
        }
        .panic-key-box.recording {
            border-color: var(--accent);
            background: rgba(255, 0, 204, 0.1); /* Pink tint */
            animation: pulseBorder 1.5s infinite;
        }
        .panic-key-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .panic-key-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
            font-family: monospace;
        }
        .panic-note {
            font-size: 12px; 
            color: var(--text-secondary); 
            line-height: 1.5; 
            margin-bottom: 20px; 
            text-align: center;
        }
        .panic-highlight {
            color: var(--text-main);
            font-weight: 700;
        }

        @keyframes pulseBorder {
            0% { border-color: var(--accent); }
            50% { border-color: transparent; }
            100% { border-color: var(--accent); }
        }

        /* --- НОВЫЙ СТИЛЬ EXPLORED BAR --- */
        .explored-row {
            padding: 12px 16px;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important; /* Центрируем по вертикали бар и иконку */
            min-height: 50px;
            border-bottom: 1px solid rgba(128,128,128,0.1);
        }

        .explored-left {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        /* Правая часть: Бар + Цифры */
        .explored-right {
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            width: 140px; /* Фиксированная ширина */
            position: relative;
        }

        /* Трек бара */
        .explored-track {
            width: 100%;
            height: 8px; /* Чуть толще для красоты */
            background: var(--nav-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 4px; /* Отступ до цифр */
        }

        /* Заливка */
        .explored-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), #9b59b6);
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 0 10px var(--accent); /* Легкое свечение */
        }

        /* Контейнер для цифр под баром */
        .explored-nums-container {
            position: relative;
            width: 100%;
            height: 14px; /* Высота под шрифт */
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* Бегущая цифра (Текущее) */
        #ex-current {
            position: absolute;
            top: 0;
            left: 0; /* Будет меняться через JS */
            transform: translateX(-50%); /* Центрируем относительно конца полоски */
            transition: left 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            color: var(--text-main); /* Ярче */
            white-space: nowrap;
        }

        /* Статичная цифра (Всего) */
        #ex-total-label {
            position: absolute;
            top: 0;
            right: 0;
            opacity: 0.6;
        }

        /* --- Сетка категорий --- */
        .explored-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 колонки */
            gap: 12px;
            padding-bottom: 20px;
        }

        /* --- Карточка категории --- */
        .ex-card {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: transform 0.2s;
            overflow: hidden;
        }

        .ex-card:active {
            transform: scale(0.98);
        }

        /* Иконка сверху по центру */
        .ex-card-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 10px;
            /* Инверсия для темной темы, если иконки черные */
            filter: invert(1) drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            transition: filter 0.3s;
        }

        body.light-theme .ex-card-icon {
            filter: invert(0) drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        /* Название категории */
        .ex-card-title {
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-main);
            margin-bottom: 8px;
            text-align: center;
        }

        /* Прогресс-бар контейнер */
        .ex-progress-track {
            width: 100%;
            height: 6px;
            background: rgba(128,128,128,0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 5px;
        }

        /* Прогресс-бар заливка */
        .ex-progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Текст статистики (снизу) */
        .ex-card-stats {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        /* --- СТИЛЬ ДЛЯ ПОЛНОСТЬЮ ОТКРЫТЫХ (ЗЕЛЕНЫЙ) --- */
        .ex-card.completed {
            border: 1px solid #2ecc71;
            background: rgba(46, 204, 113, 0.1); /* Легкий зеленый фон */
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.2);
        }

        .ex-card.completed .ex-progress-fill {
            background: #2ecc71; /* Зеленая полоска */
        }

        .ex-card.completed .ex-card-title {
            color: #2ecc71;
        }

        .ex-card.completed .ex-card-icon {
            /* Зеленое свечение иконки */
            filter: invert(1) sepia(1) saturate(5) hue-rotate(80deg) drop-shadow(0 0 5px #2ecc71); 
        }
        /* Коррекция для светлой темы для completed */
        body.light-theme .ex-card.completed .ex-card-icon {
            filter: invert(0) sepia(1) saturate(5) hue-rotate(80deg);
        }

        .ex-date {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Показываем дату только если выполнено */
        .ex-card.completed .ex-date {
            opacity: 1;
            color: #2ecc71; /* Зеленый цвет */
        }

        /* --- СТИЛИ ДЛЯ ПОЛЕЗНОСТЕЙ (TIPS) --- */

        /* Сетка: 2 колонки */
        .tips-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 колонки */
            gap: 12px;
            padding-bottom: 20px;
        }

        /* Карточка-контейнер */
        .tip-card {
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            overflow: hidden; /* Чтобы шапка не вылезала */
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            aspect-ratio: 0.8; /* Чуть вытянутый прямоугольник (близко к 4:3 вертикально) */
            cursor: pointer;
            transition: transform 0.2s;
            background: var(--ios-card); /* Подложка */
        }

        .tip-card:active {
            transform: scale(0.96);
        }

        /* 1/3 Сверху: Цветная шапка */
        .tip-card-header {
            height: 35%; /* Треть высоты */
            width: 100%;
            /* Фон задается через JS (градиент) */
        }

        /* 2/3 Снизу: Нейтральное стекло */
        .tip-card-body {
            height: 65%;
            width: 100%;
            position: relative; /* Для позиционирования иконки */
            padding: 12px;
            display: flex;
            flex-direction: column;
            
            /* Стеклянный нейтральный фон */
            background: var(--ios-card); 
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.05), transparent);
        }

        /* Иконка (Эмодзи) */
        .tip-card-icon {
            position: absolute;
            top: -22px; /* Поднимаем вверх, чтобы села на границу */
            left: 12px; /* Слева */
            font-size: 36px; /* Крупный размер */
            line-height: 1;
            z-index: 2;
            /* Тень для контраста на фоне границы */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
        }

        /* Заголовок */
        .tip-card-title {
            margin-top: 18px; /* Отступ сверху, чтобы не наехать на иконку */
            font-size: 13px;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1.2;
            margin-bottom: 6px;
        }

        /* Описание */
        .tip-card-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.35;
            font-weight: 500;
            
            /* Обрезаем лишнее */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tip-card.viewed {
            opacity: 0.5;
            transform: scale(0.98);
            order: 1;
            filter: grayscale(0.5); 
        }

        /* Текст заголовка "Стань гуру" (маленький и серый) */
        .tips-guru-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            opacity: 0.7;
        }

        /* =========================================
        DYNAMIC LOGO GRADIENTS PER THEME 
        ========================================= */

        /* Базовые настройки для текста-градиента */
        .logo span, 
        .sum-logo-text span.grad {
            display: inline-block; /* Важно для корректной отрисовки */
            color: transparent;    /* На случай, если градиент не загрузится */
        }

        /* --- 1. BLUE (Midnight / Sky) --- */
        body[data-theme="blue-dark"] .logo span,
        body[data-theme="blue-light"] .logo span,
        body[data-theme="blue-dark"] .sum-logo-text span.grad,
        body[data-theme="blue-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #64ffda 0%, #2563eb 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 2. GREEN (Forest / Mint) --- */
        body[data-theme="green-dark"] .logo span,
        body[data-theme="green-light"] .logo span,
        body[data-theme="green-dark"] .sum-logo-text span.grad,
        body[data-theme="green-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #86efac 0%, #16a34a 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 3. RED (Vampire / Rose) --- */
        body[data-theme="red-dark"] .logo span,
        body[data-theme="red-light"] .logo span,
        body[data-theme="red-dark"] .sum-logo-text span.grad,
        body[data-theme="red-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #fb7185 0%, #e11d48 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 4. GOLD (Luxury / Sand) --- */
        body[data-theme="gold-dark"] .logo span,
        body[data-theme="gold-light"] .logo span,
        body[data-theme="gold-dark"] .sum-logo-text span.grad,
        body[data-theme="gold-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #facc15 0%, #d97706 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 5. PURPLE (Amethyst / Lavender) --- */
        body[data-theme="purple-dark"] .logo span,
        body[data-theme="purple-light"] .logo span,
        body[data-theme="purple-dark"] .sum-logo-text span.grad,
        body[data-theme="purple-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #e9d5ff 0%, #9333ea 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 6. ORANGE (Magma / Peach) --- */
        body[data-theme="orange-dark"] .logo span,
        body[data-theme="orange-light"] .logo span,
        body[data-theme="orange-dark"] .sum-logo-text span.grad,
        body[data-theme="orange-light"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #fb923c 0%, #ea580c 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }

        /* --- 7. NOIR (Черно-белая) --- */
        body[data-theme="noir"] .logo span,
        body[data-theme="noir"] .sum-logo-text span.grad {
            background: linear-gradient(180deg, #ffffff 0%, #888888 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        /* --- 8. OLD MONEY (Mahogany) --- */
        body[data-theme="old-money"] .logo span,
        body[data-theme="old-money"] .sum-logo-text span.grad {
            /* Золотой градиент */
            background: linear-gradient(180deg, #e6c98c 20%, #c5a059 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* --- 9. DEFAULT (Розовый) --- */
        body:not([data-theme^="blue"]):not([data-theme^="green"]):not([data-theme^="red"]):not([data-theme^="gold"]):not([data-theme^="purple"]):not([data-theme^="orange"]):not([data-theme="noir"]):not([data-theme="old-money"]) .logo span {
            background: linear-gradient(180deg, #CB53F0 20%, #ff00cc 100%) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
        }


        /* === НОВЫЙ БЛОК ИНТЕНСИВНОСТИ === */
        .intensity-wrapper {
            background: var(--nav-bg); /* Цвет фона как у активных элементов */
            border-radius: 20px;       /* Закругленные края */
            padding: 15px 10px;        /* Внутренние отступы */
            margin: 10px 12px 12px 12px; /* Отступы от краев группы */
            border: 1px solid var(--border);
        }

        .intensity-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 5px;
        }

        .intensity-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-main);
            letter-spacing: 1px;
        }

        /* Ограничитель ширины для слайдера и иконок */
        .intensity-controls-inner {
            width: 80%;       /* Слайдер стал меньше (уже) */
            margin: 0 auto;   /* Центрирование */
            position: relative;
        }

        /* =========================================
        18. MEDIA QUERIES (ADAPTATION)
        ========================================= */

        @media (max-width: 768px) {
            #row-install-app, 
            #group-install-container { 
                display: none !important;
            }
        }

        /* DESKTOP / TABLET (> 768px) */
        @media (min-width: 769px) {
            
            /* 1. Глобальный контейнер таба - центрирует всё содержимое */
            #tab-home {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                height: 100vh !important;
                width: 100% !important;
                padding: 0 !important;
                overflow: hidden !important;
                position: relative; 
            }

            /* 2. Промежуточная обертка - сжимаем её до размера контента */
            #tab-home .center-wrapper {
                height: auto !important;
                width: auto !important; /* Не растягивать на всю ширину! */
                max-width: none !important; 
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                margin: 0 auto !important; /* Центрирование по горизонтали */
                flex-direction: column !important;
            }

            /* 3. ЯКОРЯ КАРТОЧКИ (Самое важное для иконок) */
            /* Задаем им фиксированную ширину, чтобы иконки знали, где "край" карточки */
            #card-anchor, #card-anim-wrapper {
                width: 650px !important; /* Ширина равна ширине карточки */
                max-width: 90vw !important;
                position: relative !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
            }

            /* 4. САМА КАРТОЧКА */
            .card {
                width: 100% !important; /* Занимает всю ширину якоря (650px) */
                height: 85vh !important;
                
                min-height: 700px !important;
                max-height: 950px !important;
                
                margin: 0 !important;
                justify-content: space-between !important; 
            }

            /* 5. ИКОНКИ НА ПК (Возвращаем их на место) */
            .icon-left {
                width: 160px !important; /* Чуть крупнее для ПК */
                top: -40px !important;
                left: -40px !important;
            }
            .icon-right {
                width: 130px !important;
                top: -30px !important;
                right: -30px !important;
            }

            /* 6. ТЕКСТ РЕЗУЛЬТАТА */
            .slot-window {
                height: 55% !important; 
                display: flex !important;
                align-items: center !important;
            }
            .slot-item {
                font-size: 110px !important; 
                line-height: 1.1 !important;
            }

            /* 7. Фраза над карточкой */
            .status-text-combined {
                font-size: 24px !important;
                margin-bottom: 30px !important;
                white-space: nowrap; /* Чтобы не переносилась */
            }

            /* 8. Кнопки управления */
            .t-circle-btn.large { width: 90px !important; height: 90px !important; font-size: 40px !important; }
            .t-circle-btn.medium { width: 70px !important; height: 70px !important; font-size: 30px !important; }
            
            /* 9. Модальные окна */
            #modal-sub-overlay .modal {
                width: 950px !important;
                max-width: 95% !important;
            }
            .plans-container { flex-direction: row; align-items: stretch; justify-content: center; }
            .plan-card { flex: 1; }
        }

        #hist-list-swipes, #hist-list-watch {
            padding-bottom: 20px;
        }

        .stats-tf-capsule, 
        .stats-nav-capsule {
            flex-shrink: 0 !important;
            width: 100% !important;
        }

        @media (min-width: 769px) {
            .plans-container {
                flex-direction: row !important;
                align-items: stretch !important;
            }
        }

        /* Закрепленный футер модального окна */
        .modal-footer {
            flex-shrink: 0; /* Запрещаем сжиматься */
            padding: 15px 20px;
            background: var(--sidebar-bg); /* Цвет фона как у модалки */
            border-top: 1px solid var(--border); /* Разделитель сверху */
            z-index: 10;
        }

        /* Корректировка капсулы, чтобы она растягивалась красиво */
        .modal-footer .stats-nav-capsule {
            margin-top: 0;
            width: 100%;
        }

        /* VERSION CAPSULE STYLE */
        .version-card {
            display: flex;
            align-items: center; /* Центрирование по вертикали */
            justify-content: space-between;
            
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 18px; /* Скругление капсулы */
            padding: 12px 16px;
            margin-bottom: 10px;
            
            transition: transform 0.2s;
        }

        .version-card:active {
            transform: scale(0.98);
            background: var(--nav-bg);
        }

        /* Левая часть: Версия */
        .v-ver-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--accent);
            font-weight: 800;
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 10px;
            min-width: 50px;
            text-align: center;
            margin-right: 12px;
            flex-shrink: 0; /* Чтобы не сжималась */
        }

        /* Середина: Описание */
        .v-content {
            flex: 1; /* Занимает всё свободное место */
            font-size: 13px;
            color: var(--text-main);
            line-height: 1.3;
            margin-right: 12px;
            font-weight: 500;
        }

        /* Правая часть: Дата */
        .v-date {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            white-space: nowrap; /* Чтобы дата не переносилась */
            flex-shrink: 0;
        }

        /* === BENTO GRID SYSTEM === */
        .bento-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Две колонки */
            grid-auto-rows: min-content;    /* Высота по содержимому */
            gap: 12px;
            padding-bottom: 20px;
        }

        /* Базовая карточка Бенто */
        .bento-box {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .bento-box:active {
            transform: scale(0.98);
            background: var(--nav-bg);
        }

        /* --- ТИПЫ БЛОКОВ --- */

        /* 1. Широкий блок (на всю ширину) */
        .bento-wide {
            grid-column: span 2;
        }

        /* 2. Блок подписки (Акцентный) */
        .bento-sub {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            min-height: 100px;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Цветовые модификаторы для подписки */
        .bento-sub.is-free { border-color: var(--border); }
        .bento-sub.is-pro { border-color: #ff9900; background: linear-gradient(135deg, rgba(255, 153, 0, 0.1), transparent); }
        .bento-sub.is-beast { border-color: #9b59b6; background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), transparent); }
        .bento-sub.is-bestie { border-color: #00d2ff; background: linear-gradient(135deg, rgba(0, 210, 255, 0.1), transparent); }

        /* 3. Квадратные статы (Apple Watch style) */
        .bento-stat {
            aspect-ratio: 1.1 / 1; /* Почти квадрат */
            justify-content: space-between;
        }

        .bento-stat-large {
            display: flex;
            flex-direction: column;
            align-items: center;      /* Центрирование по горизонтали */
            justify-content: center;  /* Центрирование по вертикали */
            text-align: center;
            padding: 15px 10px;
            gap: 6px;                 /* Отступы между элементами */
            aspect-ratio: 1 / 1;      /* Строгий квадрат */
        }

        /* Крупная иконка по центру */
        .bento-img-icon {
            width: 42px;
            height: 42px;
            object-fit: contain;
            margin-bottom: 2px;
            
            /* Адаптация цвета (инверсия для темной темы, как в сайдбаре) */
            filter: invert(1);
            opacity: 0.9;
            transition: transform 0.2s;
        }

        /* Светлая тема - иконки темные */
        body.light-theme .bento-img-icon {
            filter: invert(0);
            opacity: 0.7;
        }

        /* Эффект при нажатии на блок */
        .bento-stat-large:active .bento-img-icon {
            transform: scale(0.9);
        }

        /* Корректировка цифры */
        .bento-stat-large .bento-val {
            font-size: 28px;     /* Чуть крупнее */
            margin-top: 0;       /* Убираем старый margin-top: auto */
            line-height: 1;
        }

        /* Корректировка подписи */
        .bento-stat-large .bento-label {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 2px;
        }

        /* --- ВНУТРЕННОСТИ КАРТОЧЕК --- */

        /* Иконка в углу */
        .bento-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: var(--bg-color); /* Темнее фона карточки */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* Заголовок (мелкий) */
        .bento-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Значение (большое) */
        .bento-val {
            font-size: 26px;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-top: auto; /* Прижать к низу, если флекс */
        }

        /* Профиль (User Identity) */
        .bento-profile {
            display: flex;
            flex-direction: row !important;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
        }
        .profile-avatar {
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            background: var(--nav-bg); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 16px;
        }

        /* Кнопка синхронизации */
        .bento-action {
            background: var(--accent);
            color: #000;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 14px;
            padding: 18px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
        }
        .bento-action:active {
            transform: scale(0.96);
            filter: brightness(0.9);
        }

        /* Кнопки выхода/сброса (мелкие внизу) */
        .bento-footer-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 5px;
        }
        .bento-small-btn {
            flex: 1;
            padding: 12px;
            border-radius: 16px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        #age-gate {
            background-color: var(--bg-color) !important; /* Сплошной цвет темы */
            backdrop-filter: none !important; /* Убираем блюр, он не нужен на сплошном */
            opacity: 1 !important; /* Гарантируем видимость */
        }

        /* 2. Центрирование кнопок в модальных окнах (Установка и Онбординг) */
        #modal-install-overlay .btn-gen,
        #onboarding-overlay .btn-gen {
            display: flex !important;
            justify-content: center !important; /* Центрирует текст/иконку по горизонтали */
            align-items: center !important;     /* Центрирует по вертикали */
            text-align: center !important;      /* На всякий случай для текста */
            width: 100% !important;             /* Растягиваем кнопку на всю ширину */
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        #modal-install-overlay .modal-close-btn {
            display: flex !important; /* Принудительно показываем */
            visibility: visible !important;
            opacity: 1 !important;
        }


        #block-account .ios-row[onclick*="handleLoginClick"] {
            padding: 10px 12px !important;
        }

        #block-prefs .ios-group > div:not(.ios-row):not(.custom-separator) {
            padding: 10px 10px 8px 14px !important; 
        }

        @media (min-width: 769px) {
            #block-account .ios-row[onclick*="handleLoginClick"] {
                padding: 8px 10px !important;
            }
        }

        /* --- STYLES FOR GENRE DETAILS (EXPLORED) --- */
        .genre-detail-view {
            display: none; /* Скрыто по умолчанию */
            flex-direction: column;
            align-items: center;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }

        .genre-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .genre-icon-large {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            
            filter: invert(1) drop-shadow(0 0 15px rgba(255,255,255,0.2));
            transition: filter 0.3s ease;
        }

        body.light-theme .genre-icon-large {
            filter: invert(0) drop-shadow(0 0 15px rgba(0,0,0,0.1));
        }

        body[data-theme="old-money"] .genre-icon-large {
            filter: invert(75%) sepia(26%) saturate(677%) hue-rotate(357deg) brightness(89%) contrast(88%) drop-shadow(0 2px 5px rgba(0,0,0,0.3)) !important;
        }

        /* === СТИЛИ ДЛЯ РЕЖИМА ПАНИКИ (Green Theme) === */

        /* Темная зеленая тема (По умолчанию в панике) -> Иконки БЕЛЫЕ */
        body[data-theme="green-dark"] .settings-icon {
            filter: invert(1);
            opacity: 0.9;
        }

        /* Светлая зеленая тема -> Иконки ЧЕРНЫЕ */
        body[data-theme="green-light"] .settings-icon {
            filter: invert(0);
            opacity: 0.7;
        }

        /* На всякий случай сбрасываем принудительные фильтры */
        body[data-theme="green-dark"] .settings-icon,
        body[data-theme="green-light"] .settings-icon {
            transition: filter 0.3s ease;
        }

        .genre-desc-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .genre-samples-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .genre-samples-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 25px;
            width: 100%;
        }

        .sample-tag {
            background: var(--ios-card);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
        }

        .achievement-section {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .ach-icon-img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
            opacity: 0.5; /* Полупрозрачная, пока не открыто */
            filter: grayscale(1);
            transition: all 0.5s ease;
        }

        .ach-icon-img.unlocked {
            opacity: 1;
            filter: grayscale(0) drop-shadow(0 0 20px var(--accent));
        }

        .ach-status-text {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--text-secondary);
        }

        .ach-status-text.unlocked {
            color: var(--accent);
        }

        /* Скрываем сетку, когда активны детали */
        .modal-body.show-details #explored-grid {
            display: none;
        }
        .modal-body.show-details .genre-detail-view {
            display: flex;
        }

        /* --- ACHIEVEMENTS SYSTEM --- */

        /* Кнопка в профиле (под бенто-блоком подписки) */
        .btn-achievements-trigger {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .btn-achievements-trigger:active { transform: scale(0.98); background: var(--nav-bg); }

        /* Сетка достижений (Grid) */
        .ach-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ПК: 3 колонки */
            gap: 15px;
            padding-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .ach-grid {
                grid-template-columns: repeat(2, 1fr) !important; /* Принудительно 2 колонки */
                gap: 10px; /* Чуть меньше отступы */
            }
            
            /* Уменьшаем отступы самого окна, чтобы влезало больше контента */
            #modal-achievements-overlay .modal-body {
                padding: 15px 10px !important;
                overflow-x: hidden !important; /* Запрещаем гориз. скролл */
            }
        }

        .ach-card {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            opacity: 0.5; /* По умолчанию закрыто */
            filter: grayscale(1);
            transition: transform 0.2s;
            min-height: 110px;
        }

        .ach-card.unlocked {
            opacity: 1;
            filter: grayscale(0);
            border-color: var(--accent);
            background: linear-gradient(165deg, var(--ios-card) 0%, rgba(255,255,255,0.05) 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .ach-card:active { transform: scale(0.95); }

        .ach-card-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
        }

        .ach-card-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-main);
            line-height: 1.2;
        }

        /* Секция достижений в деталях жанра */
        .genre-achievements-header {
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 15px 0 10px 0;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            letter-spacing: 1px;
        }

        .genre-icons-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px; /* Отступ между двумя наградами */
            margin-bottom: 10px;
        }

        .reward-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90px;
        }

        .reward-display-img {
            width: 70px;
            height: 70px;
            object-fit: contain; /* Чтобы картинка вписывалась */
            margin-bottom: 8px;
            transition: transform 0.2s;
        }

        /* Специфика для Иконки приложения (App Icon) */
        .reward-display-img.app-icon-style {
            border-radius: 15px; /* Скругление как у iOS иконки */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Тень */
            object-fit: cover; /* Иконка заполняет весь квадрат */
        }

        /* Специфика для Бейджа (Badge) */
        .reward-display-img.badge-style {
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); /* Тень для прозрачного PNG */
        }

        /* Эффект нажатия (опционально) */
        .reward-display-img:active {
            transform: scale(0.95);
        }

        /* Второе достижение (Иконка темы) */
        .theme-reward-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-bottom: 5px;
            /* Иконки тем обычно уже цветные, не инвертируем их */
        }

        /* --- DETAIL SHARING CARD (Скрытая карточка для экспорта) --- */
        #achievement-share-card {
            position: fixed; left: -9999px; top: 0;
            width: 350px;
            background: #12000b; /* Темный фон для картинки */
            border: 1px solid #333;
            border-radius: 24px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-family: sans-serif;
            color: #fff;
        }

        .share-ach-icon {
            width: 120px; height: 120px;
            object-fit: contain;
            margin: 20px 0;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.3));
        }

        .share-ach-title {
            font-size: 24px; font-weight: 900;
            text-transform: uppercase; margin-bottom: 10px;
            color: #ff00cc; /* Дефолтный акцент */
        }

        .share-ach-desc {
            font-size: 14px; color: #aaa; line-height: 1.5; margin-bottom: 20px;
        }

        .share-ach-date {
            background: rgba(255,255,255,0.1);
            padding: 5px 15px; border-radius: 20px;
            font-size: 12px; font-weight: 700; color: #fff;
            margin-bottom: 20px;
        }

        .icons-section-header {
            margin: 15px 0 5px 12px !important;
            font-size: 11px !important;
            font-weight: 700 !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase;
            opacity: 0.7;
            display: flex !important; 
        }

        @media (max-width: 768px) {
            .icons-section-header {
                display: none !important;
            }
        }

        .icons-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding-bottom: 20px;
        }

        .app-icon-item {
            width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .app-icon-item:active { transform: scale(0.95); }

        .app-icon-img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 5px;
            border: 2px solid transparent; /* Для активного состояния */
            transition: all 0.2s;
            object-fit: cover;
        }

        /* Активная иконка (выбрана) */
        .app-icon-item.active .app-icon-img {
            border-color: var(--accent);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent);
        }

        /* Закрытая иконка */
        .app-icon-item.locked .app-icon-img {
            filter: grayscale(1) brightness(0.7);
            opacity: 0.6;
        }

        /* Замочек на закрытой */
        .icon-lock-badge {
            position: absolute;
            top: -5px; right: -5px;
            font-size: 12px;
        }

        .app-icon-label {
            font-size: 9px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.1;
            font-weight: 600;
        }

        /* --- СТИЛЬ ДЛЯ ЭМОДЗИ-АЧИВОК --- */
        .ach-emoji-box {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* Размер квадрата в списке */
            width: 50px; 
            height: 50px;
            
            /* Стеклянный фон */
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 14px;
            
            /* Тень и свечение */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 0 10px rgba(255,255,255,0.05);
            
            margin-bottom: 8px; /* Отступ до текста */
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            overflow: hidden;
        }

        /* Эффект блика (Маска) */
        .ach-emoji-box::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Сам эмодзи внутри */
        .ach-emoji-content {
            font-size: 28px;
            line-height: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); /* Тень для объема */
            z-index: 1;
        }

        /* --- СТИЛЬ ДЛЯ ОТКРЫТОЙ АЧИВКИ (Свечение цветом темы) --- */
        .ach-card.unlocked .ach-emoji-box {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(255, 0, 204, 0.2), inset 0 0 10px rgba(255, 0, 204, 0.1);
        }

        .ach-card.unlocked .ach-emoji-content {
            filter: drop-shadow(0 0 5px var(--accent)); /* Эмодзи тоже начинает светиться */
        }

        /* --- БОЛЬШАЯ ВЕРСИЯ (Для детального просмотра) --- */
        .ach-emoji-box.large {
            width: 120px;
            height: 120px;
            border-radius: 24px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0.2) 100%);
        }

        .ach-emoji-box.large .ach-emoji-content {
            font-size: 64px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6));
        }

        /* Если закрыто в деталях */
        .ach-emoji-box.large.locked {
            filter: grayscale(1);
            opacity: 0.5;
        }

        /* Стили для скидочных цен */
        .price-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .old-price {
            font-size: 14px;
            color: var(--text-secondary);
            text-decoration: line-through;
            margin-bottom: 2px;
        }

        .new-price-highlight {
            font-size: 22px;
            font-weight: 800;
            color: var(--highlight-green) !important; /* Зеленый для выгоды */
            animation: pulsePrice 2s infinite;
        }

        .discount-badge-card {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--highlight-red);
            color: #fff;
            font-size: 10px;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 6px;
            z-index: 5;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.4);
        }

        @keyframes pulsePrice {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Стили для модалки лояльности */
        .loyalty-avatar {
            width: 80px; height: 80px;
            border-radius: 50%;
            margin-bottom: 15px;
            border: 3px solid var(--accent);
            padding: 3px;
        }

        /* Таймер окончания скидки */
        .discount-timer {
            font-size: 11px;
            font-weight: 700;
            color: var(--highlight-red);
            background: rgba(231, 76, 60, 0.15);
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 4px;
            display: inline-block;
            animation: fadeIn 0.5s ease;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        /* Адаптация контейнера цены */
        .price-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Прижать влево */
            justify-content: center;
            margin-bottom: 15px;
            min-height: 50px; /* Чтобы не прыгало при переключении */
        }

        /* Стили для слайда Топ Категорий */
        .top-cats-container {
            width: 90%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cat-rank-row {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Анимация появления списка */
        .cat-rank-row.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .cat-rank-num {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-secondary);
            width: 25px;
        }

        .cat-rank-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
            margin-right: 12px;
        }

        .cat-rank-name {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            flex: 1;
            text-transform: uppercase;
        }

        .cat-rank-score {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
        }

        /* Особый стиль для ТОП-1 */
        .cat-rank-row.rank-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(0, 0, 0, 0) 100%);
            border: 1px solid #ffd700;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        /* Таймер интриги */
        .rank-1-mask {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .rank-1-mask.revealed {
            transform: translateY(-100%);
        }

        .countdown-number {
            font-size: 40px;
            font-weight: 900;
            color: #fff;
            animation: pulseCount 0.8s infinite;
        }

        @keyframes pulseCount {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal-close-btn {
            position: absolute !important;
            left: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            z-index: 20 !important;
            
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important; 
            max-width: 32px !important;
            padding: 0 !important;
            border-radius: 50% !important;
            
            /* Внешний вид */
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-secondary) !important;
            
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
        }
        @media (min-width: 769px) {
            .modal-close-btn {
                width: 14px !important;
                height: 14px !important;
                min-width: 14px !important;
                max-width: 14px !important;
                border-radius: 50% !important;
                
                /* Цвет macOS (красный) */
                background: #ff5f56 !important; 
                border: 1px solid rgba(0, 0, 0, 0.1) !important;
                
                /* Позиционирование */
                left: 20px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                
                /* Убираем лишние отступы */
                padding: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* Символ крестика появляется только при наведении (эффект macOS) */
            .modal-close-btn::after {
                content: "×" !important; /* Символ умножения, он аккуратнее */
                font-size: 13px !important;
                color: #4e0002 !important; /* Темно-бордовый для контраста */
                line-height: 0.8 !important;
                font-weight: 700 !important;
                opacity: 0; /* Скрыт по умолчанию */
                transition: opacity 0.2s ease;
                display: block !important;
                margin-top: -1px; /* Микро-коррекция центровки */
            }
            .modal-close-btn:hover::after {
                opacity: 1;
            }

            .modal-close-btn:active {
                filter: brightness(0.8);
                transform: translateY(-50%) scale(0.9) !important;
            }
            .modal-header > span:not(.modal-close-btn):not(.modal-header-actions) {
                top: 50% !important;
                transform: translateY(-50%) !important;
                margin-top: 3px !important; /* Сдвигаем вниз на 3px */
                
                /* Доп. стили для красоты на ПК */
                font-size: 15px !important;
                letter-spacing: 0.5px !important;
            }
        }


        .modal-close-btn:active {
            background: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-50%) scale(0.95) !important;
            color: var(--text-main) !important;
        }

        /* Иконка стрелки для мобильных (CSS-рисованная или SVG) */
        .modal-close-icon {
            /* Рисуем стрелку "Назад" или Крестик */
            display: block !important;
            width: 10px !important;
            height: 10px !important;
            border: none !important;
            
            /* Стрелка влево */
            border-top: 2px solid var(--text-main) !important;
            border-left: 2px solid var(--text-main) !important;
            transform: rotate(-45deg) !important;
            margin-left: 2px !important; /* Визуальная центровка стрелки */
            
            /* Сброс фона, если был */
            background: transparent !important;
        }

        .modal-close-btn::after, 
        .modal-close-btn::before {
            display: none !important;
        }

        @media (max-width: 768px) {
            .modal-close-btn {
                top: 50% !important;
                transform: translateY(-50%) !important;
                left: 20px !important;
            }
            
            /* Если справа есть иконки (Share), их тоже центрируем */
            .modal-header-actions {
                top: 50% !important;
                transform: translateY(-50%) !important;
            }

            .modal-close-icon {
                /* 1. Сбрасываем ВСЕ границы, чтобы убрать наследство от десктопа */
                border: none !important; 
                
                width: 8px !important;
                height: 8px !important;
                
                /* 2. Рисуем только две нужные стороны для "уголка" стрелки */
                border-top: 2px solid var(--text-main) !important;
                border-left: 2px solid var(--text-main) !important;
                
                /* 3. Поворачиваем на -45 градусов, чтобы угол смотрел влево */
                transform: rotate(-45deg) !important; 
                
                margin-left: 2px !important; 
                display: block !important;
                opacity: 0.8 !important;
            }

            .modal-close-btn:active {
                transform: translateY(-50%) scale(0.9) !important;
                background: rgba(128, 128, 128, 0.25) !important;
            }
        }

        /* Плавный переход для всех элементов, которые могут быть размыты */
        #slot-reel, #result-desc, #badge-wrapper, #related-block {
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        /* Класс размытия контента */
        .card-content-blur {
            filter: blur(10px) !important;
            opacity: 0.4;
            pointer-events: none; /* Чтобы нельзя было кликнуть по размытым ссылкам */
        }

        #mods-counter {
            position: absolute !important;
            right: 20px !important; /* Отступ от правого края */
            left: auto !important;  /* Отменяем центрирование, если оно было */
            top: 50% !important;
            transform: translateY(-50%) !important; /* Центрируем по вертикали */
            
            display: block !important;
            width: auto !important;
            margin: 0 !important;
            z-index: 100 !important;
            
            font-size: 13px !important;
            font-weight: 700 !important;
            color: var(--text-secondary) !important;
        }

        .main-content {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100vh; /* Для старых браузеров */
            height: 100dvh; /* Dynamic viewport для мобильных */
            overflow: hidden;
        }

        /* Возвращаем правильное поведение вкладок */
        .tab-content {
            display: none; /* Прячем неактивные */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            overflow-y: auto; /* Скролл внутри вкладок */
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
        }

        /* Активная вкладка */
        .tab-content.active {
            display: flex !important;
        }

        @keyframes tabPremiumIn {
            0% {
                opacity: 0;
                transform: translateY(6px) scale(0.99);
                filter: blur(4px); /* Эффект линзы */
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        @media (max-width: 768px) {
            #tab-home .center-wrapper {
                height: 100% !important;
                max-height: 100% !important;
                padding-bottom: 110px !important; 
                padding-top: 75px !important;
                justify-content: center !important; /* Центрируем карточку по вертикали */
            }

            .tab-content.active .center-wrapper {
                animation: tabPremiumIn 0.25s cubic-bezier(0.2, 0, 0.2, 1) forwards;
                will-change: transform, opacity, filter;
            }
        }

        /* Календарная сетка */
        .calendar-month { margin-bottom: 30px; }
        .calendar-month-title { text-align: center; font-weight: 800; margin-bottom: 10px; text-transform: uppercase; color: var(--accent); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day-label { text-align: center; font-size: 10px; color: var(--text-secondary); padding: 5px 0; }

        .calendar-day {
            aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; border-radius: 8px; cursor: pointer;
            transition: background 0.2s; color: var(--text-main);
        }

        .calendar-day.disabled { opacity: 0.2; pointer-events: none; }
        .calendar-day.selected { background: var(--accent) !important; color: #000 !important; font-weight: 800; }
        .calendar-day.in-range { background: rgba(255, 0, 204, 0.2); border-radius: 0; }
        .calendar-day:not(.disabled):hover { background: rgba(255,255,255,0.1); }

        #calendar-scroll-container {
            display: flex;
            flex-direction: column; 
            gap: 20px;
            overflow-y: auto;
        }

        #calendar-scroll-container::-webkit-scrollbar {
            width: 4px;
        }
        #calendar-scroll-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* --- УЛУЧШЕННЫЙ ДИЗАЙН КАЛЕНДАРЯ --- */

        .date-capsule-row {
            display: flex;
            gap: 15px;
            padding: 20px 20px 10px 20px;
            background: transparent !important;
            flex-shrink: 0; /* Чтобы шапка не сжималась при скролле */
            z-index: 10;
        }

        /* Капсула (теперь с relative для позиционирования инпута) */
        .date-capsule {
            flex: 1;
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            overflow: hidden; /* Чтобы каретка не вылезала */
        }

        /* Текст внутри капсулы */
        .date-capsule span {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            pointer-events: none; /* Клики проходят сквозь текст на инпут */
            z-index: 1;
        }

        .date-capsule-input {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            text-align: center;
            
            font-family: var(--font-main);
            font-size: 15px;
            font-weight: 700;
            color: var(--text-secondary); 
            
            padding: 0 10px;
            border-radius: 50px;
        }

        .date-capsule-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
            font-weight: 600;
        }

        .date-capsule.filled .date-capsule-input {
            color: var(--text-main); 
        }

        .date-capsule-input:focus {
            background: rgba(255,255,255,0.05);
        }

        .date-capsule.filled {
            background: var(--nav-bg);
            border-color: var(--accent);
        }
        .date-capsule.filled span {
            color: var(--text-main);
        }

        /* Контейнер скролла */
        #calendar-scroll-container {
            flex: 1;
            overflow-y: auto;
            /* Важно для iOS: инерционный скролл */
            -webkit-overflow-scrolling: touch; 
            padding: 10px 15px 100px 15px; /* Большой отступ снизу, чтобы кнопка не перекрывала */
            background: transparent;
            position: relative;
            z-index: 5;
        }

        /* Карточка месяца */
        .calendar-month-card {
            background: var(--ios-card);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .calendar-month-title {
            font-size: 15px !important;
            text-transform: capitalize !important;
            margin-bottom: 15px !important;
            color: var(--text-main) !important;
            text-align: center;
            font-weight: 800;
        }

        .calendar-grid {
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }

        /* Дни-кружочки */
        .calendar-day {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 50% !important;
            font-size: 13px !important;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            cursor: pointer;
        }

        .calendar-day.disabled { opacity: 0.2; pointer-events: none; }

        .calendar-day.selected {
            background: var(--accent) !important;
            color: #000 !important;
            font-weight: 800 !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .calendar-day.in-range {
            background: rgba(255, 0, 204, 0.15) !important;
            color: var(--accent) !important;
            font-weight: 700;
        }

        /* Плавающая кнопка (Градиент снизу) */
        .confirm-floating-container {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            padding: 20px 20px 30px 20px; /* Отступ снизу для iPhone (Home bar) */
            background: linear-gradient(to top, var(--bg-color) 40%, transparent 100%) !important;
            display: flex;
            justify-content: center;
            pointer-events: none; /* Пропускает клики сквозь градиент */
            z-index: 20;
        }

        .btn-confirm-capsule {
            pointer-events: auto; /* Сама кнопка кликабельна */
            width: 100% !important;
            max-width: 320px;
            padding: 16px !important;
            border-radius: 50px !important;
            font-size: 16px !important;
            font-weight: 800 !important;
            text-transform: uppercase;
            background: var(--text-main) !important;
            color: var(--bg-color) !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4) !important;
            border: none;
        }

        /* --- SITES MODAL STYLES --- */

        .smart-mode-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            margin: 15px;
            padding: 15px;
            border-radius: 16px;
            border: 1px solid var(--accent);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .site-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--ios-card);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .site-card:first-child { border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .site-card:last-child { border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; border-bottom: none; }

        .site-card:active {
            background: var(--nav-bg);
        }

        .site-card.selected {
            background: rgba(46, 204, 113, 0.1); /* Зеленоватый фон для выбранного */
        }

        .site-card.selected .site-check {
            opacity: 1;
            transform: scale(1);
        }

        .site-info {
            display: flex;
            flex-direction: column;
        }

        .site-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 2px;
        }

        .site-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .site-check {
            color: var(--accent);
            font-size: 18px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* =========================================
        MACOS STYLE SIDEBAR (DESKTOP ONLY)
        ========================================= */
        @media (min-width: 769px) {
            
            body {
                /* Добавляем немного отступа контенту, чтобы он не прилипал к парящему сайдбару */
                overflow: hidden; /* Убираем скролл у всего body */
            }

            .sidebar {
                /* 1. РАЗМЕРЫ И ОТСТУПЫ (Парящий эффект) */
                height: calc(100vh - 20px) !important;
                margin-top: 10px !important;
                margin-left: 10px !important;
                margin-bottom: 10px !important;
                margin-right: 0 !important; /* Справа не нужен отступ, там контент */
                
                border-radius: 22px !important;

                padding: 10px !important;
                
                /* 2. ЭФФЕКТ СТЕКЛА (Glassmorphism) */
                background: rgba(28, 28, 30, 0.65) !important; 
                
                backdrop-filter: blur(25px) saturate(180%) !important;
                -webkit-backdrop-filter: blur(25px) saturate(180%) !important;
                
                /* 3. ГРАНИЦЫ И ТЕНИ */
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-right: 1px solid rgba(255, 255, 255, 0.1) !important; /* Перебиваем старый border-right */
                
                /* Глубокая тень для ощущения "парения" */
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5) !important;
                
                z-index: 100 !important;
            }

            /* Адаптация для СВЕТЛОЙ ТЕМЫ */
            body.light-theme .sidebar {
                /* Полупрозрачный белый */
                background: rgba(255, 255, 255, 0.65) !important;
                border: 1px solid rgba(0, 0, 0, 0.05) !important;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            }

            /* Убираем скроллбар внутри сайдбара, чтобы было красиво, но оставляем возможность скроллить */
            .sidebar::-webkit-scrollbar {
                width: 0px;
                background: transparent;
            }
            
            /* Корректируем логотип, чтобы он красиво смотрелся в стекле */
            .sidebar .logo {
                margin-top: 10px !important; 
                margin-bottom: 10px !important;
                min-height: 40px;            
            }
        }

        @media (max-width: 768px) {
    
            /* 1. СКРЫВАЕМ ЗАГОЛОВКИ БЛОКОВ */
            .ios-header {
                display: none !important;
            }

            /* 2. УБИРАЕМ ВНУТРЕННИЕ ОТСТУПЫ У КОНТЕЙНЕРОВ */
            /* Это позволяет блокам растягиваться почти на всю ширину */
            #tab-settings, 
            #tab-account,
            #tab-settings .center-wrapper, 
            #tab-account .center-wrapper {
                padding-left: 0 !important;
                padding-right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            /* 3. НАСТРАИВАЕМ САМИ БЛОКИ */
            .ios-group {
                /* Маленькие отступы от краев (10px) */
                margin-left: 20px !important; 
                margin-right: 20px !important;
                width: auto !important;
                
                margin-top: 0 !important;
                margin-bottom: 15px !important; /* Расстояние между блоками */
            }

            /* 4. ОТСТУП СВЕРХУ ДЛЯ ПЕРВОГО БЛОКА */
            #block-prefs .ios-group:first-child,
            #block-account .ios-group:first-child {
                margin-top: 15px !important;
            }
        }

        @media (max-width: 768px) {
            
            /* Сбрасываем внешние отступы у контейнеров-оберток */
            #block-prefs, #block-account, #block-extras, #block-history {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
                padding-top: 0 !important;
            }

            /* Единственный источник отступа - сама группа кнопок */
            .ios-group {
                /* Стандартный отступ между всеми блоками */
                margin-bottom: 15px !important;
                margin-top: 0 !important;
            }

            /* Фикс для первого элемента, чтобы не прилипал к шапке */
            #block-prefs {
                margin-top: 15px !important;
            }

            body.tab-home-active .top-gradient-mask {
                display: none !important;
            }
            
            
        }

        /* --- 2. ПК ВЕРСИЯ (Стиль macOS Finder) --- */
        @media (min-width: 769px) {
            
            /* Возвращаем заголовки (делаем их маленькими и аккуратными) */
            .ios-header {
                display: flex !important;
                font-size: 11px !important;
                font-weight: 700 !important;
                color: var(--text-secondary) !important;
                margin: 15px 0 5px 12px !important; /* Отступы как в списках */
                text-transform: uppercase;
                opacity: 0.7;
            }

            /* УБИРАЕМ СТИЛЬ КАРТОЧКИ У БЛОКОВ (Прозрачный фон, без границ) */
            .ios-group {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important; /* Чтобы ховер не обрезался */
            }

            /* СТИЛИЗУЕМ СТРОКИ (КНОПКИ) */
            .ios-row {
                background: transparent !important; /* Прозрачный фон */
                border-radius: 8px !important;      /* Скругление при наведении */
                margin: 0 5px 2px 5px !important;   /* Небольшой зазор между кнопками */
                padding: 8px 10px !important;       /* Компактные отступы внутри */
                min-height: 36px !important;        /* Чуть компактнее по высоте */
                border: none !important;            /* Убираем границы */
            }

            /* Убираем линии-разделители между кнопками */
            .ios-row::after {
                display: none !important;
            }

            /* Эффект наведения (Светлая подсветка как в macOS) */
            .ios-row.clickable:hover {
                background: rgba(255, 255, 255, 0.1) !important;
            }
            
            /* Для светлой темы на ПК */
            body.light-theme .ios-row.clickable:hover {
                background: rgba(0, 0, 0, 0.05) !important;
            }

            /* Убираем шевроны (стрелочки) на ПК, для чистоты */
            .chevron {
                opacity: 0.3;
            }
        }

        /* === PC TWEAKS FOR GRIDS (3 COLUMNS) === */
        @media (min-width: 769px) {
            
            /* 1. Делаем модальные окна шире именно для Tips и Explored, 
                чтобы 3 карточки влезли свободно */
            #modal-tips-overlay .modal,
            #modal-explored-overlay .modal {
                width: 750px !important; /* Увеличили ширину (было 550px) */
                max-width: 95vw !important;
            }

            /* 2. Переключаем сетку на 3 колонки */
            .tips-grid,
            .explored-grid {
                grid-template-columns: repeat(3, 1fr) !important; /* 3 равные колонки */
                gap: 20px !important; /* Чуть больше воздуха между карточками */
            }

            .ex-card-title {
                font-size: 12px !important; 
            }
            /* На ПК скрываем саму стрелку внутри красной точки */
            .modal-close-icon {
                display: none !important;
            }
        }

        .modal.swiping {
            transition: none !important;
        }

        .modal {
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1) !important;
            will-change: transform;
        }

        /* Заголовок категории */
        .tips-category-title {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 30px 0 15px 0;
            text-align: center; /* Центрирование */
            width: 100%;
        }

        /* Контейнер скролла */
        .tips-scroll-row {
            display: flex;
            overflow-x: auto;
            overflow-y: visible; /* Чтобы тени не обрезались */
            gap: 15px;
            padding: 20px 20px 40px 20px; /* Отступы по бокам + снизу для теней */
            
            /* Убираем жесткий snap, чтобы скролл был плавным как в Instagram/AppStore */
            /* scroll-snap-type: x mandatory; <- УДАЛЕНО, чтобы не конфликтовало */
            
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .tips-scroll-row::-webkit-scrollbar { display: none; }

        /* Карточка */
        .tip-card {
            /* Фиксируем размер, но используем min-width, чтобы не сжимались */
            min-width: 240px;
            width: 240px;
            height: 320px;
            
            display: flex;
            flex-direction: column;
            
            /* ВАЖНО: visible, чтобы иконка могла торчать наружу */
            overflow: visible !important; 
            
            border-radius: 24px;
            border: 1px solid var(--border);
            background: var(--ios-card);
            position: relative;
            cursor: pointer;
            
            /* Убираем тусклость */
            opacity: 1 !important;
            filter: none !important;
            transform: scale(1) !important;
            
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .tip-card:active {
            transform: scale(0.96) !important;
        }

        /* Верхняя цветная часть (1/3) */
        .tip-card-header {
            height: 35% !important;
            width: 100%;
            /* Скругляем только верх */
            border-radius: 24px 24px 0 0;
        }

        /* Нижняя часть (2/3) */
        .tip-card-body {
            height: 65% !important;
            width: 100%;
            padding: 15px;
            background: var(--ios-card);
            
            display: flex;
            flex-direction: column;
            text-align: left; /* Текст слева, как раньше */
            
            /* Скругляем только низ */
            border-radius: 0 0 24px 24px;
            position: relative;
        }

        .tip-card-icon {
            font-size: 42px;
            position: absolute;
            
            /* Поднимаем вверх, чтобы она села на границу */
            top: -25px !important; 
            left: 15px !important;
            
            /* Сбрасываем центрирование, которое ломало вид */
            transform: none !important; 
            
            z-index: 10;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
            line-height: 1;
        }

        /* Заголовок */
        .tip-card-title {
            /* Отступ сверху, чтобы не наехать на иконку */
            margin-top: 25px !important;
            font-size: 15px;
            font-weight: 800;
            line-height: 1.2;
            color: var(--text-main);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Описание */
        .tip-card-desc {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.7;
            line-height: 1.4;
            color: var(--text-secondary);
            
            display: -webkit-box;
            -webkit-line-clamp: 5; /* Показываем больше текста */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Галочка прочитанного */
        .tip-card.viewed::after {
            content: "✓";
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            z-index: 20;
            backdrop-filter: blur(4px);
        }

        /* === КОМПАКТНЫЕ КАРТОЧКИ БАЗЫ ЗНАНИЙ === */

        /* 1. Уменьшаем контейнер карточки */
        .tip-card {
            min-width: 160px !important; /* Было 240px */
            width: 160px !important;
            height: 215px !important;    /* Было 320px */
            border-radius: 18px !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08) !important; /* Чуть меньше тень */
        }

        /* 2. Адаптируем верхнюю и нижнюю части */
        .tip-card-header {
            border-radius: 18px 18px 0 0 !important;
        }

        .tip-card-body {
            padding: 10px 12px !important; /* Уменьшаем внутренние отступы */
            border-radius: 0 0 18px 18px !important;
        }

        /* 3. Уменьшаем и двигаем иконку (Эмодзи) */
        .tip-card-icon {
            font-size: 30px !important;  /* Было 42px */
            top: -18px !important;       /* Чуть ниже, так как иконка меньше */
            left: 10px !important;
        }

        /* 4. Тексты */
        .tip-card-title {
            font-size: 12px !important;  /* Было 15px */
            margin-top: 15px !important; /* Меньше отступ от иконки */
            margin-bottom: 3px !important;
            line-height: 1.2 !important;
        }

        .tip-card-desc {
            font-size: 9px !important;   /* Было 11px */
            line-height: 1.35 !important;
            opacity: 0.8 !important;
            
            /* Показываем чуть меньше текста, чтобы влезло */
            -webkit-line-clamp: 5 !important; 
        }

        /* 5. Галочка прочитанного */
        .tip-card.viewed::after {
            width: 18px !important;
            height: 18px !important;
            font-size: 10px !important;
            top: 8px !important;
            right: 8px !important;
        }

        /* 6. Отступы между списками (чтобы две категории влезли в экран) */
        .tips-category-title {
            font-size: 11px !important;
            margin: 15px 0 5px 0 !important; /* Сжимаем вертикальные отступы */
            padding-left: 15px !important;
        }

        .tips-scroll-row {
            padding: 5px 15px 20px 15px !important; /* Убираем лишний воздух */
            gap: 10px !important; /* Расстояние между карточками */
        }

        /* === АНИМАЦИИ СТАТИСТИКИ И WRAPPED === */

        /* 1. Диапазон дат в статистике */
        .stats-date-range {
            text-align: center;
            font-size: 11px;
            color: var(--accent);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            opacity: 0;
            transform: translateY(5px);
            animation: fadeInUp 0.3s forwards;
        }

        /* 2. Переливающийся текст (Градиент) */
        .shimmer-text {
            background: linear-gradient(90deg, #fff, var(--accent), #fff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer {
            to { background-position: 200% center; }
        }

        /* 3. Анимация Радара (Диаграммы) */
        .radar-poly {
            transform-origin: center;
            transform: scale(0);
            opacity: 0;
            /* Анимация будет запускаться через JS класс */
            transition: transform 1.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s;
        }
        .radar-poly.animate {
            transform: scale(1);
            opacity: 0.6;
        }

        /* 4. Анимация Эволюции (Контейнер) */
        .evo-container {
            position: relative;
            width: 100%;
            height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .evo-row {
            position: absolute; /* Абсолютное позиционирование для анимации перемещения */
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: top 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s, transform 0.5s;
            left: 0;
        }

        /* 5. Асинхронное появление текста */
        .stagger-text {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s forwards;
        }
        .stagger-delay-1 { animation-delay: 0.2s; }
        .stagger-delay-2 { animation-delay: 0.5s; }
        .stagger-delay-3 { animation-delay: 0.8s; }
        .stagger-delay-4 { animation-delay: 1.2s; }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* === IN-APP PUSH NOTIFICATIONS === */
        #notification-container {
            position: fixed;
            z-index: 999999;
            pointer-events: none; /* Чтобы не мешал кликам, когда пуст */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Стили для мобильных (сверху по центру) */
        @media (max-width: 768px) {
            #notification-container {
                top: calc(10px + env(safe-area-inset-top));
                left: 0;
                width: 100%;
                padding: 0 15px;
                align-items: center;
            }
        }

        /* Стили для ПК (справа сверху) */
        @media (min-width: 769px) {
            #notification-container {
                top: 20px;
                right: 20px;
                width: 350px;
                align-items: flex-end;
            }
        }

        .toast-push {
            pointer-events: auto; /* Делаем само уведомление кликабельным */
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 12px 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            max-width: 360px;
            cursor: pointer;
            transition: transform 0.3s ease, opacity 0.3s ease;
            will-change: transform, opacity;
        }

        /* Светлая тема */
        body.light-theme .toast-push {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .toast-push-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-push-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toast-push-title {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toast-push-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        @keyframes slideInMobile {
            from { transform: translateY(-150%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInPC {
            from { transform: translateX(150%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-animate-in {
            animation: slideInMobile 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @media (min-width: 769px) {
            .toast-animate-in {
                animation: slideInPC 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            }
        }

        .toast-animate-out {
            opacity: 0 !important;
            transform: scale(0.9) !important;
        }

        @keyframes slideOutMobile {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-150%); opacity: 0; }
        }

        @keyframes slideOutPC {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(150%); opacity: 0; }
        }

        .toast-animate-out {
            animation: slideOutMobile 0.4s cubic-bezier(0.32, 0.725, 0.0, 1) forwards !important;
        }

        @media (min-width: 769px) {
            .toast-animate-out {
                animation: slideOutPC 0.4s cubic-bezier(0.32, 0.725, 0.0, 1) forwards !important;
            }
        }

        .seo-context {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

    </style>

</head>
<body>

<!-- FORCE INSTALL OVERLAY -->
<div id="force-install-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#050505; z-index:1000000; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center; box-sizing:border-box; color:#fff; font-family:-apple-system, system-ui, sans-serif;">
    <img src="logo_icon.png" style="width:80px; height:80px; border-radius:20px; margin-bottom:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
    
    <h2 id="fio-title" style="margin-bottom:15px; font-weight:800; font-size:24px; text-transform:uppercase;">Install Required</h2>
    
    <p id="fio-desc" style="font-size:15px; color:#aaa; line-height:1.5; margin-bottom:25px;">
        To provide a secure and private experience on mobile devices, xFetishHub must be installed as an App.
    </p>

    <!-- Гифка -->
    <div style="width:100%; max-width:300px; background:#111; border-radius:15px; overflow:hidden; border:1px solid #333; margin-bottom:25px;">
        <img src="pwa.gif" alt="How to install" style="width:100%; display:block;">
    </div>

    <!-- Инструкция для iOS -->
    <div id="fio-instr-ios" style="display:none; font-size:14px; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; width:100%;">
        1. Tap <b>Share</b> ( <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMjAgMzRWMTBNMjAgMTBMMTIuNSAxNy41TTIwIDEwTDI3LjUgMTcuNU0xMCAyNEgxMGMtMS42NTY4NSAwLTMtMS4zNDMxLTMtM1YxMGMwLTEuNjU2ODUgMS4zNDMxLTMgMy0zaDIwYzEuNjU2OSAwIDMgMS4zNDMxIDMgM3YxMWMwIDEuNjU2OS0xLjM0MzEgMy0zIDNoMCIgc3Ryb2tlPSIjMDBkNTRmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==" style="width:20px; vertical-align:middle;"> )<br>
        2. Select <b>"Add to Home Screen"</b>
    </div>

    <!-- Инструкция для Android -->
    <div id="fio-instr-android" style="display:none; font-size:14px; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; width:100%;">
        1. Tap <b>Menu</b> (3 dots in top right)<br>
        2. Select <b>"Install App"</b> or <b>"Add to Home"</b>
    </div>
</div>

<!-- EKRAN ZAGRUZKI -->
<div id="loading-overlay">
    <img src="icon_light.png" class="loader-logo" alt="Loading...">
    <div class="loader-text" id="loader-phrase">INITIALIZING...</div>
    
    <div class="loader-progress-container">
        <div class="loader-progress-fill" id="loader-bar"></div>
    </div>
</div>

<script>
    (function() {
        // 1. МГНОВЕННАЯ УСТАНОВКА ЦВЕТА ФОНА (Чтобы не мигало)
        const themeId = localStorage.getItem('xch_theme_id') || 'dark';
        const overlay = document.getElementById('loading-overlay');
        const fill = document.getElementById('loader-bar');
        const logo = document.querySelector('.loader-logo');
        const text = document.getElementById('loader-phrase');

        // Карта цветов фона
        const bgColors = {
            'dark': '#12000b', 'light': '#ffeef8',
            'blue-dark': '#020c1b', 'blue-light': '#dbeafe',
            'green-dark': '#020a02', 'green-light': '#dcfce7',
            'red-dark': '#0d0000', 'red-light': '#ffe4e6',
            'gold-dark': '#0a0900', 'gold-light': '#fef3c7',
            'noir': '#000000', 'old-money': '#1a0505'
        };
        // Карта акцентов (для бара)
        const accentColors = {
            'dark': '#ff00cc', 'light': '#db2777',
            'blue-dark': '#64ffda', 'blue-light': '#2563eb',
            'green-dark': '#2ecc71', 'green-light': '#16a34a',
            'red-dark': '#e74c3c', 'red-light': '#e11d48',
            'gold-dark': '#f1c40f', 'gold-light': '#d97706',
            'noir': '#ffffff', 'old-money': '#c5a059'
        };

        if (bgColors[themeId]) overlay.style.backgroundColor = bgColors[themeId];
        if (accentColors[themeId]) fill.style.background = accentColors[themeId];

        // Адаптация под светлую тему
        if (themeId.includes('light')) {
            text.style.color = '#555';
            logo.style.filter = 'invert(1)';
            document.querySelector('.loader-progress-container').style.background = 'rgba(0,0,0,0.1)';
        }

        // 2. СПИСОК ФРАЗ (Англ + немного юмора/техно)
        const phrases = [
            "Warming up engines...",
            "Decrypting desires...",
            "Loading pleasure...",
            "Scanning for kinks...",
            "Preparing visuals...",
            "Calibrating algorithms...",
            "Checking compatibility...",
            "Connecting to the hub...",
            "Fetching spicy data...",
            "Analyzing preferences...",
            "Unlocking categories...",
            "Setting the mood...",
            "Almost there...",
            "Optimizing experience..."
        ];

        // 3. АНИМАЦИЯ ФРАЗ
        let phraseIndex = Math.floor(Math.random() * phrases.length);
        text.innerText = phrases[phraseIndex]; // Первая фраза сразу

        const phraseInterval = setInterval(() => {
            phraseIndex = (phraseIndex + 1) % phrases.length;
            text.innerText = phrases[phraseIndex];
        }, 800); // Меняем каждые 800мс

        // 4. СИМУЛЯЦИЯ ПРОГРЕСС БАРА
        let progress = 0;
        const progressInterval = setInterval(() => {
            // Быстро до 30%, медленнее до 70%, очень медленно до 90%
            let increment = 0;
            if (progress < 30) increment = Math.random() * 5;
            else if (progress < 70) increment = Math.random() * 2;
            else if (progress < 90) increment = Math.random() * 0.5;
            
            progress += increment;
            if (progress > 90) progress = 90; // Ждем полной загрузки страницы
            
            fill.style.width = progress + '%';
        }, 100);

        // Сохраняем ID интервалов в window, чтобы остановить их при полной загрузке
        window.loaderIntervals = { phrase: phraseInterval, progress: progressInterval };
    })();
</script>

<div class="top-gradient-mask"></div>

<div class="app-layout">

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <!-- Логотип: Картинка + Текст -->
        <div class="logo" onclick="resetToHome()">
            <img src="logo.png" alt="X" class="logo-img">
            x<span>Fetish</span>Hub
        </div>
        <!-- Подзаголовок -->
        <div class="subtitle" data-key="subtitle">Your home for adult preferences</div>

        <div id="pc-settings-mount"></div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <div class="mobile-header">
            <div class="logo" onclick="resetToHome()"> 
                <img src="logo.png" alt="X" class="logo-img">
                x<span>Fetish</span>Hub
            </div>
            <div class="subtitle" data-key="subtitle">Your home for adult preferences</div>
            
        </div>

        <div class="tabs-slider-track" id="tabs-slider-track">

            <!-- TAB 1: HOME -->
            <div id="tab-home" class="tab-content active">
                <div class="center-wrapper">

                    <!-- ЯКОРЬ -->
                    <div id="card-anchor" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: visible;">
                        
                        <!-- ОБЁРТКА (Wrapper) -->
                        <div id="card-anim-wrapper" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: visible; z-index: 10;">
                            
                            <!-- 1. ФРАЗА СЮДА -->
                            <div class="status-text-combined stagger-item delay-5" id="status-text"></div>

                            <!-- 2. Иконки -->
                            <img src="" id="deco-left" class="deco-icon icon-left" alt="">
                            <img src="" id="deco-right" class="deco-icon icon-right" alt="">


                            <!-- КАРТОЧКА -->
                            <div class="card" id="card-block">

                                <div id="card-notch" class="card-notch">
                                    <span id="card-notch-text">STATUS</span>
                                </div>

                                <!-- START SCREEN OVERLAY -->
                                <div id="mode-start-overlay" class="mode-start-overlay hidden">
                                    
                                    <!-- Текст-приветствие -->
                                    <div id="mode-start-text" class="mode-greeting-text">
                                        What are we watching today?
                                    </div>
                                    
                                    <!-- КНОПКИ РЕЖИМОВ -->
                                    <div id="mode-buttons-container" class="mode-buttons-row">
                                        
                                        <!-- 1. Explore (Scope Icon) -->
                                        <button class="mode-circle-btn side-btn explore" onclick="setAppModeAndStart('explore')">
                                            <img src="scope.png" class="side-icon-img" alt="Explore">
                                        </button>
                                        
                                        <!-- 2. AI Assistant (AI Icon) -->
                                        <button class="mode-circle-btn center-btn ai-assist" onclick="openAssistantUI()">
                                            <img src="ai.png" class="ai-icon-img" alt="AI">
                                        </button>
                                        
                                        <!-- 3. Pleasure (Favorite Icon) -->
                                        <button class="mode-circle-btn side-btn pleasure" onclick="setAppModeAndStart('pleasure')">
                                            <img src="favorite.png" class="side-icon-img" alt="Pleasure">
                                        </button>

                                    </div>

                                    <!-- UI АССИСТЕНТА -->
                                    <div id="assistant-ui" class="assistant-ui">
                                        <div class="assistant-prompt" data-key="ai_prompt">What do you desire? 😏</div>
                                        
                                        <div class="assistant-input-group" style="position: relative; overflow: hidden;">
                                            <!-- 1. Контейнер рулетки (Абсолютно поверх фона, под инпутом) -->
                                            <div id="ai-rolling-container" class="rolling-input-overlay">
                                                <div class="rolling-list" id="ai-rolling-list">
                                                    <!-- Сюда JS вставит варианты -->
                                                </div>
                                            </div>

                                            <!-- 2. Сам инпут (Прозрачный фон) -->
                                            <input type="text" id="ai-input" class="assistant-input" style="position: relative; z-index: 2; background: transparent !important;" autocomplete="off">
                                            
                                            <button class="btn-mic-trigger" id="btn-mic" onclick="toggleVoiceInput()" style="position: relative; z-index: 3;">
                                                <img src="voice.png" class="voice-icon-img" alt="Voice">
                                            </button>
                                        </div>

                                        <button id="btn-ai-go" class="btn-ai-confirm" onclick="processAiRequest()">
                                            <span data-key="ai_btn_go">Find It</span>
                                        </button>
                                        
                                        <div class="btn-ai-cancel" onclick="closeAssistantUI()">
                                            <span data-key="btn_cancel">Cancel</span>
                                        </div>
                                    </div>

                                    <!-- UI ДУМАНИЯ -->
                                    <div id="thinking-ui" class="thinking-ui">
                                        <div class="thinking-spinner"></div>
                                        <div style="font-size: 18px; font-weight: 700; color: var(--text-secondary);" id="ai-thinking-text" data-key="ai_thinking">Thinking...</div>
                                    </div>
                                </div>

                                <!-- Оверлей для цвета при свайпе -->
                                <div class="swipe-overlay"></div>
                                
                                <!-- Верхняя часть: Бейджи -->
                                <div style="width:100%; display:flex; justify-content:center; min-height: 30px; flex-shrink: 0;" class="stagger-item delay-1" id="badge-container-anim">
                                    <div class="badge-wrapper" id="badge-wrapper"></div>
                                </div>

                                <!-- ЦЕНТРАЛЬНАЯ ЧАСТЬ (flex-grow: 1, чтобы занимать всё свободное место) -->
                                <div style="width:100%; display:flex; flex-direction:column; align-items:center; justify-content: center; flex-grow: 1; overflow: hidden;">
                                    
                                    <!-- Название (Слот-машина) -->
                                    <div class="slot-window">
                                        <div id="slot-reel" class="slot-reel">
                                            <!-- Начальный текст -->
                                            <div class="slot-item" id="result-text" style="opacity: 0.8; font-size: 32px;">Ready?</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Описание -->
                                    <div id="result-desc" class="result-description stagger-item delay-2"></div>
                                    
                                    <!-- "Вам может понравиться" -->
                                    <div class="related-section hidden-initial stagger-item delay-3" id="related-block">
                                        <div class="related-title" data-key="related_header">You might also like:</div>
                                        <div class="related-tags" id="related-tags"></div>
                                    </div>
                                </div>

                                <!-- НИЖНЯЯ ЧАСТЬ: Кнопки (flex-shrink: 0, чтобы не сжимались) -->
                                <div style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top: auto; flex-shrink: 0; padding-bottom: 5px;">
                                    
                                    <!-- 1. Кнопка СТАРТА (Внутри карточки) -->
                                    <div id="start-btn-container">
                                        <button class="btn-start-capsule" onclick="startNewSession()">
                                            🔥 <span data-key="btn_start">Let's Go</span>
                                        </button>
                                    </div>

                                    <!-- 2. КНОПКИ УПРАВЛЕНИЯ -->
                                    <div class="tinder-nav-row hidden-initial stagger-item delay-4" id="tinder-controls">
                                        
                                        <!-- BACK -->
                                        <button class="t-circle-btn small undo" id="btn-t-undo" onclick="undoLastAction()">
                                            <img src="back.png" class="action-icon-img" alt="Undo">
                                        </button>
                                        
                                        <!-- DISLIKE -->
                                        <button class="t-circle-btn medium dislike" id="btn-t-pass" onclick="handleSwipeAction('left')">
                                            <img src="dislike.png" class="action-icon-img" alt="Pass">
                                        </button>
                                        
                                        <!-- WATCH -->
                                        <a href="#" target="_blank" class="t-circle-btn large watch" id="btn-t-watch" onclick="handleOutboundClick(event)">
                                            <img src="watch.png" class="action-icon-img" alt="Watch">
                                        </a>
                                        
                                        <!-- LIKE -->
                                        <button class="t-circle-btn medium like" id="btn-t-like" onclick="handleSwipeAction('right')">
                                            <img src="like.png" class="action-icon-img" alt="Like">
                                        </button>
                                        
                                        <!-- WATCH LATER -->
                                        <button class="t-circle-btn small wl" id="btn-t-wl" onclick="toggleWatchLater()">
                                            <img src="watchlater.png" class="action-icon-img" alt="Later">
                                        </button>
                                    </div>

                                    <!-- 3. Модификаторы (Expandable Capsule) -->
                                    <div id="mods-block" class="hidden-initial stagger-item delay-4" style="width:100%; display: flex; justify-content: center;">
                                        
                                        <!-- Сама капсула -->
                                        <div id="mods-capsule" class="mods-wrapper-expanded" onclick="toggleModifiers(event)">
                                            <!-- Иконка (Плюс / Крестик) -->
                                            <div class="mods-icon-plus">+</div>
                                            
                                            <!-- Контейнер для тегов (Сюда JS будет вставлять кнопки) -->
                                            <div class="mods-content" id="mod-container">
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div> <!-- Конец .card -->
                        </div> <!-- Конец #card-anim-wrapper -->
                    </div>
                </div>
            </div>

            <!-- TAB 2: SETTINGS -->
            <div id="tab-settings" class="tab-content">
                <div class="center-wrapper">
                    <div id="mount-prefs"></div>
                </div>
            </div>

            <!-- TAB 3: ACCOUNT -->
            <div id="tab-account" class="tab-content">
                <div class="center-wrapper">
                    <div id="mount-account"></div>
                    <div id="mount-extras"></div>
                </div>
            </div>

        </div>

    </div>
 </div>

<div class="bottom-gradient-mask"></div>

<div class="bottom-nav" id="bottom-nav">
    <div class="nav-active-pill" id="nav-active-pill"></div>

    <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <img src="home_fill.png" class="nav-icon-img" alt="Home">
        <span data-key="nav_home">Home</span>
    </div>
    <div class="nav-item" onclick="switchTab('settings')" id="nav-settings">
        <img src="settings_outline.png" class="nav-icon-img" alt="Settings">
        <span data-key="nav_settings">Settings</span>
    </div>
    <div class="nav-item" onclick="switchTab('account')" id="nav-account">
        <img src="account_outline.png" class="nav-icon-img" alt="Account">
        <span data-key="nav_account">Account</span>
    </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal-overlay" id="modal-history-overlay" onclick="closeHistoryModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeHistoryModal(null, true)">
                <div class="modal-close-icon"></div>
            </div>
            
            <span data-key="history_title">History</span>
        </div>
        
        <!-- Тело с контентом (скроллится) -->
        <div class="modal-body" style="padding-bottom: 10px !important;">
            <div id="hist-list-swipes" style="display:block;"></div>
            <div id="hist-list-watch" style="display:none;"></div>
            <div id="hist-list-wrapped" style="display:none;"></div>
        </div>

        <!-- Футер с кнопками (ПРИБИТ К НИЗУ) -->
        <div class="modal-footer">
            <div class="stats-nav-capsule">
                <div class="stats-nav-item active" id="hist-nav-swipes" onclick="switchHistoryTab('swipes')">
                    <span data-key="hist_tab_swipes">Swipes</span>
                </div>
                <div class="stats-nav-item" id="hist-nav-watch" onclick="switchHistoryTab('watch')">
                    <span data-key="hist_tab_watch">Time</span>
                </div>
                <div class="stats-nav-item" id="hist-nav-wrapped" onclick="switchHistoryTab('wrapped')">
                    <span>Wrapped</span>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- FAVORITES (LIKED) MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeList(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeList(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="favorites_catalog">Liked</span>
        </div>
        <div class="modal-body" id="modal-catalog-body">
            <!-- JS inserts content here -->
        </div>
    </div>
</div>

<!-- BLACKLIST (DISLIKED) MODAL -->
<div class="modal-overlay" id="modal-blacklist-overlay" onclick="closeBlacklist(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeBlacklist(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="blacklist_catalog">Disliked</span>
        </div>
        <div class="modal-body" id="modal-blacklist-body">
            <!-- JS inserts content here -->
        </div>
    </div>
</div>

<!-- STATISTICS MODAL -->
<div class="modal-overlay" id="modal-stats-overlay" onclick="closeStats(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeStats(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="btn_stats">Statistics</span>
            <div class="modal-header-actions">
                <div class="icon-btn-round" onclick="shareStats()"><img src="share.png" class="share-icon-img"></div>
            </div>
        </div>

        <div class="modal-body">
            <!-- Wrapped Button -->
            <button id="btn-wrapped-trigger" onclick="openWrapped()" class="btn-gen" style="width:100%; padding:12px; margin-bottom:15px; font-size:14px; background: linear-gradient(45deg, #FF9900, #9B59B6); color:#fff; display:none; border:none; border-radius:16px; font-weight:800; text-transform:uppercase; letter-spacing:1px; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);">
                <span data-key="wrapped_btn">Fetish Wrapped ✨</span>
            </button>

            <!-- Chart Container -->
            <div id="modal-stats-body" style="min-height: 250px;"></div>

            <!-- Footer Controls -->
            <div style="margin-top: 20px;">
                <div class="stats-tf-capsule">
                    <div class="stats-tf-item active" id="tf-week" onclick="switchTimeframe('week')">Week</div>
                    <div class="stats-tf-item" id="tf-month" onclick="switchTimeframe('month')">Month</div>
                    <div class="stats-tf-item" id="tf-year" onclick="switchTimeframe('year')">Year</div>
                    <div class="stats-tf-item" id="tf-custom" onclick="openDatePicker()">
                        <img src="calendar.png" style="width:16px; height:16px; filter:invert(1); opacity:0.8;">
                    </div>
                </div>
                <div class="stats-nav-capsule" style="margin-top: 8px;">
                    <div class="stats-nav-item active" id="stat-nav-tags" onclick="switchStatsTab('tags')">
                        <span data-key="stats_prefs">Preferences</span>
                    </div>
                    <div class="stats-nav-item" id="stat-nav-activity" onclick="switchStatsTab('activity')">
                        <span data-key="stats_activity">Activity</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- RANGE PICKER -->
<div class="modal-overlay" id="modal-date-picker" onclick="closeDatePicker(event)">
    <div class="modal" style="height: 90vh; height: 90dvh; max-height: 800px; background: var(--bg-color) !important; border-radius: 24px 24px 0 0 !important;">
        
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeDatePicker(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="picker_title">Select Range</span>
        </div>
        
        <div class="modal-body" style="display:flex; flex-direction:column; padding:0; overflow: hidden; position: relative; height: 100%;">
            
            <!-- 1. Капсулы с РУЧНЫМ вводом -->
            <div class="date-capsule-row">
                <div id="capsule-start" class="date-capsule">
                    <input type="tel" id="input-start" class="date-capsule-input" placeholder="Start" maxlength="10" autocomplete="off">
                </div>
                
                <div style="display:flex; align-items:center; opacity:0.3; font-size: 18px;">➝</div>
                
                <div id="capsule-end" class="date-capsule">
                    <input type="tel" id="input-end" class="date-capsule-input" placeholder="End" maxlength="10" autocomplete="off">
                </div>
            </div>

            <!-- 2. Скролл календаря -->
            <div id="calendar-scroll-container">
                <!-- JS генерирует месяцы здесь -->
            </div>

            <!-- 3. Плавающая кнопка -->
            <div class="confirm-floating-container">
                <button class="btn-gen btn-confirm-capsule" onclick="applyCustomRange()" data-key="picker_confirm">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AGE GATE OVERLAY -->
<div id="age-gate" class="modal-overlay" style="z-index: 20000; background: var(--bg-color);">
    <div class="center-wrapper" style="text-align:center; padding:20px;">
        
        <!-- Логотип -->
        <div class="logo">
            <img src="logo.png" alt="X" class="logo-img">
            x<span>Fetish</span>Hub
        </div>

        <h2 style="margin-bottom:10px;" data-key="age_title">Age Verification</h2>
        
        <p style="color:var(--text-secondary); margin-bottom:30px; line-height:1.5;" data-key="age_desc">
            This website contains age-restricted materials. Are you 18 years or older?
        </p>
        
        <!-- КНОПКИ И ЯЗЫК В ОДНОМ БЛОКЕ -->
        <div style="display:flex; flex-wrap: wrap; gap:10px; width:100%; max-width:320px; justify-content:center; align-items: center;">
            
            <!-- Язык  -->
            <div style="position: relative;">
                <select onchange="changeLanguage(this.value)" style="
                    appearance: none; -webkit-appearance: none;
                    background: transparent;
                    color: var(--text-secondary);
                    border: 1px solid var(--border);
                    border-radius: 20px;
                    padding: 12px 30px 12px 15px; /* Место под стрелочку */
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    height: 100%;
                    min-width: 80px;
                    text-align: center;
                ">
                    <option value="en">EN</option>
                    <option value="ru">RU</option>
                    <option value="es">ES</option>
                    <option value="de">DE</option>
                </select>
                <!-- Кастомная стрелочка -->
                <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; font-size: 10px;">▼</span>
            </div>

            <!-- Кнопка НЕТ -->
            <button class="btn-gen secondary" onclick="blockAccess()" data-key="age_no" style="flex: 1; min-width: 80px; padding: 12px;">No</button>
            
            <!-- Кнопка ДА -->
            <button class="btn-gen" onclick="passAgeGate()" style="background:var(--accent); color:#000; flex: 1.5; padding: 12px;" data-key="age_yes">Yes, 18+</button>
        </div>
    </div>
</div>

<!-- BLOCKED SCREEN -->
<div id="age-block" class="modal-overlay" style="z-index: 20001; background: #000; display:none;">
    <div class="center-wrapper" style="text-align:center;">
        <div style="font-size:50px; margin-bottom:20px;">⛔</div>
        <h2 style="color:#fff;" data-key="age_block_msg">This website is only for users over 18 years of age.</h2>
    </div>
</div>

<!-- ONBOARDING PREFERENCES -->
<div id="onboarding-overlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <span data-key="onb_title">Quick Setup</span>
            <!-- Без кнопки закрытия, так как это обязательный шаг, но есть Skip внизу -->
        </div>
        
        <div class="modal-body">
            <p style="color:var(--text-secondary); font-size:14px; text-align:center; margin-bottom: 20px;" data-key="onb_desc">
                Tell us what you like in one sentence.
            </p>
            
            <textarea id="onb-input" rows="3" 
                style="width:100%; background:var(--bg-color); border:1px solid var(--border); border-radius:12px; padding:12px; color:var(--text-main); font-size:16px; resize:none;"
                placeholder="e.g. I like milf..."></textarea>
            
            <button class="btn-gen" onclick="processOnboardingText()" data-key="onb_btn_check" style="margin-top:15px; padding:12px; font-size:14px;">
                Check
            </button>

            <!-- Results area -->
            <div id="onb-results" style="display:none; flex-direction:column; gap:10px; margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                <div style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; text-align:center;" data-key="onb_found">Found:</div>
                <div id="onb-tags-container" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;"></div>
                <button class="btn-watch" onclick="finishOnboarding()" data-key="onb_btn_confirm" style="margin-top:10px;">Confirm & Start</button>
            </div>
            
            <div style="text-align:center; margin-top:15px;">
                <span style="font-size:13px; color:var(--text-secondary); text-decoration:underline; cursor:pointer;" onclick="skipOnboarding()" data-key="onb_skip">Skip setup</span>
            </div>
        </div>
    </div>
</div>

<div id="ui-blocks-source" style="display:none;">
    
   <!-- BLOCK: PREFERENCES -->
    <div id="block-prefs">
        
        <div class="ios-header" style="margin-top: 0;" data-key="header_prefs">Preferences</div>
        <div class="ios-group">
            
            <!-- 1. Site -->
            <div class="ios-row clickable" onclick="openSitesModal()">
                <div class="ios-row-left">
                    <img src="site.png" class="settings-icon" alt="Site">
                    <span class="platform-label" data-key="site_label">Site</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="current-site-label" style="font-size:15px; color:var(--text-secondary); font-weight:600;">Pornhub</span>
                    <div class="chevron"></div>
                </div>
            </div>

            <!-- 2. Mode -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="modes.png" class="settings-icon" alt="Mode">
                    <span class="platform-label" data-key="mode_label">Mode</span>
                    <img src="question.png" id="tip-icon-modes" class="settings-icon" 
                        onclick="openSpecificTip('modes')"
                        alt="Info" 
                        style="width:14px; height:14px; margin-left:6px; opacity:0.5; cursor:pointer; transition: opacity 0.3s ease;">
                </div>
                <select id="app-mode-select" class="platform-select" onchange="setAppMode(this.value)" dir="rtl">
                    <option value="explore" data-key="mode_explore">Explore</option>
                    <option value="pleasure" data-key="mode_pleasure">Pleasure</option>
                </select>
            </div>
        </div>

        <div class="ios-header" data-key="header_filters">Filters</div>
        <div class="ios-group">
            
            <!-- 3. INTENSITY -->
            <div style="padding: 12px 16px; overflow: visible;">
                <!-- Заголовок + Иконка + Текст значения -->
                <div class="ios-row-left" style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; width: 100%; overflow: visible;">
                    
                    <!-- Левая часть: Иконка и Заголовок -->
                    <div style="display:flex; align-items:center; overflow: visible;">
                        <!-- Контейнер для иконки -->
                        <div style="width: 24px; height: 24px; margin-right: 12px; display: flex; align-items: center; justify-content: center; overflow: visible;">
                            <img src="safe.png" id="main-intensity-icon" class="settings-icon" alt="Safety" style="width: 24px; height: 24px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); object-fit: contain; margin: 0;">
                        </div>
                        <!-- Заголовок -->
                        <div style="display:flex; align-items:center;">
                            <div style="font-size:16px;" data-key="exploration_mode">Intensity</div>
                            <img src="question.png" id="intensity-info-icon" class="settings-icon" 
                                onclick="openSpecificTip('intensity')"
                                alt="Info" 
                                style="width:14px; height:14px; margin-left:6px; opacity:0.5; cursor:pointer; transition: opacity 0.3s ease;">
                        </div>
                    </div>
                    
                    <!-- Текст значения справа -->
                    <span id="intensity-value-label" style="font-size:14px; font-weight:800; opacity: 0; transition: opacity 0.6s ease; text-transform: uppercase; margin-right: 2px;">
                        Safe 🛡️
                    </span>
                </div>
                
                <!-- Слайдер  -->
                <div class="slider-container" style="margin-left: 24px; width: calc(100% - 26px); box-sizing: border-box; margin-bottom: 5px;">
                    <input type="range" min="1" max="3" value="1" step="1" id="intensity-slider" oninput="updateIntensity(this.value)">
                </div>
            </div>

            <!-- РАЗДЕЛИТЕЛЬ -->
            <div class="custom-separator"></div>

            <!-- 4. Orientation -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="orientation.png" class="settings-icon" alt="Orientation">
                    <span class="platform-label" data-key="ori_label">Orientation</span>
                </div>
                <select id="orientation-select" class="platform-select" onchange="changeOrientation(this.value)">
                    <option value="hetero" data-key="ori_hetero">Hetero</option>
                    <option value="gay" data-key="ori_gay">Gay</option>
                    <option value="trans" data-key="ori_trans">Trans</option>
                    <option value="pan" data-key="ori_pan">Pansexual</option>
                </select>
            </div>

            <!-- 5. Language -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="language.png" class="settings-icon" alt="Lang">
                    <span class="platform-label" data-key="lang_label">Language</span>
                </div>
                <select id="lang-select" class="platform-select" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ru">Русский</option>
                    <option value="es">Español</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>

            <!-- 6. Search EN -->
            <div id="comp-search" class="ios-row" style="display:none;">
                <div class="ios-row-left">
                    <img src="en_search.png" class="settings-icon" alt="Search EN">
                    <span class="toggle-text" data-key="search_en_label">Search EN</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="force-en" checked onchange="updateLink()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- 7. Theme -->
            <div class="ios-row clickable" onclick="openThemeModal()">
                <div class="ios-row-left">
                    <img src="appearance.png" class="settings-icon" alt="Theme">
                    <span class="toggle-text" data-key="theme_label">Appearance</span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="current-theme-name" style="color:var(--text-secondary); font-size:15px;">Dark</span>
                    <div class="chevron"></div>
                </div>
            </div>

            <!-- 8. Modifiers -->
            <div class="ios-row clickable" onclick="openModifiersSettings()">
                <div class="ios-row-left">
                    <img src="modifiers.png" class="settings-icon" alt="Mods">
                    <span class="toggle-text" data-key="mod_manage">Manage Modifiers</span>
                </div>
                <div class="chevron"></div>
            </div>

            <!-- 9. Deco -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="deco.png" class="settings-icon" alt="Deco">
                    <span class="toggle-text" data-key="deco_label">Show Decorations</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="deco-toggle" checked onchange="toggleDecoIcons(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- 10. NOTIFICATIONS -->
            <div class="ios-row">
                <div class="ios-row-left">
                    <img src="notification.png" class="settings-icon" alt="Badge">
                    <span class="toggle-text" data-key="badge_indicator_label">Icon Badge Indicator</span>
                    
                    <img src="question.png" id="tip-icon-notifications" class="settings-icon" 
                        onclick="openSpecificTip('missing_wrapped'); event.stopPropagation();" 
                        alt="Info" 
                        style="width:14px; height:14px; margin-left:6px; opacity:0.5; cursor:pointer; transition: opacity 0.3s ease;">
                </div>
                <label class="switch">
                    <input type="checkbox" id="badge-toggle" onchange="handleNotificationToggle(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- BLOCK: ACCOUNT -->
    <div id="block-account">
        <div class="ios-header" style="display:flex; justify-content:space-between; align-items:baseline; padding-right: 16px;">
            <span data-key="nav_account">Account</span>
            <span id="last-sync-date" style="font-size:11px; color:var(--text-secondary); text-transform:none; font-weight:400; opacity:0.8; display:none;"></span>
        </div>
        
        <div class="ios-group">
            
            <!-- 1. ВХОД -->
            <div class="ios-row clickable" onclick="window.handleLoginClick()" style="padding: 12px 16px;">
                <div class="ios-row-left">
                    <img src="user_account.png" class="settings-icon" alt="User">
                    <span id="login-btn-text" style="font-weight:600; font-size:17px; color:var(--text-main);" data-key="login_text">Sync Data</span>
                </div>
                <div class="chevron"></div>
            </div>

            <!-- 3. СПИСКИ -->
            <div class="ios-row clickable" onclick="openFavoritesCatalog()">
                <div class="ios-row-left">
                    <img src="liked.png" class="settings-icon" alt="Liked">
                    <span data-key="favorites_catalog">Liked</span>
                </div>
                <span class="badge" id="count-fav" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>
            <div class="ios-row clickable" onclick="openBlacklistCatalog()">
                <div class="ios-row-left">
                    <img src="disliked.png" class="settings-icon" alt="Disliked">
                    <span data-key="blacklist_catalog">Disliked</span>
                </div>
                <span class="badge" id="count-ban" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>
            <div class="ios-row clickable" onclick="openWatchLaterCatalog()">
                <div class="ios-row-left">
                    <img src="watched-later.png" class="settings-icon" alt="WL">
                    <span data-key="watch_later">Watch Later</span>
                </div>
                <span class="badge" id="count-wl" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>

            <!-- ADMIN BUTTON -->
            <div id="btn-admin-trigger" class="ios-row clickable" onclick="openAdminModal()" style="display:none;">
                <div class="ios-row-left">
                    <img src="admin.png" class="settings-icon" alt="Admin">
                    <span style="font-weight:700; color:var(--text-secondary);">Admin Panel</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <div class="ios-header" data-key="info_header">Information</div>
        <div class="ios-group">
            
            <!-- 1. ПОЛЕЗНОСТИ -->
            <div class="ios-row clickable" onclick="openTipsModal()">
                <div class="ios-row-left">
                    <img src="book.png" class="settings-icon" alt="Tips" style="margin-right: 12px;">
                    <span data-key="tips_btn">Tips & Tricks</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openStatistics()">
                <div class="ios-row-left">
                    <img src="stats.png" class="settings-icon" alt="Stats">
                    <span data-key="btn_open_stats">Statistics</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openHistoryModal()">
                <div class="ios-row-left">
                    <img src="history.png" class="settings-icon" alt="History">
                    <span data-key="history_title">History</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openExploredModal()">
                <div class="ios-row-left">
                    <img src="explored.png" class="settings-icon" alt="Explored">
                    <span data-key="explored_label">Explored</span>
                </div>
                
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="ex-total-display" style="font-size:15px; color:var(--text-secondary); font-weight:600;">0 / 0</span>
                    <div class="chevron"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- BLOCK: EXTRAS -->
    <div id="block-extras">
    
        <!-- 1. ССЫЛКИ (Community) -->
        <div class="ios-header" data-key="header_community">Community</div>
        <div class="ios-group">
            <!-- Reddit -->
            <div class="ios-row clickable" onclick="window.open('https://www.reddit.com/user/xfetishhub/', '_blank')">
                <div class="ios-row-left">
                    <img src="reddit.png" class="settings-icon" alt="Reddit">
                    <span>Reddit</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>

            <!-- X (Twitter) -->
            <div class="ios-row clickable" onclick="window.open('https://x.com/xfetishhub', '_blank')">
                <div class="ios-row-left">
                    <img src="x.png" class="settings-icon" alt="X">
                    <span>X (Twitter)</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>

            <!-- Report Issue -->
            <div class="ios-row clickable" onclick="window.open('https://tally.so/r/Y50280', '_blank')">
                <div class="ios-row-left">
                    <img src="report.png" class="settings-icon" alt="Report">
                    <span data-key="report_issue">Report Issue</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>

            <!-- About -->
            <div class="ios-row clickable" onclick="window.open('https://www.xfetishhub.site', '_blank')">
                <div class="ios-row-left">
                    <img src="about.png" class="settings-icon" alt="About">
                    <span data-key="lbl_about">About Project</span>
                </div>
                <div style="font-size:18px; color:var(--text-secondary); line-height: 0;">↗</div>
            </div>
        </div>

        <!-- 2. УСТАНОВКА (Install) -->
        <div class="ios-header" data-key="install_title">Install App</div>
        <div class="ios-group" id="group-install-container">
            <div id="row-install-app" class="ios-row clickable" onclick="openQRModal()">
                <div class="ios-row-left">
                    <img src="install.png" class="settings-icon" alt="Install">
                    <span data-key="btn_install_phone">Install on Phone</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 3. ФУНКЦИИ (Roadmap + Panic) -->
        <div class="ios-header" data-key="header_features">Features</div>
        <div class="ios-group">
            <div class="ios-row clickable" onclick="openRoadmap()">
                <div class="ios-row-left">
                    <img src="roadmap.png" class="settings-icon" alt="Roadmap">
                    <span data-key="btn_roadmap">Roadmap</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="openPanicSettings()">
                <div class="ios-row-left">
                    <img src="sos.png" class="settings-icon" alt="SOS">
                    <span data-key="panic_btn">Emergency Mode</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 4. ЮРИДИЧЕСКОЕ (Legal) -->
        <div class="ios-header" data-key="header_legal">Legal</div>
        <div class="ios-group">
            <div class="ios-row clickable" onclick="window.openLegal('terms')">
                <div class="ios-row-left">
                    <img src="terms.png" class="settings-icon" alt="Terms">
                    <span data-key="doc_terms">Terms of Use</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="window.openLegal('privacy')">
                <div class="ios-row-left">
                    <img src="privacy.png" class="settings-icon" alt="Privacy">
                    <span data-key="doc_privacy">Privacy Policy</span>
                </div>
                <div class="chevron"></div>
            </div>
            <div class="ios-row clickable" onclick="window.openLegal('refund')">
                <div class="ios-row-left">
                    <img src="refund.png" class="settings-icon" alt="Refund">
                    <span data-key="doc_refund">Refund Policy</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 5. СПОНСОРЫ (Sponsors) -->
        <!-- Без заголовка, просто отдельный блок -->
        <div class="ios-group" style="margin-top: 25px;">
            <div class="ios-row clickable" onclick="openSponsorsModal()">
                <div class="ios-row-left">
                    <img src="sponsors.png" class="settings-icon" alt="Sponsors">
                    <span data-key="btn_early_sponsors">Early Sponsors</span>
                </div>
                <div class="chevron"></div>
            </div>
        </div>

        <!-- 6. ВЕРСИЯ (Version) -->
        <div class="ios-group">
            <div class="ios-row clickable" onclick="openChangelogModal()">
                <div class="ios-row-left">
                    <img src="info.png" class="settings-icon" alt="Version"> 
                    <span data-key="btn_version">Version</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="app-version-label" style="font-size:15px; color:var(--text-secondary); font-weight:500;">...</span>
                    <div class="chevron"></div>
                </div>
            </div>
        </div>

    </div>
    
    <div id="block-history" style="margin-top:20px;">
        <div class="ios-header" data-key="history_title">History</div>
        <div class="ios-group" id="history-list"></div>
    </div>
</div>

<!-- SUBSCRIPTION MODAL -->
<div class="modal-overlay" id="modal-sub-overlay" onclick="closeSubModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeSubModal(null, true)">
                <div class="modal-close-icon"></div>
            </div>
            <span data-key="sub_title">Premium Access</span>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px; margin-top:5px;">
                <p style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="sub_intro">
                    xFetishHub is an ad-free project. Your subscription ensures its survival.
                </p>
            </div>

            <!-- Toggle -->
            <div class="billing-toggle-container" style="display:flex; justify-content:center; margin-bottom: 20px;">
                <div class="stats-nav-capsule" style="width: auto; min-width: 200px;">
                    <div id="btn-billing-monthly" class="stats-nav-item active" onclick="switchBilling('monthly')" data-key="bill_monthly">
                        Monthly
                    </div>
                    <div id="btn-billing-yearly" class="stats-nav-item" onclick="switchBilling('yearly')">
                        <span data-key="bill_yearly">Yearly</span> <span style="font-size:10px; color:var(--accent); margin-left:3px;">-20%</span>
                    </div>
                </div>
            </div>

            <!-- PLANS GRID -->
            <div class="plans-container">
                
                <!-- 1. FREE -->
                <div class="plan-card">
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px;">Free</div>
                    <div class="plan-price" style="font-size:18px; font-weight:700; margin-bottom:15px;">$0</div>
                    <ul class="plan-features">
                        <li id="free-limit-row">🎲 15 Generations / day</li>
                        <li data-key="feat_wrapped_limited">🎁 1 Fetish Wrapped / week</li>
                        <li data-key="feat_stats_basic">📊 Basic Statistics</li>
                    </ul>
                    <button class="plan-btn current" disabled data-key="btn_current">Current Plan</button>
                </div>

                <!-- 2. PRO -->
                <div class="plan-card pro" style="border-color:#ff9900;">
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px; color:#ff9900;">Pro</div>
                    <div class="plan-price" id="price-pro" style="font-size:18px; font-weight:700; margin-bottom:15px;">$2.99 <span style="font-size:12px">/ mo</span></div>
                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_unlim">🔥 <b>Unlimited</b> Gens</li>
                        <li data-key="feat_stats_adv">📈 Advanced Stats</li>
                        <li data-key="feat_wrapped_unlim">✨ <b>Unlimited</b> Wrapped</li>
                        <li data-key="feat_custom">🎨 Deep Customization</li>
                    </ul>
                    <button class="plan-btn pro-btn" onclick="openPaymentSelection('pro')" data-key="btn_get_pro" style="background:#ff9900; color:#000;">Get Pro</button>
                </div>

                <!-- 3. BEAST -->
                <div class="plan-card beast" style="border-color:#9b59b6;">
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px; color:#9b59b6;">Beast</div>
                    <div class="plan-price" id="price-beast" style="font-size:18px; font-weight:700; margin-bottom:15px;">$4.99 <span style="font-size:12px">/ mo</span></div>
                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_all_pro">👑 <b>All Pro Features</b></li>
                        <li data-key="feat_discord">💬 <b>Discord</b> (Dev Chat)</li>
                        <li data-key="feat_vote">🗳️ Vote on Roadmap</li>
                    </ul>
                    <button class="plan-btn beast-btn" onclick="openPaymentSelection('beast')" data-key="btn_get_beast" style="background:#9b59b6; color:#fff;">Unleash Beast</button>
                </div>

                <!-- 4. BESTIE  -->
                <div class="plan-card bestie" style="border: 2px solid #00d2ff; background: linear-gradient(165deg, rgba(0, 210, 255, 0.1), transparent); position: relative;">
                    <div class="bestie-badge" style="background:#00d2ff; color:#000; font-size:10px; font-weight:800; padding:4px 8px; position:absolute; top:0; right:0; border-radius:0 0 0 10px; z-index:5;" data-key="badge_limited">LIMITED</div>
                    
                    <div class="plan-title" style="font-size:20px; font-weight:800; margin-bottom:5px; color:#00d2ff;">Bestie</div>
                    <div class="plan-price" style="font-size:18px; font-weight:700; margin-bottom:15px;">$49.99 <span style="font-size:12px">/ once</span></div>
                    
                    <div class="limit-container" style="background:rgba(0,0,0,0.2); padding:8px; border-radius:8px; margin-bottom:10px;">
                        <div class="limit-labels" style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:4px;">
                            <span style="color:#ff6b6b; font-weight:700;" data-key="limit_burn">🔥 ALMOST GONE</span>
                            <span style="color:#fff;">47 / 50</span>
                        </div>
                        <div style="width:100%; height:4px; background:rgba(255,255,255,0.1); border-radius:2px;"><div style="width:96%; height:100%; background:#00d2ff;"></div></div>
                    </div>

                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_lifetime">♾️ <b>Lifetime Access</b></li>
                        <li data-key="feat_all_beast">🦁 <b>All Beast Features</b></li> 
                        <li data-key="feat_sponsors">💎 In Sponsors List</li>
                    </ul>
                    <button class="plan-btn bestie-btn" onclick="openPaymentSelection('bestie')" data-key="btn_get_bestie" style="background:linear-gradient(90deg, #00d2ff, #3a7bd5); color:#fff;">Get Forever</button>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- THEME MODAL -->
<div class="modal-overlay" id="modal-theme-overlay" onclick="closeThemeModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeThemeModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="theme_title">Choose Theme</span>
        </div>
        
        <div class="modal-body">
            <div class="ios-header" style="margin-left:0; margin-top:0;" data-key="theme_basic">Basic</div>
            <div class="theme-grid" id="theme-list-basic">
                <!-- JS inserts themes here -->
            </div>

            <div class="ios-header" style="margin-left:0;" data-key="theme_premium">Premium</div>
            <div class="theme-grid" id="theme-list-premium">
                <!-- JS inserts themes here -->
            </div>
            <div class="icons-section-header" style="margin-left:0;" data-key="theme_icons_header">App Icons (Rewards)</div>
            <div class="icons-grid" id="theme-list-icons">
                <!-- JS сюда вставит иконки достижений -->
            </div>
        </div>
        <!-- Панель предпросмотра (Скрыта по умолчанию) -->
        <div id="theme-preview-bar" style="display:none; padding: 15px; border-top: 1px solid var(--border); background: var(--sidebar-bg); flex-direction: column; gap: 10px; align-items: center; text-align: center;">
            <div style="font-size: 13px; color: var(--text-secondary);">
                <span data-key="theme_preview_mode">Preview Mode</span>
            </div>
            <button class="btn-gen" onclick="buyCurrentPreview()" style="width: 100%; padding: 12px; background: linear-gradient(45deg, #FF9900, #9B59B6); color: white; border: none; font-size: 14px; text-transform: uppercase; font-weight: 800; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);">
                <span data-key="btn_unlock_theme">Unlock Theme 🔒</span>
            </button>
        </div>
    </div>
</div>

<!-- MODIFIERS SETTINGS MODAL -->
<div class="modal-overlay" id="modal-mods-overlay" onclick="closeModifiersSettings(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeModifiersSettings(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="mod_title">Modifiers</span>
            <span id="mods-counter" style="position: absolute; right: 20px; font-size:12px; color:var(--text-secondary);">0/10</span>
        </div>
        
        <div class="modal-body">
            <!-- ACTIVE -->
            <div style="font-size:12px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:10px; font-weight:700;" data-key="mod_active_sec">
                Active
            </div>
            <div id="mods-list-active" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:25px; min-height:50px;">
                <!-- JS content -->
            </div>

            <div style="height:1px; background:var(--border); margin-bottom:20px;"></div>

            <!-- INACTIVE -->
            <div style="font-size:12px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:10px; font-weight:700;" data-key="mod_inactive_sec">
                Inactive
            </div>
            <div id="mods-list-inactive" style="display:flex; flex-wrap:wrap; gap:8px;">
                <!-- JS content -->
            </div>
        </div>
    </div>
</div>

<!-- LEGAL MODAL -->
<div class="modal-overlay" id="modal-legal-overlay" onclick="closeLegal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeLegal(null, true)"><div class="modal-close-icon"></div></div>
            <span id="legal-modal-title">Document</span>
        </div>
        
        <div class="modal-body">
            <div id="legal-modal-content" style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                <!-- JS Content -->
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--border); text-align: center;">
            <button class="btn-gen" onclick="closeLegal(null, true)" data-key="btn_close" style="padding: 10px 30px; font-size: 14px; width: auto;">Close</button>
        </div>
    </div>
</div>

<!-- ADMIN MODAL -->
<div class="modal-overlay" id="modal-admin-overlay" onclick="closeAdminModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeAdminModal(null, true)">
                <div class="modal-close-icon"></div>
            </div>
            <span>Admin Panel</span>
        </div>

        <div class="modal-body" style="padding: 10px 15px;">
            
            <!-- СЕКЦИЯ 1: СТАТИСТИКА (Компактно) -->
            <div class="ios-header" style="margin-left: 5px;">📊 СТАТИСТИКА</div>
            <div class="sync-stats-grid" style="margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="sync-stat-item" style="background: var(--nav-bg); border: 1px solid var(--border); padding: 12px;">
                    <span class="sync-stat-val" id="stat-total-users" style="font-size: 24px;">...</span>
                    <span class="sync-stat-label">Юзеров</span>
                </div>
                <div class="sync-stat-item" style="background: var(--nav-bg); border: 1px solid var(--border); padding: 12px;">
                    <span class="sync-stat-val" id="stat-premium-users" style="font-size: 24px; color: var(--accent);">...</span>
                    <span class="sync-stat-label">Premium</span>
                </div>
            </div>
            <button class="btn-gen secondary" onclick="refreshAdminStats()" style="width: 100%; padding: 10px; font-size: 11px; margin-bottom: 20px; border-radius: 12px; height: auto;">
                Обновить данные
            </button>

            <!-- СЕКЦИЯ 2: ВЫДАЧА (С фиксом отступов) -->
            <div class="ios-header" style="margin-left: 5px;">🎁 ВЫДАЧА ПОДПИСКИ</div>
            <div class="ios-group" style="margin-left:0 !important; margin-right:0 !important; width: 100% !important; padding: 15px; margin-bottom: 20px;">
                <input type="text" id="admin-gift-email" class="promo-input" placeholder="Email или ник..." style="margin-bottom: 10px; width: 100%;">
                
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <select id="admin-gift-type" class="promo-input" style="flex: 1; padding-right: 25px;">
                        <option value="pro">Pro</option>
                        <option value="beast">Beast</option>
                        <option value="bestie">Bestie</option>
                    </select>
                    <input type="number" id="admin-gift-days" class="promo-input" style="width: 70px;" value="30">
                </div>
                
                <button class="btn-gen" onclick="adminGiftSub()" style="width: 100%; background: var(--accent); color: #000; font-weight: 800; font-size: 14px;">
                    АКТИВИРОВАТЬ
                </button>
            </div>

            <!-- СЕКЦИЯ 3: СКИДКИ (С фиксом отступов) -->
            <div class="ios-header" style="margin-left: 5px;">⚡ УПРАВЛЕНИЕ СКИДКОЙ</div>
            <div class="ios-group" style="margin-left:0 !important; margin-right:0 !important; width: 100% !important; padding: 15px;">
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <select id="admin-disc-target" class="promo-input" style="flex: 1.5;">
                        <option value="all">Все планы</option>
                        <option value="pro">Pro</option>
                        <option value="beast">Beast</option>
                        <option value="bestie">Bestie</option>
                    </select>
                    <select id="admin-disc-type" class="promo-input" style="flex: 1;">
                        <option value="percent">%</option>
                        <option value="fixed">$</option>
                    </select>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <input type="number" id="admin-disc-value" class="promo-input" placeholder="Сумма/Процент" style="flex: 1;">
                    <input type="number" id="admin-disc-days" class="promo-input" placeholder="Дни" value="3" style="width: 70px;">
                </div>

                <div style="display: flex; gap: 8px;">
                    <button class="btn-gen" onclick="adminSetDiscount()" style="flex: 1; background: var(--highlight-green); color: #fff; font-size: 13px;">
                        ЗАПУСТИТЬ
                    </button>
                    <button class="btn-gen secondary" onclick="adminRemoveDiscount()" style="flex: 1; color: var(--highlight-red); border-color: var(--highlight-red); font-size: 13px;">
                        ОТКЛЮЧИТЬ
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- INSTALL APP MODAL -->
<div class="modal-overlay" id="modal-install-overlay">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="skipInstall()"><div class="modal-close-icon"></div></div>
            <span data-key="install_title">Install App</span>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="logo.png" style="width:60px; height:60px; border-radius:15px; margin-bottom:15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                
                <p style="font-size:14px; color:var(--text-secondary); line-height:1.5;" data-key="install_desc">
                    Install our app for a full-screen experience and private browsing history.
                </p>
            </div>

            <!-- Platform Select -->
            <div class="ios-group" style="margin-bottom:15px;">
                <!-- iOS -->
                <div class="ios-row clickable" onclick="toggleInstallInstruct('ios')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:20px;">🍎</span>
                        <span style="font-weight:600;">iPhone (Safari)</span>
                    </div>
                    <span>▼</span>
                </div>
                <div id="instruct-ios" style="display:none; padding:15px; background:var(--bg-color); font-size:13px; color:var(--text-secondary); line-height:1.6;">
                    1. <span data-key="inst_ios_1">Tap Share</span> <br>
                    2. <span data-key="inst_ios_2">Scroll down and tap</span> <br>
                    <span style="font-weight:700; color:var(--text-main);">➕ <span data-key="inst_ios_btn">Add to Home Screen</span></span>
                </div>

                <!-- Android -->
                <div class="ios-row clickable" onclick="toggleInstallInstruct('android')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:20px;">🤖</span>
                        <span style="font-weight:600;">Android (Chrome)</span>
                    </div>
                    <span>▼</span>
                </div>
                <div id="instruct-android" style="display:none; padding:15px; background:var(--bg-color); font-size:13px; color:var(--text-secondary); line-height:1.6;">
                    1. <span data-key="inst_and_1">Tap Menu (3 dots)</span> <br>
                    2. <span data-key="inst_and_2">Select</span> <br>
                    <span style="font-weight:700; color:var(--text-main);">⬇ <span data-key="inst_and_btn">Install App</span></span>
                </div>
            </div>

            <button class="btn-gen secondary" onclick="skipInstall()" data-key="install_continue" style="padding:15px; font-size:14px;">
                Continue in Browser
            </button>
        </div>
    </div>
</div>

<!-- LOGIN (AUTH) MODAL -->
<div class="modal-overlay" id="modal-login-overlay" onclick="closeLoginModal(event)">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeLoginModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="auth_title">Sync & Backup</span>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom: 20px;">
                <div style="font-size:40px; margin-bottom:10px;">☁️</div>
            </div>

            <ul class="auth-benefits">
                <li>
                    <div class="auth-icon">🔄</div>
                    <span data-key="auth_p1">Sync history across devices</span>
                </li>
                <li>
                    <div class="auth-icon">⭐</div>
                    <span data-key="auth_p2">Activate Premium status</span>
                </li>
                <li>
                    <div class="auth-icon">🔒</div>
                    <span data-key="auth_p3">Anonymous secure storage</span>
                </li>
            </ul>

            <button class="btn-google" onclick="performGoogleLogin()">
                <img src="google_logo.svg.png" width="20" height="20" style="object-fit: contain;">
                <span data-key="btn_google_signin">Continue with Google</span>
            </button>

            <div class="auth-note" data-key="auth_security_note">
                We respect your privacy. No data leaks.
            </div>
        </div>
    </div>
</div>

<!-- SYNC INFO MODAL -->
<div class="modal-overlay" id="modal-sync-info-overlay" onclick="closeSyncInfoModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeSyncInfoModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="sync_title">Cloud Storage</span>
        </div>
        
        <div class="modal-body">
            
            <div class="bento-container">
                
                <!-- 1. ПРОФИЛЬ -->
                <div class="bento-box bento-wide bento-profile">
                    <div class="profile-avatar">👤</div>
                    <div style="display:flex; flex-direction:column; overflow:hidden;">
                        <span style="font-size:10px; color:var(--text-secondary); text-transform:uppercase;">Account ID</span>
                        <span id="sync-email-display" style="font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">...</span>
                    </div>
                </div>

                <!-- 2. ПОДПИСКА -->
                <div id="sync-sub-card" class="bento-box bento-wide bento-sub clickable" onclick="closeSyncInfoModal(null, true); openSubModal();">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%; margin-bottom:5px;">
                        <div class="bento-label" data-key="lbl_subscription">SUBSCRIPTION</div>
                        <div style="font-size:18px;">✨</div>
                    </div>
                    <div id="sync-sub-value" style="font-size:32px; font-weight:900; letter-spacing:1px; margin-bottom:2px;">...</div>
                    <div id="sync-sub-desc" style="font-size:12px; opacity:0.7;">Checking...</div>
                </div>

                <!-- Кнопка Достижений -->
                <div class="bento-box bento-wide clickable" onclick="openAchievementsModal()" style="flex-direction:row; align-items:center; justify-content:space-between; padding:15px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span style="font-size:24px;">🏆</span>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:700; font-size:15px; color:var(--text-main);" data-key="ach_title">Achievements</span>
                            <span id="ach-total-progress" style="font-size:11px; color:var(--text-secondary);">0 / 26</span>
                        </div>
                    </div>
                    <div class="chevron"></div>
                </div>

                <!-- 3. СЕТКА СТАТИСТИКИ -->
                
                <!-- Liked -->
                <div class="bento-box bento-stat-large clickable" onclick="closeSyncInfoModal(null, true); openFavoritesCatalog();">
                    <img src="liked.png" class="bento-img-icon" alt="Liked">
                    <div class="bento-val" id="cloud-fav-count">0</div>
                    <div class="bento-label" data-key="favorites_catalog">Liked</div>
                </div>

                <!-- Watch Later -->
                <div class="bento-box bento-stat-large clickable" onclick="closeSyncInfoModal(null, true); openWatchLaterCatalog();">
                    <img src="watched-later.png" class="bento-img-icon" alt="Saved">
                    <div class="bento-val" id="cloud-wl-count">0</div>
                    <div class="bento-label" data-key="watch_later">Saved</div>
                </div>

                <!-- Explored -->
                <div class="bento-box bento-stat-large clickable" onclick="closeSyncInfoModal(null, true); openExploredModal();">
                    <img src="explored.png" class="bento-img-icon" alt="Explored">
                    <div class="bento-val" id="cloud-explored-count">0</div>
                    <div class="bento-label" data-key="explored_label">Explored</div>
                </div>

                <!-- Minutes -->
                <div class="bento-box bento-stat-large" style="cursor: default;">
                    <img src="history.png" class="bento-img-icon" alt="Time">
                    <div class="bento-val" id="cloud-ban-count">0m</div>
                    <div class="bento-label" data-key="sync_minutes">Minutes</div>
                </div>

                <!-- 4. КНОПКА СИНХРОНИЗАЦИИ -->
                <button class="bento-box bento-wide bento-action" onclick="performManualSync()" id="btn-manual-sync">
                    <span id="sync-btn-text" data-key="btn_sync">Synchronize Device</span>
                </button>

            </div>

            <!-- Футер (Выход) -->
            <div class="bento-footer-actions">
                <button class="bento-small-btn" onclick="window.logout()">
                    <span data-key="logout_text">Log Out</span>
                </button>
                <button class="bento-small-btn" onclick="openResetModal()" style="color:var(--highlight-red); border-color:rgba(231,76,60,0.3);">
                    <span data-key="btn_reset">Reset Data</span>
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ROADMAP MODAL -->
<div class="modal-overlay" id="modal-roadmap-overlay" onclick="closeRoadmap(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeRoadmap(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="roadmap_title">Future Plans</span>
        </div>

        <div class="modal-body">
            <p style="font-size:13px; color:var(--text-secondary); line-height:1.5; margin-bottom:25px; text-align:center;" data-key="roadmap_desc">
                With your support, xFetishHub will evolve. Here is what we are building:
            </p>

            <div class="roadmap-container">
                
                <!-- 1. Community -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#ff00cc; background:rgba(255, 0, 204, 0.15); border:1px solid rgba(255, 0, 204, 0.3); z-index:2;">👥</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_community_title">Fetish Community</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_community_desc">
                            Anonymous social hub. Share your Wrapped, join psychotype groups, and discuss preferences with like-minded people.
                        </div>
                    </div>
                </div>

                <!-- 2. Global Intelligence -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#9b59b6; background:rgba(155, 89, 182, 0.15); border:1px solid rgba(155, 89, 182, 0.3); z-index:2;">🌐</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_global_title">Global Intelligence</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_global_desc">
                            Aggregation of anonymous data. Global 'Most Loved' charts.
                        </div>
                    </div>
                </div>

                <!-- 3. Co-op Mode -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#2ecc71; background:rgba(46, 204, 113, 0.15); border:1px solid rgba(46, 204, 113, 0.3); z-index:2;">🤝</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_coop_title">Co-op Mode</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_coop_desc">
                            Invite a partner. See results in real-time. Perfect for distant couples.
                        </div>
                    </div>
                </div>

                <!-- 4. More Categories -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#ff9900; background:rgba(255, 153, 0, 0.15); border:1px solid rgba(255, 153, 0, 0.3); z-index:2;">📚</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_content_title">5000+ Categories</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_content_desc">
                            Massive database expansion. Every micro-fetish indexed.
                        </div>
                    </div>
                </div>

                <!-- 5. Actor Selector -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#3498db; background:rgba(52, 152, 219, 0.15); border:1px solid rgba(52, 152, 219, 0.3); z-index:2;">⭐</div>
                        <!-- No line for last item -->
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_actors_title">Actor Selector</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_actors_desc">
                            Find pornstars based on visual preferences and body types.
                        </div>
                    </div>
                </div>
                <!-- 6. Localization -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#2ecc71; background:rgba(46, 204, 113, 0.15); border:1px solid rgba(46, 204, 113, 0.3); z-index:2;">🌍</div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" style="font-weight:700; margin-bottom:5px; font-size:15px;" data-key="rm_loc_title">Global Expansion</div>
                        <div class="rm-desc" style="font-size:13px; color:var(--text-secondary); line-height:1.4;" data-key="rm_loc_desc">
                            New languages coming soon: Portuguese, Italian, Chinese, Japanese, and Korean.
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-top:10px; text-align:center;">
                <button class="btn-gen secondary" onclick="closeRoadmap(null, true); openSubModal();" style="border-color:var(--accent); color:var(--text-main);">
                    <span data-key="rm_support_btn">Support Development 🚀</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR CODE MODAL -->
<div class="modal-overlay" id="modal-qr-overlay" onclick="closeQRModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="qr_title">Scan to Install</span>
            <span onclick="closeQRModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body" style="text-align: center;">
            <div style="background: white; padding: 15px; border-radius: 20px; display: inline-block; margin-bottom: 20px;">
                <img id="qr-code-img" src="" alt="QR Code" style="width: 200px; height: 200px; display: block;">
            </div>

            <p style="font-size:14px; color:var(--text-secondary); line-height: 1.5;" data-key="qr_desc">
                Scan with your phone camera.
            </p>
        </div>
    </div>
</div>

<!-- SPONSORS MODAL -->
<div class="modal-overlay" id="modal-sponsors-overlay" onclick="closeSponsorsModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeSponsorsModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="sponsors_title">Early Sponsors</span>
        </div>
        <div class="modal-body">
            
            <!-- БЛОК ВВОДА (Скрыт по умолчанию) -->
            <div id="sponsor-input-container" style="display:none; margin-bottom: 20px; padding: 15px; background: rgba(0, 210, 255, 0.1); border: 1px solid #00d2ff; border-radius: 16px;">
                <div style="font-size: 13px; font-weight: 700; color: #00d2ff; margin-bottom: 8px; text-transform: uppercase;" data-key="spon_header">
                    Bestie Privilege 💎
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.4;" data-key="spon_input_desc">
                    Write your name in history. It will be visible to everyone forever. <br><b>You can only do this once.</b>
                </p>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="sponsor-nickname-input" class="promo-input" placeholder="Your Nickname" maxlength="30" style="font-size: 14px; padding: 10px;">
                    <button class="btn-gen" onclick="submitSponsorName()" style="width: auto; padding: 0 20px; font-size: 13px; background: #00d2ff; color: #000;">
                        <span data-key="spon_btn_save">Save</span>
                    </button>
                </div>
            </div>

            <div style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;" data-key="sponsors_desc">
                Legends who supported xFetishHub early.
            </div>
            
            <!-- СПИСОК -->
            <div class="ios-group" id="sponsors-list">
                <!-- Сюда JS будет грузить список -->
            </div>
        </div>
    </div>
</div>

<!-- CRYPTO PAYMENT MODAL -->
<div class="modal-overlay" id="modal-crypto-payment" onclick="closeCryptoModal(event)">
    <div class="modal" style="text-align: center;">
        
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeCryptoModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="pay_header">USDT Payment</span>
        </div>

        <div class="modal-body">
            
            <!-- MAIN VIEW: QR & Address -->
            <div id="crypto-main-view">
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:15px; line-height:1.4;" data-key="pay_instruction">
                    Send the <b>EXACT amount</b> (including decimals!) via <b>Tron (TRC20)</b>.
                </p>
                
                <!-- QR Code Box -->
                <div style="margin-bottom:20px; background:white; padding:10px; display:inline-block; border-radius:15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);">
                    <img id="crypto-qr-img" src="" style="width:180px; height:180px; display:block;">
                </div>

                <!-- Amount (Clickable Copy) -->
                <div class="ios-group" style="margin-bottom:10px;">
                    <div class="ios-row clickable" onclick="copyCryptoAmount()" style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                        <div style="display:flex; align-items:center;">
                            <span style="color:var(--text-secondary); font-size:13px;" data-key="pay_sum_label">Amount to send:</span>
                            <span id="amount-copy-hint" style="font-size:10px; color:var(--accent); margin-left:8px; opacity:0; transition:opacity 0.3s;">COPIED!</span>
                        </div>
                        <span id="crypto-amount" style="font-weight:800; font-size:18px; color:var(--accent); display:flex; align-items:center; gap:6px;">
                            0.00 USDT <span style="font-size:14px; opacity:0.6;">📋</span>
                        </span>
                    </div>
                </div>

                <!-- Address Copy -->
                <div class="ios-group" style="margin-bottom:15px;">
                    <div class="ios-row clickable" onclick="copyCryptoAddress()" style="display:block; padding:15px; text-align:center;">
                        <div style="font-size:11px; color:var(--text-secondary); text-transform:uppercase; margin-bottom:5px;" data-key="pay_copy_addr">Tap to Copy Address</div>
                        <div id="crypto-address" style="font-family:monospace; font-size:13px; word-break:break-all; font-weight:600;">...</div>
                    </div>
                </div>

                <!-- Toggle Guide Link -->
                <div style="margin-bottom:10px;">
                    <span style="font-size:12px; color:var(--accent); text-decoration:underline; cursor:pointer;" onclick="toggleCryptoView('guide')" data-key="pay_how_to">Don't have crypto? How to pay</span>
                </div>

                <!-- Loading Spinner -->
                <div id="payment-status-box">
                    <div class="thinking-spinner" style="width:24px; height:24px; border-width:3px; margin:0 auto 10px auto;"></div>
                    <div style="font-size:13px; font-weight:600; color:var(--text-secondary); animation: pulse 2s infinite;" data-key="pay_waiting">Waiting for payment...</div>
                </div>
                <div id="crypto-timer" style="margin-top:10px; font-size:11px; color:var(--text-secondary); opacity:0.5;">--:--</div>

                <!-- КНОПКА "НЕ ЗАСЧИТАЛСЯ ПЛАТЕЖ?" -->
                <div style="margin-top:20px; padding-top:10px; border-top:1px solid var(--border);">
                    <span style="font-size:11px; color:var(--text-secondary); text-decoration:underline; cursor:pointer; opacity:0.7;" onclick="toggleCryptoView('problem')" data-key="pay_problem_link">Payment not credited?</span>
                </div>
            </div>

            <!-- GUIDE VIEW -->
            <div id="crypto-guide-view" style="display:none; text-align:left;">
                <div style="font-weight:700; font-size:16px; margin-bottom:15px; text-align:center;" data-key="guide_title">How to pay with Crypto</div>
                
                <div style="font-size:13px; line-height:1.6; color:var(--text-secondary);">
                    <p style="margin-bottom:10px;" data-key="guide_step_1"></p>
                    <p style="margin-bottom:10px;" data-key="guide_step_2"></p>
                    <p style="margin-bottom:10px; font-size:12px; opacity:0.8;">
                        ⚠️ <span data-key="guide_warning">Important: Select <b>TRON (TRC20)</b> network.</span>
                    </p>
                </div>

                <button class="btn-gen secondary" onclick="toggleCryptoView('main')" style="margin-top:15px; width:100%; padding:10px;" data-key="btn_back">Back</button>
            </div>

            <!-- PROBLEM VIEW -->
            <div id="crypto-problem-view" style="display:none; text-align:left; animation: fadeIn 0.3s ease;">
                <div style="font-weight:700; font-size:16px; margin-bottom:15px; text-align:center; color:var(--highlight-red);" data-key="pay_problem_title">Where is my subscription?</div>
                
                <div style="font-size:13px; line-height:1.5; color:var(--text-secondary);">
                    <p style="margin-bottom:15px;" data-key="pay_prob_desc">If status didn't update in 10 mins:</p>
                    
                    <ul style="padding-left:20px; margin-bottom:20px; list-style-type: disc;">
                        <li style="margin-bottom:8px;" data-key="pay_prob_reason_1">Wrong Amount</li>
                        <li style="margin-bottom:8px;" data-key="pay_prob_reason_2">Network Fee deducted</li>
                        <li style="margin-bottom:8px;" data-key="pay_prob_reason_3">Wrong Network</li>
                    </ul>

                    <p style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; border:1px dashed var(--border);" data-key="pay_prob_solution">
                        Don't worry! Send TxID to support.
                    </p>
                </div>

                <!-- Ссылка на Tally форму -->
                <button class="btn-gen" onclick="window.open('https://tally.so/r/Y50280', '_blank')" style="margin-top:20px; width:100%; padding:12px; background:var(--text-main); color:var(--bg-color);" data-key="btn_contact_support">Contact Support</button>

                <button class="btn-gen secondary" onclick="toggleCryptoView('main')" style="margin-top:10px; width:100%; padding:10px;" data-key="btn_back">Back</button>
            </div>

            <!-- SUCCESS VIEW -->
            <div id="payment-success-msg" style="display:none; margin-top:20px; animation: popIn 0.5s ease;">
                <div style="font-size:50px; margin-bottom:10px;">✅</div>
                <h3 style="color:var(--highlight-green); margin:0 0 10px 0;" data-key="pay_success_title">Payment Received!</h3>
                <p style="font-size:13px; color:var(--text-secondary);" data-key="pay_success_desc">Subscription activated.</p>
                <a id="btn-discord-join" href="#" target="_blank" class="btn-gen" style="display:none; margin-top:15px; background:#5865F2; color:#fff; text-decoration:none; align-items:center; justify-content:center; gap:8px;">
                    <span style="font-size:20px;">💬</span> Join Discord
                </a>
                <button class="btn-gen" onclick="location.reload()" style="margin-top:15px; width:100%;" data-key="pay_reload">Reload Page</button>
            </div>

        </div>
    </div>
</div>

<!-- PANIC SETTINGS MODAL -->
<div class="modal-overlay" id="modal-panic-settings" onclick="closePanicSettings(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closePanicSettings(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="panic_title">Emergency Mode</span>
        </div>
        
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="sos.png" style="width:60px; height:60px; margin-bottom:15px; filter: invert(1);">
                <p style="font-size:14px; color:var(--text-secondary); line-height:1.5;" data-key="panic_desc">
                    Enable a stealth mode to quickly hide content. Trigger it by <b>Double Tapping</b> anywhere or pressing <b>Spacebar twice</b>.
                </p>
            </div>

            <div class="ios-group">
                <div class="ios-row">
                    <div class="ios-row-left">
                        <span data-key="panic_enable">Enable Trigger</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="panic-toggle-input" onchange="togglePanicSetting(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- VPN & ADS WARNING MODAL -->
<div class="modal-overlay" id="modal-vpn-overlay">
    <div class="modal" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <span style="color:var(--accent);">⚠️ <span data-key="vpn_title">Notice</span></span>
        </div>
        
        <div class="modal-body">
            <!-- Часть 1: Общее предупреждение -->
            <p style="font-size:14px; color:var(--text-main); margin-bottom:15px; line-height:1.5;" data-key="vpn_text_1">
                Must warn you...
            </p>

            <!-- Часть 2: Только для PWA (скрыто по умолчанию) -->
            <div id="vpn-pwa-text" style="display:none; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; margin-bottom:15px; font-size:13px; color:var(--text-secondary); border:1px dashed var(--border);">
                <span data-key="vpn_text_pwa">PWA Hint...</span>
            </div>

            <!-- Часть 3: ВПН -->
            <p style="font-size:15px; font-weight:700; color:var(--accent); margin-bottom:25px;" data-key="vpn_text_2">
                Don't forget VPN!
            </p>

            <button class="btn-gen" id="btn-vpn-go" style="width:100%; padding:14px; font-size:16px;">
                <span data-key="vpn_btn">Let's go</span>
            </button>
        </div>
    </div>
</div>

<!-- TIPS MODAL -->
<div class="modal-overlay" id="modal-tips-overlay" onclick="closeTipsModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeTipsModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="tips_title">Knowledge Base</span>
        </div>
        
        <div class="modal-body" style="padding: 0 20px 30px 20px;">
            
            <!-- VIEW 1: СПИСОК КАРТОЧЕК -->
            <div id="tips-view-list">
                <!-- Маленький серый заголовок -->
                <div class="tips-guru-text" data-key="tips_guru_title">
                    Become a Guru 😈
                </div>

                <!-- Сетка карточек -->
                <div class="tips-grid" id="tips-list-container">
                    <!-- JS сгенерирует здесь карточки -->
                </div>
            </div>

            <!-- VIEW 2: ДЕТАЛИ (ОСТАВЛЯЕМ ТЕМ ЖЕ, НО НЕМНОГО УЛУЧШИМ) -->
            <div id="tips-view-detail" style="display:none; animation: fadeIn 0.3s ease;">
                <div style="background:var(--ios-card); padding:20px; border-radius:24px; border:1px solid var(--border);">
                    <div id="tip-detail-icon" style="font-size:50px; text-align:center; margin-bottom:15px;"></div>
                    <h3 id="tip-detail-title" style="text-align:center; margin-bottom:20px; color:var(--text-main); font-size:20px;"></h3>
                    
                    <div id="tip-detail-content" style="font-size:14px; line-height:1.6; color:var(--text-secondary); margin-bottom:20px;"></div>
                </div>

                <button class="btn-gen" onclick="backToTipsList()" style="width:100%; padding:14px; margin-top:20px; border-radius:50px;">
                    <span data-key="btn_got_it">Got it</span>
                </button>
            </div>

        </div>
    </div>
</div>

<!-- EXPLORED CATEGORIES MODAL -->
<div class="modal-overlay" id="modal-explored-overlay" onclick="closeExploredModal(event)">
    <div class="modal">
        <div class="modal-header" style="border-bottom: none; padding-bottom: 5px;">
            <div class="modal-close-btn" id="explored-back-btn" onclick="backToExploredGrid()" style="display:none;"><div class="modal-close-icon"></div></div>
            <div class="modal-close-btn" id="explored-main-close" onclick="closeExploredModal(null, true)"><div class="modal-close-icon"></div></div>
            <span id="explored-modal-title" data-key="explored_label" style="margin-left: 40px;">Explored</span>
        </div>
        
        <div id="explored-subtitle" class="modal-subtitle" data-key="explored_subtitle" style="text-align: center; color: var(--text-secondary); font-size: 13px; padding: 0 20px 20px 20px; line-height: 1.4; font-weight: 500;">
            Here are the achievements you need to get "Platinum" 😈
        </div>
        
        <div class="modal-body" id="explored-modal-body" style="padding: 0 15px 20px 15px;">
            <!-- 1. СЕТКА (GRID) -->
            <div id="explored-grid" class="explored-grid"></div>

            <!-- 2. ДЕТАЛИ (DETAILS VIEW) -->
            <div id="explored-details" class="genre-detail-view">
                <!-- Контент генерируется через JS -->
            </div>
        </div>
    </div>
</div>

<!-- ACHIEVEMENTS LIST MODAL -->
<div class="modal-overlay" id="modal-achievements-overlay" onclick="closeAchievementsModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeAchievementsModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="ach_title">Achievements</span>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="achievements-grid" class="ach-grid">
                <!-- JS вставит сюда карточки -->
            </div>
        </div>
    </div>
</div>

<!-- ACHIEVEMENT DETAIL MODAL -->
<div class="modal-overlay" id="modal-ach-detail-overlay" onclick="closeAchDetail(event)">
    <div class="modal" style="max-width: 340px; text-align:center;">
        <div class="modal-header" style="border:none;">
            <div class="modal-close-btn" onclick="closeAchDetail(null, true)"><div class="modal-close-icon"></div></div>
        </div>
        
        <div class="modal-body" style="padding-bottom:25px; display:flex; flex-direction:column; align-items:center;">
            
            <img id="detail-ach-icon" src="" style="width:120px; height:120px; object-fit:contain; margin-bottom:15px;">
            
            <div id="detail-ach-title" style="font-size:22px; font-weight:900; text-transform:uppercase; margin-bottom:10px; line-height:1.1;">
                Title
            </div>
            
            <div id="detail-ach-date" style="font-size:12px; font-weight:700; color:var(--accent); background:rgba(255,255,255,0.05); padding:4px 12px; border-radius:12px; margin-bottom:15px;">
                Unlocked: 01.01.2025
            </div>

            <p id="detail-ach-desc" style="font-size:14px; color:var(--text-secondary); line-height:1.5; margin-bottom:25px;">
                Description goes here.
            </p>

            <button id="btn-ach-share" class="btn-gen" onclick="shareAchievementCard()" style="width:100%; padding:12px;">
                <span data-key="share_btn">Share</span>
            </button>
        </div>
    </div>
</div>

<!-- LIMIT REACHED MODAL -->
<div class="modal-overlay" id="modal-limit-overlay" onclick="closeLimitModal(event)">
    <div class="modal" style="max-width: 340px; text-align: center;">
        <div class="modal-body" style="padding: 30px 20px 20px 20px; display: flex; flex-direction: column; align-items: center;">
            
            <div style="font-size: 50px; margin-bottom: 15px;">✋</div>
            
            <h3 style="margin-bottom: 10px; color: var(--text-main);" data-key="limit_title">
                Limit Reached
            </h3>

            <p id="limit-custom-text" style="font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px;">
                That's enough for today, buddy. Come back tomorrow, or join Pro and watch until you turn blue 😏
            </p>

            <!-- Маленькая подпись с временем сброса -->
            <div id="limit-reset-time" style="font-size: 11px; background: var(--nav-bg); padding: 4px 10px; border-radius: 8px; margin-bottom: 25px; opacity: 0.8;">
                Reset: 00:00
            </div>

            <!-- Кнопка купить -->
            <button class="btn-gen" onclick="closeLimitModal(null, true); openSubModal();" style="width: 100%; margin-bottom: 10px; background: var(--accent); color: #000;">
                <span data-key="btn_get_pro">Get Pro</span>
            </button>

            <!-- Кнопка закрыть -->
            <button class="btn-gen secondary" onclick="closeLimitModal(null, true)" style="width: 100%;">
                <span data-key="btn_close">Close</span>
            </button>

        </div>
    </div>
</div>

<!-- CHANGELOG MODAL -->
<div class="modal-overlay" id="modal-changelog-overlay" onclick="closeChangelogModal(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeChangelogModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="changelog_title">What's New</span>
        </div>
        
        <div class="modal-body" id="changelog-container" style="padding: 20px 25px;">
            <!-- JS сгенерирует историю здесь -->
        </div>
    </div>
</div>

<!-- PROMO TIPS MODAL -->
<div class="modal-overlay" id="modal-promo-tips-overlay">
    <div class="modal" style="max-width: 360px; text-align: center;">
        
        <div class="modal-header">
            <span style="color:var(--accent);">💡 <span data-key="pt_title">Did you know?</span></span>
        </div>
        
        <div class="modal-body" style="padding-bottom: 25px;">
            <p style="font-size:14px; color:var(--text-main); line-height:1.5; margin-bottom:25px;" data-key="pt_desc">
                If you want to learn how to completely disable ads in videos or not get caught at the right moment, read the Knowledge Base here, you won't be disappointed 🌚
            </p>

            <!-- Кнопка перехода к Базе знаний -->
            <button class="btn-gen" onclick="openTipsFromPromo()" style="width:100%; padding:14px; font-size:15px; margin-bottom: 15px;">
                <span data-key="pt_btn_go">Open Knowledge Base</span>
            </button>

            <!-- Кнопка пропуска -->
            <div style="text-align:center;">
                <span style="font-size:13px; color:var(--text-secondary); text-decoration:underline; cursor:pointer; opacity: 0.7;" onclick="closePromoTips()" data-key="onb_skip">Skip</span>
            </div>
        </div>
    </div>
</div>


<!-- LOYALTY OFFER MODAL -->
<div class="modal-overlay" id="modal-loyalty-overlay">
    <div class="modal" style="max-width: 360px; text-align: center;">
        <div class="modal-header">
            <!-- Кнопка закрытия слева -->
            <div class="modal-close-btn" onclick="closeLoyaltyModal()">
                <div class="modal-close-icon"></div>
            </div>
            <span style="color:var(--accent);" data-key="loyal_title">Special Offer</span>
        </div>
        
        <div class="modal-body" style="padding-bottom: 25px;">
            <img src="logo.png" class="loyalty-avatar">
            
            <h3 style="margin-bottom: 10px; color: var(--text-main);" data-key="loyal_hey">Hey! 👋</h3>
            
            <p style="font-size:14px; color:var(--text-secondary); line-height:1.5; margin-bottom:20px;" data-key="loyal_text">
                ...
            </p>

            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed var(--border);">
                <div style="font-size:11px; text-transform:uppercase; color:var(--text-secondary);">Offer ends in:</div>
                <div id="loyal-timer" style="font-size:16px; font-weight:700; font-family:monospace;">--:--:--</div>
            </div>

            <button class="btn-gen" onclick="acceptLoyaltyOffer()" style="width:100%; padding:14px; background: linear-gradient(45deg, var(--accent), #9b59b6); color:#fff; box-shadow: 0 5px 20px rgba(255,0,204,0.4);">
                <span data-key="loyal_btn">Get Pro Offer</span>
            </button>

            <div style="text-align:center; margin-top:15px;">
                <span style="font-size:12px; color:var(--text-secondary); text-decoration:underline; cursor:pointer; opacity: 0.6;" onclick="closeLoyaltyModal()" data-key="btn_close">Maybe later</span>
            </div>
        </div>
    </div>
</div>

<!-- RESET DATA SELECTION MODAL -->
<div class="modal-overlay" id="modal-reset-selection" onclick="closeResetModal(event)">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeResetModal(null, true)"><div class="modal-close-icon"></div></div>
            <span data-key="reset_title_select">Select Data to Reset</span>
        </div>
        
        <div class="modal-body">
            <p style="font-size:13px; color:var(--text-secondary); text-align:center; margin-bottom:20px; line-height:1.4;" data-key="reset_desc_select">
                Choose what you want to delete. This action cannot be undone.
            </p>

            <div class="ios-group">
                <!-- 1. Лайки (Favorites) -->
                <div class="ios-row">
                    <div class="ios-row-left">
                        <span>💚 <span data-key="favorites_catalog">Liked</span></span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="chk-reset-fav">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- 2. Дизлайки (Blacklist) -->
                <div class="ios-row">
                    <div class="ios-row-left">
                        <span>⛔ <span data-key="blacklist_catalog">Disliked</span></span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="chk-reset-ban">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- 3. История (Просмотры + Свайпы) -->
                <div class="ios-row">
                    <div class="ios-row-left">
                        <span>📜 <span data-key="history_title">History</span></span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="chk-reset-hist">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- 4. Алгоритм (Веса тегов) -->
                <div class="ios-row">
                    <div class="ios-row-left">
                        <span>🧠 <span data-key="reset_opt_algo">Algorithm & Weights</span></span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="chk-reset-algo">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- 5. Открытые категории (Explored) -->
                <div class="ios-row">
                    <div class="ios-row-left">
                        <span>🏆 <span data-key="explored_label">Explored</span></span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="chk-reset-expl">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- Кнопка удаления -->
            <button class="btn-gen" onclick="performPartialReset()" style="width:100%; margin-top:10px; background:var(--highlight-red); color:#fff; font-weight:800; border:none; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                <span data-key="btn_delete_selected">Delete Selected</span>
            </button>
        </div>
    </div>
</div>

<!-- SITES SELECTION MODAL -->
<div class="modal-overlay" id="modal-sites-overlay" onclick="closeSitesModal(event)">
    
    <style>
        /* === ГЛАВНЫЙ КОНТЕЙНЕР БЛОКОВ === */
        #modal-sites-overlay .sites-fixed-group {
            background: var(--ios-card) !important;
            border: none !important;
            border-radius: 12px !important; 
            margin: 2px 2px !important;
            overflow: hidden !important;
            position: relative;
        }

        /* --- Внутренние стили строк --- */
        #modal-sites-overlay .sites-mode-row {
            padding: 12px 16px 4px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
        }

        #modal-sites-overlay .sites-mode-desc {
            padding: 0 16px 12px 52px;
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.8;
            line-height: 1.3;
            background: transparent;
        }

        /* Разделитель внутри блока режимов */
        #modal-sites-overlay .sites-separator {
            height: 1px;
            background-color: var(--ios-separator);
            margin-left: 52px;
            margin-right: 0;
            transform: scaleY(0.5);
        }

        /* --- СТИЛИ СПИСКА САЙТОВ --- */
        
        #sites-list-container .site-card {
            border: none !important; 
            border-radius: 0 !important;
            margin: 0 !important;
            background: transparent !important;
            border-bottom: 1px solid var(--ios-separator) !important;
        }

        #sites-list-container .site-card:last-child {
            border-bottom: none !important;
        }

        /* Эффект нажатия */
        #sites-list-container .site-card:active,
        #sites-list-container .site-card:hover {
            background: var(--nav-bg) !important;
        }

    </style>

    <div class="modal" style="height: 85vh; max-height: 800px;">
        <div class="modal-header">
            <div class="modal-close-btn" onclick="closeSitesModal(null, true)">
                <div class="modal-close-icon"></div>
            </div>
            <span data-key="site_title">Choose Platform</span>
        </div>
        
        <div class="modal-body" style="padding: 0; background: var(--bg-color);">
            
            <!-- БЛОК РЕЖИМОВ -->
            <div class="sites-fixed-group">
                
                <!-- 1. SMART MODE -->
                <div class="sites-mode-row">
                    <div style="display:flex; align-items:center;">
                        <div style="font-size:22px; width:24px; text-align:center; margin-right:12px;">🧠</div>
                        <span style="font-weight:600; font-size:16px; color:var(--text-main);" data-key="sm_title">Smart Mode</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="smart-site-toggle" onchange="toggleSmartSites(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="sites-mode-desc" data-key="sm_desc">
                    Auto-select site based on tags
                </div>

                <!-- РАЗДЕЛИТЕЛЬ -->
                <div class="sites-separator"></div>

                <!-- 2. RANDOM MODE -->
                <div class="sites-mode-row">
                    <div style="display:flex; align-items:center;">
                        <div style="font-size:22px; width:24px; text-align:center; margin-right:12px;">🎲</div>
                        <span style="font-weight:600; font-size:16px; color:var(--text-main);" data-key="rnd_title">Random Mode</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="random-site-toggle" onchange="toggleRandomSites(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="sites-mode-desc" data-key="rnd_desc">
                    Surprise me every time
                </div>
            </div>

            <!-- ЗАГОЛОВОК СПИСКА -->
            <div class="ios-header" style="margin-left:25px; margin-bottom: 5px; margin-top: 5px;" data-key="sites_all">All Sites</div>
            
            <!-- СПИСОК САЙТОВ -->
            <div id="sites-list-container" class="sites-fixed-group">
                <!-- JS вставит список -->
            </div>
            
            <!-- Безопасная зона снизу -->
            <div style="height: 30px;"></div>
        </div>
    </div>
</div>

<!-- THEME PREVIEW FLOATING BAR -->
<div id="preview-floating-bar">
    
    <div style="display:flex; flex-direction:column; align-items: center; text-align: center; flex: 1;">
        
        <span style="font-size:13px; font-weight:800; color:var(--text-main); letter-spacing: 0.5px;" data-key="theme_preview_mode">
            Preview Mode
        </span>
        
        <span style="font-size:10px; color:var(--text-secondary); opacity:0.8; margin-top: 3px;" data-key="theme_tap_cancel">
            Tap anywhere to cancel
        </span>
        
    </div>

    <button class="btn-gen" onclick="buyFromPreview(event)" style="flex-shrink: 0; width:auto; padding: 10px 24px; border-radius: 40px; font-size:13px; margin:0; background: var(--accent); color: #000; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <span data-key="btn_unlock_theme">Unlock</span>
    </button>
    
</div>

<div id="wrapped-mount" class="wrapped-overlay"></div>

<div id="notification-container"></div>

<!-- FIREBASE INTEGRATION -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, 
        serverTimestamp, writeBatch, query, where, collection, 
        deleteField, Timestamp, limit, orderBy, 
        initializeFirestore, persistentLocalCache, getCountFromServer, persistentMultipleTabManager
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC94QWRaFu0o60kDSU8Uz0VJAcXwaDWjlI",
        authDomain: "xfetishhub.firebaseapp.com",
        projectId: "xfetishhub",
        storageBucket: "xfetishhub.firebasestorage.app",
        messagingSenderId: "617015941952",
        appId: "1:617015941952:web:4f75df1239b0c114d8f8a5"
    };

    const ADMIN_UID = "Tqk5aauZ8JVzQ4Bs7Z0BCT5dZKf1";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    window.auth = auth;
    const db = initializeFirestore(app, {
        localCache: persistentLocalCache({
            tabManager: persistentMultipleTabManager() 
        })
    });
    let cachedUserProfile = null;
    window.cachedUserProfile = null; 
    let lastProfileReadTime = 0;
    const provider = new GoogleAuthProvider();

    let syncTimeout = null;

    const PROFILE_CACHE_TTL = 60000; 

    // Глобальное состояние входа
    window.isUserLoggedIn = false;

    // --- ЛОГИКА СПОНСОРОВ (BESTIE) ---

    window.openSponsorsModal = async function() {
        const list = document.getElementById('sponsors-list');
        const inputBlock = document.getElementById('sponsor-input-container');
        
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Loading legends...</div>';
        document.getElementById('modal-sponsors-overlay').classList.add('open');

        // Проверяем, нужно ли показывать поле ввода
        if (inputBlock) {
            inputBlock.style.display = 'none';
            
            // Читаем подписку из localStorage (так надежнее для синхронного кода)
            const currentSub = localStorage.getItem('xch_sub_level') || 'free';
            
            // Если Bestie и имя еще не установлено (проверяем глобальную переменную)
            if (window.isUserLoggedIn && 
                currentSub === 'bestie' && 
                window.cachedUserProfile && !window.cachedUserProfile.sponsorNameSet) {
                
                inputBlock.style.display = 'block';
            }
        }

        try {
            // Запрос к базе (теперь query и collection доступны из импорта)
            const q = query(collection(db, "sponsors_public"), orderBy("timestamp", "desc"), limit(100));
            const querySnapshot = await getDocs(q);
            
            list.innerHTML = ''; 

            // 1. Старые спонсоры (из массива в коде)
            if (typeof earlySponsors !== 'undefined') {
                earlySponsors.forEach(person => renderSponsorRow(list, person.name, person.date, true));
            }

            // 2. Новые спонсоры (из базы)
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                renderSponsorRow(list, data.name, data.date, false);
            });

        } catch (e) {
            console.error("Error loading sponsors:", e);
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">Error loading list. Check console.</div>';
        }
    };

    window.submitSponsorName = async function() {
        const input = document.getElementById('sponsor-nickname-input');
        const name = input.value.trim();
        const user = auth.currentUser;

        if (!name) return alert("Please enter a name");
        if (name.length > 30) return alert("Name is too long (max 30 chars)");
        if (!user) return alert("Error: User not found");

        const btn = document.querySelector('#sponsor-input-container button');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Saving...";

        try {
            const dateObj = new Date();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const dateStr = `${monthNames[dateObj.getMonth()]} ${dateObj.getFullYear()}`;

            const batch = writeBatch(db);

            // 1. Создаем публичную запись
            const publicRef = doc(collection(db, "sponsors_public"));
            batch.set(publicRef, {
                name: name,
                date: dateStr,
                uid: user.uid,
                timestamp: serverTimestamp()
            });

            // 2. Обновляем профиль пользователя (чтобы скрыть поле)
            const userRef = doc(db, "users", user.uid);
            batch.update(userRef, {
                sponsorNameSet: true,
                sponsorNameValue: name
            });

            await batch.commit();

            // Обновляем локальный кеш
            if (window.cachedUserProfile) {
                window.cachedUserProfile.sponsorNameSet = true;
            }

            document.getElementById('sponsor-input-container').style.display = 'none';
            alert("Welcome to the Wall of Fame! ✨");
            window.openSponsorsModal(); // Перезагружаем список

        } catch (e) {
            console.error("Error saving sponsor:", e);
            alert("Error: " + e.message);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    };

    function renderSponsorRow(container, name, date, isVerified) {
        const row = document.createElement('div');
        row.className = 'ios-row';
        row.style.cursor = 'default';
        const icon = isVerified ? '💎' : '👑';
        
        const safeName = name.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        row.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:18px;">${icon}</span>
                <span style="font-weight:600; color:var(--text-main);">${safeName}</span>
            </div>
            <span style="font-size:12px; color:var(--text-secondary); text-transform:uppercase;">${date}</span>
        `;
        container.appendChild(row);
    }

    // === ФУНКЦИИ ВХОДА/ВЫХОДА (Доступны глобально) ===
    
    window.loginWithGoogle = async function() {
        try {
            await signInWithPopup(auth, provider);
            // Состояние обновится в onAuthStateChanged
        } catch (error) {
            console.error("Login failed:", error);
        }
    };

   window.logout = async function() {
        const user = auth.currentUser;
        
        // Попытка сохранить данные перед выходом
        if (user) {
            const btnText = document.getElementById('sync-btn-text');
            if(btnText) btnText.innerText = "Saving...";
            try {
                await window.syncToCloud(true);
            } catch (e) { console.error(e); }
        }

        try {
            await signOut(auth);
            
            // === ПОЛНАЯ ОЧИСТКА ДАННЫХ ПОДПИСКИ ===
            localStorage.removeItem('xch_last_sync_ts');
            localStorage.removeItem('xch_sub_level'); // УДАЛЯЕМ ПОДПИСКУ
            
            // Сбрасываем переменную в памяти
            subscriptionLevel = 'free';
            
            console.log("Logged out. Local subscription data cleared.");
            
            // Перезагрузка страницы применит Free тариф (т.к. в localStorage ничего нет)
            location.reload(); 
        } catch (error) {
            console.error("Logout failed:", error);
        }
    };

    // === АКТИВАЦИЯ ПРОМОКОДА ===
    window.activatePromoCode = async function(code) {
        const user = auth.currentUser;
        // Ссылки на документы
        const codeRef = doc(db, "promocodes", code);
        const userRef = doc(db, "users", user.uid);

        try {
            // 1. Сначала читаем код, чтобы убедиться, что он есть (как и раньше)
            const codeSnap = await getDoc(codeRef);
            if (!codeSnap.exists() || !codeSnap.data().active) {
                alert("Invalid code");
                return;
            }
            const promoData = codeSnap.data();

            // 2. Создаем ПАКЕТ (Batch)
            const batch = writeBatch(db);

            // Операция А: Сжигаем код
            batch.update(codeRef, {
                active: false,
                usedBy: user.uid,
                usedAt: serverTimestamp()
            });

            // Операция Б: Обновляем юзера
            batch.set(userRef, {
                subscription: promoData.type, // 'pro' или 'beast'
                expiresAt: new Date(Date.now() + (promoData.days * 86400000)),
                lastUsedCode: code 
            }, { merge: true });

            // 3. Отправляем всё вместе. Если хоть одно правило запретит, отменится ВСЁ.
            await batch.commit();

            alert("Success!");
            location.reload();

        } catch (error) {
            console.error("Hacking attempt failed:", error);
            alert("Error activating code.");
        }
    };

    // === 1. ФУНКЦИЯ КЛИКА ПО АККАУНТУ ===
    window.handleLoginClick = function() {
        if (window.isUserLoggedIn) {
            openSyncInfoModal();
        } else {
            openLoginModal();
        }
    };

    // === 2. ОТКРЫТИЕ ОКНА И ПОДГРУЗКА СТАТИСТИКИ ===
    window.openSyncInfoModal = async function() {
        const user = auth.currentUser;
        if (!user) return;

        document.body.classList.add('modal-open');
        document.getElementById('modal-sync-info-overlay').classList.add('open');
        
        const emailEl = document.getElementById('sync-email-display');
        if(emailEl) emailEl.innerText = user.email;

        const subValue = document.getElementById('sync-sub-value');
        const subDesc = document.getElementById('sync-sub-desc');
        const subCard = document.getElementById('sync-sub-card');

        if(subDesc) subDesc.innerText = "..."; 

        const now = Date.now();
        let d = cachedUserProfile;
        if (!d || (now - lastProfileReadTime > 60000)) {
            try {
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    d = docSnap.data();
                    cachedUserProfile = d;
                    window.cachedUserProfile = d;
                    lastProfileReadTime = now;
                }
            } catch (e) { console.error(e); }
        }

        const t = langData[currentLang] || langData['en'];

        if (d) {
            // 1. Статус подписки
            const plan = d.subscription || 'free';
            if(subValue) subValue.innerText = plan.toUpperCase();
            
            if(subDesc) {
                if (plan === 'bestie') {
                    subDesc.innerText = t.feat_lifetime.replace('<b>','').replace('</b>',''); 
                } else if (d.expiresAt && plan !== 'free') {
                    const expDate = (d.expiresAt && typeof d.expiresAt.toDate === 'function') 
                        ? d.expiresAt.toDate() 
                        : new Date(d.expiresAt || Date.now());
                    subDesc.innerText = `${t.sub_exp || 'Expires:'} ${expDate.toLocaleDateString()}`;
                } else {
                    subDesc.innerText = plan === 'free' ? "Standard Account" : "Active";
                }
            }

            if(subCard) {
                subCard.classList.remove('is-free', 'is-pro', 'is-beast', 'is-bestie');
                subCard.classList.add('is-' + plan);
            }

            // 2. Счетчики Избранного и WL (берем из локальной памяти для актуальности)
            if(document.getElementById('cloud-fav-count')) document.getElementById('cloud-fav-count').innerText = window.favorites.length;
            if(document.getElementById('cloud-wl-count')) document.getElementById('cloud-wl-count').innerText = window.watchLater.length;
            
            // --- ОТКРЫТЫЕ ФЕТИШИ ---
            // Берем размер локального Set, так как он всегда актуален
            let exCount = window.permanentExplored ? window.permanentExplored.size : 0;
            if(document.getElementById('cloud-explored-count')) document.getElementById('cloud-explored-count').innerText = exCount;

            // 4. МИНУТЫ ПРОСМОТРА
            const timeValEl = document.getElementById('cloud-ban-count');
            if(timeValEl) {
                const wHistory = window.watchHistory || [];
                const totalSeconds = wHistory.reduce((acc, item) => acc + (item.seconds || 0), 0);
                const totalMinutes = Math.floor(totalSeconds / 60);
                
                timeValEl.innerText = totalMinutes + "m";
                
                const parentBox = timeValEl.closest('.bento-box');
                if(parentBox) {
                    const label = parentBox.querySelector('.bento-label');
                    if(label) label.innerText = t.sync_minutes || "Minutes";
                }
            }
        }
        
        applyLanguage();
    };

    window.closeSyncInfoModal = function(e, force) {
        if (force || e.target.id === 'modal-sync-info-overlay') {
            document.getElementById('modal-sync-info-overlay').classList.remove('open');
            document.body.classList.remove('modal-open');
        }
    };

    // === 3. РУЧНАЯ СИНХРОНИЗАЦИЯ (MERGE) ===
    window.performManualSync = async function() {
        const user = auth.currentUser;
        if (!user) return;

        const btn = document.getElementById('btn-manual-sync');
        const btnText = document.getElementById('sync-btn-text');
        const originalText = btnText.innerText;
        
        // Получаем перевод для успеха
        const t = langData[currentLang] || langData['en'];
        const successText = t.sync_btn_success || "✅ Done! Reloading...";

        // Блокируем кнопку и включаем спиннер
        btn.disabled = true;
        btnText.innerHTML = `<span class="spinning-icon">↻</span> Syncing...`;
        
        try {
            await loadUserData(user); 

            // УСПЕХ
            btnText.innerHTML = successText;
            btn.style.background = "var(--highlight-green)"; // Зеленый цвет
            btn.style.color = "#fff";

            // АВТОМАТИЧЕСКАЯ ПЕРЕЗАГРУЗКА ЧЕРЕЗ 1.5 СЕК
            setTimeout(() => {
                location.reload();
            }, 1500);

        } catch (e) {
            console.error("Manual sync failed:", e);
            btnText.innerText = "❌ Error";
            setTimeout(() => {
                btnText.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        }
    };

    // === СЛУШАТЕЛЬ АВТОРИЗАЦИИ (Главная точка входа) ===
    onAuthStateChanged(auth, async (user) => {
        const btnText = document.getElementById('login-btn-text');
        
        // Получаем текущие переводы
        const currentLang = localStorage.getItem('xch_lang') || 'en';
        const t = (typeof langData !== 'undefined' && langData[currentLang]) ? langData[currentLang] : langData['en'];

        if (user) {
            // === ПОЛЬЗОВАТЕЛЬ ВОШЕЛ ===
            window.isUserLoggedIn = true;
            console.log("Authorized:", user.email);
            
            // 1. Обновляем текст кнопки
            if(btnText) {
                const activeText = t.personal_account || "Personal Account";
                const shortEmail = user.email.split('@')[0];
                // Просто текст и email серым цветом
                btnText.innerHTML = `${activeText} <span style="font-size:13px; color:var(--text-secondary); font-weight:400; margin-left:6px;">${shortEmail}</span>`;
            }

            // 2. Обновляем дату синхронизации и грузим данные
            if (window.updateLastSyncUI) window.updateLastSyncUI();
            await loadUserData(user); 

            // 3. Проверка промокода в URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                await window.activatePromoCode(code);
            }
        } else {
            // === ПОЛЬЗОВАТЕЛЬ ВЫШЕЛ ===
            window.isUserLoggedIn = false;
            
            // Возвращаем исходный текст
            const btnText = document.getElementById('login-btn-text');
            if(btnText) btnText.innerText = t.login_text || "Sync / Login";
            
            if (window.updateLastSyncUI) window.updateLastSyncUI();
        }

        // Кнопка админа
        if (user && user.uid === ADMIN_UID) {
            const btn = document.getElementById('btn-admin-trigger');
            if(btn) btn.style.display = 'flex';
        }
    });
    
    // 2. Выдача подписки по Email
    window.adminGiftSub = async function() {
        const user = auth.currentUser;
        if (!user || user.uid !== ADMIN_UID) return;

        const emailInput = document.getElementById('admin-gift-email');
        let targetEmail = emailInput.value.trim();
        const type = document.getElementById('admin-gift-type').value;
        const days = parseInt(document.getElementById('admin-gift-days').value);

        if (!targetEmail) { alert("Введи email или ник!"); return; }

        // --- ЛОГИКА ДОБАВЛЕНИЯ @GMAIL.COM ---
        // Если в строке нет собаки (@), считаем это ником и добавляем домен
        if (!targetEmail.includes('@')) {
            targetEmail += '@gmail.com';
            // Обновляем поле, чтобы админ видел, что произошло
            emailInput.value = targetEmail; 
        }

        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "Поиск...";
        btn.disabled = true;

        try {
            // Ищем пользователя в базе по полю email
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", targetEmail));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert(`Пользователь ${targetEmail} не найден в базе.\nПусть сначала нажмет 'Синхронизация'.`);
                return;
            }

            // Берем первого найденного 
            let targetUserDoc = null;
            querySnapshot.forEach((doc) => { targetUserDoc = doc; });

            // Вычисляем дату (если Bestie, дата не так важна, но пусть будет)
            const now = new Date();
            const expireDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));

            // Обновляем документ ЧУЖОГО пользователя
            await updateDoc(targetUserDoc.ref, {
                subscription: type,
                expiresAt: Timestamp.fromDate(expireDate)
            });

            alert(`Успех! ${targetEmail} теперь ${type.toUpperCase()} на ${days} дн.`);
            emailInput.value = "";

        } catch (e) {
            console.error(e);
            alert("Ошибка: " + e.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    };

    // 3. Сброс подписки до FREE по Email
    window.adminSetDiscount = async function() {
        const target = document.getElementById('admin-disc-target').value;
        const type = document.getElementById('admin-disc-type').value;
        const value = document.getElementById('admin-disc-value').value;
        const days = document.getElementById('admin-disc-days').value;

        if(!value) return alert("Введи сумму/процент!");

        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "...";

        try {
            const user = window.auth.currentUser;
            if (!user) return alert("Сначала войдите");

            const res = await fetch(`${API_BASE_URL}/admin/set-discount`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    uid: user.uid,
                    planTarget: target,
                    type: type,
                    value: value,
                    days: days
                })
            });
            
            if(res.ok) {
                alert("Скидка запущена! Перезагрузи страницу, чтобы увидеть.");
                location.reload();
            } else {
                alert("Ошибка сервера");
                btn.disabled = false;
                btn.innerText = "Запустить";
            }
        } catch(e) { 
            console.error(e);
            alert("Ошибка сети");
            btn.disabled = false;
            btn.innerText = "Запустить";
        }
    }

    window.adminRemoveDiscount = async function() {
        const user = window.auth.currentUser;
        if (!user) return;
        
        if(!confirm("Точно отключить текущую скидку?")) return;

        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "...";

        try {
            await fetch(`${API_BASE_URL}/admin/remove-discount`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: user.uid })
            });
            alert("Скидка отключена.");
            location.reload();
        } catch (e) {
            console.error(e);
            btn.disabled = false;
            btn.innerText = "Отключить";
        }
    }

    // Флаг: есть ли несохраненные изменения?
    window.unsavedChanges = false;
    let saveInterval = null;

    // Функция, которую вызываем при ЛЮБОМ изменении (свайп, лайк, настройка)
    window.markDirty = function() {
        window.unsavedChanges = true;
        // Можно добавить визуальную индикацию, если хочешь (например, точка в углу)
    };

    // 1. Слушатель ухода с вкладки (Сворачивание / Закрытие)
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') {
            if (window.isUserLoggedIn && window.unsavedChanges) {
                console.log("App hidden, forcing save...");
                window.syncToCloud(true);
            }
        }
    });



    // 2. Таймер: сохраняем раз в 3 минуты (180 секунд), если есть изменения
    if (saveInterval) clearInterval(saveInterval);
    saveInterval = setInterval(() => {
        if (window.isUserLoggedIn && window.unsavedChanges) {
            console.log("Auto-saving by timer...");
            window.syncToCloud(true);
        }
    }, 180 * 1000); // 180 секунд = 3 минуты

    // === ЗАГРУЗКА И СЛИЯНИЕ ДАННЫХ (СЕРДЦЕ СИНХРОНИЗАЦИИ) ===
    async function loadUserData(user) {
        const userRef = doc(db, "users", user.uid);
        
        try {
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                const now = new Date();
                
                // --- ПРОВЕРКА ИСТЕЧЕНИЯ ПОДПИСКИ ---
                let cloudSub = cloudData.subscription || 'free';
                
                // Если подписка не вечная (bestie) и не бесплатная, проверяем дату
                if (cloudSub !== 'free' && cloudSub !== 'bestie' && cloudData.expiresAt) {
                    // Конвертируем Timestamp Firebase в объект Date
                    const expDate = cloudData.expiresAt.toDate ? cloudData.expiresAt.toDate() : new Date(cloudData.expiresAt);
                    
                    if (now > expDate) {
                        console.log("🚨 Subscription expired! Resetting user to FREE.");
                        cloudSub = 'free';
                        
                        // Обновляем статус в облаке немедленно
                        await updateDoc(userRef, {
                            subscription: 'free'
                        });
                    }
                }

                // Глобальные переменные (обновляем с учетом проверки)
                cachedUserProfile = { ...cloudData, subscription: cloudSub };
                window.cachedUserProfile = cachedUserProfile;
                lastProfileReadTime = Date.now();
                
                // 1. ПРИМЕНЯЕМ ПОДПИСКУ
                localStorage.setItem('xch_sub_level', cloudSub);
                if (typeof subscriptionLevel !== 'undefined') subscriptionLevel = cloudSub;
                if (window.updateSubscriptionUI) window.updateSubscriptionUI();

                // 2. СПИСКИ (Избранное, ЧС, WL)
                const mergeArrays = (local, cloud) => [...new Set([...local, ...cloud])];
                
                const mergedFav = mergeArrays(JSON.parse(localStorage.getItem('xch_favorites')) || [], cloudData.favorites || []);
                const mergedBan = mergeArrays(JSON.parse(localStorage.getItem('xch_blacklist')) || [], cloudData.blacklist || []);
                const mergedWL = mergeArrays(JSON.parse(localStorage.getItem('xch_watch_later')) || [], cloudData.watchLater || []);

                localStorage.setItem('xch_favorites', JSON.stringify(mergedFav));
                window.favorites = mergedFav;
                localStorage.setItem('xch_blacklist', JSON.stringify(mergedBan));
                window.blacklist = mergedBan;
                localStorage.setItem('xch_watch_later', JSON.stringify(mergedWL));
                window.watchLater = mergedWL;

                // 3. ИСТОРИЯ СВАЙПОВ
                const localHist = JSON.parse(localStorage.getItem('xch_history')) || [];
                const cloudHist = cloudData.history || [];
                const histMap = new Map();
                [...localHist, ...cloudHist].forEach(item => histMap.set(item.id, item));
                const mergedHistory = Array.from(histMap.values())
                    .filter(item => item && (item.timestamp || item.ts))
                    .sort((a, b) => (b.timestamp?.seconds || b.timestamp) - (a.timestamp?.seconds || a.timestamp))
                    .slice(0, 100);
                
                localStorage.setItem('xch_history', JSON.stringify(mergedHistory));
                window.historyData = mergedHistory;

                // 4. ИСТОРИЯ ПРОСМОТРОВ
                const localWatch = JSON.parse(localStorage.getItem('xch_watch_history')) || [];
                const cloudWatch = cloudData.watchHistory || [];
                const watchMap = new Map();
                [...localWatch, ...cloudWatch].forEach(item => {
                    if (item && item.id) {
                        const ts = item.timestamp?.seconds || item.timestamp || 0;
                        watchMap.set(`${item.id}_${ts}`, item);
                    }
                });
                const mergedWatch = Array.from(watchMap.values()).sort((a, b) => b.timestamp - a.timestamp).slice(0, 200);
                
                localStorage.setItem('xch_watch_history', JSON.stringify(mergedWatch));
                window.watchHistory = mergedWatch;

                // 5. ЛОГИ АКТИВНОСТИ
                const localLog = JSON.parse(localStorage.getItem('xch_activity_log')) || [];
                const cloudLog = cloudData.activityLog || [];
                const logMap = new Map();
                [...localLog, ...cloudLog].forEach(item => logMap.set((item.ts || 0) + "_" + item.id, item));
                const mergedLog = Array.from(logMap.values())
                    .filter(item => item && item.ts)
                    .sort((a, b) => (a.ts || 0) - (b.ts || 0))
                    .slice(-5000);
                
                localStorage.setItem('xch_activity_log', JSON.stringify(mergedLog));
                window.activityLog = mergedLog;

                // ФИНАЛ
                localStorage.setItem('xch_last_sync_ts', Date.now());
                if (window.updateLastSyncUI) window.updateLastSyncUI();
                if (typeof updateCounts === 'function') updateCounts();
                if (typeof renderHistory === 'function') renderHistory();
                if (typeof updateActionButtons === 'function') updateActionButtons();

                // Проверка алертов об окончании (за 3 дня)
                checkSubscriptionExpiry(); 

                if (document.getElementById('modal-sync-info-overlay').classList.contains('open')) {
                    window.openSyncInfoModal();
                }

            } else {
                localStorage.setItem('xch_sub_level', 'free');
                if (window.updateSubscriptionUI) window.updateSubscriptionUI();
                window.syncToCloud(true);
            }
        } catch (error) {
            console.error("Error loading data:", error);
        }
    }

    // === АВТО-СОХРАНЕНИЕ В ОБЛАКО ===
    window.syncToCloud = async function(immediate = false) {
        const user = auth.currentUser;
        if (!user) return; 
        if (!immediate && !window.unsavedChanges) return;

        const userRef = doc(db, "users", user.uid);
        const currentPlatform = localStorage.getItem('xch_platform') || 'xh';
        const safeJSON = (key, def) => JSON.parse(localStorage.getItem(key)) || def;

        // Берем актуальные данные из памяти (window) или из localStorage
        const wHistory = window.watchHistory || safeJSON('xch_watch_history', []);

        const dataToSave = {
            favorites: window.favorites || safeJSON('xch_favorites', []),
            blacklist: window.blacklist || safeJSON('xch_blacklist', []),
            watchLater: window.watchLater || safeJSON('xch_watch_later', []),
            tagScores: window.tagScores || safeJSON('xch_tag_scores', {}),
            
            history: (window.historyData || safeJSON('xch_history', [])).slice(0, 100),
            activityLog: (window.activityLog || safeJSON('xch_activity_log', [])).slice(-300),
            
            // ОТПРАВЛЯЕМ ОБЪЕДИНЕННУЮ ИСТОРИЮ ПРОСМОТРОВ
            watchHistory: wHistory.slice(0, 200),
            
            platform: currentPlatform,
            email: user.email,
            lastUpdated: serverTimestamp(),
            modifiersPool: window.userModifiersPool || safeJSON('xch_user_mods', []),
            exploredCount: (window.permanentExplored ? window.permanentExplored.size : 0)
        };

        try {
            await setDoc(userRef, dataToSave, { merge: true });
            
            const now = Date.now();
            localStorage.setItem('xch_last_sync_ts', now);
            window.unsavedChanges = false;
            
            const btnText = document.getElementById('sync-btn-text');
            if(btnText) {
                btnText.innerHTML = "✅ Saved";
                setTimeout(() => { if(btnText) btnText.innerHTML = "🔄 Synchronize Device"; }, 2000);
            }
            console.log(`☁️ Cloud Save Success`);
        } catch (e) {
            console.error("Auto-save error:", e);
        }
    };

    window.refreshAdminStats = async function() {
        const user = auth.currentUser;
        if (!user || user.uid !== ADMIN_UID) return;

        let btn = null;
        let originalText = "";
        
        // Используем глобальный event
        if (typeof event !== 'undefined' && event && event.target) {
            // Ищем ближайшую кнопку или div
            const target = event.target.closest('button');
            if (target) {
                btn = target;
                originalText = btn.innerText;
                btn.innerText = "Loading...";
                btn.disabled = true;
            }
        }

        try {
            const usersRef = collection(db, "users");

            // 1. Общее кол-во пользователей
            const totalSnapshot = await getCountFromServer(usersRef);
            document.getElementById('stat-total-users').innerText = totalSnapshot.data().count;

            // 2. Кол-во платных (где подписка не free)
            const premiumQuery = query(usersRef, where("subscription", "!=", "free"));
            const premiumSnapshot = await getCountFromServer(premiumQuery);
            document.getElementById('stat-premium-users').innerText = premiumSnapshot.data().count;

        } catch (e) {
            console.error("Ошибка админ-статистики:", e);
        } finally {
            // Возвращаем текст кнопки обратно
            if (btn) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    };

    // Авто-запуск при открытии админки
    const originalOpenAdminModal = window.openAdminModal;
    window.openAdminModal = function() {
        originalOpenAdminModal();
        refreshAdminStats();
    };

</script>

<script>
    let currentLang = 'en';
    let subscriptionLevel = localStorage.getItem('xch_sub_level') || 'free';
    let currentOrientation = localStorage.getItem('xch_orientation') || 'hetero';
    let cooldownList = [];
    const COOLDOWN_SIZE = 20;
    const TAG_DECAY_RATE = 0.98;
    const WRAPPED_THRESHOLD = 30;
    let data = [];
    let onbFoundLikes = [];    
    let onbFoundDislikes = [];

    let cryptoPollInterval = null;
    let cryptoTimerInterval = null;
    let currentBillingCycle = '1'; 

    let originalThemeId = null;
    let previewThemeId = null;
    let isPreviewActive = false;

    let isPanicEnabled = localStorage.getItem('xch_panic_enabled') !== 'false';
    let panicKey = localStorage.getItem('xch_panic_key') || 'Escape';
    let panicDouble = localStorage.getItem('xch_panic_is_double') !== 'false';
    let isRecordingKey = false; // Флаг записи клавиши

    let wrappedTimerInterval = null;

    let pendingOutboundUrl = '';

    const earlySponsors = [
        { name: "Alex M.", date: "Jan 2026" },
        { name: "CryptoWhale", date: "Jan 2026" }
    ];

    const BASE_PRICES = {
        pro: { monthly: 2.99, yearly: 29.99 },
        beast: { monthly: 4.99, yearly: 49.99 }
    };

    const TAG_ICONS = {

        'general': ['deco9.png'], 

        // 1. ANAL & ASS (Самые частые)
        'anal': ['anal1.png', 'anal2.png', 'anal3.png'],
        'ass': ['anal1.png', 'anal2.png'],
        'booty': ['anal1.png', 'anal2.png'],
        'big-ass': ['anal1.png', 'anal2.png'],

        // 2. BREASTS (Грудь)
        'big-tits': ['tits1.png', 'tits2.png'],
        'boobs': ['tits1.png', 'tits2.png'],
        'breasts': ['tits1.png', 'tits2.png'],
        'tit-fucking': ['tits1.png', 'tits2.png'],

        // 3. BDSM & ROUGH (Жесткое)
        'bdsm': ['bdsm1.png', 'bdsm2.png'],
        'bondage': ['bondage1.png', 'bondage2.png'],
        'rough': ['bdsm1.png', 'bdsm2.png'],
        'submission': ['bdsm1.png', 'bondage1.png'],
        'domination': ['bdsm2.png'],

        // 4. ORAL (Оральный)
        'oral': ['oral1.png', 'oral2.png'],
        'blowjob': ['oral1.png', 'oral2.png'],
        'deepthroat': ['oral1.png', 'oral2.png'],
        'licking': ['oral2.png'],

        // 5. CUM (Финал)
        'cum': ['cum1.png', 'cum2.png'],
        'creampie': ['cum1.png', 'cum2.png'],
        'cumshot': ['cum1.png', 'cum2.png'],
        'facial': ['cum1.png'],

        // 6. FEET (Ноги)
        'foot-fetish': ['feet1.png', 'feet2.png'],
        'feet': ['feet1.png', 'feet2.png'],
        'foot-worship': ['feet1.png', 'feet2.png'],

        // 7. GROUP (Групповое)
        'group': ['group1.png', 'group2.png', 'group3.png'],
        'threesome': ['group1.png', 'group2.png'],
        'gangbang': ['group3.png'],
        'orgy': ['group3.png'],

        // 8. LESBIAN (Лесби)
        'lesbian': ['lesbian1.png', 'lesbian2.png'],
        'tribadism': ['lesbian1.png', 'lesbian2.png'],
        'scissoring': ['lesbian3.png'],

        // 9. MILF (Зрелые)
        'milf': ['milf1.png', 'milf2.png'],
        'mature': ['milf1.png', 'milf2.png'],
        'mom': ['milf1.png'],

        'body-part': ['body1.png'],  
        'hentai': ['hentai1.png'],

        // 10. SOLO (Соло)
        'masturbation': ['solo1.png', 'solo2.png'],
        'solo': ['solo1.png', 'solo2.png'],
        'fingering': ['solo1.png', 'solo2.png'],

        // 11. PUBLIC/OUTDOOR (Улица)
        'public': ['public1.png', 'public2.png'],
        'outdoor': ['public1.png', 'public2.png'],
        'risky': ['public1.png'],

        // 12. ROLEPLAY/UNIFORM (Ролевые)
        'roleplay': ['roleplay1.png', 'roleplay2.png'],
        'uniform': ['roleplay1.png', 'roleplay2.png'],
        'maid': ['roleplay1.png'],
        'nurse': ['roleplay2.png'],
        'teacher': ['roleplay2.png'],

        // 13. TOYS (Игрушки)
        'toys': ['toys1.png', 'toys2.png'],
        'dildo': ['toys1.png', 'toys2.png'],
        'vibrator': ['toys1.png'],

        // 14. YOUNG/SCHOOL (Молодые)
        'schoolgirl': ['young1.png', 'young2.png'],
        'teen': ['young1.png', 'young2.png'],
        'student': ['young1.png'],

        // 15. TRANS (Транс)
        'trans': ['trans1.png', 'trans2.png', 'trans3.png'],
        'shemale': ['trans1.png', 'trans2.png'],
        'ladyboy': ['trans3.png'],

        // 16. INTERRACIAL (Межрасовое)
        'interracial': ['interracial1.png'],
        'bbc': ['interracial1.png'],
        'ebony': ['interracial1.png'],

        // 17. BBW (Пышки)
        'bbw': ['bbw1.png'],
        'fat': ['bbw1.png'],
        'chubby': ['bbw1.png'],

        // 18. LEGS/STOCKINGS (Чулки/Ноги)
        'stockings': ['legs1.png', 'legs2.png'],
        'legs': ['legs1.png', 'legs2.png'],
        'pantyhose': ['legs1.png', 'legs2.png'],
        'high-heels': ['legs2.png'],

        // 19. HARDCORE (Жесть)
        'hardcore': ['hardcore1.png'],
        'extreme': ['hardcore1.png'],
        'rough-sex': ['hardcore1.png'],

        // 20. ROMANCE (Романтика)
        'romance': ['romantic1.png', 'romantic2.png'],
        'passionate': ['romantic1.png', 'romantic2.png'],
        'kissing': ['romantic1.png']
    };

    const NEUTRAL_DECOS = [
        'deco1.png', 'deco2.png', 'deco3.png', 'deco4.png', 'deco5.png',
        'deco6.png', 'deco7.png', 'deco9.png', 'deco10.png', 'deco11.png'
    ];

    // ОБНОВЛЕННЫЙ МАССИВ ДАННЫХ
    const EXPLORED_GROUPS = [
        { 
            id: 'general', iconTag: 'general', tags: ['general', 'specific', 'softcore', 'vanilla', 'romantic', 'sensual'],
            achIcon: 'ach_general.png', // Картинка достижения (большая)
            appIcon: 'icon_app_general.png', // Награда: Иконка приложения (маленькая)
            desc_en: "The absolute entire database of fetishes that we managed to find 😈.",
            desc_ru: "Абсолютно вся база фетишей, которую удалось найти 😈.",
            desc_es: "Toda la base de datos de fetiches que logramos encontrar 😈.",
            desc_de: "Die absolut gesamte Datenbank an Fetischen, die wir finden konnten 😈."
        },
        { 
            id: 'solo', iconTag: 'solo', tags: ['solo', 'masturbation', 'fingering', 'autofellatio', 'handjob', 'hands', 'suck-off'],
            achIcon: 'ach_solo.png',
            desc_en: "Focus on the individual. Intimate moments alone.",
            desc_ru: "Фокус на одном человеке. Интимные моменты наедине с собой.",
            desc_es: "Enfoque en el individuo. Momentos íntimos a solas.",
            desc_de: "Fokus auf das Individuum. Intime Momente allein."
        },
        { 
            id: 'anal', iconTag: 'anal', tags: ['anal', 'ass', 'booty', 'gap', 'rimming', 'prostate-massage', 'anal-training', 'asshole', 'fisting', 'gaping', 'pegging'],
            achIcon: 'ach_anal.png',
            desc_en: "Exploring the backdoor. From soft rimming to hardcore fisting.",
            desc_ru: "Исследование черного хода. От нежного римминга до жесткого фистинга.",
            desc_es: "Explorando la puerta trasera. Desde rimming suave hasta fisting duro.",
            desc_de: "Erkundung der Hintertür. Von sanftem Rimming bis hin zu Hardcore-Fisting."
        },
        { 
            id: 'breasts', iconTag: 'big-tits', tags: ['tits', 'big-tits', 'small-tits', 'nipples', 'lactation', 'breast-expansion', 'tit-fucking', 'breastfeeding'],
            achIcon: 'ach_breasts.png',
            desc_en: "Worship of the chest. Size, shape, and lactation play.",
            desc_ru: "Поклонение груди. Размер, форма и игры с лактацией.",
            desc_es: "Adoración del pecho. Tamaño, forma y juegos de lactancia.",
            desc_de: "Verehrung der Brust. Größe, Form und Laktationsspiele."
        },
        { 
            id: 'oral', iconTag: 'oral', tags: ['oral', 'blowjob', 'cunnilingus', 'deepthroat', 'face-fucking', 'spitting', 'gagging', 'throat', 'licking', 'tongue'],
            achIcon: 'ach_oral.png',
            desc_en: "The art of oral pleasure. Skillful tongue and throat work.",
            desc_ru: "Искусство орального удовольствия. Мастерская работа языком и горлом.",
            desc_es: "El arte del placer oral. Trabajo hábil de lengua y garganta.",
            desc_de: "Die Kunst der oralen Lust. Geschickte Zungen- und Rachenarbeit."
        },
        { 
            id: 'hardcore', iconTag: 'bdsm', tags: ['hardcore', 'bdsm', 'kinky', 'rough', 'pain', 'choking', 'bondage', 'rope', 'slave', 'domination', 'submission', 'spanking', 'whip', 'torture', 'humiliation', 'femdom', 'cbt'],
            achIcon: 'ach_hardcore.png',
            appIcon: 'icon_app_bdsm.png', // Иконка БДСМ
            desc_en: "Power exchange and intensity. Pain, control, and submission.",
            desc_ru: "Обмен властью и интенсивность. Боль, контроль и подчинение.",
            desc_es: "Intercambio de poder e intensidad. Dolor, control y sumisión.",
            desc_de: "Machtaustausch und Intensität. Schmerz, Kontrolle und Unterwerfung."
        },
        { 
            id: 'lgbt', iconTag: 'lesbian', tags: ['gay', 'lesbian', 'trans', 'bi', 'shemale', 'futanari', 'crossdresser', 't4t', 'ladyboy', 'sissy', 'trap', 'yuri', 'yaoi'],
            achIcon: 'ach_lgbt.png',
            appIcon: 'icon_app_lgbt.png', // Иконка ЛГБТ
            desc_en: "Spectrum of sexuality. Same-sex and trans experiences.",
            desc_ru: "Спектр сексуальности. Однополые отношения и транс-опыт.",
            desc_es: "Espectro de la sexualidad. Experiencias del mismo sexo y trans.",
            desc_de: "Spektrum der Sexualität. Gleichgeschlechtliche und Trans-Erfahrungen."
        },
        { 
            id: 'group', iconTag: 'group', tags: ['group', 'threesome', 'gangbang', 'orgy', 'cuckold', 'sharing', 'swingers', 'double-penetration', 'bukkake'],
            achIcon: 'ach_group.png',
            desc_en: "The more the merrier. Multiple partners and shared pleasure.",
            desc_ru: "Чем больше, тем веселее. Множество партнеров и общее удовольствие.",
            desc_es: "Cuantos más, mejor. Múltiples parejas y placer compartido.",
            desc_de: "Je mehr, desto besser. Mehrere Partner und gemeinsames Vergnügen."
        },
        { 
            id: 'feet', iconTag: 'feet', tags: ['feet', 'foot-fetish', 'legs', 'toes', 'stockings', 'shoes', 'boots', 'socks', 'pantyhose', 'high-heels', 'soles'],
            achIcon: 'ach_feet.png',
            appIcon: 'icon_app_feet.png', // Иконка Ноги
            desc_en: "From toes to thighs. Appreciation of feet, legs, and footwear.",
            desc_ru: "От пальчиков до бедер. Обожание ног, ступней и обуви.",
            desc_es: "De los dedos a los muslos. Apreciación de pies, piernas y calzado.",
            desc_de: "Von den Zehen bis zu den Oberschenkeln. Wertschätzung von Füßen, Beinen und Schuhwerk."
        },
        { 
            id: 'roleplay', iconTag: 'roleplay', tags: ['roleplay', 'uniform', 'costume', 'teacher', 'nurse', 'cosplay', 'maid', 'cheerleader', 'police', 'military', 'office', 'secretary'],
            achIcon: 'ach_roleplay.png',
            appIcon: 'icon_app_roleplay.png', // Иконка Ролплей
            desc_en: "Acting out fantasies. Uniforms, costumes, and scenarios.",
            desc_ru: "Воплощение фантазий. Униформа, костюмы и сценарии.",
            desc_es: "Representando fantasías. Uniformes, disfraces y escenarios.",
            desc_de: "Fantasien ausleben. Uniformen, Kostüme und Szenarien."
        },
        { 
            id: 'public', iconTag: 'public', tags: ['public', 'outdoor', 'risky', 'taboo', 'voyeur', 'exhibitionism', 'incest', 'family', 'step-mom', 'step-sister', 'car', 'beach'],
            achIcon: 'ach_public.png',
            desc_en: "The thrill of getting caught. Outdoor acts and forbidden taboos.",
            desc_ru: "Азарт быть пойманным. Секс на улице и запретные табу.",
            desc_es: "La emoción de ser atrapado. Actos al aire libre y tabúes prohibidos.",
            desc_de: "Der Nervenkitzel, erwischt zu werden. Outdoor-Akte und verbotene Tabus."
        },
        { 
            id: 'body', iconTag: 'body-part', tags: ['body-type', 'body-part', 'bbw', 'skinny', 'muscle', 'face', 'hair', 'tattoo', 'piercing', 'chubby', 'fat', 'hairy', 'redhead', 'blonde', 'brunette', 'milf', 'teen', 'interracial'],
            achIcon: 'ach_body.png',
            appIcon: 'icon_app_body.png', // Иконка Тело
            desc_en: "Celebrating specific forms. Shapes, colors, and physical traits.",
            desc_ru: "Восхищение формами. Фигуры, цвета и физические особенности.",
            desc_es: "Celebrando formas específicas. Formas, colores y rasgos físicos.",
            desc_de: "Feier spezifischer Formen. Formen, Farben und körperliche Merkmale."
        },
        { 
            id: 'toys', iconTag: 'toys', tags: ['toys', 'dildo', 'vibrator', 'machine', 'plug', 'strap-on', 'sybian', 'doll'],
            achIcon: 'ach_toys.png',
            desc_en: "Synthetic assistance. Gadgets and machines for pleasure.",
            desc_ru: "Синтетическая помощь. Гаджеты и машины для удовольствия.",
            desc_es: "Asistencia sintética. Gadgets y máquinas para el placer.",
            desc_de: "Synthetische Unterstützung. Gadgets und Maschinen für das Vergnügen."
        },
        { 
            id: 'mess', iconTag: 'cum', tags: ['cum', 'creampie', 'mess', 'squirting', 'facial', 'wet', 'piss', 'scat', 'vomit', 'sweat', 'mud', 'oil', 'slime'],
            achIcon: 'ach_mess.png',
            desc_en: "Wet and wild. Body fluids, oil, and messy fun.",
            desc_ru: "Мокро и грязно. Телесные жидкости, масло и беспорядок.",
            desc_es: "Húmedo y salvaje. Fluidos corporales, aceite y diversión desordenada.",
            desc_de: "Nass und wild. Körperflüssigkeiten, Öl und schmutziger Spaß."
        },
        { 
            id: 'fantasy', iconTag: 'hentai', tags: ['fantasy', 'hentai', 'anime', 'art', 'visual', 'cartoon', 'monster', 'alien', 'giantess', 'vore', 'furry', 'transformation'],
            achIcon: 'ach_fantasy.png',
            appIcon: 'icon_app_fantasy.png', // Иконка Фантазия
            desc_en: "Beyond reality. Animated, drawn, and supernatural desires.",
            desc_ru: "За гранью реальности. Анимация, рисунки и сверхъестественное.",
            desc_es: "Más allá de la realidad. Deseos animados, dibujados y sobrenaturales.",
            desc_de: "Jenseits der Realität. Animierte, gezeichnete und übernatürliche Wünsche."
        },
        { 
            id: 'clothing', iconTag: 'legs', tags: ['clothing', 'latex', 'leather', 'lingerie', 'spandex', 'nylon', 'satin', 'dress', 'skirt', 'underwear', 'panties', 'bikini'],
            achIcon: 'ach_clothing.png',
            desc_en: "Material fetishism. Fabric textures and specific outfits.",
            desc_ru: "Фетишизм материалов. Текстуры тканей и специфические наряды.",
            desc_es: "Fetichismo material. Texturas de telas y atuendos específicos.",
            desc_de: "Materialfetischismus. Stofftexturen und spezifische Outfits."
        }
    ];

    const CHANGELOG_DATA = [
        {
            ver: "0.2",
            date: "Feb 2026",
            changes: {
                en: ["Achievements system added 🏆."],
                ru: ["Добавлена система достижений 🏆."],
                es: ["Sistema de logros añadido 🏆."],
                de: ["Erfolgssystem hinzugefügt 🏆."]
            }
        },
        {
            ver: "0.1",
            date: "Jan 2026",
            changes: {
                en: ["I was born 👶. First public release."],
                ru: ["Я родился 👶. Первый публичный релиз."],
                es: ["Nací 👶. Primer lanzamiento público."],
                de: ["Ich wurde geboren 👶. Erste öffentliche Veröffentlichung."]
            }
        }
    ];

    let watchStartTime = 0; // Время ухода с сайта

    let permanentExplored = new Set(JSON.parse(localStorage.getItem('xch_permanent_explored')) || []);

    let achievementDates = JSON.parse(localStorage.getItem('xch_achievement_dates')) || {};

    // Слушатель возвращения на вкладку
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            // === ЛОГИКА ЗАКРЫТИЯ МОДИФИКАТОРОВ ПРИ ВОЗВРАТЕ ===
            const capsule = document.getElementById('mods-capsule');
            if (capsule && capsule.classList.contains('open')) {
                // Просто вызываем функцию переключения, она сама снимет класс и блюр
                toggleModifiers(); 
            }

            if (typeof watchStartTime !== 'undefined' && watchStartTime > 0) {
                calculateWatchTime();
            }
        } else {
            // Логика при уходе в фон (сохранение в облако и т.д.)
            if (window.isUserLoggedIn && window.unsavedChanges) {
                window.syncToCloud(true);
            }
        }
    });

    const DAILY_LIMIT = 50;
    let currentItem = null;
    let lastGeneratedItem = null; 
    let hasInteractedWithCurrent = false;

    let suggestedFavId = null;
    let suggestedNewId = null; 

    let pendingPlan = null;

    let activeMods = new Set();
    let isGenerating = false;
    let isFirstGen = true;
    let hasWatchedCurrentItem = false;
    let currentIntensity = 1; 
    
    // STATS STATE
    let currentStatsTab = 'tags';
    let currentStatsTimeframe = 'all';

    // Tinder
    let startX = 0, startY = 0;
    let currentX = 0, currentY = 0;
    let isDragging = false;
    const card = document.getElementById('card-block');
    const overlayLike = document.querySelector('.overlay-like');
    const overlayNope = document.querySelector('.overlay-nope');

    let sessionHistoryStack = [];

    let onboardingSelectedIds = [];

    let currentSlideIndex = 0;
    let slideInterval;
    let itemBeingWatched = null; 
    let currentHistoryTab = 'swipes';

    let currentAppMode = 'explore';
    let aiContextTokens = [];
    let isModeSelectActive = false; 

    let viewedTips = JSON.parse(localStorage.getItem('xch_viewed_tips')) || [];

    const API_BASE_URL = "https://api.fetishback.site";

    const STORAGE = {
        THEME: 'xch_theme',
        LANG: 'xch_lang',
        BLACKLIST: 'xch_blacklist',
        FAVORITES: 'xch_favorites',
        WATCH_LATER: 'xch_watch_later',
        INTENSITY: 'xch_intensity',
        TAG_SCORES: 'xch_tag_scores',
        HISTORY: 'xch_history',
        ACTIVITY_LOG: 'xch_activity_log',
        WATCH_HISTORY: 'xch_watch_history'
    };

    const APP_THEMES = [
        // === BASIC (Row 1) ===
        { id: 'dark', name: 'Dark (Cyber)', type: 'free', isLight: false, preview: '#ff00cc', accent: null },
        { id: 'light', name: 'Light (Sakura)', type: 'free', isLight: true, preview: '#ffeef8', accent: null },
        
        // === PREMIUM ===
        { 
            id: 'noir', name: 'Noir', type: 'pro', isLight: false, preview: '#000000',
            colors: { bg: '#000000', sidebar: '#0a0a0a', card: '#141414', nav: '#141414', border: '#333333' },
            accent: '#ffffff', accentLight: '#cccccc'
        },
        { 
            id: 'blue-dark', name: 'Midnight', type: 'pro', isLight: false, preview: '#0a192f',
            colors: { bg: '#020c1b', sidebar: '#0a192f', card: '#112240', nav: '#112240', border: '#233554' },
            accent: '#64ffda', accentLight: '#94ffea'
        },
        { 
            id: 'green-dark', name: 'Forest', type: 'pro', isLight: false, preview: '#051405',
            colors: { bg: '#020a02', sidebar: '#051405', card: '#0f290f', nav: '#0f290f', border: '#1a401a' },
            accent: '#2ecc71', accentLight: '#58d68d'
        },
        { 
            id: 'red-dark', name: 'Vampire', type: 'pro', isLight: false, preview: '#1a0000',
            colors: { bg: '#0d0000', sidebar: '#1a0000', card: '#330000', nav: '#330000', border: '#4d0000' },
            accent: '#e74c3c', accentLight: '#ff6b6b'
        },
        { 
            id: 'gold-dark', name: 'Luxury', type: 'pro', isLight: false, preview: '#141100',
            colors: { bg: '#0a0900', sidebar: '#141100', card: '#292200', nav: '#292200', border: '#4d4000' },
            accent: '#f1c40f', accentLight: '#f4d03f'
        },
        { 
            id: 'purple-dark', name: 'Amethyst', type: 'pro', isLight: false, preview: '#3b005e',
            colors: { bg: '#0d0014', sidebar: '#180026', card: '#240038', nav: '#240038', border: '#4a0072' },
            accent: '#9d00ff', accentLight: '#c466ff'
        },
        { 
            id: 'orange-dark', name: 'Magma', type: 'pro', isLight: false, preview: '#331a00',
            colors: { bg: '#0f0700', sidebar: '#1f0f00', card: '#331a00', nav: '#331a00', border: '#663300' },
            accent: '#ff6600', accentLight: '#ff9933'
        },
        { 
            id: 'old-money', 
            name: 'Old Money', 
            type: 'pro', 
            isLight: false, 
            preview: '#1a0505', // Темный квадрат для превью
            colors: { bg: '#1a0505', sidebar: '#260909', card: '#2e0b0b', nav: '#2e0b0b', border: '#4a1919' },
            accent: '#c5a059', 
            accentLight: '#e6c98c'
        }
    ];

    let blacklist = JSON.parse(localStorage.getItem(STORAGE.BLACKLIST)) || [];
    let favorites = JSON.parse(localStorage.getItem(STORAGE.FAVORITES)) || [];
    let protectedFavorites = JSON.parse(localStorage.getItem('xch_protected_favorites')) || [];
    let itemScores = JSON.parse(localStorage.getItem('xch_item_scores')) || {};
    let watchLater = JSON.parse(localStorage.getItem(STORAGE.WATCH_LATER)) || [];
    let tagScores = JSON.parse(localStorage.getItem(STORAGE.TAG_SCORES)) || {};
    let historyData = JSON.parse(localStorage.getItem(STORAGE.HISTORY)) || [];
    let watchHistory = JSON.parse(localStorage.getItem(STORAGE.WATCH_HISTORY)) || [];
    let activityLog = JSON.parse(localStorage.getItem(STORAGE.ACTIVITY_LOG)) || [];

    let activeDiscount = null;

    const modifiersData = [
        { key: 'Amateur', en: 'Amateur', ru: 'Любительское', es: 'Amateur', de: 'Amateur' },
        { key: 'POV', en: 'POV', ru: 'POV', es: 'POV', de: 'POV' },
        { key: 'Hardcore', en: 'Hardcore', ru: 'Жесткое', es: 'Hardcore', de: 'Hardcore' },
        { key: 'Homemade', en: 'Homemade', ru: 'Домашнее', es: 'Casero', de: 'Hausgemacht' },
        { key: 'Oiled', en: 'Oiled', ru: 'В масле', es: 'Aceite', de: 'Eingeölt' },
        { key: 'Gay', en: 'Gay', ru: 'Геи', es: 'Gay', de: 'Schwul' },
        { key: 'BBW', en: 'BBW', ru: 'BBW', es: 'BBW', de: 'BBW' },
        { key: 'Lesbian', en: 'Lesbian', ru: 'Лесби', es: 'Lesbianas', de: 'Lesbisch' },
        { key: 'Trans', en: 'Trans', ru: 'Транс', es: 'Trans', de: 'Trans' },
        { key: 'Orgy', en: 'Orgy', ru: 'Оргия', es: 'Orgía', de: 'Orgie' },
        { key: 'VR', en: 'VR', ru: 'VR', es: 'RV (VR)', de: 'VR' },
        { key: 'Compilation', en: 'Compilation', ru: 'Сборник', es: 'Compilación', de: 'Kompilation' },
        { key: 'Vintage', en: 'Vintage', ru: 'Ретро', es: 'Vintage', de: 'Vintage' },
        { key: 'Solo', en: 'Solo', ru: 'Соло', es: 'Solo', de: 'Solo' },
        { key: 'AI', en: 'AI', ru: 'ИИ', es: 'IA', de: 'KI' },
        { key: 'Squirt', en: 'Squirt', ru: 'Сквирт', es: 'Squirt', de: 'Squirt' },
        { key: 'Uncensored', en: 'Uncensored', ru: 'Без цензуры', es: 'Sin censura', de: 'Unzensiert' }
    ];

    const SITES_DATA = [
        // --- ТОП ГИГАНТЫ ---
        { 
            id: 'ph', name: 'Pornhub', 
            url: 'https://www.pornhub.com/video/search?search={q}', sep: '+',
            tags: ['general', 'high-quality', 'vr'],
            desc: { en: "Universal choice. Trends, 4K.", ru: "Универсальный выбор. Тренды, 4K.", es: "Elección universal. Tendencias, 4K.", de: "Universelle Wahl. Trends, 4K." }
        },
        { 
            id: 'xv', name: 'XVideos', 
            url: 'https://www.xvideos.com/?k={q}', sep: '+',
            tags: ['amateur', 'general', 'trans'],
            desc: { en: "Largest library. Fast load.", ru: "Самая большая библиотека. Быстро.", es: "La biblioteca más grande. Rápido.", de: "Größte Bibliothek. Schnell." }
        },
        { 
            id: 'xh', name: 'xHamster', 
            url: 'https://xhamster.com/search/{q}', sep: '+',
            tags: ['amateur', 'live', 'mature'],
            desc: { en: "Amateur & User content.", ru: "Любительское и домашнее видео.", es: "Contenido amateur y de usuarios.", de: "Amateur- & Nutzerinhalte." }
        },
        { 
            id: 'xn', name: 'XNXX', 
            url: 'https://www.xnxx.com/search/{q}', sep: '+',
            tags: ['general', 'old', 'rough'],
            desc: { en: "Fast search, rare videos.", ru: "Быстрый поиск, редкие видео.", es: "Búsqueda rápida, videos raros.", de: "Schnelle Suche, seltene Videos." }
        },
        // --- КАЧЕСТВО & ДЛИННЫЕ ---
        { 
            id: 'sb', name: 'SpankBang', 
            url: 'https://spankbang.com/s/{q}/', sep: '+',
            tags: ['hd', 'full-length', '4k'],
            desc: { en: "Full-length videos, no ads.", ru: "Полные видео без рекламы.", es: "Videos completos, sin anuncios.", de: "Videos in voller Länge, keine Werbung." }
        },
        { 
            id: 'epo', name: 'Eporner', 
            url: 'https://www.eporner.com/search/{q}/', sep: '-',
            tags: ['4k', '60fps', 'hd'],
            desc: { en: "High Quality 4K/60fps.", ru: "Высокое качество 4K/60fps.", es: "Alta calidad 4K/60fps.", de: "Hohe Qualität 4K/60fps." }
        },
        // --- КЛАССИКА TUBE ---
        { 
            id: 'yp', name: 'YouPorn', 
            url: 'https://www.youporn.com/search/?query={q}', sep: '+',
            tags: ['general', 'clean'],
            desc: { en: "Clean interface, less ads.", ru: "Чистый интерфейс, меньше рекламы.", es: "Interfaz limpia, menos anuncios.", de: "Saubere Oberfläche, weniger Werbung." }
        },
        { 
            id: 'rt', name: 'RedTube', 
            url: 'https://www.redtube.com/?search={q}', sep: '+',
            tags: ['classic', 'professional'],
            desc: { en: "Classic, stable viewing.", ru: "Классика, стабильный просмотр.", es: "Clásico, visualización estable.", de: "Klassisch, stabile Wiedergabe." }
        },
        { 
            id: 't8', name: 'Tube8', 
            url: 'https://www.tube8.com/search/videos?q={q}', sep: '+',
            tags: ['hardcore', 'long'],
            desc: { en: "Long scenes, old hits.", ru: "Длинные сцены, старые хиты.", es: "Escenas largas, éxitos antiguos.", de: "Lange Szenen, alte Hits." }
        },
        { 
            id: 'pcom', name: 'Porn.com', 
            url: 'https://www.porn.com/videos/search?q={q}', sep: '+',
            tags: ['general'],
            desc: { en: "Simple category search.", ru: "Простой поиск по категориям.", es: "Búsqueda sencilla por categorías.", de: "Einfache Kategoriesuche." }
        },
        // --- УДОБНЫЕ / МОБИЛЬНЫЕ ---
        { 
            id: 'thumb', name: 'Thumbzilla', 
            url: 'https://www.thumbzilla.com/video/search?q={q}', sep: '+',
            tags: ['mobile', 'simple'],
            desc: { en: "Minimalist, no distractions.", ru: "Минимализм, ничего лишнего.", es: "Minimalista, sin distracciones.", de: "Minimalistisch, keine Ablenkungen." }
        },
        { 
            id: 'ixxx', name: 'IXXX', 
            url: 'https://www.ixxx.com/search/{q}', sep: '-',
            tags: ['mobile', 'fast'],
            desc: { en: "Fast start, many categories.", ru: "Быстрый старт, много категорий.", es: "Inicio rápido, muchas categorías.", de: "Schnellstart, viele Kategorien." }
        },
        { 
            id: 'pone', name: 'PornOne', 
            url: 'https://pornone.com/?s={q}', sep: '+',
            tags: ['general'],
            desc: { en: "Classic tube, no signup.", ru: "Классический туб без регистрации.", es: "Tubo clásico, sin registro.", de: "Klassische Röhre, keine Anmeldung." }
        },
        { 
            id: 'tna', name: 'TnaFlix', 
            url: 'https://www.tnaflix.com/search.php?q={q}', sep: '+',
            tags: ['retro', 'amateur'],
            desc: { en: "Amateur & Retro content.", ru: "Любительское и ретро.", es: "Contenido amateur y retro.", de: "Amateur- & Retro-Inhalte." }
        },
        // --- JAV & ASIAN ---
        { 
            id: 'miss', name: 'MissAV', 
            url: 'https://missav.com/search/{q}', sep: '-',
            tags: ['jav', 'asian', 'uncensored'],
            desc: { en: "Best JAV library (Subs).", ru: "Лучшая библиотека JAV (субтитры).", es: "Mejor biblioteca JAV (Subs).", de: "Beste JAV-Bibliothek (Untertitel)." }
        },
        { 
            id: 'sup', name: 'SupJav', 
            url: 'https://supjav.com/?s={q}', sep: '+',
            tags: ['jav', 'asian', 'censored'],
            desc: { en: "Huge JAV collection.", ru: "Огромный выбор японского порно.", es: "Enorme colección JAV.", de: "Riesige JAV-Sammlung." }
        },
        // --- HENTAI & TOON ---
        { 
            id: 'hh', name: 'Hentai Haven', 
            url: 'https://hentaihaven.xxx/?s={q}', sep: '+',
            tags: ['hentai', 'anime', 'cartoon', 'fantasy'],
            desc: { en: "Anime porn & 3D.", ru: "Хентай и аниме порно.", es: "Porno anime y 3D.", de: "Anime-Porno & 3D." }
        },
        { 
            id: 'r34', name: 'Rule34', 
            url: 'https://rule34video.com/search/{q}/', sep: '+',
            tags: ['rule34', '3d', 'sfm', 'overwatch'],
            desc: { en: "Rule34 / Memes / Games.", ru: "Rule34 / Мемы / Игры.", es: "Rule34 / Memes / Juegos.", de: "Rule34 / Memes / Spiele." }
        },
        // --- EXTREME & SPECIFIC ---
        { 
            id: 'mom', name: 'Motherless', 
            url: 'https://motherless.com/search/videos?q={q}', sep: '+',
            tags: ['extreme', 'fetish', 'scat', 'piss', 'fisting'],
            desc: { en: "Extreme, fetish, shock.", ru: "Экстрим, фетиш, шок-контент.", es: "Extremo, fetiche, shock.", de: "Extrem, Fetisch, Schock." }
        },
        { 
            id: 'ero', name: 'EroMe', 
            url: 'https://www.erome.com/search?q={q}', sep: '+',
            tags: ['pics', 'short', 'albums'],
            desc: { en: "Photos & Short clips.", ru: "Фото и короткие клипы.", es: "Fotos y clips cortos.", de: "Fotos & kurze Clips." }
        }
    ];

    // Дефолтный пул
    const DEFAULT_MODS_POOL = []; 

    // Загрузка
    let userModifiersPool = [];
    try {
        const saved = JSON.parse(localStorage.getItem('xch_user_mods'));
        // Если в памяти что-то есть (массив), берем его. Иначе — пустой массив.
        userModifiersPool = Array.isArray(saved) ? saved : [];
    } catch (e) {
        userModifiersPool = [];
    }

    localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));

    const STOP_WORDS = [
        "i", "want", "need", "show", "me", "some", "video", "porn", "please", "today", "now", "like", "love", "looking", "for",
        "surprise", "give", "find", "search", "something", "about", "with",
        "я", "хочу", "покажи", "мне", "что-то", "сегодня", "сейчас", "люблю", "нравится", "нужен", "нужна", "посоветуй",
        "удиви", "дай", "найди", "поиск", "какой-нибудь", "про", "с", "на", "тему", "типа", "наподобие",
        "quiero", "ver", "dame", "algo", "hoy", "ahora", "gusta", "necesito", "sorprendeme", "busca",
        "ich", "will", "möchte", "zeig", "mir", "heute", "jetzt", "überrasch", "suche"
    ];

    const CLEAN_PHRASES = [
        "связанное с", "относящееся к", "похожее на", // RU
        "related to", "connected with", "similar to", // EN
        "relacionado con", "parecido a", // ES
        "ähnlich wie", "verbunden mit", "bezogen auf" // DE
    ];

    const NEGATIVES = [
        "no ", "without ", "not ", "except ", // EN
        "без ", "не ", "кроме ", // RU
        "sin ", "no ", "excepto ", // ES
        "ohne ", "kein ", "außer " // DE
    ];

    const SPECIAL_COMMANDS = {
        surprise: {
            en: ["surprise", "random", "lucky"],
            ru: ["удиви", "случайно", "рандом", "что угодно"],
            es: ["sorprende", "aleatorio", "suerte"],
            de: ["überrasch", "zufall", "glück"]
        },
        yesterday: {
            en: ["yesterday", "last time", "again"],
            ru: ["вчера", "прошлый раз", "повтори", "как раньше"],
            es: ["ayer", "ultima vez", "otra vez"],
            de: ["gestern", "letztes mal", "wieder"]
        }
    };

    const welcomePhrases = {
        en: [
            "Thought you wouldn't come back 😁",
            "You come here often, don't you? 😏",
            "Let's skip the foreplay 🌚",
            "Ready to sin? 😈",
            "I missed you... barely.",
            "Back for more? I knew it.",
            "Your incognito tab missed you.",
            "Let's find something dirty.",
            "Bored or horny? Let's fix both.",
            "Don't tell anyone you're here 🤫"
        ],
        ru: [
            "Думал, ты больше не вернёшься 😁",
            "Как-то ты часто здесь появляешься 😏",
            "Давай без прелюдий 🌚",
            "Твой режим инкогнито скучал по мне.",
            "Снова здесь? Я так и знал.",
            "Скучно или одиноко? Сейчас исправим.",
            "Только никому не говори, что ты здесь 🤫",
            "Готов согрешить? 😈",
            "Ищем что-то новенькое или как обычно?",
            "Надеюсь, ты в наушниках..."
        ],
        es: [
            "Pensé que no volverías 😁",
            "Vienes muy seguido por aquí 😏",
            "Saltemos los juegos previos 🌚",
            "¿Listo para pecar? 😈",
            "Tu modo incógnito te extrañaba.",
            "¿De nuevo aquí? Lo sabía.",
            "No le digas a nadie que estás aquí 🤫",
            "¿Aburrido o caliente? Arreglemos eso.",
            "Busquemos algo sucio.",
            "Espero que tengas audífonos..."
        ],
        de: [
            "Dachte, du kommst nicht zurück 😁",
            "Du bist aber oft hier 😏",
            "Lass uns das Vorspiel überspringen 🌚",
            "Bereit zu sündigen? 😈",
            "Dein Inkognito-Tab hat dich vermisst.",
            "Schon wieder hier? Wusste ich es doch.",
            "Erzähl niemandem, dass du hier bist 🤫",
            "Langeweile oder Lust? Lösen wir beides.",
            "Lass uns etwas Schmutziges finden.",
            "Hoffentlich hast du Kopfhörer auf..."
        ]
    };

    const firstTimePhrase = {
        en: "Glad to see more people here 😏",
        ru: "Рад видеть ещё людей здесь 😏",
        es: "Me alegra ver más gente aquí 😏",
        de: "Schön, mehr Leute hier zu sehen 😏"
    };

    let statusHideTimeout = null;

    function setWelcomeMessage() {
        const statusEl = document.getElementById('status-text');
        if(!statusEl) return;
        
        // Сброс предыдущего таймера
        if (statusHideTimeout) clearTimeout(statusHideTimeout);
        
        // Показываем текст
        const phrases = welcomePhrases[currentLang] || welcomePhrases.en;
        statusEl.innerText = phrases[Math.floor(Math.random() * phrases.length)];
        statusEl.style.color = "var(--accent)"; 
        statusEl.style.opacity = "1"; // Убеждаемся, что видно
        
        // Таймер на скрытие через 5 секунд
        statusHideTimeout = setTimeout(() => {
            statusEl.style.transition = "opacity 1s ease";
            statusEl.style.opacity = "0";
        }, 5000);
    }
    const wlReminderPhrases = {
        en: [
            "Seems like you wanted to watch this... 👀",
            "You saved this for later. Is 'later' now? 😏",
            "A reminder from your personal stash 📂",
            "Don't let this wait forever 🔥",
            "Your past self had good taste ✨"
        ],
        ru: [
            "Кажется, ты хотел это посмотреть... 👀",
            "Ты отложил это на потом. 'Потом' наступило? 😏",
            "Напоминание из твоей личной коллекции 📂",
            "Не заставляй это ждать вечно 🔥",
            "У твоего прошлого 'я' был отличный вкус ✨"
        ],
        es: [
            "Parece que querías ver esto... 👀",
            "Guardaste esto para luego. ¿Es ahora? 😏",
            "Un recordatorio de tu colección personal 📂",
            "No lo hagas esperar para siempre 🔥",
            "Tu yo del pasado tenía buen gusto ✨"
        ],
        de: [
            "Scheint, als wolltest du das sehen... 👀",
            "Du hast das für später gespeichert. Ist jetzt 'später'? 😏",
            "Eine Erinnerung aus deiner Sammlung 📂",
            "Lass es nicht ewig warten 🔥",
            "Dein früheres Ich hatte guten Geschmack ✨"
        ]
    };

    const favReminderPhrases = {
        en: [
            "Let's remember this gem? 💎",
            "A classic from your collection ✨",
            "Ready for round two? 🔄",
            "You loved this one. Still do? 😏",
            "Oldie but goldie 🔥"
        ],
        ru: [
            "Давай вспомним это ещё раз? 💎",
            "Классика твоей коллекции ✨",
            "Готов ко второму раунду? 🔄",
            "Тебе это нравилось. Всё ещё? 😏",
            "Старый друг лучше новых двух 🔥"
        ],
        es: [
            "¿Recordamos esta joya? 💎",
            "Un clásico de tu colección ✨",
            "¿Listo para la segunda ronda? 🔄",
            "Te encantó esto. ¿Aún te gusta? 😏",
            "Viejo pero bueno 🔥"
        ],
        de: [
            "Erinnern wir uns an dieses Juwel? 💎",
            "Ein Klassiker aus deiner Sammlung ✨",
            "Bereit für Runde zwei? 🔄",
            "Du hast das geliebt. Immer noch? 😏",
            "Alt aber gold 🔥"
        ]
    };

    const banReminderPhrases = {
        en: [
            "Maybe give it another shot? 🤔",
            "Tastes change... do yours? 🤨",
            "Are you sure you hate this? 🧐",
            "Everyone deserves a second chance 👻",
            "Risky click of the day 🎲"
        ],
        ru: [
            "Может дашь ещё шанс? 🤔",
            "Вкусы меняются... а твои? 🤨",
            "Точно уверен, что не нравится? 🧐",
            "Все заслуживают второй шанс 👻",
            "Рискнём ещё разок? 🎲"
        ],
        es: [
            "¿Quizás darle otra oportunidad? 🤔",
            "Los gustos cambian... ¿los tuyos? 🤨",
            "¿Seguro que odias esto? 🧐",
            "Todos merecen una segunda oportunidad 👻",
            "El riesgo del día 🎲"
        ],
        de: [
            "Vielleicht noch eine Chance geben? 🤔",
            "Geschmäcker ändern sich... deiner auch? 🤨",
            "Sicher, dass du das hasst? 🧐",
            "Jeder verdient eine zweite Chance 👻",
            "Risiko des Tages 🎲"
        ]
    };

    const animationPhrases = {
        en: ["Finding your fetish...", "Scanning the hub...", "What will it be?", "Looking for spicy stuff..."],
        ru: ["Ищем твой фетиш...", "Сканируем хаб...", "Что же выпадет?", "Подбираем погорячее..."],
        es: ["Buscando tu fetiche...", "Escaneando el hub...", "¿Qué será?", "Buscando algo picante..."],
        de: ["Suche deinen Fetisch...", "Scanne den Hub...", "Was wird es sein?", "Suche etwas Scharfes..."]
    };

    const resultComments = {
        en: ["Like it? Go watch 😈", "Not bad, huh? 😏", "Enjoy your time 🔥", "Go for it! 😀"],
        ru: ["Заинтересовало? Иди и смотри 😈", "Неплохой фетиш, а? 😏", "Приятного просмотра 🔥", "Ну всё, беги смотреть! 😀"],
        es: ["¿Te gusta? Ve a verlo 😈", "Nada mal, ¿eh? 😏", "Disfruta tu tiempo 🔥", "¡Ve por ello! 😀"],
        de: ["Gefällt es dir? Schau es an 😈", "Nicht schlecht, oder? 😏", "Viel Spaß 🔥", "Tu es! 😀"]
    };

    const langData = {
        en: {
            // --- 1. General & Navigation ---
            subtitle: "Your home for adult preferences",
            lang_label: "Language",
            nav_home: "Home",
            nav_settings: "Settings",
            nav_account: "Account",
            header_prefs: "Preferences",
            header_filters: "Filters",  
            mode_label: "Mode", 
            ori_label: "Orientation",
            ori_hetero: "Hetero",
            ori_gay: "Gay",
            ori_trans: "Trans",
            ori_pan: "Pansexual",
            header_extras: "Extras",
            header_community: "Community",
            header_features: "Features",
            header_legal: "Legal",
            theme_label: "Appearance",
            theme_title: "Choose Theme",
            theme_basic: "Basic",
            theme_premium: "Premium Colors",
            btn_start: "Let's Go",
            btn_pass: "Other",
            btn_like: "Similar",
            btn_upgrade_short: "Upgrade ⇧",
            btn_return: "Return",
            watch_later: "Watch Later",
            empty_wl: "No saved items yet",
            sync_label: "Synced: ",
            expl_undo: "Changed your mind? 😏",
            expl_hist: "From Archives 📜",
            deco_label: "Show Decorations",

            rnd_title: "Random Mode",
            rnd_desc: "Different site every time",
            guide_rnd_hint: "Ideally for exploring new libraries.",

            site_title: "Choose Platform",
            sm_title: "Smart Mode",
            sm_desc: "Auto-select site based on tags",
            guide_sm_hint: "e.g. Opens <b>Hentai Haven</b> for anime, <b>MissAV</b> for JAV, <b>Motherless</b> for extreme.",
            sites_all: "All Sites",

            reset_title_select: "Data Management",
            reset_desc_select: "Select specific categories to wipe from memory.",
            reset_opt_algo: "Algorithm (Recommendations)",
            btn_delete_selected: "Delete Selected",

            picker_title: "Select Range",
            picker_from: "From",
            picker_to: "To",
            picker_confirm: "Confirm",

            loyalty_title: "Loyalty Check",
            loyalty_old_label: "Old Hits",
            loyalty_new_label: "New Horizons",
            loyalty_title_cons: "The Conservator",
            loyalty_title_pioneer: "The Pioneer",
            loyalty_title_balanced: "Balanced Soul",
            loyalty_desc_cons: "You know what you like, and you stick to it. Respect.",
            loyalty_desc_pioneer: "Always chasing the next thrill. A true explorer.",
            loyalty_desc_balanced: "A bit of old, a bit of new. You've found the perfect mix.",

            header_notifications: "Notifications",
            badge_indicator_label: "Notifications",
            badge_enabled_msg: "Indicator enabled! You will see a red dot on the app icon when Wrapped is ready or subscription is ending.",
            badge_denied_msg: "Permission denied. Please enable notifications in iOS Settings to use this feature.",

            tip_badge_title: "Never miss a Wrapped",
            tip_badge_desc: "Enable the red dot on the app icon",
            tip_badge_text: `
                <b>What are notifications?</b><br>
                They appear only as a discrete dot or number in the corner of the app icon. No annoying text alerts or push messages will be sent to your device.<br><br>
                <b>When does the indicator appear?</b><br>
                1. <b>Fetish Wrapped:</b> When your personal summary is ready to view.<br>
                2. <b>Subscription:</b> When your Premium status is expiring soon (3 days left).<br><br>
                <b>Numbers:</b><br>
                If both events happen at the same time, you will see the number <b>2</b> on the icon. Otherwise, it will just be a dot or the number 1.
            `,

            sync_minutes: "Minutes",

            spon_header: "Bestie Privilege 💎",
            spon_input_desc: "Write your name in history. It will be visible to everyone forever.<br><b>You can only do this once.</b>",
            spon_placeholder: "Your Nickname",
            spon_btn_save: "Save",

            exp_header: "Subscription Alert",
            exp_title: "Don't lose your access!",
            exp_text: "Glad you've been using the site so long! Just a heads up, your subscription ends in {n}. Time to renew to keep all benefits and support the site 😊",
            exp_btn_renew: "Renew Subscription",

            loyal_title: "Just for You",
            loyal_hey: "Hey, friend! 👋",
            loyal_text: "I see you're not here for the first time. I appreciate your engagement, so I want to offer you a <b>Pro subscription</b> for just <span class='new-price-highlight'>{price}</span>. This goes directly to keeping the site alive 😊",
            loyal_btn: "Claim Offer",

            theme_random: "Random Theme on Start",
            theme_include_light: "Include Light Themes",

            alert_titles: [
                "Welcome back 😈", 
                "Guess what?", 
                "Your stats are in 📊", 
                "Curious about yourself?", 
                "Time for truth 🕯️",
                "Missed you 😏"
            ],
            alert_texts: [
                "You have a ready Fetish Wrapped for <b>{period}</b>.<br>It reveals your obsession with <b style='color:var(--accent)'>{tag}</b>.",
                "Let's see what you've been up to this <b>{period}</b>.<br>Spoiler: You really liked <b style='color:var(--accent)'>{tag}</b>.",
                "Your personal report for <b>{period}</b> is here.<br>Top genre: <b style='color:var(--accent)'>{tag}</b>. Want to see details?",
                "We analyzed your desires for <b>{period}</b>.<br>It seems you can't live without <b style='color:var(--accent)'>{tag}</b>.",
                "Ready to face your stats for <b>{period}</b>?<br>Hint: <b style='color:var(--accent)'>{tag}</b> is dominating."
            ],
            btn_watch_now: "Watch Now",

            ach_how_to: "How to unlock",
            ach_progress: "Progress",
            status_locked: "LOCKED",
            ach_genre_hint: "Find and interact with all items in this category.",
            ach_psycho_hint: "Earn this archetype in your weekly Fetish Wrapped.",

            lbl_badge: "BADGE",
            lbl_icon: "ICON",

            ach_title: "Achievements",
            theme_icons_header: "App Icons (Rewards)",

            mod_add_custom: "Add Custom Tag",
            mod_input_ph: "e.g. Redhead, Latex...",
            mod_add_btn: "Add",

            cat_tips_tech: "Tech & Features",
            cat_tips_info: "Info & 18+ Knowledge",

            tip_sites_title: "Site Guide 2026",
            tip_sites_desc: "Pros, cons, and which to pick",
            tip_sites_text: `
                Let's be real: you probably know the giants like Pornhub without my help 😈. But each site has its own superpower worth knowing.<br><br>

                <b>🔥 The Classics</b><br>
                <b>xHamster</b> is king for "real" and amateur vibes. <b>XVideos</b> and <b>XNXX</b> are the workhorses: they find everything and load instantly. And <b>Pornhub</b>... well, it's Pornhub: comments, trends, 4K, but a moody player.<br><br>

                <b>✨ For Aesthetes</b><br>
                Tired of short clips? <b>SpankBang</b> and <b>Tube8</b> often host full scenes. If you are a visual perfectionist needing 60fps, go to <b>Eporner</b>.<br><br>

                <b>📱 Minimalist</b><br>
                <b>Thumbzilla</b>, <b>PornOne</b>, and <b>IXXX</b> are for those who hate clutter. Click and watch. <b>YouPorn</b> and <b>RedTube</b> are the stable old school.<br><br>

                <b>🎎 Asian & Anime</b><br>
                <b>MissAV</b> is the best for Japanese (JAV) because it has subtitles (plot matters!). <b>SupJav</b> for quantity. 2D fans live on <b>Hentai Haven</b> and <b>Rule34</b>.<br><br>

                <b>💀 The Deep End</b><br>
                Seen it all? <b>Motherless</b> will surprise you with near-zero censorship (extreme, shock). <b>EroMe</b> is for photo lovers. <b>TnaFlix</b> for retro.<br><br>

                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; border-left: 3px solid var(--accent); margin-top:15px;">
                    <b>👨‍💻 Developer's Choice:</b><br>
                    If you are using the App, I highly recommend sticking to <b>xHamster</b> or <b>XVideos</b>. They are stable and fast.<br><br>
                    Why not Pornhub? It often gives a black screen inside the app due to protection scripts. Sites like SpankBang annoy with age gates. Save your nerves — start with xHamster, explore others only if bored.
                </div>
            `,

            // 1. ALGORITHM
            tip_algo_title: "How the Algorithm Works",
            tip_algo_desc: "Training xFetishHub secrets",
            tip_algo_text: `
                xFetishHub is not just a randomizer. It's a neural network of your arousal.<br><br>
                <b>👍 Swipe Right (Like):</b><br>
                You tell the system: "I want more of this." We remember the tags (e.g., <i>Milf, Stockings</i>) and boost their weight. They will appear more often.<br><br>
                <b>👎 Swipe Left (Dislike):</b><br>
                You say: "Take this away." Tag weights drop. If you dislike <i>BDSM</i> often, the system will stop suggesting it.<br><br>
                <b>💡 Tip:</b><br>
                Don't be afraid to dislike what turns you off. The more honest you are, the better the recommendations in <b>"Pleasure"</b> mode become.
            `,

            // 2. GLOSSARY
            tip_dict_title: "Fetish Glossary",
            tip_dict_desc: "POV, PMV, JOI and others",
            tip_dict_text: `
                Confused by acronyms? Here is a breakdown of the most popular ones:<br><br>
                <b>POV (Point Of View):</b> Filmed from the first-person perspective. You see through the actor's eyes.<br>
                <b>PMV (Porn Music Video):</b> Clips edited to music. Aesthetic and rhythmic.<br>
                <b>JOI (Jerk Off Instruction):</b> The model tells you exactly what to do and when.<br>
                <b>BBW (Big Beautiful Woman):</b> Plus-size women. More than just "chubby".<br>
                <b>PAWG (Phat Ass White Girl):</b> Self-explanatory. A cult favorite.<br>
                <b>SPH (Small Penis Humiliation):</b> A popular niche involving teasing sizes.<br>
                <b>CBT (Cock and Ball Torture):</b> Hardcore fetish involving pain to genitals.<br>
                <b>Creampie:</b> Finishing inside. A timeless classic.
            `,

            // 3. PSYCHOTYPES
            tip_psycho_title: "All Psychotypes",
            tip_psycho_desc: "Badges you can earn",
            tip_psycho_text: `
                In your weekly <b>Fetish Wrapped</b>, you get a psychotype based on your history. Here are the rarest ones:<br><br>
                👑 <b>The Dark Lord:</b><br>You love BDSM, Humiliation, and Taboo. You explore the deepest shadows.<br><br>
                🎭 <b>The Performer:</b><br>Frequent Public and Roleplay tags. Life is a stage for you.<br><br>
                🕯️ <b>The Idolater:</b><br>Focus on body parts (Feet, Hands) and Clothing (Latex, Stockings). You worship the form.<br><br>
                🧠 <b>The Manipulator:</b><br>Psychological play, JOI, Hypno. You play with souls, not just bodies.<br><br>
                🍇 <b>The Caligula:</b><br>Group sex + Hardcore. Chaos and pleasure intertwined.<br><br>
                🍦 <b>The Classic:</b><br>Vanilla, Romantic, Standard. Simplicity is the ultimate sophistication.
            `,

            tip_pwa_title: "Turn Site into App",
            tip_pwa_desc: "Fullscreen, Private Browser & Forever History",
            tip_pwa_text: `
                Did you know xFetishHub is designed to be an App?<br><br>
                <b>Why install?</b><br>
                ✅ <b>It looks gorgeous:</b> Fullscreen, no ugly browser bars.<br>
                ✅ <b>Built-in Private Browser:</b> When you click 'Watch', videos open <i>inside</i> the app. Your main browser history (Safari/Chrome) stays clean!<br>
                ✅ <b>Eternal Memory:</b> Browsers often delete data after 7 days. The App keeps your history and preferences forever.<br><br>
                <b>How to install:</b><br>
                🍎 <b>iOS (Safari):</b> Tap 'Share' (square with arrow) → Scroll down → 'Add to Home Screen'.<br>
                🤖 <b>Android (Chrome):</b> Tap Menu (3 dots) → 'Install App' or 'Add to Home Screen'.
            `,

            tip_mods_title: "Power of Modifiers",
            tip_mods_desc: "How to refine your search",
            tip_mods_text: `
                The <b>+</b> button under the card is your ultimate comfort tool.<br><br>
                <b>How it works:</b><br>
                Modifiers are applied on top of the generated genre, so you don't have to type extra details on the 18+ sites themselves. You can type anything there: your favorite actor, a scenario, or any specific detail.<br><br>
                <b>Example:</b><br>
                You got "Anal".<br>
                You add the modifier "Mia Khalifa".<br>
                Result: You see videos with Mia Khalifa and Anal 😏.
            `,

            pt_title: "Did you know?",
            pt_desc: "If you want to learn how to completely disable ads in videos or not get caught at the right moment, read the Knowledge Base here, you won't be disappointed 🌚",
            pt_btn_go: "Open Knowledge Base",

            theme_preview_mode: "Preview",
            btn_unlock_theme: "Unlock Theme 🔒",
            theme_tap_cancel: "Tap anywhere to cancel",

            site_random: "Random",

            btn_version: "Version",
            changelog_title: "Version History",

            limit_title: "Limit Reached",
            limit_desc_fun: "That's enough for today, buddy. Come back tomorrow, or join Pro and watch until you turn blue 😏",

            act_time: "Time",

            unlocked_on: "Unlocked:",
            explored_subtitle: "Here are the achievements you need to get 'Platinum' 😈",
            cat_general: "All Fetishes",
            cat_solo: "Solo & Hands",
            cat_anal: "Anal & Ass",
            cat_breasts: "Breasts & Milk",
            cat_oral: "Oral Pleasure",
            cat_hardcore: "Hardcore & BDSM",
            cat_lgbt: "LGBTQ+",
            cat_group: "Group & Social",
            cat_feet: "Feet & Legs",
            cat_roleplay: "Roleplay & Uniforms",
            cat_public: "Public & Taboo",
            cat_body: "Body & Appearance",
            cat_toys: "Toys & Machines",
            cat_mess: "Fluids & Mess",
            cat_fantasy: "Fantasy & Art",
            cat_clothing: "Clothing & Fetish",

            lbl_includes: "Includes:",

            panic_active_phrases: ["Nothing suspicious here 😇", "Just a hobby", "Pure innocence", "Productivity boost 📈", "Stay hydrated 💧"],

            val_safe: "Safe & Chill",
            val_spicy: "Spicy 🔥",
            val_extreme: "EXTREME 💀",

            share_caption: "Discover yourself",

            mode_greeting_hint: [
                "Explore 🔭, Enjoy 🥰, or a Wish ✨?",
                "Trust the dice 🔭, your history 🥰, or AI ✨?",
                "Something new 🔭, familiar 🥰, or specific ✨?",
                "Roll the dice 🔭, replay hits 🥰, or describe a fantasy ✨?"
            ],
            mode_greeting_dynamic: [
                "In the mood for<br><b>{fav}</b> 🥰<br>or maybe check something new like<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Or type specific ✨, I won't disappoint 😏</span>",
                "Back to<br><b>{fav}</b> 🥰<br>or take a risk with<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>You can also describe a fantasy ✨</span>",
                "Missed<br><b>{fav}</b> 🥰?<br>Or let's explore<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>Or just ask me, I'll find it ✨</span>"
            ],
            mode_explore: "Explore",
            mode_pleasure: "Pleasure",
            mode_ai: "AI Agent",

            info_header: "Information",
            hist_tab_swipes: "Swipes",
            hist_tab_watch: "Time",
            hist_empty_watch: "No watch data yet. Go watch something! 😏",
            hist_watched: "WATCHED",

            status_wl: "In Watch Later",
            status_fav: "Liked",
            status_ban: "Disliked",

            stats_no_data: "No data yet",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Be active {n} more to open your personal summary",
            
            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amethyst",
            "theme_purple-light": "Lavender",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Peach",
            "theme_old-money": "Old Money",
    

            plan_bestie_sub: "Lifetime",
            plan_bestie_price: "/ once",
            badge_limited: "LIMITED OFFER",
            limit_burn: "🔥 ALMOST GONE",
            limit_claimed: "claimed",
            feat_lifetime: "♾️ <b>Lifetime Access</b>",
            feat_onetime: "💸 One-time payment",
            btn_get_bestie: "Get Forever",

            // --- Sponsors ---
            btn_early_sponsors: "Early Sponsors",
            sponsors_title: "Wall of Fame",
            sponsors_desc: "These legends supported xFetishHub at the very beginning by purchasing the Bestie plan. Forever grateful! 💙",

            return_phrases: [
                "A whole {t}. You acted surely 😏",
                "Back after {t}. Did you enjoy it? 🔥",
                "{t}... Quite a session! 😅",
                "You were gone for {t}. Hope it was worth it.",
                "Wow, {t}! Seems like a good choice."
            ],
            return_phrase_short: "Only {t}? That was quick... ⚡",

            reset_phrases: [
                "Sometimes everyone needs a break 🧘",
                "Let's start over...",
                "System reboot 🔄",
                "Peace and quiet...",
                "Clean slate ✨"
            ],

            auth_title: "Sync & Backup",
            auth_p1: "Store history and preferences on all devices",
            auth_p2: "Activate Pro / Beast status",
            auth_p3: "Anonymous storage on Google servers",
            btn_google_signin: "Continue with Google",
            auth_security_note: "The developer doesn't have access to the data. But if you're worried, you can use a second account. 😏",
            btn_cancel: "Cancel",

            pay_header: "USDT (TRC20) Payment",
            pay_instruction: "Send the <b>EXACT amount</b> (including decimals!) via <b>Tron (TRC20)</b>.",
            pay_fee_warn: "⚠️ Network fee is NOT included. Do not send from exchange if fee is deducted from amount!",
            pay_sum_label: "Amount to send:",
            pay_copy_addr: "Tap to Copy Address",
            pay_how_to: "Don't have crypto? How to pay",
            pay_waiting: "Waiting for payment...",
            pay_success_title: "Payment Received!",
            pay_success_desc: "Subscription activated successfully.",
            pay_reload: "Reload Page",
            guide_title: "How to pay with Crypto",
            guide_warning: "Important: Select <b>TRON (TRC20)</b> network when sending.",
            btn_back: "Back",

            pay_problem_link: "Payment not credited?",
            pay_problem_title: "Where is my subscription?",
            pay_prob_desc: "If you sent money but the status hasn't changed within 10 minutes, here are common reasons:",
            pay_prob_reason_1: "<b>Wrong Amount:</b> You sent slightly less or more than required.",
            pay_prob_reason_2: "<b>Network Fee:</b> The exchange deducted the fee from the amount sent.",
            pay_prob_reason_3: "<b>Wrong Network:</b> You used BEP20 instead of TRC20.",
            pay_prob_solution: "Don't worry! Your money is safe. Send us your <b>TxID (Transaction Hash)</b> via support form, and we will activate it manually.",
            btn_contact_support: "Contact Support",
            
            // ПЕРЕВОДЫ ДЛЯ ГАЙДА (Guide View)
            guide_step_1: "<b>1. Telegram Wallet:</b><br>Open <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Buy USDT via P2P (Bank Card). Click 'Send' → 'External Wallet' → paste address.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Download app. Buy USDT (TRC20) with card. Send to our address.",

            info_header: "Information",
            lbl_support_email: "Support Email",
            doc_terms: "Terms of Use",
            doc_privacy: "Privacy Policy",
            doc_refund: "Refund Policy",

            
            btn_roadmap: "Roadmap",
            roadmap_title: "Roadmap",
            roadmap_desc: "With your active support via subscriptions, xFetishHub will evolve. Here is what we are building:",
            rm_global_title: "Global Intelligence",
            rm_global_desc: "Aggregation of anonymous data to create the smartest recommendation engine. Plus, view global 'Most Loved' and 'Most Hated' charts.",
            rm_coop_title: "Co-op Mode",
            rm_coop_desc: "Invite a partner or friend. They will see what genres you roll in real-time. Perfect for distant couples.",
            rm_content_title: "5000+ Categories",
            rm_content_desc: "Massive database expansion. Every specific micro-fetish and niche genre will be indexed.",
            rm_actors_title: "Actor Selector",
            rm_actors_desc: "A dedicated mode to find pornstars based on your visual preferences and body type filters.",
            rm_community_title: "Fetish Community",
            rm_community_desc: "Anonymous social hub. Share Wrapped stories, join psychotype groups, and discover user-curated collections.",
            rm_loc_title: "Global Expansion",
            rm_loc_desc: "We are going worldwide! Incoming translations: Portuguese, Italian, Chinese, Japanese, and Korean.",
            rm_support_btn: "Support Development 🚀",

            ai_prompt: [
                "What do you desire today? 😏",
                "Describe your fantasy...",
                "What are you in the mood for?",
                "Tell me, what turns you on right now?"
            ],
            ai_placeholder: [
                "e.g. big tits, no anal...",
                "I want something passionate...",
                "Surprise me with redhead...",
                "Hardcore, outdoor, maybe spitting..."
            ],
            ai_thinking: "Searching the hub...",
            ai_btn_go: "Find It",
            ai_phrases_success: [
                "As you requested:",
                "Found exactly what you need.",
                "Your wish is my command.",
                "This matches your vibe perfectly.",
                "I think this is it.",
                "Straight from the database to you."
            ],
            ai_phrases_fail: [
                "That's a bit specific, but try this instead:",
                "I couldn't find an exact match, but you'll love this:",
                "My database is stumped, but here is a top pick:",
                "Tricky request... how about this?",
                "I didn't quite catch that, so here is something safe:"
            ],

            panic_btn: "Emergency Mode",
            panic_title: "Emergency Mode",
            panic_desc: "Enable a stealth mode to quickly hide content. Trigger it by <b>Double Tapping</b> anywhere or pressing <b>ESC twice</b>.",
            panic_enable: "Enable Trigger",
            
            // Safe Mode UI
            safe_subtitle: "Your home for favorite hobbies",
            safe_btn_start: "Start Hobby",
            safe_status: "Time to relax 😌",
            
            // Settings Masquerade
            safe_label_site: "Time",
            safe_label_ori: "Location",
            safe_label_int: "Difficulty",
            safe_opt_morn: "Morning", safe_opt_day: "Day", safe_opt_eve: "Evening",
            safe_opt_home: "Home", safe_opt_work: "Work", safe_opt_park: "Park",

            // Post-Panic Phrases
            post_panic_phrases: ["Hope you didn't get caught 😁", "That was close...", "Safe now 😮‍💨", "Back to business 😏"],

            vpn_title: "Just a heads up",
            vpn_text_1: "Must warn you: you are leaving for an 18+ site with adult content and ads. Just in case 😊.",
            vpn_text_pwa: "If the video doesn't play, try restarting it, or open it in a regular browser as a last resort.",
            vpn_text_2: "And don't forget VPN! Enjoy watching 😏",
            vpn_btn: "Let's go",

            tips_btn: "Useful Tips",
            tips_title: "Knowledge Base",
            tips_guru_title: "Become a Watching Guru 😈",
            btn_got_it: "Got it",

            tip_ads_title: "How to remove ads",
            tip_ads_desc: "Tricks for clean viewing in App",
            tip_ads_text: "There are NO ads in xFetishHub itself. However, when you click 'Watch', you go to 18+ sites which have ads.<br><br><b>Lifehack for App (PWA):</b><br>If you use the installed app on iPhone/Android, it uses your system browser engine (Safari/Chrome).<br>1. Install an Ad-Blocker (e.g., AdGuard) in Safari or Chrome.<br>2. Enable it in browser settings.<br>3. It will automatically work inside xFetishHub App!",

            tip_video_title: "Video won't play?",
            tip_video_desc: "Black screen or loading issues",
            tip_video_text: "Due to PWA (Progressive Web App) technology limitations on some devices, external video players might sometimes fail to load or show a black screen.<br><br><b>Solution:</b><br>1. Try refreshing the page.<br>2. If that doesn't help, open xFetishHub in a regular browser instead of the App.",

            tip_pay_title: "How to pay?",
            tip_pay_desc: "Why crypto & how to use it",
            tip_pay_text: "Currently, we only accept Cryptocurrency (USDT). Why? Because traditional payment systems (Stripe, Apple Pay) block adult-oriented projects.<br><br><b>New to Crypto? It's easy:</b><br>1. Open <b>@wallet</b> in Telegram.<br>2. Verify your account.<br>3. Buy USDT via P2P (Bank Card).<br>4. Send USDT to our address using TRC20 network.",

            tip_bug_title: "Report a Problem",
            tip_bug_desc: "Help improve the project",
            tip_bug_text: "This project is built by one person and launched recently, so bugs are inevitable. Your feedback is crucial!<br><br>To help, please go to the <b>Extras</b> section and click <b>'Report Issue'</b>.<br>Fill out the form describing what went wrong. I read every report and fix bugs ASAP!",

            tip_panic_title: "How not to get caught",
            tip_panic_desc: "Stealth mode secrets",
            tip_panic_text: "The app features a <b>Panic Mode</b>. Activate it by <b>Double Tapping</b> anywhere (or using hotkeys on PC).<br><br>It switches to a neutral interface where nothing embarrassing is visible.<br>To exit: click the main 'Start' button or use the same activation gesture.",

            tip_layout_title: "Overlapping phrases",
            tip_layout_desc: "Fixing layout bugs",
            tip_layout_text: "Due to PWA specifics on some mobile devices, the card might move too high, causing phrases to overlap with the logo capsule.<br><br><b>The Fix:</b><br>Simply rotate your phone to <b>landscape</b> mode and back to <b>portrait</b>. The layout will reset and look perfect again.",

            tip_int_title: "Intensity Levels",
            tip_int_desc: "What exactly changes?",
            tip_int_text: `
                <b>🛡️ SAFE (Level 1):</b><br>
                Vanilla, romantic, and standard sex. Completely filters out BDSM, fetish, and any rough content. Safe for work (almost).<br><br>
                <b>🔥 SPICY (Level 2):</b><br>
                Unlocks <b>BDSM & Kink</b>. Adds bondage, spanking, domination, submission, and fetishes. Filters out bodily fluids and pain.<br><br>
                <b>💀 EXTREME (Level 3):</b><br>
                Unlocks <b>Hardcore & Mess</b>. Adds what was hidden: watersports, scat, fisting, pain, and extreme fetishes. No filters.
            `,

            tip_modes_title: "Game Modes",
            tip_modes_desc: "Explore vs Pleasure vs AI",
            tip_modes_text: `
                <b>🔭 Explore (Default):</b><br>
                Balanced randomness. Uses your history slightly but prioritizes discovering new tags. Perfect when you don't know what you want.<br><br>
                <b>🥰 Pleasure:</b><br>
                Strictly follows your preferences. Uses "Liked" tags heavily and avoids experiments. Ideal for a quick guaranteed hit.<br><br>
                <b>🤖 AI Agent:</b><br>
                Activates when you use text or voice search. It understands context ("harder", "something new") and searches for specific scenarios.
            `,

            // --- 2. Generator (Main Tab) ---
            generate: "Random Genre",
            generate_again: "Different Genre",
            btn_similar: "Similar",
            watch: "Watch",
            search: "Search", // For Google mode
            related_header: "You may also like:",
            mod_manage: "Manage Modifiers",
            mod_title: "Modifiers",
            mod_active_sec: "Active (Visible)",
            mod_inactive_sec: "Inactive (Hidden)",
            mod_limit_reached: "Limit reached (Max 6)!",
            add_genre: "Add to genre:",
            search_en_label: "Search EN",
            site_label: "Site",
            exploration_mode: "Safety Level",
            
            // --- 3. Subscription (Premium) ---
            sub_title: "Premium Access",
            sub_intro: "xFetishHub is a one-of-a-kind project that helps you discover and analyze your adult preferences in one cozy, ad-free place. By subscribing, you ensure the project's survival, and in return, I'll give you significantly more features:",
            
            // Plans Features
            feat_limit: "🎲 50 Generations / day",
            feat_stats_basic: "📊 Basic Statistics",
            feat_filters: "✔️ Standard Filters",
            btn_current: "Current Plan",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / week",
            feat_wrapped_unlim: "✨ <b>Unlimited</b> Fetish Wrapped",

            lbl_subscription: "Subscription",
            limit_text_full: "🎲 50 Generations / day (left: {n}/50)",

            feat_unlim: "🔥 Unlimited Generations",
            feat_stats_adv: "📈 Advanced Stats & History",
            feat_custom: "🎨 Deep Customization",
            feat_early: "🚀 Early Access features",
            btn_get_pro: "Get Pro",

            feat_all_pro: "👑 All Pro Features",
            feat_all_beast: "🦁 <b>All Beast Features</b>",
            feat_sponsors: "💎 Listed in Sponsors",
            feat_discord: "💬 Discord with Developer",
            feat_vote: "🗳️ Vote on Roadmap",
            btn_get_beast: "Unleash Beast",

            bill_monthly: "Monthly",
            bill_yearly: "Yearly",

            btn_lower_tier: "You deserve better",

            pay_desc: "Select a payment method. You will receive an activation code instantly.",
            pay_stars: "Telegram Stars",
            pay_card: "Card (World)",
            pay_crypto: "Crypto (Anonymous)",
            pay_boosty: "Boosty (RF Cards)",
            pay_code_label: "If you paid, enter code here:",
            pay_code_placeholder: "Activation code...",

            lbl_current_plan: "Current Plan",
            login_alert: "Please log in to manage subscriptions!",

            // --- 4. Account & Data ---
            login_text: "Sync / Login",
            logout_text: "Logout",
            login_required: "Please log in (Sync Data) first so we can identify you!",
            sync_success: "Data synced successfully!",
            btn_open_stats: "Statistics",

            personal_account: "Personal Account",
            
            "theme_blue-dark": "Midnight",
            "theme_green-dark": "Forest",
            "theme_red-dark": "Vampire",
            "theme_gold-dark": "Luxury",
            "theme_noir": "Noir",
            "theme_blue-light": "Sky",
            "theme_green-light": "Mint",
            "theme_red-light": "Rose",
            "theme_gold-light": "Sand",
            "theme_dark": "Dark",
            "theme_light": "Light",

            history_title: "History",
            
            btn_reset: "Reset Data",
            confirm_reset: "Are you sure? This will delete your history, statistics, and preferences learning. This cannot be undone.",
            reset_done: "Data has been reset.",
            
            explored_label: "Explored",
            explored_txt: "{n} / {t} categories",
            report_issue: "Report Issue",

            sync_title: "Cloud Storage",
            sync_desc: "Data stored safely on Google servers",
            sync_tip: "Click 'Synchronize' to merge. <b>Page will reload to apply changes.</b>",
            sync_btn_success: "✅ Done! Reloading...",
            btn_sync: "🔄 Synchronize Device",
            sub_exp: "exp:",
            sub_expired: "Expired",
            time_d: "d",
            
            // --- 5. Lists (Favorites/Blacklist) ---
            favorites_catalog: "Liked",
            blacklist_catalog: "Disliked",
            btn_fav_add: "Favorite",
            btn_fav_remove: "In Favorites",
            btn_ban_add: "Block",
            btn_ban_remove: "Unblock",
            empty: "List is empty (Check filters)!",
            
            // --- 6. Filters ---
            filter_include: "Include",
            filter_exclude: "Exclude",
            tag_fav: "Favorites",
            tag_straight: "Straight", 
            tag_gay: "Gay", 
            tag_lesbian: "Lesbian", 
            tag_trans: "Trans",

            // --- 7. Statistics ---
            btn_stats: "Statistics",
            stats_header: "Your Favorite Categories",
            stats_prefs: "Preferences",
            stats_activity: "Activity",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Come back in a week. Or if you want stats every day, Pro subscription is your best friend.",
            btn_close: "Close",
            search_liked: "Search liked...",
            search_disliked: "Search disliked...",
            hist_empty: "History is empty",
            limit_reset: "Reset:",
            
            tf_week: "Week", 
            tf_month: "Month", 
            tf_year: "Year", 
            tf_all: "All time",
            
            act_gen: "Generations", 
            act_watch: "Watched",
            chart_prefs_x: "Preferences",
            chart_points_y: "Points",
            chart_count_y: "Count",
            share_btn: "Share",

            legend_watch: "Watch (+10)",
            legend_like: "Like / Similar (+5)",
            legend_dislike: "Other / Dislike (-10)",
            act_actions: "Swipes",
            act_watches: "Watches",

            // --- 8. Explanations (Why did I get this?) ---
            expl_fav: "Because you like ",
            expl_sim: "Related to previous",
            expl_rand: "Fate",
            expl_score: "Because you liked ",
            expl_tag_click: "You chose tag: ",

            // --- 9. Badges & Tooltips ---
            badge_extreme: "Extreme",
            badge_desc_extreme: "⚠️ <b>High Intensity</b><br>This category contains rough, intense, or hardcore elements. Not suitable for vanilla preferences.",
            
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>LGBTQ+ Content</b><br>Includes same-sex relationships (Gay/Lesbian) or Transgender content.",
            
            badge_niche: "Niche",
            badge_desc_niche: "🔍 <b>Specific Fetish</b><br>A distinct interest that focuses on specific body parts, objects, or scenarios rather than general sex.",
            
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM & Kink</b><br>Involves bondage, dominance, submission, or sensation play.",

            // --- 10. Modals (Age Gate, Onboarding) ---
            age_title: "Age Verification",
            age_desc: "This website contains age-restricted materials. Are you 18 years or older?",
            age_yes: "Yes, I am 18+",
            age_no: "No, Exit",
            age_block_msg: "This website is only for users over 18 years of age.",

            // Окно установки
            install_title: "Install App",
            install_desc: "Install app for full-screen mode. Plus, watch videos in the built-in browser to keep your main browser history clean!",
            install_continue: "Continue in Browser",

            btn_install_phone: "Install on Phone",
            qr_title: "Scan to Install",
            qr_desc: "Scan this QR code with your phone camera to open the site, then follow the instructions below:",
            
            inst_ios_1: "Tap the <b>Share</b> button",
            inst_ios_2: "Scroll down and tap",
            inst_ios_btn: "Add to Home Screen",
            inst_ios_3: "Tap <b>Add</b>.",
            
            inst_and_1: "Tap the <b>Menu</b> (3 dots)",
            inst_and_2: "Select",
            inst_and_btn: "Install App / Add to Home",

            onb_title: "Quick Setup",
            onb_desc: "Write what you like or dislike so we can get straight to what you love 😈.",
            onb_placeholder: "e.g. I love blowjob and anal, but hate foot fetish and outdoor...",
            onb_btn_check: "Find Categories",
            onb_found: "We found:",
            onb_btn_confirm: "Add to Favorites",
            onb_skip: "Skip setup",

            lbl_about: "About Project",
            
            terms_text: `
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing and using xFetishHub (the "Service"), you confirm that you are at least 18 years of age (or the age of majority in your jurisdiction) and agree to be bound by these Terms. If you do not agree, you must exit the Service immediately.</p>
                
                <h3>2. Nature of Service</h3>
                <p>xFetishHub is a search aggregator and recommendation engine. <b>We do not host, upload, or control any video content.</b> All links generated by the Service lead to third-party websites (e.g., xHamster, Pornhub). We serve as a conduit for finding content available publicly on the internet.</p>
                
                <h3>3. Third-Party Content</h3>
                <p>We have no control over, and assume no responsibility for, the content, privacy policies, or practices of any third-party websites. You acknowledge and agree that xFetishHub shall not be responsible or liable, directly or indirectly, for any damage or loss caused by your use of any third-party content.</p>
                
                <h3>4. User Accounts & Subscriptions</h3>
                <p>Some features require a paid subscription ("Pro" or "Beast"). Payment processing is handled via direct Cryptocurrency transfer (USDT). We do not store your payment credentials. We reserve the right to terminate accounts that violate these Terms.</p>
                
                <h3>5. Disclaimer of Warranties</h3>
                <p>The Service is provided on an "AS IS" and "AS AVAILABLE" basis. We do not warrant that the results generated will meet your requirements or be free of errors.</p>
            `,

            privacy_text: `
                <h3>1. Introduction</h3>
                <p>Your privacy is our priority. This policy explains how we handle your data. We aim to collect the absolute minimum amount of information required to provide our Service.</p>
                
                <h3>2. Data We Collect</h3>
                <p><b>Authentication Data:</b> When you login via Google, we receive your email address and UID to synchronize your preferences. We do not see your password. <b>Usage Data:</b> We store your generated history, favorite tags, and preferences ("liked" or "disliked" categories) locally on your device and encrypted in our database to provide the Service. <b>Local Storage:</b> We use browser local storage to save your settings (theme, language, platform preference) without cookies.</p>

                <h3>3. How We Use Data</h3>
                <p>Your data is used solely to synchronize your progress across devices, verify your subscription status, and train the personalization algorithm to improve suggestions. <b>We do not sell, trade, or rent your personal identification information to others.</b></p>

                <h3>4. Data Deletion</h3>
                <p>You may request full deletion of your account and data at any time by contacting support or using the "Reset Data" button within the app (for local data).</p>
            `,

            refund_text: `
                <h3>1. Digital Goods Policy</h3>
                <p>Due to the nature of digital content, all sales of subscriptions for xFetishHub are generally <b>final and non-refundable</b> once the subscription has been activated.</p>
                
                <h3>2. Exceptions</h3>
                <p>We may offer a refund or replacement at our sole discretion under specific circumstances: <b>Non-Delivery:</b> You paid but did not receive the service within 24 hours. <b>Double Billing:</b> You were charged twice for the same billing period due to a technical glitch.</p>

                <h3>3. How to Request</h3>
                <p>To request a refund, please contact support via the "Report Issue" button or email. Include your transaction ID (TxID) and the date of purchase. Requests must be made within 14 days of purchase.</p>
            `
        },

        ru: {
            // --- 1. Общее и Навигация ---
            subtitle: "Твой дом для взрослых предпочтений",
            lang_label: "Язык",
            nav_home: "Главная",
            nav_settings: "Настройки",
            nav_account: "Аккаунт",
            header_prefs: "Предпочтения",
            header_filters: "Фильтры",
            mode_label: "Режим",
            ori_label: "Ориентация",
            ori_hetero: "Гетеро",
            ori_gay: "Гей",
            ori_trans: "Транс",
            ori_pan: "Пансексуал",
            header_extras: "Дополнительно",
            header_community: "Сообщество",
            header_features: "Возможности",
            header_legal: "Юридическое",
            theme_label: "Оформление",
            theme_title: "Выбор темы",
            theme_basic: "Базовые",
            theme_premium: "Премиум цвета",
            btn_start: "Поехали",
            btn_pass: "Другое",
            btn_like: "Похожее",
            btn_upgrade_short: "Улучш... ⇧",
            btn_return: "Вернуться",
            watch_later: "Смотреть позже",
            empty_wl: "Список пуст",
            sync_label: "Синхр: ",
            expl_undo: "Передумал? 😏",
            expl_hist: "Из архивов 📜",
            deco_label: "Показывать декор",

            rnd_title: "Случайный режим",
            rnd_desc: "Разные сайты каждый раз",
            guide_rnd_hint: "Идеально для изучения новых библиотек.",

            site_title: "Выбор платформы",
            sm_title: "Умный режим",
            sm_desc: "Авто-выбор сайта по тегам",
            guide_sm_hint: "Например: <b>Hentai Haven</b> для аниме, <b>MissAV</b> для JAV, <b>Motherless</b> для жести.",
            sites_all: "Все сайты",

            reset_title_select: "Управление данными",
            reset_desc_select: "Выберите категории для удаления из памяти.",
            reset_opt_algo: "Алгоритм (Рекомендации)",
            btn_delete_selected: "Удалить выбранное",

            picker_title: "Выбор периода",
            picker_from: "От",
            picker_to: "До",
            picker_confirm: "Подтвердить",

            loyalty_title: "Проверка верности",
            loyalty_old_label: "Старые хиты",
            loyalty_new_label: "Новые горизонты",
            loyalty_title_cons: "Консерватор",
            loyalty_title_pioneer: "Первооткрыватель",
            loyalty_title_balanced: "Баланс сил",
            loyalty_desc_cons: "Ты точно знаешь, чего хочешь. Верность вкусу — это стиль.",
            loyalty_desc_pioneer: "Вечно в погоне за новым. Твое любопытство не знает границ.",
            loyalty_desc_balanced: "Немного старого, немного нового. Идеальное сочетание.",

            header_notifications: "Уведомления",
            badge_indicator_label: "Уведомления",
            badge_enabled_msg: "Индикатор включен! Ты увидишь красную точку на иконке приложения, когда будет готов Wrapped или заканчиваться подписка.",
            badge_denied_msg: "Доступ запрещен. Пожалуйста, включи уведомления в настройках iOS для этого приложения.",

            tip_badge_title: "Как не пропускать сводки?",
            tip_badge_desc: "Включаем красный индикатор на иконке",
            tip_badge_text: `
                <b>Что такое уведомления?</b><br>
                Они выглядят как аккуратная точка или цифра в углу иконки приложения. Мы уважаем твою приватность: никакие текстовые сообщения или пуш-уведомления приходить не будут.<br><br>
                <b>Когда появляется индикатор?</b><br>
                1. <b>Fetish Wrapped:</b> Когда твой личный отчет готов к просмотру.<br>
                2. <b>Подписка:</b> Когда срок Premium-статуса подходит к концу (осталось 3 дня).<br><br>
                <b>Цифры:</b><br>
                Если оба события совпали, на иконке отобразится цифра <b>2</b>. В остальных случаях это будет точка или цифра 1.
            `,

            sync_minutes: "Минут",

            spon_header: "Привилегия Bestie 💎",
            spon_input_desc: "Впиши своё имя в историю. Оно останется здесь навсегда.<br><b>Это можно сделать только один раз.</b>",
            spon_placeholder: "Твой никнейм",
            spon_btn_save: "Сохранить",

            exp_header: "Напоминание",
            exp_title: "Не теряй доступ!",
            exp_text: "Рад, что ты так долго пользуешься моим сайтом! Напоминаю, что через {n} твоя подписка закончится. Самое время её обновить, чтобы сохранить все фишки и поддержать проект 😊",
            exp_btn_renew: "Продлить подписку",

            loyal_title: "Специально для тебя",
            loyal_hey: "Привет! 👋",
            loyal_text: "Я смотрю, ты здесь уже не в первый раз. Ценю твою вовлечённость, поэтому предлагаю оформить <b>Pro подписку</b> всего за <span class='new-price-highlight'>{price}</span>. Это пойдет на поддержание сайта 😊",
            loyal_btn: "Забрать скидку",

            theme_random: "Случайная тема при старте",
            theme_include_light: "Включая светлые",

            alert_titles: [
                "С возвращением 😈", 
                "У меня есть кое-что 🎁", 
                "Твоя статистика 📊", 
                "Любопытно? 😏", 
                "Время правды 🕯️", 
                "Скучал по тебе..."
            ],
            alert_texts: [
                "У тебя готов Fetish Wrapped за <b>{period}</b>.<br>Там рассказывают про твой любимый жанр <b style='color:var(--accent)'>{tag}</b>.",
                "Давай глянем, как прошел твой <b>{period}</b>.<br>Спойлер: Ты подсел на <b style='color:var(--accent)'>{tag}</b>.",
                "Твой личный отчет за <b>{period}</b> собран.<br>Топ жанр: <b style='color:var(--accent)'>{tag}</b>. Взглянешь?",
                "Мы проанализировали твои желания за <b>{period}</b>.<br>Кажется, ты жить не можешь без <b style='color:var(--accent)'>{tag}</b>.",
                "Готов увидеть правду за <b>{period}</b>?<br>Подсказка: <b style='color:var(--accent)'>{tag}</b> доминирует."
            ],
            btn_watch_now: "Посмотреть",

            ach_how_to: "Как получить",
            ach_progress: "Прогресс",
            status_locked: "ЗАКРЫТО",
            ach_genre_hint: "Найди и повзаимодействуй со всеми предметами этой категории.",
            ach_psycho_hint: "Получи этот психотип в еженедельном Fetish Wrapped.",

            lbl_badge: "ЗНАЧОК",
            lbl_icon: "ИКОНКА",

            ach_title: "Достижения",
            theme_icons_header: "Иконки (Награды)",

            mod_add_custom: "Вписать своё",
            mod_input_ph: "напр. Рыжие, Чулки...",
            mod_add_btn: "Добавить",

            cat_tips_tech: "Техническое и Функции",
            cat_tips_info: "Инфо и 18+ Знания",

            tip_sites_title: "Гид по сайтам 2026",
            tip_sites_desc: "Плюсы, минусы и кого выбрать",
            tip_sites_text: `
                Давай честно: про гигантов вроде Pornhub ты и без меня знаешь 😈. Но у каждого сайта есть свои фишки, о которых стоит знать.<br><br>

                <b>🔥 Классика (База)</b><br>
                <b>xHamster</b> — король «живого» и любительского контента. <b>XVideos</b> и <b>XNXX</b> — безотказные рабочие лошадки: находят всё, грузятся везде. А <b>Pornhub</b>... ну, это Pornhub: комментарии, тренды, 4K, но капризный плеер.<br><br>

                <b>✨ Для Эстетов</b><br>
                Устал от обрезков? На <b>SpankBang</b> и <b>Tube8</b> часто лежат полные сцены. Если ты визуал и хочешь 60fps, тебе на <b>Eporner</b>.<br><br>

                <b>📱 Минимализм</b><br>
                <b>Thumbzilla</b>, <b>PornOne</b> и <b>IXXX</b> — для тех, кто не хочет копаться в меню. Зашел, нажал, смотришь. <b>YouPorn</b> и <b>RedTube</b> — старая добрая школа без лишних баннеров.<br><br>

                <b>🎎 Азия и Аниме</b><br>
                <b>MissAV</b> — топ для японского порно (JAV), потому что там есть субтитры (сюжет важен!). <b>SupJav</b> для количества. Фанаты 2D живут на <b>Hentai Haven</b> и <b>Rule34</b>.<br><br>

                <b>💀 Для искушенных</b><br>
                Видел всё? <b>Motherless</b> удивит отсутствием цензуры (экстрим, шок). <b>EroMe</b> — для любителей фото-сетов. <b>TnaFlix</b> — ретро.<br><br>

                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; border-left: 3px solid var(--accent); margin-top:15px;">
                    <b>👨‍💻 Совет Разработчика:</b><br>
                    Если ты сидишь через приложение, я настоятельно рекомендую использовать <b>xHamster</b> или <b>XVideos</b>. Они работают стабильно.<br><br>
                    Почему не Pornhub? У него сложная защита, из-за чего внутри приложения часто бывает черный экран. А сайты вроде SpankBang мучают проверкой возраста. Побереги нервы — начни с xHamster, а остальное пробуй, если станет скучно.
                </div>
            `,

            // 1. АЛГОРИТМ
            tip_algo_title: "Как работает умная лента",
            tip_algo_desc: "Секреты обучения xFetishHub",
            tip_algo_text: `
                xFetishHub — это не просто рандомайзер. Это нейросеть твоего возбуждения.<br><br>
                <b>👍 Свайп вправо (Лайк):</b><br>
                Ты говоришь системе: "Хочу больше такого". Мы запоминаем теги этого видео (например, <i>Milf, Stockings</i>) и повышаем их вес. В следующий раз они выпадут с большей вероятностью.<br><br>
                <b>👎 Свайп влево (Дизлайк):</b><br>
                Ты говоришь: "Убери это". Вес тегов снижается. Если ты часто дизлайкаешь <i>BDSM</i>, система перестанет его предлагать.<br><br>
                <b>💡 Совет:</b><br>
                Не бойся дизлайкать то, что тебе не по душе. Чем честнее ты свайпаешь, тем точнее становятся рекомендации в режиме <b>"Наслаждение"</b>.
            `,

            // 2. СЛОВАРЬ
            tip_dict_title: "Словарь терминов",
            tip_dict_desc: "POV, PMV, JOI и другие",
            tip_dict_text: `
                Часто встречаешь непонятные аббревиатуры? Вот расшифровка самых популярных:<br><br>
                <b>POV (Point Of View):</b> Съемка от первого лица. Ты видишь всё глазами актера.<br>
                <b>PMV (Porn Music Video):</b> Нарезка кадров под музыку. Эстетично и ритмично.<br>
                <b>JOI (Jerk Off Instruction):</b> Инструкции для мастурбации. Модель говорит тебе, что и как делать.<br>
                <b>BBW (Big Beautiful Woman):</b> Пышные дамы. Больше, чем просто "толстушка".<br>
                <b>PAWG (Phat Ass White Girl):</b> Белая девушка с очень большой попой.<br>
                <b>SPH (Small Penis Humiliation):</b> Унижение маленького члена. Популярный фетиш.<br>
                <b>CBT (Cock and Ball Torture):</b> Пытки гениталий. Жесткий фетиш для любителей боли.<br>
                <b>Creampie:</b> Финал внутрь. Классика.
            `,

            // 3. ПСИХОТИПЫ
            tip_psycho_title: "Все Психотипы",
            tip_psycho_desc: "Какие статусы можно получить",
            tip_psycho_text: `
                В конце недели ты получаешь <b>Fetish Wrapped</b>, где тебе присваивается психотип на основе твоих действий. Вот самые редкие из них:<br><br>
                👑 <b>The Dark Lord (Тёмный Лорд):</b><br>Любишь БДСМ, унижение и Табу. Ты исследуешь самые темные уголки.<br><br>
                🎭 <b>The Performer (Артист):</b><br>Часто смотришь Public (на улице) и Ролевые игры. Жизнь для тебя — сцена.<br><br>
                🕯️ <b>The Idolater (Идолопоклонник):</b><br>Фокус на частях тела (ноги, руки) и одежде (чулки, латекс). Ты ценишь детали.<br><br>
                🧠 <b>The Manipulator (Манипулятор):</b><br>Психологическое доминирование, JOI, гипноз. Тебя возбуждают игры разума.<br><br>
                🍇 <b>The Caligula (Калигула):</b><br>Групповой секс + БДСМ. Хаос и наслаждение переплетены.<br><br>
                🍦 <b>The Classic (Классик):</b><br>Ваниль, романтика, традиционный секс. Простота — залог успеха.
            `,

            tip_pwa_title: "Преврати сайт в Приложение",
            tip_pwa_desc: "Полный экран, Встроенный браузер и Вечная память",
            tip_pwa_text: `
                Ты знал, что xFetishHub создан работать как Приложение?<br><br>
                <b>Зачем устанавливать?</b><br>
                ✅ <b>Это красиво:</b> Полный экран, никаких панелей браузера.<br>
                ✅ <b>Встроенный Приватный Браузер:</b> Когда ты жмешь 'Смотреть', видео открываются <i>внутри</i> приложения. История твоего основного Safari или Chrome остается чистой!<br>
                ✅ <b>Вечная память:</b> Браузеры часто удаляют данные через 7 дней. Приложение хранит твою историю и настройки вечно.<br><br>
                <b>Как установить:</b><br>
                🍎 <b>iOS (Safari):</b> Нажми 'Поделиться' (квадрат со стрелкой) → Прокрути вниз → 'На экран Домой'.<br>
                🤖 <b>Android (Chrome):</b> Нажми Меню (3 точки) → 'Установить приложение' или 'На гл. экран'.
            `,

            tip_mods_title: "Сила Модификаторов",
            tip_mods_desc: "Как уточнить поиск",
            tip_mods_text: `
                Кнопка <b>+</b> под карточкой — твой полезнейший инструмент для комфорта.<br><br>
                <b>Как это работает:</b><br>
                Модификаторы накладываются поверх выпавшего жанра, благодаря чему тебе не придётся вписывать дополнительное пояснение на самих 18+ сайтах. Ты можешь вписать туда что угодно, хоть любимого актёра, хоть сценарий, хоть любое уточнение.<br><br>
                <b>Пример:</b><br>
                Тебе выпал "Анал".<br>
                Ты добавляешь модификатор "Mia Khalifa".<br>
                Итог: Тебе показываются видео с Mia Khalifa и Анал 😏.
            `,

            pt_title: "Ты знал?",
            pt_desc: "Если хочешь узнать как полностью отключить рекламу в видео или не спалиться в нужный момент, то прочитай здешнюю Базу знаний, точно не разочаруешься 🌚",
            pt_btn_go: "Открыть Базу Знаний",

            theme_preview_mode: "Предпросмотр",
            btn_unlock_theme: "Разблокировать тему 🔒",
            theme_tap_cancel: "Нажми куда угодно для отмены",

            site_random: "Случайный",

            btn_version: "Версия",
            changelog_title: "История версий",

            limit_title: "Лимит исчерпан",
            limit_desc_fun: "На сегодня хватит, дружище. Возвращайся завтра, либо присоединяйся к Pro, и смотри хоть до посинения 😏",
            
            act_time: "Время",

            unlocked_on: "Получено:",
            explored_subtitle: "Вот тебе ачивки, которые нужно получить для достижения «Платины» 😈",
            cat_general: "Все фетиши",
            cat_solo: "Соло и Руки",
            cat_anal: "Анал и Попа",
            cat_breasts: "Грудь и Молоко",
            cat_oral: "Оральный секс",
            cat_hardcore: "Хардкор и БДСМ",
            cat_lgbt: "ЛГБТ+",
            cat_group: "Групповое",
            cat_feet: "Ноги и Фут-фетиш",
            cat_roleplay: "Ролевые и Костюмы",
            cat_public: "Публичное и Табу",
            cat_body: "Тело и Внешность",
            cat_toys: "Игрушки",
            cat_mess: "Жидкости и Грязь",
            cat_fantasy: "Фантазия и Арт",
            cat_clothing: "Одежда и Латекс",

            lbl_includes: "В жанр входят:", 

            panic_active_phrases: ["Ничего подозрительного 😇", "Просто хобби", "Сама невинность", "Минутка продуктивности 📈", "Пей воду 💧"],

            val_safe: "Безопасно",
            val_spicy: "Горячо 🔥",
            val_extreme: "ЭКСТРИМ 💀",

            share_caption: "Узнай себя",

            mode_greeting_hint: [
                "Поиск 🔭, Любимое 🥰 или Желание ✨?",
                "Доверься случаю 🔭, опыту 🥰 или Магии ✨?",
                "Что-то новое 🔭, знакомое 🥰 или конкретная фантазия ✨?",
                "Рискнем 🔭, повторим 🥰 или загадаешь сам ✨?"
            ],
            mode_greeting_dynamic: [
                "Настроен на<br><b>{fav}</b> 🥰<br>или может посмотрим что-то новое, например<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Либо пиши что конкретно ✨, не разочарую 😏</span>",
                "Вернемся к<br><b>{fav}</b> 🥰<br>или рискнем с<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Можешь просто описать фантазию ✨</span>",
                "Соскучился по<br><b>{fav}</b> 🥰?<br>Или изучим жанр<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>А лучше спроси меня, я найду ✨</span>"
            ],

            mode_explore: "Исследование",
            mode_pleasure: "Наслаждение",
            mode_ai: "ИИ Агент",

            info_header: "Информация",
            hist_tab_swipes: "Свайпы",
            hist_tab_watch: "Время",
            hist_empty_watch: "Данных о просмотрах нет. Иди глянь что-нибудь! 😏",
            hist_watched: "ПРОСМОТРЕНО",

            status_wl: "Смотреть позже",
            status_fav: "В Избранном",
            status_ban: "Не нравится",

            stats_no_data: "Пока нет данных",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Активничай ещё {n}, чтобы открыть личную сводку",

            "theme_pink-dark": "Кибер",
            "theme_pink-light": "Сакура",
            "theme_purple-dark": "Аметист",
            "theme_purple-light": "Лаванда",
            "theme_orange-dark": "Магма",
            "theme_orange-light": "Персик",
            "theme_old-money": "Old Money",

            plan_bestie_sub: "Навсегда",
            plan_bestie_price: "/ разово",
            badge_limited: "ОГРАНИЧЕНО",
            limit_burn: "🔥 СКОРО РАЗБЕРУТ",
            limit_claimed: "забрали",
            feat_lifetime: "♾️ <b>Доступ навсегда</b>",
            feat_onetime: "💸 Разовый платёж",
            btn_get_bestie: "Купить навсегда",

            // --- Sponsors ---
            btn_early_sponsors: "Ранние спонсоры",
            sponsors_title: "Зал Славы",
            sponsors_desc: "Эти легенды поддержали xFetishHub в самом начале, купив тариф Bestie. Бесконечно благодарен! 💙",

            return_phrases: [
                "Целых {t}. Ты действовал наверняка 😏",
                "С возвращением спустя {t}. Понравилось? 🔥",
                "{t}... Неплохой марафон! 😅",
                "Тебя не было {t}. Надеюсь, оно того стоило.",
                "Ого, {t}! Кажется, это был отличный выбор."
            ],
            return_phrase_short: "Всего {t}? Быстро ты... ⚡",

            reset_phrases: [
                "Порой всем нужен отдых 🧘",
                "Давай начнём сначала...",
                "Перезагрузка системы 🔄",
                "Тишина и спокойствие...",
                "Чистый лист ✨"
            ],

            auth_title: "Синхронизация",
            auth_p1: "Хранение истории и предпочтений на всех устройствах",
            auth_p2: "Активация Pro / Beast статуса",
            auth_p3: "Анонимное хранение на серверах Google",
            btn_google_signin: "Войти через Google",
            auth_security_note: "Разработчик не имеет доступа к данным. Но если боишься, то можешь использовать второй аккаунт. 😏",
            btn_cancel: "Отмена",

            pay_header: "Оплата USDT (TRC20)",
            pay_instruction: "Отправь <b>ТОЧНУЮ сумму</b> (вплоть до копеек) через сеть <b>Tron (TRC20)</b>.",
            pay_fee_warn: "⚠️ Комиссия сети НЕ включена. Не отправляй с биржи, если комиссия вычитается из суммы!",
            pay_sum_label: "Сумма:",
            pay_copy_addr: "Нажми, чтобы скопировать",
            pay_how_to: "Нет крипты? Как оплатить?",
            pay_waiting: "Ожидаем оплату...",
            pay_success_title: "Оплата прошла!",
            pay_success_desc: "Подписка активирована.",
            pay_reload: "Обновить страницу",
            guide_title: "Как оплатить криптой",
            guide_warning: "Важно: При отправке выбирай сеть <b>TRON (TRC20)</b>.",
            btn_back: "Назад к оплате",

            pay_problem_link: "Не засчитался платёж?",
            pay_problem_title: "Где моя подписка?",
            pay_prob_desc: "Если ты отправил деньги, но статус не изменился в течение 10 минут, вот частые причины:",
            pay_prob_reason_1: "<b>Неверная сумма:</b> Отправлено чуть меньше или больше требуемого.",
            pay_prob_reason_2: "<b>Комиссия:</b> Биржа вычла комиссию из суммы перевода.",
            pay_prob_reason_3: "<b>Не та сеть:</b> Выбрали BEP20 или ERC20 вместо TRC20.",
            pay_prob_solution: "Не волнуйся! Деньги не пропали. Пришли нам <b>TxID (Хеш транзакции)</b> в поддержку, и мы активируем вручную.",
            btn_contact_support: "Написать в поддержку",

            guide_step_1: "<b>1. Telegram Wallet:</b><br>Открой <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Купи USDT через P2P (с карты). Нажми «Отправить» → «Внешний кошелек» → вставь адрес.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Скачай приложение. Купи USDT (TRC20) с карты. Отправь на наш адрес.",

            info_header: "Информация",
            lbl_support_email: "Почта поддержки",
            doc_terms: "Польз. соглашение",
            doc_privacy: "Политика конф-ти",
            doc_refund: "Политика возвратов",

            btn_roadmap: "Дорожная карта",
            roadmap_title: "Планы развития",
            roadmap_desc: "Благодаря твоей поддержке и подпискам, проект будет развиваться. Вот что мы планируем добавить:",
            rm_global_title: "Глобальный Разум",
            rm_global_desc: "Улучшение рекомендаций на основе анонимной статистики всех пользователей. Топы самых любимых и ненавистных жанров мира.",
            rm_coop_title: "Совместный режим",
            rm_coop_desc: "Пригласи партнера по ссылке. Он будет видеть твои результаты в реальном времени. Идеально для пар на расстоянии.",
            rm_content_title: "5000+ Категорий",
            rm_content_desc: "Масштабное расширение базы. Каждый микро-фетиш и нишевый жанр будет добавлен в поиск.",
            rm_actors_title: "Поиск Актёров",
            rm_actors_desc: "Отдельный режим для подбора порнозвезд и моделей на основе твоих визуальных предпочтений.",
            rm_community_title: "Сообщество",
            rm_community_desc: "Анонимный социальный хаб. Делись своими Wrapped, вступай в группы по психотипам и обсуждай вкусы с единомышленниками.",
            rm_loc_title: "Мировая экспансия",
            rm_loc_desc: "Новые языки уже в планах: португальский, итальянский, китайский, японский и корейский.",
            rm_support_btn: "Поддержать развитие 🚀",

            ai_prompt: [
                "Что хочешь посмотреть сегодня? 😏",
                "Опиши свою фантазию...",
                "Какое настроение?",
                "Расскажи, что тебя заводит прямо сейчас?"
            ],
            ai_placeholder: [
                "напр. большая грудь, без анала...",
                "Хочу что-то страстное...",
                "Удиви меня рыжими...",
                "Жестко, на улице, может быть плевки..."
            ],
            ai_thinking: "Анализирую...",
            ai_btn_go: "Найти",
            ai_phrases_success: [
                "Как ты и просил:",
                "Нашел специально для тебя.",
                "Твой запрос услышан.",
                "Это идеально подходит под описание.",
                "Думаю, это то, что нужно.",
                "Из недр базы — прямо тебе."
            ],
            ai_phrases_fail: [
                "Сложный запрос. Но давай попробуем это:",
                "Точного совпадения нет, но это тебе зайдет:",
                "Я в замешательстве, но вот отличный вариант:",
                "Не совсем понял, поэтому держи проверенное:",
                "В базе такого нет, но как насчет этого?"
            ],

            panic_btn: "Экстренный режим",
            panic_title: "Экстренный режим",
            panic_desc: "Скрытый режим для быстрой маскировки контента. Активируется <b>Двойным тапом</b> по экрану или <b>Двойным ESC</b>.",
            panic_enable: "Включить триггер",
            
            // Safe Mode UI
            safe_subtitle: "Твой дом для любимых хобби",
            safe_btn_start: "Начать",
            safe_status: "Время расслабиться 😌",
            
            // Settings Masquerade
            safe_label_site: "Время",
            safe_label_ori: "Место",
            safe_label_int: "Сложность",
            safe_opt_morn: "Утро", safe_opt_day: "День", safe_opt_eve: "Вечер",
            safe_opt_home: "Дом", safe_opt_work: "Работа", safe_opt_park: "Парк",

            // Post-Panic Phrases
            post_panic_phrases: ["Надеюсь, не спалился 😁", "Пронесло...", "Фух, вроде чисто 😮‍💨", "Возвращаемся к делу 😏"],

            vpn_title: "Предупреждение",
            vpn_text_1: "Должен предупредить: ты переходишь на 18+ сайт, где сам понимаешь какой контент, к тому же есть реклама. Это на всякий случай 😊.",
            vpn_text_pwa: "И если у тебя вдруг не запускается видео, то попробуй перезапустить его, либо на крайний случай открой его в браузере.",
            vpn_text_2: "И про ВПН не забудь! Приятного просмотра 😏",
            vpn_btn: "Пошли",

            tips_btn: "Полезности",
            tips_title: "База знаний",
            tips_guru_title: "Стань гуру просмотра 😈",
            btn_got_it: "Понятно",

            tip_ads_title: "Как убрать рекламу",
            tip_ads_desc: "Секрет чистого просмотра в приложении",
            tip_ads_text: "В самом xFetishHub рекламы НЕТ. Но при переходе на сайты 18+ она появится — это неизбежно.<br><br><b>Лайфхак для Приложения (PWA):</b><br>Если ты смотришь через установленное приложение:<br>1. Скачай Ад-блокер (например, AdGuard) для Safari или Chrome.<br>2. Включи его в настройках браузера.<br>3. Он автоматически заработает внутри приложения xFetishHub!",

            tip_video_title: "Не грузит видео?",
            tip_video_desc: "Черный экран или ошибки",
            tip_video_text: "Из-за особенностей технологии PWA (веб-приложение), на некоторых устройствах плееры сторонних сайтов могут не запускаться с первого раза.<br><br><b>Решение:</b><br>1. Попробуй перезагрузить страницу.<br>2. Если не помогает — открой сайт в обычном браузере, а не в приложении.",

            tip_pay_title: "Как оплатить?",
            tip_pay_desc: "Почему крипта и как ей платить",
            tip_pay_text: "Сейчас доступна только оплата в криптовалюте (USDT). Из-за тематики сайта (18+) трудно договориться с банками и Apple/Google Pay.<br><br><b>Ни разу не платил криптой?</b><br>1. Открой <b>@wallet</b> в Telegram.<br>2. Купи USDT через P2P (с карты).<br>3. Нажми Отправить -> Внешний кошелек -> Вставь наш адрес (сеть TRC20).",

            tip_bug_title: "Сообщить о проблеме",
            tip_bug_desc: "Помоги улучшить проект",
            tip_bug_text: "Сайт создан недавно одним человеком, поэтому ошибки неизбежны. Твоя помощь очень важна!<br><br>Зайди в блок <b>«Дополнительно»</b> -> <b>«Сообщить о проблеме»</b>.<br>Опиши, что именно не так. Я реагирую на отзывы и исправляю баги максимально быстро.",

            tip_panic_title: "Как не спалиться",
            tip_panic_desc: "Секретный режим",
            tip_panic_text: "На сайте есть режим паники. Активируй его <b>двумя тапами</b> по экрану (или клавишами на ПК).<br><br>Он включает нейтральный интерфейс, где не видно ничего, что может поставить в неловкое положение.<br>Выйти можно нажатием на кнопку действия или тем же способом, как вошли.",

            tip_layout_title: "Перекрывающиеся фразы",
            tip_layout_desc: "Исправление верстки",
            tip_layout_text: "Из-за особенностей PWA иногда карточка на мобильных может уходить слишком вверх, и фразы перекрываются капсулой с логотипом.<br><br><b>Решение:</b><br>Смени ориентацию телефона на <b>горизонтальную</b> и верни её в <b>вертикальную</b>. Проблема решится, и всё встанет на места.",

            tip_int_title: "Уровни Откровенности",
            tip_int_desc: "Что именно меняется?",
            tip_int_text: `
                <b>🛡️ БЕЗОПАСНО (Ур. 1):</b><br>
                Ваниль, романтика и классика. Полностью блокирует БДСМ, фетиши и любую грубость. Максимально "чистый" контент.<br><br>
                <b>🔥 ГОРЯЧО (Ур. 2):</b><br>
                Открывает <b>БДСМ и Кинки</b>. Добавляет связывание, порку, доминирование и фетиши. Но всё ещё блокирует "грязь" и боль.<br><br>
                <b>💀 ЭКСТРИМ (Ур. 3):</b><br>
                Открывает <b>Хардкор и Треш</b>. Добавляет то, что было скрыто: туалетную тему, фистинг, боль и жидкости. Без фильтров.
            `,

            tip_modes_title: "Режимы Игры",
            tip_modes_desc: "Исследование vs Наслаждение",
            tip_modes_text: `
                <b>🔭 Исследование (Explore):</b><br>
                Баланс случайности. Учитывает историю, но приоритет отдается поиску новых жанров. Идеально, когда не знаешь, чего хочешь.<br><br>
                <b>🥰 Наслаждение (Pleasure):</b><br>
                Строго следует твоим вкусам. Часто предлагает то, что содержит твои любимые теги. Минимум экспериментов, максимум гарантии.<br><br>
                <b>🤖 ИИ Агент (AI):</b><br>
                Включается при текстовом или голосовом поиске. Понимает контекст («пожестче», «что-то новое») и ищет конкретные сценарии.
            `,

            // --- 2. Генератор ---
            generate: "Случайный жанр",
            generate_again: "Другой жанр",
            btn_similar: "Похожий",
            watch: "Смотреть",
            search: "Найти",
            related_header: "Вам также может понравиться:",
            mod_manage: "Настроить модификаторы",
            mod_title: "Модификаторы",
            mod_active_sec: "Активные (В карточке)",
            mod_inactive_sec: "Неактивные (Скрыты)",
            mod_limit_reached: "Лимит достигнут (Макс 6)!",
            add_genre: "Добавить к жанру:",
            search_en_label: "Поиск на Англ.",
            site_label: "Сайт",
            exploration_mode: "Откровенность",

            // --- 3. Подписка (Premium) ---
            sub_title: "Премиум доступ",
            sub_intro: "xFetishHub — это единственный в своём роде проект, который помогает тебе узнать и проанализировать твои взрослые предпочтения в одном уютном месте без рекламы. Если оплатишь подписку, то проект и дальше сможет существовать, а взамен я тебе дам ощутимо больше возможностей:",
            
            // Планы
            feat_limit: "🎲 50 Генераций / день",
            feat_stats_basic: "📊 Базовая статистика",
            feat_filters: "✔️ Стандартные фильтры",
            btn_current: "Текущий план",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / неделю",
            feat_wrapped_unlim: "✨ <b>Безлимитный</b> Wrapped",

            lbl_subscription: "Подписка",
            limit_text_full: "🎲 50 Генераций / день (осталось: {n}/50)",

            feat_unlim: "🔥 Безлимитные генерации",
            feat_stats_adv: "📈 Расширенные сводки",
            feat_custom: "🎨 Кастомизация",
            feat_early: "🚀 Ранний доступ к функциям",
            btn_get_pro: "Купить Pro",

            feat_all_pro: "👑 Всё, что есть в Pro",
            feat_all_beast: "🦁 <b>Всё, что есть в Beast</b>",
            feat_sponsors: "💎 Имя во вкладке Спонсоры",
            feat_discord: "💬 Discord с разработчиком",
            feat_vote: "🗳️ Влияние на развитие",
            btn_get_beast: "Стать Зверем",

            bill_monthly: "Ежемесячно",
            bill_yearly: "Ежегодно",

            btn_lower_tier: "Ты достоен большего",
            pay_desc: "Выбери способ оплаты. Ты получишь код активации мгновенно после оплаты.",
            pay_stars: "Telegram Stars",
            pay_card: "Карта (Весь мир)",
            pay_crypto: "Крипта (Анонимно)",
            pay_boosty: "Boosty (Карты РФ)",
            pay_code_label: "Если оплатил, введи код сюда:",
            pay_code_placeholder: "Код активации...",

            lbl_current_plan: "Текущий план",
            login_alert: "Пожалуйста, войди в аккаунт для управления подпиской!",

            // --- 4. Аккаунт и Данные ---
            login_text: "Вход / Синхронизация",
            personal_account: "Личный кабинет",

            "theme_blue-dark": "Полночь",
            "theme_green-dark": "Лес",
            "theme_red-dark": "Вампир",
            "theme_gold-dark": "Роскошь",
            "theme_noir": "Нуар",
            "theme_blue-light": "Небо",
            "theme_green-light": "Мята",
            "theme_red-light": "Роза",
            "theme_gold-light": "Песок",
            "theme_dark": "Тёмная",
            "theme_light": "Светлая",

            history_title: "История",


            logout_text: "Выйти",
            login_required: "Пожалуйста, войди в аккаунт, чтобы мы могли активировать подписку!",
            sync_success: "Данные синхронизированы!",

            btn_open_stats: "Статистика",

            btn_reset: "Сброс данных",
            confirm_reset: "Ты уверен? Это удалит историю, статистику и обучение алгоритма. Это действие нельзя отменить.",
            reset_done: "Данные сброшены.",

            explored_label: "Открыто",
            explored_txt: "{n} из {t} категорий",
            report_issue: "Сообщить о проблеме",

            sync_title: "Облачное хранилище",
            sync_desc: "Данные безопасно хранятся на серверах Google",
            sync_tip: "Нажми «Синхронизировать» для объединения. <b>Страница перезагрузится.</b>",
            sync_btn_success: "✅ Готово! Перезагрузка...",
            btn_sync: "🔄 Синхронизировать",
            sub_exp: "ист:",
            sub_expired: "Истекла",
            time_d: "д",

            // --- 5. Списки ---
            favorites_catalog: "Понравившиеся",
            blacklist_catalog: "Не понравившиеся",
            btn_fav_add: "В Избранное",
            btn_fav_remove: "В Избранном",
            btn_ban_add: "В ЧС",
            btn_ban_remove: "Убрать из ЧС",
            empty: "Пусто (Проверь фильтры)!",

            // --- 6. Фильтры ---
            filter_include: "Включить",
            filter_exclude: "Исключить",
            tag_fav: "Избранное",
            tag_straight: "Гетеро", 
            tag_gay: "Гей", 
            tag_lesbian: "Лесби", 
            tag_trans: "Транс",

            // --- 7. Статистика ---
            btn_stats: "Статистика",
            stats_header: "Твои любимые категории",
            stats_prefs: "Предпочтения",
            stats_activity: "Активность",
            
            tf_week: "Неделя", 
            tf_month: "Месяц", 
            tf_year: "Год", 
            tf_all: "Всё время",
            
            act_gen: "Генераций", 
            act_watch: "Просмотров",
            chart_prefs_x: "Предпочтения",
            chart_points_y: "Очки",
            chart_count_y: "Кол-во",
            share_btn: "Поделиться",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Приходи сюда снова через неделю. Либо если хочешь статистику каждый день, то Pro подписка будет твоим лучшим другом.",
            btn_close: "Закрыть",
            search_liked: "Поиск любимых...",
            search_disliked: "Поиск нелюбимых...",
            hist_empty: "История пуста",
            limit_reset: "Сброс:",

            legend_watch: "Просмотр (+10)",
            legend_like: "Лайк / Похожее (+5)",
            legend_dislike: "Другое / Дизлайк (-10)",
            act_actions: "Свайпы",
            act_watches: "Просмотры",

            // --- 8. Объяснения ---
            expl_fav: "Потому что ты любишь: ",
            expl_sim: "Похоже на прошлое",
            expl_rand: "Судьба",
            expl_score: "Потому что тебе зашло: ",
            expl_tag_click: "Выбрана категория: ",

            // --- 9. Бейджи ---
            badge_extreme: "Экстрим",
            badge_desc_extreme: "⚠️ <b>Высокая интенсивность</b><br>Категория содержит жесткие или специфические практики. Не для любителей 'ванильного' контента.",
            
            badge_lgbt: "ЛГБТ",
            badge_desc_lgbt: "🏳️‍🌈 <b>ЛГБТ+ Контент</b><br>Включает однополые отношения (Гей/Лесби) или Транс-тематику.",
            
            badge_niche: "Нишевое",
            badge_desc_niche: "🔍 <b>Специфичный фетиш</b><br>Узконаправленный интерес, фокусирующийся на определенных частях тела, предметах или сценариях.",
            
            badge_bdsm: "БДСМ",
            badge_desc_bdsm: "⛓️ <b>БДСМ и Фетиш</b><br>Связывание, доминирование, подчинение и игры с ощущениями.",

            // --- 10. Модальные окна ---
            age_title: "Проверка возраста",
            age_desc: "Этот сайт содержит материалы для взрослых. Вам уже исполнилось 18 лет?",
            age_yes: "Да, мне 18+",
            age_no: "Нет, выйти",
            age_block_msg: "Этот сайт предназначен только для пользователей старше 18 лет.",

        
            install_title: "Установить приложение",
            install_desc: "Установи приложение для полного экрана. Плюс, смотри видео во встроенном браузере, чтобы не засорять историю основного браузера!",
            install_continue: "Продолжить в браузере",

            btn_install_phone: "Установить на телефон",
            qr_title: "Сканируй для установки",
            qr_desc: "Наведи камеру телефона на QR-код, чтобы открыть сайт, затем следуй инструкции:",
            
            inst_ios_1: "Нажми кнопку <b>Поделиться</b>",
            inst_ios_2: "Пролистай вниз и выбери",
            inst_ios_btn: "На экран «Домой»",
            inst_ios_3: "Нажми <b>Добавить</b>.",
            
            inst_and_1: "Нажми <b>Меню</b> (3 точки)",
            inst_and_2: "Выбери",
            inst_and_btn: "Установить / Добавить на экран",


            onb_title: "Быстрая настройка",
            onb_desc: "Напиши, что тебе нравится или не нравится, чтобы мы сразу могли приступить к тому, что ты любишь 😈.",
            onb_placeholder: "Например: люблю минет и анал, но ненавижу фут-фетиш и улицу...",
            onb_btn_check: "Найти категории",
            onb_found: "Мы нашли:",
            onb_btn_confirm: "Добавить в избранное",
            onb_skip: "Пропустить",

            lbl_about: "О проекте",
            
            terms_text: `
                <h3>1. Принятие условий</h3>
                <p>Используя сервис xFetishHub, ты подтверждаешь, что тебе исполнилось 18 лет (или больше, в зависимости от законов твоей страны), и ты соглашаешься с данными условиями. Если ты не согласен, пожалуйста, покинь сайт.</p>
                
                <h3>2. Суть сервиса</h3>
                <p>xFetishHub является поисковым агрегатором и системой рекомендаций. <b>Мы не храним, не загружаем и не контролируем видеоконтент.</b> Все ссылки ведут на сторонние ресурсы (xHamster, Pornhub и др.). Мы лишь помогаем найти контент, который и так доступен в публичном доступе.</p>
                
                <h3>3. Сторонние ресурсы</h3>
                <p>Мы не несем ответственности за содержание, политику конфиденциальности или действия сторонних сайтов. Переходя по ссылкам, ты действуешь на свой страх и риск. Мы не отвечаем за любой ущерб, связанный с использованием внешних ресурсов.</p>
                
                <h3>4. Аккаунты и Подписки</h3>
                <p>Некоторые функции доступны по подписке ("Pro" или "Beast"). Оплата производится посредством прямого перевода криптовалюты (USDT). Мы не храним твои платежные данные. Мы оставляем за собой право блокировать аккаунты при нарушении правил.</p>
                
                <h3>5. Отказ от ответственности</h3>
                <p>Сервис предоставляется по принципу "КАК ЕСТЬ". Мы не гарантируем, что результаты поиска будут всегда соответствовать твоим ожиданиям или работать без сбоев.</p>
            `,

            privacy_text: `
                <h3>1. Введение</h3>
                <p>Конфиденциальность — наш приоритет. Мы собираем абсолютный минимум данных, необходимый для работы синхронизации.</p>
                
                <h3>2. Сбор данных</h3>
                <p><b>Авторизация:</b> При входе через Google мы получаем твой Email и UID для привязки настроек. Мы не видим твой пароль. <b>Данные использования:</b> Мы храним историю генераций, лайки, дизлайки и веса тегов. Это нужно исключительно для работы алгоритма рекомендаций. <b>Локальное хранилище:</b> Мы используем LocalStorage браузера для сохранения темы и языка.</p>

                <h3>3. Использование данных</h3>
                <p>Твои данные используются только для синхронизации прогресса между устройствами, проверки статуса подписки и обучения алгоритма под твои вкусы. <b>Мы не продаем и не передаем твои данные третьим лицам.</b></p>

                <h3>4. Удаление данных</h3>
                <p>Ты можешь в любой момент сбросить данные в приложении ("Сброс данных") или написать в поддержку для полного удаления аккаунта с серверов.</p>
            `,

            refund_text: `
                <h3>1. Политика цифровых товаров</h3>
                <p>В связи с природой цифрового контента, все продажи подписок являются <b>окончательными и не подлежат возврату</b> после активации услуги.</p>
                
                <h3>2. Исключения</h3>
                <p>Мы можем рассмотреть возврат в индивидуальном порядке в следующих случаях: <b>Недоставка:</b> Ты оплатил, но услуга не была предоставлена в течение 24 часов. <b>Двойное списание:</b> Из-за технического сбоя оплата прошла дважды.</p>

                <h3>3. Запрос возврата</h3>
                <p>Для запроса свяжись с поддержкой через кнопку "Сообщить о проблеме" или по Email. Укажи ID транзакции (TxID). Запросы принимаются в течение 14 дней с момента покупки.</p>
            `
        },

        es: {
            // --- General ---
            subtitle: "Tu hogar para preferencias adultas",
            lang_label: "Idioma",
            nav_home: "Inicio",
            nav_settings: "Ajustes",
            nav_account: "Cuenta",
            header_prefs: "Preferencias",
            header_filters: "Filtros",
            mode_label: "Modo",
            ori_label: "Orientación",
            ori_hetero: "Hetero",
            ori_gay: "Gay",
            ori_trans: "Trans",
            ori_pan: "Pansexual",
            header_extras: "Extras",
            header_community: "Comunidad",
            header_features: "Funciones",
            header_legal: "Legal",
            theme_label: "Apariencia",
            theme_title: "Elegir Tema",
            theme_basic: "Básico",
            theme_premium: "Colores Premium",
            btn_return: "Volver",
            watch_later: "Ver más tarde",
            empty_wl: "Lista vacía",
            sync_label: "Sinc: ",
            expl_undo: "¿Cambiaste de opinión? 😏",
            expl_hist: "De los archivos 📜",
            deco_label: "Mostrar decoración",

            rnd_title: "Modo Aleatorio",
            rnd_desc: "Sitio diferente cada vez",
            guide_rnd_hint: "Ideal para explorar nuevas bibliotecas.",

            site_title: "Elegir Plataforma",
            sm_title: "Modo Inteligente",
            sm_desc: "Selección auto según etiquetas",
            guide_sm_hint: "Ej. abre <b>Hentai Haven</b> para anime, <b>MissAV</b> para JAV, <b>Motherless</b> para extremo.",
            sites_all: "Todos los sitios",

            reset_title_select: "Gestión de Datos",
            reset_desc_select: "Selecciona categorías para borrar.",
            reset_opt_algo: "Algoritmo (Recomendaciones)",
            btn_delete_selected: "Borrar Seleccionados",

            picker_title: "Seleccionar rango",
            picker_from: "Desde",
            picker_to: "Hasta",
            picker_confirm: "Confirmar",

            loyalty_title: "Chequeo de Lealtad",
            loyalty_old_label: "Clásicos",
            loyalty_new_label: "Nuevos Horizontes",
            loyalty_title_cons: "El Conservador",
            loyalty_title_pioneer: "El Pionero",
            loyalty_title_balanced: "Alma Equilibrada",
            loyalty_desc_cons: "Sabes lo que te gusta y te mantienes fiel a ello. Respeto.",
            loyalty_desc_pioneer: "Siempre en busca de la próxima emoción. Un verdadero explorador.",
            loyalty_desc_balanced: "Un poco de lo antiguo, un poco de lo nuevo. Has encontrado la mezcla perfecta.",


            header_notifications: "Notificaciones",
            badge_indicator_label: "Notificaciones",
            badge_enabled_msg: "¡Indicador activado! Verás un punto rojo en el icono de la app cuando un Wrapped esté listo o tu suscripción esté terminando.",
            badge_denied_msg: "Permiso denegado. Por favor, activa las notificaciones en los Ajustes de iOS para usar esta función.",
            
            tip_badge_title: "¿Cómo no perderse los informes?",
            tip_badge_desc: "Activa el indicador rojo en el icono",
            tip_badge_text: `
                <b>¿Qué son las notificaciones?</b><br>
                Aparecen solo como un punto o número discreto en la esquina del icono de la aplicación. No se enviarán alertas de texto ni mensajes push a tu dispositivo.<br><br>
                <b>¿Cuándo aparece el indicador?</b><br>
                1. <b>Fetish Wrapped:</b> Cuando tu resumen personal esté listo для ver.<br>
                2. <b>Suscripción:</b> Cuando tu estado Premium caduque pronto (faltan 3 días).<br><br>
                <b>Números:</b><br>
                Si ambos eventos ocurren al mismo tiempo, verás el número <b>2</b> en el icono. De lo contrario, solo será un punto o el número 1.
            `,

            sync_minutes: "Minutos",

            spon_header: "Privilegio Bestie 💎",
            spon_input_desc: "Escribe tu nombre en la historia. Será visible para siempre.<br><b>Solo puedes hacerlo una vez.</b>",
            spon_placeholder: "Tu Apodo",
            spon_btn_save: "Guardar",

            exp_header: "Recordatorio",
            exp_title: "¡No pierdas acceso!",
            exp_text: "¡Me alegra que uses el sitio! Te recuerdo que tu suscripción termina en {n}. Es hora de renovar para mantener los beneficios y apoyar el sitio 😊",
            exp_btn_renew: "Renovar Suscripción",

            loyal_title: "Solo para ti",
            loyal_hey: "¡Hola! 👋",
            loyal_text: "Veo que no es tu primera vez aquí. Aprecio tu interés, así que te ofrezco <b>Pro</b> por solo <span class='new-price-highlight'>{price}</span>. Esto ayuda a mantener el sitio 😊",
            loyal_btn: "Obtener Oferta",

            theme_random: "Tema aleatorio al inicio",
            theme_include_light: "Incluir temas claros",

            alert_titles: [
                "Bienvenido de nuevo 😈",
                "¿Adivina qué? 🎁",
                "Tus estadísticas 📊",
                "¿Curioso? 😏",
                "Hora de la verdad 🕯️"
            ],
            alert_texts: [
                "Tienes un Fetish Wrapped listo para <b>{period}</b>.<br>Revela tu obsesión con <b style='color:var(--accent)'>{tag}</b>.",
                "Veamos qué has hecho este <b>{period}</b>.<br>Spoiler: Te encantó <b style='color:var(--accent)'>{tag}</b>.",
                "Tu informe personal de <b>{period}</b> está aquí.<br>Género top: <b style='color:var(--accent)'>{tag}</b>. ¿Quieres ver?",
                "Analizamos tus deseos de <b>{period}</b>.<br>Parece que no puedes vivir sin <b style='color:var(--accent)'>{tag}</b>."
            ],
            btn_watch_now: "Ver ahora",

            ach_how_to: "Cómo desbloquear",
            ach_progress: "Progreso",
            status_locked: "BLOQUEADO",
            ach_genre_hint: "Encuentra e interactúa con todos los elementos de esta categoría.",
            ach_psycho_hint: "Obtén este arquetipo en tu Fetish Wrapped semanal.",

            lbl_badge: "INSIGNIA",
            lbl_icon: "ICONO",

            ach_title: "Logros",
            theme_icons_header: "Iconos (Recompensas)",

            mod_add_custom: "Añadir Propio",
            mod_input_ph: "ej. Pelirroja...",
            mod_add_btn: "Añadir",

            cat_tips_tech: "Técnico y Funciones",
            cat_tips_info: "Info y Conocimiento +18",

            tip_sites_title: "Guía de Sitios 2026",
            tip_sites_desc: "Pros, contras y cuál elegir",
            tip_sites_text: `
                Seamos honestos: probablemente ya conoces a gigantes como Pornhub sin mi ayuda 😈. Pero cada sitio tiene su superpoder.<br><br>

                <b>🔥 Los Clásicos</b><br>
                <b>xHamster</b> es el rey de lo amateur y "real". <b>XVideos</b> y <b>XNXX</b> son los caballos de batalla: encuentran todo y cargan rápido. Y <b>Pornhub</b>... bueno, es Pornhub: tendencias, 4K, pero un reproductor caprichoso.<br><br>

                <b>✨ Para Estetas</b><br>
                ¿Cansado de clips cortos? <b>SpankBang</b> y <b>Tube8</b> suelen tener escenas completas. Si buscas 60fps, ve a <b>Eporner</b>.<br><br>

                <b>📱 Minimalistas</b><br>
                <b>Thumbzilla</b>, <b>PornOne</b> e <b>IXXX</b> son para quienes odian el desorden. Clic y ver. <b>YouPorn</b> y <b>RedTube</b> son la vieja escuela estable.<br><br>

                <b>🎎 Asia y Anime</b><br>
                <b>MissAV</b> es lo mejor para JAV (Japonés) porque tiene subtítulos (¡la trama importa!). <b>SupJav</b> para cantidad. Los fans del 2D viven en <b>Hentai Haven</b> y <b>Rule34</b>.<br><br>

                <b>💀 Profundidad</b><br>
                ¿Lo has visto todo? <b>Motherless</b> te sorprenderá con cero censura (extremo, shock). <b>EroMe</b> para amantes de fotos. <b>TnaFlix</b> para retro.<br><br>

                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; border-left: 3px solid var(--accent); margin-top:15px;">
                    <b>👨‍💻 Opinión del Desarrollador:</b><br>
                    Si usas la App, recomiendo encarecidamente <b>xHamster</b> o <b>XVideos</b>. Son estables.<br><br>
                    ¿Por qué no Pornhub? A menudo da pantalla negra en la app por sus scripts. Sitios como SpankBang molestan con la edad. Ahorra nervios: empieza con xHamster, prueba otros si te aburres.
                </div>
            `,

            tip_algo_title: "Cómo funciona el Algoritmo",
            tip_algo_desc: "Secretos de xFetishHub",
            tip_algo_text: `
                <b>👍 Deslizar Derecha (Like):</b> Aumenta el peso de las etiquetas (ej. Milf). Aparecerán más seguido.<br><br>
                <b>👎 Deslizar Izquierda (Dislike):</b> Disminuye el peso. El sistema dejará de sugerirlo.<br><br>
                <b>💡 Consejo:</b> Sé honesto con tus swipes para mejorar el modo <b>"Placer"</b>.
            `,

            tip_dict_title: "Glosario Fetiche",
            tip_dict_desc: "Qué significa POV, BBW, etc.",
            tip_dict_text: `
                <b>POV:</b> Punto de vista (primera persona).<br>
                <b>PMV:</b> Video musical porno.<br>
                <b>JOI:</b> Instrucciones de masturbación.<br>
                <b>BBW:</b> Mujeres grandes y hermosas.<br>
                <b>PAWG:</b> Chica blanca con trasero grande.<br>
                <b>CBT:</b> Tortura genital (Hardcore).
            `,

            tip_psycho_title: "Todos los Psicotipos",
            tip_psycho_desc: "Insignias desbloqueables",
            tip_psycho_text: `
                👑 <b>Señor Oscuro:</b> Amas el BDSM y Tabú.<br>
                🎭 <b>El Artista:</b> Público y Juegos de Rol.<br>
                🕯️ <b>El Idólatra:</b> Partes del cuerpo y Ropa.<br>
                🍇 <b>Calígula:</b> Orgia + Hardcore.<br>
                🍦 <b>El Clásico:</b> Vainilla y Romántico.
            `,

            tip_pwa_title: "Convertir sitio en App",
            tip_pwa_desc: "Pantalla completa, Navegador privado e Historial eterno",
            tip_pwa_text: `
                ¿Sabías que xFetishHub está diseñado para ser una App?<br><br>
                <b>¿Por qué instalar?</b><br>
                ✅ <b>Se ve genial:</b> Pantalla completa, sin barras de navegador.<br>
                ✅ <b>Navegador Privado Integrado:</b> Al hacer clic en 'Ver', los videos se abren <i>dentro</i> de la app. ¡Tu historial de Safari/Chrome permanece limpio!<br>
                ✅ <b>Memoria Eterna:</b> Los navegadores borran datos tras 7 días. La App guarda tu historial y preferencias para siempre.<br><br>
                <b>Cómo instalar:</b><br>
                🍎 <b>iOS (Safari):</b> Toca 'Compartir' (cuadrado con flecha) → Baja y selecciona → 'Añadir a Inicio'.<br>
                🤖 <b>Android (Chrome):</b> Toca Menú (3 puntos) → 'Instalar aplicación' o 'Añadir a pantalla de inicio'.
            `,

            tip_mods_title: "Poder de Modificadores",
            tip_mods_desc: "Cómo refinar tu búsqueda",
            tip_mods_text: `
                El botón <b>+</b> bajo la tarjeta es tu mejor herramienta de confort.<br><br>
                <b>Cómo funciona:</b><br>
                Los modificadores se superponen al género obtenido, así no tienes que escribir detalles extra en los sitios +18. Puedes escribir lo que quieras: tu actor favorito, un escenario o cualquier aclaración.<br><br>
                <b>Ejemplo:</b><br>
                Obtuviste "Anal".<br>
                Añades el modificador "Mia Khalifa".<br>
                Resultado: Se te muestran videos de Mia Khalifa y Anal 😏.
            `,

            pt_title: "¿Sabías qué?",
            pt_desc: "Si quieres saber cómo desactivar completamente los anuncios en videos o no ser descubierto en el momento justo, lee la Base de Conocimientos aquí, no te decepcionará 🌚",
            pt_btn_go: "Abrir Base de Conocimientos",

            theme_preview_mode: "Avance",
            btn_unlock_theme: "Desbloquear Tema 🔒",
            theme_tap_cancel: "Toca donde sea para cancelar",

            site_random: "Aleatorio",

            btn_version: "Versión",
            changelog_title: "Historial de versiones",

            limit_title: "Límite Alcanzado",
            limit_desc_fun: "Suficiente por hoy, amigo. Vuelve mañana o únete a Pro y mira hasta que te pongas azul 😏",


            act_time: "Tiempo",

            unlocked_on: "Desbloqueado:",
            explored_subtitle: "Aquí están los logros que necesitas para obtener el 'Platino' 😈",
            cat_general: "Todos los fetiches",
            cat_solo: "Solo y Manos",
            cat_anal: "Anal y Trasero",
            cat_breasts: "Pechos y Leche",
            cat_oral: "Placer Oral",
            cat_hardcore: "Hardcore y BDSM",
            cat_lgbt: "LGBTQ+",
            cat_group: "Grupo y Social",
            cat_feet: "Pies y Piernas",
            cat_roleplay: "Juego de Rol",
            cat_public: "Público y Tabú",
            cat_body: "Cuerpo y Apariencia",
            cat_toys: "Juguetes",
            cat_mess: "Fluidos y Desorden",
            cat_fantasy: "Fantasía y Arte",
            cat_clothing: "Ropa y Fetiche",

            lbl_includes: "Incluye:",

            panic_active_phrases: ["Nada sospechoso aquí 😇", "Solo un hobby", "Pura inocencia", "Productividad 📈", "Bebe agua 💧"],

            val_safe: "Tranquilo",
            val_spicy: "Picante 🔥",
            val_extreme: "EXTREMO 💀",

            share_caption: "Descúbrete",

            mode_greeting_hint: [
                "¿Explorar 🔭, Disfrutar 🥰 o una Fantasía ✨?",
                "¿Confiar en el azar 🔭, tu historia 🥰 o la Magia ✨?",
                "¿Algo nuevo 🔭, familiar 🥰 o específico ✨?"
            ],
            mode_greeting_dynamic: [
                "¿Con ganas de<br><b>{fav}</b> 🥰<br>o tal vez algo nuevo como<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>O escribe tu deseo ✨, no te decepcionaré 😏</span>",
                "¿Volvemos a<br><b>{fav}</b> 🥰<br>o nos arriesgamos con<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>También puedes describir una fantasía ✨</span>",
                "¿Extrañas<br><b>{fav}</b> 🥰?<br>O exploremos<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>O simplemente pregúntame ✨</span>"
            ],

            mode_explore: "Explorar",
            mode_pleasure: "Placer",
            mode_ai: "Agente IA",

            info_header: "Información",
            hist_tab_swipes: "Deslizamientos",
            hist_tab_watch: "Tiempo",
            hist_empty_watch: "Aún no hay datos de visualización. ¡Ve a ver algo! 😏",
            hist_watched: "VISTO",

            status_wl: "Ver más tarde",
            status_fav: "Me gusta",
            status_ban: "No me gusta",

            stats_no_data: "Aún no hay datos",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Sea activo {n} más para abrir su resumen personal",

            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amatista",
            "theme_purple-light": "Lavanda",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Melocotón",
            "theme_old-money": "Old Money",

            plan_bestie_sub: "De por vida",
            plan_bestie_price: "/ una vez",
            badge_limited: "OFERTA LIMITADA",
            limit_burn: "🔥 CASI AGOTADO",
            limit_claimed: "reclamados",
            feat_lifetime: "♾️ <b>Acceso de por vida</b>",
            feat_onetime: "💸 Pago único",
            btn_get_bestie: "Obtener para siempre",

            // --- Sponsors ---
            btn_early_sponsors: "Patrocinadores",
            sponsors_title: "Muro de la Fama",
            sponsors_desc: "Estas leyendas apoyaron xFetishHub al principio comprando el plan Bestie. ¡Eternamente agradecido! 💙",

            return_phrases: [
                "Todo un {t}. Fuiste a lo seguro 😏",
                "De vuelta tras {t}. ¿Te gustó? 🔥",
                "{t}... ¡Vaya sesión! 😅",
                "Te fuiste por {t}. Espero que valiera la pena.",
                "¡Wow, {t}! Parece una buena elección."
            ],
            return_phrase_short: "¿Solo {t}? Qué rápido... ⚡",

            reset_phrases: [
                "A veces todos necesitamos un descanso 🧘",
                "Empecemos de nuevo...",
                "Reinicio del sistema 🔄",
                "Paz y tranquilidad...",
                "Borrón y cuenta nueva ✨"
            ],

            auth_title: "Sincronización",
            auth_p1: "Historial y preferencias en todos los dispositivos",
            auth_p2: "Activar estado Pro / Beast",
            auth_p3: "Almacenamiento anónimo en servidores de Google",
            btn_google_signin: "Continuar con Google",
            auth_security_note: "El desarrollador no tiene acceso a los datos. Pero si te preocupa, puedes usar una segunda cuenta. 😏",
            btn_cancel: "Cancelar",

            pay_header: "Pago USDT (TRC20)",
            pay_instruction: "Envía la <b>cantidad exacta</b> (incluyendo decimales) vía red <b>Tron (TRC20)</b>.",
            pay_fee_warn: "⚠️ La comisión de la red NO está incluida. ¡No envíes desde un exchange si la comisión se deduce del monto!",
            pay_sum_label: "Monto a enviar:",
            pay_copy_addr: "Toca para copiar dirección",
            pay_how_to: "¿No tienes cripto? ¿Cómo pagar?",
            pay_waiting: "Esperando pago...",
            pay_success_title: "¡Pago Recibido!",
            pay_success_desc: "Suscripción activada.",
            pay_reload: "Recargar Página",
            guide_title: "Cómo pagar con Cripto",
            guide_warning: "Importante: Selecciona la red <b>TRON (TRC20)</b> al enviar.",
            btn_back: "Volver",

            pay_problem_link: "¿Pago no acreditado?",
            pay_problem_title: "¿Dónde está mi suscripción?",
            pay_prob_desc: "Si enviaste dinero pero el estado no cambió en 10 minutos:",
            pay_prob_reason_1: "<b>Monto incorrecto:</b> Enviaste un poco menos o más.",
            pay_prob_reason_2: "<b>Comisión:</b> El exchange descontó la comisión del total.",
            pay_prob_reason_3: "<b>Red incorrecta:</b> Usaste BEP20 en lugar de TRC20.",
            pay_prob_solution: "¡Tranquilo! Envíanos tu <b>TxID (Hash)</b> y lo activaremos manualmente.",
            btn_contact_support: "Contactar Soporte",

            guide_step_1: "<b>1. Telegram Wallet:</b><br>Abre <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Compra USDT vía P2P. Toca 'Enviar' → 'Wallet Externa' → pega la dirección.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Descarga la app. Compra USDT (TRC20). Envía a nuestra dirección.",

            info_header: "Información",
            lbl_support_email: "Correo de soporte",
            doc_terms: "Términos de Uso",
            doc_privacy: "Privacidad",
            doc_refund: "Reembolsos",
            btn_close: "Cerrar",

            btn_roadmap: "Hoja de Ruta",
            roadmap_title: "Planes Futuros",
            roadmap_desc: "Con tu apoyo activo, xFetishHub evolucionará. Esto es lo que estamos construyendo:",
            rm_global_title: "Inteligencia Global",
            rm_global_desc: "Estadísticas anónimas de todos los usuarios para mejorar recomendaciones. Ver los fetiches más amados y odiados.",
            rm_coop_title: "Modo Cooperativo",
            rm_coop_desc: "Invita a tu pareja. Verán lo que generas en tiempo real. Perfecto para parejas a distancia.",
            rm_content_title: "5000+ Categorías",
            rm_content_desc: "Expansión masiva de la base de datos. Cada micro-fetiche será indexado.",
            rm_actors_title: "Selector de Actores",
            rm_actors_desc: "Un modo dedicado para encontrar estrellas porno basado en tus preferencias visuales.",
            rm_community_title: "Comunidad fetichista",
            rm_community_desc: "Centro social anónimo. Comparte historias envueltas, únete a grupos de psicotipos y descubre colecciones seleccionadas por los usuarios.",
            rm_loc_title: "Expansión Global",
            rm_loc_desc: "¡Vamos por todo el mundo! Traducciones entrantes: portugués, italiano, chino, japonés y coreano.",
            rm_support_btn: "Apoyar Desarrollo 🚀",

            ai_prompt: [
                "¿Qué deseas ver hoy? 😏",
                "Describe tu fantasía...",
                "¿De qué tienes ganas?",
                "Dime, ¿qué te excita ahora mismo?"
            ],
            ai_placeholder: [
                "ej. pechos grandes, sin anal...",
                "Quiero algo apasionado...",
                "Sorpréndeme con pelirrojas...",
                "Duro, al aire libre..."
            ],
            ai_thinking: "Pensando...",
            ai_btn_go: "Buscar",
            ai_phrases_success: [
                "Como pediste:",
                "Encontré exactamente lo que necesitas.",
                "Tus deseos son órdenes.",
                "Esto encaja perfectamente.",
                "Creo que esto es.",
                "Directo de la base de datos para ti."
            ],
            ai_phrases_fail: [
                "Eso es muy específico, pero prueba esto:",
                "No encontré una coincidencia exacta, pero te gustará esto:",
                "Mi base de datos está perpleja, pero aquí tienes una opción top:",
                "Solicitud difícil... ¿qué tal esto?",
                "No entendí bien, así que aquí hay algo seguro:"
            ],

            search_liked: "Buscar favoritos...",
            search_disliked: "Buscar bloqueados...",
            hist_empty: "Historial vacío",
            limit_reset: "Reinicio:",

            panic_btn: "Modo Emergencia",
            panic_title: "Modo Emergencia",
            panic_desc: "Modo sigiloso para ocultar contenido. Actívalo con <b>Doble Toque</b> o <b>Doble ESC</b>.",
            panic_enable: "Activar atajo",
            
            // Safe Mode UI
            safe_subtitle: "Tu hogar para pasatiempos favoritos",
            safe_btn_start: "Comenzar",
            safe_status: "Hora de relajarse 😌",
            
            // Settings Masquerade
            safe_label_site: "Hora",
            safe_label_ori: "Ubicación",
            safe_label_int: "Dificultad",
            safe_opt_morn: "Mañana", safe_opt_day: "Día", safe_opt_eve: "Noche",
            safe_opt_home: "Casa", safe_opt_work: "Trabajo", safe_opt_park: "Parque",

            // Post-Panic Phrases
            post_panic_phrases: ["Espero que no te hayan pillado 😁", "Estuvo cerca...", "A salvo 😮‍💨", "De vuelta al negocio 😏"],

            vpn_title: "Aviso",
            vpn_text_1: "Debo advertirte: vas a un sitio +18 con contenido adulto y anuncios. Por si acaso 😊.",
            vpn_text_pwa: "Si el video no se reproduce, intenta reiniciarlo o ábrelo en el navegador.",
            vpn_text_2: "¡Y no olvides la VPN! Disfruta 😏",
            vpn_btn: "Vamos",

            tips_btn: "Consejos Útiles",
            tips_title: "Base de Conocimiento",
            tips_guru_title: "Sé un Gurú del Video 😈",
            btn_got_it: "Entendido",

            tip_ads_title: "Cómo quitar anuncios",
            tip_ads_desc: "Trucos para la App",
            tip_ads_text: "NO hay anuncios en xFetishHub. Pero los sitios externos sí tienen.<br><br><b>Truco para la App (PWA):</b><br>Instala un bloqueador de anuncios (ej. AdGuard) en Safari/Chrome. ¡Funcionará automáticamente dentro de nuestra App!",

            tip_video_title: "¿No carga el video?",
            tip_video_desc: "Pantalla negra o errores",
            tip_video_text: "Debido a la tecnología PWA, a veces los videos no cargan en la App.<br><br><b>Solución:</b><br>1. Recarga la página.<br>2. Si falla, abre el sitio en el navegador normal.",

            tip_pay_title: "¿Cómo pagar?",
            tip_pay_desc: "Cripto y cómo usarlo",
            tip_pay_text: "Solo aceptamos Cripto (USDT) debido a las restricciones de contenido adulto.<br><br><b>¿Nuevo en Cripto?</b><br>1. Abre <b>@wallet</b> en Telegram.<br>2. Compra USDT vía P2P.<br>3. Envía a nuestra dirección (red TRC20).",

            tip_bug_title: "Reportar Problema",
            tip_bug_desc: "Ayuda a mejorar",
            tip_bug_text: "Un solo desarrollador creó esto. Los errores pasan.<br><br>Usa el botón <b>'Reportar Problema'</b> en Extras. ¡Leo y arreglo todo!",

            tip_panic_title: "Cómo no ser descubierto",
            tip_panic_desc: "Modo sigilo",
            tip_panic_text: "La app tiene un <b>Modo Pánico</b>. Actívalo con <b>Doble Toque</b> (o teclas en PC).<br><br>Cambia a una interfaz neutral sin contenido comprometedor.<br>Para salir: pulsa el botón principal o usa el mismo gesto.",

            tip_layout_title: "Frases superpuestas",
            tip_layout_desc: "Arreglar diseño",
            tip_layout_text: "Debido a la PWA, a veces la tarjeta sube demasiado y el logo tapa el texto.<br><br><b>Solución:</b><br>Gira el teléfono a <b>horizontal</b> y vuelve a <b>vertical</b>. El diseño se arreglará automáticamente.",

            tip_int_title: "Niveles de Intensidad",
            tip_int_desc: "¿Qué cambia exactamente?",
            tip_int_text: `
                <b>🛡️ TRANQUILO (Nivel 1):</b><br>
                Vainilla y romance. Bloquea completamente BDSM y fetiches. Contenido "limpio".<br><br>
                <b>🔥 PICANTE (Nivel 2):</b><br>
                Desbloquea <b>BDSM y Kink</b>. Añade bondage, nalgadas, dominación y fetiches. Aún bloquea fluidos y dolor.<br><br>
                <b>💀 EXTREMO (Nivel 3):</b><br>
                Desbloquea <b>Hardcore</b>. Añade lo prohibido: lluvia dorada, scat, fisting, dolor y fetiches extremos. Sin filtros.
            `,

            tip_modes_title: "Modos de Juego",
            tip_modes_desc: "Explorar vs Placer vs IA",
            tip_modes_text: `
                <b>🔭 Explorar:</b><br>
                Aleatoriedad equilibrada. Prioriza descubrir nuevos géneros. Perfecto cuando no sabes qué quieres.<br><br>
                <b>🥰 Placer:</b><br>
                Sigue estrictamente tus gustos. Usa tus etiquetas favoritas. Ideal para un éxito garantizado.<br><br>
                <b>🤖 Agente IA:</b><br>
                Se activa con búsqueda de texto o voz. Entiende el contexto ("más duro", "algo nuevo").
            `,

            // --- Generator ---
            generate: "Género Aleatorio",
            generate_again: "Otro Género",
            btn_similar: "Similar",
            watch: "Ver",
            search: "Buscar",
            related_header: "También te puede interesar:",
            mod_manage: "Gestionar Mods",
            mod_title: "Modificadores",
            mod_active_sec: "Activos",
            mod_inactive_sec: "Inactivos",
            mod_limit_reached: "¡Límite alcanzado!",
            add_genre: "Añadir al género:",
            search_en_label: "Buscar en EN",
            site_label: "Sitio",
            exploration_mode: "Intensidad",


            btn_start: "¡Vamos!",
            btn_pass: "Otro",
            btn_like: "Similar",
            btn_upgrade_short: "Mejorar ⇧",

            // --- Subscription ---
            sub_title: "Acceso Premium",
            sub_intro: "xFetishHub es un proyecto único en su tipo que te ayuda a descubrir y analizar tus preferencias adultas en un lugar acogedor y sin publicidad. Al suscribirte aseguras la supervivencia del proyecto, y a cambio te daré muchas más funciones:",
            
            feat_limit: "🎲 50 Generaciones / día",
            feat_stats_basic: "📊 Estadísticas Básicas",
            feat_filters: "✔️ Filtros Estándar",
            btn_current: "Plan Actual",

            feat_wrapped_limited: "🎁 1 Fetish Wrapped / semana",
            feat_wrapped_unlim: "✨ Fetish Wrapped <b>Ilimitado</b>",

            lbl_subscription: "Suscripción",
            limit_text_full: "🎲 50 Generaciones / día (quedan: {n}/50)",

            feat_unlim: "🔥 Generaciones Ilimitadas",
            feat_stats_adv: "📈 Estadísticas Avanzadas",
            feat_custom: "🎨 Personalización",
            feat_early: "🚀 Acceso Anticipado",
            btn_get_pro: "Obtener Pro",

            feat_all_pro: "👑 Todo lo de Pro",
            feat_all_beast: "🦁 <b>Todo lo de Beast</b>",
            feat_sponsors: "💎 En Patrocinadores",
            feat_discord: "💬 Discord con el desarrollador",
            feat_vote: "🗳️ Votar Futuro",
            btn_get_beast: "Modo Bestia",

            bill_monthly: "Mensual",
            bill_yearly: "Anual",

            btn_lower_tier: "Mereces algo mejor",

            pay_desc: "Selecciona un método de pago. Recibirás un código de activación al instante.",
            pay_stars: "Estrellas Telegram",
            pay_card: "Tarjeta (Mundial)",
            pay_crypto: "Cripto (Anónimo)",
            pay_boosty: "Boosty (Tarjetas)",
            pay_code_label: "Si ya pagaste, ingresa el código:",
            pay_code_placeholder: "Código de activación...",

            lbl_current_plan: "Plan Actual",
            login_alert: "¡Inicia sesión para gestionar suscripciones!",

            // --- Account ---
            login_text: "Entrar / Sincronizar",
            personal_account: "Cuenta Personal",
            btn_open_stats: "Estadísticas",

            // ТЕМЫ
            "theme_blue-dark": "Medianoche",
            "theme_green-dark": "Bosque",
            "theme_red-dark": "Vampiro",
            "theme_gold-dark": "Lujo",
            "theme_noir": "Noir",
            "theme_blue-light": "Cielo",
            "theme_green-light": "Menta",
            "theme_red-light": "Rosa",
            "theme_gold-light": "Arena",
            "theme_dark": "Oscuro",
            "theme_light": "Claro",

            history_title: "Historial",

            logout_text: "Cerrar sesión",
            login_required: "¡Por favor inicia sesión para activar tu suscripción!",
            sync_success: "¡Datos sincronizados!",
            
            btn_reset: "Restablecer datos",
            confirm_reset: "¿Estás seguro? Esto borrará tu historial y estadísticas. No se puede deshacer.",
            reset_done: "Datos restablecidos.",
            
            explored_label: "Explorado",
            explored_txt: "{n} / {t} categorías",
            report_issue: "Reportar Problema",

            sync_title: "Nube",
            sync_desc: "Datos guardados seguros en Google",
            sync_tip: "Haz clic en 'Sincronizar'. <b>La página se recargará.</b>",
            sync_btn_success: "✅ ¡Hecho! Recargando...",
            btn_sync: "🔄 Sincronizar",
            sub_exp: "exp:",
            sub_expired: "Vencido",
            time_d: "d",

            // --- Lists ---
            favorites_catalog: "Me Gusta",
            blacklist_catalog: "No Me Gusta",
            btn_fav_add: "A Favoritos",
            btn_fav_remove: "En Favoritos",
            btn_ban_add: "Bloquear",
            btn_ban_remove: "Desbloquear",
            empty: "¡Lista vacía (Filtros)!",

            // --- Filters ---
            filter_include: "Incluir",
            filter_exclude: "Excluir",
            tag_fav: "Favoritos",
            tag_straight: "Hetero", tag_gay: "Gay", tag_lesbian: "Lesbiana", tag_trans: "Trans",

            // --- Stats ---
            btn_stats: "Estadísticas",
            stats_header: "Tus Categorías",
            stats_prefs: "Preferencias",
            stats_activity: "Actividad",
            tf_week: "Semana", tf_month: "Mes", tf_year: "Año", tf_all: "Todo el tiempo",
            act_gen: "Generaciones", act_watch: "Vistas",
            chart_prefs_x: "Preferencias",
            chart_points_y: "Puntos",
            chart_count_y: "Cantidad",
            share_btn: "Compartir",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Vuelve en una semana. O si quieres estadísticas diarias, la suscripción Pro es tu mejor amiga.",

            legend_watch: "Ver (+10)",
            legend_like: "Me gusta (+5)",
            legend_dislike: "Otro / No me gusta (-10)",
            act_actions: "Desliza",
            act_watches: "Vistas", 

            // --- Explain ---
            expl_fav: "Porque te gusta ",
            expl_sim: "Relacionado",
            expl_rand: "Destino",
            expl_score: "Porque te gustó ",
            expl_tag_click: "Elegiste etiqueta: ",

            // --- Badges ---
            badge_extreme: "Extremo",
            badge_desc_extreme: "⚠️ <b>Alta Intensidad</b><br>Contenido rudo o intenso.",
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>Contenido LGBTQ+</b><br>Relaciones del mismo sexo o Trans.",
            badge_niche: "Nicho",
            badge_desc_niche: "🔍 <b>Fetiche Específico</b><br>Interés particular no convencional.",
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM</b><br>Bondage, dominación y sumisión.",

            // --- Modals ---
            age_title: "Verificación de edad",
            age_desc: "Este sitio web contiene material para adultos. ¿Tienes 18 años o más?",
            age_yes: "Sí, tengo 18+",
            age_no: "No, Salir",
            age_block_msg: "Este sitio web es solo para usuarios mayores de 18 años.",
        
            install_title: "Instalar App",
            install_desc: "Instala la app para pantalla completa. ¡Además, mira videos en el navegador integrado para mantener limpio tu historial principal!",
            install_continue: "Continuar en navegador",

            btn_install_phone: "Instalar en móvil",
            qr_title: "Escanear para instalar",
            qr_desc: "Escanea este código QR con tu cámara para abrir el sitio, luego sigue las instrucciones:",
            
            inst_ios_1: "Toca el botón <b>Compartir</b>",
            inst_ios_2: "Baja y selecciona",
            inst_ios_btn: "Añadir a Inicio",
            inst_ios_3: "Toca <b>Añadir</b>.",
            
            inst_and_1: "Toca el <b>Menú</b> (3 puntos)",
            inst_and_2: "Selecciona",
            inst_and_btn: "Instalar Aplicación",

            onb_title: "Configuración rápida",
            onb_desc: "Escribe lo que te gusta o no te gusta para que podamos ir directo a lo que amas 😈.",
            onb_placeholder: "ej. amo mamada y anal, pero odio fetiche de pies y exterior...",
            onb_btn_check: "Buscar Categorías",
            onb_found: "Encontramos:",
            onb_btn_confirm: "Añadir a Favoritos",
            onb_skip: "Saltar configuración",

            lbl_about: "Sobre el proyecto",
            
            terms_text: `
                <h3>1. Aceptación de los Términos</h3>
                <p>Al acceder y utilizar xFetishHub, confirma que tiene al menos 18 años de edad (o la mayoría de edad en su jurisdicción) y acepta estar sujeto a estos términos. Si no está de acuerdo, debe abandonar el servicio inmediatamente.</p>
                
                <h3>2. Naturaleza del Servicio</h3>
                <p>xFetishHub es un agregador de búsqueda y motor de recomendaciones. <b>No alojamos, subimos ni controlamos ningún contenido de video.</b> Todos los enlaces generados conducen a sitios web de terceros. Servimos como un conducto para encontrar contenido disponible públicamente en Internet.</p>
                
                <h3>3. Contenido de Terceros</h3>
                <p>No tenemos control ni asumimos responsabilidad por el contenido, las políticas de privacidad o las prácticas de sitios web de terceros. Usted reconoce y acepta que xFetishHub no será responsable por ningún daño o pérdida causada por su uso de cualquier contenido de terceros.</p>
                
                <h3>4. Cuentas y Suscripciones</h3>
                <p>Algunas funciones requieren una suscripción paga ("Pro" o "Beast"). El pago se realiza mediante transferencia directa de Criptomonedas (USDT). No almacenamos sus credenciales de pago. Nos reservamos el derecho de cancelar cuentas que violen estos términos.</p>
                
                <h3>5. Renuncia de Garantías</h3>
                <p>El servicio se proporciona "TAL CUAL". No garantizamos que los resultados generados cumplan con sus requisitos o estén libres de errores.</p>
            `,

            privacy_text: `
                <h3>1. Introducción</h3>
                <p>Su privacidad es nuestra prioridad. Esta política explica cómo manejamos sus datos. Nuestro objetivo es recopilar la cantidad mínima absoluta de información requerida.</p>
                
                <h3>2. Datos que Recopilamos</h3>
                <p><b>Autenticación:</b> Al iniciar sesión a través de Google, recibimos su correo electrónico y UID. No vemos su contraseña. <b>Uso:</b> Almacenamos su historial generado, etiquetas favoritas y preferencias localmente y encriptados en nuestra base de datos. <b>Almacenamiento Local:</b> Utilizamos el almacenamiento local del navegador para guardar sus configuraciones.</p>

                <h3>3. Cómo Usamos los Datos</h3>
                <p>Sus datos se utilizan únicamente para sincronizar su progreso, verificar el estado de su suscripción y entrenar el algoritmo de personalización. <b>No vendemos, intercambiamos ni alquilamos su información personal a terceros.</b></p>

                <h3>4. Eliminación de Datos</h3>
                <p>Puede solicitar la eliminación completa de su cuenta y datos en cualquier momento contactando al soporte o utilizando el botón "Restablecer datos".</p>
            `,

            refund_text: `
                <h3>1. Política de Bienes Digitales</h3>
                <p>Debido a la naturaleza del contenido digital, todas las ventas de suscripciones para xFetishHub son generalmente <b>finales y no reembolsables</b> una vez activada la suscripción.</p>
                
                <h3>2. Excepciones</h3>
                <p>Podemos ofrecer un reembolso a nuestra discreción en caso de: <b>No Entrega:</b> Pagó pero no recibió el servicio dentro de las 24 horas. <b>Doble Facturación:</b> Se le cobró dos veces por el mismo período debido a un fallo técnico.</p>

                <h3>3. Cómo Solicitar</h3>
                <p>Para solicitar un reembolso, contacte al soporte a través del botón "Reportar Problema". Incluya su ID de transacción (TxID). Las solicitudes deben realizarse dentro de los 14 días posteriores a la compra.</p>
            `
        },

        de: {
            // --- General ---
            subtitle: "Dein Zuhause für Erwachsenen-Vorlieben",
            lang_label: "Sprache",
            nav_home: "Start",
            nav_settings: "Einstell.",
            nav_account: "Konto",
            header_prefs: "Präferenzen",
            header_filters: "Filter",
            mode_label: "Modus",
            ori_label: "Orientierung",
            ori_hetero: "Hetero",
            ori_gay: "Schwul",
            ori_trans: "Trans",
            ori_pan: "Pansexuell",
            header_extras: "Extras",
            header_community: "Gemeinschaft",
            header_features: "Funktionen",
            header_legal: "Rechtliches",
            theme_label: "Aussehen",
            theme_title: "Thema wählen",
            theme_basic: "Basis",
            theme_premium: "Premium Farben",
            btn_return: "Zurück",
             watch_later: "Später ansehen",
            empty_wl: "Liste leer",
            sync_label: "Sync: ",
            expl_undo: "Meinung geändert? 😏",
            expl_hist: "Aus dem Archiv 📜",
            deco_label: "Dekoration anzeigen",

            rnd_title: "Zufallsmodus",
            rnd_desc: "Jedes Mal eine andere Seite",
            guide_rnd_hint: "Ideal zum Entdecken neuer Bibliotheken.",

            site_title: "Plattform wählen",
            sm_title: "Smart-Modus",
            sm_desc: "Auto-Auswahl basierend auf Tags",
            guide_sm_hint: "Z.B. öffnet <b>Hentai Haven</b> für Anime, <b>MissAV</b> für JAV, <b>Motherless</b> für Extremes.",
            sites_all: "Alle Seiten",

            reset_title_select: "Datenverwaltung",
            reset_desc_select: "Wählen Sie Kategorien zum Löschen.",
            reset_opt_algo: "Algorithmus (Empfehlungen)",
            btn_delete_selected: "Ausgewählte löschen",

            picker_title: "Zeitraum wählen",
            picker_from: "Von",
            picker_to: "Bis",
            picker_confirm: "Bestätigen",

            loyalty_title: "Loyalitäts-Check",
            loyalty_old_label: "Klassiker",
            loyalty_new_label: "Neue Horizonte",
            loyalty_title_cons: "Der Bewahrer",
            loyalty_title_pioneer: "Der Pionier",
            loyalty_title_balanced: "Ausgewogene Seele",
            loyalty_desc_cons: "Du weißt, was dir gefällt, und bleibst dabei. Respekt.",
            loyalty_desc_pioneer: "Immer auf der Jagd nach dem nächsten Kick. Ein echter Entdecker.",
            loyalty_desc_balanced: "Ein bisschen alt, ein bisschen neu. Du hast die perfekte Mischung gefunden.",


            header_notifications: "Benachrichtigungen",
            badge_indicator_label: "Benachrichtigungen",
            badge_enabled_msg: "Indikator aktiviert! Du siehst einen roten Punkt auf dem App-Icon, wenn ein Wrapped bereit ist oder dein Abo ausläuft.",
            badge_denied_msg: "Berechtigung verweigert. Bitte aktiviere die Benachrichtigungen in den iOS-Einstellungen, um diese Funktion zu nutzen.",
            
            tip_badge_title: "Keine Berichte verpassen?",
            tip_badge_desc: "Roten Punkt am Icon aktivieren",
            tip_badge_text: `
                <b>Was sind Benachrichtigungen?</b><br>
                Sie erscheinen nur als diskreter Punkt oder Zahl in der Ecke des App-Icons. Es werden keine störenden Textnachrichten oder Push-Meldungen an dein Gerät gesendet.<br><br>
                <b>Wann erscheint die Anzeige?</b><br>
                1. <b>Fetish Wrapped:</b> Wenn deine persönliche Zusammenfassung bereit ist.<br>
                2. <b>Abonnement:</b> Wenn dein Premium-Status bald abläuft (noch 3 Tage).<br><br>
                <b>Zahlen:</b><br>
                Wenn beide Ereignisse gleichzeitig eintreten, siehst du die Zahl <b>2</b> auf dem Icon. Andernfalls ist es nur ein Punkt oder die Zahl 1.
            `,

            sync_minutes: "Minuten",

            spon_header: "Bestie Privileg 💎",
            spon_input_desc: "Schreibe deinen Namen in die Geschichte. Für immer sichtbar.<br><b>Du kannst dies nur einmal tun.</b>",
            spon_placeholder: "Dein Spitzname",
            spon_btn_save: "Speichern",

            exp_header: "Erinnerung",
            exp_title: "Verliere nicht den Zugang!",
            exp_text: "Schön, dass du dabei bist! Deine Mitgliedschaft endet in {n}. Zeit zum Verlängern, um alle Vorteile zu behalten und die Seite zu unterstützen 😊",
            exp_btn_renew: "Abo verlängern",

            loyal_title: "Nur für dich",
            loyal_hey: "Hey! 👋",
            loyal_text: "Ich sehe, du bist öfter hier. Ich schätze das sehr und biete dir daher <b>Pro</b> für nur <span class='new-price-highlight'>{price}</span> an. Das hilft, die Seite am Leben zu halten 😊",
            loyal_btn: "Angebot sichern",

            theme_random: "Zufälliges Design beim Start",
            theme_include_light: "Helle Designs einschließen",

            alert_titles: [
                "Willkommen zurück 😈",
                "Rate mal? 🎁",
                "Deine Statistik 📊",
                "Neugierig? 😏",
                "Zeit für die Wahrheit 🕯️"
            ],
            alert_texts: [
                "Du hast einen fertigen Fetish Wrapped für <b>{period}</b>.<br>Er enthüllt deine Besessenheit von <b style='color:var(--accent)'>{tag}</b>.",
                "Mal sehen, was du <b>{period}</b> getrieben hast.<br>Spoiler: Du mochtest <b style='color:var(--accent)'>{tag}</b> sehr.",
                "Dein persönlicher Bericht für <b>{period}</b> ist da.<br>Top-Genre: <b style='color:var(--accent)'>{tag}</b>. Ansehen?",
                "Wir haben deine Wünsche für <b>{period}</b> analysiert.<br>Es scheint, du kannst nicht ohne <b style='color:var(--accent)'>{tag}</b> leben."
            ],
            btn_watch_now: "Jetzt ansehen",

            ach_how_to: "Wie freischalten",
            ach_progress: "Fortschritt",
            status_locked: "GESPERRT",
            ach_genre_hint: "Finde und interagiere mit allen Elementen dieser Kategorie.",
            ach_psycho_hint: "Erhalte diesen Archetyp in deinem wöchentlichen Fetish Wrapped.",

            lbl_badge: "ABZEICHEN",
            lbl_icon: "ICON",

            ach_title: "Erfolge",
            theme_icons_header: "App-Icons (Belohnungen)",

            mod_add_custom: "Eigenes hinzufügen",
            mod_input_ph: "z.B. Rothaarige...",
            mod_add_btn: "Hinzufügen",

            cat_tips_tech: "Technik & Funktionen",
            cat_tips_info: "Info & 18+ Wissen",

            tip_sites_title: "Seiten-Guide 2026",
            tip_sites_desc: "Vor- & Nachteile im Vergleich",
            tip_sites_text: `
                Seien wir ehrlich: Giganten wie Pornhub kennst du wahrscheinlich auch ohne mich 😈. Aber jede Seite hat ihre eigene Superkraft.<br><br>

                <b>🔥 Die Klassiker</b><br>
                <b>xHamster</b> ist der König des Amateur-Contents. <b>XVideos</b> und <b>XNXX</b> sind die Arbeitstiere: finden alles, laden sofort. Und <b>Pornhub</b>... nun, ist Pornhub: Trends, 4K, aber ein launischer Player.<br><br>

                <b>✨ Für Ästheten</b><br>
                Genervt von kurzen Clips? <b>SpankBang</b> und <b>Tube8</b> haben oft volle Szenen. Wenn du 60fps willst, geh zu <b>Eporner</b>.<br><br>

                <b>📱 Minimalistisch</b><br>
                <b>Thumbzilla</b>, <b>PornOne</b> und <b>IXXX</b> sind für alle, die Chaos hassen. Klick und schau. <b>YouPorn</b> und <b>RedTube</b> sind die stabile alte Schule.<br><br>

                <b>🎎 Asien & Anime</b><br>
                <b>MissAV</b> ist top für JAV (Japanisch) wegen Untertiteln (Handlung zählt!). <b>SupJav</b> für Menge. 2D-Fans leben auf <b>Hentai Haven</b> und <b>Rule34</b>.<br><br>

                <b>💀 Das tiefe Ende</b><br>
                Alles gesehen? <b>Motherless</b> überrascht mit null Zensur (Extrem, Schock). <b>EroMe</b> für Foto-Liebhaber. <b>TnaFlix</b> für Retro.<br><br>

                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; border-left: 3px solid var(--accent); margin-top:15px;">
                    <b>👨‍💻 Tipp des Entwicklers:</b><br>
                    Wenn du die App nutzt, empfehle ich <b>xHamster</b> oder <b>XVideos</b>. Sie laufen stabil.<br><br>
                    Warum nicht Pornhub? Es zeigt in der App oft einen schwarzen Bildschirm. Seiten wie SpankBang nerven mit Altersprüfung. Spar dir die Nerven: Starte mit xHamster, probiere andere nur bei Langeweile.
                </div>
            `,

            tip_algo_title: "Wie der Algorithmus funktioniert",
            tip_algo_desc: "Training von xFetishHub",
            tip_algo_text: `
                <b>👍 Rechts (Like):</b> Erhöht die Gewichtung von Tags. Sie erscheinen öfter.<br><br>
                <b>👎 Links (Dislike):</b> Verringert die Gewichtung. Das System schlägt es seltener vor.<br><br>
                <b>💡 Tipp:</b> Sei ehrlich, um den <b>"Genuss"</b>-Modus zu verbessern.
            `,

            tip_dict_title: "Fetisch-Glossar",
            tip_dict_desc: "POV, BBW und mehr erklärt",
            tip_dict_text: `
                <b>POV:</b> Perspektive der ersten Person.<br>
                <b>PMV:</b> Porno-Musikvideo.<br>
                <b>JOI:</b> Wichsanleitung.<br>
                <b>BBW:</b> Große schöne Frauen.<br>
                <b>PAWG:</b> Weiße Frau mit großem Hintern.<br>
                <b>CBT:</b> Genitalfolter (Hardcore).
            `,

            tip_psycho_title: "Alle Psychotypen",
            tip_psycho_desc: "Freischaltbare Abzeichen",
            tip_psycho_text: `
                👑 <b>Dunkler Lord:</b> Du liebst BDSM und Tabus.<br>
                🎭 <b>Der Performer:</b> Öffentlich und Rollenspiel.<br>
                🕯️ <b>Der Götzendiener:</b> Körperteile und Kleidung.<br>
                🍇 <b>Caligula:</b> Gruppe + Hardcore.<br>
                🍦 <b>Der Klassiker:</b> Vanille und Romantik.
            `,

            tip_pwa_title: "Website in App verwandeln",
            tip_pwa_desc: "Vollbild, Privater Browser & Ewiger Verlauf",
            tip_pwa_text: `
                Wusstest du, dass xFetishHub als App konzipiert ist?<br><br>
                <b>Warum installieren?</b><br>
                ✅ <b>Es sieht toll aus:</b> Vollbild, keine Browserleisten.<br>
                ✅ <b>Integrierter Privater Browser:</b> Wenn du auf 'Ansehen' klickst, öffnen sich Videos <i>in</i> der App. Dein Safari/Chrome-Verlauf bleibt sauber!<br>
                ✅ <b>Ewiger Speicher:</b> Browser löschen Daten oft nach 7 Tagen. Die App behält deinen Verlauf für immer.<br><br>
                <b>Wie installieren:</b><br>
                🍎 <b>iOS (Safari):</b> Tippe auf 'Teilen' (Quadrat mit Pfeil) → Runterscrollen → 'Zum Home-Bildschirm'.<br>
                🤖 <b>Android (Chrome):</b> Tippe auf Menü (3 Punkte) → 'App installieren' oder 'Zum Startbildschirm'.
            `,

            tip_mods_title: "Macht der Modifikatoren",
            tip_mods_desc: "Suche verfeinern",
            tip_mods_text: `
                Der <b>+</b> Button unter der Karte ist dein bestes Komfort-Tool.<br><br>
                <b>Wie es funktioniert:</b><br>
                Modifikatoren werden über das generierte Genre gelegt, sodass du auf den 18+ Seiten keine zusätzlichen Details eingeben musst. Du kannst dort alles eintragen: deinen Lieblingsdarsteller, ein Szenario oder jede beliebige Präzisierung.<br><br>
                <b>Beispiel:</b><br>
                Du hast "Anal" erhalten.<br>
                Du fügst den Modifikator "Mia Khalifa" hinzu.<br>
                Ergebnis: Dir werden Videos mit Mia Khalifa und Anal angezeigt 😏.
            `,

            pt_title: "Wusstest du?",
            pt_desc: "Wenn du wissen willst, wie man Werbung in Videos komplett deaktiviert oder im richtigen Moment nicht erwischt wird, lies die Wissensdatenbank hier, du wirst nicht enttäuscht sein 🌚",
            pt_btn_go: "Wissensdatenbank öffnen",

            theme_preview_mode: "Vorschau",
            btn_unlock_theme: "Thema freischalten 🔒",
            theme_tap_cancel: "Tippe irgendwo zum Abbrechen",

            site_random: "Zufällig",

            btn_version: "Version",
            changelog_title: "Versionsverlauf",

            limit_title: "Limit erreicht",
            limit_desc_fun: "Das reicht für heute, Kumpel. Komm morgen wieder oder hol dir Pro und schau bis du blau wirst 😏",

            act_time: "Zeit",

            unlocked_on: "Freigeschaltet:",
            explored_subtitle: "Hier sind die Erfolge, die du für 'Platin' brauchst 😈",
            cat_general: "Alle Fetische",
            cat_solo: "Solo & Hände",
            cat_anal: "Anal & Po",
            cat_breasts: "Brüste & Milch",
            cat_oral: "Orale Lust",
            cat_hardcore: "Hardcore & BDSM",
            cat_lgbt: "LGBTQ+",
            cat_group: "Gruppe & Sozial",
            cat_feet: "Füße & Beine",
            cat_roleplay: "Rollenspiel",
            cat_public: "Öffentlich & Tabu",
            cat_body: "Körper & Aussehen",
            cat_toys: "Spielzeug",
            cat_mess: "Flüssigkeiten",
            cat_fantasy: "Fantasie & Kunst",
            cat_clothing: "Kleidung & Fetisch",

            lbl_includes: "Beinhaltet:",

            panic_active_phrases: ["Nichts Verdächtiges 😇", "Nur ein Hobby", "Reine Unschuld", "Produktivität 📈", "Wasser trinken 💧"],

            val_safe: "Sicher",
            val_spicy: "Würzig 🔥",
            val_extreme: "EXTREM 💀",

            share_caption: "Entdecke dich selbst",

            mode_greeting_hint: [
                "Erkunden 🔭, Genießen 🥰 oder ein Wunsch ✨?",
                "Zufall 🔭, Geschichte 🥰 oder Magie ✨?",
                "Etwas Neues 🔭, Bekanntes 🥰 oder Spezifisches ✨?"
            ],
            mode_greeting_dynamic: [
                "Lust auf<br><b>{fav}</b> 🥰<br>oder vielleicht etwas Neues wie<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Oder schreib deinen Wunsch ✨</span>",
                "Zurück zu<br><b>{fav}</b> 🥰<br>oder ein Risiko eingehen mit<br><b>{new}</b> 🔭?<br><span class='ai-hint-text'>Du kannst auch eine Fantasie beschreiben ✨</span>",
                "Vermisst du<br><b>{fav}</b> 🥰?<br>Oder erkunden wir<br><b>{new}</b> 🔭<br><span class='ai-hint-text'>Oder frag mich einfach ✨</span>"
            ],
            mode_explore: "Erkunden",
            mode_pleasure: "Genießen",
            mode_ai: "KI-Agent",

            info_header: "Informationen",
            hist_tab_swipes: "Swipes",
            hist_tab_watch: "Zeit",
            hist_empty_watch: "Noch keine Daten. Schau dir was an! 😏",
            hist_watched: "GESEHEN",

            status_wl: "Später ansehen",
            status_fav: "Gefällt mir",
            status_ban: "Gefällt nicht",

            stats_no_data: "Noch keine Daten",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Seien Sie aktiv {n} mehr, um Ihre persönliche Zusammenfassung zu öffnen",

            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amethyst",
            "theme_purple-light": "Lavendel",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Pfirsich",
            "theme_old-money": "Old Money",

            plan_bestie_sub: "Lebenslang",
            plan_bestie_price: "/ einmalig",
            badge_limited: "LIMITIERTES ANGEBOT",
            limit_burn: "🔥 FAST WEG",
            limit_claimed: "beansprucht",
            feat_lifetime: "♾️ <b>Lebenslanger Zugriff</b>",
            feat_onetime: "💸 Einmalzahlung",
            btn_get_bestie: "Für immer holen",

            // --- Sponsors ---
            btn_early_sponsors: "Frühe Sponsoren",
            sponsors_title: "Ruhmeshalle",
            sponsors_desc: "Diese Legenden haben xFetishHub von Anfang an mit dem Bestie-Plan unterstützt. Ewig dankbar! 💙",

            return_phrases: [
                "Ganze {t}. Du warst dir sicher 😏",
                "Zurück nach {t}. Hat es dir gefallen? 🔥",
                "{t}... Was für eine Sitzung! 😅",
                "Du warst {t} weg. Hoffentlich war es das wert.",
                "Wow, {t}! Scheint eine gute Wahl zu sein."
            ],
            return_phrase_short: "Nur {t}? Das ging schnell... ⚡",

            reset_phrases: [
                "Manchmal braucht jeder eine Pause 🧘",
                "Lass uns neu anfangen...",
                "Systemneustart 🔄",
                "Ruhe und Frieden...",
                "Ein neuer Anfang ✨"
            ],

            auth_title: "Synchronisierung",
            auth_p1: "Verlauf und Vorlieben auf allen Geräten speichern",
            auth_p2: "Pro / Beast Status aktivieren",
            auth_p3: "Anonyme Speicherung auf Google-Servern",
            btn_google_signin: "Weiter mit Google",
            auth_security_note: "Der Entwickler hat keinen Zugriff auf die Daten. Falls Sie dennoch Bedenken haben, können Sie ein zweites Konto verwenden. 😏",
            btn_cancel: "Abbrechen",

            pay_header: "Zahlung USDT (TRC20)",
            pay_instruction: "Sende den <b>exakten Betrag</b> (einschließlich Dezimalstellen) über das <b>Tron (TRC20)</b> Netzwerk.",
            pay_fee_warn: "⚠️ Netzwerkgebühr ist NICHT enthalten. Sende nicht von einer Börse, wenn die Gebühr vom Betrag abgezogen wird!",
            pay_sum_label: "Betrag:",
            pay_copy_addr: "Tippen zum Kopieren",
            pay_how_to: "Keine Krypto? Wie zahlen?",
            pay_waiting: "Warte auf Zahlung...",
            pay_success_title: "Zahlung erhalten!",
            pay_success_desc: "Abonnement aktiviert.",
            pay_reload: "Seite neu laden",
            guide_title: "Wie man mit Krypto zahlt",
            guide_warning: "Wichtig: Wähle das <b>TRON (TRC20)</b> Netzwerk.",
            btn_back: "Zurück",

            pay_problem_link: "Zahlung nicht erhalten?",
            pay_problem_title: "Wo ist mein Abo?",
            pay_prob_desc: "Wenn sich der Status nach 10 Minuten nicht ändert:",
            pay_prob_reason_1: "<b>Falscher Betrag:</b> Du hast etwas zu wenig/viel gesendet.",
            pay_prob_reason_2: "<b>Gebühr:</b> Die Börse hat die Gebühr abgezogen.",
            pay_prob_reason_3: "<b>Falsches Netz:</b> BEP20 statt TRC20 verwendet.",
            pay_prob_solution: "Keine Sorge! Sende uns deinen <b>TxID (Hash)</b> und wir aktivieren es manuell.",
            btn_contact_support: "Support kontaktieren",

            guide_step_1: "<b>1. Telegram Wallet:</b><br>Öffne <a href='https://t.me/wallet' target='_blank' style='color:var(--accent)'>@wallet</a>. Kaufe USDT per P2P. Klicke 'Senden' → 'Externe Wallet'.",
            guide_step_2: "<b>2. Trust Wallet / TronLink:</b><br>Lade die App. Kaufe USDT (TRC20). Sende an unsere Adresse.",

            info_header: "Informationen",
            lbl_support_email: "Support-E-Mail",
            doc_terms: "Nutzungsbedingungen",
            doc_privacy: "Datenschutz",
            doc_refund: "Rückerstattung",

            btn_roadmap: "Roadmap",
            roadmap_title: "Zukunftspläne",
            roadmap_desc: "Mit deiner Unterstützung wird sich xFetishHub weiterentwickeln. Das bauen wir:",
            rm_global_title: "Globale Intelligenz",
            rm_global_desc: "Verbesserte Empfehlungen basierend auf anonymen Daten aller Nutzer. Siehe globale 'Top' und 'Flop' Listen.",
            rm_coop_title: "Koop-Modus",
            rm_coop_desc: "Lade einen Partner ein. Er sieht in Echtzeit, was du generierst. Perfekt für Fernbeziehungen.",
            rm_content_title: "5000+ Kategorien",
            rm_content_desc: "Massive Erweiterung der Datenbank. Jeder Mikro-Fetisch wird indexiert.",
            rm_actors_title: "Darsteller-Suche",
            rm_actors_desc: "Ein Modus zum Finden von Pornostars basierend auf deinen visuellen Vorlieben.",
            rm_community_title: "Fetisch-Community",
            rm_community_desc: "Anonymer sozialer Hub. Teilen Sie verpackte Geschichten, treten Sie Psychotyp-Gruppen bei und entdecken Sie von Benutzern kuratierte Sammlungen.",
            rm_loc_title: "Globale Expansion",
            rm_loc_desc: "Wir gehen weltweit! Eingehende Übersetzungen: Portugiesisch, Italienisch, Chinesisch, Japanisch und Koreanisch.",
            rm_support_btn: "Entwicklung unterstützen 🚀",

            ai_prompt: [
                "Was möchtest du heute sehen? 😏",
                "Beschreibe deine Fantasie...",
                "Wonach ist dir heute?",
                "Sag mir, was dich gerade anmacht?"
            ],
            ai_placeholder: [
                "z.B. große Brüste, kein Anal...",
                "Ich will etwas Leidenschaftliches...",
                "Überrasch mich...",
                "Hart, draußen..."
            ],
            ai_thinking: "Nachdenken...",
            ai_btn_go: "Finden",
            ai_phrases_success: [
                "Wie gewünscht:",
                "Genau das gefunden, was du brauchst.",
                "Dein Wunsch ist mir Befehl.",
                "Das passt perfekt.",
                "Ich glaube, das ist es.",
                "Direkt aus der Datenbank für dich."
            ],
            ai_phrases_fail: [
                "Das ist etwas spezifisch, aber versuch das:",
                "Keine exakte Übereinstimmung, aber das wirst du mögen:",
                "Datenbank ist ratlos, aber hier ist ein Top-Tipp:",
                "Schwierige Anfrage... wie wäre es damit?",
                "Nicht ganz verstanden, hier ist etwas Sicheres:"
            ],

            btn_start: "Los geht's",
            btn_pass: "Andere",
            btn_like: "Ähnlich",
            btn_upgrade_short: "Upgrade ⇧",

            panic_btn: "Notfallmodus",
            panic_title: "Notfallmodus",
            panic_desc: "Stealth-Modus zum Verstecken. Aktivierung durch <b>Doppeltippen</b> oder <b>Doppel-ESC</b>.",
            panic_enable: "Auslöser aktivieren",
            
            // Safe Mode UI
            safe_subtitle: "Dein Zuhause für Lieblingshobbys",
            safe_btn_start: "Starten",
            safe_status: "Zeit zum Entspannen 😌",
            
            // Settings Masquerade
            safe_label_site: "Zeit",
            safe_label_ori: "Ort",
            safe_label_int: "Schwierigkeit",
            safe_opt_morn: "Morgen", safe_opt_day: "Tag", safe_opt_eve: "Abend",
            safe_opt_home: "Zuhause", safe_opt_work: "Arbeit", safe_opt_park: "Park",

            // Post-Panic Phrases
            post_panic_phrases: ["Hoffentlich wurdest du nicht erwischt 😁", "Das war knapp...", "Jetzt sicher 😮‍💨", "Zurück zum Geschäft 😏"],

            vpn_title: "Hinweis",
            vpn_text_1: "Muss dich warnen: Du gehst auf eine 18+ Seite mit Werbung. Nur für den Fall 😊.",
            vpn_text_pwa: "Falls das Video nicht läuft, starte es neu oder öffne es im Browser.",
            vpn_text_2: "VPN nicht vergessen! Viel Spaß 😏",
            vpn_btn: "Los geht's",

            tips_btn: "Nützliche Tipps",
            tips_title: "Wissensdatenbank",
            tips_guru_title: "Werde ein Video-Guru 😈",
            btn_got_it: "Verstanden",

            tip_ads_title: "Werbung entfernen",
            tip_ads_desc: "Tricks für die App",
            tip_ads_text: "xFetishHub selbst hat KEINE Werbung. Externe Seiten schon.<br><br><b>Tipp für die App (PWA):</b><br>Installiere einen Ad-Blocker (z.B. AdGuard) in Safari/Chrome. Er funktioniert automatisch auch in der App!",

            tip_video_title: "Video läuft nicht?",
            tip_video_desc: "Schwarzer Bildschirm",
            tip_video_text: "Wegen der PWA-Technologie laden Videos in der App manchmal nicht.<br><br><b>Lösung:</b><br>1. Seite neu laden.<br>2. Im normalen Browser öffnen.",

            tip_pay_title: "Wie bezahlen?",
            tip_pay_desc: "Warum Krypto & Anleitung",
            tip_pay_text: "Wir akzeptieren nur Krypto (USDT) wegen der Erwachsenen-Inhalte.<br><br><b>Neu bei Krypto?</b><br>1. Öffne <b>@wallet</b> in Telegram.<br>2. Kaufe USDT via P2P.<br>3. Sende an unsere Adresse (Netzwerk TRC20).",

            tip_bug_title: "Problem melden",
            tip_bug_desc: "Hilf uns",
            tip_bug_text: "Ein Entwickler, neues Projekt. Fehler passieren.<br><br>Nutze <b>'Problem melden'</b> im Extras-Menü. Ich reagiere schnell!",

            tip_panic_title: "Nicht erwischt werden",
            tip_panic_desc: "Stealth-Modus",
            tip_panic_text: "Die App hat einen <b>Panikmodus</b>. Aktiviere ihn durch <b>Doppeltippen</b> (oder Tasten am PC).<br><br>Er zeigt eine neutrale Oberfläche ohne peinliche Inhalte.<br>Beenden: Klicke auf den Hauptbutton oder nutze die gleiche Geste.",

            tip_layout_title: "Überlappende Sätze",
            tip_layout_desc: "Layout korrigieren",
            tip_layout_text: "Wegen PWA-Eigenheiten rutscht die Karte manchmal zu hoch und Text wird verdeckt.<br><br><b>Lösung:</b><br>Drehe das Handy ins <b>Querformat</b> und zurück ins <b>Hochformat</b>. Das Layout wird korrigiert.",

            tip_int_title: "Intensitätsstufen",
            tip_int_desc: "Was genau ändert sich?",
            tip_int_text: `
                <b>🛡️ SICHER (Stufe 1):</b><br>
                Vanille und Romantik. Blockiert BDSM und Fetische komplett. "Sauberer" Inhalt.<br><br>
                <b>🔥 WÜRZIG (Stufe 2):</b><br>
                Schaltet <b>BDSM & Kink</b> frei. Fügt Fesselspiele, Spanking und Dominanz hinzu. Blockiert noch Körperflüssigkeiten.<br><br>
                <b>💀 EXTREM (Stufe 3):</b><br>
                Schaltet <b>Hardcore</b> frei. Fügt hinzu, was verborgen war: Natursekt, Scat, Fisting und Schmerz. Keine Filter.
            `,

            tip_modes_title: "Spielmodi",
            tip_modes_desc: "Erkunden vs Genuss vs KI",
            tip_modes_text: `
                <b>🔭 Erkunden:</b><br>
                Ausgewogener Zufall. Priorisiert das Entdecken neuer Genres. Perfekt, wenn du unentschlossen bist.<br><br>
                <b>🥰 Genuss:</b><br>
                Folgt streng deinen Vorlieben. Nutzt deine "Likes". Ideal für einen garantierten Treffer.<br><br>
                <b>🤖 KI-Agent:</b><br>
                Aktiviert bei Text- oder Sprachsuche. Versteht Kontext ("härter", "etwas Neues").
            `,

            // --- Generator ---
            generate: "Zufallsgenre",
            generate_again: "Anderes Genre",
            btn_similar: "Ähnlich",
            watch: "Ansehen",
            search: "Suchen",
            related_header: "Das könnte Ihnen auch gefallen:",
            mod_manage: "Mods verwalten",
            mod_title: "Modifikatoren",
            mod_active_sec: "Aktiv",
            mod_inactive_sec: "Inaktiv",
            mod_limit_reached: "Limit erreicht!",
            add_genre: "Zum Genre:",
            search_en_label: "Suche auf EN",
            site_label: "Webseite",
            exploration_mode: "Intensität",

            // --- Subscription ---
            sub_title: "Premium Zugang",
            sub_intro: "xFetishHub ist ein einzigartiges Projekt, das dir hilft, deine Vorlieben an einem gemütlichen, werbefreien Ort zu entdecken und zu analysieren. Mit einem Abo sicherst du den Fortbestand des Projekts, und im Gegenzug biete ich dir deutlich mehr Funktionen:",
            
            feat_limit: "🎲 50 Generationen / Tag",
            feat_stats_basic: "📊 Basis-Statistik",
            feat_filters: "✔️ Standardfilter",
            btn_current: "Aktueller Plan",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / Woche",
            feat_wrapped_unlim: "✨ <b>Unbegrenztes</b> Wrapped",

            lbl_subscription: "Abonnement",
            limit_text_full: "🎲 50 Generationen / Tag (übrig: {n}/50)",

            feat_unlim: "🔥 Unbegrenzte Generationen",
            feat_stats_adv: "📈 Erweiterte Statistik",
            feat_custom: "🎨 Tiefe Anpassung",
            feat_early: "🚀 Frühzugang",
            btn_get_pro: "Pro holen",

            feat_all_pro: "👑 Alle Pro-Funktionen",
            feat_all_beast: "🦁 <b>Alle Beast-Funktionen</b>",
            feat_sponsors: "💎 In Sponsorenliste",
            feat_discord: "💬 Discord mit dem Entwickler",
            feat_vote: "🗳️ Abstimmung",
            btn_get_beast: "Beast werden",

            bill_monthly: "Monatlich",
            bill_yearly: "Jährlich",

            btn_lower_tier: "Du verdienst Besseres",

            pay_desc: "Wähle eine Zahlungsmethode. Du erhältst sofort einen Aktivierungscode.",
            pay_stars: "Telegram Stars",
            pay_card: "Karte (Weltweit)",
            pay_crypto: "Krypto (Anonym)",
            pay_boosty: "Boosty (Karten)",
            pay_code_label: "Wenn bezahlt, Code hier eingeben:",
            pay_code_placeholder: "Aktivierungscode...",

            lbl_current_plan: "Aktueller Plan",
            login_alert: "Bitte anmelden, um Abos zu verwalten!",

            // --- Account ---
            login_text: "Anmelden / Sync",
            personal_account: "Persönliches Konto",
            btn_open_stats: "Statistik",

            // ТЕМЫ
            "theme_blue-dark": "Mitternacht",
            "theme_green-dark": "Wald",
            "theme_red-dark": "Vampir",
            "theme_gold-dark": "Luxus",
            "theme_noir": "Noir",
            "theme_blue-light": "Himmel",
            "theme_green-light": "Minze",
            "theme_red-light": "Rose",
            "theme_gold-light": "Sand",
            "theme_dark": "Dunkel",
            "theme_light": "Hell",

            history_title: "Verlauf",

            logout_text: "Abmelden",
            login_required: "Bitte melde dich an, um das Abo zu aktivieren!",
            sync_success: "Daten synchronisiert!",
            
            btn_reset: "Daten zurücksetzen",
            confirm_reset: "Bist du sicher? Dies löscht Verlauf und Statistiken. Kann nicht rückgängig gemacht werden.",
            reset_done: "Daten zurückgesetzt.",
            
            explored_label: "Erforscht",
            explored_txt: "{n} / {t} Kategorien",
            report_issue: "Problem melden",

            sync_title: "Cloud-Speicher",
            sync_desc: "Daten sicher auf Google-Servern gespeichert",
            sync_tip: "Klicke auf 'Synchronisieren'. <b>Seite wird neu geladen.</b>",
            sync_btn_success: "✅ Fertig! Wird neu geladen...",
            btn_sync: "🔄 Synchronisieren",
            sub_exp: "abl:",
            sub_expired: "Abgelaufen",
            time_d: "t",

            // --- Lists ---
            favorites_catalog: "Gefällt mir",
            blacklist_catalog: "Gefällt mir nicht",
            btn_fav_add: "Favorit",
            btn_fav_remove: "In Favoriten",
            btn_ban_add: "Blockieren",
            btn_ban_remove: "Entblocken",
            empty: "Liste leer (Filter)!",

            // --- Filters ---
            filter_include: "Einschließen",
            filter_exclude: "Ausschließen",
            tag_fav: "Favoriten",
            tag_straight: "Hetero", tag_gay: "Schwul", tag_lesbian: "Lesbisch", tag_trans: "Trans",

            // --- Stats ---
            btn_stats: "Statistik",
            stats_header: "Deine Favoriten",
            stats_prefs: "Vorlieben",
            stats_activity: "Aktivität",
            tf_week: "Woche", tf_month: "Monat", tf_year: "Jahr", tf_all: "Gesamtzeit",
            act_gen: "Generationen", act_watch: "Angeschaut",
            chart_prefs_x: "Vorlieben",
            chart_points_y: "Punkte",
            chart_count_y: "Anzahl",
            share_btn: "Teilen",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Komm in einer Woche wieder. Oder wenn du tägliche Statistiken willst, ist das Pro-Abo dein bester Freund.",
            btn_close: "Schließen",
            search_liked: "Favoriten suchen...",
            search_disliked: "Blockierte suchen...",
            hist_empty: "Verlauf leer",
            limit_reset: "Reset:",

            legend_watch: "Ansehen (+10)",
            legend_like: "Like (+5)",
            legend_dislike: "Andere / Dislike (-10)",
            act_actions: "Swipes",
            act_watches: "Angeschaut",

            // --- Explain ---
            expl_fav: "Weil du magst: ",
            expl_sim: "Ähnlich wie voriges",
            expl_rand: "Schicksal",
            expl_score: "Weil du mochtest: ",
            expl_tag_click: "Tag gewählt: ",

            // --- Badges ---
            badge_extreme: "Extrem",
            badge_desc_extreme: "⚠️ <b>Hohe Intensität</b><br>Raue oder intensive Inhalte.",
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>LGBTQ+ Inhalt</b><br>Gleichgeschlechtliche oder Trans-Inhalte.",
            badge_niche: "Nische",
            badge_desc_niche: "🔍 <b>Spezifischer Fetisch</b><br>Besondere Interessen, kein Mainstream.",
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM</b><br>Fesselspiele, Dominanz und Unterwerfung.",

            // --- Modals ---
            age_title: "Altersprüfung",
            age_desc: "Diese Website enthält Material für Erwachsene. Sind Sie 18 Jahre oder älter?",
            age_yes: "Ja, ich bin 18+",
            age_no: "Nein, Verlassen",
            age_block_msg: "Diese Website ist nur für Nutzer über 18 Jahre bestimmt.",
        
            install_title: "App installieren",
            install_desc: "Installiere die App für Vollbild. Plus: Schaue Videos im integrierten Browser, um deinen Hauptverlauf sauber zu halten!",
            install_continue: "Im Browser fortfahren",

            btn_install_phone: "Auf Handy installieren",
            qr_title: "Scannen zum Installieren",
            qr_desc: "Scanne diesen QR-Code mit deiner Kamera, dann befolge die Anweisungen:",
            
            inst_ios_1: "Tippe auf <b>Teilen</b>",
            inst_ios_2: "Scrolle runter und wähle",
            inst_ios_btn: "Zum Home-Bildschirm",
            inst_ios_3: "Tippe auf <b>Hinzufügen</b>.",
            
            inst_and_1: "Tippe auf <b>Menü</b> (3 Punkte)",
            inst_and_2: "Wähle",
            inst_and_btn: "App installieren",

            onb_title: "Schnelleinrichtung",
            onb_desc: "Schreib, was du magst oder nicht magst, damit wir direkt zu dem kommen, was du liebst 😈.",
            onb_placeholder: "z.B. Ich liebe Blowjob und Anal, hasse aber Fußfetisch und Outdoor...",
            onb_btn_check: "Kategorien suchen",
            onb_found: "Wir haben gefunden:",
            onb_btn_confirm: "Zu Favoriten",
            onb_skip: "Überspringen",

            lbl_about: "Über das Projekt",
            
            terms_text: `
                <h3>1. Annahme der Bedingungen</h3>
                <p>Durch den Zugriff auf xFetishHub bestätigen Sie, dass Sie mindestens 18 Jahre alt sind und stimmen diesen Bedingungen zu. Wenn Sie nicht zustimmen, müssen Sie den Dienst sofort verlassen.</p>
                
                <h3>2. Art des Dienstes</h3>
                <p>xFetishHub ist ein Suchaggregator und eine Empfehlungsmaschine. <b>Wir hosten, laden hoch oder kontrollieren keine Videoinhalte.</b> Alle Links führen zu Websites Dritter. Wir dienen lediglich als Vermittler zum Auffinden von Inhalten, die öffentlich verfügbar sind.</p>
                
                <h3>3. Inhalte Dritter</h3>
                <p>Wir haben keine Kontrolle über und übernehmen keine Verantwortung für die Inhalte oder Datenschutzrichtlinien von Websites Dritter. Sie erkennen an, dass xFetishHub nicht für Schäden haftbar gemacht werden kann, die durch Ihre Nutzung von Inhalten Dritter verursacht werden.</p>
                
                <h3>4. Benutzerkonten & Abonnements</h3>
                <p>Einige Funktionen erfordern ein kostenpflichtiges Abonnement ("Pro" oder "Beast"). Die Zahlung erfolgt per direkter Kryptowährungsüberweisung (USDT). Wir speichern keine Zahlungsdaten. Wir behalten uns das Recht vor, Konten zu kündigen, die gegen diese Bedingungen verstoßen.</p>
                
                <h3>5. Gewährleistungsausschluss</h3>
                <p>Der Dienst wird "WIE BESEHEN" bereitgestellt. Wir garantieren nicht, dass die Ergebnisse Ihren Anforderungen entsprechen oder fehlerfrei sind.</p>
            `,

            privacy_text: `
                <h3>1. Einführung</h3>
                <p>Ihre Privatsphäre ist unsere Priorität. Diese Richtlinie erklärt, wie wir mit Ihren Daten umgehen. Wir sammeln nur die absolut notwendigen Informationen.</p>
                
                <h3>2. Datenerfassung</h3>
                <p><b>Authentifizierung:</b> Wenn Sie sich über Google anmelden, erhalten wir Ihre E-Mail und UID. Wir sehen Ihr Passwort nicht. <b>Nutzung:</b> Wir speichern Ihren Verlauf, Favoriten und Präferenzen lokal und verschlüsselt in unserer Datenbank. <b>Lokaler Speicher:</b> Wir verwenden den lokalen Browserspeicher für Ihre Einstellungen.</p>

                <h3>3. Verwendung der Daten</h3>
                <p>Ihre Daten werden ausschließlich verwendet für: Synchronisierung Ihres Fortschritts, Überprüfung Ihres Abonnementstatus und Training des Personalisierungsalgorithmus. <b>Wir verkaufen Ihre Daten nicht an Dritte.</b></p>

                <h3>4. Datenlöschung</h3>
                <p>Sie können jederzeit die vollständige Löschung Ihres Kontos und Ihrer Daten beantragen, indem Sie den Support kontaktieren oder "Daten zurücksetzen" in der App verwenden.</p>
            `,

            refund_text: `
                <h3>1. Richtlinie für digitale Güter</h3>
                <p>Aufgrund der Natur digitaler Inhalte sind alle Verkäufe von Abonnements für xFetishHub in der Regel <b>endgültig und nicht erstattungsfähig</b>, sobald das Abonnement aktiviert wurde.</p>
                
                <h3>2. Ausnahmen</h3>
                <p>Wir können unter folgenden Umständen eine Rückerstattung anbieten: <b>Nichtlieferung:</b> Sie haben bezahlt, aber den Dienst nicht innerhalb von 24 Stunden erhalten. <b>Doppelbuchung:</b> Ihnen wurde derselbe Zeitraum aufgrund eines Fehlers zweimal berechnet.</p>

                <h3>3. Anforderung</h3>
                <p>Um eine Rückerstattung zu beantragen, kontaktieren Sie den Support. Geben Sie Ihre Transaktions-ID (TxID) an. Anfragen müssen innerhalb von 14 Tagen nach dem Kauf gestellt werden.</p>
            `
        }
    };

    const tipsData = [
    { 
        id: 'ads', 
        icon: '🛡️', 
        titleKey: 'tip_ads_title', 
        descKey: 'tip_ads_desc', 
        textKey: 'tip_ads_text',
        gradient: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' // Синий
    },
    { 
        id: 'video', 
        icon: '▶️', 
        titleKey: 'tip_video_title', 
        descKey: 'tip_video_desc', 
        textKey: 'tip_video_text',
        gradient: 'linear-gradient(135deg, #ec4899 0%, #be185d 100%)' // Розовый
    },
    { 
        id: 'pay', 
        icon: '💸', 
        titleKey: 'tip_pay_title', 
        descKey: 'tip_pay_desc', 
        textKey: 'tip_pay_text',
        gradient: 'linear-gradient(135deg, #10b981 0%, #059669 100%)' // Изумрудный
    },
    { 
        id: 'bug', 
        icon: '🐛', 
        titleKey: 'tip_bug_title', 
        descKey: 'tip_bug_desc', 
        textKey: 'tip_bug_text',
        gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' // Оранжевый
    },
    { 
        id: 'panic', 
        icon: '🚨', 
        titleKey: 'tip_panic_title', 
        descKey: 'tip_panic_desc', 
        textKey: 'tip_panic_text',
        gradient: 'linear-gradient(135deg, #ef4444 0%, #b91c1c 100%)' // Красный
    },
    { 
        id: 'layout', 
        icon: '📱', 
        titleKey: 'tip_layout_title', 
        descKey: 'tip_layout_desc', 
        textKey: 'tip_layout_text',
        gradient: 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)' // Фиолетовый
    },
    { 
        id: 'intensity', 
        icon: '🌶️', 
        titleKey: 'tip_int_title', 
        descKey: 'tip_int_desc', 
        textKey: 'tip_int_text',
        gradient: 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)' // Желто-оранжевый
    },
    { 
        id: 'modes', 
        icon: '🎛️', 
        titleKey: 'tip_modes_title', 
        descKey: 'tip_modes_desc', 
        textKey: 'tip_modes_text',
        gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' // Сине-фиолетовый
    },
    { 
        id: 'sites_guide', 
        icon: '🌐', 
        titleKey: 'tip_sites_title', 
        descKey: 'tip_sites_desc', 
        textKey: 'tip_sites_text',
        gradient: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)' // Голубой градиент
    },
    { 
        id: 'algo_secrets', 
        icon: '🧠', 
        titleKey: 'tip_algo_title', 
        descKey: 'tip_algo_desc', 
        textKey: 'tip_algo_text',
        gradient: 'linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%)' // Фиолетовый (Интеллект)
    },
    { 
        id: 'glossary', 
        icon: '🎓', 
        titleKey: 'tip_dict_title', 
        descKey: 'tip_dict_desc', 
        textKey: 'tip_dict_text',
        gradient: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' // Изумрудный (Знания)
    },
    { 
        id: 'psychotypes', 
        icon: '🎭', 
        titleKey: 'tip_psycho_title', 
        descKey: 'tip_psycho_desc', 
        textKey: 'tip_psycho_text',
        gradient: 'linear-gradient(135deg, #f2994a 0%, #f2c94c 100%)' // Золотой (Ачивки)
    },
    { 
        id: 'install_guide', 
        icon: '📲', 
        titleKey: 'tip_pwa_title', 
        descKey: 'tip_pwa_desc', 
        textKey: 'tip_pwa_text',
        gradient: 'linear-gradient(135deg, #00f260 0%, #0575E6 100%)' // Яркий Cyan-Blue градиент
    },
    { 
        id: 'mods_guide', 
        icon: '⚙️', 
        titleKey: 'tip_mods_title', 
        descKey: 'tip_mods_desc', 
        textKey: 'tip_mods_text',
        gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' // Фиолетовый
    },
    { 
        id: 'missing_wrapped', 
        icon: '🔔', 
        titleKey: 'tip_badge_title', 
        descKey: 'tip_badge_desc', 
        textKey: 'tip_badge_text',
        gradient: 'linear-gradient(135deg, #6366f1 0%, #a855f7 100%)' 
    }
];
    
    const TIPS_CATS = {
        tech: ['install_guide', 'mods_guide', 'ads', 'video', 'pay', 'bug', 'panic', 'layout', 'modes'],
        info: ['sites_guide', 'algo_secrets', 'glossary', 'psychotypes', 'intensity', 'missing_wrapped']
    };

    // --- WRAPPED DATA & TEXTS ---
    const WRAPPED_CONFIG = {
        badges: {
            en: { daily: "Daily", weekly: "Weekly", monthly: "Monthly", yearly: "Yearly" },
            ru: { daily: "день", weekly: "неделю", monthly: "месяц", yearly: "год" },
            es: { daily: "Diario", weekly: "Semanal", monthly: "Mensual", yearly: "Anual" },
            de: { daily: "Tag", weekly: "Woche", monthly: "Monat", yearly: "Jahr" }
        },
        // Фразы для слайдов (Intro)
        phrases: {
            daily: {
                en: ["Quick check-in? Let's see.", "Another day, another stats.", "Your daily dose of data."],
                ru: ["Быстрая проверка? Смотрим.", "Новый день, новые цифры.", "Твоя дневная доза данных."],
                es: ["¿Chequeo rápido? Veamos.", "Otro día, otras estadísticas.", "Tu dosis diaria de datos."],
                de: ["Kurzer Check? Mal sehen.", "Neuer Tag, neue Daten.", "Deine tägliche Dosis."]
            },
            weekly: {
                en: ["It's been a busy week.", "Seven days of secrets.", "Your week in review."],
                ru: ["Неделька была насыщенной.", "Семь дней секретов.", "Обзор твоей недели."],
                es: ["Ha sido una semana ocupada.", "Siete días de secretos.", "Tu semana en revisión."],
                de: ["Eine arbeitsreiche Woche.", "Sieben Tage voller Geheimnisse.", "Dein Wochenrückblick."]
            },
            monthly: {
                en: ["The month is over. The stats are in.", "30 days of desires.", "Let's look at the bigger picture."],
                ru: ["Месяц позади. Данные собраны.", "30 дней твоих желаний.", "Взглянем на картину целиком."],
                es: ["El mes ha terminado.", "30 días de deseos.", "Miremos el panorama general."],
                de: ["Der Monat ist vorbei.", "30 Tage deiner Wünsche.", "Das große Ganze."]
            },
            yearly: {
                en: ["Your year defined.", "365 days of you.", "The ultimate summary."],
                ru: ["Твой год в цифрах.", "365 дней тебя.", "Финальный отчёт."],
                es: ["Tu año definido.", "365 días de ti.", "El resumen definitivo."],
                de: ["Dein Jahr definiert.", "365 Tage von dir.", "Die ultimative Zusammenfassung."]
            }
        },
        // Достижения (Значки)
        achievements: {
            // Время суток
            morning: { 
                icon: "🌅", 
                en: "Early Bird", ru: "Ранняя пташка", es: "Madrugador", de: "Frühaufsteher",
                desc_en: "You start your day with pleasure.", desc_ru: "Ты начинаешь день с удовольствия.", desc_es: "Empiezas el día con placer.", desc_de: "Du beginnst den Tag mit Vergnügen."
            },
            day: { 
                icon: "☀️", 
                en: "Day Walker", ru: "Дневной житель", es: "Diurno", de: "Tagwanderer",
                desc_en: "Active during business hours.", desc_ru: "Активен в рабочее время.", desc_es: "Activo en horario laboral.", desc_de: "Aktiv während der Geschäftszeiten."
            },
            night: { 
                icon: "🦇", 
                en: "Night Owl", ru: "Полуночник", es: "Nocturno", de: "Nachteule",
                desc_en: "You thrive in the dark.", desc_ru: "Ты расцветаешь в темноте.", desc_es: "Brillas en la oscuridad.", desc_de: "Du blühst im Dunkeln auf."
            },
            // Тип активности
            binger: { 
                icon: "🍿", 
                en: "The Binger", ru: "Зритель", es: "Espectador", de: "Zuschauer",
                desc_en: "High watch time. You love content.", desc_ru: "Много просмотров. Ты любишь контент.", desc_es: "Mucho tiempo viendo.", desc_de: "Viel Zeit beim Zuschauen."
            },
            picky: { 
                icon: "🧐", 
                en: "The Critic", ru: "Критик", es: "Crítico", de: "Kritiker",
                desc_en: "Lots of swipes, few watches.", desc_ru: "Много свайпов, мало просмотров.", desc_es: "Muchos swipes, pocas vistas.", desc_de: "Viele Swipes, wenig angesehen."
            },
            // Стиль (На основе разнообразия тегов)
            explorer: { 
                icon: "🔭", 
                en: "The Explorer", ru: "Исследователь", es: "Explorador", de: "Entdecker",
                desc_en: "You constantly seek new genres.", desc_ru: "Ты постоянно ищешь новые жанры.", desc_es: "Buscas nuevos géneros.", desc_de: "Du suchst ständig neue Genres."
            },
            hedonist: { 
                icon: "🥰", 
                en: "The Hedonist", ru: "Гедонист", es: "Hedonista", de: "Hedonist",
                desc_en: "You stick to what you love.", desc_ru: "Ты верен своим любимым темам.", desc_es: "Te apegas a lo que amas.", desc_de: "Du bleibst bei dem, was du liebst."
            }
        }
    };

    // === КОНФИГУРАЦИЯ ПСИХОТИПОВ ===
    const PSYCHO_TYPES = {
        // 1. По доминирующей оси (10 шт)
        'bdsm': {
            en: "The Kink Master", ru: "Мастер Кинка", es: "Amo del Kink", de: "Kink-Meister",
            desc_en: "Control and sensation are your currency.", desc_ru: "Контроль и ощущения — твоя валюта."
        },
        'roleplay': {
            en: "The Shapeshifter", ru: "Перевертыш", es: "Camaleón", de: "Gestaltwandler",
            desc_en: "You can be anyone for the sake of pleasure.", desc_ru: "Ты можешь быть кем угодно ради удовольствия."
        },
        'humiliation': {
            en: "The Devotee", ru: "Поклонник", es: "Devoto", de: "Der Hingebungsvolle",
            desc_en: "You find strength in surrender.", desc_ru: "Ты находишь силу в капитуляции."
        },
        'public': {
            en: "The Exhibitionist", ru: "Эксгибиционист", es: "Exhibicionista", de: "Exhibitionist",
            desc_en: "The world is your stage.", desc_ru: "Весь мир — твоя сцена."
        },
        'clothing': {
            en: "The Fetishista", ru: "Фетишиста", es: "Fetichista", de: "Fetischista",
            desc_en: "Material matters more than flesh.", desc_ru: "Материал важнее, чем плоть."
        },
        'sensory': {
            en: "The Sensorium", ru: "Сенсорик", es: "Sensorial", de: "Sensoriker",
            desc_en: "Feeling is believing.", desc_ru: "Чувствовать — значит верить."
        },
        'psychological': {
            en: "The Psychonaut", ru: "Психонавт", es: "Psiconauta", de: "Psychonaut",
            desc_en: "It's all in the mind.", desc_ru: "Всё происходит в голове."
        },
        'taboo': {
            en: "The Deviant", ru: "Девиант", es: "Desviado", de: "Abweichler",
            desc_en: "Rules are meant to be broken.", desc_ru: "Правила созданы, чтобы их нарушать."
        },
        'group': {
            en: "The Party Animal", ru: "Тусовщик", es: "Fiestero", de: "Partylöwe",
            desc_en: "The more, the merrier.", desc_ru: "Чем больше, тем веселее."
        },
        'body-part': {
            en: "The Anatomist", ru: "Анатом", es: "Anatomista", de: "Anatom",
            desc_en: "You appreciate the specific details.", desc_ru: "Ты ценишь конкретные детали."
        },

        // 2. Комбинации (10 шт)
        'dark_lord': { // BDSM + Taboo/Humiliation
            en: "The Dark Lord", ru: "Темный Лорд", es: "Señor Oscuro", de: "Dunkler Lord",
            desc_en: "You explore the deepest shadows.", desc_ru: "Ты исследуешь самые глубокие тени."
        },
        'performer': { // Public + Roleplay
            en: "The Performer", ru: "Артист", es: "Artista", de: "Performer",
            desc_en: "Life is a performance.", desc_ru: "Жизнь — это представление."
        },
        'worshipper': { // Body-part + Clothing
            en: "The Idolater", ru: "Идолопоклонник", es: "Idólatra", de: "Götzendiener",
            desc_en: "Specific forms deserve worship.", desc_ru: "Формы заслуживают поклонения."
        },
        'brainwasher': { // Psychological + Humiliation
            en: "The Manipulator", ru: "Манипулятор", es: "Manipulador", de: "Manipulator",
            desc_en: "You play with souls, not bodies.", desc_ru: "Ты играешь с душами, а не телами."
        },
        'risk_taker': { // Public + Taboo
            en: "Adrenaline Junkie", ru: "Адреналинщик", es: "Adicto a Adrenalina", de: "Adrenalin-Junkie",
            desc_en: "Danger is the best spice.", desc_ru: "Опасность — лучшая приправа."
        },
        'orgy_master': { // Group + BDSM/Public
            en: "The Caligula", ru: "Калигула", es: "Calígula", de: "Caligula",
            desc_en: "Chaos and pleasure intertwined.", desc_ru: "Хаос и удовольствие переплетены."
        },
        'immersionist': { // Roleplay + Sensory
            en: "The Immersionist", ru: "Иммерсив", es: "Inmersivo", de: "Immersionist",
            desc_en: "Deep dive into alternate realities.", desc_ru: "Глубокое погружение в иную реальность."
        },
        'collector': { // Разнообразие (много разных)
            en: "The Collector", ru: "Коллекционер", es: "Coleccionista", de: "Sammler",
            desc_en: "You want to try everything once.", desc_ru: "Ты хочешь попробовать всё."
        },
        
        // 3. Дефолтные
        'vanilla': {
            en: "The Classic", ru: "Классик", es: "Clásico", de: "Klassiker",
            desc_en: "Simplicity is the ultimate sophistication.", desc_ru: "Простота — высшая форма утонченности."
        }
    };

    // 10 психологических осей
    const PSYCHO_AXES = [
        'bdsm', 'roleplay', 'humiliation', 'public', 'clothing', 
        'sensory', 'psychological', 'taboo', 'group', 'body-part'
    ];

    // Переводы для графика
    const PSYCHO_LABELS = {
        'bdsm': {en:'BDSM', ru:'БДСМ', es:'BDSM', de:'BDSM'},
        'roleplay': {en:'Roleplay', ru:'Ролевые', es:'Rol', de:'Rollenspiel'},
        'humiliation': {en:'Humiliation', ru:'Унижение', es:'Humillación', de:'Demütigung'},
        'public': {en:'Public', ru:'Публика', es:'Público', de:'Öffentlich'},
        'clothing': {en:'Clothing', ru:'Одежда', es:'Ropa', de:'Kleidung'},
        'sensory': {en:'Sensory', ru:'Сенсорика', es:'Sensorial', de:'Sensorik'},
        'psychological': {en:'Mind', ru:'Психо', es:'Mente', de:'Psyche'},
        'taboo': {en:'Taboo', ru:'Табу', es:'Tabú', de:'Tabu'},
        'group': {en:'Group', ru:'Группа', es:'Grupo', de:'Gruppe'},
        'body-part': {en:'Body', ru:'Тело', es:'Cuerpo', de:'Körper'}
    };

    // Функция локализации для Wrapped
    function getWText(key, subkey) {
        const lang = WRAPPED_CONFIG.badges[currentLang] ? currentLang : 'en';
        if(key === 'badge') return WRAPPED_CONFIG.badges[lang][subkey];
        return "Text";
    }

    const KEYWORD_ALIASES = {
        'redhead': ['ginger', 'firecrotch', 'рыжая', 'рыжие', 'рыжих', 'рыжими', 'pelirroja', 'rothaarige', 'red', 'рыженькая'],
        'blonde': ['blond', 'fair', 'блондинка', 'блондинки', 'блондинок', 'блондинками', 'беленькая', 'rubia', 'blondine'],
        'brunette': ['brown', 'dark hair', 'брюнетка', 'брюнетки', 'черненькая', 'темненькая', 'morena', 'brünette'],
        'anal': ['ass', 'butt', 'анал', 'жопа', 'culo', 'trasero', 'arsch', 'hintern', 'anal'],
        'milf': ['mom', 'mother', 'мамка', 'мать', 'madre', 'mama', 'mutter', 'reif'],
        'teen': ['school', 'student', 'young', '18', 'школьница', 'студентка', 'joven', 'estudiante', 'jung', 'schülerin'],
        'group': ['orgy', 'gangbang', 'threesome', 'групповой', 'оргия', 'trio', 'orgía', 'grupo', 'orgie', 'groupsex', 'dreier'],
        'bdsm': ['rough', 'hard', 'slave', 'bondage', 'жестко', 'грубо', 'бдсм', 'duro', 'esclava', 'hart', 'fesseln', 'domina'],
        'tits': ['big-tits', 'boobs', 'busty', 'сиськи', 'грудь', 'tetas', 'pechos', 'titten', 'große'],
        'feet': ['foot', 'toes', 'ноги', 'ступни', 'pies', 'patas', 'füße', 'fuss'],
        'lesbian': ['girl-on-girl', 'tribadism', 'лесби', 'ножницы', 'lesbiana', 'tijeras', 'lesbisch'],
        'cum': ['creampie', 'facial', 'сперма', 'кончил', 'leche', 'corrida', 'sperma', 'besamung']
    };

    const CONTEXT_TRIGGERS = {
        'harder': [
            'harder', 'rougher', 'extreme', 'more intense', // EN
            'жестче', 'грубее', 'сильнее', 'пожестче', // RU
            'mas duro', 'más fuerte', 'intenso', 'violento', // ES
            'härter', 'stärker', 'intensiver', 'wilder' // DE
        ],
        'softer': [
            'softer', 'gentle', 'vanilla', 'less intense', // EN
            'мягче', 'нежнее', 'ваниль', 'полегче', // RU
            'suave', 'lento', 'cariñoso', 'mas suave', // ES
            'sanfter', 'weicher', 'zärtlich', 'ruhiger' // DE
        ],
        'more': [
            'more', 'another', 'else', 'similar', // EN
            'еще', 'другое', 'похожее', // RU
            'mas', 'otro', 'quiero mas', // ES
            'mehr', 'noch eins', 'anderes' // DE
        ]
    };
    
    const THINKING_STEPS = {
        en: ["Analyzing preferences...", "Checking history...", "Filtering tags...", "Selecting best match..."],
        ru: ["Анализирую вкусы...", "Сверяю с историей...", "Отсеиваю лишнее...", "Выбираю лучшее..."],
        es: ["Analizando gustos...", "Revisando historial...", "Filtrando etiquetas...", "Seleccionando..."],
        de: ["Analysiere...", "Prüfe Verlauf...", "Filtere Tags...", "Wähle aus..."]
    };

    window.openLegal = function(type) {
        // 1. Берем текущие переводы из langData
        const t = langData[currentLang] || langData['en'];

        let titleText = "Document";
        let bodyHTML = "<p>Loading...</p>";

        // 2. Выбираем текст в зависимости от типа
        if (type === 'terms') {
            titleText = t.doc_terms;
            bodyHTML = t.terms_text;
        } 
        else if (type === 'privacy') {
            titleText = t.doc_privacy;
            bodyHTML = t.privacy_text;
        } 
        else if (type === 'refund') {
            titleText = t.doc_refund;
            bodyHTML = t.refund_text;
        }

        // 3. Заполняем модальное окно
        const titleEl = document.getElementById('legal-modal-title');
        const contentEl = document.getElementById('legal-modal-content');
        
        if (titleEl) titleEl.innerText = titleText;
        if (contentEl) contentEl.innerHTML = bodyHTML;

        // 4. Открываем
        const modal = document.getElementById('modal-legal-overlay');
        if(modal) {
            modal.classList.add('open');
            modal.style.display = 'flex';
        }
    };

    window.closeLegal = function(e, force) {
        if (force || e.target.id === 'modal-legal-overlay') {
            const modal = document.getElementById('modal-legal-overlay');
            if(modal) {
                modal.classList.remove('open');
                modal.style.display = 'none';
            }
        }
    };

    const EXTREME_TAGS = ['extreme', 'blood', 'scat', 'piss', 'pain', 'torture', 'vomit', 'enema', 'fisting', 'needle-play'];
    const SPICY_TAGS = ['bdsm', 'kinky', 'fetish', 'bondage', 'domination', 'submission', 'spanking'];
    const LGBT_TAGS = ['gay', 'trans', 'shemale', 'bi', 'crossdresser'];

    const filterCats = [
        { id: 'straight', key: 'tag_straight' },
        { id: 'gay', key: 'tag_gay' },
        { id: 'lesbian', key: 'tag_lesbian' },
        { id: 'trans', key: 'tag_trans' }
    ];

    window.onload = async () => {
        initLanguage();
        initTheme();
        initIntensity();
        initDecoSettings();
        randomizeDecorations();
        renderModifiers();
        renderHistory();
        updateCounts();
        syncScoresFromLists(); 
        
        // 2. Инициализация систем
        initAgeGate();
        initSwipeCards();

        const wrapper = document.getElementById('card-anim-wrapper');
            if (wrapper) {
                wrapper.style.opacity = '0'; // Скрываем всю обертку
                
                const cardBlock = document.getElementById('card-block');
                if(cardBlock) cardBlock.classList.add('card-content-hidden');
            }
        
        // 3. Установка платформы
        const savedPlatform = localStorage.getItem('xch_platform');
        if (savedPlatform) {
            const platformSelect = document.getElementById('platform');
            if (platformSelect) platformSelect.value = savedPlatform;
        }
        updateLink();

        // 4. Текст и Анимация слота
        setWelcomeMessage(); 
        
        // Сброс флага первой генерации
        isFirstGen = true; 
        
        // Запуск "холостого хода" слота (бегущая строка)
        initIdleSlot(); 

        updateSubscriptionUI();
        
        // 5. Инициализация Ориентации
        const oriSelect = document.getElementById('orientation-select');
        if (oriSelect) oriSelect.value = currentOrientation;

        // 6. Верстка (в самом конце, чтобы всё уже было готово)
        checkLayout(); 
        window.addEventListener('resize', checkLayout);
        
        // Принудительно ставим класс для мобильной шапки
        document.body.classList.add('tab-home-active');

       const bar = document.getElementById('loader-bar');
        const text = document.getElementById('loader-phrase');
        if (bar) bar.style.width = '100%';
        if (text) text.innerText = "Ready.";

        if (window.loaderIntervals) {
            clearInterval(window.loaderIntervals.phrase);
            clearInterval(window.loaderIntervals.progress);
        }

        // Задержка перед исчезновением экрана (600мс)
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            
            if (overlay) {
                // 1. Лоадер исчезает
                overlay.classList.add('hidden');
                setTimeout(() => overlay.style.display = 'none', 500);
                
                // 2. ЗАПУСК АНИМАЦИИ КАРТОЧКИ (через 100мс после начала исчезновения лоадера)
                setTimeout(() => {
                    const wrapper = document.getElementById('card-anim-wrapper');
                    const cardBlock = document.getElementById('card-block');
                    
                    if (wrapper) {
                        wrapper.style.opacity = '1'; // Показываем обертку
                        wrapper.classList.add('anim-initial-pop'); // Карточка выпрыгивает
                    }

                    // 3. ЗАПУСК ВНУТРЕННИХ ЭЛЕМЕНТОВ (Stagger)
                    if (cardBlock) {
                        // Убираем класс скрытия, чтобы сработали CSS animation-delay (stagger-item)
                        cardBlock.classList.remove('card-content-hidden');
                        
                        // Перезапускаем анимации stagger-item вручную для надежности
                        const elements = cardBlock.querySelectorAll('.stagger-item');
                        elements.forEach(el => {
                            el.style.animation = 'none';
                            el.offsetHeight; /* trigger reflow */
                            el.style.animation = ''; 
                        });
                    }
                }, 100);
            }
        }, 600);
    };

    function isPWA() {
    return (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
}

    function isMobile() {
        return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768;
    }

    // ПЕРЕХВАТ ЗАГРУЗКИ
    const originalLoadData = window.loadData;

    window.loadData = async function() {
        if (isMobile() && !isPWA()) {
            showForceInstallOverlay();
            console.log("Blocked: Mobile browser detected. PWA installation required.");
            return; // ПРЕРЫВАЕМ выполнение, основной код не запустится
        }
        
        // Если всё ок (ПК или PWA), запускаем основную загрузку
        if (originalLoadData) originalLoadData();
    };

    function showForceInstallOverlay() {
        const overlay = document.getElementById('force-install-overlay');
        const iosInstr = document.getElementById('fio-instr-ios');
        const andInstr = document.getElementById('fio-instr-android');
        const title = document.getElementById('fio-title');
        const desc = document.getElementById('fio-desc');

        // Детекция языка (из localStorage или по умолчанию)
        const lang = localStorage.getItem('xch_lang') || 'en';
        
        if (lang === 'ru') {
            title.innerText = "Нужна установка";
            desc.innerText = "Для безопасности и приватности на мобильных устройствах, xFetishHub работает только через приложение (PWA).";
        }

        overlay.style.display = 'flex';

        // Показываем инструкцию в зависимости от ОС
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
            iosInstr.style.display = 'block';
        } else {
            andInstr.style.display = 'block';
        }
    }

    async function loadData() {
        try {
            // Пытаемся загрузить JSON файл (1200+ фетишей)
            const response = await fetch('data.json');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Парсим JSON в переменную data
            data = await response.json();
            console.log(`Успешно загружено ${data.length} категорий.`);

            // 3. Запускаем инициализацию приложения ТОЛЬКО после загрузки данных
            initApp();

        } catch (error) {
            console.error('Ошибка загрузки data.json:', error);
            document.body.innerHTML = '<h2 style="color:white;text-align:center;margin-top:50px;">Error loading data.json. Check console.</h2>';
        }
    }

    function initApp() {
        // Инициализация данных
        initLanguage();
        initTheme();
        initIntensity();
        randomizeDecorations(); 
        renderModifiers();
        renderHistory();
        updateCounts();
        updateSiteLabelUI()

        document.getElementById('app-version-label').innerText = CHANGELOG_DATA[0].ver;
        
        // Инициализация систем
        initAgeGate();
        initSwipeCards();
        initModes();
        updateNavIcons('home');
        
        // Установка платформы
        const savedPlatform = localStorage.getItem('xch_platform');
        if (savedPlatform) {
            const platformSelect = document.getElementById('platform');
            if (platformSelect) platformSelect.value = savedPlatform;
        }
        updateLink();

        // Текст и Анимация слота
        setWelcomeMessage(); 
        
        isFirstGen = true; 
        
        // Запуск "холостого хода"
        initIdleSlot(); 

        updateSubscriptionUI();

        checkTipIcons();
        checkWrappedAlert(); 
        
        // Инициализация Ориентации
        const oriSelect = document.getElementById('orientation-select');
        if (oriSelect) oriSelect.value = currentOrientation;

        // Верстка
        checkLayout(); 
        window.addEventListener('resize', checkLayout);

        if (permanentExplored.size === 0 && activityLog.length > 0) {
            // Миграция: Заполняем вечную память из существующего лога
            activityLog.forEach(log => permanentExplored.add(log.id));
            localStorage.setItem('xch_permanent_explored', JSON.stringify([...permanentExplored]));
        }
        
        document.body.classList.add('tab-home-active');
        setTimeout(() => {
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.classList.add('hidden');
            }
        }, 500); 

        updateAppBadge();
        checkNotificationState();
    }

    window.onload = loadData;

    function setWelcomeMessage() {
        const statusEl = document.getElementById('status-text');
        if(!statusEl) return;
        
        const phrases = welcomePhrases[currentLang];
        // Ставим случайную фразу и делаем цвет акцентным
        statusEl.innerText = phrases[Math.floor(Math.random() * phrases.length)];
        statusEl.style.color = "var(--accent)"; 
    }

    function logActivity(type, itemId, tags) {
        const logEntry = {
            type: type,
            id: itemId,
            tags: tags || [],
            ts: Date.now()
        };
        
        // 1. Старый лог (последние 5000 действий)
        activityLog.push(logEntry);
        if (activityLog.length > 5000) activityLog = activityLog.slice(-5000);
        localStorage.setItem(STORAGE.ACTIVITY_LOG, JSON.stringify(activityLog));
        
        // 2. ВЕЧНАЯ ПАМЯТЬ (Только ID, никогда не удаляем)
        if (!permanentExplored.has(itemId)) {
            permanentExplored.add(itemId);
            // Преобразуем Set в Array для сохранения
            localStorage.setItem('xch_permanent_explored', JSON.stringify([...permanentExplored]));
            updateExploredCount(); // Обновляем цифры на кнопке
        }
        
        markDayActive();
        if (window.markDirty) window.markDirty(); 
    }

    // 1. Обновленная функция подсчета (только цифры на кнопке)
    function updateExploredCount() {
        const total = (typeof data !== 'undefined') ? data.length : 0;
        // Считаем размер вечного сета
        const uniqueExplored = permanentExplored.size;
        
        const displayEl = document.getElementById('ex-total-display');
        if (displayEl) {
            displayEl.innerText = `${uniqueExplored} / ${total}`;
        }
    }

    // 1. Открытие модального окна (Сетка)
    function openExploredModal() {
        const modal = document.getElementById('modal-explored-overlay');
        const grid = document.getElementById('explored-grid');
        const details = document.getElementById('explored-details');
        const title = document.getElementById('explored-modal-title');
        const subtitle = document.getElementById('explored-subtitle');
        const backBtn = document.getElementById('explored-back-btn');
        const body = document.getElementById('explored-modal-body');

        // Сброс состояния (показываем сетку, скрываем детали)
        grid.style.display = 'grid';
        details.style.display = 'none';
        body.classList.remove('show-details');
        backBtn.style.display = 'none';
        
        // Локализация заголовков
        const t = langData[currentLang] || langData['en'];
        title.innerText = t.explored_label || "Explored";
        subtitle.style.display = 'block'; // Показываем подзаголовок в сетке
        subtitle.innerText = t.explored_subtitle || "Here are the achievements you need to get 'Platinum' 😈";

        // Рендер Сетки
        grid.innerHTML = '';
        const exploredIds = permanentExplored; 

        // Подготовка данных (как и раньше)
        const groupsWithStats = EXPLORED_GROUPS.map(group => {
            const groupItems = data.filter(item => item.tags.some(tag => group.tags.includes(tag)));
            const totalCount = groupItems.length;
            if (totalCount === 0) return { ...group, percent: 0, count: 0, total: 0 };

            const exploredCount = groupItems.filter(item => exploredIds.has(item.id)).length;
            const percent = Math.round((exploredCount / totalCount) * 100);
            
            // Дата
            let dateStr = "";
            let dateTs = Infinity;
            if (percent === 100) {
                if (achievementDates[group.id]) {
                    dateStr = achievementDates[group.id];
                } else {
                    const now = new Date();
                    dateStr = now.toLocaleDateString();
                    achievementDates[group.id] = dateStr;
                    localStorage.setItem('xch_achievement_dates', JSON.stringify(achievementDates));
                }
                const parts = dateStr.split('.');
                dateTs = parts.length === 3 ? new Date(parts[2], parts[1]-1, parts[0]).getTime() : (Date.parse(dateStr) || Date.now());
            }

            return { ...group, percent, count: exploredCount, total: totalCount, dateStr, dateTs };
        });

        // Сортировка
        groupsWithStats.sort((a, b) => {
            if (a.id === 'general') return -1;
            if (b.id === 'general') return 1;
            const aDone = a.percent === 100;
            const bDone = b.percent === 100;
            if (aDone && !bDone) return -1;
            if (!aDone && bDone) return 1;
            if (aDone && bDone) return a.dateTs - b.dateTs;
            return b.percent - a.percent;
        });

        // Рендер карточек
        groupsWithStats.forEach(stats => {
            if (stats.total === 0) return;

            let iconSrc = 'logo_icon.png';
            if (TAG_ICONS[stats.iconTag] && TAG_ICONS[stats.iconTag][0]) iconSrc = TAG_ICONS[stats.iconTag][0];
            else if (TAG_ICONS['general']) iconSrc = TAG_ICONS['general'][0];

            const displayTitle = t['cat_' + stats.id] || stats.id.toUpperCase();
            const unlockedLabel = t.unlocked_on || "Unlocked:";
            const isCompleted = stats.percent === 100;

            const card = document.createElement('div');
            card.className = `ex-card ${isCompleted ? 'completed' : ''}`;
            
            card.innerHTML = `
                <img src="${iconSrc}" class="ex-card-icon" alt="${stats.id}">
                <div class="ex-card-title">${displayTitle}</div>
                <div class="ex-progress-track">
                    <div class="ex-progress-fill" style="width: ${stats.percent}%"></div>
                </div>
                <div class="ex-card-stats">${stats.count} / ${stats.total} (${stats.percent}%)</div>
                <div class="ex-date">${isCompleted ? `🏆 ${unlockedLabel} ${stats.dateStr}` : ''}</div>
            `;
            
            card.onclick = () => showGenreDetails(stats);

            grid.appendChild(card);
        });

        modal.classList.add('open');
    }

    // 2. Открытие детального просмотра (Внутри того же окна)
    function showGenreDetails(groupData) {
        // 1. Получение элементов
        const grid = document.getElementById('explored-grid');
        const details = document.getElementById('explored-details');
        const modalBody = document.getElementById('explored-modal-body');
        const title = document.getElementById('explored-modal-title');
        const subtitle = document.getElementById('explored-subtitle');
        const backBtn = document.getElementById('explored-back-btn');
        const mainCloseBtn = document.getElementById('explored-main-close'); 
        const t = langData[currentLang] || langData['en'];

        // 2. Переключение UI
        grid.style.display = 'none';
        subtitle.style.display = 'none';
        details.style.display = 'flex';
        modalBody.classList.add('show-details');
        
        // Показываем кнопку "Назад", скрываем "Закрыть"
        if (backBtn) backBtn.style.display = 'flex';
        if (mainCloseBtn) mainCloseBtn.style.display = 'none';

        // 3. Локализация слова "Открыто"
        const labelExplored = (currentLang === 'ru') ? "Открыто" : 
                            (currentLang === 'es') ? "Explorado" : 
                            (currentLang === 'de') ? "Erforscht" : "Explored";

        // 4. Данные
        title.innerText = t['cat_' + groupData.id] || groupData.id.toUpperCase();

        let iconSrc = 'logo_icon.png';
        if (TAG_ICONS[groupData.iconTag]) iconSrc = TAG_ICONS[groupData.iconTag][0];

        let desc = groupData.desc_en;
        if (currentLang === 'ru') desc = groupData.desc_ru;
        else if (currentLang === 'es') desc = groupData.desc_es;
        else if (currentLang === 'de') desc = groupData.desc_de;

        // Генерация примеров
        let potentialSamples = data.filter(item => item.tags.some(tag => groupData.tags.includes(tag)));
        if (potentialSamples.length > 3) {
            potentialSamples.sort(() => 0.5 - Math.random());
            potentialSamples = potentialSamples.slice(0, 3);
        }
        const samplesHtml = potentialSamples.map(item => `<div class="sample-tag">${getLocalizedName(item)}</div>`).join('');
        const includesLabel = t.lbl_includes || "Includes:";

        // Статусы
        const isUnlocked = groupData.percent === 100;
        const statusClass = isUnlocked ? "unlocked" : "";
        const achImg = groupData.achIcon || "ach_placeholder.png";
        const achHeader = t.ach_title || "Achievements";
        const badgeLabel = t.lbl_badge || "BADGE";
        const iconLabel = t.lbl_icon || "ICON";
        const badgeStyle = isUnlocked ? '' : 'filter: grayscale(1); opacity: 0.5;';
        const badgeOnClick = `onclick="closeExploredModal(null, true); openAchievementsModal(); showAchievementDetailByID('genre_${groupData.id}')"`;
        const iconOnClick = `onclick="closeExploredModal(null, true); openThemeModal()"`;


        let extraIconHtml = '';
        if (groupData.appIcon) {
            const appIconStyle = isUnlocked ? '' : 'filter: grayscale(1); opacity: 0.5;';
            extraIconHtml = `
                <div class="reward-box">
                    <img src="${groupData.appIcon}" class="reward-display-img app-icon-style" style="${appIconStyle}">
                    <div class="ach-status-text ${statusClass}" style="font-size:9px;">${iconLabel}</div>
                </div>
            `;
        }

        // Рендер
        details.innerHTML = `
            <div class="genre-header">
                <img src="${iconSrc}" class="genre-icon-large">
                <div style="width:100%; max-width:200px; margin-bottom:5px;">
                    <div class="ex-progress-track" style="height:8px; background:rgba(255,255,255,0.1);">
                        <div class="ex-progress-fill" style="width: ${groupData.percent}%; background:var(--accent);"></div>
                    </div>
                    <!-- ВОТ ЗДЕСЬ ИЗМЕНЕНО: Добавлено слово "Открыто" -->
                    <div style="text-align:center; font-size:10px; color:var(--text-secondary); margin-top:3px;">
                        ${labelExplored}: ${groupData.count} / ${groupData.total}
                    </div>
                </div>
            </div>

            <div class="genre-desc-box">${desc}</div>

            <div class="genre-samples-title">${includesLabel}</div>
            <div class="genre-samples-row">${samplesHtml}</div>

            <div class="genre-achievements-header">${achHeader}</div>
            
            <div class="genre-icons-row">
                <div class="reward-box" ${badgeOnClick} style="cursor:pointer;">
                    <img src="${achImg}" class="reward-display-img badge-style" style="${badgeStyle}">
                    <div class="ach-status-text ${statusClass}" style="font-size:9px;">${badgeLabel}</div>
                </div>
                ${groupData.appIcon ? `
                <div class="reward-box" ${iconOnClick} style="cursor:pointer;">
                    <img src="${groupData.appIcon}" class="reward-display-img app-icon-style" style="${isUnlocked ? '' : 'filter: grayscale(1); opacity: 0.5;'}">
                    <div class="ach-status-text ${statusClass}" style="font-size:9px;">${iconLabel}</div>
                </div>` : ''}
            </div>
            
            ${isUnlocked ? `<div style="text-align:center; font-size:10px; color:var(--text-secondary); margin-top:5px;">${groupData.dateStr}</div>` : ''}
        `;
    }

    window.showAchievementDetailByID = function(achID) {
        // 1. Собираем данные всех ачивок (логика как в openAchievementsModal)
        // Это позволит нам найти нужный объект ачивки по его ID
        const exploredIds = permanentExplored;
        const t = langData[currentLang] || langData['en'];
        
        // Ищем среди жанровых
        const group = EXPLORED_GROUPS.find(g => 'genre_' + g.id === achID);
        if (group) {
            const groupItems = data.filter(item => item.tags.some(tag => group.tags.includes(tag)));
            const count = groupItems.filter(item => exploredIds.has(item.id)).length;
            const percent = Math.round((count / groupItems.length) * 100);
            
            const achObj = {
                id: achID,
                title: t['cat_' + group.id] || group.id,
                icon: group.achIcon || 'ach_placeholder.png',
                desc: group['desc_' + currentLang] || group.desc_en,
                unlocked: percent === 100,
                date: achievementDates[group.id] || "",
                type: 'genre',
                stats: { count, total: groupItems.length, percent }
            };
            showAchievementDetail(achObj);
        }
    };

    // 3. Возврат к сетке
    function backToExploredGrid() {
        const grid = document.getElementById('explored-grid');
        const details = document.getElementById('explored-details');
        const modalBody = document.getElementById('explored-modal-body');
        const title = document.getElementById('explored-modal-title');
        const subtitle = document.getElementById('explored-subtitle');
        const backBtn = document.getElementById('explored-back-btn');
        if (mainCloseBtn) mainCloseBtn.style.display = 'flex';
        const t = langData[currentLang] || langData['en'];

        details.style.display = 'none';
        grid.style.display = 'grid';
        modalBody.classList.remove('show-details');
        backBtn.style.display = 'none';
        
        // Возвращаем исходный заголовок
        title.innerText = t.explored_label || "Explored";
        subtitle.style.display = 'block';
    }

    function closeExploredModal(e, force) {
        if (force || e.target.id === 'modal-explored-overlay') {
            document.getElementById('modal-explored-overlay').classList.remove('open');
        }
    }

    function openAchievementsModal() {
        closeSyncInfoModal(null, true);
        
        const grid = document.getElementById('achievements-grid');
        grid.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        const allAchievements = [];
        const exploredIds = permanentExplored;

        // 1. Только ЖАНРОВЫЕ ДОСТИЖЕНИЯ
        EXPLORED_GROUPS.forEach(group => {
            const groupItems = data.filter(item => item.tags.some(tag => group.tags.includes(tag)));
            const total = groupItems.length;
            if (total === 0) return;
            
            const count = groupItems.filter(item => exploredIds.has(item.id)).length;
            const percent = Math.round((count / total) * 100);
            const isUnlocked = percent === 100;
            
            let dateStr = "";
            if (isUnlocked && achievementDates[group.id]) dateStr = achievementDates[group.id];

            let name = t['cat_' + group.id] || group.id;
            let desc = group['desc_' + currentLang] || group.desc_en;

            allAchievements.push({
                id: 'genre_' + group.id,
                title: name,
                icon: group.achIcon || 'ach_placeholder.png',
                desc: desc,
                unlocked: isUnlocked,
                date: dateStr,
                type: 'genre',
                stats: { count, total, percent }
            });
        });

        // 2. СОРТИРОВКА (Открытые сверху)
        allAchievements.sort((a, b) => (b.unlocked - a.unlocked));

        // Обновляем общий счетчик 
        const unlockedCount = allAchievements.filter(x => x.unlocked).length;
        const progressEl = document.getElementById('ach-total-progress');
        if(progressEl) progressEl.innerText = `${unlockedCount} / ${allAchievements.length}`;

        // 3. РЕНДЕР
        allAchievements.forEach(ach => {
            const div = document.createElement('div');
            div.className = `ach-card ${ach.unlocked ? 'unlocked' : ''}`;
            div.onclick = () => showAchievementDetail(ach);
            
            div.innerHTML = `
                <img src="${ach.icon}" class="ach-card-icon" onerror="this.src='ach_placeholder.png'" style="width:50px; height:50px; margin-bottom:8px;">
                <div class="ach-card-title">${ach.title}</div>
            `;
            grid.appendChild(div);
        });

        document.getElementById('modal-achievements-overlay').classList.add('open');
    }

    function closeAchievementsModal(e, force) {
        if (force || e.target.id === 'modal-achievements-overlay') {
            document.getElementById('modal-achievements-overlay').classList.remove('open');
        }
    }

    let currentDetailAch = null; // Для шеринга

    function showAchievementDetail(ach) {
        currentDetailAch = ach; 
        
        const modalBody = document.querySelector('#modal-ach-detail-overlay .modal-body');
        const modalHeader = document.querySelector('#modal-ach-detail-overlay .modal-header');
        const shareBtn = document.getElementById('btn-ach-share');
        const t = langData[currentLang] || langData['en'];

        // 1. Кнопка Назад в шапке
        const backSpan = modalHeader.querySelector('span:first-child');
        if (backSpan) {
            backSpan.innerHTML = "←";
            backSpan.style.opacity = "1";
            backSpan.style.cursor = "pointer";
            backSpan.onclick = () => {
                closeAchDetail(null, true);
                openAchievementsModal();
            };
        }

        // 2. Очистка и установка Иконки
        const oldIcon = document.getElementById('detail-ach-icon');
        if (oldIcon) oldIcon.remove();
        
        const newIconEl = document.createElement('img');
        newIconEl.id = 'detail-ach-icon';
        newIconEl.src = ach.icon;
        newIconEl.style.cssText = 'width:120px; height:120px; object-fit:contain; margin-bottom:15px;';
        if (!ach.unlocked) newIconEl.style.filter = 'grayscale(1) opacity(0.3)';
        
        const titleEl = document.getElementById('detail-ach-title');
        modalBody.insertBefore(newIconEl, titleEl);

        // 3. Тексты
        titleEl.innerText = ach.title;
        document.getElementById('detail-ach-desc').innerText = ach.desc;
        
        const dateEl = document.getElementById('detail-ach-date');
        if (ach.unlocked) {
            dateEl.innerText = `${t.unlocked_on} ${ach.date}`;
            dateEl.style.display = 'block';
            if (shareBtn) shareBtn.style.display = 'block';
        } else {
            dateEl.innerText = `${t.status_locked} 🔒`;
            if (shareBtn) shareBtn.style.display = 'none';
        }

        // 4. Шкала прогресса
        const oldProgress = document.getElementById('ach-progress-container');
        if (oldProgress) oldProgress.remove();

        const progressContainer = document.createElement('div');
        progressContainer.id = 'ach-progress-container';
        progressContainer.style.width = "100%";
        progressContainer.style.textAlign = "left";

        progressContainer.innerHTML = `
            <div style="border-top:1px solid var(--border); padding-top:15px; margin-bottom:20px;">
                <div style="font-size:12px; font-weight:800; color:var(--text-secondary); text-transform:uppercase; margin-bottom:5px;">${t.ach_how_to}</div>
                <div style="font-size:13px; line-height:1.4; color:var(--text-main); opacity:0.8;">${t.ach_genre_hint}</div>
                
                <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-secondary); margin-bottom:5px; margin-top:15px;">
                    <span style="text-transform:uppercase; font-weight:700;">${t.ach_progress}</span>
                    <span>${ach.stats.count} / ${ach.stats.total} (${ach.stats.percent}%)</span>
                </div>
                <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden;">
                    <div style="width:${ach.stats.percent}%; height:100%; background:var(--accent); transition: width 0.5s ease;"></div>
                </div>
            </div>
        `;
        modalBody.insertBefore(progressContainer, shareBtn || modalBody.lastElementChild);

        document.getElementById('modal-ach-detail-overlay').classList.add('open');
    }

    function closeAchDetail(e, force) {
        if (force || e.target.id === 'modal-ach-detail-overlay') {
            document.getElementById('modal-ach-detail-overlay').classList.remove('open');
        }
    }

    // --- ШЕРИНГ ДОСТИЖЕНИЯ ---
    function shareAchievementCard() {
        if (!currentDetailAch) return;
        
        const container = document.createElement('div');
        container.id = 'achievement-share-card';
        document.body.appendChild(container);
        
        const t = langData[currentLang] || langData['en'];
        const themeId = localStorage.getItem('xch_theme_id') || 'dark';
        
        // Для скриншота логотип берем из функции (предполагаем она есть в коде)
        const logoSrc = typeof getThemeLogoSrc === 'function' ? getThemeLogoSrc(themeId) : 'logo.png';
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&data=${encodeURIComponent(window.location.origin)}`;

        // Логика визуализации (Изображение или Эмодзи)
        let iconHtml = '';
        if (currentDetailAch.type === 'genre') {
            iconHtml = `<img src="${currentDetailAch.icon}" class="share-ach-icon">`;
        } else {
            // Эмодзи для психотипа
            iconHtml = `<div style="font-size:100px; margin:20px 0; filter:drop-shadow(0 0 20px rgba(255,255,255,0.3));">${currentDetailAch.icon}</div>`;
        }

        container.innerHTML = `
            <div class="screenshot-header">
                <div class="screenshot-logo-area">
                    <div class="screenshot-logo">x<span>Fetish</span>Hub</div>
                    <div class="screenshot-caption">ACHIEVEMENT UNLOCKED</div>
                </div>
                <div class="screenshot-qr"><img src="${qrUrl}" style="width:100%;"></div>
            </div>
            
            ${iconHtml}
            
            <div class="share-ach-title">${currentDetailAch.title}</div>
            
            ${currentDetailAch.unlocked ? `<div class="share-ach-date">UNLOCKED: ${currentDetailAch.date}</div>` : ''}
            
            <div class="share-ach-desc">
                ${currentDetailAch.desc}
            </div>
        `;

        html2canvas(container, {
            backgroundColor: null,
            scale: 2,
            useCORS: true
        }).then(canvas => {
            document.body.removeChild(container);
            shareCanvasImage(canvas, `achievement-${Date.now()}.png`);
        });
    }

    function adjustTagScoresByTags(tags, delta) {
        if (!tags) return;
        
        // Time Decay
        for (let key in tagScores) {
            if (tagScores[key] > 0) tagScores[key] *= TAG_DECAY_RATE;
        }

        const ignore = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd', 'kinky', 'fetish'];
        
        tags.forEach(tag => {
            if (ignore.includes(tag)) return;

            if (!tagScores[tag]) tagScores[tag] = 0;
            
            // Добавляем вес
            tagScores[tag] += delta;

            // Кэппинг
            if (tagScores[tag] > 100) tagScores[tag] = 100;
            if (tagScores[tag] < -100) tagScores[tag] = -100;
        });

        localStorage.setItem(STORAGE.TAG_SCORES, JSON.stringify(tagScores));
    }

    function adjustTagScores(item, delta) {
        if (!item) return;
        const tags = getCombinedTags(item);
        adjustTagScoresByTags(tags, delta);
    }

    function calculateItemWeight(item) {
        // 1. Базовые проверки (ЧС и Кулдаун)
        if (blacklist.includes(item.id)) return 0;
        if (cooldownList.includes(item.id)) return 0.1;

        let score = 50; 
        
        // Определяем тип контента
        const isGeneral = item.tags.includes('general');
        const isSpecific = item.tags.includes('specific');

        // Считаем общее количество действий пользователя (лайки + дизлайки)
        const totalInteractions = favorites.length + blacklist.length;

        // === ЛОГИКА ВОРОНКИ ===

        if (isGeneral) {
            // Базовый буст для общих категорий
            score += 100; 

            // Если пользователь новичок (< 30 действий), сильно пушим General,
            // чтобы быстрее понять его вкусы
            if (totalInteractions < 30) {
                score += 200;
            }
        }

        // Считаем совпадения по тегам из истории
        let historyScore = 0;
        let knownTagsCount = 0;

        item.tags.forEach(tag => {
            // Игнорируем технические теги при подсчете очков
            if (['general', 'specific'].includes(tag)) return;

            if (tagScores[tag]) {
                historyScore += tagScores[tag];
                if (tagScores[tag] > 5) knownTagsCount++; // Тег, который пользователю точно нравится
            }
        });

        score += historyScore;

        // ЛОГИКА SPECIFIC:
        // Если это специфичный фетиш, но мы НЕ знаем, нравятся ли пользователю входящие в него теги,
        // мы занижаем вероятность. (Например, не показывать "Fisting", если мы не знаем, нравится ли "Anal")
        if (isSpecific) {
            if (knownTagsCount === 0) {
                // Если нет ни одного "любимого" тега внутри этого Specific -> штрафуем
                score -= 150;
            } else {
                // Если есть совпадения, Specific получает бонус, так как это точное попадание
                score += 50;
            }
        }

        // === РЕЖИМЫ ===
        if (currentAppMode === 'pleasure') {
            if (favorites.includes(item.id)) score += 1000;
            // В режиме удовольствия Specific ценится выше, если он совпадает со вкусами
            if (isSpecific && knownTagsCount > 0) score += 200; 
            score += (historyScore * 2); // Усиливаем влияние истории
        } 
        else if (currentAppMode === 'ai') {
            // Логика AI контекста 
            if (aiContextTokens.length > 0) {
                const itemString = [item.name, item.slug, ...item.tags].join(" ").toLowerCase();
                aiContextTokens.forEach(token => {
                    if (itemString.includes(token)) score += 500;
                });
            }
            if (favorites.includes(item.id)) score += 200;
            score += historyScore;
        }
        else {
            // Режим Explore (по умолчанию)
            if (favorites.includes(item.id)) score = 1; // Убираем уже лайкнутое
            score += Math.random() * 50; // Немного рандома
        }

        // === ОРИЕНТАЦИЯ ===
        if (currentOrientation === 'gay' && item.tags.includes('gay')) score += 100;
        if (currentOrientation === 'trans' && item.tags.some(t => ['trans', 'shemale', 'crossdresser'].includes(t))) score += 100;
        if (currentOrientation === 'lesbian' && item.tags.includes('lesbian')) score += 100;
        
        // Жесткий штраф за несовпадение ориентации
        if (currentOrientation === 'gay' && item.tags.includes('straight')) score -= 5000;
        if (currentOrientation === 'hetero' && (item.tags.includes('gay') || item.tags.includes('shemale'))) score -= 5000;

        return Math.max(1, score);
    }

    function getWeightedRandom(items) {
        // Шаг 1: Считаем веса
        let weightedItems = items.map(item => {
            return { item: item, weight: calculateItemWeight(item) };
        });

        // Шаг 2: Убираем совсем неподходящие (вес <= 1)
        // Но оставляем хотя бы что-то, если все отфильтровались
        let candidates = weightedItems.filter(i => i.weight > 1);
        if (candidates.length === 0) candidates = weightedItems;

        // Шаг 3: Exploration vs Exploitation (Исследование или Использование)
        // С шансом 20% мы игнорируем веса и берем случайное из топа 50% (чтобы подкинуть новое)
        const isExploration = Math.random() < 0.2; 

        if (isExploration && candidates.length > 5) {
            // Берем случайный из первой половины списка (но не обязательно лучший)
            // Сортируем по весу
            candidates.sort((a, b) => b.weight - a.weight);
            // Отрезаем топ 50%
            const sliceIndex = Math.floor(candidates.length / 2);
            const pool = candidates.slice(0, sliceIndex);
            return pool[Math.floor(Math.random() * pool.length)].item;
        }

        // Шаг 4: Классическая рулетка (Exploitation)
        let totalWeight = candidates.reduce((sum, i) => sum + i.weight, 0);
        let random = Math.random() * totalWeight;
        
        for (const candidate of candidates) {
            if (random < candidate.weight) return candidate.item;
            random -= candidate.weight;
        }

        return candidates[0].item;
    }

    function resetControls() {
        document.querySelector('.gen-controls').classList.remove('visually-hidden');
        document.getElementById('mods-block').classList.remove('visually-hidden');
        document.getElementById('card-block').classList.remove('is-spinning');
    }

    function getExplanationText(mode) {
        const t = langData[currentLang];
        let reason = null;

        if (mode === 'panic') {
            // Берем нейтральные фразы
            const phrases = t.panic_active_phrases || ["Nothing to see here 😇"];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }

        // 1. Напоминание посмотреть/повторить/одуматься
        else if (mode === 'wl_reminder') {
            const phrases = wlReminderPhrases[currentLang] || wlReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        else if (mode === 'fav_reminder') {
            const phrases = favReminderPhrases[currentLang] || favReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        else if (mode === 'ban_reminder') {
            const phrases = banReminderPhrases[currentLang] || banReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        // 2. Возврат (Кнопка Undo)
        else if (mode === 'undo') {
            reason = t.expl_undo; 
        }
        // 3. История (Клик из списка)
        else if (mode === 'history') {
            reason = t.expl_hist;
        }
        // 4. Похожее (Кнопка Similar)
        else if (mode === 'similar') {
            reason = t.expl_sim;
        } 
        // 5. Клик по тегу (В каталоге)
        else if (mode === 'tag_click') {
            reason = t.expl_tag_click; 
        } 
        // 6. Обычная генерация (Smart / Random)
        else {
            // === УМНЫЙ ПОИСК ПРИЧИНЫ ===
            let bestTag = null;
            let maxScore = 0;
            
            const ignoreTags = ['universal', 'straight', 'gay', 'lesbian', 'trans', 'bi', 'male', 'female'];
            
            currentItem.tags.forEach(tag => {
                if (!ignoreTags.includes(tag) && tagScores[tag] && tagScores[tag] > 5) {
                    if (tagScores[tag] > maxScore) {
                        maxScore = tagScores[tag];
                        bestTag = tag;
                    }
                }
            });
            
            if (bestTag) {
                // Ищем В ИСТОРИИ или ЛАЙКАХ предмет с этим тегом
                let sourceItem = null;
                if (favorites.length > 0) {
                    const favItem = favorites.map(id => data.find(x => x.id === id)).find(item => item && item.tags.includes(bestTag));
                    if (favItem) sourceItem = favItem;
                }
                
                if (!sourceItem && historyData.length > 0) {
                    const histItem = historyData.map(h => data.find(x => x.id === h.id)).find(item => item && item.id !== currentItem.id && item.tags.includes(bestTag));
                    if (histItem) sourceItem = histItem;
                }

                if (sourceItem) {
                    const reasonName = getLocalizedName(sourceItem);
                    reason = t.expl_score + reasonName; 
                } else {
                    let displayTag = bestTag.charAt(0).toUpperCase() + bestTag.slice(1);
                    reason = t.expl_score + displayTag; 
                }
            }
            else if (favorites.includes(currentItem.id)) {
                reason = t.expl_fav; // "Потому что ты любишь это"
            }
        }
        return reason;
    }

    function prepareElementsForFadeIn() {
        // Убрали старые ID, добавили status-text
        const ids = ['result-desc', 'status-text', 'related-block']; 
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('fade-visible');
                el.classList.add('fade-hidden');
            }
        });
    }

    function finishGeneration(item, mode) {
        isGenerating = false;

        // Проверяем текущую настройку
        const currentPlatformPref = document.getElementById('platform') ? document.getElementById('platform').value : 'xh';
        
        // Если стоит "Random" и у предмета еще нет закрепленного сайта
        if (currentPlatformPref === 'random' && !item.assignedPlatform) {
            const sites = ['xh', 'ph', 'xv', 'sb', 'yp', 'rt'];
            item.assignedPlatform = sites[Math.floor(Math.random() * sites.length)];
        }
        
        if (isPanicMode || mode === 'panic') {
            const card = document.getElementById('card-block');
            if(card) card.classList.add('has-results');
            updateCardStatusVisuals(); 
            renderResultUI(item, mode);
            return;
        }

        addToHistory(item); 

        cooldownList.push(item.id);
        if (cooldownList.length > COOLDOWN_SIZE) {
            cooldownList.shift();
        }

        logActivity('gen', item.id, item.tags);
        
        const card = document.getElementById('card-block');
        if(card) {
            card.classList.add('has-results');
        }

        renderResultUI(item, mode);
    }

    function forceShowResult(item, mode = 'history', customStatus = null) {
    if (mode !== 'ai_request') {
        activeMods.clear();
        
        if (currentOrientation === 'gay') activeMods.add('Gay');
        else if (currentOrientation === 'trans') activeMods.add('Trans');
    } 
        isGenerating = false;
        
        // 1. ОТКЛЮЧАЕМ СТАРТОВЫЙ РЕЖИМ
        isFirstGen = false; 
        hasInteractedWithCurrent = false; 
        hasWatchedCurrentItem = false; 
        // Важно: отключаем режим выбора, чтобы свайпы работали как Лайк/Дизлайк
        isModeSelectionActive = false; 

        // === ОЧИСТКА НАЧАЛЬНОГО ЭКРАНА ===
        const startOverlay = document.getElementById('mode-start-overlay');
        const assistantUI = document.getElementById('assistant-ui');
        const thinkingUI = document.getElementById('thinking-ui');
        const startBtn = document.getElementById('start-btn-container');

        // Жестко скрываем оверлей с треугольником
        if (startOverlay) {
            startOverlay.classList.add('hidden');
            startOverlay.style.display = 'none'; // Принудительно
            startOverlay.style.opacity = '0';
            startOverlay.style.pointerEvents = 'none';
        }
        
        // Скрываем UI ассистента и думания (на случай если остались)
        if (assistantUI) assistantUI.classList.remove('visible');
        if (thinkingUI) thinkingUI.style.display = 'none';

        // Скрываем старую кнопку "Поехали"
        if (startBtn) {
            startBtn.classList.add('hidden-initial');
            startBtn.style.display = 'none';
        }
        // ========================================================

        // 2. СБРОС СЛОТ-МАШИНЫ (Убираем бегущую строку Idle)
        const reel = document.getElementById('slot-reel');
        if (reel) {
            reel.className = 'slot-reel'; // Убираем класс 'idle'
            reel.style.transform = '';    // Сбрасываем позицию
            reel.innerHTML = '';          // Очищаем старый текст
        }

        // 3. АНИМАЦИЯ ПОЯВЛЕНИЯ КАРТОЧКИ
        const wrapper = document.getElementById('card-anim-wrapper');
        if(wrapper) {
            wrapper.style.transform = '';
            wrapper.style.opacity = '1';
            
            // Если это не прямой ввод (а например из истории), делаем анимацию
            if (mode !== 'ai_request') {
                wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
                void wrapper.offsetWidth; // Триггер перерисовки
                wrapper.classList.add('anim-fly-left');
            }
        }

        // 4. СКРОЛЛ НАВЕРХ
        const mainContent = document.querySelector('.main-content') || document.querySelector('.tab-content.active');
        if(mainContent) mainContent.scrollTop = 0;
        
        // Логика истории
        addToHistory(item);
        logActivity('gen', item.id, item.tags);

        // 5. РЕНДЕР
        renderResultUI(item, mode, customStatus);
        
        // Снимаем класс анимации через секунду
        setTimeout(() => {
            if(wrapper) wrapper.classList.remove('anim-fly-left');
        }, 800);
    }

    function renderBadges() {
        const badgeWrapper = document.getElementById('badge-wrapper');
        badgeWrapper.innerHTML = '';
        const t = langData[currentLang];
        
        const safetyTags = ['straight', 'universal', 'vanilla'];
        const isSafe = currentItem.tags.some(t => safetyTags.includes(t));
        const isExtreme = currentItem.tags.some(t => EXTREME_TAGS.includes(t));
        const isBDSM = currentItem.tags.includes('bdsm') || currentItem.tags.includes('bondage');
        const hasLgbtTag = currentItem.tags.some(t => ['gay','trans','shemale','lesbian', 'bi'].includes(t));
        const showLgbt = hasLgbtTag && !isSafe;
        const isNiche = currentItem.tags.includes('fetish') || currentItem.tags.includes('scat');

        // Функция для создания HTML бейджа с тултипом
        const createBadge = (className, label, desc) => {
            return `
                <div class="warning-badge ${className}" style="position:relative; overflow:visible; cursor:help;">
                    ${label}
                    <div class="badge-tooltip">${desc}</div>
                </div>
            `;
        };

        // Логика добавления бейджей (теперь с тултипами внутри)
        // Добавляем класс 'has-tooltip' для обработки кликов на мобильных (опционально через CSS :hover)
        
        if(isExtreme) { 
            badgeWrapper.innerHTML += createBadge('badge-extreme', t.badge_extreme, t.badge_desc_extreme);
        }
        else if(isBDSM) { 
            badgeWrapper.innerHTML += createBadge('', t.badge_bdsm, t.badge_desc_bdsm); // Default dark style
            // Добавим стиль для BDSM если его нет в CSS
            badgeWrapper.lastElementChild.style.background = "#333";
        }
        else if(showLgbt) { 
            badgeWrapper.innerHTML += createBadge('badge-lgbt', t.badge_lgbt, t.badge_desc_lgbt);
        }
        else if(isNiche) {
            badgeWrapper.innerHTML += createBadge('badge-niche', t.badge_niche, t.badge_desc_niche);
        }
    }

    function renderExplanation(mode) {
        const explText = document.getElementById('explanation-text');
        const t = langData[currentLang];
        let reason = "";

        if (mode === 'similar') {
            reason = t.expl_sim;
        } else if (mode === 'tag_click') {
            reason = t.expl_tag_click; 
        } else {
            let bestTag = null;
            let maxScore = 0;
            currentItem.tags.forEach(tag => {
                if (tagScores[tag] && tagScores[tag] > 5) {
                    if (tagScores[tag] > maxScore) {
                        maxScore = tagScores[tag];
                        bestTag = tag;
                    }
                }
            });
            if (bestTag) reason = t.expl_score + bestTag;
            else if (favorites.includes(currentItem.id)) reason = t.expl_fav;
        }
        explText.innerText = reason;
    }

    function renderRelatedItems() {
        const relatedEl = document.getElementById('related-tags');
        const relatedBlock = document.getElementById('related-block');
        const btnSimilar = document.getElementById('btn-similar');
        
        relatedEl.innerHTML = '';

        if (isPanicMode) {
            // Если мы в панике, берем теги из текущего безопасного задания
            if (currentItem && currentItem.tags) {
                currentItem.tags.forEach(tag => {
                    const btn = document.createElement('div');
                    btn.className = 'related-item-btn';
                    btn.innerText = tag;
                    // Клик генерирует новую БЕЗОПАСНУЮ карточку
                    btn.onclick = () => generatePanicCard('next');
                    relatedEl.appendChild(btn);
                });
            }
            
            // Показываем блок
            relatedBlock.classList.remove('hidden-initial');
            relatedBlock.classList.add('fade-visible');
            
            // Скрываем кнопку "Похожее" из нижней панели (если она там есть), 
            // так как в панике мы используем только теги
            if(btnSimilar) btnSimilar.style.display = 'none';
            
            return;
        }
        
        // 1. Хелпер для токенов (слов)
        const getTokens = (text) => {
            if (!text) return [];
            const stopWords = [
                'the', 'and', 'or', 'of', 'in', 'on', 'at', 'to', 'a', 'an', 'is', 'are', 
                'for', 'with', 'by', 'from', 'using', 'being', 'getting', 'into', 'over', 'sex',
                'video', 'movie', 'porn', 'compilation'
            ];
            return text.toLowerCase()
                      .split(/[\s/\-(),.]+/g)
                      .filter(w => w.length > 2 && !stopWords.includes(w));
        };

        const currentTokens = new Set([
            ...getTokens(currentItem.name),
            ...getTokens(currentItem.desc_en)
        ]);

        // 2. Определение пола текущего предмета (Гендерный щит)
        const maleTags = ['gay', 'male', 'man', 'boy', 'bear', 'twink', 'jock', 'dick', 'cock', 'father', 'grandpa'];
        const femaleTags = ['female', 'woman', 'girl', 'lesbian', 'milf', 'mom', 'sister', 'pussy', 'tits', 'boobs', 'vagina'];
        
        const isCurrentMale = currentItem.tags.some(t => maleTags.includes(t));
        const isCurrentFemale = currentItem.tags.some(t => femaleTags.includes(t));

        let candidates = data.map(item => {
            if (item.id === currentItem.id) return null;

            // === БАЗОВЫЕ ФИЛЬТРЫ (Как и раньше) ===
            if (currentIntensity === 1) { 
                if (item.tags.some(t => EXTREME_TAGS.includes(t) || SPICY_TAGS.includes(t))) return null;
            } else if (currentIntensity === 2) { 
                if (item.tags.some(t => EXTREME_TAGS.includes(t))) return null;
            }

            // === ФИЛЬТР ОРИЕНТАЦИИ ДЛЯ ПОХОЖИХ ===
            // Если мы в режиме Гей, не показываем Лесби/Гетеро в похожих, даже если теги совпадают
            const itemIsGay = item.tags.includes('gay');
            const itemIsStraight = item.tags.includes('straight');
            const itemIsLesbian = item.tags.includes('lesbian');
            
            if (currentOrientation === 'gay' && !itemIsGay) return null;
            if (currentOrientation === 'hetero' && itemIsGay) return null;

            // === ГЕНДЕРНЫЙ ЩИТ (Gender Guard) ===
            // Если текущий предмет МУЖСКОЙ (напр. Bear), штрафуем ЖЕНСКИЕ (напр. SSBBW), даже если у них общий тег "Fat"
            const itemIsMale = item.tags.some(t => maleTags.includes(t));
            const itemIsFemale = item.tags.some(t => femaleTags.includes(t));

            if (isCurrentMale && !isCurrentFemale && itemIsFemale) return null; // Ищем мужское, убираем женское
            if (isCurrentFemale && !isCurrentMale && itemIsMale) return null; // Ищем женское, убираем мужское

            // === ПОДСЧЕТ ОЧКОВ ===
            let score = 0;

            // А. Текст (вес: 5)
            const candidateTokens = [...getTokens(item.name), ...getTokens(item.desc_en)];
            let textMatches = 0;
            candidateTokens.forEach(token => {
                if (currentTokens.has(token)) textMatches++;
            });
            score += textMatches * 5;

            // Б. Теги (Вес: 10 за редкие, 0 за мусорные)
            const trashTags = [
                'general', 'specific',
                'universal', 'straight', 'gay', 'lesbian', 'bi', 'male', 'female', 'adult', 
                'roleplay', 'video', 'hd', 'soft', 'hardcore', 'fetish', 'kinky', 'fantasy',
                'body-part', 'action', 'hair'
            ];

            item.tags.forEach(tag => {
                if (currentItem.tags.includes(tag)) {
                    if (!trashTags.includes(tag)) {
                        score += 15; // Увеличили вес совпадения специфичных тегов
                    }
                }
            });

            // Если очков мало - это случайное совпадение, убираем
            if (score < 5) return null;

            return { item: item, score: score };
        }).filter(x => x !== null);

        candidates.sort((a, b) => b.score - a.score);
        const topCandidates = candidates.slice(0, 5);

        if (topCandidates.length > 0) {
            topCandidates.forEach(cand => {
                const item = cand.item;
                const name = getLocalizedName(item);
                const btn = document.createElement('div');
                btn.className = 'related-item-btn';
                btn.innerText = name;
                
                btn.onclick = () => {
                    // Сначала проверяем лимит
                    if (checkGenerationLimit()) {
                        // Если ок — открываем
                        forceShowResult(item, 'similar');
                    }
                };
                
                relatedEl.appendChild(btn);
            });
            relatedBlock.classList.remove('hidden-initial');
            relatedBlock.classList.add('fade-visible');
            if(btnSimilar) {
                btnSimilar.classList.remove('hidden-initial');
                btnSimilar.style.display = 'flex';
            }
        } else {
            relatedBlock.classList.add('hidden-initial'); 
            if(btnSimilar) btnSimilar.style.display = 'none'; 
        }
    }

    function savePlatform(val) {
        // Сохраняем локально
        localStorage.setItem('xch_platform', val);
        
        // Обновляем цвета и ссылку (твоя старая функция)
        updateLink(); 
    }

    function getCombinedTags(item) {
        if (!item || !item.tags) return [];
        
        // Берем теги жанра
        const combined = [...item.tags];
        
        // Добавляем активные модификаторы (приводим к нижнему регистру)
        activeMods.forEach(modKey => {
            const tag = modKey.toLowerCase();
            if (!combined.includes(tag)) {
                combined.push(tag);
            }
        });
        
        return combined;
    }

    function handleOutboundClick(e) {
        if (isPanicMode) {
            if(e) e.preventDefault();
            togglePanicMode();
            return;
        }

        // Проверяем, показывали ли мы предупреждение раньше
        const hasWarned = localStorage.getItem('xch_vpn_warned');
        
        if (!hasWarned) {
            if (e) e.preventDefault(); // Останавливаем переход
            
            // Получаем ссылку, куда юзер хотел пойти
            const btn = document.getElementById('btn-t-watch');
            pendingOutboundUrl = btn ? btn.href : '#';
            
            openVpnModal(); // Открываем модалку
            return; // Прерываем выполнение, пока юзер не нажмет кнопку в модалке
        }

        if(!currentItem) return;
        
        watchStartTime = Date.now();
        itemBeingWatched = currentItem;

        if(!hasWatchedCurrentItem) {
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, 3); 
            logActivity('watch', currentItem.id, fullTags);
            hasWatchedCurrentItem = true;
            hasInteractedWithCurrent = true;
        }
    }

    function openVpnModal() {
        const modal = document.getElementById('modal-vpn-overlay');
        const pwaText = document.getElementById('vpn-pwa-text');
        const btn = document.getElementById('btn-vpn-go');

        // Проверка PWA и Мобильного устройства
        const isMobile = window.innerWidth < 768;
        const isPWA = (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);

        // Показываем текст про перезапуск видео ТОЛЬКО если это PWA на мобильном
        if (isMobile && isPWA) {
            pwaText.style.display = 'block';
        } else {
            pwaText.style.display = 'none';
        }

        // Навешиваем событие на кнопку "Пошли"
        btn.onclick = () => {
            // 1. Запоминаем, что предупреждение показано
            localStorage.setItem('xch_vpn_warned', 'true');
            
            // 2. Закрываем окно
            modal.classList.remove('open');
            
            // 3. Открываем ссылку
            if (pendingOutboundUrl && pendingOutboundUrl !== '#') {
                window.open(pendingOutboundUrl, '_blank');
                
                handleOutboundClick(null); 
            }
        };

        modal.classList.add('open');
    }

    function addToHistory(item) {
        const entry = { id: item.id, timestamp: Date.now() };
        historyData = historyData.filter(x => x.id !== item.id);
        historyData.unshift(entry);
        if(historyData.length > 30) historyData.pop();
        localStorage.setItem(STORAGE.HISTORY, JSON.stringify(historyData));
        renderHistory();
        updateExploredCount();
        if (window.markDirty) window.markDirty();
    }
    
    function getLocalizedName(item) {
        if (!item) return "";
        if (currentLang === 'ru' && item.name_ru) return item.name_ru;
        if (currentLang === 'es' && item.name_es) return item.name_es;
        if (currentLang === 'de' && item.name_de) return item.name_de;
        return item.name; // По умолчанию английский
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (historyData.length === 0) {
            list.innerHTML = `<div class="ios-row" style="justify-content:center; color:var(--text-secondary); font-size:14px;">${t.hist_empty}</div>`;
            return;
        }

        historyData.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;
            const div = document.createElement('div');
            div.className = 'history-item-ios'; 
            
            const name = getLocalizedName(item);
            
            div.innerHTML = `<span>${name}</span><span style="color:var(--accent); font-size:18px;">↺</span>`;
            div.onclick = () => { switchTab('home'); forceShowResult(item, 'history'); };
            list.appendChild(div);
        });
    }

    function filterData() {
        // Обновленный список безопасных тегов
        const SAFETY_NET = ['straight', 'general', 'vanilla']; 
        const recentIds = historyData.slice(0, 50).map(entry => entry.id);

        let candidates = data.filter(item => {
            // 1. Черный список и История (без изменений)
            if (blacklist.includes(item.id)) return false;
            if (recentIds.includes(item.id)) return false;

            // 2. Интенсивность (без изменений)
            if (currentIntensity === 1) {
                if (item.tags.some(t => EXTREME_TAGS.includes(t) || SPICY_TAGS.includes(t))) return false;
            }
            if (currentIntensity === 2) {
                if (item.tags.some(t => EXTREME_TAGS.includes(t))) return false;
            }

            // 3. Ориентация (без изменений)
            const isGay = item.tags.includes('gay');
            const isTrans = item.tags.some(t => ['trans', 'shemale', 'futanari', 'crossdresser'].includes(t));
            const isLesbian = item.tags.includes('lesbian');
            const isStraight = item.tags.includes('straight');
            const isBi = item.tags.includes('bi');
            
            const isLgbtForHetero = isGay || isTrans || isBi; 

            if (currentOrientation === 'hetero') {
                if (isLgbtForHetero && !isLesbian) return false;
            }
            else if (currentOrientation === 'gay') {
                if (isStraight && !isGay) return false;
            }
            else if (currentOrientation === 'trans') {
                if (isStraight && !isTrans) return false;
            }

            return true;
        });

        // Fallback: Если фильтры слишком жесткие, возвращаем хотя бы General контент
        if (candidates.length < 3) {
            candidates = data.filter(item => 
                !blacklist.includes(item.id) && 
                item.tags.includes('general') // Показываем только General в случае нехватки
            );
        }
        
        return candidates;
    }

    function renderResultName() {
        if (!currentItem) return;
        
        // 1. Получаем базовое название (на нужном языке)
        const displayName = getLocalizedName(currentItem);
        
        // 2. Формируем HTML для модификаторов (точно так же, как при генерации результата)
        let modifiersHtml = "";
        
        if (activeMods.size > 0) {
            // Проходим по активным модам и ищем их перевод
            const modNames = Array.from(activeMods).map(key => {
                const m = modifiersData.find(x => x.key === key);
                if (m) {
                    if (currentLang === 'ru') return m.ru;
                    if (currentLang === 'es') return m.es;
                    if (currentLang === 'de') return m.de;
                    return m.en;
                }
                return key;
            });
            
            // Собираем строку: + POV + Hardcore
            if (modNames.length > 0) {
                // Важно: span с opacity создает эффект "второстепенного" текста
                modifiersHtml = ` <span style="color:var(--accent); font-weight:300; opacity:0.9;">+ ${modNames.join(" + ")}</span>`;
            }
        }

        // 3. Обновляем элемент на странице
        const titleEl = document.getElementById('result-text');
        if (titleEl) {
            // Используем innerHTML, чтобы отобразился цветной span, а не просто текст тегов
            titleEl.innerHTML = `${displayName}${modifiersHtml}`;
        }
        
        // 4. Обновляем описание (на всякий случай, если язык менялся)
        let desc = currentItem.desc_en;
        if (currentLang === 'ru' && currentItem.desc_ru) desc = currentItem.desc_ru;
        else if (currentLang === 'es' && currentItem.desc_es) desc = currentItem.desc_es;
        else if (currentLang === 'de' && currentItem.desc_de) desc = currentItem.desc_de;

        const descEl = document.getElementById('result-desc');
        if (descEl) descEl.innerText = desc || "";
    }

    function openSitesModal() {
        renderSitesList();
        
        const isSmart = localStorage.getItem('xch_smart_sites') === 'true';
        const isRandom = localStorage.getItem('xch_random_sites') === 'true';
        
        document.getElementById('smart-site-toggle').checked = isSmart;
        document.getElementById('random-site-toggle').checked = isRandom;

        document.getElementById('modal-sites-overlay').classList.add('open');
    }

    function closeSitesModal(e, force) {
        if (force || e.target.id === 'modal-sites-overlay') {
            document.getElementById('modal-sites-overlay').classList.remove('open');
        }
    }

    // 2. РЕНДЕР СПИСКА
    function renderSitesList() {
        const container = document.getElementById('sites-list-container');
        container.innerHTML = '';
        
        const currentSiteId = localStorage.getItem('xch_platform') || 'xh';
        const lang = ['en','ru','es','de'].includes(currentLang) ? currentLang : 'en';

        SITES_DATA.forEach(site => {
            const isSelected = (site.id === currentSiteId);
            const desc = site.desc[lang] || site.desc.en;

            const div = document.createElement('div');
            div.className = `site-card ${isSelected ? 'selected' : ''}`;
            div.onclick = () => selectGlobalSite(site.id);

            div.innerHTML = `
                <div class="site-info">
                    <div class="site-name">${site.name}</div>
                    <div class="site-desc">${desc}</div>
                </div>
                <div class="site-check">✓</div>
            `;
            container.appendChild(div);
        });
    }

    // 3. ВЫБОР САЙТА (Глобально)
    function selectGlobalSite(id) {
        localStorage.setItem('xch_platform', id);
        
        // Если выбрали конкретный сайт — выключаем автоматику
        localStorage.setItem('xch_smart_sites', 'false');
        localStorage.setItem('xch_random_sites', 'false');
        
        // Визуально обновляем переключатели, если окно открыто
        const smToggle = document.getElementById('smart-site-toggle');
        const rndToggle = document.getElementById('random-site-toggle');
        if(smToggle) smToggle.checked = false;
        if(rndToggle) rndToggle.checked = false;

        renderSitesList(); 
        updateSiteLabelUI();
        updateLink(); 
        
        if(navigator.vibrate) navigator.vibrate(10);
        setTimeout(() => {
            document.getElementById('modal-sites-overlay').classList.remove('open');
        }, 200);
    }

    // 4. ПЕРЕКЛЮЧЕНИЕ РЕЖИМОВ ДЛЯ САЙТОВ
    function toggleSmartSites(enabled) {
        localStorage.setItem('xch_smart_sites', enabled);
        if (enabled) {
            localStorage.setItem('xch_random_sites', 'false');
            document.getElementById('random-site-toggle').checked = false;
        }
        updateSiteLabelUI();
        updateLink();
    }

    function toggleRandomSites(enabled) {
        localStorage.setItem('xch_random_sites', enabled);
        if (enabled) {
            localStorage.setItem('xch_smart_sites', 'false');
            document.getElementById('smart-site-toggle').checked = false;
        }
        updateSiteLabelUI();
        updateLink();
    }

    // 5. ОБНОВЛЕНИЕ ТЕКСТА В НАСТРОЙКАХ
    function updateSiteLabelUI() {
        const label = document.getElementById('current-site-label');
        if (!label) return;

        const currentId = localStorage.getItem('xch_platform') || 'xh';
        const isSmart = localStorage.getItem('xch_smart_sites') === 'true';
        const isRandom = localStorage.getItem('xch_random_sites') === 'true';
        
        const siteObj = SITES_DATA.find(s => s.id === currentId);
        let text = siteObj ? siteObj.name : 'xHamster';

        if (isSmart) {
            text = `🧠 Smart / ${text}`; // Показываем Smart + (Fallback сайт)
        } else if (isRandom) {
            text = `🎲 Random`;
        }

        label.innerText = text;
    }

    function updateLink() {
        const btnWatch = document.getElementById('btn-t-watch');
        if (isPanicMode) {
            if(btnWatch) { btnWatch.removeAttribute('href'); btnWatch.removeAttribute('target'); }
            return;
        }

        if(!currentItem) return;

        // 1. Получаем настройки
        const userSiteId = localStorage.getItem('xch_platform') || 'xh';
        const isSmart = localStorage.getItem('xch_smart_sites') === 'true';
        const isRandom = localStorage.getItem('xch_random_sites') === 'true';
        const forceEn = document.getElementById('force-en') ? document.getElementById('force-en').checked : false;
        
        let targetSiteId = userSiteId;

        // 2. ПРИОРИТЕТ 1: RANDOM MODE
        if (isRandom) {
            // Выбираем случайный сайт из списка SITES_DATA
            const randomSite = SITES_DATA[Math.floor(Math.random() * SITES_DATA.length)];
            targetSiteId = randomSite.id;
        }
        // 3. ПРИОРИТЕТ 2: SMART MODE
        else if (isSmart) {
            const itemTags = currentItem.tags;
            const matches = (tags) => itemTags.some(t => tags.includes(t));

            if (matches(['jav'])) targetSiteId = 'miss'; 
            else if (matches(['hentai', 'anime', 'cartoon'])) targetSiteId = 'hh'; 
            else if (matches(['rule34', '3d', 'sfm', 'overwatch'])) targetSiteId = 'r34';
            else if (matches(['extreme', 'scat', 'piss', 'vomit', 'fetish'])) targetSiteId = 'mom'; 
            else if (matches(['pics', 'albums'])) targetSiteId = 'ero';
            else if (matches(['amateur', 'homemade', 'real']) && userSiteId !== 'xv') targetSiteId = 'xh';
            else if (matches(['hd', '4k']) && userSiteId !== 'epo') targetSiteId = 'sb';
        }

        // 4. Получаем объект сайта
        const targetSite = SITES_DATA.find(s => s.id === targetSiteId) || SITES_DATA[0];

        // 5. Формируем запрос
        const useRu = (currentLang === 'ru' && !forceEn);
        let queryName = useRu ? (currentItem.name_ru || currentItem.name) : currentItem.name;
        
        let queryParts = [queryName];
        
        if (typeof activeMods !== 'undefined') {
            activeMods.forEach(key => {
                const mod = modifiersData.find(m => m.key === key);
                if (mod) queryParts.push(useRu ? mod.ru : mod.en);
                else queryParts.push(key);
            });
        }

        const sep = targetSite.sep || '+';
        const q = queryParts.join(sep).toLowerCase();
        
        const finalUrl = targetSite.url.replace('{q}', q);

        if(btnWatch) {
            btnWatch.href = finalUrl;
            btnWatch.target = "_blank";
        }
    }

    function saveLists() {
        localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
        localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
    }

    function updateCounts() { 
        document.getElementById('count-fav').innerText = favorites.length; 
        
        const banBadge = document.getElementById('count-ban');
        if(banBadge) banBadge.innerText = blacklist.length;
        
        const wlBadge = document.getElementById('count-wl');
        if(wlBadge) wlBadge.innerText = watchLater.length;
        
        updateExploredCount(); // Вызов соседней функции
    }

    function exportData() {
        const exportObj = {
            // Добавляем activityLog в экспорт
            activityLog: activityLog, 
            blacklist, 
            favorites, 
            tagScores, 
            history: historyData,
            settings: { 
                lang: currentLang, 
                theme: localStorage.getItem(STORAGE.THEME), 
                intensity: currentIntensity,
                platform: localStorage.getItem('xch_platform') || 'xh',
            sub: subscriptionLevel
            }
        };
        // Используем clipboard API для удобства, если поддерживается, или prompt
        const dataStr = JSON.stringify(exportObj);
        
        try {
            navigator.clipboard.writeText(dataStr).then(() => {
                alert("Data copied to clipboard!");
            }).catch(() => {
                prompt("Copy this data:", dataStr);
            });
        } catch (e) {
            prompt("Copy this data:", dataStr);
        }
    }

    function importData() {
        const str = prompt("Paste data here:");
        if(!str) return;
        try {
            const obj = JSON.parse(str);
            
            // Восстанавливаем все поля
            if(obj.blacklist) blacklist = obj.blacklist;
            if(obj.favorites) favorites = obj.favorites;
            if(obj.tagScores) tagScores = obj.tagScores;
            if(obj.history) historyData = obj.history;
            if(obj.activityLog) activityLog = obj.activityLog; // Восстанавливаем лог
            
            // Настройки
            if(obj.settings) {
                if (obj.settings.intensity) currentIntensity = obj.settings.intensity;
                if (obj.settings.platform) localStorage.setItem('xch_platform', obj.settings.platform);
                if (obj.settings.lang) localStorage.setItem(STORAGE.LANG, obj.settings.lang);
            }

            if (obj.settings && obj.settings.sub) {
                localStorage.setItem('xch_sub_level', obj.settings.sub);
                subscriptionLevel = obj.settings.sub;
            }
            
            // Сохраняем в память браузера
            saveLists();
            localStorage.setItem(STORAGE.TAG_SCORES, JSON.stringify(tagScores));
            localStorage.setItem(STORAGE.HISTORY, JSON.stringify(historyData));
            localStorage.setItem(STORAGE.ACTIVITY_LOG, JSON.stringify(activityLog)); // Сохраняем лог
            localStorage.setItem(STORAGE.INTENSITY, currentIntensity);
            
            alert("Import successful! Reloading page..."); 
            location.reload();
        } catch(e) { 
            console.error(e);
            alert("Error parsing data! Check format."); 
        }
    }

    function initIntensity() {
            const saved = localStorage.getItem(STORAGE.INTENSITY);
            currentIntensity = saved ? parseInt(saved) : 1;
            
            // Синхронизируем позицию ползунка (на случай, если HTML сбросился)
            const slider = document.getElementById('intensity-slider');
            if (slider) slider.value = currentIntensity;

            updateIntensity(currentIntensity);
        }
    
    let intensityTextTimeout = null;
    let intensityColorTimeout = null;

    function updateIntensity(val) {
        currentIntensity = parseInt(val);
        localStorage.setItem(STORAGE.INTENSITY, currentIntensity);
        
        const slider = document.getElementById('intensity-slider');
        const mainIcon = document.getElementById('main-intensity-icon');
        const labelText = document.getElementById('intensity-value-label');

        if (!slider || !mainIcon) return;

        slider.value = currentIntensity;

        const t = langData[currentLang] || langData['en'];
        const isNoir = document.body.getAttribute('data-theme') === 'noir';
        const isLight = document.body.classList.contains('light-theme');
        const colorBg = 'var(--border)'; 
        
        // Нейтральный фильтр
        const neutralFilter = isLight ? "invert(0) opacity(0.8)" : "invert(1) opacity(0.9)";

        // Конфигурация уровней
        let config = {};
        if (currentIntensity === 1) {
            config = {
                icon: 'safe.png', key: 'val_safe', color: '#2ecc71', emoji: "🛡️",
                bg: colorBg,
                activeFilter: "invert(68%) sepia(61%) saturate(452%) hue-rotate(97deg) brightness(89%) contrast(85%)"
            };
        } else if (currentIntensity === 2) {
            config = {
                icon: 'spicy.png', key: 'val_spicy', color: isNoir ? '#ffffff' : '#f39c12', emoji: "🔥",
                bg: `linear-gradient(to right, ${isNoir ? '#fff' : '#f39c12'} 0%, ${isNoir ? '#fff' : '#f39c12'} 50%, ${colorBg} 50%, ${colorBg} 100%)`,
                activeFilter: "invert(77%) sepia(33%) saturate(5427%) hue-rotate(357deg) brightness(101%) contrast(90%)"
            };
        } else {
            config = {
                icon: 'extreme.png', key: 'val_extreme', color: isNoir ? '#ffffff' : '#e74c3c', emoji: "💀",
                bg: isNoir ? '#ffffff' : '#e74c3c',
                activeFilter: "invert(43%) sepia(97%) saturate(1874%) hue-rotate(338deg) brightness(96%) contrast(89%)"
            };
        }

        if (isNoir) {
            config.activeFilter = isLight ? "invert(0)" : "invert(1)";
        }

        slider.style.background = config.bg;

        // --- ЛОГИКА АНИМАЦИИ ИКОНКИ ---
        if (intensityColorTimeout) clearTimeout(intensityColorTimeout);

        // 1. ФАЗА АКТИВАЦИИ (Быстрый удар)
        mainIcon.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.2s ease-out";
        
        // При смене картинки делаем "перезарядку"
        if (mainIcon.src.indexOf(config.icon) === -1) {
            mainIcon.style.transform = "scale(0.5)"; // Сжатие
            setTimeout(() => {
                mainIcon.src = config.icon;
                mainIcon.style.filter = config.activeFilter; 
                mainIcon.style.transform = "scale(1.25)"; // Сильное увеличение (Pop)
                setTimeout(() => mainIcon.style.transform = "scale(1.1)", 150);
            }, 100);
        } else {
            // Та же иконка — просто красим и увеличиваем
            mainIcon.style.filter = config.activeFilter;
            mainIcon.style.transform = "scale(1.2)";
        }

        // 2. ФАЗА ВОЗВРАТА (С "Прыжком")
        intensityColorTimeout = setTimeout(() => {
            mainIcon.style.transition = "filter 0.8s ease, transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)";
            
            mainIcon.style.filter = neutralFilter; 
            mainIcon.style.transform = "scale(1)";
        }, 1200);


        // --- ЛОГИКА ТЕКСТА ---
        const infoIcon = document.getElementById('intensity-info-icon');
        if (labelText) {
            labelText.style.opacity = "";
            labelText.style.transform = ""; 
            labelText.style.transition = ""; 

            if (intensityTextTimeout) clearTimeout(intensityTextTimeout);

            let rawText = t[config.key] || "Level " + currentIntensity;
            rawText = rawText.replace(config.emoji, '').trim(); 
            
            labelText.innerText = rawText + " " + config.emoji;
            labelText.style.color = config.color;

            requestAnimationFrame(() => {
                labelText.classList.add('visible');
                if(infoIcon) {
                    infoIcon.style.opacity = '0';
                    infoIcon.style.pointerEvents = 'none';
                }
            });

            intensityTextTimeout = setTimeout(() => {
                labelText.classList.remove('visible');
                if(infoIcon) {
                    infoIcon.style.opacity = '0.5'; 
                    infoIcon.style.pointerEvents = 'auto';
                }
            }, 1200);
        }
        
        if(navigator.vibrate) navigator.vibrate(15);
    }

    function initIdleSlot() {
        const reel = document.getElementById('slot-reel');
        if (!reel) return;

        // Берем 30 случайных элементов
        const sample = [...data].sort(() => 0.5 - Math.random()).slice(0, 30);
        
        // Дублируем список 4 раза для бесшовности
        let html = '';
        // Генерируем HTML один раз
        const itemsHtml = sample.map(item => `<div class="slot-item">${getLocalizedName(item)}</div>`).join('');
        
        // Вставляем 4 копии
        reel.innerHTML = itemsHtml + itemsHtml + itemsHtml + itemsHtml;

        reel.className = 'slot-reel idle'; 
        reel.style.transform = ''; 
        reel.style.transition = ''; 
    }

    function checkLayout() {
        const isPC = window.innerWidth > 768;
        
        // 1. Исходные блоки
        const bPrefs = document.getElementById('block-prefs');    
        const bAccount = document.getElementById('block-account'); 
        const bExtras = document.getElementById('block-extras');
        
        // 2. Целевые контейнеры
        const sidebar = document.getElementById('pc-settings-mount'); 
        
        const mPrefs = document.getElementById('mount-prefs');     
        const mAccount = document.getElementById('mount-account'); 

        if (isPC) {
            // === ПК РЕЖИМ (ВСЁ В САЙДБАРЕ) ===
            if (sidebar) {
                if(bPrefs) sidebar.appendChild(bPrefs);
                if(bAccount) sidebar.appendChild(bAccount);
                if(bExtras) sidebar.appendChild(bExtras);
            }
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const homeTab = document.getElementById('tab-home');
            if(homeTab) homeTab.classList.add('active');

        } else {
            // === МОБИЛЬНЫЙ РЕЖИМ ===
            
            // 1. Настройки
            if(mPrefs && bPrefs) mPrefs.appendChild(bPrefs);
            
            // 2. Ссылки (Extras) в Settings
            if(mPrefs && bExtras) {
                mPrefs.appendChild(bExtras);
            }

            // 3. Аккаунт
            if(mAccount && bAccount) mAccount.appendChild(bAccount);
        }
    }

    function toggleModifiers(e) {
        // Если кликнули по самому тегу внутри, не закрываем меню
        if (e && e.target.classList.contains('tag')) return;

        const capsule = document.getElementById('mods-capsule');
        if (!capsule) return;

        const isOpen = capsule.classList.toggle('open');
        
        // Элементы для размытия
        const blurTargets = [
            document.getElementById('slot-reel'),
            document.getElementById('result-desc'),
            document.getElementById('badge-wrapper'),
            document.getElementById('related-block')
        ];

        // Применяем размытие только на мобильных (экран <= 768px)
        if (window.innerWidth <= 768) {
            blurTargets.forEach(el => {
                if (el) {
                    if (isOpen) {
                        el.classList.add('card-content-blur');
                    } else {
                        el.classList.remove('card-content-blur');
                    }
                }
            });
        }

        if(navigator.vibrate) navigator.vibrate(10);
    }

    const tabs = ['home', 'settings', 'account'];
    let activeIndex = 0;
    const navBar = document.getElementById('bottom-nav');
    const pill = document.getElementById('nav-active-pill');

    function switchTab(tabName, isInteractive = false) {
        const index = tabs.indexOf(tabName);
        if (index === -1 || (index === activeIndex && isInteractive)) return;

        activeIndex = index;

        // 1. Двигаем капсулу (индекс * 100%)
        pill.style.transform = `translateX(${index * 100}%)`;

        // 2. Переключаем контент вкладок
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');

        // 3. Обновляем иконки в меню
        document.querySelectorAll('.nav-item').forEach((item, i) => {
            item.classList.toggle('active', i === index);
        });

        // 4. Обновляем классы хедера
        document.body.classList.remove('tab-home-active', 'tab-settings-active', 'tab-account-active');
        document.body.classList.add(`tab-${tabName}-active`);

        updateNavIcons(tabName);

        // Мягкий клик
        if (navigator.vibrate) navigator.vibrate(1);
    }

    // === ЛОГИКА НЕПРЕРЫВНОГО СЛАЙДИНГА В НАВБАРЕ ===
    let isDraggingNav = false;

    navBar.addEventListener('touchstart', (e) => {
        isDraggingNav = true;
        handleNavTouch(e);
    }, { passive: false });

    navBar.addEventListener('touchmove', (e) => {
        if (!isDraggingNav) return;
        e.preventDefault(); // Запрещаем скролл страницы при вождении по меню
        handleNavTouch(e);
    }, { passive: false });

    navBar.addEventListener('touchend', () => {
        isDraggingNav = false;
    });

    function handleNavTouch(e) {
        const touch = e.touches[0];
        const rect = navBar.getBoundingClientRect();
        
        // Вычисляем позицию пальца относительно ширины навбара (от 0 до 1)
        let offsetX = (touch.clientX - rect.left) / rect.width;
        
        // Ограничиваем края
        offsetX = Math.max(0, Math.min(offsetX, 0.99));

        // Определяем, на какую вкладку попадает палец (0, 1 или 2)
        const newIndex = Math.floor(offsetX * tabs.length);

        if (newIndex !== activeIndex) {
            switchTab(tabs[newIndex], true);
        }
    }

    function updateNavIcons(activeTab) {
        const tabs = ['home', 'settings', 'account'];
        
        tabs.forEach(t => {
            // Находим картинку внутри кнопки навигации
            const img = document.querySelector(`#nav-${t} .nav-icon-img`);
            if (img) {
                // Если таб активен — ставим _fill, иначе _outline
                const suffix = (t === activeTab) ? '_fill' : '_outline';
                img.src = `${t}${suffix}.png`;
            }
        });
    }

    function initTheme() {
        const isPaid = subscriptionLevel !== 'free';
        const isRandomEnabled = localStorage.getItem('xch_random_theme') === 'true';
        const includeLight = localStorage.getItem('xch_random_include_light') === 'true';
        
        let themeToApply = localStorage.getItem('xch_theme_id') || 'dark';

        // Логика выбора темы
        if (isPaid && isRandomEnabled) {
            let pool = APP_THEMES;

            // Если "Включая светлые" выключено — фильтруем только темные
            if (!includeLight) {
                pool = pool.filter(t => !t.isLight);
            }

            // Выбираем абсолютно любую тему из пула
            const randomIndex = Math.floor(Math.random() * pool.length);
            themeToApply = pool[randomIndex].id;
            
            console.log("🎲 Random Theme Selected:", themeToApply);
        } else {
            // Обычная логика проверки прав для Free пользователей
            if (!isPaid) {
                const themeObj = APP_THEMES.find(t => t.id === themeToApply);
                if (!themeObj || themeObj.type === 'pro') {
                    themeToApply = 'dark';
                    localStorage.setItem('xch_theme_id', 'dark');
                }
            }
        }

        applyTheme(themeToApply, true); 
    }
    
    function initLanguage() {
        const saved = localStorage.getItem(STORAGE.LANG);
        currentLang = saved || 'en';

        document.getElementById('lang-select').value = currentLang;
        
        const ageGateSelect = document.querySelector('#age-gate select');
        if (ageGateSelect) ageGateSelect.value = currentLang;
        applyLanguage();
        updateToggleLabels();
    }
    
    function changeLanguage(val) {
        currentLang = val;
        localStorage.setItem(STORAGE.LANG, currentLang);
        const s1 = document.getElementById('lang-select');
        const s2 = document.querySelector('#age-gate select');
        if (s1) s1.value = val;
        if (s2) s2.value = val;
        applyLanguage();
        randomizeModeGreeting();
        if (window.updateLastSyncUI) window.updateLastSyncUI(); 
        renderHistory();
        renderModifiers();
        updateThemeLabel();
        if(currentItem) { renderResultUI(currentItem, null); updateLink(); } 
        updateToggleLabels();
        updateExploredCount();
    }
    
    function updateToggleLabels() {
        const isRu = (currentLang === 'ru');
        document.getElementById('comp-search').style.display = isRu ? 'flex' : 'none';
    }
   
    function applyLanguage() {
        const t = langData[currentLang];
        
        // Перевод текстов
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if(t[key]) {
                if (key.startsWith('inst_') || 
                    key.startsWith('badge_') || 
                    key.startsWith('feat_') || 
                    key.startsWith('pay_') || 
                    key.startsWith('guide_') || 
                    key.startsWith('spon_') || 
                    key === 'sync_tip') {
                    el.innerHTML = t[key];
                } else {
                    el.innerText = t[key];
                }
            }
        });

        // Перевод плейсхолдеров
        const onbInput = document.getElementById('onb-input');
        if(onbInput && t.onb_placeholder) onbInput.placeholder = t.onb_placeholder;

        const promoInput = document.getElementById('promo-input-field');
        if(promoInput && t.pay_code_placeholder) promoInput.placeholder = t.pay_code_placeholder;

        const sponInput = document.getElementById('sponsor-nickname-input');
        if(sponInput && t.spon_placeholder) sponInput.placeholder = t.spon_placeholder;
        
        updateExploredCount();
        updateSubscriptionUI(); 
    }

    function submitPromoFromInput() {
        const input = document.getElementById('promo-input-field');
        const code = input.value.trim();
        
        if (!code) {
            // Визуальная тряска или красная рамка (опционально)
            input.style.borderColor = "var(--highlight-red)";
            setTimeout(() => input.style.borderColor = "var(--border)", 1000);
            return;
        }

        // Вызываем существующую логику активации
        window.activatePromoCode(code);
        
        // Очищаем поле
        input.value = "";
        
        closePaymentModal(null, true);
        closeSubModal(null, true);
    }

    function openFavoritesCatalog() {
        renderListModal('fav');
    }

    function openBlacklistCatalog() {
        renderListModal('ban');
    }

    function renderListModal(type) {
        let modalId, bodyId, listData, placeholder;
        const t = langData[currentLang] || langData['en']; // Получаем переводы

        if (type === 'fav') {
            modalId = 'modal-overlay'; bodyId = 'modal-catalog-body'; listData = favorites;
            placeholder = t.search_liked; // Локализованный плейсхолдер
        } else if (type === 'ban') {
            modalId = 'modal-blacklist-overlay'; bodyId = 'modal-blacklist-body'; listData = blacklist;
            placeholder = t.search_disliked; // Локализованный плейсхолдер
        } else if (type === 'wl') {
            modalId = 'modal-overlay'; 
            bodyId = 'modal-catalog-body'; 
            listData = watchLater;
            
            const header = document.querySelector(`#${modalId} .modal-header span`);
            if(header) header.innerText = t.watch_later;
        }

        const modal = document.getElementById(modalId);
        const body = document.getElementById(bodyId);
        
        body.innerHTML = '';
        body.style.display = 'block';
        body.style.padding = '15px';

        // 1. ПОЛЕ ПОИСКА (Только если это НЕ Watch Later)
        if (type !== 'wl') {
            const searchBox = document.createElement('div');
            searchBox.className = 'modal-search-box';
            searchBox.innerHTML = `
                <input type="text" class="modal-search-input" placeholder="${placeholder}" id="search-${type}">
                <div class="modal-suggestions" id="suggest-${type}"></div>
            `;
            body.appendChild(searchBox);
        }

        // 2. Контейнер тегов
        const tagsContainer = document.createElement('div');
        tagsContainer.style.display = 'flex';
        tagsContainer.style.flexWrap = 'wrap';
        tagsContainer.style.gap = '8px';
        body.appendChild(tagsContainer);

        // 3. Рендер тегов
        renderCurrentTags(type, listData, tagsContainer);

        // 4. Логика поиска (Только если поле создано)
        if (type !== 'wl') {
            const input = document.getElementById(`search-${type}`);
            const suggestBox = document.getElementById(`suggest-${type}`);

            input.oninput = (e) => {
                const val = e.target.value.toLowerCase().trim();
                if (val.length < 2) { suggestBox.style.display = 'none'; return; }

                const matches = data.filter(item => {
                    if (listData.includes(item.id)) return false;
                    const terms = [item.name, item.name_ru || "", item.name_es || "", item.name_de || "", item.slug].map(x => x.toLowerCase());
                    return terms.some(term => term.includes(val));
                }).slice(0, 10);

                suggestBox.innerHTML = '';
                if (matches.length > 0) {
                    suggestBox.style.display = 'flex';
                    matches.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'suggestion-row';
                        row.innerHTML = `${getLocalizedName(item)} <span>+</span>`;
                        
                        row.onclick = () => {
                            if (type === 'fav') {
                                favorites.push(item.id);
                                if (blacklist.includes(item.id)) blacklist = blacklist.filter(x => x !== item.id);
                                adjustTagScores(item, 5);
                                logActivity('like', item.id, item.tags);
                            } else if (type === 'ban') {
                                blacklist.push(item.id);
                                if (favorites.includes(item.id)) favorites = favorites.filter(x => x !== item.id);
                                adjustTagScores(item, -5);
                                logActivity('dislike', item.id, item.tags);
                            } 
                            
                            localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
                            localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
                            
                            updateCounts();
                            if (window.markDirty) window.markDirty();
                            
                            input.value = ''; 
                            suggestBox.style.display = 'none';
                            renderListModal(type);
                            if(currentItem && currentItem.id === item.id) updateActionButtons();
                        };
                        suggestBox.appendChild(row);
                    });
                } else {
                    suggestBox.style.display = 'none';
                }
            };
        }

        // Возврат заголовка для Fav при закрытии (или при следующем открытии Fav само исправится)
        if (type === 'fav') {
             const header = document.querySelector(`#${modalId} .modal-header span`);
             if(header) header.innerText = t.favorites_catalog;
        }

        modal.classList.add('open');
    }

    function renderCurrentTags(type, listIds, container) {
        container.innerHTML = '';
        const t = langData[currentLang];
        
        if (listIds.length === 0) {
            container.innerHTML = `<div style="width:100%; text-align:center; color:var(--text-secondary); margin-top:20px; font-size:14px;">${t.empty_wl || "List is empty"}</div>`;
            return;
        }

        const sortedIds = [...listIds].sort((a, b) => {
            const itemA = data.find(x => x.id === a);
            const itemB = data.find(x => x.id === b);
            if (!itemA || !itemB) return 0;
            return getLocalizedName(itemA).localeCompare(getLocalizedName(itemB));
        });

        sortedIds.forEach(id => {
            const item = data.find(x => x.id === id);
            if (!item) return;

            const div = document.createElement('div');
            // ОПРЕДЕЛЕНИЕ КЛАССА
            let className = 'catalog-item';
            if (type === 'fav') className += ' active';
            else if (type === 'ban') className += ' ban-active';
            else if (type === 'wl') className += ' wl-active'; // СИНИЙ
            
            div.className = className;
            div.innerHTML = `${getLocalizedName(item)} <span class="catalog-remove-btn">✕</span>`;

            div.querySelector('.catalog-remove-btn').onclick = (e) => {
                e.stopPropagation();
                
                if (type === 'fav') favorites = favorites.filter(x => x !== id);
                else if (type === 'ban') blacklist = blacklist.filter(x => x !== id);
                else if (type === 'wl') watchLater = watchLater.filter(x => x !== id);
                
                localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
                localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
                localStorage.setItem(STORAGE.WATCH_LATER, JSON.stringify(watchLater));
                
                updateCounts();
                if (window.markDirty) window.markDirty();
                
                div.style.opacity = '0';
                div.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    renderCurrentTags(type, type === 'fav' ? favorites : (type === 'ban' ? blacklist : watchLater), container);
                }, 200);

                if(currentItem && currentItem.id === id) updateActionButtons();
            };
            
            // Клик по самому тегу открывает его (как в истории)
            div.onclick = (e) => {
                if(e.target.classList.contains('catalog-remove-btn')) return;
                closeList(null, true);
                closeBlacklist(null, true);
                switchTab('home');
                forceShowResult(item, 'history');
            }

            container.appendChild(div);
        });
    }

    function closeList(e, force) {
        if (force || e.target.id === 'modal-overlay') {
            document.getElementById('modal-overlay').classList.remove('open');
        }
    }
    
    function closeBlacklist(e, force) {
        if (force || e.target.id === 'modal-blacklist-overlay') {
            document.getElementById('modal-blacklist-overlay').classList.remove('open');
        }
    }

    function searchByTag(tag) {
        const candidates = data.filter(item => item.tags.includes(tag));
        if (candidates.length === 0) return; 
        const selected = getWeightedRandom(candidates); 
        forceShowResult(selected, 'tag_click');
    }

    let wrappedRotationInterval = null;

    function openStatistics() {
        const t = langData[currentLang];
        
        // Локализация табов
        if (document.getElementById('tf-week')) document.getElementById('tf-week').innerText = t.tf_week;
        if (document.getElementById('tf-month')) document.getElementById('tf-month').innerText = t.tf_month;
        if (document.getElementById('tf-year')) document.getElementById('tf-year').innerText = t.tf_year;
        if (document.getElementById('tf-all')) document.getElementById('tf-all').innerText = t.tf_all;

        updateStatsLocks();

        // === ЛОГИКА WRAPPED КНОПКИ ===
        const wBtn = document.getElementById('btn-wrapped-trigger');
        const isPaid = subscriptionLevel !== 'free';
        const daysActive = activeDaysSet.size;
        
        // Очистка старых таймеров
        if (wrappedTimerInterval) clearInterval(wrappedTimerInterval);
        if (wrappedRotationInterval) clearInterval(wrappedRotationInterval);

        // Удаляем прогресс-бар для совсем новичков (лок)
        const oldProgress = document.getElementById('wrapped-progress-ui');
        if (oldProgress) oldProgress.remove();

        // 1. Собираем список статусов для ротации
        let statuses = [];
        const now = new Date();

        // A. DAILY (Только для платных)
        if (isPaid) {
            if (!hasDailyForYesterday()) {
                statuses.push({ type: 'ready', label: 'DAILY READY', color: '#2ecc71' });
            } else {
                // Таймер до завтра
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                statuses.push({ type: 'timer', label: 'DAILY', target: tomorrow.getTime() });
            }
        }

        // B. WEEKLY
        if (daysActive >= 7) {
            statuses.push({ type: 'ready', label: 'WEEKLY READY', color: '#2ecc71' });
        } else {
            // Сколько дней осталось (если меньше 3, добавляем в ротацию)
            const left = 7 - daysActive;
            if (left <= 3) {
                const daysWord = currentLang === 'ru' ? 'дн.' : 'd';
                statuses.push({ type: 'text', label: 'WEEKLY', text: `${left} ${daysWord}` });
            }
        }

        // C. MONTHLY (Примерная логика: конец месяца)
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const daysToMonthEnd = Math.ceil((endOfMonth - now) / (1000 * 60 * 60 * 24));
        if (daysToMonthEnd <= 3) {
            const daysWord = currentLang === 'ru' ? 'дн.' : 'd';
            statuses.push({ type: 'text', label: 'MONTHLY', text: `${daysToMonthEnd} ${daysWord}` });
        }

        // Если статусов нет (новичок Free), показываем общий прогресс
        if (statuses.length === 0 && subscriptionLevel === 'free') {
            const daysWord = currentLang === 'ru' ? 'дн.' : 'd';
            statuses.push({ type: 'text', label: 'WEEKLY', text: `${daysActive}/7 ${daysWord}` });
        }

        // === РЕНДЕР КНОПКИ ===
        // Показываем кнопку, если есть хоть какие-то статусы или архив
        if (statuses.length > 0 || wrappedArchive.length > 0) {
            if (wBtn) wBtn.style.display = 'flex';
            
            const btnTitle = t.wrapped_btn || "Fetish Wrapped ✨";
            
            // Вставляем структуру: Слева заголовок, Справа контейнер для ротации
            wBtn.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <span>${btnTitle}</span>
                    <div id="wrapped-dynamic-badge" style="display:flex; align-items:center; justify-content:flex-end; min-width:80px;">
                        <!-- Сюда JS будет вставлять контент -->
                    </div>
                </div>
            `;

            const badgeContainer = document.getElementById('wrapped-dynamic-badge');
            let statusIndex = 0;

            // Функция обновления бейджа
            const updateBadgeUI = () => {
                const state = statuses[statusIndex];
                let html = '';

                if (state.type === 'ready') {
                    html = `<span style="background:${state.color}; color:#000; font-size:10px; font-weight:800; padding:3px 8px; border-radius:6px; text-transform:uppercase;">${state.label}</span>`;
                } 
                else if (state.type === 'text') {
                    html = `
                        <span style="font-size:9px; color:rgba(255,255,255,0.6); margin-right:5px; text-transform:uppercase; font-weight:700;">${state.label}</span>
                        <span style="background:rgba(255,255,255,0.15); color:#fff; font-size:10px; font-weight:700; padding:3px 8px; border-radius:6px;">${state.text}</span>
                    `;
                } 
                else if (state.type === 'timer') {
                    // Вычисляем время
                    const diff = state.target - Date.now();
                    let timeStr = "--:--";
                    if (diff > 0) {
                        const h = Math.floor(diff / 3600000);
                        const m = Math.floor((diff % 3600000) / 60000);
                        timeStr = `${h}h ${m}m`; // Компактный вид: 12h 40m
                    }
                    html = `
                        <span style="font-size:9px; color:rgba(255,255,255,0.6); margin-right:5px; text-transform:uppercase; font-weight:700;">${state.label}</span>
                        <span style="background:rgba(255,255,255,0.15); color:#fff; font-size:10px; font-weight:700; padding:3px 8px; border-radius:6px; font-variant-numeric: tabular-nums;">${timeStr}</span>
                    `;
                }

                // Плавная смена через прозрачность
                badgeContainer.style.opacity = '0';
                setTimeout(() => {
                    badgeContainer.innerHTML = html;
                    badgeContainer.style.opacity = '1';
                }, 200);
            };

            // Запуск первого состояния
            updateBadgeUI();

            // Если статусов больше 1, запускаем ротацию каждые 2.5 секунды
            if (statuses.length > 1) {
                wrappedRotationInterval = setInterval(() => {
                    statusIndex = (statusIndex + 1) % statuses.length;
                    updateBadgeUI();
                }, 2500);
            }
            // Если есть таймер, запускаем обновление каждую минуту (для обновления цифр)
            if (statuses.some(s => s.type === 'timer')) {
                wrappedTimerInterval = setInterval(() => {
                    // Просто перерисовываем текущий, если он таймер
                    if (statuses[statusIndex].type === 'timer') updateBadgeUI();
                }, 60000);
            }

        } else {
            // Если совсем пусто (для Free без истории) -> Большая плашка
            if (wBtn) wBtn.style.display = 'none';
            const left = 7 - daysActive;
            const descTxt = (t.wrapped_lock_desc || "Activity needed: {n}").replace('{n}', `${left} days`);
            const percent = Math.min(100, (daysActive / 7) * 100);

            const progressHTML = `
                <div id="wrapped-progress-ui" class="wrapped-lock-container" style="margin: 0 10px 20px 10px;">
                    <div class="wrapped-lock-title">${t.wrapped_lock_title}</div>
                    <div class="wrapped-lock-desc">${descTxt}</div>
                    <div class="w-progress-track"><div class="w-progress-fill" style="width: ${percent}%"></div></div>
                </div>
            `;
            const modalBody = document.getElementById('modal-stats-body');
            if(modalBody) modalBody.insertAdjacentHTML('beforebegin', progressHTML);
        }

        // Открытие модалки
        const modal = document.getElementById('modal-stats-overlay');
        if (modal) {
            modal.classList.add('open');
            currentStatsTimeframe = 'week'; 
            currentStatsTab = 'tags';
            // Сброс табов UI
            document.querySelectorAll('.stats-tf-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tf-week').classList.add('active');
            document.getElementById('stat-nav-tags').classList.add('active');
            document.getElementById('stat-nav-activity').classList.remove('active');
            renderStatsContent();
        }
    }

    // Добавляем очистку интервала при закрытии
    const originalCloseStats = window.closeStats;
    window.closeStats = function(e, force) {
        if (wrappedRotationInterval) clearInterval(wrappedRotationInterval);
        originalCloseStats(e, force);
    }

    function switchStatsTab(tab) {
        
        currentStatsTab = tab;
        
        // Переключаем классы
        document.getElementById('stat-nav-tags').classList.toggle('active', tab === 'tags');
        document.getElementById('stat-nav-activity').classList.toggle('active', tab === 'activity');
        
        // Если пользователь бесплатный, принудительно переключаем на 'week' при смене вкладки,
        if (subscriptionLevel === 'free' && currentStatsTimeframe !== 'week') {
            switchTimeframe('week'); 
        } else {
            renderStatsContent();
        }
    }

    function switchTimeframe(tf) {
        // NERF: Блокируем всё кроме "Week" для бесплатных
        if (tf !== 'week' && subscriptionLevel === 'free') {
            openSubModal();
            return;
        }

        currentStatsTimeframe = tf;
        document.querySelectorAll('.stats-tf-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tf-' + tf).classList.add('active');
        renderStatsContent();
    }

    function updateStatsLocks() {
        const isFree = subscriptionLevel === 'free';
        const idsToLock = ['tf-month', 'tf-year', 'tf-custom']; 

        idsToLock.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;

            // 1. Полная очистка перед рендером
            const oldLock = el.querySelector('.lock-badge-custom');
            if (oldLock) oldLock.remove();
            
            const anchor = el.querySelector('.tf-anchor');
            if (anchor) {
                // Возвращаем контент в исходный вид
                const originalContent = anchor.innerHTML.replace('<span class="lock-badge-custom">🔒</span>', '');
                el.innerHTML = originalContent;
            }

            if (isFree) {
                el.style.opacity = '0.5';

                // 2. Берем текущий контент (текст или <img>)
                const content = el.innerHTML;
                
                // 3. Перезаписываем с новой структурой: Контент + Замок внутри одного якоря
                el.innerHTML = `
                    <span class="tf-anchor">
                        ${content}
                        <span class="lock-badge-custom">🔒</span>
                    </span>
                `;
            } else {
                el.style.opacity = '1';
            }
        });
    }

    let customRangeStart = null;
    let customRangeEnd = null;

    function openDatePicker() {
        if (subscriptionLevel === 'free') {
            openSubModal();
            return;
        }
        
        renderCalendarList();
        
        // Навешиваем слушатели на инпуты
        initDateInputListeners();
        
        // Локализация плейсхолдеров
        const t = { start: { en: "Start", ru: "Начало" }, end: { en: "End", ru: "Конец" } };
        const lang = ['ru'].includes(currentLang) ? 'ru' : 'en';
        
        document.getElementById('input-start').placeholder = t.start[lang];
        document.getElementById('input-end').placeholder = t.end[lang];

        document.getElementById('modal-date-picker').classList.add('open');
    }

    function initDateInputListeners() {
        const startInput = document.getElementById('input-start');
        const endInput = document.getElementById('input-end');

        // Функция обработки ввода
        const handleInput = (e, type) => {
            let val = e.target.value.replace(/\D/g, ''); // Удаляем всё кроме цифр
            
            // Ограничиваем длину (DDMMYYYY = 8 цифр)
            if (val.length > 8) val = val.slice(0, 8);

            // Добавляем точки: 06.02.2026
            let formatted = val;
            if (val.length >= 5) {
                formatted = val.slice(0, 2) + '.' + val.slice(2, 4) + '.' + val.slice(4);
            } else if (val.length >= 3) {
                formatted = val.slice(0, 2) + '.' + val.slice(2);
            }
            
            e.target.value = formatted; // Возвращаем в поле

            // Если дата введена полностью (10 символов: 01.01.2000)
            if (formatted.length === 10) {
                parseAndApplyDate(formatted, type);
            }
        };

        // Навешиваем (удаляя старые чтобы не дублировать)
        startInput.oninput = (e) => handleInput(e, 'start');
        endInput.oninput = (e) => handleInput(e, 'end');
    }

    function parseAndApplyDate(str, type) {
        const parts = str.split('.');
        if (parts.length !== 3) return;

        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1; 
        const year = parseInt(parts[2]);

        const date = new Date(year, month, day);

        // Простая проверка валидности
        if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
            
            if (type === 'start') {
                customRangeStart = date;
                if (customRangeEnd && customRangeEnd < customRangeStart) customRangeEnd = null;
            } else {
                customRangeEnd = date;
                if (!customRangeStart) customRangeStart = date;
                // Если конец раньше начала — меняем местами
                else if (customRangeEnd < customRangeStart) {
                    const temp = customRangeStart;
                    customRangeStart = customRangeEnd;
                    customRangeEnd = temp;
                }
            }
            // Обновляем календарь (подсветку кружочков)
            updateCalendarSelection(false); 
        }
    }

    function closeDatePicker(e, force) {
        if (force || e.target.id === 'modal-date-picker') {
            document.getElementById('modal-date-picker').classList.remove('open');
        }
    }

    function renderCalendarList() {
        const container = document.getElementById('calendar-scroll-container');
        container.innerHTML = '';
        container.style.display = 'block'; 
        
        const now = new Date();
        const monthsToGenerate = 24; 

        // Генерируем от "24 месяца назад" до "сегодня"
        for (let i = monthsToGenerate; i >= 0; i--) {
            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const monthEl = createMonthElement(date.getFullYear(), date.getMonth());
            container.appendChild(monthEl);
        }
        
        // Скроллим вниз
        requestAnimationFrame(() => {
            container.scrollTop = container.scrollHeight;
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
        });

        updateCalendarSelection();
    }

    function createMonthElement(year, month) {
        const wrapper = document.createElement('div');
        wrapper.className = 'calendar-month-card'; 
        
        const monthName = new Date(year, month).toLocaleString(currentLang, { month: 'long', year: 'numeric' });
        wrapper.innerHTML = `<div class="calendar-month-title">${monthName}</div>`;
        
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        // Дни недели
        const days = currentLang === 'ru' ? ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'] : 
                     (currentLang === 'es' ? ['Lu','Ma','Mi','Ju','Vi','Sa','Do'] : 
                     (currentLang === 'de' ? ['Mo','Di','Mi','Do','Fr','Sa','So'] : ['Mo','Tu','We','Th','Fr','Sa','Su']));
                     
        days.forEach(d => grid.innerHTML += `<div class="calendar-day-label" style="font-weight:700; opacity:0.5;">${d}</div>`);
        
        // Пустые ячейки
        let firstDay = new Date(year, month, 1).getDay();
        firstDay = firstDay === 0 ? 6 : firstDay - 1; 
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        
        // Дни
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        today.setHours(0,0,0,0);

        for (let d = 1; d <= daysInMonth; d++) {
            const currentIterDate = new Date(year, month, d);
            const isFuture = currentIterDate > today;
            const dateStr = currentIterDate.toISOString().split('T')[0];
            
            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day ${isFuture ? 'disabled' : ''}`;
            dayEl.dataset.date = dateStr;
            dayEl.innerText = d;
            
            // Если дата в будущем — убираем клик
            if(!isFuture) {
                dayEl.onclick = () => selectDate(currentIterDate);
            }
            
            grid.appendChild(dayEl);
        }
        
        wrapper.appendChild(grid);
        return wrapper;
    }
    
    function selectDate(date) {
        if (!customRangeStart || (customRangeStart && customRangeEnd)) {
            customRangeStart = date;
            customRangeEnd = null;
        } else {
            if (date < customRangeStart) {
                customRangeEnd = customRangeStart;
                customRangeStart = date;
            } else {
                customRangeEnd = date;
            }
        }
        updateCalendarSelection();
    }

    function handleManualDate(type, value) {
        if (!value) return;
        
        // value приходит в формате "YYYY-MM-DD"
        const dateParts = value.split('-');
        const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
        
        if (type === 'start') {
            customRangeStart = dateObj;
            // Если конец меньше начала, сбрасываем конец
            if (customRangeEnd && customRangeEnd < customRangeStart) {
                customRangeEnd = null;
            }
        } else {
            customRangeEnd = dateObj;
            // Если начало не выбрано, ставим его таким же
            if (!customRangeStart) {
                customRangeStart = dateObj;
            } 
            // Если конец меньше начала, меняем их местами
            else if (customRangeEnd < customRangeStart) {
                const temp = customRangeStart;
                customRangeStart = customRangeEnd;
                customRangeEnd = temp;
            }
        }
        
        updateCalendarSelection();
        renderCalendarList(); 
    }

    function updateCalendarSelection(updateInputs = true) {
        const days = document.querySelectorAll('.calendar-day');
        
        const startCapsule = document.getElementById('capsule-start');
        const endCapsule = document.getElementById('capsule-end');
        const startInput = document.getElementById('input-start');
        const endInput = document.getElementById('input-end');

        // Форматтер DD.MM.YYYY
        const fmt = (d) => {
            if (!d) return "";
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}.${mm}.${yyyy}`;
        };

        // 1. Обновляем ИНПУТЫ (только если это не ручной ввод)
        if (updateInputs) {
            if (customRangeStart) {
                startInput.value = fmt(customRangeStart);
                startCapsule.classList.add('filled');
            } else {
                startInput.value = "";
                startCapsule.classList.remove('filled');
            }

            if (customRangeEnd) {
                endInput.value = fmt(customRangeEnd);
                endCapsule.classList.add('filled');
            } else {
                endInput.value = "";
                endCapsule.classList.remove('filled');
            }
        } else {
            // Если ручной ввод — просто обновляем цвет капсулы
            if (customRangeStart) startCapsule.classList.add('filled');
            if (customRangeEnd) endCapsule.classList.add('filled');
        }

        // 2. Обновляем КАЛЕНДАРЬ (Кружочки)
        days.forEach(day => {
            const dStr = day.dataset.date;
            if (!dStr) return;
            
            const d = new Date(dStr);
            d.setHours(0,0,0,0);
            const dTime = d.getTime();
            
            const sTime = customRangeStart ? customRangeStart.getTime() : null;
            const eTime = customRangeEnd ? customRangeEnd.getTime() : null;

            day.classList.remove('selected', 'in-range');
            
            // Начало и Конец (Темный круг)
            if (sTime && dTime === sTime) day.classList.add('selected');
            if (eTime && dTime === eTime) day.classList.add('selected');
            
            // Диапазон (Светлый фон)
            if (sTime && eTime && dTime > sTime && dTime < eTime) {
                day.classList.add('in-range');
            }
        });
    }

    function applyCustomRange() {
        const t = langData[currentLang] || langData['en'];
        
        if (!customRangeStart) {
            alert(currentLang === 'ru' ? "Выберите дату начала" : "Select start date");
            return;
        }
        
        if (!customRangeEnd) customRangeEnd = new Date(customRangeStart);
        
        currentStatsTimeframe = 'custom';
        
        document.querySelectorAll('.stats-tf-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tf-custom').classList.add('active');
        
        closeDatePicker(null, true);
        renderStatsContent();
        
        if(navigator.vibrate) navigator.vibrate(10);
    }

    function renderStatsContent() {
        const body = document.getElementById('modal-stats-body');
        body.innerHTML = '';
        const t = langData[currentLang] || langData['en'];

        // 1. ОПРЕДЕЛЕНИЕ ВРЕМЕННОГО ДИАПАЗОНА
        const now = new Date();
        const nowTs = now.getTime();
        const oneDay = 86400000;
        
        let cutoffTime = 0;   // Начало периода
        let endTime = nowTs;   // Конец периода (по умолчанию - сейчас)
        let rangeText = "";

        // Логика выбора границ времени
        if (currentStatsTimeframe === 'custom' && customRangeStart) {
            // Режим календаря
            cutoffTime = customRangeStart.getTime();
            // Устанавливаем конец дня для выбранной конечной даты (или начальной, если выбрана одна)
            const end = new Date(customRangeEnd || customRangeStart);
            end.setHours(23, 59, 59, 999);
            endTime = end.getTime();
        } else {
            // Стандартные пресеты
            if (currentStatsTimeframe === 'week') cutoffTime = nowTs - (7 * oneDay);
            else if (currentStatsTimeframe === 'month') cutoffTime = nowTs - (30 * oneDay);
            else if (currentStatsTimeframe === 'year') cutoffTime = nowTs - (365 * oneDay);
            else cutoffTime = 0; // "Всё время" (если вдруг осталось)
        }

        // Хелпер для красивого вывода даты под заголовком
        const formatDate = (ts) => {
            const d = new Date(ts);
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const year = d.getFullYear();
            return `${day}.${month}.${year}`;
        };

        // Формируем текст диапазона для заголовка модалки
        if (currentStatsTimeframe === 'all' && !customRangeStart) {
            rangeText = t.tf_all || "All Time";
        } else {
            const startStr = formatDate(cutoffTime > 0 ? cutoffTime : (activityLog.length > 0 ? activityLog[0].ts : nowTs));
            const endStr = formatDate(endTime);
            rangeText = `${startStr} — ${endStr}`;
        }

        // Обновляем плашку с датами сверху
        let dateHeader = document.getElementById('stats-date-display');
        if (!dateHeader) {
            body.insertAdjacentHTML('beforebegin', `<div id="stats-date-display" class="stats-date-range"></div>`);
            dateHeader = document.getElementById('stats-date-display');
        }
        dateHeader.innerText = rangeText;
        dateHeader.style.animation = 'none';
        dateHeader.offsetHeight; // trigger reflow
        dateHeader.style.animation = 'fadeInUp 0.3s forwards';

        // --- ВАРИАНТ А: ТЕГИ (PREFERENCES) ---
        if (currentStatsTab === 'tags') {
            const tempScores = {};
            const IGNORED_TAGS = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd'];
            
            // Фильтруем логи строго по выбранному диапазону
            activityLog.forEach(log => {
                if (log.ts < cutoffTime || log.ts > endTime) return;

                if (log.tags) {
                    let weight = 0;
                    if (log.type === 'watch') weight = 10;
                    else if (log.type === 'like' || log.type === 'similar') weight = 5;
                    else if (log.type === 'dislike') weight = -1.5;

                    if (weight !== 0) {
                        log.tags.forEach(tag => {
                            if(!IGNORED_TAGS.includes(tag)) {
                                tempScores[tag] = (tempScores[tag] || 0) + weight;
                            }
                        });
                    }
                }
            });


            const sortedTags = Object.entries(tempScores)
                .sort((a, b) => b[1] - a[1])
                .filter(x => x[1] > 0)
                .slice(0, 15); 
            
            let html = `<div class="chart-wrapper fade-visible" style="animation: fadeInUp 0.5s ease;"><div class="chart-scroll-view" id="chart-source-el">`;

            if(sortedTags.length === 0) {
                html += `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                const maxVal = Math.max(...sortedTags.map(x => x[1]));
            
                sortedTags.forEach(([tag, score], index) => {
                    const height = Math.max(10, (score / maxVal) * 90);
                    let displayTag = tag.charAt(0).toUpperCase() + tag.slice(1);
                    if (displayTag.length > 9) displayTag = displayTag.substring(0, 7) + '..';

                    let delay = 0;
                    if (index >= 5) delay = 0.05 + (index * 0.01); 
                    else if (index === 4) delay = 0.2;
                    else if (index === 3) delay = 0.3;
                    else if (index === 2) delay = 0.4;
                    else if (index === 1) delay = 0.5;
                    else if (index === 0) delay = 0.7; 

                    html += `
                        <div class="pref-col">
                            <div class="chart-value-y stagger-text" style="animation-delay:${delay}s">${score}</div>
                            <div class="chart-bar" style="height:0%; animation: growTag${index} 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards ${delay}s;"></div>
                            <div class="chart-label-x stagger-text" title="${tag}" style="animation-delay:${delay}s">${displayTag}</div>
                            <style>@keyframes growTag${index} { from { height: 0%; opacity: 0; } to { height: ${height}%; opacity: 1; } }</style>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            
            html += `
                <div class="stats-legend-row stagger-text" style="animation-delay:0.5s">
                    <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> ${t.legend_watch}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--text-main)"></div> ${t.legend_like}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--highlight-red)"></div> ${t.legend_dislike}</div>
                </div>
            `;
            
            body.innerHTML = html;
        } 
        
        // --- ВАРИАНТ Б: АКТИВНОСТЬ (ACTIVITY) ---
        else {
            const aggregated = {};
            
            // Сет для отслеживания уникальности в рамках текущей истории логов
            const encounteredIdsInLog = new Set();

            const getDateKey = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') return `${d.getFullYear()}-${d.getMonth()}`;
                return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            };

            const getLabel = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') {
                    return d.toLocaleDateString(currentLang, { month: 'short' }).replace('.', '');
                }
                return d.toLocaleDateString(currentLang, { day: 'numeric', month: 'numeric' });
            };

            // 1. Сбор данных
            const sortedLogs = [...activityLog].sort((a, b) => a.ts - b.ts);

            sortedLogs.forEach(log => {
                const key = getDateKey(log.ts);
                
                // Инициализация бакета даты (если в диапазоне)
                if (log.ts >= cutoffTime) {
                    if (!aggregated[key]) aggregated[key] = { newItems: 0, watch: 0, time: 0, label: getLabel(log.ts), sort: log.ts };
                }

                // --- Считаем только НОВЫЕ ---
                // Если это генерация или просмотр, и мы еще не видели этот ID в логах
                if (['gen', 'watch'].includes(log.type)) {
                    if (!encounteredIdsInLog.has(log.id)) {
                        encounteredIdsInLog.add(log.id);
                        
                        // Засчитываем в статистику ТОЛЬКО если дата входит в выбранный диапазон
                        if (log.ts >= cutoffTime && aggregated[key]) {
                            aggregated[key].newItems++;
                        }
                    }
                }

                if (log.type === 'watch' && log.ts >= cutoffTime && aggregated[key]) {
                    aggregated[key].watch++;
                }
            });

            // Добавляем время просмотра из истории просмотров
            watchHistory.forEach(entry => {
                if (entry.timestamp < cutoffTime) return;
                const key = getDateKey(entry.timestamp);
                // Если бакета еще нет (например, смотрел, но не генерировал новое), создаем
                if (!aggregated[key]) aggregated[key] = { newItems: 0, watch: 0, time: 0, label: getLabel(entry.timestamp), sort: entry.timestamp };
                
                aggregated[key].time += entry.seconds;
                // Синхронизируем кол-во просмотров, если вдруг в логах не было
                if (aggregated[key].watch === 0) aggregated[key].watch++;
            });

            const chartData = Object.values(aggregated).sort((a, b) => a.sort - b.sort);
            
            let html = `<div class="chart-wrapper fade-visible"><div class="chart-scroll-view" id="chart-source-el" style="justify-content: flex-start; padding-left: 5px;">`;

            if (chartData.length === 0) {
                html += `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                // ===  ЛОГИКА МАСШТАБИРОВАНИЯ ===
                let globalMax = 0;
                chartData.forEach(d => {
                    const minutes = Math.round(d.time / 60);
                    // Сравниваем Новые, Просмотры и Минуты
                    const localMax = Math.max(d.newItems, d.watch, minutes);
                    if (localMax > globalMax) globalMax = localMax;
                });
                if (globalMax < 5) globalMax = 5;

                const gradGrey = `linear-gradient(180deg, #bdc3c7 0%, #7f8c8d 100%)`; // Светло-серый для "New"
                const gradAccent = `linear-gradient(180deg, var(--accent-light) 0%, var(--accent) 100%)`;
                const gradPurple = `linear-gradient(180deg, #d2b4de 0%, #8e44ad 100%)`;

                chartData.forEach((d, index) => {
                    const timeMin = Math.round(d.time / 60);

                    const hNew = (d.newItems / globalMax) * 100;
                    const hWatch = (d.watch / globalMax) * 100;
                    const hTime = (timeMin / globalMax) * 100;
                    
                    const delay = index * 0.05;

                    html += `
                        <div class="act-col" style="min-width: 85px; margin-right: 5px;">
                            <div class="act-bars-group">
                                <!-- Новые (Серый) -->
                                <div class="act-bar" style="background:${gradGrey}; height:0%; opacity:0.8; animation: growBarH${index} 0.6s forwards ${delay}s;"></div>
                                <!-- Просмотры (Акцент) -->
                                <div class="act-bar" style="background:${gradAccent}; height:0%; animation: growBarW${index} 0.6s forwards ${delay+0.1}s;"></div>
                                <!-- Время (Фиолетовый) -->
                                <div class="act-bar" style="background:${gradPurple}; height:0%; animation: growBarT${index} 0.6s forwards ${delay+0.2}s;"></div>
                            </div>
                            <style>
                                @keyframes growBarH${index} { to { height: ${d.newItems > 0 ? Math.max(4, hNew) : 0}%; } }
                                @keyframes growBarW${index} { to { height: ${d.watch > 0 ? Math.max(4, hWatch) : 0}%; } }
                                @keyframes growBarT${index} { to { height: ${timeMin > 0 ? Math.max(4, hTime) : 0}%; } }
                            </style>

                            <div class="act-values-row stagger-text" style="animation-delay:${delay + 0.3}s">
                                <span class="act-val" style="color:var(--text-secondary); font-weight:700;">${d.newItems}</span>
                                <span class="act-val" style="color:var(--text-main);">${d.watch}</span>
                                <span class="act-val" style="color:#9b59b6;">${timeMin}</span>
                            </div>

                            <div class="chart-label-x stagger-text" style="animation-delay:${delay + 0.3}s; font-size:11px;">${d.label}</div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;

            // Тексты для легенды
            let legendUnit = currentLang === 'ru' ? 'мин' : 'min';
            let legendNew = currentLang === 'ru' ? 'Открытые фетиши' : 
                            (currentLang === 'es' ? 'Explorados' : 
                            (currentLang === 'de' ? 'Entdeckt' : 'Explored'));

            html += `
                <div class="stats-legend-row stagger-text" style="margin-top:10px; animation-delay:0.5s;">
                    <div class="legend-item"><div class="legend-dot" style="background:#bdc3c7"></div> ${legendNew}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> ${t.act_watches}</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#9b59b6"></div> ${t.act_time} (${legendUnit})</div>
                </div>
            `;

            body.innerHTML = html;
        }
        // Авто-скролл к последней дате для вкладки активности
        if (currentStatsTab === 'activity') {
            const scrollView = document.getElementById('chart-source-el');
            if (scrollView) {
                // Небольшая задержка, чтобы браузер успел отрисовать элементы и рассчитать ширину
                setTimeout(() => {
                    scrollView.scrollTo({
                        left: scrollView.scrollWidth,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
    }

    function shareCanvasImage(canvas, filename) {
        canvas.toBlob(async (blob) => {
            const file = new File([blob], filename, { type: "image/png" });
            const shareData = {
                files: [file],
                title: 'xFetishHub Stats',
                text: 'Check my stats! 🔥'
            };

            // Проверяем, поддерживает ли браузер шеринг файлов
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                    console.log("Shared successfully");
                } catch (err) {
                    // Если пользователь просто нажал "Отмена" в меню, ничего не делаем
                    if (err.name !== 'AbortError') {
                        console.error("Share error:", err);
                        // Если произошла реальная ошибка — скачиваем по старинке
                        downloadFallback(canvas, filename);
                    }
                }
            } else {
                // Если браузер не умеет (например, ПК) — скачиваем файл
                downloadFallback(canvas, filename);
            }
        });
    }

    function downloadFallback(canvas, filename) {
        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    function shareStats() {
        if(navigator.vibrate) navigator.vibrate(50);

        // 1. СОБИРАЕМ ОБЩИЕ ДАННЫЕ
        const t = langData[currentLang] || langData['en'];
        const themeId = localStorage.getItem('xch_theme_id') || 'dark';
        const logoSrc = getThemeLogoSrc(themeId); 
        
        const slogan = t.share_caption || "Discover yourself";
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&data=${encodeURIComponent(window.location.origin)}`;
        
        const now = new Date();
        const pad = (n) => n < 10 ? '0'+n : n;
        const formatDate = (d) => `${pad(d.getDate())}.${pad(d.getMonth()+1)}`;
        let rangeStr = "";
        
        if (currentStatsTimeframe === 'all') rangeStr = "ALL TIME";
        else {
            let days = 7;
            if (currentStatsTimeframe === 'month') days = 30;
            if (currentStatsTimeframe === 'year') days = 365;
            rangeStr = `${formatDate(new Date(now.getTime() - (days * 86400000)))} - ${formatDate(now)}`;
        }

        let chartHtml = '';
        let subTitleText = "";

        // === ВЕТВЛЕНИЕ: ПРЕДПОЧТЕНИЯ ИЛИ АКТИВНОСТЬ ===

        if (currentStatsTab === 'tags') {
            // --- ЛОГИКА ДЛЯ ПРЕДПОЧТЕНИЙ (TAGS) ---
            subTitleText = `TOP 5 ${t.stats_prefs}`;

            const tempScores = {};
            const IGNORED_TAGS = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd'];
            
            activityLog.forEach(log => {
                if (log.tags) {
                    let weight = 0;
                    if (log.type === 'watch') weight = 10;
                    else if (log.type === 'like' || log.type === 'similar') weight = 5;
                    else if (log.type === 'dislike') weight = -5;

                    if (weight !== 0) {
                        log.tags.forEach(tag => {
                            if(!IGNORED_TAGS.includes(tag)) {
                                tempScores[tag] = (tempScores[tag] || 0) + weight;
                            }
                        });
                    }
                }
            });

            const sortedTags = Object.entries(tempScores)
                .sort((a, b) => b[1] - a[1])
                .filter(x => x[1] > 0)
                .slice(0, 5); 

            if(sortedTags.length === 0) {
                chartHtml = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                const maxVal = Math.max(...sortedTags.map(x => x[1]));
                chartHtml = `<div style="display:flex; width:100%; height:100%; align-items:flex-end; justify-content: space-between; padding: 0 10px;">`;
                
                sortedTags.forEach(([tag, score]) => {
                    const height = Math.max(10, (score / maxVal) * 85);
                    let displayTag = tag.charAt(0).toUpperCase() + tag.slice(1);
                    if (displayTag.length > 8) displayTag = displayTag.substring(0, 6) + '..';

                    chartHtml += `
                        <div class="pref-col" style="flex:1; max-width:18%; display:flex; flex-direction:column; align-items:center; justify-content:flex-end;">
                            <div class="chart-value-y" style="margin-bottom:4px; font-weight:800; font-size:12px; color:#fff;">${score}</div>
                            <div class="chart-bar" style="height:${height}%; width:100%; border-radius: 6px 6px 0 0; background:var(--accent); min-height:4px;"></div>
                            <div class="chart-label-x" style="margin-top:6px; font-size:11px; font-weight:600; color:var(--text-secondary);">${displayTag}</div>
                        </div>
                    `;
                });
                chartHtml += `</div>`;
            }

        } else {
            // --- ЛОГИКА ДЛЯ АКТИВНОСТИ (ACTIVITY - EXPORT) ---
            subTitleText = (currentLang === 'ru' ? "ИСТОРИЯ АКТИВНОСТИ" : "ACTIVITY HISTORY");

            const aggregated = {};
            const exportLimit = 7; // Берем последние 7 точек
            
            // Используем ту же логику агрегации, но без фильтра времени (берем всё)
            const getDateKey = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') return `${d.getFullYear()}-${d.getMonth()}`;
                return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            };
            const getLabel = (ts) => {
                const d = new Date(ts);
                if (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') return d.toLocaleDateString(currentLang, { month: 'short' });
                return d.toLocaleDateString(currentLang, { day: 'numeric', month: 'numeric' });
            };

            activityLog.forEach(log => {
                const key = getDateKey(log.ts);
                if (!aggregated[key]) aggregated[key] = { gen: 0, watch: 0, time: 0, label: getLabel(log.ts), sort: log.ts };
                if (['like', 'gen', 'pass', 'dislike'].includes(log.type)) aggregated[key].gen++;
                if (log.type === 'watch') aggregated[key].watch++;
            });

            watchHistory.forEach(entry => {
                const key = getDateKey(entry.timestamp);
                if (!aggregated[key]) aggregated[key] = { gen: 0, watch: 0, time: 0, label: getLabel(entry.timestamp), sort: entry.timestamp };
                aggregated[key].time += entry.seconds;
                if (aggregated[key].watch === 0) aggregated[key].watch++;
            });

            const chartData = Object.values(aggregated).sort((a, b) => a.sort - b.sort).slice(-exportLimit);

            if (chartData.length === 0) {
                chartHtml = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                let maxGen = 5, maxWatch = 3, maxTime = 300;
                chartData.forEach(d => {
                    if (d.gen > maxGen) maxGen = d.gen;
                    if (d.watch > maxWatch) maxWatch = d.watch;
                    if (d.time > maxTime) maxTime = d.time;
                });

                chartHtml = `<div style="display:flex; width:100%; height:100%; align-items:flex-end; justify-content: space-between; padding: 0 10px;">`;

                chartData.forEach(d => {
                    const hGen = (d.gen / maxGen) * 100;
                    const hWatch = (d.watch / maxWatch) * 100;
                    const hTime = (d.time / maxTime) * 100;
                    const timeMin = Math.round(d.time/60);
                    
                    chartHtml += `
                        <div style="flex:1; max-width:13%; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; margin:0 2px;">
                            
                            <!-- График (3 столбика) -->
                            <div style="display:flex; align-items:flex-end; gap:2px; height:75%; width:100%; border-bottom:1px solid rgba(128,128,128,0.2);">
                                <div style="flex:1; background:var(--text-secondary); height:${Math.max(5, hGen)}%; opacity:0.3; border-radius:2px 2px 0 0;"></div>
                                <div style="flex:1; background:var(--accent); height:${Math.max(5, hWatch)}%; border-radius:2px 2px 0 0;"></div>
                                <div style="flex:1; background:#9b59b6; height:${Math.max(5, hTime)}%; border-radius:2px 2px 0 0;"></div>
                            </div>
                            
                            <!-- Цифры -->
                            <div style="display:flex; justify-content:space-between; width:100%; margin-top:2px; font-size:8px; font-weight:700;">
                                <span style="color:var(--text-secondary); opacity:0.7;">${d.gen}</span>
                                <span style="color:var(--text-main);">${d.watch}</span>
                                <span style="color:#9b59b6;">${timeMin}</span>
                            </div>

                            <div class="chart-label-x" style="margin-top:2px; font-size:9px; font-weight:600; color:var(--text-secondary);">${d.label}</div>
                        </div>
                    `;
                });
                chartHtml += `</div>`;
            }
        }

        // 3. СОЗДАЕМ СКРЫТЫЙ КОНТЕЙНЕР (Карточка)
        const exportContainer = document.createElement('div');
        exportContainer.id = 'export-stats-card'; // Использует CSS стили
        
        const headerHTML = `
            <div class="export-header">
                <div style="display:flex; flex-direction:column;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <img src="${logoSrc}" style="height:32px;">
                        <div style="font-size:24px; font-weight:900; color:var(--text-main); line-height:1;">
                            x<span style="color:var(--accent); background:none; -webkit-text-fill-color:initial;">Fetish</span>Hub
                        </div>
                    </div>
                    <div style="font-size:10px; text-transform:uppercase; color:var(--text-secondary); margin-left:42px; letter-spacing:1.5px; margin-top:4px;">${slogan}</div>
                </div>
                <div style="background:#fff; padding:4px; border-radius:8px; width:54px; height:54px; display:flex; align-items:center; justify-content:center;">
                    <img src="${qrUrl}" style="width:100%; height:100%; display:block;">
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:-5px;">
                <span style="font-size:12px; color:var(--text-secondary); font-weight:700;">${rangeStr}</span>
                <span style="font-size:12px; color:var(--accent); font-weight:800; text-transform:uppercase;">
                    ${subTitleText}
                </span>
            </div>
            
            <div class="chart-wrapper" style="height:220px; border:none; margin:0; padding:0; display:flex; align-items:flex-end;">
                ${chartHtml}
            </div>
        `;

        exportContainer.innerHTML = headerHTML;
        document.body.appendChild(exportContainer);

        // 4. ДЕЛАЕМ СКРИНШОТ
        html2canvas(exportContainer, {
            backgroundColor: null,
            scale: 2,
            useCORS: true,
            allowTaint: true
        }).then(canvas => {
            document.body.removeChild(exportContainer);
            shareCanvasImage(canvas, `xfetish-stats-${Date.now()}.png`);
        }).catch(e => {
            console.error(e);
            if(document.body.contains(exportContainer)) document.body.removeChild(exportContainer);
            alert("Error creating image");
        });
    }

    function openSupportModal() {
        const t = langData[currentLang];
        const contentDiv = document.getElementById('support-content');
        
        contentDiv.innerHTML = `
            <p>${t.support_intro}</p>
            <p>${t.support_why}</p>
            <h4 style="color:var(--text-main); margin:15px 0 10px 0;">${t.support_roadmap_title}</h4>
            <ul style="padding-left:20px; margin:0;">
                ${t.support_roadmap_list}
            </ul>
        `;
        
        document.getElementById('modal-support-overlay').classList.add('open');
    }
    
    function closeSupport(e, force) {
        if (force || e.target.id === 'modal-support-overlay') {
            document.getElementById('modal-support-overlay').classList.remove('open');
        }
    }

    function closeStats(e, force) {
        if (force || e.target.id === 'modal-stats-overlay') {
            document.getElementById('modal-stats-overlay').classList.remove('open');
            if (wrappedTimerInterval) {
                clearInterval(wrappedTimerInterval);
                wrappedTimerInterval = null;
            }
        }
    }

    function initAgeGate() {
        const isVerified = localStorage.getItem('xch_age_verified');

        if (!isVerified) {
            // Если возраст не подтвержден - показываем Age Gate
            document.getElementById('age-gate').classList.add('open');
        } else {
            // Если подтвержден - запускаем цепочку проверок
            runStartupChecks();
        }
    }

    function passAgeGate() {
        localStorage.setItem('xch_age_verified', 'true');
        document.getElementById('age-gate').classList.remove('open');
        runStartupChecks();
    }

    function runStartupChecks() {
        const isMobile = window.innerWidth < 768; // Проверка на мобильность
        const isInstalled = isAppInstalled();
        const isSkipped = sessionStorage.getItem('xch_install_skipped'); // Проверка, пропускали ли в этой сессии

        // ЦЕПОЧКА:
        // 1. Мобилка? НЕ установлено? НЕ пропускали? -> Показать Install Modal
        // 2. Иначе -> Проверить Onboarding Preferences

        if (isMobile && !isInstalled && !isSkipped) {
            document.getElementById('modal-install-overlay').classList.add('open');
        } else {
            checkOnboarding();
        }
    }

    function blockAccess() {
        document.getElementById('age-block').style.display = 'flex';
        // На всякий случай блокируем скролл и всё остальное
        document.body.style.overflow = 'hidden';
    }

    function skipOnboarding() {
        localStorage.setItem('xch_onboarding_done', 'true');
        document.getElementById('onboarding-overlay').classList.remove('open');
        
        setTimeout(() => {
            document.getElementById('modal-promo-tips-overlay').classList.add('open');
        }, 300);
    }

    function processOnboardingText() {
        const inputField = document.getElementById('onb-input');
        // Очищаем от лишних пробелов и знаков препинания
        let text = inputField.value.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ");
        
        if (!text.trim()) return;

        const container = document.getElementById('onb-tags-container');
        container.innerHTML = ''; 
        document.getElementById('onb-results').style.display = 'flex';

        // 1. ТРИГГЕРЫ НАСТРОЕНИЯ
        const triggers = {
            negative: ["hate", "dislike", "no ", "don't", "except", "ненавижу", "не люблю", "без ", "кроме", "фу", "не хочу", "не нрав", "odio", "no me gusta", "sin ", "hasse", "ohne", "kein"],
            positive: ["like", "love", "want", "prefer", "enjoy", "люблю", "хочу", "нравится", "обожаю", "давай", "amo", "quiero", "me gusta", "mag", "liebe", "will"]
        };

        // Временные сеты для избежания дубликатов в рамках одного запуска
        let foundLikes = new Set();
        let foundDislikes = new Set();
        let totalCount = 0;
        const MAX_TOTAL_RESULTS = 10;

        // Разбиваем ввод на слова (токены)
        const tokens = text.split(/\s+/).filter(w => w.length > 2);

        // --- ЛОГИКА ПОИСКА ПО СЛОВАМ ---
        tokens.forEach((token, index) => {
            // Если лимит превышен, прекращаем поиск
            if (totalCount >= MAX_TOTAL_RESULTS) return;

            // 1. Определяем настроение для текущего слова
            // Смотрим на предыдущие 2 слова, нет ли там триггера
            let mood = 'like';
            const contextStr = tokens.slice(Math.max(0, index - 2), index + 1).join(" ");
            
            if (triggers.negative.some(neg => contextStr.includes(neg))) {
                mood = 'dislike';
            }

            // 2. Поиск кандидатов для ЭТОГО слова
            let candidates = [];

            // Проверяем все предметы в базе
            data.forEach(item => {
                let matchScore = 0;

                // А. Проверка названия (Точное совпадение = высокий балл)
                const names = [item.name, item.name_ru, item.name_es, item.name_de, item.slug].filter(n => n);
                if (names.some(n => n.toLowerCase() === token)) matchScore = 100; // Точное совпадение
                else if (names.some(n => isFuzzyMatch(token, n))) matchScore = 50; // Нечеткое совпадение названия

                // Б. Проверка алиасов (Пышки -> BBW)
                if (matchScore === 0) {
                    for (const [key, aliases] of Object.entries(KEYWORD_ALIASES)) {
                        // Если токен похож на алиас (например "пышек" ~ "пышки")
                        if (key === token || aliases.some(alias => isFuzzyMatch(token, alias))) {
                            // И если этот предмет содержит этот ключевой тег или слово в названии
                            if (item.tags.includes(key) || names.some(n => n.toLowerCase().includes(key))) {
                                matchScore = 40; 
                            }
                        }
                    }
                }

                // В. Проверка тегов (низкий приоритет, чтобы "Anal" не выводил всё подряд)
                if (matchScore === 0 && item.tags.includes(token)) {
                    matchScore = 20;
                }

                if (matchScore > 0) {
                    candidates.push({ item: item, score: matchScore });
                }
            });

            // 3. Сортировка и Лимит для слова
            // Берем только топ-2 результата для этого слова
            candidates.sort((a, b) => b.score - a.score);
            const topMatches = candidates.slice(0, 2);

            // 4. Добавление в результаты
            topMatches.forEach(match => {
                if (totalCount >= MAX_TOTAL_RESULTS) return;

                const id = match.item.id;
                
                // Проверка на дубликаты (чтобы не добавить то, что уже есть в глобальных массивах)
                if (onbFoundLikes.includes(id) || onbFoundDislikes.includes(id) || foundLikes.has(id) || foundDislikes.has(id)) return;

                if (mood === 'like') {
                    onbFoundLikes.push(id);
                    foundLikes.add(id);
                } else {
                    onbFoundDislikes.push(id);
                    foundDislikes.add(id);
                }
                totalCount++;
            });
        });

        // --- РЕНДЕР ---
        onbFoundLikes.forEach(id => {
            const item = data.find(x => x.id === id);
            if(item) renderOnbTag(item, container, 'like');
        });
        
        onbFoundDislikes.forEach(id => {
            const item = data.find(x => x.id === id);
            if(item) renderOnbTag(item, container, 'dislike');
        });

        if (onbFoundLikes.length === 0 && onbFoundDislikes.length === 0) {
             container.innerHTML = '<span class="onb-error" style="color:var(--text-secondary); font-size:13px; width:100%; text-align:center; padding:10px;">Nothing found. Try simpler words.</span>';
        }
        
        inputField.value = "";
    }

    function renderOnbTag(item, container, type) {
        const name = getLocalizedName(item);
        const div = document.createElement('div');
        
        // Добавляем класс типа (like/dislike)
        div.className = `onb-tag ${type}`;
        
        // Добавляем иконку
        const icon = type === 'like' ? '💚' : '⛔';
        
        div.innerHTML = `
            ${icon} ${name}
            <span class="onb-tag-remove" style="cursor:pointer; opacity:0.6; margin-left:5px;" onclick="removeOnbTag(${item.id}, '${type}', this)">✕</span>
        `;
        container.appendChild(div);
    }

    function removeOnbTag(id, type, el) {
        if (type === 'like') {
            onbFoundLikes = onbFoundLikes.filter(x => x !== id);
        } else {
            onbFoundDislikes = onbFoundDislikes.filter(x => x !== id);
        }
        el.parentElement.remove();
    }

    function finishOnboarding() {
        let changed = false;

        if (typeof onbFoundLikes !== 'undefined' && onbFoundLikes.length > 0) {
            onbFoundLikes.forEach(id => {
                if (!favorites.includes(id)) {
                    favorites.push(id);
                    
                    // === ЗАЩИТА: Добавляем в защищенный список ===
                    if (!protectedFavorites.includes(id)) {
                        protectedFavorites.push(id);
                    }
                    // ============================================

                    blacklist = blacklist.filter(x => x !== id);
                    const item = data.find(x => x.id === id);
                    if (item) {
                        adjustTagScores(item, 5);
                        logActivity('like', item.id, item.tags);
                    }
                }
            });
            changed = true;
            // Сохраняем защищенный список
            localStorage.setItem('xch_protected_favorites', JSON.stringify(protectedFavorites));
        }

        if (typeof onbFoundDislikes !== 'undefined' && onbFoundDislikes.length > 0) {
            onbFoundDislikes.forEach(id => {
                if (!blacklist.includes(id)) {
                    blacklist.push(id);
                    favorites = favorites.filter(x => x !== id);
                    const item = data.find(x => x.id === id);
                    if (item) {
                        adjustTagScores(item, -10);
                        logActivity('dislike', item.id, item.tags);
                    }
                }
            });
            changed = true;
        }
        
        if (changed) {
            saveLists();
            updateCounts();
            if (window.markDirty) window.markDirty();
        }
        
        // Сохраняем флаг, что онбординг пройден
        localStorage.setItem('xch_onboarding_done', 'true');
        
        // Закрываем окно онбординга
        document.getElementById('onboarding-overlay').classList.remove('open');

        // Делаем небольшую задержку (300мс) для плавности
        setTimeout(() => {
            document.getElementById('modal-promo-tips-overlay').classList.add('open');
        }, 300);
    }

    function resetAppHistory() {
        const t = langData[currentLang] || langData['en'];
        
        if (confirm(t.confirm_reset)) {
            // 1. ОЧИСТКА LOCAL STORAGE
            const keysToRemove = [
                STORAGE.HISTORY, 
                STORAGE.ACTIVITY_LOG, 
                STORAGE.TAG_SCORES, 
                STORAGE.BLACKLIST, 
                STORAGE.FAVORITES, 
                STORAGE.WATCH_LATER, 
                STORAGE.WATCH_HISTORY,
                'xch_permanent_explored', // Счетчик открытых фетишей
                'xch_active_days',        // Прогресс Wrapped (дни)
                'xch_wrapped_archive',    // Архив Wrapped
                'xch_achievement_dates',  // Даты ачивок
                'xch_viewed_tips',        // Прочитанные советы
                'xch_last_archive_check',
                'xch_protected_favorites'
            ];
            
            keysToRemove.forEach(k => localStorage.removeItem(k));
            
            // 2. СБРОС ГЛОБАЛЬНЫХ ПЕРЕМЕННЫХ (В ПАМЯТИ)
            historyData = [];
            activityLog = [];
            tagScores = {};
            blacklist = [];
            favorites = [];
            watchLater = [];
            watchHistory = [];
            protectedFavorites = [];
            
            // Важные сбросы
            permanentExplored = new Set(); // Сброс счетчика фетишей
            activeDaysSet = new Set();     // Сброс прогресса дней
            wrappedArchive = [];           // Сброс архива
            achievementDates = {};
            viewedTips = [];               // Сброс подсказок
            
            // 3. ОБНОВЛЕНИЕ ИНТЕРФЕЙСА
            updateCounts();
            updateExploredCount(); // Обновляет цифру "0 / 1200"
            renderHistory();
            checkTipIcons();       // Возвращает знаки вопроса (?)
            
            // Сброс UI статистики и Wrapped
            const progressUI = document.getElementById('wrapped-progress-ui');
            if (progressUI) progressUI.remove();
            
            const wBtn = document.getElementById('btn-wrapped-trigger');
            if (wBtn) wBtn.style.display = 'none';

            // Если открыто окно статистики, обновляем его содержимое (чтобы исчез график)
            const statsBody = document.getElementById('modal-stats-body');
            if (statsBody && document.getElementById('modal-stats-overlay').classList.contains('open')) {
                renderStatsContent();
                openStatistics(); // Перерисовываем прогресс-бар (покажет 0/7)
            }

            // 4. СИНХРОНИЗАЦИЯ С ОБЛАКОМ (Отправляем пустые данные)
            if (window.isUserLoggedIn) {
                // Принудительная отправка немедленно
                window.syncToCloud(true);
            }
            
            alert(t.reset_done);
        }
    }

    function openResetModal() {
        // Сбрасываем чекбоксы при открытии (для безопасности)
        document.getElementById('chk-reset-fav').checked = false;
        document.getElementById('chk-reset-ban').checked = false;
        document.getElementById('chk-reset-hist').checked = false;
        document.getElementById('chk-reset-algo').checked = false;
        document.getElementById('chk-reset-expl').checked = false;
        
        // Скрываем предыдущее модальное окно (если открыто окно синхронизации)
        closeSyncInfoModal(null, true);
        
        document.getElementById('modal-reset-selection').classList.add('open');
    }

    function closeResetModal(e, force) {
        if (force || e.target.id === 'modal-reset-selection') {
            document.getElementById('modal-reset-selection').classList.remove('open');
        }
    }

    async function performPartialReset() {
        const resetFav = document.getElementById('chk-reset-fav').checked;
        const resetBan = document.getElementById('chk-reset-ban').checked;
        const resetHist = document.getElementById('chk-reset-hist').checked;
        const resetAlgo = document.getElementById('chk-reset-algo').checked;
        const resetExpl = document.getElementById('chk-reset-expl').checked;

        // Если ничего не выбрано
        if (!resetFav && !resetBan && !resetHist && !resetAlgo && !resetExpl) {
            return;
        }

        const t = langData[currentLang] || langData['en'];
        
        if (!confirm(t.confirm_reset || "Are you sure?")) return;

        // 1. ЛАЙКИ
        if (resetFav) {
            favorites = favorites.filter(id => protectedFavorites.includes(id)); 
            favorites = []; 
            localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
            
            for (const id in itemScores) {
                if (itemScores[id] > 0) delete itemScores[id];
            }
            localStorage.setItem('xch_item_scores', JSON.stringify(itemScores));
        }

        // 2. ДИЗЛАЙКИ
        if (resetBan) {
            blacklist = [];
            localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
            
            // Очистка очков < 0
            for (const id in itemScores) {
                if (itemScores[id] < 0) delete itemScores[id];
            }
            localStorage.setItem('xch_item_scores', JSON.stringify(itemScores));
        }

        // 3. ИСТОРИЯ (Свайпы + Просмотры + Wrapped)
        if (resetHist) {
            historyData = [];
            watchHistory = [];
            activityLog = [];
            wrappedArchive = [];
            
            localStorage.setItem(STORAGE.HISTORY, JSON.stringify([]));
            localStorage.setItem(STORAGE.WATCH_HISTORY, JSON.stringify([]));
            localStorage.setItem(STORAGE.ACTIVITY_LOG, JSON.stringify([]));
            localStorage.setItem('xch_wrapped_archive', JSON.stringify([]));
            localStorage.setItem('xch_active_days', JSON.stringify([]));
            
            // Сбрасываем кнопку Wrapped
            const wBtn = document.getElementById('btn-wrapped-trigger');
            if (wBtn) wBtn.style.display = 'none';
        }

        // 4. АЛГОРИТМ (Веса тегов)
        if (resetAlgo) {
            tagScores = {};
            localStorage.setItem(STORAGE.TAG_SCORES, JSON.stringify({}));
        }

        // 5. ОТКРЫТЫЕ ФЕТИШИ (Explored)
        if (resetExpl) {
            permanentExplored = new Set();
            achievementDates = {};
            localStorage.setItem('xch_permanent_explored', JSON.stringify([]));
            localStorage.setItem('xch_achievement_dates', JSON.stringify({}));
        }

        // ОБНОВЛЕНИЕ UI
        updateCounts();
        updateExploredCount();
        renderHistory();
        updateActionButtons(); // Если текущая карточка была лайкнута, кнопка должна стать серой
        
        // Синхронизация с облаком (если залогинен)
        if (window.isUserLoggedIn) {
            const btn = document.querySelector('#modal-reset-selection .btn-gen');
            const oldText = btn.innerText;
            btn.innerText = "Syncing...";
            
            await window.syncToCloud(true); // Принудительная отправка
            
            btn.innerText = oldText;
        }

        closeResetModal(null, true);
        alert(t.reset_done || "Done.");
        
        // Если сбросили алгоритм или историю — лучше перезагрузить страницу, 
        // чтобы слоты генератора обновились
        if (resetAlgo || resetHist) {
            location.reload();
        }
    }

    function openSubModal() {
        // 1. Находим кнопки
        const btnFree = document.querySelector('.plan-card:nth-child(1) .plan-btn'); 
        const btnPro = document.querySelector('.plan-card.pro .plan-btn');
        const btnBeast = document.querySelector('.plan-card.beast .plan-btn');
        const btnBestie = document.querySelector('.plan-card.bestie .plan-btn');

        // 2. Получаем переводы
        const t = langData[currentLang] || langData['en'];

        const tCurrent = t.btn_current || "Current Plan";
        const tExtend = currentLang === 'ru' ? "Продлить" : "Extend"; // Текст для продления
        const tUpgrade = currentLang === 'ru' ? "Улучшить" : "Upgrade"; // Текст для апгрейда
        
        const tPro = t.btn_get_pro || "Get Pro";
        const tBeast = t.btn_get_beast || "Unleash Beast";
        const tBestie = t.btn_get_bestie || "Get Forever"; 

        // Helper: Настройка кнопки
        const configureBtn = (btn, state, buyText, planType) => {
            if (!btn) return; 
            btn.onclick = null;
            btn.classList.remove('current', 'pro-btn', 'beast-btn', 'bestie-btn');
            btn.disabled = false; // По умолчанию активна
            
            if (state === 'current') {
                // ТЕПЕРЬ ТЕКУЩИЙ ПЛАН МОЖНО ПРОДЛИТЬ
                // (Кроме Bestie, он навсегда)
                if (planType === 'bestie') {
                    btn.disabled = true;
                    btn.classList.add('current');
                    btn.innerText = "Purchased";
                } else {
                    // Это Pro или Beast — даем продлить
                    if (btn.closest('.pro')) btn.classList.add('pro-btn');
                    if (btn.closest('.beast')) btn.classList.add('beast-btn');
                    btn.innerText = tExtend; // "Extend"
                    btn.onclick = () => openPaymentSelection(planType);
                }
            } 
            else if (state === 'lower') {
                btn.disabled = true;
                btn.classList.add('current'); 
                btn.innerText = "Included"; // Или галочка       
            } 
            else { // 'buy' или 'upgrade'
                if (btn.closest('.pro')) btn.classList.add('pro-btn');
                if (btn.closest('.beast')) btn.classList.add('beast-btn');
                if (btn.closest('.bestie')) btn.classList.add('bestie-btn');
                
                // Если это апгрейд, пишем Upgrade, иначе стандартный текст
                btn.innerText = state === 'upgrade' ? tUpgrade : buyText;
                btn.onclick = () => openPaymentSelection(planType);
            }
        };

        // ЛОГИКА ОТОБРАЖЕНИЯ
        if (subscriptionLevel === 'bestie') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'lower', null, null);
            configureBtn(btnBeast, 'lower', null, null);
            configureBtn(btnBestie, 'current', null, 'bestie');
        }
        else if (subscriptionLevel === 'beast') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'lower', null, null);
            configureBtn(btnBeast, 'current', null, 'beast'); // Можно продлить
            configureBtn(btnBestie, 'upgrade', tBestie, 'bestie'); 
        } 
        else if (subscriptionLevel === 'pro') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'current', null, 'pro'); // Можно продлить
            configureBtn(btnBeast, 'upgrade', tBeast, 'beast'); // Апгрейд
            configureBtn(btnBestie, 'upgrade', tBestie, 'bestie');
        } 
        else {
            // Free user
            configureBtn(btnFree, 'current', null, null);
            if(btnFree) { btnFree.disabled = true; btnFree.innerText = tCurrent; }

            configureBtn(btnPro, 'buy', tPro, 'pro');
            configureBtn(btnBeast, 'buy', tBeast, 'beast');
            configureBtn(btnBestie, 'buy', tBestie, 'bestie');
        }

        renderDiscountedPrices(); 

        document.getElementById('modal-sub-overlay').classList.add('open');
    }

    function calculateDiscountedPrice(originalPrice, planType) {
        if (!activeDiscount) return null;
        
        // Проверяем, подходит ли скидка этому плану
        const matches = activeDiscount.planTarget === 'all' || activeDiscount.planTarget === planType;
        if (!matches) return null;

        let newPrice = originalPrice;
        if (activeDiscount.type === 'fixed') {
            newPrice = activeDiscount.value;
        } else {
            newPrice = originalPrice * (1 - (activeDiscount.value / 100));
        }
        
        return Math.round(newPrice * 100) / 100; // Округление
    }

    async function handleNotificationToggle(isChecked) {
        const t = langData[currentLang] || langData['en'];
        const toggle = document.getElementById('badge-toggle');

        if (isChecked) {
            // Если включают
            if (!("Notification" in window)) {
                alert("This browser does not support notifications");
                toggle.checked = false;
                return;
            }

            const permission = await Notification.requestPermission();

            if (permission === 'granted') {
                if (typeof updateAppBadge === 'function') {
                    updateAppBadge();
                }
                // Можно не бесить алертом, а просто оставить свитч включенным
                console.log("Notifications granted");
            } else {
                // Если отказал — выключаем свитч обратно
                alert(t.badge_denied_msg);
                toggle.checked = false;
            }
        } else {
            // Если выключают — просто очищаем бейдж
            if ('clearAppBadge' in navigator) {
                navigator.clearAppBadge();
            }
        }
    }

    function checkNotificationState() {
        const toggle = document.getElementById('badge-toggle');
        if (toggle && Notification.permission === 'granted') {
            toggle.checked = true;
        }
    }

    function checkLoyaltyStatus() {
        // 1. Условия показа
        const isFree = subscriptionLevel === 'free';
        const activeDays = new Set(JSON.parse(localStorage.getItem('xch_active_days') || '[]')).size;
        const hasSeenRecently = localStorage.getItem('xch_loyalty_shown_ts');
        const now = Date.now();

        // Показываем, если:
        // - Есть активная скидка на PRO (или ALL)
        // - Пользователь бесплатный
        // - Заходил хотя бы в 3 разные дня (лояльный)
        // - Не видел это окно последние 3 дня
        
        const isDiscountForPro = activeDiscount && (activeDiscount.planTarget === 'all' || activeDiscount.planTarget === 'pro');
        
        if (isDiscountForPro && isFree && activeDays >= 3) {
            if (!hasSeenRecently || (now - parseInt(hasSeenRecently) > 3 * 24 * 60 * 60 * 1000)) {
                openLoyaltyModal();
            }
        }
    }

    function openLoyaltyModal() {
        const modal = document.getElementById('modal-loyalty-overlay');
        const priceSpan = document.getElementById('loyal-price');
        const textP = document.querySelector('[data-key="loyal_text"]');
        
        // Рассчитываем цену Pro
        const newPrice = calculateDiscountedPrice(2.99, 'pro');
        
        // Формируем текст с ценой
        const t = langData[currentLang] || langData['en'];
        let rawText = t.loyal_text;
        rawText = rawText.replace('{price}', `$${newPrice}`);
        
        textP.innerHTML = rawText;

        // Запускаем таймер скидки
        startLoyaltyTimer(activeDiscount.expiresAt);

        modal.classList.add('open');
        
        // Записываем, что показали
        localStorage.setItem('xch_loyalty_shown_ts', Date.now());
    }

    function closeLoyaltyModal() {
        document.getElementById('modal-loyalty-overlay').classList.remove('open');
    }

    function acceptLoyaltyOffer() {
        closeLoyaltyModal();
        // Открываем окно оплаты сразу на Pro
        openPaymentSelection('pro');
    }

    function startLoyaltyTimer(expiresAt) {
        const el = document.getElementById('loyal-timer');
        
        const update = () => {
            const diff = expiresAt - Date.now();
            if (diff <= 0) {
                el.innerText = "00:00:00";
                return;
            }
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            el.innerText = `${h}h ${m}m ${s}s`;
        };
        
        update();
        setInterval(update, 1000);
    }

    function toggleCryptoView(viewName) {
        const main = document.getElementById('crypto-main-view');
        const guide = document.getElementById('crypto-guide-view');
        const problem = document.getElementById('crypto-problem-view');
        const success = document.getElementById('payment-success-msg');

        // Скрываем всё сначала
        main.style.display = 'none';
        guide.style.display = 'none';
        problem.style.display = 'none';
        success.style.display = 'none';

        // Показываем нужное
        if (viewName === 'guide') {
            guide.style.display = 'block';
        } else if (viewName === 'problem') {
            problem.style.display = 'block';
        } else if (viewName === 'success') {
            success.style.display = 'block';
        } else {
            // Default 'main'
            main.style.display = 'block';
        }
    }

    function switchBilling(cycle) {
        const btnMon = document.getElementById('btn-billing-monthly');
        const btnYear = document.getElementById('btn-billing-yearly');
        
        if (cycle === 'monthly') {
            currentBillingCycle = '1';
            btnMon.classList.add('active');
            btnYear.classList.remove('active');
        } else {
            currentBillingCycle = '12';
            btnYear.classList.add('active');
            btnMon.classList.remove('active');
        }

        renderDiscountedPrices(); 
    }

    // ===  УМНЫЙ РЕНДЕР ЦЕН (СКИДКИ + ТАЙМЕР + ПЕРИОД) ===
    function renderDiscountedPrices() {
        // Если скидок нет или они не загрузились, рендерим базы
        const plans = ['pro', 'beast'];
        const suffix = currentBillingCycle === '1' ? '/ mo' : '/ year';
        const periodKey = currentBillingCycle === '1' ? 'monthly' : 'yearly';

        // Получаем текущую скидку
        // Важно: activeDiscount должен быть глобальной переменной, которую мы загрузили ранее
        const discount = (typeof activeDiscount !== 'undefined' && activeDiscount?.isActive) ? activeDiscount : null;

        // Вычисляем строку времени (Осталось дн:час)
        let timeRemainingStr = "";
        if (discount) {
            const diff = discount.expiresAt - Date.now();
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                // Локализация "Ends in"
                const t = langData[currentLang] || langData['en'];
                const endTxt = currentLang === 'ru' ? "Конец через:" : "Ends in:";
                
                timeRemainingStr = `${endTxt} ${days}d ${hours}h`;
            }
        }

        plans.forEach(planType => {
            const el = document.getElementById(`price-${planType}`);
            const card = el.closest('.plan-card');
            const basePrice = BASE_PRICES[planType][periodKey];
            
            let finalPrice = basePrice;
            let hasDiscount = false;

            // --- РАСЧЕТ СКИДКИ ---
            if (discount) {
                // Проверяем, распространяется ли скидка на этот тариф
                const targetMatches = discount.planTarget === 'all' || discount.planTarget === planType;
                
                if (targetMatches) {
                    if (discount.type === 'fixed') {
                        if (currentBillingCycle === '1') {
                            finalPrice = discount.value;
                            hasDiscount = true;
                        }
                    } else if (discount.type === 'percent') {
                        // Проценты применяются и к месяцу, и к году
                        finalPrice = basePrice * (1 - (discount.value / 100));
                        hasDiscount = true;
                    }
                }
            }

            // Округляем
            finalPrice = Math.round(finalPrice * 100) / 100;

            // Убираем старый бейдж, если есть
            const oldBadge = card.querySelector('.discount-badge-card');
            if(oldBadge) oldBadge.remove();

            // --- РЕНДЕР HTML ---
            if (hasDiscount && finalPrice < basePrice) {
                // ЕСТЬ СКИДКА
                el.innerHTML = `
                    <div class="price-container">
                        <span class="old-price">$${basePrice}</span>
                        <span class="new-price-highlight">$${finalPrice} <span style="font-size:12px; color:var(--text-main); font-weight:400;">${suffix}</span></span>
                        <div class="discount-timer">⏳ ${timeRemainingStr}</div>
                    </div>
                `;

                // Добавляем бейдж "SALE"
                const badge = document.createElement('div');
                badge.className = 'discount-badge-card';
                const badgeText = discount.type === 'percent' ? `-${discount.value}%` : 'SALE 🔥';
                badge.innerText = badgeText;
                card.appendChild(badge);

            } else {
                // НЕТ СКИДКИ (Обычная цена)
                el.innerHTML = `$${basePrice} <span style="font-size:12px">${suffix}</span>`;
            }
        });
    }

    async function openPaymentSelection(type) {
        if (!window.isUserLoggedIn) {
            openLoginModal();
            return;
        }

        let finalPlanId = type;
        
        // Добавляем суффикс, если нужно
        if (type === 'pro' || type === 'beast') {
            finalPlanId = `${type}_${currentBillingCycle}`;
        }

        // Ищем кнопку безопасно. Если type кривой, querySelector не упадет с ошибкой.
        let btn = null;
        try {
            // Убеждаемся, что type существует и является допустимым
            if (type && /^[a-zA-Z0-9_-]+$/.test(type)) {
                btn = document.querySelector(`.plan-btn.${type}-btn`);
            }
        } catch (err) {
            console.warn("Кнопка не найдена или селектор неверен:", type);
        }

        const oldText = btn ? btn.innerText : '';
        if(btn) { btn.innerText = "Creating..."; btn.disabled = true; }

        try {
            const response = await fetch(`${API_BASE_URL}/create-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    uid: window.auth.currentUser.uid,
                    plan: finalPlanId
                })
            });

            if (!response.ok) {
                // Пытаемся прочитать текст ошибки от сервера
                const errText = await response.text();
                throw new Error(`Server Error: ${response.status} ${errText}`);
            }

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            showCryptoModal(data);
            closeSubModal(null, true);

        } catch (e) {
            console.error(e);
            alert("Ошибка соединения: " + e.message);
        } finally {
            if(btn) { btn.innerText = oldText; btn.disabled = false; }
        }
    }

    function showCryptoModal(data) {
        const modal = document.getElementById('modal-crypto-payment');
        
        // Форматируем сумму (оставляем 6 знаков после запятой, если они есть)
        // parseFloat уберет лишние нули на конце (например, 5.000000 -> 5)
        const amountStr = parseFloat(data.amount.toFixed(6));
        
        // Вставляем сумму
        const amountEl = document.getElementById('crypto-amount');
        
        // СОХРАНЯЕМ ЧИСТОЕ ЗНАЧЕНИЕ ДЛЯ КОПИРОВАНИЯ В АТРИБУТ
        amountEl.setAttribute('data-val', amountStr);
        
        // Добавляем иконку копирования визуально
        amountEl.innerHTML = `${amountStr} <span style="font-size:14px">USDT</span> <span style="font-size:14px; opacity:0.6;">📋</span>`;
        amountEl.style.color = "#ff9900"; 

        // --- ДОБАВЛЯЕМ ПРЕДУПРЕЖДЕНИЕ О КОМИССИИ ---
        let warnEl = document.getElementById('fee-warning-box');
        if (!warnEl) {
            warnEl = document.createElement('div');
            warnEl.id = 'fee-warning-box';
            warnEl.style.cssText = "font-size:11px; color:#e74c3c; margin-top:5px; line-height:1.2; padding:0 15px; text-align:right;";
            amountEl.parentNode.parentNode.appendChild(warnEl);
        }
        const t = langData[currentLang] || langData['en'];
        warnEl.innerHTML = t.pay_fee_warn || "⚠️ Fee not included!";
        // -------------------------------------------
        
        document.getElementById('crypto-address').innerText = data.address;
        
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&margin=10&data=${data.address}`;
        document.getElementById('crypto-qr-img').src = qrUrl;

        document.getElementById('payment-status-box').style.display = 'block';
        document.getElementById('payment-success-msg').style.display = 'none';
        toggleCryptoView('main');
        
        modal.classList.add('open');

        startCryptoTimer(data.expiresAt);
        startCryptoPolling(data.invoiceId);
    }

    window.closeCryptoModal = function(e, force) {
        if (force || (e && e.target.id === 'modal-crypto-payment')) {
            const modal = document.getElementById('modal-crypto-payment');
            if (modal) modal.classList.remove('open');
            
            // Очистка таймеров
            if (cryptoPollInterval) clearInterval(cryptoPollInterval);
            if (cryptoTimerInterval) clearInterval(cryptoTimerInterval);
        }
    };

    function copyCryptoAddress() {
        const text = document.getElementById('crypto-address').innerText;
        navigator.clipboard.writeText(text).then(() => {
            // Визуальный эффект
            const el = document.getElementById('crypto-address');
            const oldColor = el.style.color;
            el.style.color = "var(--highlight-green)";
            setTimeout(() => el.style.color = oldColor, 300);
            
            // Можно вибрацию добавить на мобильных
            if(navigator.vibrate) navigator.vibrate(50);
        });
    }

    function copyCryptoAmount() {
        const el = document.getElementById('crypto-amount');
        // Берем чистое число из атрибута, который мы установили в showCryptoModal
        const val = el.getAttribute('data-val'); 
        
        if (!val) return;

        navigator.clipboard.writeText(val).then(() => {
            // 1. Вибрация (для мобильных)
            if(navigator.vibrate) navigator.vibrate(50);

            // 2. Визуальный эффект на тексте суммы
            const originalHTML = el.innerHTML;
            const originalColor = el.style.color;
            
            el.style.color = "var(--highlight-green)"; // Зеленый цвет при успехе
            el.style.transform = "scale(1.05)";
            el.style.transition = "all 0.2s";

            // 3. Показываем подсказку "COPIED!"
            const hint = document.getElementById('amount-copy-hint');
            if (hint) {
                hint.style.opacity = '1';
            }

            // Возврат в исходное состояние через 1 сек
            setTimeout(() => {
                el.style.color = originalColor;
                el.style.transform = "scale(1)";
                if (hint) hint.style.opacity = '0';
            }, 1000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert("Copy failed manually select text.");
        });
    }

    function startCryptoPolling(invoiceId) {
        if (cryptoPollInterval) clearInterval(cryptoPollInterval);

        cryptoPollInterval = setInterval(async () => {
            try {
                // Запрос к серверу
                const res = await fetch(`${API_BASE_URL}/check-status/${invoiceId}`);
                const json = await res.json();

                if (json.status === 'paid' || json.status === 'processed') {
                    clearInterval(cryptoPollInterval);
                    clearInterval(cryptoTimerInterval);
                    
                    // Показываем экран успеха
                    document.getElementById('payment-status-box').style.display = 'none';
                    document.getElementById('payment-success-msg').style.display = 'block';
                    document.getElementById('crypto-timer').style.display = 'none';
                    
                    // === БЕЗОПАСНАЯ ВЫДАЧА ССЫЛКИ ===
                    // Если сервер прислал ссылку (значит, проверка на сервере прошла успешно)
                    if (json.discordLink) {
                        const discordBtn = document.getElementById('btn-discord-join');
                        if (discordBtn) {
                            discordBtn.href = json.discordLink; // Вставляем ссылку динамически
                            discordBtn.style.display = 'flex';  // Показываем кнопку
                        }
                    }
                }
                
                if (json.status === 'expired') {
                    clearInterval(cryptoPollInterval);
                    clearInterval(cryptoTimerInterval);
                    alert("Время оплаты истекло. Создай новый платеж.");
                    closeCryptoModal();
                }
            } catch (e) { console.error("Poll error", e); }
        }, 5000); 
    }

    function startCryptoTimer(expiresAt) {
        if (cryptoTimerInterval) clearInterval(cryptoTimerInterval);
        
        const timerEl = document.getElementById('crypto-timer');
        timerEl.style.display = 'block';

        const update = () => {
            const now = Date.now();
            const diff = expiresAt - now;

            if (diff <= 0) {
                timerEl.innerText = "Expired";
                clearInterval(cryptoTimerInterval);
                return;
            }

            const min = Math.floor(diff / 60000);
            const sec = Math.floor((diff % 60000) / 1000);
            timerEl.innerText = `Expires in ${min}:${sec < 10 ? '0'+sec : sec}`;
        };

        update();
        cryptoTimerInterval = setInterval(update, 1000);
    }

    function closePaymentModal(e, force) {
        if (force || e.target.id === 'modal-payment-overlay') {
            document.getElementById('modal-payment-overlay').classList.remove('open');
        }
    }

    function promptPromoCode() {
        const code = prompt("Enter your activation code (received after payment):");
        if (code) {
            // Вызываем существующую функцию активации
            window.activatePromoCode(code.trim());
            closePaymentModal(null, true);
            closeSubModal(null, true);
        }
    }

    function closeSubModal(e, force) {
        if (force || e.target.id === 'modal-sub-overlay') {
            document.getElementById('modal-sub-overlay').classList.remove('open');
        }
    }

    function checkGenerationLimit(onlyCheck = false) {
        if (subscriptionLevel !== 'free') return true; 

        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        
        // Читаем сохраненные данные
        let count = parseInt(localStorage.getItem('xch_limit_count') || '0');
        let startTime = parseInt(localStorage.getItem('xch_limit_start') || '0');

        // Логика сброса: Если прошло 24 часа с момента старта отсчета — сбрасываем
        if (startTime > 0 && (now - startTime > oneDay)) {
            if (!onlyCheck) {
                count = 0;
                startTime = 0;
                localStorage.setItem('xch_limit_count', '0');
                localStorage.setItem('xch_limit_start', '0');
            } else {
                count = 0; 
            }
        }

        // Если лимит исчерпан
        if (count >= DAILY_LIMIT) {
            
            // Вычисляем время сброса для отображения
            const resetTime = startTime > 0 ? startTime + oneDay : now + oneDay;
            const resetDate = new Date(resetTime);
            
            const dateStr = resetDate.toLocaleString(currentLang, { 
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });

            // --- ОТКРЫВАЕМ ОКНО ---
            if (!onlyCheck) {
                openLimitModal(dateStr); 
            }
            
            // Обновляем кнопку подписки (красная)
            updateSubscriptionUI();
            
            return false;
        }

        if (onlyCheck) return true; 

        // Списание
        if (count === 0 || startTime === 0) {
            localStorage.setItem('xch_limit_start', now);
        }

        count++;
        localStorage.setItem('xch_limit_count', count);
        
        updateSubscriptionUI(); 
        
        return true;
    }

    function updateSubscriptionUI() {
        // Данные
        subscriptionLevel = localStorage.getItem('xch_sub_level') || 'free';
        const t = langData[currentLang] || langData['en'];

        // --- ОБНОВЛЕНИЕ КНОПКИ В С АЙДБАРЕ ---
        const loginBtnText = document.getElementById('login-btn-text');
        
        if (loginBtnText) {
            if (window.isUserLoggedIn) {
                // Если залогинен: "Account • PRO"
                const planLabel = subscriptionLevel.toUpperCase();
                
                // Используем var(--text-secondary), как у стрелочек и дат
                let colorStyle = 'color:var(--text-secondary); font-weight:500;';

                const accText = t.personal_account || "Personal Account";
                loginBtnText.innerHTML = `${accText} <span style="font-size:15px; margin-left:6px; ${colorStyle}">${planLabel}</span>`;
            } else {
                // Если не залогинен: "Sync / Login"
                loginBtnText.innerText = t.login_text || "Sync / Login";
            }
        }

        // --- ОБНОВЛЕНИЕ СЧЕТЧИКА ЛИМИТОВ (Карточка Free в модалке) ---
        const freeLimitRow = document.getElementById('free-limit-row');
        const count = parseInt(localStorage.getItem('xch_limit_count') || '0');
        const remaining = Math.max(0, DAILY_LIMIT - count);

        if (freeLimitRow) {
            if (subscriptionLevel === 'free') {
                let text = t.limit_text_full || `🎲 ${DAILY_LIMIT} Generations / day (left: {n}/${DAILY_LIMIT})`;
                text = text.replace('{n}', remaining);
                freeLimitRow.innerHTML = text;
                freeLimitRow.style.color = remaining === 0 ? "var(--highlight-red)" : "";
            } else {
                freeLimitRow.innerHTML = t.feat_limit || `🎲 ${DAILY_LIMIT} Generations / day`;
                freeLimitRow.style.color = ""; 
            }
        }

        // --- НАСТРОЙКА КНОПОК ПОКУПКИ (Pro/Beast/Bestie) ---
        const configureBtn = (btn, state, buyText, planType) => {
            if (!btn) return;
            btn.onclick = null;
            btn.classList.remove('current', 'pro-btn', 'beast-btn', 'bestie-btn');
            btn.disabled = false;
            btn.style.opacity = "1";

            const tCurrent = t.btn_current || "Current Plan";
            const tExtend = currentLang === 'ru' ? "Продлить" : "Extend"; 
            const tUpgrade = currentLang === 'ru' ? "Улучшить" : "Upgrade";
            const tLower = t.btn_lower_tier || "Included";

            if (state === 'current') {
                if (planType === 'bestie') {
                    btn.disabled = true; btn.classList.add('current'); btn.innerText = "Purchased";
                } else {
                    if (btn.closest('.pro')) btn.classList.add('pro-btn');
                    if (btn.closest('.beast')) btn.classList.add('beast-btn');
                    btn.innerText = tExtend; 
                    btn.onclick = () => openPaymentSelection(planType);
                }
            } else if (state === 'lower') {
                btn.disabled = true; 
                btn.classList.add('current'); 
                
                btn.innerText = t.btn_lower_tier || "You deserve better"; 
                
                btn.style.opacity = "0.6";
            } else { 
                if (btn.closest('.pro')) btn.classList.add('pro-btn');
                if (btn.closest('.beast')) btn.classList.add('beast-btn');
                if (btn.closest('.bestie')) btn.classList.add('bestie-btn');
                btn.innerText = state === 'upgrade' ? tUpgrade : buyText;
                btn.onclick = () => openPaymentSelection(planType);
            }
        };

        const btnFree = document.querySelector('.plan-card:nth-child(1) .plan-btn'); 
        const btnPro = document.querySelector('.plan-card.pro .plan-btn');
        const btnBeast = document.querySelector('.plan-card.beast .plan-btn');
        const btnBestie = document.querySelector('.plan-card.bestie .plan-btn');
        const tPro = t.btn_get_pro || "Get Pro";
        const tBeast = t.btn_get_beast || "Unleash Beast";
        const tBestie = t.btn_get_bestie || "Get Forever"; 

        if (subscriptionLevel === 'bestie') {
            configureBtn(btnFree, 'lower'); configureBtn(btnPro, 'lower'); configureBtn(btnBeast, 'lower'); configureBtn(btnBestie, 'current', null, 'bestie');
        } else if (subscriptionLevel === 'beast') {
            configureBtn(btnFree, 'lower'); configureBtn(btnPro, 'lower'); configureBtn(btnBeast, 'current', null, 'beast'); configureBtn(btnBestie, 'upgrade', tBestie, 'bestie');
        } else if (subscriptionLevel === 'pro') {
            configureBtn(btnFree, 'lower'); configureBtn(btnPro, 'current', null, 'pro'); configureBtn(btnBeast, 'upgrade', tBeast, 'beast'); configureBtn(btnBestie, 'upgrade', tBestie, 'bestie');
        } else {
            configureBtn(btnFree, 'current'); if(btnFree){btnFree.disabled=true; btnFree.innerText=t.btn_current;}
            configureBtn(btnPro, 'buy', tPro, 'pro'); configureBtn(btnBeast, 'buy', tBeast, 'beast'); configureBtn(btnBestie, 'buy', tBestie, 'bestie');
        }
    }

    function openBoosty(url) {
        if (!window.isUserLoggedIn) {
            // Если не залогинен - требуем вход
            alert(langData[currentLang].login_required || "Please log in (Sync Data) first so we can activate your subscription!");
            
            // Скроллим к кнопке входа и подсвечиваем её (опционально)
            switchTab('account');
            const loginBtn = document.getElementById('login-capsule');
            if(loginBtn) {
                loginBtn.style.border = "1px solid var(--accent)";
                setTimeout(() => loginBtn.style.border = "none", 1000);
            }
            return;
        }
        // Если залогинен - открываем
        window.open(url, '_blank');
    }

    function openThemeModal() {
        if (!isPreviewActive) {
            originalThemeId = localStorage.getItem('xch_theme_id') || 'dark';
        }
        
        renderThemes();
        document.getElementById('modal-theme-overlay').classList.add('open');
    }

    function closeThemeModal(e, force) {
        if (force || e.target.id === 'modal-theme-overlay') {
            document.getElementById('modal-theme-overlay').classList.remove('open');
        }
    }

    function openLimitModal(resetTimeStr) {
        const modal = document.getElementById('modal-limit-overlay');
        const textEl = document.getElementById('limit-custom-text');
        const timeEl = document.getElementById('limit-reset-time');
        
        // Берем перевод фразы
        const t = langData[currentLang] || langData['en'];
        if (textEl) textEl.innerText = t.limit_desc_fun;
        
        // Обновляем время сброса
        if (timeEl) {
            const label = currentLang === 'ru' ? "Сброс:" : "Reset:";
            timeEl.innerText = `${label} ${resetTimeStr}`;
        }

        modal.classList.add('open');
    }

    function closeLimitModal(e, force) {
        if (force || e.target.id === 'modal-limit-overlay') {
            document.getElementById('modal-limit-overlay').classList.remove('open');
        }
    }

    function renderThemes() {
        const basicCont = document.getElementById('theme-list-basic');
        const premCont = document.getElementById('theme-list-premium');
        const iconsCont = document.getElementById('theme-list-icons'); 
        
        const currentId = document.body.getAttribute('data-theme') || 'dark';
        const t = langData[currentLang] || langData['en'];
        
        // 1. ПРИНУДИТЕЛЬНЫЙ ПЕРЕВОД ЗАГОЛОВКА ИКОНОК
        const headerEl = document.querySelector('#modal-theme-overlay .icons-section-header');
        if (headerEl && t.theme_icons_header) {
            headerEl.innerText = t.theme_icons_header;
        }

        basicCont.innerHTML = '';
        premCont.innerHTML = '';

        // 2. РЕНДЕР ОСНОВНЫХ ТЕМ
        APP_THEMES.forEach(theme => {
            const isLocked = (theme.type === 'pro' && subscriptionLevel === 'free');
            const isActive = (currentId === theme.id);
            
            const themeKey = 'theme_' + theme.id;
            const localizedName = (t && t[themeKey]) ? t[themeKey] : theme.name;
            
            let typeText = theme.isLight ? 'Light' : 'Dark';

            let statusIcon = '';
            if (isActive) {
                statusIcon = '<span class="lock-icon" style="color:var(--accent)">✓</span>';
            } else if (isLocked) {
                statusIcon = '<span class="pro-badge-icon">PRO</span>';
            }

            const div = document.createElement('div');
            div.className = `theme-item ${isActive ? 'active' : ''}`;
            
            div.innerHTML = `
                <div class="theme-preview-box" style="background: ${theme.preview}; border: 1px solid var(--border);">
                    <span style="font-size:10px; font-weight:700; color:${theme.isLight ? '#000' : '#fff'}">Aa</span>
                </div>
                <div class="theme-info">
                    <span class="theme-name">${localizedName}</span>
                    <span class="theme-type" style="color: ${theme.type==='pro' ? 'var(--accent)' : 'var(--text-secondary)'}">
                        ${typeText}
                    </span>
                </div>
                ${statusIcon}
            `;

            div.onclick = () => selectTheme(theme);
            
            if (theme.type === 'free') basicCont.appendChild(div);
            else premCont.appendChild(div);
        });

        // 3. РЕНДЕР ИКОНОК ПРИЛОЖЕНИЯ (App Icons)
        if (iconsCont) {
            iconsCont.innerHTML = '';
            const savedIcon = localStorage.getItem('xch_custom_icon');
            const exploredIds = permanentExplored;
            const iconGroups = EXPLORED_GROUPS.filter(g => g.appIcon);

            iconGroups.forEach(group => {
                const groupItems = data.filter(item => item.tags.some(tag => group.tags.includes(tag)));
                const unlockedCount = groupItems.filter(item => exploredIds.has(item.id)).length;
                const isUnlocked = (unlockedCount === groupItems.length && groupItems.length > 0);
                const isActive = (savedIcon === group.appIcon);
                const title = t['cat_' + group.id] || group.id;

                const div = document.createElement('div');
                div.className = `app-icon-item ${isActive ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
                div.innerHTML = `
                    <img src="${group.appIcon}" class="app-icon-img">
                    ${!isUnlocked ? '<span class="icon-lock-badge">🔒</span>' : ''}
                    <div class="app-icon-label">${title}</div>
                `;
                div.onclick = () => {
                    if (isUnlocked) {
                        toggleCustomIcon(group.appIcon);
                    } else {
                        // Если закрыто — ведем в детали жанра, чтобы юзер видел прогресс
                        closeThemeModal(null, true); 
                        openExploredModal(); // Открываем модалку категорий
                        
                        // Сразу показываем детали этого конкретного жанра
                        showGenreDetails({
                            ...group, 
                            percent: Math.round((unlockedCount / groupItems.length) * 100), 
                            count: unlockedCount, 
                            total: groupItems.length
                        });
                    }
                };
                iconsCont.appendChild(div);
            });
        }

        // 4. БЛОК СЛУЧАЙНОЙ ТЕМЫ (Только для платных пользователей)
        const oldSettings = document.getElementById('theme-random-settings');
        if (oldSettings) oldSettings.remove();

        if (subscriptionLevel !== 'free') {
            const isRandom = localStorage.getItem('xch_random_theme') === 'true';
            const includeLight = localStorage.getItem('xch_random_include_light') === 'true';

            const randomDiv = document.createElement('div');
            randomDiv.id = 'theme-random-settings';
            randomDiv.style.marginTop = '25px';
            randomDiv.innerHTML = `
                <div class="ios-group" style="margin: 0 !important; width: 100% !important;">
                    <div class="ios-row">
                        <div class="ios-row-left">
                            <span style="font-weight:600;">${t.theme_random}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="random-theme-toggle" ${isRandom ? 'checked' : ''} onchange="toggleRandomTheme(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="ios-row" id="row-include-light" style="display: ${isRandom ? 'flex' : 'none'}">
                        <div class="ios-row-left">
                            <span style="font-weight:600;">${t.theme_include_light}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="random-light-toggle" ${includeLight ? 'checked' : ''} onchange="toggleRandomIncludeLight(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            `;
            document.querySelector('#modal-theme-overlay .modal-body').appendChild(randomDiv);
        }
    }

    function toggleRandomTheme(enabled) {
        localStorage.setItem('xch_random_theme', enabled);
        const lightRow = document.getElementById('row-include-light');
        if (lightRow) {
            lightRow.style.display = enabled ? 'flex' : 'none';
        }
        if(navigator.vibrate) navigator.vibrate(10);
    }

    function toggleRandomIncludeLight(enabled) {
        localStorage.setItem('xch_random_include_light', enabled);
        if(navigator.vibrate) navigator.vibrate(10);
    }

    function selectTheme(theme) {
        const isLocked = (theme.type === 'pro' && subscriptionLevel === 'free');

        if (isLocked) {
            startPreview(theme.id);
        } else {
            // При ручном выборе мы применяем тему и сохраняем её как основную
            applyTheme(theme.id, true);
            originalThemeId = theme.id;
            
            // Обновляем список, чтобы поставить галочку на новую тему
            renderThemes();
            
            if(navigator.vibrate) navigator.vibrate(15);
        }
    }

    function startPreview(themeId) {
        isPreviewActive = true;

        // 1. Применяем тему визуально (без сохранения)
        applyTheme(themeId, false);

        // 2. Закрываем окно тем
        document.getElementById('modal-theme-overlay').classList.remove('open');

        // 3. Переходим на главную (если мобилка), чтобы было видно красоту
        if (window.innerWidth < 768) {
            switchTab('home');
            // Скроллим наверх
            const home = document.getElementById('tab-home');
            if(home) home.scrollTop = 0;
        }

        // 4. Показываем плашку снизу
        const bar = document.getElementById('preview-floating-bar');
        bar.classList.add('visible');

        // 5. Добавляем слушатель клика "в никуда" для отмены
        // Делаем небольшую задержку, чтобы текущий клик не сработал сразу
        setTimeout(() => {
            document.addEventListener('click', handlePreviewOutsideClick);
        }, 100);
    }

    function handlePreviewOutsideClick(e) {
        const bar = document.getElementById('preview-floating-bar');
        
        // Если кликнули ВНУТРИ плашки (кнопка Unlock), ничего не делаем (там свой onclick)
        if (bar.contains(e.target)) return;

        // Если кликнули МИМО -> Отмена
        cancelPreview();
    }

    // Отмена предпросмотра (возврат)
    function cancelPreview() {
        if (!isPreviewActive) return;
        isPreviewActive = false;

        // 1. Возвращаем старую тему
        if (originalThemeId) {
            applyTheme(originalThemeId, true);
        }

        // 2. Скрываем плашку
        document.getElementById('preview-floating-bar').classList.remove('visible');

        // 3. Удаляем слушатель кликов
        document.removeEventListener('click', handlePreviewOutsideClick);

        // 4. Открываем окно тем обратно
        openThemeModal();
    }

    // Покупка из режима предпросмотра
    function buyFromPreview(e) {
        // Останавливаем всплытие, чтобы не сработал handlePreviewOutsideClick
        if(e) e.stopPropagation();

        // 1. Убираем слушатель отмены (чтобы не моргало)
        document.removeEventListener('click', handlePreviewOutsideClick);
        
        // 2. Возвращаем тему (пока не купил) - опционально, но безопаснее
        applyTheme(originalThemeId, true);
        isPreviewActive = false;
        
        // 3. Скрываем плашку
        document.getElementById('preview-floating-bar').classList.remove('visible');

        // 4. Открываем окно оплаты
        openSubModal();
    }

    function buyCurrentPreview() {
        closeThemeModal(null, true);
        openSubModal();
    }

    function getThemeLogoSrc(themeId) {
        const logoMap = {
            // Фиолетовая
            'purple-dark': 'amethyst_icon.png',
            'purple-light': 'amethyst_icon.png',
            
            // Зеленая
            'green-dark': 'forest_icon.png',
            'green-light': 'forest_icon.png',
            
            // Золотая
            'gold-dark': 'gold_icon.png',
            'gold-light': 'gold_icon.png',
            
            // Оранжевая
            'orange-dark': 'magma_icon.png',
            'orange-light': 'magma_icon.png',
            
            // Синяя
            'blue-dark': 'midnight_icon.png', 
            'blue-light': 'midnight_icon.png',
            
            // Красная
            'red-dark': 'vampire_icon.png',
            'red-light': 'vampire_icon.png',
            
            // Нуар
            'noir': 'noir_icon.png',

            // Old Money 
            'old-money': 'oldmoney_icon.png', 
        };

        // Если темы нет в списке (например, 'dark' или 'light'), возвращаем дефолт
        return logoMap[themeId] || 'logo.png';
    }

    function toggleCustomIcon(iconFilename) {
        const currentIcon = localStorage.getItem('xch_custom_icon');
        
        if (currentIcon === iconFilename) {
            // Если уже выбрана — убираем (возврат к иконке темы)
            localStorage.removeItem('xch_custom_icon');
        } else {
            // Устанавливаем новую
            localStorage.setItem('xch_custom_icon', iconFilename);
        }
        
        // Применяем изменения
        const currentThemeId = localStorage.getItem('xch_theme_id') || 'dark';
        updateGlobalLogos(currentThemeId); // Эта функция сама проверит custom_icon
        
        // Перерисовываем список (чтобы обновить рамки)
        renderThemes();
    }

    function updateGlobalLogos(themeId) {
        // 1. Проверяем, есть ли кастомная иконка
        const customIcon = localStorage.getItem('xch_custom_icon');
        
        let newSrc;
        if (customIcon) {
            // Если пользователь выбрал достижение -> используем его
            newSrc = customIcon;
        } else {
            // Иначе -> стандартная иконка темы
            newSrc = getThemeLogoSrc(themeId);
        }

        // --- 1. ОБНОВЛЕНИЕ ЛОГОТИПОВ ВНУТРИ САЙТА ---
        document.querySelectorAll('.logo-img').forEach(img => {
            img.src = newSrc;
        });
        
        // Лого в окне установки и wrapped
        const installLogo = document.querySelector('#modal-install-overlay img');
        if (installLogo && installLogo.src.includes('logo')) installLogo.src = newSrc;
        
        const wrappedLogo = document.querySelector('.sum-logo-img');
        if (wrappedLogo) wrappedLogo.src = newSrc;

        // --- 2. ОБНОВЛЕНИЕ ФАВИКОНОК ---
        // Если тема дефолтная И нет кастомной иконки -> logo_icon.png
        // Иначе -> newSrc (либо иконка темы, либо кастомная)
        let faviconSrc = newSrc;
        if (!customIcon && (themeId === 'dark' || themeId === 'light')) {
            faviconSrc = 'logo_icon.png';
        }

        let linkIcon = document.querySelector("link[rel~='icon']");
        if (!linkIcon) {
            linkIcon = document.createElement('link');
            linkIcon.rel = 'icon';
            document.head.appendChild(linkIcon);
        }
        linkIcon.href = faviconSrc;

        let linkApple = document.querySelector("link[rel~='apple-touch-icon']");
        if (!linkApple) {
            linkApple = document.createElement('link');
            linkApple.rel = 'apple-touch-icon';
            document.head.appendChild(linkApple);
        }
        linkApple.href = faviconSrc;
    }

    function applyTheme(themeId, save = true) {
        // Если сохраняем, пишем в память
        if (save) {
            localStorage.setItem('xch_theme_id', themeId);
        }
        
        const root = document.documentElement;
        
        // Устанавливаем атрибут для CSS
        document.body.setAttribute('data-theme', themeId);

        updateGlobalLogos(themeId); 

        const theme = APP_THEMES.find(t => t.id === themeId);
        if (!theme) return;
        
        document.body.classList.toggle('light-theme', theme.isLight);
        
        const props = ['--bg-color', '--sidebar-bg', '--card-bg', '--nav-bg', '--border', '--ios-card', '--ios-bg', '--card-gradient'];
        props.forEach(p => root.style.removeProperty(p));
        
        if (theme.colors) {
            if (theme.colors.bg) {
                root.style.setProperty('--bg-color', theme.colors.bg);
                root.style.setProperty('--ios-bg', theme.colors.bg);
            }
            if (theme.colors.sidebar) root.style.setProperty('--sidebar-bg', theme.colors.sidebar);
            if (theme.colors.card) {
                root.style.setProperty('--card-bg', theme.colors.card);
                root.style.setProperty('--ios-card', theme.colors.card);
                root.style.setProperty('--card-gradient', `linear-gradient(165deg, ${theme.colors.card}, ${theme.colors.bg})`);
            }
            if (theme.colors.nav) root.style.setProperty('--nav-bg', theme.colors.nav);
            if (theme.colors.border) {
                root.style.setProperty('--border', theme.colors.border);
                root.style.setProperty('--ios-separator', theme.colors.border);
            }
        }

        if (theme.accent) {
            root.style.setProperty('--accent', theme.accent);
            root.style.setProperty('--accent-light', theme.accentLight || theme.accent);
        } else {
            updateLink(); // Для дефолтных тем пересчитываем цвета из платформы
        }

        // Обновляем текст в кнопке настроек
        updateThemeLabel(theme.id);
        randomizeModeGreeting(); 
    }
    
    //  функция обновления текста в кнопке
    function updateThemeLabel(themeId) {
        // 1. Если ID не передан, пытаемся найти текущий активный (из атрибута body или памяти)
        if (!themeId) {
            themeId = document.body.getAttribute('data-theme') || localStorage.getItem('xch_theme_id') || 'dark';
        }
        
        // 2. Берем текущий словарь переводов
        const t = langData[currentLang] || langData['en'];
        const label = document.getElementById('current-theme-name');
        
        if (label) {
            // Формируем ключ (например, theme_blue-dark)
            const key = 'theme_' + themeId;
            
            // 3. ПРИОРИТЕТ: Ищем в переводах
            if (t && t[key]) {
                label.innerText = t[key];
            } else {
                // Фолбек: Ищем в массиве тем (там английские названия)
                const themeObj = APP_THEMES.find(x => x.id === themeId);
                label.innerText = themeObj ? themeObj.name : themeId;
            }
        }
    }

    function initSwipeCards() {
        const card = document.getElementById('card-block');
        const overlay = document.querySelector('.swipe-overlay'); 
        
        // Элементы декора (Иконки)
        const iconLeft = document.querySelector('.icon-left');
        const iconRight = document.querySelector('.icon-right');
        const statusText = document.getElementById('status-text');

        // Элементы, которые нужно размывать
        const blurTargets = [
            document.getElementById('slot-reel'),
            document.getElementById('result-desc'),
            document.getElementById('badge-wrapper'),
            document.getElementById('related-block'),
            document.getElementById('tinder-controls') 
        ];

        if (!card) return;

        // Базовые углы наклона иконок
        const leftBaseRot = -20;
        const rightBaseRot = 15;

        // --- 1. START (Начало касания) ---
        card.addEventListener('touchstart', (e) => {
            // 1. ИГНОРИРУЕМ СКРОЛЛРУЕМЫЕ ЭЛЕМЕНТЫ
            if (e.target.closest('.related-tags') || e.target.closest('#related-tags')) {
                return;
            }

            // 2. Игнорируем другие интерактивные элементы
            if (e.target.closest('button') || 
                e.target.closest('.related-item-btn') || 
                e.target.closest('.capsule-trigger') || 
                e.target.closest('.tag')) return;
            
            if (isGenerating) return;

            // ПРОВЕРКА ЛИМИТА
            if (typeof checkGenerationLimit === 'function' && !checkGenerationLimit(true)) return;

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            currentX = startX;
            currentY = startY;
            isDragging = true;
            
            // Отключаем плавность для мгновенной реакции
            card.style.transition = 'none';
            if (statusText) statusText.style.transition = 'none';
            if (overlay) overlay.style.transition = 'none';
            
            // Пауза анимации иконок
            if(iconLeft) {
                iconLeft.style.transition = 'none';
                iconLeft.style.animation = 'none'; 
            }
            if(iconRight) {
                iconRight.style.transition = 'none';
                iconRight.style.animation = 'none'; 
            }
            
        }, {passive: false});

        // --- 2. MOVE ---
        card.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;
            let deltaX = currentX - startX;
            let deltaY = currentY - startY; 

            // Блокируем скролл страницы, если тянем карточку
            if (Math.abs(deltaX) > 10 && e.cancelable) e.preventDefault();

            // А. ДВИЖЕНИЕ КАРТОЧКИ
            let rotate = deltaX * 0.05;
            card.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;

            // Б. ДВИЖЕНИЕ ТЕКСТА (Над карточкой)
            if (statusText) {
                statusText.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;
            }

            // В. ПАРАЛЛАКС ИКОНОК (Если они есть)
            if (iconLeft) {
                iconLeft.style.transform = `translate(${deltaX * 1.2}px, ${deltaY * 0.6}px) rotate(${leftBaseRot + (deltaX * 0.1)}deg)`;
            }
            if (iconRight) {
                iconRight.style.transform = `translate(${deltaX * 0.7}px, ${deltaY * 0.3}px) rotate(${rightBaseRot - (deltaX * 0.05)}deg)`;
            }

            // Г. ЭФФЕКТЫ (ЦВЕТ + БЛЮР) - Самое важное!
            const progress = Math.min(Math.abs(deltaX) / 150, 1); // 0...1 (1 = полный свайп)
            
            // Заливка цветом
            if (overlay) {
                const alpha = progress * 0.85; // Максимум 85% непрозрачности
                if (deltaX > 0) {
                    // Вправо (Зеленый)
                    overlay.style.backgroundColor = `rgba(46, 204, 113, ${alpha})`; 
                } else {
                    // Влево (Красный)
                    overlay.style.backgroundColor = `rgba(231, 76, 60, ${alpha})`; 
                }
            }

            // Блюр контента
            const blurAmount = progress * 8; // Максимум 8px блюра
            blurTargets.forEach(el => { 
                if(el) el.style.filter = `blur(${blurAmount}px)`; 
            });

        }, {passive: false});

        // --- 3. END ---
        card.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            
            let deltaX = currentX - startX;
            const threshold = window.innerWidth * 0.25; // Свайпнуть нужно на 25% ширины экрана

            if (Math.abs(deltaX) > threshold) {
                // === УЛЕТАЕТ ===
                const direction = deltaX > 0 ? 'right' : 'left';

                if (isModeSelectionActive) {
                    // Анимация улета карточки
                    card.style.transition = 'transform 0.3s ease-out';
                    card.style.transform = `translateX(${direction === 'right' ? 500 : -500}px)`;

                    setTimeout(() => {
                        // Возврат
                        card.style.transition = 'none';
                        card.style.transform = '';
                        
                        // Логика
                        if (direction === 'right') {
                            setAppModeAndStart('pleasure'); // Вправо -> Привычное (Наслаждение)
                        } else {
                            setAppModeAndStart('explore');  // Влево -> Новое (Исследование)
                        }
                    }, 300);
                    return;
                }

                const endX = deltaX > 0 ? window.innerWidth + 200 : -window.innerWidth - 200;
                
                // Запускаем анимацию вылета
                card.style.transition = 'transform 0.3s ease-out';
                card.style.transform = `translateX(${endX}px) rotate(${endX * 0.05}deg)`;

                // Текст тоже улетает
                if (statusText) {
                    statusText.style.transition = 'transform 0.3s ease-out';
                    statusText.style.transform = `translateX(${endX}px) rotate(${endX * 0.05}deg)`;
                }

                // Иконки улетают
                if(iconLeft) {
                    iconLeft.style.transition = 'transform 0.3s ease-out, opacity 0.3s';
                    iconLeft.style.opacity = '0';
                    iconLeft.style.transform = `translate(${endX}px, -50px)`;
                }
                if(iconRight) {
                    iconRight.style.transition = 'transform 0.3s ease-out, opacity 0.3s';
                    iconRight.style.opacity = '0';
                    iconRight.style.transform = `translate(${endX}px, -20px)`;
                }

                // Вызываем логику
                setTimeout(() => {
                    handleSwipeAction(direction);
                }, 300);

            } else {
                // === ВОЗВРАТ НА МЕСТО (Отмена свайпа) ===
                
                // Убираем блюр плавно
                blurTargets.forEach(el => { 
                    if(el) { 
                        el.style.transition = 'filter 0.3s ease'; 
                        el.style.filter = 'none'; 
                    } 
                });

                // Убираем цвет оверлея плавно
                if (overlay) { 
                    overlay.style.transition = 'background-color 0.3s ease'; 
                    overlay.style.backgroundColor = 'transparent'; 
                }

                // Возвращаем карточку
                card.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                card.style.transform = 'translateX(0) rotate(0)';

                // Возвращаем текст
                if (statusText) {
                    statusText.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    statusText.style.transform = 'translateX(0) rotate(0)';
                }

                // Возвращаем иконки
                if(iconLeft) {
                    iconLeft.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    iconLeft.style.transform = `translate(0px, 0px) rotate(${leftBaseRot}deg)`;
                    setTimeout(() => { iconLeft.style.animation = ''; }, 400); // Возвращаем парение
                }
                if(iconRight) {
                    iconRight.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    iconRight.style.transform = `translate(0px, 0px) rotate(${rightBaseRot}deg)`;
                    setTimeout(() => { iconRight.style.animation = ''; }, 400);
                }
            }
        });
    }

    function handleSwipeAction(direction) {
        // 1. Проверка лимита
        if (typeof checkGenerationLimit === 'function' && !checkGenerationLimit(true)) return;

        if (isGenerating) return;
        if (currentItem) sessionHistoryStack.push(currentItem);

        const wrapper = document.getElementById('card-anim-wrapper');
        const card = document.getElementById('card-block');
        const btnUndo = document.getElementById('btn-t-undo');
        
        // Элементы для эффектов (Те же, что и в свайпах)
        const overlay = document.querySelector('.swipe-overlay');
        const blurTargets = [
            document.getElementById('slot-reel'),
            document.getElementById('result-desc'),
            document.getElementById('badge-wrapper'),
            document.getElementById('related-block'),
            document.getElementById('tinder-controls')
        ];

        if(btnUndo) btnUndo.disabled = true;

        if (direction === 'right') toggleFavorite(true); 
        else toggleBlacklist(true);

        // Проверяем, сдвинута ли карточка пальцем
        // Если transform == 'none', значит карточка стоит в центре -> это клик по кнопке
        const currentTransform = getComputedStyle(card).transform;
        const isCardCentered = currentTransform === 'none' || currentTransform === 'matrix(1, 0, 0, 1, 0, 0)';

        if (isCardCentered && wrapper) {
            // === ЭТО КЛИК ПО КНОПКЕ ===
            
            // 1. Применяем цвет и блюр (Визуальный отклик)
            if (overlay) {
                overlay.style.transition = 'background-color 0.2s ease';
                if (direction === 'right') {
                    overlay.style.backgroundColor = 'rgba(46, 204, 113, 0.8)'; // Зеленый
                } else {
                    overlay.style.backgroundColor = 'rgba(231, 76, 60, 0.8)'; // Красный
                }
            }

            blurTargets.forEach(el => {
                if(el) {
                    el.style.transition = 'filter 0.2s ease';
                    el.style.filter = 'blur(5px)'; // Блюрим контент
                }
            });

            // 2. Анимируем улет всей ОБЁРТКИ
            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.opacity = '0';
            
            if (direction === 'right') {
                wrapper.style.transform = 'translateX(150%) rotate(10deg)';
            } else {
                wrapper.style.transform = 'translateX(-150%) rotate(-10deg)';
            }

            setTimeout(() => {
                startGeneration(
                    direction === 'right' ? 'similar' : 'random', 
                    direction === 'right' ? 'like' : 'dislike'
                );
            }, 300);
        } else {
            // === ЭТО БЫЛ СВАЙП ПАЛЬЦЕМ (Эффекты уже применены в touchmove) ===
            startGeneration(
                direction === 'right' ? 'similar' : 'random', 
                direction === 'right' ? 'like' : 'dislike'
            );
        }
    }

    function animateSwipeEnd(moveX, direction) {
        const card = document.getElementById('card-block');
        card.style.transition = 'transform 0.3s ease-out';
        card.style.transform = `translateX(${moveX}px) rotate(${moveX * 0.05}deg)`;
        
        // Ждем окончания анимации вылета, затем запускаем логику
        setTimeout(() => {
            handleSwipeAction(direction);
        }, 300);
    }

    function undoLastAction() {
        // Если стек пуст, возвращаемся на стартовый экран
        if (sessionHistoryStack.length === 0) {
            resetToHome();
            return;
        }

        // Иначе выполняем стандартный откат
        const prevItem = sessionHistoryStack.pop();
        const card = document.getElementById('card-block');
        
        card.classList.remove('restore-anim', 'anim-fly-left', 'anim-fly-right');
        card.style.transform = 'none';
        void card.offsetWidth; 
        
        card.classList.add('has-results');
        card.classList.add('anim-fly-right');

        setTimeout(() => {
            forceShowResult(prevItem, 'undo'); 
            setTimeout(() => card.classList.remove('anim-fly-right'), 700);
        }, 50);

        // После отката проверяем кнопку снова (визуально можно сделать её ярче или тусклее, 
        // но теперь она всегда активна, т.к. ведет домой)
        const undoBtn = document.getElementById('btn-t-undo');
        if(undoBtn) undoBtn.disabled = false;
    }

    function startGeneration(mode, direction = 'next', specificId = null) {
        // 1. Проверки состояния
        if (isPanicMode) {
            generatePanicCard(direction);
            return;
        }
        if (!checkGenerationLimit()) return; 
        if (isGenerating) return;

        randomizeDecorations();

        // 2. Сброс модификаторов (базовый)
        activeMods.clear();
        if (currentOrientation === 'gay') activeMods.add('Gay');
        else if (currentOrientation === 'trans') activeMods.add('Trans');
        
        // === ЛОГИКА 1: КОНКРЕТНЫЙ ПРЕДМЕТ (из приветствия или истории) ===
        if (mode === 'specific' && specificId) {
            const targetItem = data.find(i => i.id === specificId);
            
            if (targetItem) {
                // Сразу запускаем анимацию с этим предметом
                // Используем mode='random', чтобы сработала стандартная логика объяснения ("Судьба" или "Потому что ты любишь")
                launchAnimation(targetItem, 'random', direction);
                return;
            }
            // Если предмет не найден (удален из базы), проваливаемся в обычный рандом
        }

        // === ЛОГИКА 2: ВБРОСЫ (INJECTIONS) - WL / Favs / Ban ===
        if (mode === 'random') {
            const roll = Math.random(); 
            const depth = sessionHistoryStack.length; 

            const isValidInjection = (item) => {
                if (!item) return false;
                if (cooldownList.includes(item.id)) return false; 
                if (currentOrientation === 'gay' && !item.tags.includes('gay')) return false;
                if (currentOrientation === 'hetero' && item.tags.includes('gay')) return false;
                if (currentOrientation === 'trans' && !item.tags.some(t=>['trans','shemale'].includes(t))) return false;
                return true;
            };

            let targetItem = null;
            let injectionMode = null;

            // 1. WATCH LATER (12%)
            if (roll < 0.12 && watchLater.length > 0 && depth > 2) {
                const candidate = data.find(x => x.id === watchLater[Math.floor(Math.random() * watchLater.length)]);
                if (isValidInjection(candidate)) { targetItem = candidate; injectionMode = 'wl_reminder'; }
            }
            // 2. FAVORITES (4%)
            else if (roll >= 0.12 && roll < 0.16 && favorites.length > 0 && depth > 5) {
                const candidate = data.find(x => x.id === favorites[Math.floor(Math.random() * favorites.length)]);
                if (isValidInjection(candidate)) { targetItem = candidate; injectionMode = 'fav_reminder'; }
            }
            // 3. BLACKLIST (1.5%)
            else if (roll >= 0.16 && roll < 0.175 && blacklist.length > 0 && depth > 10) {
                const candidate = data.find(x => x.id === blacklist[Math.floor(Math.random() * blacklist.length)]);
                if (isValidInjection(candidate)) { targetItem = candidate; injectionMode = 'ban_reminder'; }
            }

            // Если вброс сработал
            if (targetItem && injectionMode) {
                console.log(`Injection Triggered: ${injectionMode}`);
                // Запускаем анимацию вброса
                launchAnimation(targetItem, injectionMode, direction);
                return; 
            }
        }

        // === ЛОГИКА 3: СТАНДАРТНЫЙ РАНДОМ И ФИЛЬТРАЦИЯ ===
        
        // Корректировка весов на основе предыдущего действия (если это рандом)
        if (mode === 'random' && currentItem && !hasInteractedWithCurrent) {
            if (watchLater.includes(currentItem.id)) adjustTagScores(currentItem, 1);
            else adjustTagScores(currentItem, -1);
        }
        if (mode === 'similar' && currentItem) adjustTagScores(currentItem, 1);

        // Фильтрация
        let filtered = filterData();
        
        // Если режим "Похожее"
        if (mode === 'similar' && lastGeneratedItem) {
            const subset = filtered.filter(item => {
                if (item.id === lastGeneratedItem.id) return false;
                const intersection = item.tags.filter(t => lastGeneratedItem.tags.includes(t));
                return intersection.length >= 2;
            });
            if (subset.length > 0) filtered = subset;
        }

        // Если пусто
        if (filtered.length === 0) {
            const reel = document.getElementById('slot-reel');
            reel.innerHTML = `<div class="slot-item" style="color:var(--highlight-red);">List Empty</div>`;
            document.getElementById('tinder-controls').classList.remove('hidden-initial');
            return;
        }

        // Выбор победителя
        const finalItem = getWeightedRandom(filtered);

        // Запуск анимации
        launchAnimation(finalItem, mode, direction);
    }

    function launchAnimation(finalItem, mode, direction) {
        // 1. Блокируем интерфейс
        isGenerating = true;
        hasInteractedWithCurrent = false;
        hasWatchedCurrentItem = false;

        // 2. Обновляем UI модификаторов (рендерим те, что есть по дефолту)
        renderModifiers();

        // 3. Очистка старого контента карточки
        const descEl = document.getElementById('result-desc');
        if(descEl) descEl.style.display = 'none';
        const statusText = document.getElementById('status-text');
        if(statusText) statusText.innerText = ''; 
        document.getElementById('badge-wrapper').innerHTML = '';
        
        document.getElementById('mods-capsule').classList.remove('open');
        const modContainer = document.getElementById('mod-container');
        if (modContainer) modContainer.classList.remove('open');
        
        // Скрываем кнопки управления
        const uiToHide = ['tinder-controls', 'mods-block', 'related-block'];
        uiToHide.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('hidden-initial'); 
            }
        });

        // 4. Сброс стилей карточки
        const card = document.getElementById('card-block');
        const wrapper = document.getElementById('card-anim-wrapper');
        const overlay = document.querySelector('.swipe-overlay');
        const iconLeft = document.querySelector('.icon-left');
        const iconRight = document.querySelector('.icon-right');

        if (wrapper) {
            wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
            wrapper.style.transform = '';
            wrapper.style.transition = '';
            wrapper.style.opacity = '1';
        }

        if(card) {
            card.classList.remove('status-wl', 'status-fav', 'status-ban');
            card.classList.remove('flash-active', 'has-results'); 
            card.style.transform = ''; 
            card.style.transition = '';
            card.style.opacity = '1'; 
            card.style.backgroundColor = '';
            card.style.borderColor = '';
            card.style.filter = '';
            
            if (overlay) {
                overlay.style.transition = 'none';
                overlay.style.backgroundColor = 'transparent';
                overlay.style.opacity = ''; 
            }
            
            // Сброс блюра
            const blurTargets = [
                document.getElementById('slot-reel'), 
                document.getElementById('result-desc'), 
                document.getElementById('badge-wrapper'), 
                document.getElementById('related-block'),
                document.getElementById('tinder-controls')
            ];
            blurTargets.forEach(el => { 
                if(el) { el.style.transition = 'none'; el.style.filter = 'none'; }
            });
            
            void card.offsetWidth; // Force reflow
        }

        // Сброс иконок
        if(iconLeft) {
            iconLeft.style.transition = 'none'; iconLeft.style.opacity = ''; iconLeft.style.transform = ''; iconLeft.style.animation = ''; 
        }
        if(iconRight) {
            iconRight.style.transition = 'none'; iconRight.style.opacity = ''; iconRight.style.transform = ''; iconRight.style.animation = '';
        }

        const reel = document.getElementById('slot-reel');

        // === СЦЕНАРИЙ 1: ПЕРВЫЙ ЗАПУСК (СЛОТ-МАШИНА) ===
        if (isFirstGen) {
            // Генерируем фейковые имена для прокрутки
            // (Используем filterData или просто берем случайные из data, если filter пуст)
            let spinCandidates = filterData();
            if (spinCandidates.length === 0) spinCandidates = data; // Fallback

            const spinCount = 10;
            let html = '';
            
            for (let i = 0; i < spinCount - 1; i++) {
                const randomItem = spinCandidates[Math.floor(Math.random() * spinCandidates.length)];
                html += `<div class="slot-item">${getLocalizedName(randomItem)}</div>`;
            }
            
            const winnerName = getLocalizedName(finalItem);
            html += `<div class="slot-item" id="result-text">${winnerName}</div>`;
            
            reel.className = 'slot-reel spinning'; 
            reel.innerHTML = html;
            reel.querySelectorAll('.slot-item').forEach(el => el.classList.add('shrunk'));
            reel.style.transform = 'translateY(0)';
            
            // Влет обёртки
            if(wrapper) wrapper.classList.add('anim-fly-left'); 

            setTimeout(() => {
                isFirstGen = false;
                const isPC = window.innerWidth > 768;
                const itemHeight = isPC ? 450 : 300; // Примерная высота элемента
                const realHeight = reel.firstElementChild ? reel.firstElementChild.offsetHeight : itemHeight;
                const targetIndex = 9; 
                const targetY = -(targetIndex * realHeight);
                
                requestAnimationFrame(() => {
                    reel.style.transition = 'transform 1.2s cubic-bezier(0.25, 1, 0.5, 1)';
                    reel.style.transform = `translateY(${targetY}px)`;
                });
                
                setTimeout(() => { finishGeneration(finalItem, mode); }, 1200);
            }, 300);

        } 
        // === СЦЕНАРИЙ 2: ОБЫЧНАЯ ГЕНЕРАЦИЯ (СВАЙП) ===
        else {
            if(wrapper) wrapper.style.opacity = '0'; 
            
            finishGeneration(finalItem, mode);

            if(wrapper) {
                wrapper.style.transform = '';
                void wrapper.offsetWidth; 
                wrapper.style.opacity = '1';

                // Определение направления анимации
                let animClass = 'anim-fly-left'; 
                if (direction === 'entry-right') animClass = 'anim-fly-right';
                else if (direction === 'entry-left') animClass = 'anim-fly-left';
                else if (direction === 'like') animClass = 'anim-fly-left';
                else if (direction === 'dislike') animClass = 'anim-fly-right';

                wrapper.classList.add(animClass);

                setTimeout(() => {
                    wrapper.classList.remove('anim-fly-right', 'anim-fly-left');
                    wrapper.style.transform = '';
                }, 800);
            }
        }
    }

    function startNewSession(exitDirection = 'right', targetId = null) {
        if (!checkGenerationLimit(true)) return;
        
        const wrapper = document.getElementById('card-anim-wrapper');
        const startBtn = document.getElementById('start-btn-container');
        
        if(startBtn) {
            startBtn.classList.add('hidden-initial');
            startBtn.style.display = 'none';
        }

        if(wrapper) {
            const moveX = exitDirection === 'left' ? -150 : 150;
            const rotate = exitDirection === 'left' ? -15 : 15;

            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.opacity = '0';
            wrapper.style.transform = `translateX(${moveX}%) rotate(${rotate}deg)`; 
        }

        setTimeout(() => {
            sessionHistoryStack = []; 
            isFirstGen = false; 
            
            const entryAnimation = exitDirection === 'left' ? 'entry-right' : 'entry-left';
            
            // ПЕРЕДАЕМ targetId в startGeneration
            const mode = targetId ? 'specific' : 'random';
            
            startGeneration(mode, entryAnimation, targetId); 
        }, 350);
    }

    function updateCardStatusVisuals() {
        const card = document.getElementById('card-block');
        const notch = document.getElementById('card-notch');
        if (card) card.classList.remove('status-wl', 'status-fav', 'status-ban');
        if (notch) notch.classList.remove('visible');

        // В панике выходим сразу, не проверяя списки
        if (isPanicMode || !currentItem) return;

        const notchText = document.getElementById('card-notch-text');
        
        if (!card || !notch || !currentItem) return;

        // Сброс классов
        card.classList.remove('status-wl', 'status-fav', 'status-ban');
        notch.classList.remove('visible');

        const t = langData[currentLang];
        let activeStatus = null;

        // Проверяем статус (приоритет: Бан -> Лайк -> WL)
        // Но обычно WL и Лайк не пересекаются, так что порядок не критичен.
        
        if (blacklist.includes(currentItem.id)) {
            activeStatus = 'ban';
            notchText.innerText = t.status_ban;
        } 
        else if (favorites.includes(currentItem.id)) {
            activeStatus = 'fav';
            notchText.innerText = t.status_fav;
        }
        else if (watchLater.includes(currentItem.id)) {
            activeStatus = 'wl';
            notchText.innerText = t.status_wl;
        }

        // Применяем
        if (activeStatus) {
            card.classList.add('status-' + activeStatus);
            
            // Небольшая задержка для чёлки, чтобы она выезжала после появления карточки
            // Если это первый рендер
            setTimeout(() => {
                notch.classList.add('visible');
            }, 50);
        }
    }

    function renderResultUI(item, mode, customReason = null) {
        currentItem = item;
        lastGeneratedItem = item;
        
        // 1. Сброс анимаций элементов
        const elementsToReset = document.querySelectorAll('.stagger-item');
        elementsToReset.forEach(el => {
            el.style.animation = 'none';
            el.offsetHeight; /* trigger reflow */
            el.style.animation = ''; 
            // Убираем классы скрытия, чтобы элементы могли появиться
            el.classList.remove('hidden-initial', 'visually-hidden', 'fade-hidden');
        });

        let baseName = getLocalizedName(item);
        let finalHtml = baseName;

        // 2. Название (Слот)
        let displayName = getLocalizedName(item);
    
        // Формируем HTML с модификаторами
        let modifiersHtml = "";
        if (activeMods.size > 0) {
            const modNames = Array.from(activeMods).map(key => {
                const m = modifiersData.find(x => x.key === key);
                if (m) {
                    if (currentLang === 'ru') return m.ru;
                    if (currentLang === 'es') return m.es;
                    if (currentLang === 'de') return m.de;
                    return m.en;
                }
                return key;
            });
            
            // Добавляем красивый спан с плюсом
            if (modNames.length > 0) {
                modifiersHtml = ` <span style="color:var(--accent); font-weight:300; opacity:0.9;">+ ${modNames.join(" + ")}</span>`;
            }
        }

        const reel = document.getElementById('slot-reel');
        reel.removeAttribute('style');
        reel.className = 'slot-reel';
        
        // Используем innerHTML и вставляем переменную modifiersHtml
        reel.innerHTML = `<div class="slot-item final-result" id="result-text" style="color:var(--text-main); font-weight:900;">
            ${displayName}${modifiersHtml}
        </div>`;
        
        // 3. Описание
        const descEl = document.getElementById('result-desc');
        let desc = item.desc_en; 
        if (currentLang === 'ru' && item.desc_ru) desc = item.desc_ru;
        else if (currentLang === 'es' && item.desc_es) desc = item.desc_es;
        else if (currentLang === 'de' && item.desc_de) desc = item.desc_de;
        
        if(descEl) {
            descEl.innerText = desc || "";
            descEl.style.display = 'block'; 
        }

        // 4. Фраза сверху
        const statusEl = document.getElementById('status-text');
        if(statusEl) {
            statusEl.style.display = 'flex'; 
            statusEl.classList.remove('hidden-initial'); 
            
            if (customReason) {
                statusEl.innerHTML = customReason;
                statusEl.style.color = "var(--accent)";
            } 
            else {
                const explanation = getExplanationText(mode);
                
                if (explanation) {
                    statusEl.innerText = explanation;
                    
                    if (mode === 'panic') {
                        // В панике цвет нейтральный или зеленый
                        statusEl.style.color = "var(--text-main)"; 
                    } else {
                        // В обычном режиме - акцентный
                        statusEl.style.color = "var(--accent)";
                    }
                    
                } else {
                    const comments = resultComments[currentLang];
                    statusEl.innerText = comments[Math.floor(Math.random() * comments.length)];
                    statusEl.style.color = "var(--text-secondary)";
                }
            }
        }

        // 5. Карточка (Эффекты)
        const card = document.getElementById('card-block');
        if(card) {
            card.classList.remove('is-spinning');
            card.classList.add('has-results');
            
            // Вспышка
            card.classList.add('flash-active'); 
            setTimeout(() => card.classList.remove('flash-active'), 300);
            
            // Сброс позиций и цветов
            card.style.transform = 'translate(0, 0) rotate(0)';
            card.style.backgroundColor = '';
            card.style.borderColor = '';
            card.style.filter = '';
            card.style.transition = 'none';
        }

        // 6. ПЕРЕКЛЮЧЕНИЕ КНОПОК
        
        // А. Скрываем кнопку "Поехали"
        const startBtnContainer = document.getElementById('start-btn-container');
        if (startBtnContainer) {
            startBtnContainer.classList.add('hidden-initial'); // Добавляем класс
            startBtnContainer.style.display = 'none'; // Дублируем инлайном для надежности
        }

        // Б. Показываем игровые кнопки, моды и "Похожее"
        const idsToShow = ['tinder-controls', 'mods-block', 'related-block'];
        idsToShow.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('hidden-initial', 'visually-hidden');
                el.style.display = 'flex'; // Принудительно ставим flex
                
                // Перезапуск анимации появления
                el.style.animation = 'none';
                el.offsetHeight;
                el.style.animation = '';
            }
        });

        // 7. Кнопка Undo
        const btnUndo = document.getElementById('btn-t-undo');
        if (btnUndo) {
            if (sessionHistoryStack && sessionHistoryStack.length > 0) {
                btnUndo.disabled = false;
                btnUndo.style.opacity = "1";
            } else {
                btnUndo.disabled = true;
                btnUndo.style.opacity = "0.3";
            }
        }

        updateLink();
        renderBadges();
        renderRelatedItems();
        updateActionButtons();
        updateCardStatusVisuals();
        randomizeDecorations(item);
    }

    function updateActionButtons() {
        if(!currentItem) return;
        
        const btnPass = document.getElementById('btn-t-pass'); // Крестик
        const btnLike = document.getElementById('btn-t-like'); // Сердце
        const btnWL = document.getElementById('btn-t-wl');     // Звезда

        // Сброс стилей (убираем inline стили фона/бордера, оставляем классы)
        if (btnPass) btnPass.style.background = "";
        if (btnLike) btnLike.style.background = "";
        if (btnWL) btnWL.classList.remove('active');

        // Ставим стили для активных
        if (blacklist.includes(currentItem.id)) {
            if (btnPass) btnPass.style.background = "#e74c3c"; // Красный фон
            if (btnPass) btnPass.style.color = "#fff";
        } 
        if (favorites.includes(currentItem.id)) {
            if (btnLike) btnLike.style.background = "#2ecc71"; // Зеленый фон
            if (btnLike) btnLike.style.color = "#fff";
        }
        if (watchLater.includes(currentItem.id)) {
            if (btnWL) btnWL.classList.add('active'); // Добавляет синий
        } else {
            if (btnWL) btnWL.classList.remove('active'); // Убирает синий (становится серым)
        }
    }

    function updateItemScore(id, delta) {
        // Если записи нет, создаем (0)
        if (!itemScores[id]) itemScores[id] = 0;

        // Изменяем счет
        itemScores[id] += delta;

        // === ЛОГИКА ЗАЩИТЫ ===
        // Если предмет пытается уйти в минус (дизлайк), но он защищен
        if (itemScores[id] < 0 && protectedFavorites.includes(id)) {
            // Принудительно держим баланс положительным, чтобы он оставался в Favorites
            itemScores[id] = 10; 
            console.log(`Item ${id} is protected. Preventing blacklist.`);
            // Принудительно сохраняем в Favorites, если вдруг его там нет
            if (!favorites.includes(id)) favorites.push(id);
            // Удаляем из ЧС
            blacklist = blacklist.filter(x => x !== id);
        }
        // =====================
        
        // Стандартная логика (else if, так как выше мы перехватили условие)
        else if (itemScores[id] > 0) {
            // Баланс положительный -> В Избранное
            if (!favorites.includes(id)) favorites.push(id);
            blacklist = blacklist.filter(x => x !== id);
        } 
        else if (itemScores[id] < 0) {
            // Баланс отрицательный -> В ЧС
            if (!blacklist.includes(id)) blacklist.push(id);
            favorites = favorites.filter(x => x !== id);
        } 
        else {
            // Баланс НОЛЬ -> Нейтрально (убираем отовсюду, если не защищен)
            if (!protectedFavorites.includes(id)) {
                favorites = favorites.filter(x => x !== id);
            }
            blacklist = blacklist.filter(x => x !== id);
            delete itemScores[id];
        }

        // Сохраняем всё
        saveLists();
        localStorage.setItem('xch_item_scores', JSON.stringify(itemScores));
        
        // Обновляем UI
        updateActionButtons(); 
        updateCounts();
        updateCardStatusVisuals();
        if (window.markDirty) window.markDirty();
    }

    function syncScoresFromLists() {
        let changed = false;
        // Если есть в Избранном, но нет счета — ставим +1
        favorites.forEach(id => {
            if (!itemScores[id] || itemScores[id] <= 0) {
                itemScores[id] = 1;
                changed = true;
            }
        });
        // Если есть в ЧС, но нет счета — ставим -1
        blacklist.forEach(id => {
            if (!itemScores[id] || itemScores[id] >= 0) {
                itemScores[id] = -1;
                changed = true;
            }
        });
        if (changed) {
            localStorage.setItem('xch_item_scores', JSON.stringify(itemScores));
        }
    }

    function toggleFavorite(silent = false) {
        if (isPanicMode) return;
        if (!currentItem) return;
        const id = currentItem.id;
        
        // Добавляем +1 к карме видео
        updateItemScore(id, 3);

        if (!silent) {
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, 5); // Бустим теги
            hasInteractedWithCurrent = true;
            logActivity('like', id, fullTags);
        }
    }

    function toggleBlacklist(silent = false) {
        if (isPanicMode) return;
        if (!currentItem) return;
        const id = currentItem.id;

        if (watchLater.includes(id)) return;

        // Отнимаем -1 от кармы видео
        updateItemScore(id, -1);

        if (!silent) {
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, -5); // Понижаем теги
            logActivity('dislike', id, fullTags);
        }
    }

    function toggleWatchLater() {
        if (isPanicMode) return;
        if(!currentItem) return;
        const id = currentItem.id;
        const btn = document.getElementById('btn-t-wl');

        if (watchLater.includes(id)) {
            watchLater = watchLater.filter(x => x !== id);
            if(btn) btn.classList.remove('active');
        } else {
            watchLater.push(id);
            if(btn) btn.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(50);
        }
        
        localStorage.setItem(STORAGE.WATCH_LATER, JSON.stringify(watchLater));
        updateCounts(); 
        if (window.markDirty) window.markDirty();
    }

    function openWatchLaterCatalog() {
        renderListModal('wl');
    }

    function openWrapped() {
        triggerWrappedBtn();
    }

    function startSlideTimer(total, duration = 9000) {
        clearInterval(slideInterval);
        
        const show = (idx) => {
            document.querySelectorAll('.wrapped-slide').forEach(el => el.classList.remove('active-slide'));
            document.querySelectorAll('.wrapped-slide')[idx].classList.add('active-slide');
            
            for(let i=0; i<total; i++) {
                const bar = document.getElementById('bar-'+i);
                if(i < idx) { 
                    bar.style.width = '100%'; 
                    bar.style.transition = 'none'; 
                }
                else if(i > idx) { 
                    bar.style.width = '0%'; 
                    bar.style.transition = 'none'; 
                }
                else {
                    bar.style.width = '0%';
                    bar.style.transition = 'none';
                    setTimeout(() => {
                        // Используем linear для плавного заполнения
                        bar.style.transition = `width ${duration}ms linear`;
                        bar.style.width = '100%';
                    }, 50);
                }
            }
        };

        show(currentSlideIndex);

        slideInterval = setInterval(() => {
            if (currentSlideIndex < total - 1) {
                currentSlideIndex++;
                show(currentSlideIndex);
            } else {
                clearInterval(slideInterval); 
            }
        }, duration);
    }

    function nextSlide() {
        const total = document.querySelectorAll('.wrapped-slide').length;
        if (currentSlideIndex < total - 1) {
            currentSlideIndex++;
            startSlideTimer(total);
        } else {
            closeWrapped();
        }
    }

    function prevSlide() {
        const total = document.querySelectorAll('.wrapped-slide').length;
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            startSlideTimer(total);
        }
    }

    function closeWrapped() {
        clearInterval(slideInterval);
        document.getElementById('wrapped-mount').classList.remove('active');
    }

    function toggleInstallInstruct(platform) {
        const el = document.getElementById('instruct-' + platform);
        const isVisible = el.style.display === 'block';
        
        // Скрываем все
        document.getElementById('instruct-ios').style.display = 'none';
        document.getElementById('instruct-android').style.display = 'none';
        
        // Показываем нужный, если он был скрыт
        if (!isVisible) {
            el.style.display = 'block';
        }
    }

    function isAppInstalled() {
        // iOS Standalone или стандартный display-mode
        return (window.navigator.standalone === true) || (window.matchMedia('(display-mode: standalone)').matches);
    }

    function skipInstall() {
        document.getElementById('modal-install-overlay').classList.remove('open');
        // Помечаем, что видели (на эту сессию или навсегда - решать вам)
        sessionStorage.setItem('xch_install_skipped', 'true'); 
        
        // Переходим к следующему шагу (Онбординг предпочтений)
        checkOnboarding(); 
    }

    function checkOnboarding() {
        const isOnboarded = localStorage.getItem('xch_onboarding_done');
        if (!isOnboarded) {
            document.getElementById('onboarding-overlay').classList.add('open');
        }
    }

    function openLoginModal() {
        document.getElementById('modal-login-overlay').classList.add('open');
    }

    function closeLoginModal(e, force) {
        if (force || e.target.id === 'modal-login-overlay') {
            document.getElementById('modal-login-overlay').classList.remove('open');
        }
    }

    function performGoogleLogin() {
        // Закрываем модалку
        document.getElementById('modal-login-overlay').classList.remove('open');
        // Вызываем оригинальную функцию из модуля Firebase
        window.loginWithGoogle();
    }

    function changeOrientation(val) {
        currentOrientation = val;
        localStorage.setItem('xch_orientation', val);
    }

    function openRoadmap() {
        document.getElementById('modal-roadmap-overlay').classList.add('open');
    }

    function closeRoadmap(e, force) {
        if (force || e.target.id === 'modal-roadmap-overlay') {
            document.getElementById('modal-roadmap-overlay').classList.remove('open');
        }
    }

    function openQRModal() {
        // Генерируем ссылку на текущий URL
        const currentUrl = window.location.href;
        // Используем API для генерации QR
        const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=10&data=${encodeURIComponent(currentUrl)}`;
        
        document.getElementById('qr-code-img').src = qrApi;
        document.getElementById('modal-qr-overlay').classList.add('open');
    }

    function closeQRModal(e, force) {
        if (force || e.target.id === 'modal-qr-overlay') {
            document.getElementById('modal-qr-overlay').classList.remove('open');
        }
    }

    function initDecoSettings() {
        // По умолчанию true (показывать), если в памяти нет записи
        const saved = localStorage.getItem('xch_show_deco');
        const isEnabled = saved !== 'false'; // Если null или 'true', то true

        // Обновляем состояние чекбокса
        const toggle = document.getElementById('deco-toggle');
        if (toggle) toggle.checked = isEnabled;

        // Применяем класс
        applyDecoState(isEnabled);
    }

    function toggleDecoIcons(isChecked) {
        localStorage.setItem('xch_show_deco', isChecked);
        applyDecoState(isChecked);
    }

    function applyDecoState(isEnabled) {
        if (isEnabled) {
            document.body.classList.remove('no-deco');
        } else {
            document.body.classList.add('no-deco');
        }
    }

    function randomizeDecorations(item = null) {
        const leftImg = document.getElementById('deco-left');
        const rightImg = document.getElementById('deco-right');
        
        if (!leftImg || !rightImg) return;

        let selectedIcons = [];

        // ШАГ 1: Пытаемся найти специфичные иконки, если передан предмет
        if (item && item.tags) {
            item.tags.forEach(tag => {
                if (tag === 'general') return; 

                if (TAG_ICONS[tag]) {
                    selectedIcons.push(...TAG_ICONS[tag]);
                }
            });
        }

        // Убираем дубликаты (если один файл прописан в разных тегах)
        selectedIcons = [...new Set(selectedIcons)];
        
        // Перемешиваем найденные специфичные иконки
        selectedIcons.sort(() => 0.5 - Math.random());

        // ШАГ 2: Заполняем пропуски нейтральными
        // Нам нужно ровно 2 иконки (левая и правая)
        
        // Если специфичных нет вообще -> берем две нейтральные
        if (selectedIcons.length === 0) {
            selectedIcons.push(getRandomNeutral());
            selectedIcons.push(getRandomNeutral(selectedIcons[0])); // Передаем первую, чтобы вторая не совпала
        } 
        // Если есть только одна специфичная -> добавляем к ней одну нейтральную
        else if (selectedIcons.length === 1) {
            selectedIcons.push(getRandomNeutral());
        }
        // Если специфичных 2 или больше -> массив уже заполнен (лишние обрежутся ниже)

        // ШАГ 3: Применяем
        leftImg.src = selectedIcons[0];
        rightImg.src = selectedIcons[1];
    }

    function getRandomNeutral(excludeSrc = null) {
        let pool = NEUTRAL_DECOS;
        if (excludeSrc) {
            pool = pool.filter(src => src !== excludeSrc);
        }
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function calculateWatchTime() {
        // Проверка: было ли начало просмотра и есть ли сохраненный предмет
        if (watchStartTime === 0 || !itemBeingWatched) return;

        const now = Date.now();
        const diffInSeconds = Math.floor((now - watchStartTime) / 1000);
        
        watchStartTime = 0; 

        // Игнорируем меньше 5 сек
        if (diffInSeconds < 5) return;

        // ... (код расчета времени остается тем же) ...
        let timeString = "";
        const minLabel = currentLang === 'ru' ? 'мин' : 'min';
        const secLabel = currentLang === 'ru' ? 'сек' : 'sec';

        if (diffInSeconds > 1800) {
            timeString = `30+ ${minLabel}`;
        } else {
            const minutes = Math.floor(diffInSeconds / 60);
            const seconds = diffInSeconds % 60;
            if (minutes > 0) timeString = `${minutes} ${minLabel} ${seconds} ${secLabel}`;
            else timeString = `${seconds} ${secLabel}`;
        }

        // Сохранение в историю 
        const historyEntry = {
            id: itemBeingWatched.id,
            timestamp: Date.now(),
            durationStr: timeString,
            seconds: diffInSeconds
        };
        watchHistory.unshift(historyEntry);
        if (watchHistory.length > 100) watchHistory.pop();
        localStorage.setItem(STORAGE.WATCH_HISTORY, JSON.stringify(watchHistory));
        if (window.markDirty) window.markDirty();

        // === ВЫВОД СООБЩЕНИЯ С ТАЙМЕРОМ ===
        const t = langData[currentLang] || langData['en'];
        let phraseTemplate = "";
        
        if (diffInSeconds > 1800) phraseTemplate = (currentLang === 'ru') ? "Долгое погружение... 🌊" : "Deep dive... 🌊";
        else if (diffInSeconds < 40) phraseTemplate = t.return_phrase_short || "Only {t}...";
        else {
            const phrases = t.return_phrases || ["{t} passed."];
            phraseTemplate = phrases[Math.floor(Math.random() * phrases.length)];
        }
        
        const finalPhrase = phraseTemplate.includes("{t}") ? phraseTemplate.replace("{t}", timeString) : phraseTemplate;

        const statusEl = document.getElementById('status-text');
        if (statusEl) {
            // Сброс старого таймера
            if (statusHideTimeout) clearTimeout(statusHideTimeout);

            statusEl.style.transition = "none";
            statusEl.style.opacity = '0';
            
            setTimeout(() => {
                statusEl.innerText = finalPhrase;
                statusEl.style.color = "var(--text-main)";
                statusEl.style.transition = "opacity 0.3s ease";
                statusEl.style.opacity = '1';

                // Новый таймер на 5 секунд
                statusHideTimeout = setTimeout(() => {
                    statusEl.style.transition = "opacity 1s ease";
                    statusEl.style.opacity = "0";
                }, 5000);
            }, 200);
        }
    }

    function resetToHome() {

        const homeTab = document.getElementById('tab-home');
        if (!homeTab || !homeTab.classList.contains('active')) {
            return; 
        }

        // Если идет генерация — не прерываем
        if (isGenerating) return;

        const wrapper = document.getElementById('card-anim-wrapper');
        const card = document.getElementById('card-block');
        
        // 1. АНИМАЦИЯ УХОДА ТЕКУЩЕЙ КАРТОЧКИ
        if (wrapper) {
            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.transform = 'translateX(-150%) rotate(-10deg)';
            wrapper.style.opacity = '0';
        }

        // Ждем окончания анимации (350мс)
        setTimeout(() => {
            // 2. СБРОС ДАННЫХ
            currentItem = null;
            lastGeneratedItem = null;
            isFirstGen = true; 
            sessionHistoryStack = []; 

            // 3. СБРОС ИНТЕРФЕЙСА РЕЗУЛЬТАТОВ
            const uiToHide = ['result-desc', 'tinder-controls', 'mods-block', 'related-block'];
            uiToHide.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.add('hidden-initial'); 
                    el.style.display = 'none'; 
                }
            });

            // Очищаем бейджи и статус
            document.getElementById('badge-wrapper').innerHTML = '';
            const statusEl = document.getElementById('status-text');
            if(statusEl) statusEl.innerText = ''; 

            // Сброс классов карточки
            if(card) {
                card.classList.remove('has-results', 'flash-active', 'status-wl', 'status-fav', 'status-ban');
                card.style.transform = ''; 
                card.style.filter = 'none';
                
                const notch = document.getElementById('card-notch');
                if(notch) notch.classList.remove('visible');
            }

            initIdleSlot();
            randomizeDecorations();

            // Сброс декоративных иконок
            const iconLeft = document.querySelector('.icon-left');
            const iconRight = document.querySelector('.icon-right');
            [iconLeft, iconRight].forEach(icon => {
                if(icon) {
                    icon.style.transition = 'none';
                    icon.style.opacity = '';
                    icon.style.transform = '';
                    icon.style.animation = ''; 
                }
            });

            // === 4. ВОССТАНОВЛЕНИЕ НАЧАЛЬНОГО ЭКРАНА (FIXED) ===
            const totalInteractions = favorites.length + blacklist.length;
            const startBtn = document.getElementById('start-btn-container');
            const overlay = document.getElementById('mode-start-overlay');
            
            // Сброс UI ассистента
            document.getElementById('assistant-ui').classList.remove('visible');
            document.getElementById('thinking-ui').style.display = 'none';
            document.getElementById('ai-input').value = '';

            // Элементы внутри оверлея
            const startText = document.getElementById('mode-start-text');
            const modeBtns = document.getElementById('mode-buttons-container');

            // ПРИНУДИТЕЛЬНЫЙ СБРОС СТИЛЕЙ (Убираем последствия анимаций)
            if(startText) {
                startText.classList.remove('fade-out-up');
                startText.style.opacity = '1';
                startText.style.display = 'block';
                startText.style.transform = 'translate(0,0)';
            }
            if(modeBtns) {
                modeBtns.classList.remove('fade-out-up');
                modeBtns.style.opacity = '1';
                modeBtns.style.pointerEvents = 'auto';
                modeBtns.style.display = 'flex';
                modeBtns.style.transform = 'translate(0,0)';
            }

            if (totalInteractions >= 10) {
                // Опытный: Показываем оверлей режимов
                randomizeModeGreeting(); 

                if(overlay) {
                    overlay.classList.remove('hidden');
                    overlay.style.display = 'flex'; 
                    overlay.style.opacity = '1';
                    overlay.style.pointerEvents = 'auto';
                    overlay.style.transform = 'scale(1)';
                }
                
                isModeSelectionActive = true; 
                
                if(startBtn) {
                    startBtn.classList.add('hidden-initial');
                    startBtn.style.display = 'none';
                }

            } else {
                // Новичок: Показываем кнопку "Let's Go"
                if(overlay) {
                    overlay.classList.add('hidden');
                    overlay.style.display = 'none';
                }
                isModeSelectionActive = false;

                if(startBtn) {
                    startBtn.classList.remove('hidden-initial');
                    startBtn.style.display = 'flex';
                    startBtn.style.opacity = '1';
                }
            }

            // 5. ВОЗВРАЩЕНИЕ КАРТОЧКИ
            if (wrapper) {
                wrapper.style.transition = 'none';
                wrapper.style.transform = 'scale(0.95)'; 
                void wrapper.offsetWidth; 
                wrapper.style.transition = 'opacity 0.5s ease, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                wrapper.style.opacity = '1';
                wrapper.style.transform = 'scale(1)';
            }

        }, 350);
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') {
            // Если пользователь залогинен, форсируем сохранение (immediate = true)
            if (window.isUserLoggedIn) {
                console.log("App hidden, forcing save...");
                window.syncToCloud(true);
            }
        }
    });

    document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden') {
                // Когда пользователь сворачивает приложение, мы делаем финальную проверку
                updateAppBadge();
            }
        });

    function openSponsorsModal() {
        const list = document.getElementById('sponsors-list');
        list.innerHTML = '';

        earlySponsors.forEach(person => {
            const row = document.createElement('div');
            row.className = 'ios-row';
            row.style.cursor = 'default'; // Не кликабельно
            row.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:18px;">💎</span>
                    <span style="font-weight:600; color:var(--text-main);">${person.name}</span>
                </div>
                <span style="font-size:12px; color:var(--text-secondary);">${person.date}</span>
            `;
            list.appendChild(row);
        });

        document.getElementById('modal-sponsors-overlay').classList.add('open');
    }

    function closeSponsorsModal(e, force) {
        if (force || e.target.id === 'modal-sponsors-overlay') {
            document.getElementById('modal-sponsors-overlay').classList.remove('open');
        }
    }

    // Защита от XSS (вставка HTML тегов в никнейм)
    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function openHistoryModal() {
        document.getElementById('modal-history-overlay').classList.add('open');
        // Рендерим текущую вкладку
        switchHistoryTab(currentHistoryTab);
    }

    function closeHistoryModal(e, force) {
        if (force || e.target.id === 'modal-history-overlay') {
            const modal = document.getElementById('modal-history-overlay');
            modal.classList.remove('open');
        }
    }

    function switchHistoryTab(tab) {
        currentHistoryTab = tab;

        // 1. Получаем ссылки на кнопки
        const navs = {
            swipes: document.getElementById('hist-nav-swipes'),
            watch: document.getElementById('hist-nav-watch'),
            wrapped: document.getElementById('hist-nav-wrapped')
        };

        // 2. Получаем ссылки на списки
        const lists = {
            swipes: document.getElementById('hist-list-swipes'),
            watch: document.getElementById('hist-list-watch'),
            wrapped: document.getElementById('hist-list-wrapped')
        };

        // 3. Сбрасываем активные классы и скрываем списки
        Object.values(navs).forEach(el => { if(el) el.classList.remove('active'); });
        Object.values(lists).forEach(el => { if(el) el.style.display = 'none'; });

        // 4. Активируем нужную вкладку
        if (navs[tab]) navs[tab].classList.add('active');
        if (lists[tab]) lists[tab].style.display = 'block';

        // 5. Рендерим содержимое
        if (tab === 'wrapped') {
            if(typeof renderWrappedArchive === 'function') renderWrappedArchive();
        } else if (tab === 'swipes') {
            if(typeof renderSwipesHistoryList === 'function') renderSwipesHistoryList();
        } else if (tab === 'watch') {
            if(typeof renderWatchHistoryList === 'function') renderWatchHistoryList();
        }
    }

    function renderSwipesHistoryList() {
        const list = document.getElementById('hist-list-swipes');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (historyData.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">${t.hist_empty}</div>`;
            return;
        }

        historyData.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;
            
            // 1. Форматирование даты и времени
            const dateObj = new Date(entry.timestamp);
            const now = new Date();
            const isToday = dateObj.toDateString() === now.toDateString();
            
            // Время (ЧЧ:ММ)
            const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Дата (ДД.ММ), если не сегодня
            let dateDisplay = "";
            if (!isToday) {
                const day = dateObj.getDate().toString().padStart(2, '0');
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                dateDisplay = `${day}.${month}`;
            } else {
                dateDisplay = currentLang === 'ru' ? "Сегодня" : "Today";
            }

            // 2. Определение статуса (Иконка)
            let statusIcon = '⚪'; // По умолчанию (пропуск)
            let statusOpacity = '0.3'; // Для нейтрального статуса
            let statusColor = 'var(--text-secondary)';

            // Проверяем текущее состояние (Live status)
            if (blacklist.includes(item.id)) {
                statusIcon = '⛔'; // Дизлайк
                statusOpacity = '1';
                statusColor = 'var(--highlight-red)';
            } 
            else if (favorites.includes(item.id)) {
                statusIcon = '💚'; // Лайк
                statusOpacity = '1';
                statusColor = 'var(--accent)';
            } 
            else if (watchLater.includes(item.id)) {
                statusIcon = '⏰'; // WL
                statusOpacity = '1';
                statusColor = '#3498db';
            } 
            else {
                // Проверка на просмотр (если нет в списках, но смотрел)
                const isWatched = watchHistory.some(w => w.id === item.id);
                if (isWatched) {
                    statusIcon = '👁️';
                    statusOpacity = '0.8';
                    statusColor = 'var(--text-main)';
                }
            }

            const div = document.createElement('div');
            div.className = 'ios-row clickable';
            div.style.padding = '10px 20px'; 
            
            const name = getLocalizedName(item);

            div.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <div style="font-weight:600; font-size:15px; color:var(--text-main);">${name}</div>
                    <div style="font-size:11px; color:var(--text-secondary);">
                        ${dateDisplay}, ${timeStr}
                    </div>
                </div>
                
                <div style="display:flex; align-items:center; gap:15px;">
                    <!-- Иконка статуса -->
                    <div style="font-size:16px; opacity:${statusOpacity}; color:${statusColor};" title="Status">
                        ${statusIcon}
                    </div>
                    
                    <!-- Кнопка повтора -->
                    <div style="color:var(--accent); font-size:20px; opacity:0.8;">↺</div>
                </div>
            `;
            
            div.onclick = () => { 
                closeHistoryModal(null, true);
                switchTab('home'); 
                forceShowResult(item, 'history'); 
            };
            list.appendChild(div);
        });
    }

    function renderWatchHistoryList() {
        const list = document.getElementById('hist-list-watch');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (watchHistory.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">${t.hist_empty_watch}</div>`;
            return;
        }

        watchHistory.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;

            const div = document.createElement('div');
            div.className = 'ios-row clickable';
            div.style.padding = '12px 20px';

            const name = getLocalizedName(item);
            const d = new Date(entry.timestamp);
            const dateStr = d.toLocaleDateString() === new Date().toLocaleDateString() 
                ? d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                : d.toLocaleDateString([], {day:'numeric', month:'numeric'}) + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            div.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div style="font-weight:600;">${name}</div>
                    <div style="font-size:11px; color:var(--text-secondary);">${dateStr}</div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
                    <span style="font-weight:700; color:var(--text-main); font-size:15px;">${entry.durationStr}</span>
                    <span style="font-size:10px; color:var(--accent);">${t.hist_watched}</span>
                </div>
            `;
            
            div.onclick = () => {
                closeHistoryModal(null, true);
                switchTab('home');
                forceShowResult(item, 'history');
            };
            
            list.appendChild(div);
        });
    }

    window.openAdminModal = function() {
        document.getElementById('modal-admin-overlay').classList.add('open');
    };

    window.closeAdminModal = function(e, force) {
        if (force || e.target.id === 'modal-admin-overlay') {
            document.getElementById('modal-admin-overlay').classList.remove('open');
        }
    };

    function initModes() {
        const totalInteractions = favorites.length + blacklist.length;
        const hasEnoughData = totalInteractions >= 10;

        const capsules = document.querySelectorAll('.mode-capsule-wrapper');
        const startOverlay = document.getElementById('mode-start-overlay');
        const startBtn = document.getElementById('start-btn-container');

        if (hasEnoughData) {
            randomizeModeGreeting();
            // 1. Показываем капсулы (CSS media query решит, какую именно)
            capsules.forEach(el => el.style.display = 'block');
            
            // 2. Показываем Оверлей выбора в карточке
            if(startOverlay) {
                startOverlay.classList.remove('hidden');
                isModeSelectionActive = true;
            }

            // 3. Скрываем старую кнопку "Поехали" (она нам не нужна)
            if(startBtn) {
                startBtn.classList.add('hidden-initial'); // Скрываем через класс
                startBtn.style.display = 'none'; // И на всякий случай инлайном
            }
            
            // Обновляем текст в капсулах
            updateCapsuleUI();

        } else {
            // Если мало действий — скрываем всё новое, работаем как раньше
            capsules.forEach(el => el.style.display = 'none');
            if(startOverlay) startOverlay.classList.add('hidden');
            isModeSelectionActive = false;
            
            // Убеждаемся, что кнопка старта видна
            if(startBtn) {
                startBtn.classList.remove('hidden-initial');
                startBtn.style.display = 'flex';
            }
        }
    }

    function randomizeModeGreeting() {
        const el = document.getElementById('mode-start-text');
        if (!el) return;
        
        suggestedFavId = null;
        suggestedNewId = null;
        
        const t = langData[currentLang] || langData['en'];
        let finalPhrase = "";
        let favName = null;
        let newName = null;

        // 1. Поиск кандидата из истории (Наслаждение)
        const watchedIds = watchHistory.slice(0, 20).map(w => w.id);
        const sourceIds = [...new Set([...favorites, ...watchedIds])];
        const validCandidates = data.filter(item => sourceIds.includes(item.id) && !blacklist.includes(item.id));

        if (validCandidates.length > 0) {
            const winnerItem = validCandidates[Math.floor(Math.random() * validCandidates.length)];
            favName = getLocalizedName(winnerItem);
            suggestedFavId = winnerItem.id; 
        }

        // 2. Поиск нового кандидата (Исследование)
        let safePool = data;
        if (currentIntensity === 1) {
            safePool = data.filter(item => !item.tags.some(t => EXTREME_TAGS.includes(t) || SPICY_TAGS.includes(t)));
        } else if (currentIntensity === 2) {
            safePool = data.filter(item => !item.tags.some(t => EXTREME_TAGS.includes(t)));
        }

        const randomPool = safePool.sort(() => 0.5 - Math.random()).slice(0, 50).filter(item => !blacklist.includes(item.id) && !favorites.includes(item.id) && item.name !== favName);
        
        if (randomPool.length > 0) {
            const randomNewItem = randomPool[0];
            newName = getLocalizedName(randomNewItem);
            suggestedNewId = randomNewItem.id;
        }

        // --- ЛОГИКА ЦВЕТОВ ---
        const currentTheme = document.body.getAttribute('data-theme') || 'dark';
        let colorPleasure, colorExplore;

        if (currentTheme === 'noir') {
            // Нуар: Светло-серый (Pleasure) и Темно-серый (Explore)
            colorPleasure = "#dddddd"; 
            colorExplore = "#666666"; 
        } 
        else if (currentTheme === 'old-money') {
            // Old Money: Sage Green (Pleasure) и Dusty Red (Explore)
            colorPleasure = "#7d8c7c"; 
            colorExplore = "#a67c7c"; 
        } 
        else {
            // Дефолт и цветные темы: Зеленый (Pleasure) и Красный (Explore)
            // Эти цвета совпадают с градиентами кнопок внизу
            colorPleasure = "#2ecc71"; // Зеленый
            colorExplore = "#e74c3c";  // Красный
        }

        // Формирование фразы
        if (favName && newName && t.mode_greeting_dynamic) {
            const templates = t.mode_greeting_dynamic;
            const template = templates[Math.floor(Math.random() * templates.length)];
            
            // {fav} -> Pleasure Mode -> colorPleasure
            // {new} -> Explore Mode -> colorExplore
            finalPhrase = template
                .replace('{fav}', `<span style="color:${colorPleasure}; font-weight:900;">${favName}</span>`)
                .replace('{new}', `<span style="color:${colorExplore}; font-weight:900;">${newName}</span>`);
        } else {
            const phrases = Array.isArray(t.mode_greeting_hint) ? t.mode_greeting_hint : [t.mode_greeting_hint];
            finalPhrase = phrases[Math.floor(Math.random() * phrases.length)];
        }
                
        el.innerHTML = finalPhrase;
    }

    function toggleModeDropdown(type) {
        const id = type === 'pc' ? 'mode-capsule-pc' : 'mode-capsule-mobile';
        const wrapper = document.getElementById(id);
        
        // Закрываем другую, если открыта (опционально)
        document.querySelectorAll('.mode-capsule-wrapper').forEach(el => {
            if(el.id !== id) el.classList.remove('open');
        });

        wrapper.classList.toggle('open');
    }

    function setAppMode(mode) {
        currentAppMode = mode;
        updateCapsuleUI();
        
        const startOverlay = document.getElementById('mode-start-overlay');
        if (startOverlay && !startOverlay.classList.contains('hidden')) {
        }

        console.log("Mode set to:", mode);
    }

    function setAppModeAndStart(mode) {
        setAppMode(mode);
        
        const overlay = document.getElementById('mode-start-overlay');
        if(overlay) {
            overlay.style.transition = 'opacity 0.3s, transform 0.3s';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
        
        isModeSelectionActive = false;
        
        const direction = (mode === 'explore') ? 'left' : 'right';
        
        // ОПРЕДЕЛЯЕМ ЦЕЛЕВОЙ ID
        let specificId = null;
        if (mode === 'pleasure' && suggestedFavId) {
            specificId = suggestedFavId;
        } else if (mode === 'explore' && suggestedNewId) {
            specificId = suggestedNewId;
        }
        
        // Передаем ID дальше
        startNewSession(direction, specificId);
    }

    function updateCapsuleUI() {
        const select = document.getElementById('app-mode-select');
        if (!select) return;

        const t = langData[currentLang] || langData['en'];
        
        // Проверяем, есть ли уже опция AI
        let aiOption = select.querySelector('option[value="ai"]');

        if (currentAppMode === 'ai') {
            // Если режим AI активен, но опции нет -> добавляем
            if (!aiOption) {
                aiOption = document.createElement('option');
                aiOption.value = 'ai';
                aiOption.innerText = "🤖 " + (t.mode_ai || "AI Agent");
                select.appendChild(aiOption);
            }
            // Выбираем её
            select.value = 'ai';
        } else {
            if (aiOption) {
                aiOption.remove();
            }
            select.value = currentAppMode;
        }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.mode-capsule-wrapper')) {
            document.querySelectorAll('.mode-capsule-wrapper').forEach(el => el.classList.remove('open'));
        }
    });

    function getEditDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;

        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1, // замена
                        Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1) // вставка/удаление
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    function isFuzzyMatch(token, targetWord) {
        token = token.toLowerCase();
        targetWord = targetWord.toLowerCase();

        // А. Если одно содержится в другом (стандартный поиск)
        if (targetWord.includes(token)) return true;

        // Б. Проверка корня (для русского языка очень полезно)
        // Если слова длиннее 4 букв и первые 4 буквы совпадают (рыжими - рыжие)
        if (token.length >= 4 && targetWord.length >= 4) {
            if (token.substring(0, 4) === targetWord.substring(0, 4)) return true;
        }

        // В. Расстояние Левенштейна (для опечаток и коротких слов)
        // Считаем % сходства
        const len = Math.max(token.length, targetWord.length);
        if (len === 0) return false;
        
        const dist = getEditDistance(token, targetWord);
        const similarity = 1 - (dist / len);

        // Если совпадение больше 70% (0.7)
        return similarity >= 0.7; 
    }

    function analyzeUserRequest(text) {
    const rawText = text.toLowerCase();
    
    // --- 0. ПРЕДВАРИТЕЛЬНАЯ ОЧИСТКА ---
    // Убираем "связанное с", "хочу" и т.д.
    let cleanText = rawText;
    CLEAN_PHRASES.forEach(phrase => cleanText = cleanText.split(phrase).join(" "));
    STOP_WORDS.forEach(word => cleanText = cleanText.replace(new RegExp(`\\b${word}\\b`, 'g'), " "));
    
    // Сжимаем пробелы
    cleanText = cleanText.replace(/\s+/g, " ").trim();

    // === 1. ПРОВЕРКА СПЕЦИАЛЬНЫХ КОМАНД ===
    
    // А. "УДИВИ МЕНЯ" (Surprise)
    const surpriseKw = SPECIAL_COMMANDS.surprise[currentLang] || SPECIAL_COMMANDS.surprise.en;
    if (surpriseKw.some(kw => rawText.includes(kw))) {
        // Берем случайное из базы (но не из ЧС)
        const randomPool = data.filter(x => !blacklist.includes(x.id));
        const item = randomPool[Math.floor(Math.random() * randomPool.length)];
        
        const reasons = {
            en: "Fate decided! 🎲",
            ru: "Судьба решила! 🎲",
            es: "¡El destino decidió! 🎲",
            de: "Das Schicksal hat entschieden! 🎲"
        };
        return { item: item, reason: reasons[currentLang] || reasons.en, detectedMods: [] };
    }

    // Б. "КАК ВЧЕРА" (Yesterday)
    const yesterKw = SPECIAL_COMMANDS.yesterday[currentLang] || SPECIAL_COMMANDS.yesterday.en;
    if (yesterKw.some(kw => rawText.includes(kw))) {
        if (watchHistory.length > 0) {
            // Берем последний просмотренный
            const lastId = watchHistory[0].id;
            const item = data.find(x => x.id === lastId);
            if (item) {
                const reasons = {
                    en: "As you requested: Like last time ↺",
                    ru: "Как ты и просил: Повтор прошлого ↺",
                    es: "Como pediste: Como la última vez ↺",
                    de: "Wie gewünscht: Wie beim letzten Mal ↺"
                };
                return { item: item, reason: reasons[currentLang] || reasons.en, detectedMods: [] };
            }
        }
    }

    // === 2. ПОИСК МОДИФИКАТОРОВ ===
    let detectedMods = [];
    modifiersData.forEach(mod => {
        const keywords = [mod.key, mod.en, mod.ru, mod.es, mod.de].filter(k => k).map(k => k.toLowerCase());
        // Ищем целые слова или части слов (fuzzy)
        const found = cleanText.split(" ").some(userWord => {
            return userWord.length > 2 && keywords.some(keyword => isFuzzyMatch(userWord, keyword));
        });
        if (found) detectedMods.push(mod.key);
    });

    // === 3. ОБРАБОТКА "СМЕСЬ X И Y" (Mix) ===
    const foundCategories = [];
    
    // Хелпер для поиска категории в тексте
    const findCatInText = (textSource) => {
        const results = [];
        // Проверяем каждое слово юзера на совпадение с именем категории
        const userWords = textSource.split(" ").filter(w => w.length > 3);
        
        // Оптимизация: Сначала проверяем избранное
        favorites.forEach(id => {
            const item = data.find(x => x.id === id);
            if (item) checkItemMatch(item, userWords, results);
        });
        
        // Если мало нашли, ищем по всей базе (лимит 500 популярных, чтобы не висло)
        if (results.length < 2) {
            data.slice(0, 500).forEach(item => {
                if (!favorites.includes(item.id)) checkItemMatch(item, userWords, results);
            });
        }
        return results;
    };

    const checkItemMatch = (item, words, results) => {
        if (results.some(r => r.id === item.id)) return; // Уже нашли
        const names = [item.name, item.name_ru, item.name_es, item.name_de, item.slug].filter(n => n);
        
        // Проверяем совпадение
        const match = names.some(n => {
            return words.some(w => isFuzzyMatch(w, n.toLowerCase()));
        });
        
        if (match) results.push(item);
    };

    const mixMatches = findCatInText(cleanText);

    // Если нашли 2 и более категорий — делаем МИКС
    if (mixMatches.length >= 2) {
        const mainItem = mixMatches[0]; // Берем первый как базу
        const secondaryItem = mixMatches[1]; // Второй как донор тегов
        
        // Добавляем уникальные теги второго предмета в detectedMods
        secondaryItem.tags.forEach(t => {
            const modMatch = modifiersData.find(m => m.key.toLowerCase() === t || m.en.toLowerCase() === t);
            if (modMatch) detectedMods.push(modMatch.key);
            else {
            }
        });

        // Формируем причину
        const n1 = getLocalizedName(mainItem);
        const n2 = getLocalizedName(secondaryItem);
        
        const reasons = {
            en: `Mix: ${n1} + ${n2} 🍸`,
            ru: `Микс: ${n1} + ${n2} 🍸`,
            es: `Mezcla: ${n1} + ${n2} 🍸`,
            de: `Mix: ${n1} + ${n2} 🍸`
        };

        return { 
            item: mainItem, 
            reason: reasons[currentLang] || reasons.en, 
            detectedMods: [...new Set(detectedMods)] // Убираем дубли
        };
    }

    // === 4. ОБЫЧНЫЙ ПОИСК (С учетом отрицаний) ===
    
    // Парсинг отрицаний ("без анала")
    let positiveQuery = rawText;
    let negativeTerms = [];

    NEGATIVES.forEach(neg => {
        if (positiveQuery.includes(neg)) {
            const parts = positiveQuery.split(neg);
            // Берем всё, что после слова "без"
            if (parts.length > 1) {
                // Пытаемся взять слово или фразу после отрицания
                const blockedPart = parts[1].trim().split(/[.,!?;]|\s+(and|и|y|und)\s+/)[0]; 
                if (blockedPart.length > 2) {
                    negativeTerms.push(blockedPart.trim());
                }
            }
        }
    });

    // Разбиваем на токены (слова)
    let rawTokens = positiveQuery
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "")
        .split(/\s+/)
        .filter(w => w.length > 2 && !STOP_WORDS.includes(w) && !negativeTerms.some(n => w.includes(n)));

    // Проверяем контекст (Жестче/Мягче)
    let tokens = [];
    let contextMode = null; 

    rawTokens.forEach(token => {
        let found = false;
        if (CONTEXT_TRIGGERS.harder.includes(token)) contextMode = 'harder';
        else if (CONTEXT_TRIGGERS.softer.includes(token)) contextMode = 'softer';
        else if (CONTEXT_TRIGGERS.more.includes(token)) contextMode = 'more';
        
        // Синонимы
        for (const [key, aliases] of Object.entries(KEYWORD_ALIASES)) {
            if (key === token || aliases.some(alias => isFuzzyMatch(token, alias))) {
                tokens.push(key);
                found = true;
                break;
            }
        }
        if (!found) tokens.push(token);
    });

    // Применяем контекст интенсивности
    if (contextMode === 'harder') {
        if (currentIntensity < 3) updateIntensity(3);
        tokens.push(...['extreme', 'rough', 'bdsm']);
    } else if (contextMode === 'softer') {
        if (currentIntensity > 1) updateIntensity(1);
        tokens.push(...['romantic', 'soft', 'vanilla']);
    } else if (contextMode === 'more' && lastGeneratedItem) {
        tokens.push(...lastGeneratedItem.tags.slice(0, 2)); 
    }

    // Если ничего не нашли
    if (tokens.length === 0 && !contextMode && detectedMods.length === 0) return null;

    // СКОРИНГ (Поиск кандидатов)
    let candidates = data.map(item => {
        let score = 0;
        
        // Строка для проверки банов
        const fullString = [item.name, item.name_ru, item.name_es, item.name_de, item.slug, ...item.tags].join(" ").toLowerCase();
        
        // ШТРАФ ЗА ОТРИЦАНИЯ
        const isBanned = negativeTerms.some(neg => {
            // Проверяем, содержится ли запрещенное слово в описании предмета
            return isFuzzyMatch(neg, item.name.toLowerCase()) || 
                   isFuzzyMatch(neg, (item.name_ru||"").toLowerCase()) ||
                   item.tags.some(t => isFuzzyMatch(neg, t));
        });

        if (isBanned) return { item, score: -5000 }; // Моментальный бан

        // Стандартный поиск
        const targetWords = [];
        const addWords = (str) => { if(str) str.toLowerCase().split(/[\s-]+/).forEach(w => targetWords.push(w)); };
        
        addWords(item.name);
        addWords(item.name_ru);
        addWords(item.name_es);
        addWords(item.slug);
        item.tags.forEach(t => targetWords.push(t));

        tokens.forEach(token => {
            if (item.slug === token) score += 60;
            else {
                const bestMatch = targetWords.find(word => isFuzzyMatch(token, word));
                if (bestMatch) score += 40;
            }
        });

        // Бонусы
        if (score > 0) {
            if (favorites.includes(item.id)) score += 10;
            if (cooldownList.includes(item.id)) score -= 30; 
            score += Math.random() * 5;
        }

        return { item, score };
    });

    candidates.sort((a, b) => b.score - a.score);

    // Возврат победителя
    if (candidates.length > 0 && candidates[0].score > 0) {
        const winner = candidates[0].item;
        const localizedName = getLocalizedName(winner);
        
        const AI_RESPONSES = {
            en: { harder: "Spiced it up 🔥", softer: "Something gentler ✨", mention: "You mentioned: " },
            ru: { harder: "Добавил перчинки 🔥", softer: "Что-то понежнее ✨", mention: "Ты упомянул: " },
            es: { harder: "Más picante 🔥", softer: "Algo más suave ✨", mention: "Mencionaste: " },
            de: { harder: "Etwas Schärfe 🔥", softer: "Etwas Sanftes ✨", mention: "Du sagtest: " }
        };

        const phrases = AI_RESPONSES[currentLang] || AI_RESPONSES['en'];
        let reasonText = "";
        
        if (contextMode === 'harder') reasonText = phrases.harder;
        else if (contextMode === 'softer') reasonText = phrases.softer;
        else {
            reasonText = phrases.mention + `<span style="color:var(--accent); font-weight:700;">${localizedName}</span>`;
        }

        return { 
            item: winner, 
            reason: reasonText, 
            tokens: winner.reasons,
            detectedMods: [...new Set(detectedMods)]
        };
    }

    return null;
}

    function getTranslation(key) {
        const t = langData[currentLang] || langData['en'];
        return t[key] || "";
    }

    function processAiRequest() {
        const input = document.getElementById('ai-input');
        const text = input.value.trim();
        if (!text) return;

        // 1. UI: Скрываем ввод, показываем спиннер
        document.getElementById('assistant-ui').classList.remove('visible');
        document.getElementById('thinking-ui').style.display = 'flex';
        
        const thinkTxt = document.getElementById('ai-thinking-text');
        
        // 2. АНИМАЦИЯ МЫШЛЕНИЯ
        const steps = THINKING_STEPS[currentLang] || THINKING_STEPS['en'];
        let stepIndex = 0;
        thinkTxt.innerText = steps[0];

        const thinkInterval = setInterval(() => {
            stepIndex = (stepIndex + 1) % steps.length;
            thinkTxt.innerText = steps[stepIndex];
        }, 450);

        // 3. ОБРАБОТКА
        setTimeout(() => {
            clearInterval(thinkInterval);
            
            const result = analyzeUserRequest(text); 
            
            const overlay = document.getElementById('mode-start-overlay');
            overlay.classList.add('hidden'); 
            
            // Сброс UI
            setTimeout(() => {
                document.getElementById('thinking-ui').style.display = 'none';
                document.getElementById('ai-input').value = '';
                document.getElementById('btn-ai-go').classList.remove('visible');
                document.getElementById('mode-start-text').style.opacity = '1';
                document.getElementById('mode-buttons-container').style.opacity = '1';
                document.getElementById('mode-buttons-container').style.pointerEvents = 'auto';
                randomizeModeGreeting();
            }, 500);

            const statusEl = document.getElementById('status-text');
            const t = langData[currentLang] || langData['en'];
            const failPhrases = t.ai_phrases_fail || ["Try this instead:"];
            const randomFail = failPhrases[Math.floor(Math.random() * failPhrases.length)];

            if (result) {
                // УСПЕХ
                aiContextTokens = result.tokens || [];
                setAppMode('ai');

                // === СБРОС ПРЕДЫДУЩИХ МОДОВ ===
                activeMods.clear();
                // ====================================

                // === УМНОЕ ДОБАВЛЕНИЕ МОДОВ ===
                if (result.detectedMods && result.detectedMods.length > 0) {
                    
                    // Подготовка данных для проверки дубликатов
                    const winnerTags = result.item.tags.map(t => t.toLowerCase()); // Теги категории
                    const winnerName = result.item.name.toLowerCase(); // Имя (EN)
                    const winnerNameRu = (result.item.name_ru || "").toLowerCase(); // Имя (RU)
                    const winnerSlug = result.item.slug.toLowerCase();

                    result.detectedMods.forEach(modKey => {
                        const tagToCheck = modKey.toLowerCase();

                        // ПРОВЕРКА: Если модификатор уже есть в категории — НЕ добавляем его
                        // 1. Есть ли такой тег у категории? (trans -> trans)
                        const hasTag = winnerTags.includes(tagToCheck);
                        // 2. Есть ли это слово в названии? (Shemale Fucks Shemale -> trans нет, но по тегу поймали выше)
                        const inName = winnerName.includes(tagToCheck) || winnerNameRu.includes(tagToCheck);
                        // 3. Есть ли в слаге?
                        const inSlug = winnerSlug.includes(tagToCheck);

                        // Добавляем ТОЛЬКО если модификатор приносит что-то новое
                        if (!hasTag && !inName && !inSlug) {
                            activeMods.add(modKey);

                            // Добавляем в пул пользователя (визуально вниз)
                            if (!userModifiersPool.includes(modKey)) {
                                if (userModifiersPool.length >= 10) userModifiersPool.shift();
                                userModifiersPool.push(modKey);
                            }
                        }
                    });
                    
                    // Сохраняем пул и обновляем UI
                    localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
                    renderModifiers(); 
                }
                // ===============================================

                forceShowResult(result.item, 'ai_request', result.reason);
                
                // Анимация
                const wrapper = document.getElementById('card-anim-wrapper');
                if(wrapper) {
                    wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
                    void wrapper.offsetWidth; 
                    wrapper.classList.add('anim-fly-left');
                }

            } else {
                // НЕУДАЧА
                if(statusEl) {
                    statusEl.innerText = randomFail;
                    statusEl.style.color = "var(--text-secondary)";
                }
                setAppModeAndStart('pleasure');
            }

        }, 1800);
    }

    function openAssistantUI() {
        initAiRollingPrompts()
        // 1. Анимируем уход старых элементов (Текст и Кнопки)
        const startText = document.getElementById('mode-start-text');
        const modeBtns = document.getElementById('mode-buttons-container');
        
        // Добавляем класс, который уводит их вверх и делает прозрачными
        if(startText) startText.classList.add('fade-out-up');
        if(modeBtns) modeBtns.classList.add('fade-out-up');

        // 2. Открываем интерфейс ассистента с задержкой (чтобы старое успело начать исчезать)
        setTimeout(() => {
            const ui = document.getElementById('assistant-ui');
            ui.classList.add('visible'); // Сработает CSS анимация scale + opacity
            
            // --- РАНДОМИЗАЦИЯ ТЕКСТА (Как и было) ---
            const t = langData[currentLang] || langData['en'];
            
            const prompts = Array.isArray(t.ai_prompt) ? t.ai_prompt : [t.ai_prompt];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.querySelector('.assistant-prompt').innerText = randomPrompt;

            const placeholders = Array.isArray(t.ai_placeholder) ? t.ai_placeholder : [t.ai_placeholder];
            const randomPlaceholder = placeholders[Math.floor(Math.random() * placeholders.length)];
            
            const input = document.getElementById('ai-input');
            input.placeholder = randomPlaceholder;
            input.value = "";
            
            const btnText = document.querySelector('#btn-ai-go span');
            if(btnText) btnText.innerText = t.ai_btn_go || "Find It";

            // Фокус чуть позже, когда анимация закончится
            setTimeout(() => input.focus(), 300);

            // Логика ввода
            input.oninput = (e) => {
                const btn = document.getElementById('btn-ai-go');
                if (e.target.value.trim().length > 0) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            };
            input.onkeydown = (e) => {
                if (e.key === 'Enter') processAiRequest();
            };
        }, 50); // Небольшая задержка для наложения анимаций
    }

    function closeAssistantUI() {
        const ui = document.getElementById('assistant-ui');
        
        // 1. Скрываем интерфейс ассистента
        ui.classList.remove('visible');
        
        // 2. Возвращаем кнопки и текст (убираем класс ухода)
        const startText = document.getElementById('mode-start-text');
        const modeBtns = document.getElementById('mode-buttons-container');
        
        // Ждем пока поле исчезнет, потом возвращаем кнопки
        setTimeout(() => {
            if(startText) {
                startText.classList.remove('fade-out-up');
                // Сброс инлайновых стилей на всякий случай
                startText.style.opacity = ''; 
                startText.style.transform = '';
            }
            if(modeBtns) {
                modeBtns.classList.remove('fade-out-up');
                modeBtns.style.opacity = '';
                modeBtns.style.transform = '';
                modeBtns.style.pointerEvents = 'auto';
            }
        }, 200);
        
        document.getElementById('ai-input').value = '';
        document.getElementById('btn-ai-go').classList.remove('visible');
    }

    function closeAllModals() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.classList.remove('open');
        });
        document.body.classList.remove('modal-open');
    }

    function toggleVoiceInput() {
        const btn = document.getElementById('btn-mic');
        
        if (!('webkitSpeechRecognition' in window)) {
            alert("Voice input not supported in this browser.");
            return;
        }

        if (window.recognition && window.isListening) {
            window.recognition.stop();
            return;
        }

        const recognition = new webkitSpeechRecognition();
        window.recognition = recognition;
        
        // Выбираем язык распознавания на основе текущего языка приложения
        const langMap = { 'en': 'en-US', 'ru': 'ru-RU', 'es': 'es-ES', 'de': 'de-DE' };
        recognition.lang = langMap[currentLang] || 'en-US';
        
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            window.isListening = true;
            btn.classList.add('listening');
            document.getElementById('ai-input').placeholder = "Listening...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            const input = document.getElementById('ai-input');
            input.value = transcript;
            document.getElementById('btn-ai-go').classList.add('visible');
            // Не отправляем сразу, даем пользователю проверить текст
        };

        recognition.onend = () => {
            window.isListening = false;
            btn.classList.remove('listening');
            document.getElementById('ai-input').placeholder = getTranslation("ai_placeholder");
        };

        recognition.start();
    }

    function openModifiersSettings() {
        renderModifiersModal();
        document.getElementById('modal-mods-overlay').classList.add('open');
    }

    function closeModifiersSettings(e, force) {
        if (force || e.target.id === 'modal-mods-overlay') {
            document.getElementById('modal-mods-overlay').classList.remove('open');
        }
    }

    function toggleModInPool(key) {
        const index = userModifiersPool.indexOf(key);
        
        if (index > -1) {
            // Если есть -> удаляем (переносим в неактивные)
            userModifiersPool.splice(index, 1);
        } else {
            // Если нет -> добавляем, но проверяем лимит
            if (userModifiersPool.length >= 6) {
                const t = langData[currentLang] || langData['en'];
                alert(t.mod_limit_reached || "Max 6 modifiers!");
                return;
            }
            userModifiersPool.push(key);
        }
        
        // Сохраняем локально
        localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
        renderModifiersModal(); // Перерисовываем окно
        
        // Обновляем список в карточке реального времени, если она открыта
        if (currentItem) renderModifiersInCard(); 
    }

    function renderModifiersModal() {
        const activeContainer = document.getElementById('mods-list-active');
        const inactiveContainer = document.getElementById('mods-list-inactive');
        const counter = document.getElementById('mods-counter');
        const modalBody = document.querySelector('#modal-mods-overlay .modal-body');
        
        if (!activeContainer || !inactiveContainer) return;

        activeContainer.innerHTML = '';
        inactiveContainer.innerHTML = '';
        
        // 1. СЧЕТЧИК: Считает, сколько кнопок пользователь вывел на карточку (лимит 6)
        if (counter) {
            counter.innerText = `${userModifiersPool.length} / 6`;
            counter.style.color = userModifiersPool.length >= 6? 'var(--highlight-red)' : 'var(--text-secondary)';
        }

        // 2. РЕНДЕРИМ АКТИВНЫЕ (Те, что в пуле и видны на карточке)
        userModifiersPool.forEach(modKey => {
            const systemMod = modifiersData.find(x => x.key === modKey);
            const isCustom = !systemMod;
            let label = modKey;
            if (systemMod) label = systemMod[currentLang] || systemMod.en;

            const btn = document.createElement('div');
            btn.className = 'mod-chip active'; // Они всегда активны в контексте этого окна
            
            // Кнопка удаления (вернуть в неактивные / удалить кастомный)
            let iconsHtml = `<span class="custom-mod-del" style="margin-left:8px; opacity:0.6;">✕</span>`;
            btn.innerHTML = `${label}${iconsHtml}`;

            btn.onclick = () => {
                // Убираем из пула (скрываем с карточки)
                userModifiersPool = userModifiersPool.filter(k => k !== modKey);
                activeMods.delete(modKey); // На всякий случай выключаем и в выборе
                
                localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
                renderModifiersModal();
                renderModifiersInCard();
                if (currentItem) renderResultName();
            };

            activeContainer.appendChild(btn);
        });

        // 3. РЕНДЕРИМ НЕАКТИВНЫЕ (Те, что скрыты и доступны для добавления)
        modifiersData.forEach(mod => {
            // Если этого мода нет в пуле пользователя — он в списке неактивных
            if (!userModifiersPool.includes(mod.key)) {
                const btn = document.createElement('div');
                btn.className = 'mod-chip inactive';
                btn.innerText = mod[currentLang] || mod.en;

                btn.onclick = () => {
                    if (userModifiersPool.length >= 6) {
                        alert(langData[currentLang].mod_limit_reached || "Limit reached!");
                        return;
                    }
                    // Добавляем в пул (теперь он появится на карточке)
                    userModifiersPool.push(mod.key);
                    localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
                    renderModifiersModal();
                    renderModifiersInCard();
                };
                inactiveContainer.appendChild(btn);
            }
        });

        // 4. Форма для кастомных
        if (!document.getElementById('custom-mod-form')) {
            const t = langData[currentLang] || langData['en'];
            const form = document.createElement('div');
            form.id = 'custom-mod-form';
            form.style.cssText = "margin-top:25px; border-top:none; padding-top:10px; display:flex; justify-content:center;";
            
            form.innerHTML = `
                <div id="btn-show-custom-input" 
                     onclick="toggleCustomInput(true)" 
                     style="
                        background: var(--ios-card);
                        border: 1px solid var(--accent);
                        color: var(--accent);
                        border-radius: 50px;
                        padding: 10px 24px;
                        font-size: 13px;
                        font-weight: 700;
                        text-transform: uppercase;
                        cursor: pointer;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                        transition: transform 0.2s;
                     "
                     onmousedown="this.style.transform='scale(0.95)'"
                     onmouseup="this.style.transform='scale(1)'"
                >
                    + ${t.mod_add_custom}
                </div>

                <div id="custom-input-container" style="display:none; gap:10px; width:100%;">
                    <input type="text" id="custom-mod-input" class="promo-input" placeholder="${t.mod_input_ph}" style="font-size:14px; padding:10px;">
                    <button class="btn-gen" onclick="submitCustomMod()" style="width:auto; padding:0 20px; font-size:14px; min-width:80px; height:42px;">
                        ${t.mod_add_btn}
                    </button>
                </div>
            `;
            modalBody.appendChild(form);
        }
    }

    function submitCustomMod() {
        const input = document.getElementById('custom-mod-input');
        if (!input) return;
        
        let val = input.value.trim();
        if (!val) return;
        
        // --- Макс длина 20 символов ---
        if (val.length > 20) {
            alert("Too long! Max 20 chars.");
            return;
        }
        
        // Форматирование (Первая буква заглавная)
        val = val.charAt(0).toUpperCase() + val.slice(1);

        // Проверка на дубликаты
        if (userModifiersPool.includes(val)) {
            alert("Already exists!");
            return;
        }
        
        // --- Лимит пула 6 штук ---
        if (userModifiersPool.length >= 6) {
            alert("Limit reached (Max 6). Delete some first.");
            return;
        }

        // Добавляем в пул
        userModifiersPool.push(val);
        
        // Сразу делаем активным
        activeMods.add(val); 
        
        // Сохраняем в память
        localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
        
        // Сброс UI
        input.value = '';
        toggleCustomInput(false); 
        
        // Перерисовка
        renderModifiersModal(); 
        
        // Обновляем карточку на фоне
        if (typeof currentItem !== 'undefined' && currentItem) {
            renderModifiersInCard();
            renderResultName();
            updateLink();
        }
    }

    function deleteCustomMod(key) {
        if (confirm(`Remove "${key}"?`)) {
            // Удаляем из пула
            userModifiersPool = userModifiersPool.filter(k => k !== key);
            // Удаляем из активных, если он там был
            activeMods.delete(key);
            
            // Сохраняем
            localStorage.setItem('xch_user_mods', JSON.stringify(userModifiersPool));
            
            // Перерисовываем
            renderModifiersModal();
            
            // Обновляем карточку
            if (typeof currentItem !== 'undefined' && currentItem) {
                renderModifiersInCard();
                renderResultName();
                updateLink();
            }
        }
    }

    function toggleCustomInput(show) {
        const btn = document.getElementById('btn-show-custom-input');
        const container = document.getElementById('custom-input-container');
        const input = document.getElementById('custom-mod-input');
        
        if (show) {
            if(btn) btn.style.display = 'none';
            if(container) {
                container.style.display = 'flex';
                if(input) input.focus();
            }
        } else {
            if(btn) btn.style.display = 'flex';
            if(container) container.style.display = 'none';
        }
    }
    
    document.addEventListener('keydown', function(event) {
        if (event.key === "Enter" && document.getElementById('custom-mod-input') === document.activeElement) {
            submitCustomMod();
        }
    });

    function renderModifiersInCard() {
        const container = document.getElementById('mod-container'); 
        if (!container) return;
        
        container.innerHTML = '';
        const t = langData[currentLang] || langData['en'];

        const header = document.createElement('div');
        header.className = 'mods-header';
        header.innerText = t.add_genre;
        container.appendChild(header);

        // Если на карточку ничего не выведено
        if (userModifiersPool.length === 0) {
            const addBtn = document.createElement('div');
            addBtn.className = 'tag';
            addBtn.style.border = '1px dashed var(--accent)';
            addBtn.innerText = "+ " + (t.mod_add_btn || "Add");
            addBtn.onclick = (e) => { e.stopPropagation(); openModifiersSettings(); };
            container.appendChild(addBtn);
            return;
        }

        const itemTags = currentItem ? currentItem.tags.map(t => t.toLowerCase()) : [];
        const itemName = currentItem ? getLocalizedName(currentItem).toLowerCase() : "";

        // Показываем только те кнопки, которые пользователь "активировал" в модалке
        userModifiersPool.forEach(modKey => {
            const modObj = modifiersData.find(m => m.key === modKey);
            const label = modObj ? (modObj[currentLang] || modObj.en) : modKey;

            // Фильтр дублей (чтобы не предлагать Anal если это и так Anal)
            const tagLower = modKey.toLowerCase();
            if (itemTags.includes(tagLower) || itemName.includes(tagLower)) return;

            const tagBtn = document.createElement('div'); 
            tagBtn.className = 'tag';
            
            // ПРОВЕРКА: Если модификатор ВЫБРАН для этой карточки — красим в синий/акцент
            if (activeMods.has(modKey)) {
                tagBtn.classList.add('selected');
            }
            
            tagBtn.innerText = label;
            
            tagBtn.onclick = (e) => {
                e.stopPropagation();
                if (activeMods.has(modKey)) {
                    activeMods.delete(modKey);
                } else {
                    if (activeMods.size >= 6) return;
                    activeMods.add(modKey);
                }
                
                // Перерисовываем кнопки, чтобы сработал .selected
                renderModifiersInCard();
                // Обновляем название в слоте (+ POV...)
                renderResultName(); 
                // Обновляем ссылку на видео
                updateLink();
                if (navigator.vibrate) navigator.vibrate(10);
            };
            container.appendChild(tagBtn);
        });
    }

    function renderModifiers() {
        renderModifiersInCard();
    }

    // Генерация умных подсказок
    function getAiSuggestions() {
        const t = langData[currentLang] || langData['en'];
        const prompts = [];

        // 1. "Как вчера" (если есть история просмотров)
        if (watchHistory.length > 0) {
            prompts.push(currentLang === 'ru' ? "Хочу как вчера..." : "Like yesterday...");
        }

        // 2. "Пожестче"
        prompts.push(currentLang === 'ru' ? "Давай пожёстче..." : "Make it rougher...");

        // 3. "Удиви меня"
        prompts.push(currentLang === 'ru' ? "Удиви меня..." : "Surprise me...");

        // 4. "Любимое без X" (берем 1 любимый и 1 нелюбимый)
        if (favorites.length > 0 && blacklist.length > 0) {
            const favItem = data.find(x => x.id === favorites[0]);
            const banItem = data.find(x => x.id === blacklist[0]);
            if (favItem && banItem) {
                const fName = getLocalizedName(favItem);
                const bName = getLocalizedName(banItem);
                prompts.push(currentLang === 'ru' 
                    ? `${fName}, но без ${bName}` 
                    : `${fName} without ${bName}`);
            }
        }

        // 5. "Смесь X и Y" (берем 2 любимых)
        if (favorites.length >= 2) {
            // Берем случайные 2
            const shuffled = favorites.sort(() => 0.5 - Math.random()).slice(0, 2);
            const item1 = data.find(x => x.id === shuffled[0]);
            const item2 = data.find(x => x.id === shuffled[1]);
            if (item1 && item2) {
                const n1 = getLocalizedName(item1);
                const n2 = getLocalizedName(item2);
                prompts.push(currentLang === 'ru' 
                    ? `Смесь: ${n1} и ${n2}` 
                    : `Mix ${n1} and ${n2}`);
            }
        }

        // 6. "Без X и Y" (берем 2 из блэклиста)
        if (blacklist.length >= 2) {
            const item1 = data.find(x => x.id === blacklist[0]);
            const item2 = data.find(x => x.id === blacklist[1]);
            if (item1 && item2) {
                const n1 = getLocalizedName(item1);
                const n2 = getLocalizedName(item2);
                prompts.push(currentLang === 'ru' 
                    ? `Только без ${n1} и ${n2}` 
                    : `Anything but ${n1} and ${n2}`);
            }
        }

        // Заполнитель, если пусто
        if (prompts.length < 3) {
            prompts.push("Anal...");
            prompts.push("BDSM...");
            prompts.push("Romantic...");
        }

        return prompts.slice(0, 5); // Берем топ 5
    }

    function initAiRollingPrompts() {
        const container = document.getElementById('ai-rolling-list');
        const input = document.getElementById('ai-input');
        const overlay = document.getElementById('ai-rolling-container');
        
        if (!container) return;

        const suggestions = getAiSuggestions();
        
        container.innerHTML = suggestions.map(s => `<div class="rolling-item">${s}</div>`).join('');
        
        // Пересчитываем анимацию под количество элементов
        const count = suggestions.length;
        container.classList.add('animate-scroll');
        
        // Логика скрытия при вводе
        input.onfocus = () => overlay.classList.add('hidden');
        input.onblur = () => {
            if(input.value.trim() === '') overlay.classList.remove('hidden');
        };
        input.oninput = () => overlay.classList.add('hidden');
    }

    let wrappedArchive = JSON.parse(localStorage.getItem('xch_wrapped_archive')) || [];
    let activeDaysSet = new Set(JSON.parse(localStorage.getItem('xch_active_days')) || []);

    // 1. Отметка активности (Вызывать при каждом свайпе/просмотре)
    function markDayActive() {
        const today = new Date().toISOString().split('T')[0];
        if (!activeDaysSet.has(today)) {
            activeDaysSet.add(today);
            localStorage.setItem('xch_active_days', JSON.stringify([...activeDaysSet]));
            
            // При новом дне проверяем, не пора ли что-то заархивировать
            checkAutomaticArchiving();
        }
    }

    // 2. Автоматическая проверка периодов
    function checkAutomaticArchiving() {
        const now = new Date();
        const lastCheck = parseInt(localStorage.getItem('xch_last_archive_check') || '0');
        
        // Ограничение: проверяем не чаще раза в час
        if (Date.now() - lastCheck < 3600000) return; 
        localStorage.setItem('xch_last_archive_check', Date.now());

        // --- A. YEARLY CHECK (Смена года) ---
        const lastYearly = wrappedArchive.find(w => w.type === 'yearly' && w.isLatest);
        const lastYearlyYear = lastYearly ? new Date(lastYearly.timestamp).getFullYear() : 0;
        if (now.getFullYear() > lastYearlyYear && lastYearlyYear !== 0) {
            // Год сменился -> генерируем за прошлый год
            generateAndSaveWrapped('yearly');
        }

        // --- B. MONTHLY CHECK (Смена месяца) ---
        const lastMonthly = wrappedArchive.find(w => w.type === 'monthly' && w.isLatest);
        const lastMonthlyMonth = lastMonthly ? new Date(lastMonthly.timestamp).getMonth() : -1;
        if (now.getMonth() !== lastMonthlyMonth && lastMonthlyMonth !== -1) {
            // Месяц сменился -> генерируем за прошлый месяц
            generateAndSaveWrapped('monthly');
        }

        // --- C. WEEKLY CHECK (Накопление 7 дней) ---
        // Если накоплено 7+ дней активности, закрываем неделю
        if (activeDaysSet.size >= 7) {
            generateAndSaveWrapped('weekly');
            
            // СБРОС СЧЕТЧИКА ДНЕЙ ПОСЛЕ НЕДЕЛЬНОГО ОТЧЕТА
            activeDaysSet.clear();
            // Добавляем сегодняшний день обратно, так как он уже начался
            activeDaysSet.add(now.toISOString().split('T')[0]);
            localStorage.setItem('xch_active_days', JSON.stringify([...activeDaysSet]));
        }
    }

    // 3. Основная функция генерации
    function generateAndSaveWrapped(type) {
        const now = new Date();
        const oneDay = 86400000;
        let startTime = 0;
        let endTime = now.getTime();
        let targetDateKey = null;

        if (type === 'daily') {
            // Устанавливаем начало вчерашнего дня (00:00:00)
            const yesterdayStart = new Date();
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
            yesterdayStart.setHours(0, 0, 0, 0);
            startTime = yesterdayStart.getTime();

            // Устанавливаем конец вчерашнего дня (23:59:59)
            const yesterdayEnd = new Date();
            yesterdayEnd.setDate(yesterdayEnd.getDate() - 1);
            yesterdayEnd.setHours(23, 59, 59, 999);
            endTime = yesterdayEnd.getTime();

            targetDateKey = yesterdayStart.toDateString();
        } 
        else if (type === 'weekly') startTime = now.getTime() - (7 * oneDay);
        else if (type === 'monthly') startTime = now.getTime() - (30 * oneDay);
        else if (type === 'yearly') startTime = now.getTime() - (365 * oneDay);

        // Фильтруем данные строго в рамках выбранного диапазона
        const relevantLogs = activityLog.filter(l => l.ts >= startTime && l.ts <= endTime);
        const relevantWatch = watchHistory.filter(w => w.timestamp >= startTime && w.timestamp <= endTime);

        // Если активности за вчера почти не было, отчет не создаем
        if (relevantLogs.length < 5 && type === 'daily') return null;

        const stats = calculateDeepStats(relevantLogs, relevantWatch);

        // Сравнение с предыдущим таким же периодом
        const duration = endTime - startTime;
        const prevStartTime = startTime - duration;
        const prevEndTime = startTime - 1;
        const prevLogs = activityLog.filter(l => l.ts >= prevStartTime && l.ts <= prevEndTime);
        const prevWatches = watchHistory.filter(w => w.timestamp >= prevStartTime && w.timestamp <= prevEndTime);
        const prevStats = calculateDeepStats(prevLogs, prevWatches);
        
        stats.deltaActions = stats.totalActions - prevStats.totalActions;
        stats.deltaWatchTime = stats.totalWatchTime - prevStats.totalWatchTime;
        stats.prevTopTags = prevStats.topTags || [];
        stats.prevPsychoCounts = prevStats.psychoCounts || {};

        const wrappedObj = {
            id: Date.now(),
            type: type,
            targetDate: targetDateKey, // Уникальный ключ дня
            timestamp: Date.now(),
            rangeStr: getRangeString(startTime, endTime, type),
            stats: stats,
            viewed: false,
            isLatest: true
        };

        // Помечаем старые отчеты этого типа как не актуальные
        wrappedArchive.forEach(w => { if(w.type === type) w.isLatest = false; });
        wrappedArchive.unshift(wrappedObj);
        localStorage.setItem('xch_wrapped_archive', JSON.stringify(wrappedArchive));
        
        return wrappedObj;
    }

    // 4. Глубокий анализ статистики 
    function calculateDeepStats(logs, watches) {
        let totalActions = 0;
        let watchCount = 0;
        let swipeCount = 0;
        let likeCount = 0;     
        let dislikeCount = 0; 
        let oldWatchCount = 0;
        let newWatchCount = 0; 
        
        const tagCounts = {};
        const exploredBefore = new Set(permanentExplored);

        watches.forEach(w => {
            // Если предмет был в избранном до этого периода (или просто уже знаком)
            if (favorites.includes(w.id)) {
                oldWatchCount++;
            } else {
                newWatchCount++;
            }
        });

        const totalW = oldWatchCount + newWatchCount || 1;
        const loyaltyPct = Math.round((oldWatchCount / totalW) * 100);
        const curiosityPct = 100 - loyaltyPct;

        let loyaltyStatus = 'balanced';
        if (loyaltyPct > 65) loyaltyStatus = 'cons';
        if (curiosityPct > 65) loyaltyStatus = 'pioneer';
        
        // Карта очков для КОНКРЕТНЫХ предметов (ID)
        const itemScores = {}; 
        
        const psychoCounts = {};
        PSYCHO_AXES.forEach(key => psychoCounts[key] = 0);

        const hours = new Array(24).fill(0);
        const IGNORED_TAGS = ['general', 'specific', 'straight', 'male', 'female', 'adult', 'video', 'hd'];

        logs.forEach(l => {
            totalActions++;
            const h = new Date(l.ts).getHours();
            hours[h]++;

            if (l.type === 'watch') watchCount++;
            else swipeCount++;

            if (l.type === 'like') likeCount++;
            else if (l.type === 'dislike' || l.type === 'pass') dislikeCount++;

            // Вес действия
            let weight = 1;
            if (l.type === 'watch') weight = 5;      // Просмотр — высший балл
            if (l.type === 'like') weight = 3;       // Лайк — средний
            if (l.type === 'gen') weight = 1;        // Просто выпало — минимальный
            if (l.type === 'dislike') weight = 0;    // Дизлайк не считаем

            // --- СЧЕТЧИК ТЕГОВ И ПСИХОТИПОВ ---
            if (l.tags && weight > 0) {
                l.tags.forEach(t => {
                    if (IGNORED_TAGS.includes(t)) return;
                    tagCounts[t] = (tagCounts[t] || 0) + 1;

                    if (PSYCHO_AXES.includes(t)) {
                        psychoCounts[t] += weight;
                    }
                });
            }

            // --- СЧЕТЧИК КОНКРЕТНЫХ ПРЕДМЕТОВ ---
            if (l.id && weight > 0) {
                itemScores[l.id] = (itemScores[l.id] || 0) + weight;
            }
        });

        const totalWatchTime = watches.reduce((sum, w) => sum + w.seconds, 0);

        const topTags = Object.entries(tagCounts)
            .sort((a,b) => b[1]-a[1])
            .slice(0, 10).map(x => x[0]);
        
        // --- ФОРМИРОВАНИЕ ТОП-5 ФЕТИШЕЙ ---
        // Превращаем ID и Очки в полноценные объекты данных
        const topFetishes = Object.entries(itemScores)
            .sort((a, b) => b[1] - a[1]) // Сортируем по очкам
            .slice(0, 5)                 // Берем топ 5
            .map(([id, score]) => {
                // Находим реальный объект в базе данных
                // itemScores хранит ID как строку, поэтому приводим типы
                const realItem = data.find(x => x.id == id);
                if (!realItem) return null;
                return { 
                    id: id, 
                    score: score, 
                    item: realItem 
                };
            })
            .filter(x => x !== null); // Убираем, если вдруг ID удален из базы

        const morning = hours.slice(5, 12).reduce((a,b)=>a+b,0);
        const day = hours.slice(12, 20).reduce((a,b)=>a+b,0);
        const night = hours.slice(20, 24).reduce((a,b)=>a+b,0) + hours.slice(0, 5).reduce((a,b)=>a+b,0);
        
        let peakTime = 'day';
        if (night > day && night > morning) peakTime = 'night';
        else if (morning > day && morning > night) peakTime = 'morning';

        let achievement = 'day';
        if (peakTime === 'night') achievement = 'night';
        else if (peakTime === 'morning') achievement = 'morning';
        
        const ratio = watchCount / (swipeCount || 1);
        if (ratio > 0.4) achievement = 'binger';
        else if (ratio < 0.05 && totalActions > 20) achievement = 'picky';
        else {
            const uniqueTags = Object.keys(tagCounts).length;
            if (uniqueTags / (totalActions || 1) > 0.8) achievement = 'explorer';
            else achievement = 'hedonist';
        }

        return {
            totalActions, watchCount, swipeCount, totalWatchTime,
            likeCount, dislikeCount,
            topTags, peakTime, achievement,
            psychoCounts, 
            topFetishes,
            loyaltyPct, 
            curiosityPct,
            loyaltyStatus 
        };
    }

    function calculatePsychotype(psychoCounts) {
        // Превращаем объект в массив [ключ, значение] и сортируем
        const sorted = Object.entries(psychoCounts).sort((a, b) => b[1] - a[1]);
        
        const top1 = sorted[0];
        const top2 = sorted[1];
        
        // 1. Если активности почти нет
        if (top1[1] < 2) return 'vanilla';

        // 2. Проверка на "Коллекционера" (если топ-3 близки друг к другу и высоки)
        const top3 = sorted[2];
        if (top3 && top3[1] > 5 && (top1[1] - top3[1] < 3)) return 'collector';

        const k1 = top1[0];
        const k2 = top2[0];

        // 3. Комбинации (приоритет)
        const has = (key) => (k1 === key || (k2 === key && top2[1] > top1[1] * 0.6)); // Второй тег должен быть значимым

        if (has('bdsm') && (has('taboo') || has('humiliation'))) return 'dark_lord';
        if (has('public') && has('roleplay')) return 'performer';
        if (has('body-part') && has('clothing')) return 'worshipper';
        if (has('psychological') && has('humiliation')) return 'brainwasher';
        if (has('public') && has('taboo')) return 'risk_taker';
        if (has('group') && (has('bdsm') || has('public'))) return 'orgy_master';
        if (has('roleplay') && has('sensory')) return 'immersionist';

        // 4. Если комбинаций нет, возвращаем доминирующую ось
        return k1; // Вернет 'bdsm', 'roleplay' и т.д.
    }

    // Форматирование даты
    function getRangeString(start, end, type) {
        if (type === 'daily') return new Date(end).toLocaleDateString();
        
        const d1 = new Date(start);
        const d2 = new Date(end);
        const m1 = d1.getMonth() + 1;
        const m2 = d2.getMonth() + 1;
        
        // Формат: 19.01 - 26.01
        const pad = (n) => n < 10 ? '0'+n : n;
        return `${pad(d1.getDate())}.${pad(m1)} - ${pad(d2.getDate())}.${pad(m2)}`;
    }

    // 5. Кнопка запуска (Trigger)
    function triggerWrappedBtn() {
        const isPaid = subscriptionLevel !== 'free';
        const now = new Date();

        // 1. Проверяем наличие АРХИВНЫХ отчетов (Непросмотренных)
        // Сортируем по иерархии: Year > Month > Week
        const unread = wrappedArchive.filter(w => !w.viewed).sort((a,b) => {
            const priorities = { yearly: 3, monthly: 2, weekly: 1, daily: 0 };
            return priorities[b.type] - priorities[a.type];
        });

        if (unread.length > 0) {
            openWrappedUI(unread[0]);
            return;
        }

        
        if (activeDaysSet.size >= 7) {
            // Если накоплена неделя — форсируем закрытие недели
            const snapshot = generateAndSaveWrapped('weekly');
            
            // Сброс счетчика
            activeDaysSet.clear();
            activeDaysSet.add(now.toISOString().split('T')[0]);
            localStorage.setItem('xch_active_days', JSON.stringify([...activeDaysSet]));
            
            if (snapshot) openWrappedUI(snapshot);
        } 
        else if (isPaid) {
            // Платные могут смотреть Daily в любой момент
            const snapshot = generateAndSaveWrapped('daily');
            if (snapshot) openWrappedUI(snapshot);
            else alert("Not enough activity today!");
        } 
        else {
            // Free user без недели
            const daysLeft = 7 - activeDaysSet.size;
            const msg = currentLang === 'ru' ? 
                `Нужно еще ${daysLeft} активных дней для Weekly!` : 
                `Need ${daysLeft} more active days for Weekly!`;
            alert(msg);
        }
    }

    function createRadarChartSVG(currentData, prevData) {
        const size = 340; 
        const center = size / 2;
        const radius = 100; 
        const levels = 3;

        let maxVal = 0;
        PSYCHO_AXES.forEach(key => {
            maxVal = Math.max(maxVal, currentData[key] || 0, prevData ? (prevData[key] || 0) : 0);
        });
        if (maxVal === 0) maxVal = 5; // Дефолт, чтобы график не был точкой

        const getCoords = (value, index) => {
            const angle = (Math.PI * 2 * index) / 10 - (Math.PI / 2);
            // Ограничиваем радиус, чтобы график не вылезал за пределы
            const r = (Math.min(value, maxVal) / maxVal) * radius;
            const x = center + r * Math.cos(angle);
            const y = center + r * Math.sin(angle);
            return [x, y];
        };

        // Сетка
        let gridSVG = '';
        for (let i = 1; i <= levels; i++) {
            let levelPoints = [];
            const r = (radius / levels) * i;
            for (let j = 0; j < 10; j++) {
                const angle = (Math.PI * 2 * j) / 10 - (Math.PI / 2);
                const x = center + r * Math.cos(angle);
                const y = center + r * Math.sin(angle);
                levelPoints.push(`${x},${y}`);
            }
            gridSVG += `<polygon points="${levelPoints.join(' ')}" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>`;
        }

        // Оси и Текст
        let axesSVG = '';
        let labelsSVG = '';
        const langKey = ['en','ru','es','de'].includes(currentLang) ? currentLang : 'en';

        PSYCHO_AXES.forEach((key, i) => {
            const angle = (Math.PI * 2 * i) / 10 - (Math.PI / 2);
            const x = center + radius * Math.cos(angle);
            const y = center + radius * Math.sin(angle);
            
            axesSVG += `<line x1="${center}" y1="${center}" x2="${x}" y2="${y}" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>`;

            // Текст подальше от края (radius + 20)
            const labelR = radius + 25; 
            const lx = center + labelR * Math.cos(angle);
            const ly = center + labelR * Math.sin(angle);
            
            const labelText = PSYCHO_LABELS[key][langKey].toUpperCase();
            
            // Умное выравнивание
            let anchor = 'middle';
            let dominantBaseline = 'middle';
            
            if (i === 0) { anchor = 'middle'; dominantBaseline = 'auto'; } // Верх
            else if (i === 5) { anchor = 'middle'; dominantBaseline = 'hanging'; } // Низ
            else if (i > 0 && i < 5) { anchor = 'start'; } // Справа
            else { anchor = 'end'; } // Слева

            labelsSVG += `<text x="${lx}" y="${ly}" text-anchor="${anchor}" dominant-baseline="${dominantBaseline}" fill="#ffffff" font-size="10" font-family="sans-serif" font-weight="700" style="text-shadow:0 1px 3px rgba(0,0,0,0.8);">${labelText}</text>`;
        });

        // Данные
        let prevPoints = [];
        if (prevData) {
            PSYCHO_AXES.forEach((key, i) => {
                const val = prevData[key] || 0;
                const [x, y] = getCoords(val, i);
                prevPoints.push(`${x},${y}`);
            });
        }
        const prevPoly = prevPoints.length > 0 
            ? `<polygon points="${prevPoints.join(' ')}" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1" stroke-dasharray="4"/>` 
            : '';

        let currPoints = [];
        PSYCHO_AXES.forEach((key, i) => {
            const val = currentData[key] || 0;
            const [x, y] = getCoords(val, i);
            currPoints.push(`${x},${y}`);
        });
        // Заливка цветом темы
        const currPoly = `<polygon class="radar-poly" points="${currPoints.join(' ')}" fill="var(--accent)" fill-opacity="0.5" stroke="var(--accent)" stroke-width="2"/>`;
        
        let dotsSVG = '';
        currPoints.forEach(p => {
            const [px, py] = p.split(',');
            dotsSVG += `<circle cx="${px}" cy="${py}" r="3" fill="#fff"/>`;
        });

        return `
            <svg viewBox="0 0 ${size} ${size}" width="100%" height="100%" style="overflow:visible;">
                ${gridSVG}
                ${axesSVG}
                ${prevPoly}
                ${currPoly}
                ${dotsSVG}
                ${labelsSVG}
            </svg>
        `;
    }

    // 6. Отрисовка UI (Слайды)
    function openWrappedUI(dataObj) {
        const overlay = document.getElementById('wrapped-mount');
        overlay.innerHTML = '';
        overlay.classList.add('active');
        
        const stats = dataObj.stats;
        const type = dataObj.type;
        
        // Определяем текущий язык
        const langKey = ['en','ru','es','de'].includes(currentLang) ? currentLang : 'en';
        
        // --- 1. ПЕРЕВОДЫ (Локальный словарь для Wrapped) ---
        const TXT = {
            title: {en:"Fetish<br><span style='color:var(--accent)'>Wrapped</span>", ru:"Итоги<br><span style='color:var(--accent)'>Фетишей</span>", es:"Resumen<br><span style='color:var(--accent)'>Fetichista</span>", de:"Fetisch<br><span style='color:var(--accent)'>Rückblick</span>"},
            since: {en:"Since Last Time", ru:"С прошлого раза", es:"Desde la última vez", de:"Seit dem letzten Mal"},
            act: {en:"Swipes", ru:"Свайпов", es:"Deslizamientos", de:"Swipes"},
            watch: {en:"Watch Time", ru:"Время просмотра", es:"Tiempo visto", de:"Zeit"},
            period_daily: {en: "Last 24 Hours", ru: "За последние 24ч", es: "Últimas 24h", de: "Letzte 24h"},
            period_weekly: {en: "This Week", ru: "За эту неделю", es: "Esta semana", de: "Diese Woche"},
            period_monthly: {en: "This Month", ru: "За этот месяц", es: "Este mes", de: "Diesen Monat"},
            period_yearly: {en: "This Year", ru: "За этот год", es: "Este año", de: "Dieses Jahr"},
            vibe: {en:"Your Vibe", ru:"Твой Вайб", es:"Tu Vibra", de:"Deine Stimmung"},
            evol: {en:"Taste Evolution", ru:"Эволюция Вкусов", es:"Evolución", de:"Entwicklung"},
            evol_sub: {en:"Vs Previous Period", ru:"Сравнение с прошлым", es:"Vs periodo anterior", de:"Vs letztes Mal"},
            obsess: {en:"Your Obsessions", ru:"Твои Одержимости", es:"Tus Obsesiones", de:"Deine Obsessionen"},
            cmp_more: {en:"more", ru:"больше", es:"más", de:"mehr"},
            cmp_less: {en:"less", ru:"меньше", es:"menos", de:"weniger"},
            cmp_same: {en:"same", ru:"также", es:"igual", de:"gleich"},

            top_fetishes_title: {en: "Your Top Fetishes", ru: "Твои Топ Фетиши", es: "Tus Fetiches Top", de: "Deine Top-Fetische"},
            
            // Финальная карточка
            sum_watch: {en:"Videos Watched", ru:"Видео просмотрено", es:"Videos vistos", de:"Angeschaut"},
            sum_time: {en:"Total Time", ru:"Общее время", es:"Tiempo Total", de:"Gesamtzeit"},
            sum_psycho: {en:"YOUR PSYCHOTYPE", ru:"ТВОЙ ПСИХОТИП", es:"TU PSICOTIPO", de:"DEIN PSYCHOTYP"},
            top_genre: {en:"Top Genre", ru:"Топ Жанр", es:"Top Género", de:"Top Genre"},
            
            btn_done: {en:"Done", ru:"Готово", es:"Listo", de:"Fertig"},
            caption: {en:"Discover yourself", ru:"Узнай себя", es:"Descúbrete", de:"Entdecke dich"},
            
            // Слайд диаграммы
            radar_title: {en: "Your Psycho-Profile", ru: "Твой психо-портрет", es: "Tu Psico-Perfil", de: "Dein Psycho-Profil"},
            radar_curr: {en: "Current", ru: "Сейчас", es: "Ahora", de: "Aktuell"},
            radar_prev: {en: "Previous", ru: "Прошлое", es: "Anterior", de: "Vorher"},

            badge_new: {en:"NEW", ru:"NEW", es:"NUEVO", de:"NEU"},
            badge_up: {en:"UP", ru:"UP", es:"SUBIÓ", de:"HOCH"},
            badge_down: {en:"DOWN", ru:"DOWN", es:"BAJÓ", de:"RUNTER"}
        };
            

        // Хелпер для получения текста
        const t = (k) => (TXT[k] && TXT[k][langKey]) ? TXT[k][langKey] : (langData[currentLang][k] || "");

        // Подготовка данных
        const badgeText = WRAPPED_CONFIG.badges[langKey][type] || type.toUpperCase();
        const phrases = WRAPPED_CONFIG.phrases[type] || WRAPPED_CONFIG.phrases.daily;
        const introText = phrases[langKey][Math.floor(Math.random() * phrases[langKey].length)];
        const logoSrc = getThemeLogoSrc(localStorage.getItem('xch_theme_id') || 'dark');
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=0&data=${encodeURIComponent(window.location.origin)}`;

        // Психотип
        const psychoKey = calculatePsychotype(stats.psychoCounts);
        const psychoData = PSYCHO_TYPES[psychoKey] || PSYCHO_TYPES['vanilla'];
        const psychoName = psychoData[langKey].toUpperCase();
        const psychoDesc = psychoData['desc_' + langKey];

        // ============================================
        // 1. ФИКСИРОВАННЫЕ СЛАЙДЫ (Первый и Последний)
        // ============================================

        // --- ВСТУПЛЕНИЕ (Первый) ---
        const introSlide = `
            <div class="wrapped-slide bg-dark active-slide">
                <div class="w-badge ${type}" style="transform:scale(1.5); margin-bottom:30px; box-shadow:0 10px 30px rgba(0,0,0,0.5);">${badgeText}</div>
                <div class="wrapped-big-text shimmer-text" style="font-size:46px;">${t('title')}</div>
                <div class="wrapped-sub-text" style="opacity:0.8; margin-top:20px; font-family:monospace;">${dataObj.rangeStr}</div>
                <div class="wrapped-sub-text" style="margin-top:40px; font-weight:700; max-width:80%;">${introText}</div>
            </div>
        `;

        // --- ФИНАЛ (Последний) ---
        // Определяем имя топ-жанра (берем первый тег)
        let topGenreTag = stats.topTags[0] ? stats.topTags[0].toUpperCase() : '---';
        const genreMatch = modifiersData.find(m => m.key.toLowerCase() === topGenreTag.toLowerCase());
        if (genreMatch && genreMatch[langKey]) topGenreTag = genreMatch[langKey].toUpperCase();

        const planColor = subscriptionLevel === 'free' ? '#fff' : '#9b59b6';

        const finalSlide = `
            <div class="wrapped-slide bg-dark">
                <div class="sum-card-new" id="wrapped-summary-card">
                    <div class="sum-header">
                        <div class="sum-header-left">
                            <div class="sum-logo-row">
                                <img src="${logoSrc}" class="sum-logo-img">
                                <div class="sum-logo-text">x<span class="grad">Fetish</span>Hub</div>
                            </div>
                            <div class="sum-caption">${t('caption')}</div>
                        </div>
                        <div class="sum-qr-box">
                            <img src="${qrUrl}" class="sum-qr-img">
                        </div>
                    </div>

                    <div class="sum-meta-row">
                        <span>${dataObj.rangeStr}</span>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span class="w-badge ${type}" style="font-size:9px;">${badgeText}</span>
                            <span style="color:${planColor}; font-weight:700;">${subscriptionLevel.toUpperCase()}</span>
                        </div>
                    </div>

                    <div class="sum-grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- Статистика -->
                        <div class="sum-stat-box">
                            <div class="sum-stat-val">${stats.watchCount}</div>
                            <div class="sum-stat-lbl">${t('sum_watch')}</div>
                        </div>
                        <div class="sum-stat-box">
                            <div class="sum-stat-val">${Math.round(stats.totalWatchTime/60)}m</div>
                            <div class="sum-stat-lbl">${t('sum_time')}</div>
                        </div>
                        <!-- Психотип -->
                        <div class="sum-stat-box" style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid var(--accent); padding: 15px 10px;">
                            <div class="sum-stat-lbl" style="color:var(--accent); font-weight:800; letter-spacing:1px; margin-bottom:5px;">${t('sum_psycho')}</div>
                            <div style="font-size:22px; font-weight:900; color:#fff; text-transform:uppercase; line-height:1.1;">
                                ${psychoName}
                            </div>
                            <div style="font-size:10px; color:rgba(255,255,255,0.6); margin-top:5px; font-style:italic;">
                                "${psychoDesc}"
                            </div>
                        </div>
                    </div>

                    <div style="text-align:center; margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                        <div class="sum-stat-lbl" style="margin-bottom:5px;">${t('top_genre')}</div>
                        <div style="font-size:24px; font-weight:900; color:var(--accent); letter-spacing:1px;">
                            ${topGenreTag}
                        </div>
                    </div>
                </div>
                <div style="margin-top:30px; display:flex; gap:15px; align-items:center; z-index: 1000;">
                    <button onclick="closeWrapped()" class="btn-gen" style="width:auto; padding:12px 40px; font-size:16px; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); backdrop-filter:blur(10px);">
                        ${t('btn_done')}
                    </button>
                    <div class="btn-round-share" onclick="shareWrappedCard()">
                        <img src="share.png" alt="Share">
                    </div>
                </div>
            </div>
        `;

        // ============================================
        // 2. СРЕДНИЕ СЛАЙДЫ (Для перемешивания)
        // ============================================
        const middleSlides = [];

        // --- A. Слайд "Активность" (Actions vs Time) ---
        // Показываем, если не Daily или если есть изменения
        if (type !== 'daily' || Math.abs(stats.deltaActions) > 0) {
            const getTrendHTML = (delta) => {
                if (delta === 0) return `<span style="opacity:0.6">= ${t('cmp_same')}</span>`;
                const isPos = delta > 0;
                const color = isPos ? "#2ecc71" : "#e74c3c";
                const sign = isPos ? "+" : "";
                return `<span style="color:${color}">${sign}${delta}</span> <span style="opacity:0.6">vs prev</span>`;
            };
            const htmlActTrend = getTrendHTML(stats.deltaActions);
            const htmlTimeTrend = getTrendHTML(Math.round(stats.deltaWatchTime/60));
            let periodHeader = t('period_' + type) || t('since');

            middleSlides.push(`
                <div class="wrapped-slide bg-fire">
                    <div class="wrapped-sub-text" style="text-transform:uppercase; letter-spacing:2px; font-size:14px; margin-bottom:40px; font-weight:800; color:rgba(255,255,255,0.9); border-bottom:1px solid rgba(255,255,255,0.3); padding-bottom:10px;">${periodHeader}</div>
                    <div style="margin-bottom:50px; width:100%; display:flex; flex-direction:column; align-items:center;">
                        <div class="wrapped-big-text count-anim" data-target="${stats.totalActions}" style="font-size:80px; margin-bottom:0; line-height:1;">0</div>
                        <div class="wrapped-sub-text" style="font-weight:700; margin-bottom:10px;">${t('act')}</div>
                        <div class="reveal-delayed delay-1500" style="background:rgba(0,0,0,0.3); padding:5px 15px; border-radius:20px; font-size:15px; font-weight:600; border:1px solid rgba(255,255,255,0.1);">${htmlActTrend}</div>
                    </div>
                    <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:40px; width:80%; display:flex; flex-direction:column; align-items:center;">
                        <div class="wrapped-big-text" style="font-size:80px; margin-bottom:0; line-height:1;">
                            <span class="count-anim" data-target="${Math.round(stats.totalWatchTime / 60)}">0</span><span style="font-size:30px">m</span>
                        </div>
                        <div class="wrapped-sub-text" style="font-weight:700; margin-bottom:10px;">${t('watch')}</div>
                        <div class="reveal-delayed delay-1500" style="background:rgba(0,0,0,0.3); padding:5px 15px; border-radius:20px; font-size:15px; font-weight:600; border:1px solid rgba(255,255,255,0.1);">${htmlTimeTrend}</div>
                    </div>
                </div>
            `);
        }

        // --- B. Слайд "Эволюция" (Evolution) ---
        if (stats.prevTopTags && stats.prevTopTags.length > 0) {
            const formatTag = (tag) => {
                let display = tag.toUpperCase();
                const m = modifiersData.find(x => x.key.toLowerCase() === tag.toLowerCase());
                if(m && m[langKey]) display = m[langKey].toUpperCase();
                return display;
            };
            const evoData = JSON.stringify({ 
                prev: stats.prevTopTags.slice(0, 5).map(formatTag), 
                curr: stats.topTags.slice(0, 5).map(formatTag) 
            }).replace(/"/g, '&quot;');

            middleSlides.push(`
                <div class="wrapped-slide" style="background:linear-gradient(45deg, #1cb5e0 0%, #000851 100%);">
                    <div class="wrapped-sub-text stagger-text stagger-delay-1" style="text-transform:uppercase; margin-bottom:10px;">${t('evol')}</div>
                    <div class="wrapped-sub-text stagger-text stagger-delay-2" style="font-size:12px; opacity:0.6; margin-bottom:40px;">${t('evol_sub')}</div>
                    <div class="evo-container" data-evo="${evoData}"></div>
                </div>
            `);
        }

        // --- C. Слайд "Радар" (Психотип) ---
        const prevPsychoCounts = stats.prevPsychoCounts || {};
        const radarSVG = createRadarChartSVG(stats.psychoCounts, prevPsychoCounts);
        middleSlides.push(`
            <div class="wrapped-slide" style="background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); justify-content: flex-start; padding-top: 60px;">
                <div class="wrapped-sub-text" style="text-transform:uppercase; margin-bottom:30px; font-weight:800; letter-spacing:1px;">${t('radar_title')}</div>
                <div style="width:340px; height:340px; margin-bottom:30px; position:relative; flex-shrink:0;">${radarSVG}</div>
                <div style="display:flex; gap:20px; font-size:12px; font-weight:600; margin-bottom:30px;">
                    <div style="display:flex; align-items:center; gap:6px;"><div style="width:10px; height:10px; background:var(--accent); border-radius:50%;"></div><span style="color:var(--text-main)">${t('radar_curr')}</span></div>
                    <div style="display:flex; align-items:center; gap:6px;"><div style="width:10px; height:10px; background:rgba(255,255,255,0.3); border:1px dashed #fff; border-radius:50%;"></div><span style="color:var(--text-secondary)">${t('radar_prev')}</span></div>
                </div>
                <div class="reveal-delayed delay-3000" style="text-align:center; width:90%; background:rgba(255,255,255,0.05); padding:20px; border-radius:20px; border:1px solid var(--accent); box-shadow: 0 0 30px rgba(255,0,204, 0.2);">
                    <div style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; margin-bottom:5px;">${t('sum_psycho')}</div>
                    <div style="font-size:28px; font-weight:900; color:#fff; margin-bottom:5px; line-height:1.1; text-shadow: 0 0 10px var(--accent); text-transform:uppercase;">${psychoName}</div>
                    <div style="font-size:13px; font-style:italic; opacity:0.8;">"${psychoDesc}"</div>
                </div>
            </div>
        `);

        // --- D. Слайд "ТОП ФЕТИШИ" ---
        // Показываем только если НЕ Daily и есть данные
        if (type !== 'daily' && stats.topFetishes && stats.topFetishes.length > 0) {
            
            let fetishesHTML = '';
            stats.topFetishes.forEach((entry, index) => {
                const rank = index + 1;
                const item = entry.item; 
                const name = getLocalizedName(item); 
                

                if (rank === 1) {
                    // ТОП-1: Таймер + Текст по центру
                    fetishesHTML += `
                    <div class="cat-rank-row ${rank === 1 ? 'rank-1' : 'anim-list-item'}" style="${rank !== 1 ? `animation-delay:${(5-index)*0.1}s;` : ''}">
                        ${rank === 1 ? `<div class="rank-1-mask" id="cat-mask"><div class="countdown-number" id="cat-countdown">3</div></div>` : ''}
                        
                        <div style="display:flex; align-items:center; width:100%;">
                            <div class="cat-rank-num" style="color:#ffd700; min-width:30px;">#1</div>
                            <div class="cat-rank-name" style="color:#ffd700; font-size:20px; text-align:left;">${name}</div>
                            <div class="cat-rank-score">🏆 WINNER</div>
                        </div>
                    </div>
                `;
                } else {
                    const delay = (5 - index) * 0.1;
                    fetishesHTML += `
                        <div class="cat-rank-row anim-list-item" style="animation-delay:${delay}s">
                            <div class="cat-rank-num">#${rank}</div>
                            <!-- ИКОНКА УБРАНА -->
                            <div class="cat-rank-name" style="margin-left:0;">${name}</div>
                            <div class="cat-rank-score">${entry.score} pts</div>
                        </div>
                    `;
                }
            });

            const newSlide = `
                <div class="wrapped-slide" style="background: linear-gradient(180deg, #141E30 0%, #243B55 100%);">
                    <div class="wrapped-sub-text" style="margin-bottom:30px; font-weight:800; text-transform:uppercase; letter-spacing:1px;">
                        ${t('top_fetishes_title')}
                    </div>
                    <div class="top-cats-container">
                        ${fetishesHTML}
                    </div>
                </div>
            `;
            middleSlides.push(newSlide);
        }

        // --- Слайд "Loyalty Check" ---
        const loyaltySlide = `
            <div class="wrapped-slide" style="background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); overflow: hidden;">
                <div class="wrapped-sub-text" style="text-transform:uppercase; letter-spacing:2px; margin-bottom:20px;">${t('loyalty_title')}</div>
                
                <div style="position: relative; width: 100%; height: 300px; margin: 40px 0;">
                    <!-- Лево Верх: Старое -->
                    <div id="loy-old-box" class="loyalty-box" style="position:absolute; top:0; left:20px; text-align:left; transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);">
                        <div style="font-size:60px;">🥰</div>
                        <div style="font-size:14px; font-weight:800; color:rgba(255,255,255,0.6);">${t('loyalty_old_label')}</div>
                        <div style="font-size:32px; font-weight:900;">${stats.loyaltyPct}%</div>
                    </div>

                    <!-- VS по центру -->
                    <div id="loy-vs" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:40px; font-weight:900; font-style:italic; color:var(--accent); text-shadow: 0 0 20px var(--accent); transition: all 0.5s;">VS</div>

                    <!-- Право Низ: Новое -->
                    <div id="loy-new-box" class="loyalty-box" style="position:absolute; bottom:0; right:20px; text-align:right; transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);">
                        <div style="font-size:60px;">🔭</div>
                        <div style="font-size:14px; font-weight:800; color:rgba(255,255,255,0.6);">${t('loyalty_new_label')}</div>
                        <div style="font-size:32px; font-weight:900;">${stats.curiosityPct}%</div>
                    </div>
                </div>

                <!-- Титул и описание (появляются после анимации) -->
                <div id="loy-result" class="reveal-delayed" style="text-align:center; opacity:0; transform:translateY(20px); transition: all 0.6s ease 1.5s;">
                    <div style="font-size:12px; color:var(--accent); font-weight:800; text-transform:uppercase; margin-bottom:5px;">${t('vibe')}</div>
                    <div style="font-size:32px; font-weight:900; text-transform:uppercase; color:#fff; margin-bottom:10px;">${t('loyalty_title_' + stats.loyaltyStatus)}</div>
                    <div style="font-size:15px; opacity:0.8; max-width:280px; margin: 0 auto; line-height:1.4;">${t('loyalty_desc_' + stats.loyaltyStatus)}</div>
                </div>

                <style>
                    .winner-side { transform: scale(1.3) translate(0, 0) !important; z-index: 10; }
                    .loser-side { opacity: 0.2; transform: scale(0.8); filter: blur(2px); }
                    .vs-hidden { opacity: 0; transform: translate(-50%, -50%) scale(0); }
                </style>
            </div>
        `;
        middleSlides.push(loyaltySlide);

        // ============================================
        // 3. ПЕРЕМЕШИВАНИЕ И СБОРКА
        // ============================================

        // Перемешиваем средние слайды (Fisher-Yates)
        for (let i = middleSlides.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [middleSlides[i], middleSlides[j]] = [middleSlides[j], middleSlides[i]];
        }

        // Собираем всё вместе
        const allSlides = [introSlide, ...middleSlides, finalSlide];

        // Генерируем HTML для прогресс-баров
        let barsHtml = '';
        allSlides.forEach((_, i) => barsHtml += `<div class="wrapped-progress-bar"><div class="wrapped-progress-fill" id="bar-${i}"></div></div>`);
        
        // Вставляем всё в DOM
        overlay.innerHTML = `
            <div class="wrapped-progress-container">${barsHtml}</div>
            <div class="wrapped-close" onclick="closeWrapped()">✕</div>
            <div class="wrapped-nav-area nav-left" onclick="prevSlide()"></div>
            <div class="wrapped-nav-area nav-right" onclick="nextSlide()"></div>
            ${allSlides.join('')}
        `;
        
        // ============================================
        // 4. ЗАПУСК
        // ============================================
        
        // Инициализация
        currentSlideIndex = 0;
        startSlideTimerNew(allSlides.length, 6000); // 6 секунд на слайд
        
        // Обработчики кликов/паузы
        const isInteractive = (e) => e.target.closest('button') || e.target.closest('.wrapped-close') || e.target.closest('.btn-round-share') || e.target.closest('.wrapped-nav-area');
        
        const handlePause = (e) => { 
            if (isInteractive(e)) return; 
            if(e.cancelable) e.preventDefault(); 
            overlay.classList.add('paused'); 
            window.isWrappedPaused = true; 
        };
        
        const handleResume = (e) => { 
            if (isInteractive(e)) return; 
            if(e.cancelable) e.preventDefault(); 
            overlay.classList.remove('paused'); 
            window.isWrappedPaused = false; 
        };

        overlay.addEventListener('mousedown', handlePause);
        overlay.addEventListener('touchstart', handlePause, {passive: false});
        overlay.addEventListener('mouseup', handleResume);
        overlay.addEventListener('touchend', handleResume, {passive: false});
        overlay.addEventListener('mouseleave', handleResume);

        // Помечаем как просмотренное
        dataObj.viewed = true;
        localStorage.setItem('xch_wrapped_archive', JSON.stringify(wrappedArchive));

         updateAppBadge();
        
        // Обновляем бейдж в меню статистики
        openStatistics(); 
        
        // Показываем оверлей
        overlay.classList.add('active');
    }

    // ТАЙМЕР (С поддержкой паузы)
    function startSlideTimerNew(total, duration = 6000) {
        clearInterval(slideInterval);
        
        const show = (idx) => {
            // Переключаем слайды
            document.querySelectorAll('.wrapped-slide').forEach(el => el.classList.remove('active-slide'));
            document.querySelectorAll('.wrapped-slide')[idx].classList.add('active-slide');

            handleSlideAnimations(idx);
            
            // Обновляем прогресс-бары
            for(let i=0; i<total; i++) {
                const bar = document.getElementById('bar-'+i);
                if (!bar) continue;

                // СБРОС ВСЕХ АНИМАЦИЙ И ПЕРЕХОДОВ
                bar.classList.remove('animating');
                bar.style.transition = 'none'; // Важно! Убираем плавность для мгновенного переключения состояний
                bar.style.animationDuration = '0ms';

                if (i < idx) { 
                    // ПРОШЛЫЕ СЛАЙДЫ: Полностью закрашены
                    bar.style.width = '100%'; 
                }
                else if (i > idx) { 
                    // БУДУЩИЕ СЛАЙДЫ: Пустые
                    bar.style.width = '0%'; 
                }
                else {
                    // ТЕКУЩИЙ СЛАЙД: Сначала 0, потом анимация
                    bar.style.width = '0%';
                    
                    // Трюк с reflow для перезапуска CSS-анимации
                    void bar.offsetWidth; 
                    
                    bar.style.animationDuration = `${duration}ms`;
                    bar.classList.add('animating'); // CSS класс сделает остальное
                }
            }
        };

        // Показываем текущий слайд сразу
        show(currentSlideIndex);

        // Таймер
        let elapsed = 0;
        const step = 100;
        window.isWrappedPaused = false;

        slideInterval = setInterval(() => {
            if (currentSlideIndex >= total - 1) {
                clearInterval(slideInterval);
                return;
            }

            if (!window.isWrappedPaused) {
                elapsed += step;
                if (elapsed >= duration) {
                    elapsed = 0;
                    currentSlideIndex++;
                    if (currentSlideIndex < total) {
                        show(currentSlideIndex);
                    } else {
                        clearInterval(slideInterval);
                    }
                }
            }
        }, step);
    }

    function handleSlideAnimations(slideIndex) {
        const activeSlide = document.querySelectorAll('.wrapped-slide')[slideIndex];
        if (!activeSlide) return;

        // 1. АНИМАЦИЯ СЧЕТЧИКОВ
        const counters = activeSlide.querySelectorAll('.count-anim');
        counters.forEach(el => {
            const target = parseInt(el.getAttribute('data-target'));
            animateValue(el, 0, target, 1500);
        });

        // 2. АНИМАЦИЯ РАДАРА (ПСИХОТИП)
        const radar = activeSlide.querySelector('.radar-poly');
        if (radar) {
            // Сброс и запуск
            radar.classList.remove('animate');
            void radar.offsetWidth; // Reflow
            setTimeout(() => radar.classList.add('animate'), 500);
        }

        // 3. АНИМАЦИЯ ЭВОЛЮЦИИ (СЛОЖНАЯ)
        const evoContainer = activeSlide.querySelector('.evo-container');
        if (evoContainer) {
            runEvolutionAnimation(evoContainer);
        }
        // 4. АНИМАЦИЯ СПИСКА ФЕТИШЕЙ
        const listItems = activeSlide.querySelectorAll('.anim-list-item');
        listItems.forEach(el => {
            el.classList.remove('visible');
            void el.offsetWidth; 
            setTimeout(() => el.classList.add('visible'), 100);
        });

        // 5. ТАЙМЕР ИНТРИГИ
        const mask = activeSlide.querySelector('#cat-mask');
        const countdownEl = activeSlide.querySelector('#cat-countdown');
        const topRow = activeSlide.querySelector('#cat-rank-1');

        if (mask && countdownEl) {
            mask.classList.remove('revealed');
            countdownEl.innerText = "3";
            if(topRow) topRow.classList.remove('visible');

            let count = 3;
            const int = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.innerText = count;
                    if(navigator.vibrate) navigator.vibrate(50);
                } else {
                    clearInterval(int);
                    mask.classList.add('revealed');
                    if(topRow) topRow.classList.add('visible');
                    if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            }, 800);
        }

        // 6. LOYALTY CHECK
        const status = stats.loyaltyStatus;

        const oldBox = activeSlide.querySelector('#loy-old-box');
        const newBox = activeSlide.querySelector('#loy-new-box');
        const vs = activeSlide.querySelector('#loy-vs');
        const result = activeSlide.querySelector('#loy-result');

        if (oldBox && newBox && vs) {
            // Сброс позиций
            oldBox.className = "loyalty-box";
            newBox.className = "loyalty-box";
            vs.className = "";
            result.style.opacity = "0";

            // Запускаем анимацию через секунду
            setTimeout(() => {
                vs.classList.add('vs-hidden');
                
                if (status === 'cons') {
                    oldBox.style.left = "50%";
                    oldBox.style.top = "40%";
                    oldBox.style.transform = "translate(-50%, -50%) scale(1.4)";
                    newBox.classList.add('loser-side');
                } else if (status === 'pioneer') {
                    newBox.style.right = "50%";
                    newBox.style.bottom = "50%";
                    newBox.style.transform = "translate(50%, 50%) scale(1.4)";
                    oldBox.classList.add('loser-side');
                } else {
                    // Balanced: Сдвигаем оба ближе к центру
                    oldBox.style.transform = "scale(1.1)";
                    newBox.style.transform = "scale(1.1)";
                }
                
                // Показываем текст результата
                result.style.opacity = "1";
                result.style.transform = "translateY(0)";
            }, 1200);
        }
    }

    // Утилита для счета чисел
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            // Easing easeOutQuart
            const ease = 1 - Math.pow(1 - progress, 4);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end; // Финал
            }
        };
        window.requestAnimationFrame(step);
    }

    // Утилита для анимации Эволюции
    function runEvolutionAnimation(container) {
        // Данные храним в атрибуте контейнера (как JSON строка)
        const dataTags = JSON.parse(container.getAttribute('data-evo'));
        const { prev, curr } = dataTags;
        
        container.innerHTML = ''; // Очистка
        const rowHeight = 50;
        
        // ЭТАП 1: Рендерим ПРЕДЫДУЩИЙ ТОП (как будто это старт)
        // Создаем элементы
        const elementsMap = {}; // Map для отслеживания элементов по имени тега

        // 1. Создаем элементы для ВСЕХ тегов (и прошлых, и нынешних)
        const allTags = new Set([...prev, ...curr]);
        
        allTags.forEach(tag => {
            const el = document.createElement('div');
            el.className = 'evo-row';
            el.innerHTML = `<span style="font-size:20px; font-weight:800;">${tag}</span>`;
            
            // Начальная позиция
            const prevIndex = prev.indexOf(tag);
            if (prevIndex !== -1) {
                // Если был в прошлом топе - ставим на его место
                el.style.top = `${prevIndex * rowHeight}px`;
                el.style.opacity = '1';
            } else {
                // Если новый - прячем снизу
                el.style.top = `${5 * rowHeight + 20}px`; 
                el.style.opacity = '0';
                el.innerHTML += ` <span style="font-size:10px; background:#2ecc71; color:#000; padding:2px 6px; border-radius:4px; margin-left:10px; font-weight:800;">NEW</span>`;
            }
            
            container.appendChild(el);
            elementsMap[tag] = el;
        });

        // ЭТАП 2: ЗАПУСК ПЕРЕМЕЩЕНИЯ (Через 1 секунду)
        setTimeout(() => {
            allTags.forEach(tag => {
                const el = elementsMap[tag];
                const currIndex = curr.indexOf(tag);
                
                if (currIndex !== -1) {
                    // Тег есть в текущем топе -> перемещаем на новую позицию
                    el.style.top = `${currIndex * rowHeight}px`;
                    el.style.opacity = '1';
                    
                    // Если поднялся/опустился - можно добавить стрелочку (опционально)
                } else {
                    // Тег вылетел из топа -> уводим вниз и растворяем
                    el.style.top = `${5 * rowHeight + 50}px`;
                    el.style.opacity = '0';
                }
            });
        }, 1200);
    }

    // 7. Рендер списка в Истории (Archive Tab)
    function renderWrappedArchive() {
        const list = document.getElementById('hist-list-wrapped');
        list.innerHTML = '';
        
        // Сортировка: новые сверху
        const items = wrappedArchive.sort((a,b) => b.timestamp - a.timestamp);
        const isPaid = subscriptionLevel !== 'free';

        if (items.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.5;">Archive empty</div>`;
            return;
        }

        items.forEach(w => {
            // Скрываем Daily от бесплатных пользователей в архиве
            if (w.type === 'daily' && !isPaid) return;

            const dateObj = new Date(w.timestamp);
            const dateStr = dateObj.toLocaleDateString();
            
            const lang = WRAPPED_CONFIG.badges[currentLang] ? currentLang : 'en';
            const badgeLabel = WRAPPED_CONFIG.badges[lang][w.type];
            
            const div = document.createElement('div');
            div.className = 'wrapped-archive-item';
            div.onclick = () => {
                closeHistoryModal(null, true); // Закрываем модалку истории
                openWrappedUI(w); // Открываем Wrapped
            };
            
            // Точка если не прочитано
            const dot = !w.viewed ? `<span style="color:var(--accent); font-size:20px; margin-right:8px;">●</span>` : ``;

            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    ${dot}
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:700; color:var(--text-main); font-size:15px;">${dateStr}</span>
                        <span style="font-size:11px; color:var(--text-secondary); margin-top:2px;">${w.type === 'daily' ? 'Snapshot' : w.rangeStr}</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span class="w-badge ${w.type}">${badgeLabel}</span>
                    <span style="color:var(--text-secondary); margin-left:10px;">›</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // Генератор QR URL
    function getQrUrl(url) {
        return `https://api.qrserver.com/v1/create-qr-code/?size=150x150&margin=5&data=${encodeURIComponent(url)}`;
    }

    // Создание HTML хедера (лого + подпись + QR)
    function createScreenshotHeader() {
        const t = langData[currentLang] || langData['en'];
        const caption = t.share_caption || "Discover yourself";
        const qrUrl = getQrUrl(window.location.origin); // Ссылка на главную

        const header = document.createElement('div');
        header.className = 'screenshot-header';
        header.innerHTML = `
            <div class="screenshot-logo-area">
                <div class="screenshot-logo">x<span>Fetish</span>Hub</div>
                <div class="screenshot-caption">${caption}</div>
            </div>
            <div class="screenshot-qr">
                <img src="${qrUrl}" style="width:100%; height:100%; display:block;">
            </div>
        `;
        return header;
    }

    function shareWrappedCard() {
        // 1. Находим исходную карточку
        const originalCard = document.getElementById('wrapped-summary-card');
        if (!originalCard) return;

        if (navigator.vibrate) navigator.vibrate(50);

        // 2. Создаем контейнер-клон (вне экрана)
        // Используем id или класс, который мы прописали в CSS выше
        const exportContainer = document.createElement('div');
        exportContainer.className = 'export-clone-container';
        
        // 3. Клонируем карточку
        const cloneCard = originalCard.cloneNode(true);
        
        // Находим спан с классом .grad внутри клона
        const gradSpan = cloneCard.querySelector('.sum-logo-text span.grad');
        if (gradSpan) {
            // Принудительно ставим сплошной цвет
            gradSpan.style.background = 'none';
            gradSpan.style.webkitTextFillColor = 'var(--accent)'; 
            gradSpan.style.color = 'var(--accent)';
            // Убираем любые маски
            gradSpan.style.webkitBackgroundClip = 'border-box';
            gradSpan.style.backgroundClip = 'border-box';
        }

        // Добавляем клон в контейнер, а контейнер в body
        exportContainer.appendChild(cloneCard);
        document.body.appendChild(exportContainer);

        // 4. Генерируем скриншот с клона
        html2canvas(exportContainer, {
            backgroundColor: null, // Прозрачный фон (или цвет из CSS контейнера)
            scale: 2, // Высокое качество
            useCORS: true,
            allowTaint: true,
            logging: false
        }).then(canvas => {
            document.body.removeChild(exportContainer);
            shareCanvasImage(canvas, `fetish-wrapped-${Date.now()}.png`);
        }).catch(e => {
            console.error("Screenshot error:", e);
            if (document.body.contains(exportContainer)) document.body.removeChild(exportContainer);
            alert("Error creating image");
        });
    }

    // Закрытие всех модалок по ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            
            // 1. ЕСЛИ АКТИВЕН ПРЕДПРОСМОТР ТЕМЫ -> ОТМЕНЯЕМ ЕГО
            if (typeof isPreviewActive !== 'undefined' && isPreviewActive) {
                cancelPreview();
                return; // Прерываем, чтобы не закрыть открывшуюся модалку тем
            }

            // 2. Иначе закрываем модалки (стандартное поведение)
            const openModals = document.querySelectorAll('.modal-overlay.open');
            openModals.forEach(modal => {
                modal.classList.remove('open');
            });
        }
    });

   // =========================================
    // PANIC MODE (EMERGENCY SWITCH)
    // =========================================

    let isPanicMode = false;
    let lastTapTime = 0;
    let lastEscTime = 0;
    let prePanicSnapshot = null;

    // Инициализация тумблера при загрузке
    document.addEventListener("DOMContentLoaded", () => {
        const toggle = document.getElementById('panic-toggle-input');
        if (toggle) toggle.checked = isPanicEnabled;
    });

    // Хранилище состояний (чтобы вернуть всё как было)
    let savedSettingsState = {
        platformHTML: '', platformVal: '', 
        oriHTML: '', oriVal: '', 
        decoSrc: '', oriIconSrc: '', 
        themeId: ''
    };

    // Задания для безопасного режима
    const SAFE_TASKS = [
        { en: { name: "Wash Dishes", desc: "The sink is full. It's time to be a hero and clean those plates.", tags: ["Cleaning", "Kitchen", "Water"] }, ru: { name: "Помыть посуду", desc: "Раковина полна. Пришло время стать героем и отмыть эти тарелки.", tags: ["Уборка", "Кухня", "Вода"] }, es: { name: "Lavar los platos", desc: "El fregadero está lleno.", tags: ["Limpieza", "Cocina"] }, de: { name: "Geschirr spülen", desc: "Die Spüle ist voll.", tags: ["Reinigung", "Küche"] } },
        { en: { name: "Pet the Cat", desc: "Find a cat. Pet the cat. Listen to the purr. Relax.", tags: ["Animals", "Relax", "Soft"] }, ru: { name: "Погладить кота", desc: "Найди кота. Погладь кота. Слушай мурчание. Расслабься.", tags: ["Животные", "Релакс", "Мягко"] }, es: { name: "Acariciar al gato", desc: "Encuentra un gato.", tags: ["Animales", "Relax"] }, de: { name: "Katze streicheln", desc: "Finde eine Katze.", tags: ["Tiere", "Entspannung"] } },
        { en: { name: "Drink Water", desc: "Stay hydrated. Your body needs H2O to function properly.", tags: ["Health", "Liquid", "Life"] }, ru: { name: "Выпить воды", desc: "Поддерживай водный баланс. Твоему телу нужен H2O.", tags: ["Здоровье", "Жидкость", "Жизнь"] }, es: { name: "Beber agua", desc: "Mantente hidratado.", tags: ["Salud", "Vida"] }, de: { name: "Wasser trinken", desc: "Bleib hydriert.", tags: ["Gesundheit", "Leben"] } },
        { en: { name: "Read a Book", desc: "Expand your mind. Pick up that book you bought 3 years ago.", tags: ["Education", "Quiet", "Paper"] }, ru: { name: "Почитать книгу", desc: "Развивай разум. Возьми ту книгу, которую купил 3 года назад.", tags: ["Обучение", "Тишина", "Бумага"] }, es: { name: "Leer un libro", desc: "Expande tu mente.", tags: ["Educación", "Silencio"] }, de: { name: "Buch lesen", desc: "Erweitere deinen Geist.", tags: ["Bildung", "Ruhe"] } },
        { en: { name: "Go for a Walk", desc: "Touch some grass. Breathing fresh air is highly recommended.", tags: ["Outdoor", "Sport", "Nature"] }, ru: { name: "Сходить погулять", desc: "Потрогай траву. Свежий воздух крайне рекомендован.", tags: ["Улица", "Спорт", "Природа"] }, es: { name: "Ir a caminar", desc: "Toca el pasto.", tags: ["Exterior", "Deporte"] }, de: { name: "Spazieren gehen", desc: "Berühre Gras.", tags: ["Draußen", "Sport"] } }
    ];

    // --- ФУНКЦИИ УПРАВЛЕНИЯ НАСТРОЙКАМИ ---

    function updateSafeSettings(isSafe) {
        const t = langData[currentLang] || langData['en'];
        
        // В карте настроек добавляем флаг isSpecial: true только для Интенсивности
        const settingsMap = [
                { 
                    key: 'site_label', 
                    safeTxt: 'safe_label_site', 
                    normalIcon: 'site.png', 
                    safeIcon: 'watched-later.png' 
                },
                { 
                    key: 'ori_label', 
                    safeTxt: 'safe_label_ori', 
                    normalIcon: 'orientation.png', 
                    safeIcon: 'roadmap.png'
                },
                { 
                    key: 'exploration_mode', 
                    safeTxt: 'safe_label_int', 
                    normalIcon: null, 
                    safeIcon: 'plan.png',
                    isSpecial: true // <--- ВАЖНЫЙ ФЛАГ: Это строка Интенсивности
                },
                { 
                    key: 'deco_label', 
                    safeTxt: 'deco_label', 
                    normalIcon: 'deco.png', 
                    safeIcon: 'funny_deco.png'
                },
                { 
                    key: 'lang_label', 
                    safeTxt: 'lang_label', 
                    normalIcon: 'language.png', 
                    safeIcon: 'site.png'
                }
            ];

        settingsMap.forEach(item => {
            const textEl = document.querySelector(`[data-key="${item.key}"]`);
            if (!textEl) return;

            const parent = textEl.closest('.ios-row-left');
            const img = parent ? parent.querySelector('img.settings-icon') : null;

            if (isSafe) {
                // === РЕЖИМ ПАНИКИ (ВКЛЮЧЕН) ===
                
                // 1. Меняем текст
                if (item.safeTxt && t[item.safeTxt]) {
                    textEl.innerText = t[item.safeTxt];
                } else if (item.key === 'deco_label') {
                    textEl.innerText = (currentLang === 'ru') ? "Интерфейс" : "Interface";
                }

                // 2. Меняем иконку
                if (img && item.safeIcon) {
                    img.src = item.safeIcon;
                    
                    // Сброс старых стилей (фильтры, трансформации)
                    img.removeAttribute('style');

                    // Базовые размеры
                    img.style.width = "24px";
                    img.style.height = "24px";
                    img.style.objectFit = "contain";
                    img.style.opacity = "0.9";
                    
                    // --- ИСПРАВЛЕНИЕ ОТСТУПОВ ---
                    if (item.isSpecial) {
                        // Для Интенсивности (Сложность):
                        // Иконка лежит внутри div-контейнера, который уже имеет отступ.
                        // Самой иконке отступы НЕ нужны, чтобы она стояла по центру контейнера.
                        img.style.margin = "0px"; 
                    } else {
                        // Для Ориентации и остальных:
                        // Иконка лежит прямо рядом с текстом. 
                        // Ей НУЖЕН отступ справа, иначе она прилипнет или уедет влево.
                        img.style.marginRight = "12px";
                        img.style.marginLeft = "0px";
                    }
                }

            } else {
                // === ОБЫЧНЫЙ РЕЖИМ (ВЫКЛЮЧЕН) ===
                
                // 1. Возврат текста
                if (t[item.key]) {
                    textEl.innerText = t[item.key];
                }

                // 2. Возврат иконки
                if (img) {
                    if (item.key === 'exploration_mode') {
                        // Интенсивность восстанавливается своей функцией (вернет слайдер/цвета)
                        updateIntensity(currentIntensity);
                    } 
                    else if (item.normalIcon) {
                        img.src = item.normalIcon;
                        // Удаляем инлайн стили, чтобы вернулись стили из CSS-класса (.settings-icon)
                        img.removeAttribute('style'); 
                    }
                }
            }
        });
    }

    function openPanicSettings() {
        const modal = document.getElementById('modal-panic-settings');
        const body = modal.querySelector('.modal-body');
        const t = langData[currentLang] || langData['en'];
        const isPC = window.innerWidth > 768;

        // Очищаем старое содержимое
        body.innerHTML = '';

        // --- ОБЩАЯ КАРТИНКА ---
        const iconHtml = `
            <div style="text-align:center; margin-bottom:15px;">
                <img src="sos.png" style="width:60px; height:60px; filter: invert(1);">
            </div>
        `;

        // --- ЛОГИКА ДЛЯ МОБИЛЬНЫХ ---
        if (!isPC) {
            const descMobile = currentLang === 'ru' 
                ? "Быстрый вход/выход: <b>Двойной тап</b> по экрану.<br>Выход также возможен кнопкой <b>Начать</b>."
                : "Quick toggle: <b>Double Tap</b> anywhere.<br>Exit also via <b>Start</b> button.";

            body.innerHTML = `
                ${iconHtml}
                <div class="panic-note">${descMobile}</div>
                
                <div class="ios-group">
                    <div class="ios-row">
                        <div class="ios-row-left">
                            <span>${t.panic_enable}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" ${isPanicEnabled ? 'checked' : ''} onchange="togglePanicSetting(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            `;
        } 
        
        // --- ЛОГИКА ДЛЯ ПК ---
        else {
            const keyName = panicKey === ' ' ? 'Space' : panicKey.toUpperCase();
            const descPC = currentLang === 'ru' 
                ? `Вход/Выход: Нажатие клавиши <b>${keyName}</b>.<br>Выход также кнопкой <b>Начать</b>.`
                : `Toggle: Press <b>${keyName}</b>.<br>Exit also via <b>Start</b> button.`;

            const lblBinding = currentLang === 'ru' ? "Назначить клавишу" : "Key Binding";
            const lblTap = currentLang === 'ru' ? "Нажми, чтобы изменить" : "Click to change";
            const lblDouble = currentLang === 'ru' ? "Двойное нажатие" : "Double Press";

            body.innerHTML = `
                ${iconHtml}
                <div class="panic-note" id="panic-pc-desc">${descPC}</div>

                <div class="ios-group" style="margin-bottom: 20px;">
                    <div class="ios-row">
                        <div class="ios-row-left">
                            <span>${t.panic_enable}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" ${isPanicEnabled ? 'checked' : ''} onchange="togglePanicSetting(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Зона настройки клавиш -->
                <div style="padding: 0 5px;">
                    <div style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:8px; text-transform:uppercase;">
                        ${lblBinding}
                    </div>
                    
                    <div class="panic-key-box" id="panic-key-box" onclick="startKeyRecording()">
                        <div class="panic-key-label" id="panic-key-label">${lblTap}</div>
                        <div class="panic-key-value" id="panic-key-display">${keyName}</div>
                    </div>

                    <div class="ios-group">
                        <div class="ios-row">
                            <div class="ios-row-left">
                                <span>${lblDouble}</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" ${panicDouble ? 'checked' : ''} onchange="togglePanicDouble(this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        modal.classList.add('open');
    }

    function getSafeItem() {
        const langKey = ['en', 'ru', 'es', 'de'].includes(currentLang) ? currentLang : 'en';
        const task = SAFE_TASKS[Math.floor(Math.random() * SAFE_TASKS.length)][langKey];
        
        return {
            id: 'safe_' + Date.now(),
            name: task.name,
            name_ru: task.name, 
            name_es: task.name,
            name_de: task.name,
            desc_en: task.desc,
            desc_ru: task.desc,
            desc_es: task.desc,
            desc_de: task.desc,
            tags: task.tags || ["Relax", "Safe"], // Теги для пузырьков
            isPanicItem: true
        };
    }

    function closePanicSettings(e, force) {
        if (force || e.target.id === 'modal-panic-settings') {
            document.getElementById('modal-panic-settings').classList.remove('open');
        }
    }

    function togglePanicSetting(isChecked) {
        isPanicEnabled = isChecked;
        localStorage.setItem('xch_panic_enabled', isChecked);
    }

    // --- ЛОГИКА ПЕРЕКЛЮЧЕНИЯ ---

    function togglePanicMode() {
        if (!isPanicEnabled && !isPanicMode) return;

        if (!isPanicMode) {
            savedSettingsState.themeId = localStorage.getItem('xch_theme_id') || 'dark';
        }

        isPanicMode = !isPanicMode;
        
        const t = langData[currentLang] || langData['en'];
        
        // Элементы
        const logoTextDivs = document.querySelectorAll('.logo');
        const decoIcons = document.querySelectorAll('.deco-icon');
        const subtitles = document.querySelectorAll('.subtitle');
        const startBtnContainer = document.getElementById('start-btn-container');
        
        // Элементы карточки
        const reel = document.getElementById('slot-reel');
        const descEl = document.getElementById('result-desc');
        const badgeWrap = document.getElementById('badge-wrapper');
        const relatedBlock = document.getElementById('related-block');
        const startOverlay = document.getElementById('mode-start-overlay');
        const statusEl = document.getElementById('status-text');

        const uiToHide = [
            document.getElementById('tinder-controls'),
            document.getElementById('mods-block'),
            document.getElementById('card-notch')
        ];

        if (isPanicMode) {
            // === 🚨 ВХОД В ПАНИКУ ===
            console.log("⚠️ PANIC MODE ACTIVATED");

            // 1. Сохраняем состояние
            prePanicSnapshot = {
                currentItem: currentItem, // Сохраняем настоящий предмет!
                titleHTML: reel.innerHTML,
                descText: descEl.innerText,
                descDisplay: descEl.style.display,
                badgeHTML: badgeWrap.innerHTML,
                wasStartScreen: !startOverlay.classList.contains('hidden'),
                relatedDisplay: relatedBlock ? relatedBlock.style.display : 'none',
                cardClasses: document.getElementById('card-block').className,
                wasStartBtnVisible: startBtnContainer && !startBtnContainer.classList.contains('hidden-initial') && startBtnContainer.style.display !== 'none',
                oldStatusText: statusEl ? statusEl.innerText : '',
                oldStatusColor: statusEl ? statusEl.style.color : ''
            };

            // 2. Тема и Декор
            const isLight = document.body.classList.contains('light-theme');
            applyTheme(isLight ? 'green-light' : 'green-dark');
            decoIcons.forEach(el => el.style.display = 'none');

            // 3. Логотип
            logoTextDivs.forEach(div => {
                div.innerHTML = `<img src="funny_icon.png" class="logo-img" alt="F" style="height:45px; margin-right:5px;">FunnyHub`;
            });
            subtitles.forEach(el => el.innerText = t.safe_subtitle || "Your safe place");

            // 4. Скрываем "опасный" UI
            startOverlay.classList.add('hidden');
            startOverlay.style.display = 'none';
            
            uiToHide.forEach(el => {
                if(el) {
                    el.classList.add('panic-hidden-temp');
                    el.style.display = 'none';
                }
            });
            badgeWrap.innerHTML = '';

            // 5. ПОДМЕНА КАРТОЧКИ И ОБЪЕКТА
            const safeItem = getSafeItem();
            currentItem = safeItem; // <-- ВАЖНО: Подменяем глобальный предмет

            reel.innerHTML = `<div class="slot-item" style="font-size: 32px; font-weight: 800; color: var(--text-main);">${safeItem.name}</div>`;
            if(descEl) {
                descEl.style.display = 'block';
                descEl.innerText = safeItem.desc_en; // или соответствующий язык из safeItem
                descEl.style.color = "var(--text-secondary)";
            }
            
            const card = document.getElementById('card-block');
            if(card) card.className = 'card has-results';

            // 6. ОТРИСОВКА БЕЗОПАСНЫХ "ПОХОЖИХ"
            // Теперь renderRelatedItems увидит safeItem.tags (Кухня, Уборка)
            if (relatedBlock) {
                relatedBlock.style.display = 'flex'; // Показываем блок
                renderRelatedItems(); // Перерисовываем теги
            }

            // 7. Фраза сверху
            if (statusEl) {
                const safePhrases = t.panic_active_phrases || ["Nothing suspicious here 😇"];
                statusEl.innerText = safePhrases[Math.floor(Math.random() * safePhrases.length)];
                statusEl.style.color = "var(--text-secondary)";
                statusEl.style.opacity = "1";
            }

            // 8. Кнопка выхода
            if (startBtnContainer) {
                startBtnContainer.classList.remove('hidden-initial');
                startBtnContainer.style.display = 'flex';
                startBtnContainer.innerHTML = `
                    <button class="btn-start-capsule" onclick="togglePanicMode()" style="background: linear-gradient(to right, #2ecc71, #27ae60); box-shadow: 0 10px 40px -5px #2ecc71;">
                        <span style="font-size:20px; margin-right:8px;">🧘</span>
                        <span>${t.safe_btn_start || "Start Hobby"}</span>
                    </button>
                `;
            }

            updateSafeSettings(true);

        } else {
            // === ✅ ВЫХОД ИЗ ПАНИКИ ===
            console.log("✅ PANIC MODE DEACTIVATED");

            const themeToRestore = savedSettingsState.themeId || 'dark';
            applyTheme(themeToRestore);
            
            if (subscriptionLevel === 'free' && APP_THEMES.find(th => th.id === themeToRestore)?.type === 'pro') {
                applyTheme('dark');
            }

            decoIcons.forEach(el => el.style.display = '');
            const iconSrc = getThemeLogoSrc(themeToRestore);
            logoTextDivs.forEach(div => {
                div.innerHTML = `<img src="${iconSrc}" alt="X" class="logo-img">x<span>Fetish</span>Hub`;
            });
            subtitles.forEach(el => el.innerText = t.subtitle);

            if (prePanicSnapshot) {
                // ВОЗВРАЩАЕМ НАСТОЯЩИЙ ПРЕДМЕТ
                currentItem = prePanicSnapshot.currentItem;

                // Восстановление контента
                reel.innerHTML = prePanicSnapshot.titleHTML;
                if(descEl) {
                    descEl.innerText = prePanicSnapshot.descText;
                    descEl.style.display = prePanicSnapshot.descDisplay;
                }
                if(badgeWrap) badgeWrap.innerHTML = prePanicSnapshot.badgeHTML;
                
                const card = document.getElementById('card-block');
                if(card) card.className = prePanicSnapshot.cardClasses;

                document.querySelectorAll('.panic-hidden-temp').forEach(el => {
                    el.classList.remove('panic-hidden-temp');
                    el.style.display = '';
                });

                // Восстанавливаем блок "Похожее"
                if(relatedBlock) {
                    relatedBlock.style.display = prePanicSnapshot.relatedDisplay;
                    // Если блок был видим, нужно перерисовать НАСТОЯЩИЕ похожие
                    if (prePanicSnapshot.relatedDisplay !== 'none' && currentItem) {
                        renderRelatedItems();
                    }
                }

                // Восстановление кнопки
                if (startBtnContainer) {
                    startBtnContainer.innerHTML = `
                        <button class="btn-start-capsule" onclick="startNewSession()">
                            🔥 <span data-key="btn_start">${t.btn_start}</span>
                        </button>
                    `;
                    if (!prePanicSnapshot.wasStartBtnVisible && !prePanicSnapshot.wasStartScreen) {
                        startBtnContainer.style.display = 'none';
                        startBtnContainer.classList.add('hidden-initial');
                    } else if (prePanicSnapshot.wasStartScreen) {
                        startBtnContainer.style.display = 'none';
                        startBtnContainer.classList.add('hidden-initial');
                    } else {
                        startBtnContainer.style.display = 'flex';
                        startBtnContainer.classList.remove('hidden-initial');
                    }
                }

                // Восстановление экранов
                if (prePanicSnapshot.wasStartScreen) {
                    startOverlay.classList.remove('hidden');
                    startOverlay.style.display = 'flex';
                    const controls = document.getElementById('tinder-controls');
                    if(controls) controls.style.display = 'none';
                    const mods = document.getElementById('mods-block');
                    if(mods) mods.style.display = 'none';
                    randomizeModeGreeting();
                } else {
                    startOverlay.classList.add('hidden');
                    startOverlay.style.display = 'none';
                    updateCardStatusVisuals();
                }

                // Восстановление фразы
                if (statusEl) {
                    const phrases = t.post_panic_phrases || ["That was close..."];
                    statusEl.innerText = phrases[Math.floor(Math.random() * phrases.length)];
                    statusEl.style.color = "var(--text-secondary)";
                    
                    if (!prePanicSnapshot.wasStartScreen) {
                        setTimeout(() => {
                            if (!isPanicMode) {
                                statusEl.style.transition = "opacity 0.3s";
                                statusEl.style.opacity = "0";
                                setTimeout(() => {
                                    statusEl.innerText = prePanicSnapshot.oldStatusText;
                                    statusEl.style.color = prePanicSnapshot.oldStatusColor;
                                    statusEl.style.opacity = "1";
                                }, 300);
                            }
                        }, 1500);
                    }
                }
            }

            updateSafeSettings(false);
        }
    }

    function generatePanicCard(direction = 'next') {
        // Эта функция вызывается при клике на теги "Похожее" внутри паники
        
        // 1. Генерируем новый безопасный объект
        const safeItem = getSafeItem();
        currentItem = safeItem;

        // 2. Мгновенно обновляем UI
        const reel = document.getElementById('slot-reel');
        const descEl = document.getElementById('result-desc');
        
        reel.innerHTML = `<div class="slot-item" style="font-size: 32px; font-weight: 800; color: var(--text-main);">${safeItem.name}</div>`;
        if(descEl) {
            descEl.innerText = safeItem.desc_en; 
            if (currentLang === 'ru') descEl.innerText = safeItem.desc_ru;
            else if (currentLang === 'es') descEl.innerText = safeItem.desc_es;
            else if (currentLang === 'de') descEl.innerText = safeItem.desc_de;
        }

        // 3. Обновляем теги внизу
        renderRelatedItems();
        
        // 4. Вибрация (для ощущения смены)
        if(navigator.vibrate) navigator.vibrate(10);
    }

    // Сохранение режима двойного нажатия
    function togglePanicDouble(isChecked) {
        panicDouble = isChecked;
        localStorage.setItem('xch_panic_is_double', isChecked);
    }

    // Старт записи клавиши
    function startKeyRecording() {
        const box = document.getElementById('panic-key-box');
        const label = document.getElementById('panic-key-label');
        const display = document.getElementById('panic-key-display');
        
        isRecordingKey = true;
        box.classList.add('recording');
        
        const txtWaiting = currentLang === 'ru' ? "Нажми любую клавишу..." : "Press any key...";
        label.innerText = txtWaiting;
        display.style.opacity = '0.5';
    }

    // Сохранение клавиши
    function savePanicKey(code) {
        // Запрещенные клавиши (чтобы не сломать навигацию)
        if (code === 'Enter') return; 

        panicKey = code;
        localStorage.setItem('xch_panic_key', code);
        isRecordingKey = false;

        // Обновляем UI
        const box = document.getElementById('panic-key-box');
        const label = document.getElementById('panic-key-label');
        const display = document.getElementById('panic-key-display');
        const desc = document.getElementById('panic-pc-desc');

        if(box) {
            box.classList.remove('recording');
            label.innerText = currentLang === 'ru' ? "Нажми, чтобы изменить" : "Click to change";
            
            const displayCode = code === ' ' ? 'Space' : code.replace('Key', '').replace('Digit', '').toUpperCase();
            display.innerText = displayCode;
            display.style.opacity = '1';

            // Обновляем текст описания сверху
            if(desc) {
                desc.innerHTML = currentLang === 'ru' 
                ? `Вход/Выход: Нажатие клавиши <b>${displayCode}</b>.<br>Выход также кнопкой <b>Начать</b>.`
                : `Toggle: Press <b>${displayCode}</b>.<br>Exit also via <b>Start</b> button.`;
            }
        }
    }

    // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

    // A. Клавиатура (Двойной ESC)
    document.addEventListener('keydown', (e) => {
        
        // 1. Если идет запись клавиши в настройках
        if (isRecordingKey) {
            e.preventDefault();
            e.stopPropagation();
            let code = e.code;
            savePanicKey(code);
            return;
        }

        // 2. Закрытие модалок по ESC (стандартное поведение)
        if (e.code === 'Escape') {
            const openModals = document.querySelectorAll('.modal-overlay.open');
            if (openModals.length > 0) {
                openModals.forEach(modal => modal.classList.remove('open'));
                return; // Если закрыли окно, панику не трогаем (если только ESC не назначен на панику)
            }
        }

        // 3. Игнорируем ввод текста
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // 4. ПРОВЕРКА КЛАВИШИ ПАНИКИ
        // Сравниваем e.code с сохраненным panicKey
        if (e.code === panicKey) {
            
            // Если включен режим двойного нажатия
            if (panicDouble) {
                const now = new Date().getTime();
                if (now - lastEscTime < 400) {
                    e.preventDefault(); 
                    togglePanicMode();
                    lastEscTime = 0; 
                } else {
                    lastEscTime = now;
                }
            } 
            // Если одиночное нажатие
            else {
                e.preventDefault();
                togglePanicMode();
            }
        }
    });

    // B. Двойной Тап по карточке (для мобильных)
    document.addEventListener('touchend', (e) => {
        const now = new Date().getTime();
        const timeDiff = now - lastTapTime;

        // 1. Находим саму карточку
        const card = document.getElementById('card-block');

        // 2. ПРОВЕРКА: Если клик НЕ внутри карточки -> выходим
        if (!card || !card.contains(e.target)) {
            // Если тапнули мимо карточки, просто обновляем время (чтобы не сработало, 
            // если первый тап был по карте, а второй мимо)
            lastTapTime = 0; 
            return;
        }

        // 3. Игнорируем интерактивные элементы ВНУТРИ карточки
        if (e.target.closest('button') || 
            e.target.closest('.t-circle-btn') || 
            e.target.closest('.related-item-btn') ||
            e.target.closest('.btn-start-capsule') ||
            e.target.closest('.mode-circle-btn')) {
            lastTapTime = 0;
            return;
        }

        // 4. Логика активации (Двойной тап < 400мс)
        if (timeDiff < 400 && timeDiff > 0) {
            e.preventDefault(); // Предотвращаем зум или выделение
            togglePanicMode();
            lastTapTime = 0; // Сброс
        } else {
            lastTapTime = now;
        }
    });

    function openTipsModal() {
        renderTipsList();
        // Показываем список, скрываем детали
        document.getElementById('tips-view-list').style.display = 'block';
        document.getElementById('tips-view-detail').style.display = 'none';
        
        document.getElementById('modal-tips-overlay').classList.add('open');
    }

    function closeTipsModal(e, force) {
        if (force || e.target.id === 'modal-tips-overlay') {
            document.getElementById('modal-tips-overlay').classList.remove('open');
        }
    }

    function openSpecificTip(id) {
        // 1. Открываем саму модалку (чтобы инициализировать список)
        openTipsModal();
        
        // 2. Ищем нужный тип в базе
        const tip = tipsData.find(t => t.id === id);
        if (tip) {
            // 3. Сразу показываем детали
            showTipDetail(tip);
        }
    }

    function renderTipsList() {
        const viewList = document.getElementById('tips-view-list');
        const t = langData[currentLang] || langData['en'];
        
        // Заголовок окна
        let html = `
            <div class="tips-guru-text" data-key="tips_guru_title" style="margin-bottom:20px;">
                ${t.tips_guru_title || "Become a Guru 😈"}
            </div>
        `;

        const generateRow = (catKey, titleKey) => {
            const title = t[titleKey];
            const ids = TIPS_CATS[catKey];
            
            // Получаем объекты
            let items = ids.map(id => tipsData.find(x => x.id === id)).filter(Boolean);
            if (items.length === 0) return '';

            // 1. Сортировка: Непрочитанные -> Прочитанные
            items.sort((a, b) => {
                const aViewed = viewedTips.includes(a.id);
                const bViewed = viewedTips.includes(b.id);
                return aViewed - bViewed;
            });

            // 2. Генерация HTML (БЕЗ ДУБЛИРОВАНИЯ)
            const cardsHTML = items.map(tip => {
                const isViewed = viewedTips.includes(tip.id);
                return `
                    <div class="tip-card ${isViewed ? 'viewed' : ''}" onclick="openSpecificTip('${tip.id}')">
                        <div class="tip-card-header" style="background: ${tip.gradient};"></div>
                        <div class="tip-card-body">
                            <div class="tip-card-icon">${tip.icon}</div>
                            <div class="tip-card-title">${t[tip.titleKey]}</div>
                            <div class="tip-card-desc">${t[tip.descKey]}</div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="tips-category-title" style="text-align:left; padding-left:20px; margin-bottom:10px;">${title}</div>
                <div class="tips-scroll-row" id="scroll-row-${catKey}">
                    ${cardsHTML}
                </div>
            `;
        };

        html += generateRow('tech', 'cat_tips_tech');
        html += generateRow('info', 'cat_tips_info');

        viewList.innerHTML = html;
        
    }

    function initInfiniteRoulette(containerId) {
        return; 
    }

    function showTipDetail(tip) {
        const t = langData[currentLang] || langData['en'];
        
        if (!viewedTips.includes(tip.id)) {
            viewedTips.push(tip.id);
            localStorage.setItem('xch_viewed_tips', JSON.stringify(viewedTips));
            
            // Скрываем вопросики сразу же
            checkTipIcons();
        }
        
        document.getElementById('tip-detail-icon').innerText = tip.icon;
        document.getElementById('tip-detail-title').innerText = t[tip.titleKey];
        document.getElementById('tip-detail-content').innerHTML = t[tip.textKey];

        document.getElementById('tips-view-list').style.display = 'none';
        document.getElementById('tips-view-detail').style.display = 'block';
    }

    function backToTipsList() {
        document.getElementById('tips-view-detail').style.display = 'none';
        document.getElementById('tips-view-list').style.display = 'block';
        
        renderTipsList();
    }

    function openChangelogModal() {
        const container = document.getElementById('changelog-container');
        container.innerHTML = '';
        
        // Определяем текущий язык
        const langKey = ['en','ru','es','de'].includes(currentLang) ? currentLang : 'en';

        CHANGELOG_DATA.forEach(item => {
            // Берем текст
            const text = item.changes[langKey] || item.changes['en'];

            const div = document.createElement('div');
            div.className = 'version-card';
            
            div.innerHTML = `
                <!-- СЛЕВА: Версия -->
                <div class="v-ver-badge">v${item.ver}</div>
                
                <!-- ЦЕНТР: Текст -->
                <div class="v-content">${text}</div>
                
                <!-- СПРАВА: Дата -->
                <div class="v-date">${item.date}</div>
            `;
            container.appendChild(div);
        });

        document.getElementById('modal-changelog-overlay').classList.add('open');
    }

    function closeChangelogModal(e, force) {
        if (force || e.target.id === 'modal-changelog-overlay') {
            document.getElementById('modal-changelog-overlay').classList.remove('open');
        }
    }

    function checkTipIcons() {
        // 1. Иконка Интенсивности
        const intIcon = document.getElementById('intensity-info-icon');
        if (intIcon) {
            intIcon.style.display = viewedTips.includes('intensity') ? 'none' : 'block';
        }

        // 2. Иконка Режимов
        const modeIcon = document.getElementById('tip-icon-modes');
        if (modeIcon) {
            modeIcon.style.display = viewedTips.includes('modes') ? 'none' : 'block';
        }

        // 3. Иконка Уведомлений 
        const notifyIcon = document.getElementById('tip-icon-notifications');
        if (notifyIcon) {
            notifyIcon.style.display = viewedTips.includes('missing_wrapped') ? 'none' : 'block';
        }
    }

    function closePromoTips() {
        document.getElementById('modal-promo-tips-overlay').classList.remove('open');
    }

    function openTipsFromPromo() {
        // 1. Закрываем окно промо
        document.getElementById('modal-promo-tips-overlay').classList.remove('open');
        
        // 2. Через мгновение открываем Базу Знаний (Tips)
        setTimeout(() => {
            openTipsModal();
        }, 250);
    }

    function checkWrappedAlert() {
        if (sessionStorage.getItem('xch_wrapped_alert_shown')) return;

        const isPaid = subscriptionLevel !== 'free';
        const now = new Date();
        let targetWrapped = null;

        // 1. Приоритет: есть ли в архиве что-то, что пользователь еще не видел?
        const unread = wrappedArchive.filter(w => !w.viewed).sort((a,b) => b.timestamp - a.timestamp);
        
        if (unread.length > 0) {
            targetWrapped = unread[0];
        } 
        // 2. Иначе: проверяем, можно ли сгенерировать отчет за ВЧЕРА (для платных) или за неделю (для всех)
        else if (activeDaysSet.size >= 7 || (isPaid && !hasDailyForYesterday())) {
            const period = (activeDaysSet.size >= 7) ? 'weekly' : 'daily';
            targetWrapped = generateAndSaveWrapped(period);
            
            if (targetWrapped && period === 'weekly') {
                activeDaysSet.clear();
                activeDaysSet.add(now.toISOString().split('T')[0]);
                localStorage.setItem('xch_active_days', JSON.stringify([...activeDaysSet]));
            }
        }

        if (targetWrapped) {
            showWrappedAlertModal(targetWrapped);
            sessionStorage.setItem('xch_wrapped_alert_shown', 'true');
        }
    }

    // Хелпер: был ли сегодня дейли?
    function hasDailyForYesterday() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const dateKey = yesterday.toDateString(); // Например: "Fri Jan 30 2026"
        
        // Ищем в архиве отчет типа daily, который привязан к этой дате
        return wrappedArchive.some(w => w.type === 'daily' && w.targetDate === dateKey);
    }

    function getDayWord(days, lang) {
        if (lang === 'ru') {
            let lastDigit = days % 10;
            let lastTwoDigits = days % 100;
            if (lastTwoDigits >= 11 && lastTwoDigits <= 19) return "дней";
            if (lastDigit === 1) return "день";
            if (lastDigit >= 2 && lastDigit <= 4) return "дня";
            return "дней";
        }
        if (lang === 'es') return days === 1 ? "día" : "días";
        if (lang === 'de') return days === 1 ? "Tag" : "Tagen";
        return days === 1 ? "day" : "days"; // EN
    }

    function showWrappedAlertModal(wrappedObj) {
        const badges = WRAPPED_CONFIG.badges[currentLang] || WRAPPED_CONFIG.badges['en'];
        const periodName = badges[wrappedObj.type] || wrappedObj.type;

        const titles = {
            en: "Fetish Wrapped",
            ru: "Итоги фетишей",
            es: "Resumen Fetichista",
            de: "Fetisch Rückblick"
        };

        const descs = {
            en: `Your ${periodName} summary is ready! Tap to view.`,
            ru: `Твой отчет за ${periodName} готов! Нажми, чтобы посмотреть.`,
            es: `¡Tu resumen de ${periodName} está listo! Toca para ver.`,
            de: `Dein ${periodName} Rückblick ist bereit! Ansehen.`
        };

        showPushNotification({
            title: titles[currentLang] || titles.en,
            desc: descs[currentLang] || descs.en,
            icon: "🎁",
            onClick: () => {
                openWrappedUI(wrappedObj);
            }
        });
    }

    function closeWrappedAlert() {
        const activeToast = document.querySelector('.toast-push');
        if (activeToast) removeToast(activeToast);
    }

    async function fetchActiveDiscount() {
        try {
            const res = await fetch(`${API_BASE_URL}/api/active-discount`);
            const json = await res.json();
            if (json.active) {
                activeDiscount = json;
                console.log("🔥 Active Discount:", activeDiscount);
                // Проверяем лояльность после загрузки скидки
                checkLoyaltyStatus(); 
            }
        } catch (e) {
            console.error("Discount fetch error", e);
        }
    }

    // Запустить при старте
    window.addEventListener('load', fetchActiveDiscount);

    // --- АДМИНСКИЕ ФУНКЦИИ ---
    async function adminSetDiscount() {
        const target = document.getElementById('admin-disc-target').value;
        const type = document.getElementById('admin-disc-type').value;
        const value = document.getElementById('admin-disc-value').value;
        const days = document.getElementById('admin-disc-days').value;

        if(!value) return alert("Enter value");

        // Вызываем бэкенд
        try {
            const user = window.auth.currentUser;
            if (!user) return alert("Login first");

            const res = await fetch(`${API_BASE_URL}/admin/set-discount`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    uid: user.uid,
                    planTarget: target,
                    type: type,
                    value: value,
                    days: days
                })
            });
            
            if(res.ok) {
                alert("Discount Activated! Reload page to see.");
                location.reload();
            } else {
                alert("Error");
            }
        } catch(e) { console.error(e); }
    }

    async function adminRemoveDiscount() {
        const user = window.auth.currentUser;
        if (!user) return;
        await fetch(`${API_BASE_URL}/admin/remove-discount`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: user.uid })
        });
        alert("Removed");
        location.reload();
    }

    function checkSubscriptionExpiry() {
        // 1. Базовые проверки
        if (!cachedUserProfile || !cachedUserProfile.subscription || cachedUserProfile.subscription === 'free') return;
        if (cachedUserProfile.subscription === 'bestie') return; // Bestie навсегда
        if (!cachedUserProfile.expiresAt) return;

        const now = new Date();
        // Конвертируем дату из любого формата (Firestore Timestamp или строка ISO)
        const expDate = cachedUserProfile.expiresAt.toDate ? cachedUserProfile.expiresAt.toDate() : new Date(cachedUserProfile.expiresAt);
        
        // 2. ПРОВЕРКА: Если время вышло прямо сейчас
        if (now > expDate) {
            console.log("💳 Subscription just expired. Reverting to free mode.");
            
            subscriptionLevel = 'free';
            localStorage.setItem('xch_sub_level', 'free');
            
            // Обновляем UI
            if (typeof updateSubscriptionUI === 'function') updateSubscriptionUI();
            
            // Опционально: уведомляем пользователя
            alert(currentLang === 'ru' ? "Срок действия вашей подписки истек." : "Your subscription has expired.");
            return;
        }

        // 3. ПРЕДУПРЕЖДЕНИЕ: Если осталось 3 дня или меньше
        const diffMs = expDate - now;
        const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

        if (daysLeft <= 3 && daysLeft > 0) {
            const lastShown = localStorage.getItem('xch_expiry_warn_ts');
            const oneDayMs = 24 * 60 * 60 * 1000;

            // Показываем модалку не чаще раза в сутки
            if (!lastShown || (now.getTime() - parseInt(lastShown) > oneDayMs)) {
                openExpiryModal(daysLeft);
            }
        }
    }

    function openExpiryModal(days) {
        const t = langData[currentLang] || langData['en'];
        const dayWord = getDayWord(days, currentLang);

        const titles = {
            en: "Subscription",
            ru: "Подписка",
            es: "Suscripción",
            de: "Abonnement"
        };

        const descs = {
            en: `Expires in ${days} ${dayWord}. Tap to renew.`,
            ru: `Истекает через ${days} ${dayWord}. Нажми для продления.`,
            es: `Expira en ${days} ${dayWord}. Toca para renovar.`,
            de: `Läuft in ${days} ${dayWord} ab. Zum Verlängern tippen.`
        };

        showPushNotification({
            title: titles[currentLang] || titles.en,
            desc: descs[currentLang] || descs.en,
            icon: "⏳",
            onClick: () => {
                openSubModal();
            }
        });

        localStorage.setItem('xch_expiry_warn_ts', Date.now());
    }

    function closeExpiryModal() {
        const activeToast = document.querySelector('.toast-push');
        if (activeToast) removeToast(activeToast);
    }

    function renewFromExpiry() {
        closeExpiryModal();
        // Открываем стандартное окно подписки (где есть кнопка Extend/Upgrade)
        openSubModal();
    }

    // --- ЛОГИКА СВАЙПА ШТОРКИ ВНИЗ ---
    (function initSwipeToClose() {
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        let activeModal = null;
        let activeOverlay = null;

        // Порог закрытия: если протащили больше чем на 150px вниз
        const CLOSE_THRESHOLD = 150;

        document.addEventListener('touchstart', (e) => {
            const modal = e.target.closest('.modal');
            if (!modal || window.innerWidth > 768) return;

            const modalBody = modal.querySelector('.modal-body');
            const activeOverlay = modal.closest('.modal-overlay');
            const overlayId = activeOverlay ? activeOverlay.id : null;

            // Список окон, где горизонтальный скролл конфликтует со свайпом вниз
            const horizontalConflictModals = ['modal-stats-overlay', 'modal-tips-overlay'];
            
            const isHeader = e.target.closest('.modal-header');
            const isAtTop = modalBody ? modalBody.scrollTop <= 0 : true;

            let canStartDrag = false;

            if (horizontalConflictModals.includes(overlayId)) {
                // В этих окнах разрешаем свайп ТОЛЬКО за хедер
                if (isHeader) canStartDrag = true;
            } else {
                // В остальных окнах (история, аккаунт и т.д.) разрешаем всё
                if (isHeader || isAtTop) canStartDrag = true;
            }

            if (canStartDrag) {
                activeModal = modal;
                this.activeOverlay = activeOverlay; // Сохраняем ссылку для touchmove
                startY = e.touches[0].clientY;
                currentY = startY;
                isDragging = true;
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging || !activeModal) return;

            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;

            // Тянем только вниз
            if (deltaY > 0) {
                // Блокируем стандартный скролл страницы браузера
                if (e.cancelable) e.preventDefault();
                
                // Добавляем класс, чтобы убрать transition (мгновенный отклик)
                activeModal.classList.add('swiping');
                
                // Двигаем шторку вниз за пальцем
                activeModal.style.transform = `translateY(${deltaY}px)`;
                
                // Визуально осветляем фон оверлея при утягивании шторки
                const opacityProgress = Math.max(0, 1 - (deltaY / 400));
                activeOverlay.style.backgroundColor = `rgba(0, 0, 0, ${0.6 * opacityProgress})`;
            }
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (!isDragging || !activeModal) return;

            isDragging = false;
            activeModal.classList.remove('swiping'); // Возвращаем плавность через CSS
            
            const deltaY = currentY - startY;

            if (deltaY > CLOSE_THRESHOLD) {
                // === ЗАКРЫВАЕМ ===
                // Вызываем соответствующие функции закрытия в зависимости от ID оверлея
                const overlayId = activeOverlay.id;
                
                if (overlayId === 'modal-history-overlay') closeHistoryModal(null, true);
                else if (overlayId === 'modal-stats-overlay') closeStats(null, true);
                else if (overlayId === 'modal-sub-overlay') closeSubModal(null, true);
                else if (overlayId === 'modal-overlay') closeList(null, true);
                else if (overlayId === 'modal-blacklist-overlay') closeBlacklist(null, true);
                else if (overlayId === 'modal-theme-overlay') closeThemeModal(null, true);
                else if (overlayId === 'modal-mods-overlay') closeModifiersSettings(null, true);
                else if (overlayId === 'modal-explored-overlay') closeExploredModal(null, true);
                else if (overlayId === 'modal-achievements-overlay') closeAchievementsModal(null, true);
                else {
                    // Фолбек, если специфичной функции нет
                    activeOverlay.classList.remove('open');
                    document.body.classList.remove('modal-open');
                }

                // Очищаем стили после закрытия (чтобы при следующем открытии шторка была на месте)
                setTimeout(() => {
                    activeModal.style.transform = '';
                    activeOverlay.style.backgroundColor = '';
                }, 300);
            } else {
                // === ВОЗВРАЩАЕМ НА МЕСТО ===
                // Благодаря тому, что мы убрали класс .swiping, это произойдет плавно
                activeModal.style.transform = 'translateY(0)';
                activeOverlay.style.backgroundColor = '';
            }

            activeModal = null;
            activeOverlay = null;
        });
    })();

    // Управление точкой (бейджем) на иконке
    async function updateAppBadge() {
        if (!('setAppBadge' in navigator)) return;

        try {
            const isPaid = subscriptionLevel !== 'free';
            let badgeCount = 0;

            // 1. Проверка Wrapped
            const unreadWrapped = wrappedArchive.filter(w => !w.viewed).length;
            if (unreadWrapped > 0) badgeCount++;

            // 2. Проверка готовности нового Wrapped (если старые прочитаны)
            if (unreadWrapped === 0) {
                if (activeDaysSet.size >= 7 || (isPaid && !hasDailyForYesterday())) {
                    badgeCount++;
                }
            }

            // 3. Проверка подписки (если осталось меньше 3 дней)
            if (cachedUserProfile && cachedUserProfile.expiresAt) {
                const now = new Date();
                const expDate = cachedUserProfile.expiresAt.toDate ? cachedUserProfile.expiresAt.toDate() : new Date(cachedUserProfile.expiresAt);
                const diffDays = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 3 && diffDays > 0) {
                    badgeCount++;
                }
            }

            // Применяем бейдж
            if (badgeCount > 0) {
                await navigator.setAppBadge(badgeCount);
            } else {
                await navigator.clearAppBadge();
            }
        } catch (error) {
            console.error('Ошибка установки бейджа:', error);
        }
    }

    function showPushNotification(options) {
        const isMobile = window.innerWidth <= 768;
        const activeTab = document.querySelector('.tab-content.active')?.id;
        
        // На мобильных показываем ТОЛЬКО во вкладке аккаунта
        if (isMobile && activeTab !== 'tab-account') {
            return;
        }

        const container = document.getElementById('notification-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'toast-push toast-animate-in';
        
        toast.innerHTML = `
            <div class="toast-push-icon">${options.icon || '🔔'}</div>
            <div class="toast-push-content">
                <div class="toast-push-title">${options.title}</div>
                <div class="toast-push-desc">${options.desc}</div>
            </div>
        `;

        toast.onclick = () => {
            if (options.onClick) options.onClick();
            removeToast(toast);
        };

        container.appendChild(toast);

        // Удаление через 3.5 сек
        setTimeout(() => removeToast(toast), 3500);
    }

    function removeToast(toast) {
        if (!toast) return;
        toast.classList.remove('toast-animate-in'); 
        toast.classList.add('toast-animate-out');  
        
        setTimeout(() => {
            if (toast && toast.parentNode) {
                toast.remove();
            }
        }, 400); 
    }

    // === PWA PRIVACY PROTECTION ===
    (function() {
        const privacyScreen = document.getElementById('pwa-privacy-screen');
        
        // Функция показа (мгновенная)
        const showPrivacy = () => {
            privacyScreen.classList.add('active');
            // Принудительная перерисовка для iOS, чтобы он успел захватить кадр
            void privacyScreen.offsetWidth; 
        };

        // Функция скрытия (с задержкой для плавности)
        const hidePrivacy = () => {
            setTimeout(() => {
                privacyScreen.classList.remove('active');
            }, 100); // 100мс задержка, чтобы не моргало при возврате
        };

        // 1. VISIBILITY CHANGE (Стандарт для Android/PC)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                showPrivacy();
            } else {
                hidePrivacy();
            }
        });

        // 2. PAGEHIDE (Для старых iOS)
        window.addEventListener('pagehide', showPrivacy);

        // 3. BLUR & FOCUS (Критично для iOS App Switcher)
        window.addEventListener('blur', () => {
            // Проверяем, не является ли это просто кликом по iframe или инпуту
            if (document.activeElement && (document.activeElement.tagName === 'IFRAME' || document.activeElement.tagName === 'INPUT')) {
                return;
            }
            showPrivacy();
        });

        window.addEventListener('focus', hidePrivacy);

        // 4. FREEZE (Для жизненного цикла iOS PWA)
        document.addEventListener('freeze', showPrivacy);
        document.addEventListener('resume', hidePrivacy);

    })();

</script>

<!-- SEO CONTEXT BLOCK -->
<div class="seo-context">
    <h2>xFetishHub: The Ultimate Adult Preference Ecosystem</h2>
    <p>
        xFetishHub is not just a randomizer; it is your personal <strong>adult preference tracker</strong> and discovery platform. 
        Unlike simple tube sites, we provide a smart environment where you can <strong>analyze your sexual tastes</strong> through detailed charts and statistics.
    </p>
    <h3>Why use xFetishHub?</h3>
    <ul>
        <li>
            <strong>Smart Discovery:</strong> Learn about new genres and fetishes you didn't know existed. Our database covers 1000+ tags from vanilla to niche.
        </li>
        <li>
            <strong>Taste Analytics:</strong> Track what you like and dislike. View your "Fetish Wrapped" and understand your own psychology better with visual graphs.
        </li>
        <li>
            <strong>Private Browser Experience:</strong> On mobile devices, xFetishHub acts as a <strong>secure browser</strong>. Watch content from xHamster, Pornhub, and xVideos directly within our app without cluttering your main browser history.
        </li>
        <li>
            <strong>Personalized Feed:</strong> The more you use it, the better it gets. Our algorithm learns from your swipes to recommend content that truly matches your interests.
        </li>
    </ul>
    <p>
        Whether you are looking for a <strong>porn history tracker</strong>, a safe way to explore new kinks, or simply a better way to browse adult content, xFetishHub is your private home for digital intimacy.
    </p>
</div>

<!-- PRIVACY SCREEN FOR MULTITASKING -->
<div id="pwa-privacy-screen">
    <img src="logo.png" style="width: 80px; height: auto; margin-bottom: 20px;">
    <div style="font-weight: 800; font-size: 24px; color: var(--text-main); text-transform: uppercase;">
        xFetishHub
    </div>
    <div style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">
        Locked
    </div>
</div>

</body>
</html>
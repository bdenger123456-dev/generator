<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Primary Meta Tags -->
    <title>xFetishHub — Discover, Analyze & Watch. Your Private Adult Guide.</title>
    <meta name="title" content="xFetishHub — Discover, Analyze & Watch. Your Private Adult Guide.">
    
    <!-- Описание -->
    <meta name="description" content="More than a generator. Your intelligent home for adult preferences. Analyze your tastes with charts, discover 1000+ genres, and watch videos securely via the built-in private browser.">
    
    <!-- Ключевые слова -->
    <meta name="keywords" content="adult preference analyzer, porn tracker, fetish statistics, private porn browser, sex taste analysis, porn discovery, fetish encyclopedia, smart porn guide, xxx recommendation engine, porn roulette, fetishhub, safe adult browsing">
    
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="language" content="English">
    <meta name="author" content="xFetishHub">
    <meta name="rating" content="adult">
    <meta name="age-rating" content="18">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.xfetishhub.site/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.xfetishhub.site/">
    <meta property="og:title" content="xFetishHub — Your Intelligent Adult Guide">
    <meta property="og:description" content="Analyze your tastes, track history, and discover new desires in a secure, private environment.">
    <meta property="og:image" content="https://www.xfetishhub.site/og-image.jpg">
    <meta property="og:site_name" content="xFetishHub">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.xfetishhub.site/">
    <meta property="twitter:title" content="xFetishHub — Discover Your Desires">
    <meta property="twitter:description" content="The all-in-one platform for adult discovery, statistics, and private viewing.">
    <meta property="twitter:image" content="https://www.xfetishhub.site/og-image.jpg">

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FetishHub">
    <meta name="theme-color" content="#050505">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- SCHEMA.ORG: Позиционируем как ПРИЛОЖЕНИЕ (SoftwareApplication), а не просто веб-страницу -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "xFetishHub",
      "url": "https://www.xfetishhub.site/",
      "description": "An intelligent platform for tracking adult preferences, analyzing sexual statistics, and discovering new content categories securely.",
      "applicationCategory": "LifestyleApplication",
      "operatingSystem": "Web, iOS, Android",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": "Preference Analytics, Private Browser, Content Discovery, Fetish Tracker"
    }
    </script>
    
    <style>
        /* =========================================
        1. VARIABLES & RESET & THEMES
        ========================================= */
        :root {
            --bg-color: #050505;
            --sidebar-bg: #101010;
            --card-bg: #141414;
            --nav-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-secondary: #888888;
            --accent: #9b59b6; 
            --accent-light: #b07cc6;
            --border: #2a2a2a;
            --highlight-green: #2ecc71;
            --highlight-red: #e74c3c;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --modal-bg: rgba(0, 0, 0, 0.9);
            
            /* iOS Style Colors */
            --ios-bg: #000000;
            --ios-card: #1C1C1E;
            --ios-separator: #38383A;
            --ios-header: #8E8E93;

            --card-gradient: linear-gradient(165deg, #2a2a2a 0%, #141414 100%);
        }

        body.light-theme {
            --bg-color: #f2f2f7;
            --sidebar-bg: #f2f2f7; 
            --card-bg: #ffffff;
            --nav-bg: #f9f9f9;
            --text-main: #000000;
            --text-secondary: #666666;
            --border: #d1d1d6;
            --modal-bg: rgba(255, 255, 255, 0.95);
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-separator: #C6C6C8;
            --ios-header: #6D6D72;

            --card-gradient: linear-gradient(165deg, #ffffff 0%, #f2f2f7 100%);
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden; /* Скролл только внутри контейнеров */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        button, select, input { font-family: inherit; outline: none; }
        a { text-decoration: none; color: inherit; }

        /* === CUSTOMIZATION === */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 колонки */
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-item {
            background: var(--ios-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            overflow: hidden;
        }

        .theme-item.active {
            border-color: var(--accent);
            background: var(--nav-bg);
        }
        
        .theme-item.locked {
            opacity: 0.6;
        }

        /* Квадраты предпросмотра */
        .theme-preview-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(128,128,128,0.2);
            position: relative;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Кружок цвета внутри квадрата */
        .theme-preview-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .theme-info {
            display: flex;
            flex-direction: column;
        }
        
        .theme-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .theme-type {
            font-size: 10px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .lock-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        /* =========================================
        2. MAIN LAYOUT (Sidebar & Content)
        ========================================= */
        .app-layout { display: flex; height: 100%; width: 100%; }

        .sidebar {
            width: 340px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }

        .main-content {
            flex: 1;
            position: relative;
            height: 100%;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch; 
            padding: 20px 15px;
            padding-bottom: 120px;
            padding-top: 110px; /* Место под хедер на мобильных */
            width: 100%;
            box-sizing: border-box;
        }

        .tab-content.active { display: flex; }

        .center-wrapper {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 auto;
        }

        /* =========================================
        3. HEADERS, LOGO & MASKS
        ========================================= */
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 0;
            letter-spacing: -1px;
            cursor: pointer;
            line-height: 1;
        }
        .logo span { 
            /* Градиент: Сверху #CB53F0, Снизу цвет темы */
            background: linear-gradient(180deg, #CB53F0 20%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            
            margin-right: 1px; 
                
            position: relative;
            z-index: 1;
        }

        .logo-img {
            height: 56px;
            width: auto;
            display: block;
            object-fit: contain;
            transform: translateY(-8px);
        }

        body.tab-home-active .mobile-header .subtitle {
            display: none !important; /* Скрываем подзаголовок */
        }

        body.tab-home-active .mobile-header {
            min-width: auto;
            width: auto;
            padding: 8px 20px;
            border-radius: 50px;
            min-height: 50px; 
        }

        body.tab-home-active .mobile-header .logo {
            font-size: 22px;
            margin: 0;
        }

        body.tab-home-active .mobile-header .logo-img {
            height: 35px;
            transform: translateY(0);
        }

        body.tab-home-active #tab-home {
            padding-top: 80px !important; 
        }
        
        .subtitle {
            font-size: 11px; 
            color: var(--text-secondary); 
            text-transform: uppercase;
            letter-spacing: 1px; 
            text-align: center; 
            
            margin-top: -5px !important;   /* Тянем вверх к логотипу */
            margin-bottom: 25px !important; /* Отступ снизу до меню */
            
            font-weight: 600; 
            opacity: 0.7; 
            max-width: 240px; 
            margin-left: auto; /* Центрирование */
            margin-right: auto;
            line-height: 1.4;
        }

        /* Градиентные маски для скролла */
        .top-gradient-mask {
            display: none;
            position: fixed; top: -50px; left: 0; width: 100%; height: 160px;
            z-index: 9000; pointer-events: none;
            background: linear-gradient(to bottom, var(--bg-color) 40%, transparent 100%);
        }
        .bottom-gradient-mask {
            display: none; 
            position: fixed; bottom: -50px; left: 0; width: 100%; height: 160px;
            z-index: 9000; pointer-events: none;
            background: linear-gradient(to top, var(--bg-color) 40%, transparent 100%);
        }

        /* =========================================
        4. GENERATOR CARD & SLOT MACHINE
        ========================================= */
        .animation-text-box { text-align: center; min-height: 20px; margin-bottom: 5px; width: 100%; }
        .animation-text { font-size: 14px; font-weight: 700; color: var(--accent); text-transform: uppercase; opacity: 0; transition: opacity 0.2s; }
        .animation-text.visible { opacity: 1; }

        .status-text-combined {
            /* Позиционирование НАД карточкой */
            position: absolute;
            bottom: 100%; /* Приклеиваем к верху контейнера */
            left: 0;
            width: 100%;
            margin-bottom: 15px; /* Отступ от карточки */
            z-index: 25; /* Поверх декораций */
            
            /* Стили текста */
            text-align: center; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 16px; 
            font-weight: 700; 
            color: var(--text-main);
            text-transform: uppercase; 
            letter-spacing: 1px;
            line-height: 1.3; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            
            transform-origin: 50% 400px; /* Примерно центр низа карточки */
            will-change: transform;
            pointer-events: none; /* Чтобы текст не мешал свайпать */
        }

        .card {
            position: relative; 
            display: flex !important;
            flex-direction: column !important;
            justify-content: space-between !important; 
            
            width: 100%;
            min-height: 60vh; 
            height: auto;
            
            background: var(--card-gradient);
            border: 1px solid var(--border);
            border-radius: 28px;
            overflow: hidden; 
            padding: 0 !important; 
            
            transition: transform 0.1s linear; 
            z-index: 5;
        }

        body.light-theme .card {
            background: var(--card-gradient);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .card.has-results {
            min-height: inherit !important;
            height: auto !important;
            padding-top: 15px !important; 
            padding-bottom: 15px !important;
            justify-content: flex-start !important;
            gap: 5px; 
        }

        @keyframes flyInSmooth {
            0% { 
                transform: translateX(100px) scale(0.9); /* Слегка справа и меньше */
                opacity: 0; 
                filter: blur(10px);
            }
            100% { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
                filter: blur(0);
            }
        }

        .anim-slow-enter {
            /* 0.8s - медленнее и плавнее, чем обычный свайп */
            animation: flyInSmooth 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }
        
        /* Slot Window */
        .slot-window {
            width: 100%;
            /* На мобильных высота авто, чтобы не занимать лишнее место */
            height: auto !important; 
            min-height: 100px;
            
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            
            /* Маска для красивого исчезновения текста */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
        }

        /* На совсем маленьких экранах (iPhone SE и т.д.) чуть уменьшаем */
        @media (max-height: 650px) {
            .slot-window {
                height: 180px !important;
            }
        }

        .card.has-results .slot-window {
            height: auto !important;
            margin: 0 !important;
            overflow: visible !important;
            -webkit-mask-image: none !important;
            mask-image: none !important;
        }

        .slot-reel {
            display: flex; flex-direction: column; align-items: center;
            transform: translateY(0); width: 100%;
            will-change: transform;
        }

        .slot-item {
            height: auto !important; 
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            padding: 0 10px;
            font-size: clamp(32px, 8vw, 60px) !important;
            font-weight: 800;
            color: var(--text-main);
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .card.has-results .slot-item {
            height: auto !important;
            padding: 0 10px !important;
            margin-bottom: 5px;
            font-size: clamp(28px, 6vw, 42px) !important;
            
            display: block !important; 
            text-align: center !important;
            white-space: normal !important; 
            line-height: 1.2 !important;
        }

        .slot-item span {
            font-weight: 600;
            margin-left: 6px; 
            display: inline; 
        }

        .card > div:last-child {
            z-index: 20; 
            flex: 0 0 auto; 
            width: 100%;
            padding-bottom: 20px;
            margin-top: auto; 
            background: transparent; 
        }

        
        /* Animations & Effects */
        .slot-item.shrunk { transform: scale(0.8); opacity: 0.7; }
        .slot-item.zoomed { transform: scale(1.2); color: var(--accent); text-shadow: 0 0 20px rgba(255, 153, 0, 0.4); }
        
        .card.flash-active { background-color: #fff !important; border-color: #fff !important; transform: scale(1.02); }
        
        .result-description { 
            font-size: 19px !important; 
            font-weight: 500 !important;
            color: var(--text-secondary) !important;
            line-height: 1.5 !important;
            max-width: 90%; 
            margin: 0 auto; 
            text-align: center;
            opacity: 0.2;
        }
        .result-description.fade-visible:not(:empty) { display: block; }

        /* Idle Animation */
        @keyframes scrollIdle { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
        .slot-reel.idle { animation: scrollIdle 60s linear infinite; filter: blur(5px); opacity: 0.6; }
        .slot-reel.spinning { filter: blur(0); opacity: 1; }

        /* === АНИМАЦИИ FLY IN === */
        
        /* Карточка вылетает СЛЕВА (для "Другое" / Свайп влево / Вернуться) */
        @keyframes flyInLeft {
            0% { 
                transform: translateX(-150%) rotate(-15deg); /* Чуть дальше вылет */
                opacity: 0; 
                filter: blur(20px); /* Сильный блюр в начале */
            }
            50% {
                opacity: 1;
                filter: blur(10px); /* Блюр в середине */
            }
            100% { 
                transform: translateX(0) rotate(0); 
                opacity: 1; 
                filter: blur(0); /* Четкость в конце */
            }
        }

        /* Карточка вылетает СПРАВА (для "Похожее" / Свайп вправо) */
        @keyframes flyInRight {
            0% { 
                transform: translateX(150%) rotate(15deg); 
                opacity: 0; 
                filter: blur(20px); 
            }
            50% {
                opacity: 1;
                filter: blur(10px);
            }
            100% { 
                transform: translateX(0) rotate(0); 
                opacity: 1; 
                filter: blur(0); 
            }
        }

        /* Классы для JS */
        .anim-fly-left {
            animation: flyInLeft 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }

        .anim-fly-right {
            animation: flyInRight 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards !important;
        }

        /* =========================================
        5. BUTTONS & CONTROLS
        ========================================= */
        .btn-gen, .btn-watch, .related-item-btn, .btn-action { border-radius: 22px; outline: none; border: none; cursor: pointer; }
        
        .gen-controls { display: flex; gap: 10px; width: 100%; margin-bottom: 15px; transition: opacity 0.3s; }
        .btn-gen { flex: 1; padding: 22px; background: var(--text-main); color: var(--bg-color); font-size: 18px; font-weight: 900; text-transform: uppercase; box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .btn-gen.secondary { background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border); font-size: 16px; flex: 0.8; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .btn-watch { flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 15px; text-transform: uppercase; background: var(--accent); color: #000; }

        .card-actions { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-action { 
            flex: 1; padding: 15px; border-radius: 18px; border: 1px solid var(--border); 
            background: transparent; color: var(--text-secondary); font-size: 24px;
            font-weight: 700; transition: all 0.2s; max-width: 80px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-action.ban:hover, .btn-action.ban.active { border-color: var(--highlight-red); background: rgba(231, 76, 60, 0.15); color: var(--highlight-red); transform: scale(1.05); }
        .btn-action.fav:hover, .btn-action.fav.active { border-color: var(--highlight-green); background: rgba(46, 204, 113, 0.15); color: var(--highlight-green); transform: scale(1.05); }

        /* Кнопка "Смотреть позже" (Квадратная рядом с Watch) */
        .btn-watch-later {
            width: 54px; /* Фиксированная ширина = высоте */
            flex-shrink: 0;
            border-radius: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-watch-later:active {
            transform: scale(0.95);
        }

        /* Активное состояние кнопки (когда добавлено) - Синий цвет */
        .btn-watch-later.active {
            background: #3498db; /* Синий */
            color: #ffffff;
            border-color: #3498db;
        }

        /* Стиль тега в списке "Смотреть позже" (Синий) */
        .catalog-item.wl-active { 
            background: rgba(52, 152, 219, 0.2); 
            color: #3498db; 
            border: 1px solid #3498db; 
        }

        /* Related & Tags */
        .related-section { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 35px !important;
            margin-bottom: 20px; 
            text-align: center; 
        }
        .related-tags {
            display: flex;
            flex-wrap: wrap;       /* Разрешаем перенос на следующую строку */
            justify-content: center; /* Центрируем теги */
            gap: 10px;             /* Расстояние между тегами */
            width: 100%;
        }
        .related-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; opacity: 0.8; }
        .related-item-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; color: var(--text-main); transition: 0.2s; }

        /* Utility */
        .visually-hidden { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .fade-hidden { opacity: 0; transform: translateY(10px); transition: opacity 0.5s ease, transform 0.5s ease; display: none; }
        .fade-visible { opacity: 1; transform: translateY(0); display: flex; }

        /* =========================================
        6. IOS SETTINGS & COMPONENTS
        ========================================= */
        .ios-group {
            background: var(--ios-card); border-radius: 22px; overflow: hidden; margin-bottom: 20px; width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .ios-header {
            margin: 25px 0 8px 20px; font-size: 13px; color: var(--ios-header);
            text-transform: uppercase; display: flex; justify-content: space-between;
        }
        .ios-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; background: var(--ios-card); min-height: 48px; position: relative;
        }
        .ios-row:not(:last-child)::after {
            content: ""; 
            position: absolute; 
            bottom: 0; 
            left: 16px; 
            right: 16px;
            height: 1px;
            background-color: var(--ios-separator); 
            transform: scaleY(0.5);
        }
        .ios-row.clickable { cursor: pointer; transition: background 0.2s; }
        .ios-row.clickable:active { background: var(--nav-bg); }
        
        .capsule-btn {
            background: var(--ios-card); border-radius: 22px; padding: 5px 20px;
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            min-height: 55px; cursor: pointer; transition: transform 0.2s, background 0.2s; border: none;
        }
        .capsule-btn:active { transform: scale(0.98); background: var(--nav-bg); }
        .capsule-btn span { font-weight: 600; font-size: 16px; color: var(--text-main); }
        .capsule-btn select { font-weight: 700; color: var(--accent) !important; font-size: 17px; background: transparent; border: none; text-align: right; appearance: none; -webkit-appearance: none; }

        .platform-select, .ios-row select {
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
            border: none;
            font-size: 16px;
            color: var(--text-secondary);
            text-align: right;
            direction: rtl;
            padding-right: 0;
            font-weight: 400;
            cursor: pointer;
            font-family: inherit;
        }

        /* Account Elements */
        .sync-date { font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 10px; margin-bottom: 20px; opacity: 0.6; }
        
        /* Switches & Sliders */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; margin: 0 5px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .range-slider { width: 100%; cursor: pointer; }
        .intensity-labels { display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px; }
        .intensity-label { font-size: 12px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; }
        .intensity-label.active { color: var(--accent); font-weight: 700; }

        /* Accordion */
        .accordion { background: transparent !important; }
        .accordion-head { padding: 16px !important; font-size: 17px !important; color: var(--text-main) !important; display: flex; justify-content: space-between; }
        .accordion-body { display: none; padding: 0 16px 16px; flex-wrap: wrap; gap: 8px; }
        .accordion-body.open { display: flex; }
        
        /* Tags */
        .capsule-accordion-head { background: var(--card-bg); border: 1px solid var(--border); border-radius: 50px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; width: auto; max-width: 200px; margin: 0 auto 15px auto; cursor: pointer; font-size: 13px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; }

        /* =========================================
        7. MOBILE BOTTOM NAV
        ========================================= */
        .bottom-nav {
            display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px; height: 65px;
            background: var(--ios-card); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px;
            z-index: 9999; padding: 0 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            justify-content: space-between;
        }
        body.light-theme .bottom-nav { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--text-secondary); flex: 1; cursor: pointer; transition: all 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active .nav-icon { transform: translateY(-2px); color: var(--accent); }
        .nav-icon { font-size: 22px; margin-bottom: 2px; transition: transform 0.2s; }

        /* =========================================
        8. MODALS (GENERAL)
        ========================================= */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--modal-bg); z-index: 20000 !important; /* Above everything */
            display: none; justify-content: center; align-items: center; 
        }
        .modal-overlay.open { display: flex; }
        .modal { 
            background: var(--sidebar-bg); width: 90%; max-width: 500px; max-height: 80%; 
            border-radius: 20px; border: 1px solid var(--border); 
            display: flex; flex-direction: column; overflow: hidden; 
        }
        .modal-header { 
            padding: 20px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; font-weight: 800; font-size: 18px; 
        }
        .modal-body { 
            padding: 10px; overflow-y: auto; 
        }

        #sub-status-btn {
            background: var(--card-bg); 
            border: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }

        /* Catalog Search */
        .modal-search-box { width: 100%; margin-bottom: 15px; position: relative; }
        .modal-search-input { width: 100%; background: var(--ios-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; font-size: 16px; color: var(--text-main); }
        .modal-suggestions { display: none; flex-direction: column; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; margin-top: 5px; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .suggestion-row { padding: 10px 15px; border-bottom: 1px solid var(--border); font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; }
        
        .catalog-item { padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: default; display: inline-flex; align-items: center; gap: 8px; margin: 3px; }
        .catalog-item.active { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
        .catalog-item.ban-active { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
        .catalog-remove-btn { cursor: pointer; opacity: 0.6; padding: 0 4px; }

        /* =========================================
        9. STATS & CHARTS
        ========================================= */
        .axis-label-y { position: absolute; left: -15px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 10px; color: var(--text-secondary); }
        .axis-label-x-title { position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-secondary); }
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 250px; width: 100%; border-bottom: 1px solid var(--border); border-left: 1px solid var(--border); position: relative; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; flex: 1; height: 100%; position: relative; }
        .chart-bar.secondary { background: var(--text-secondary); margin-right: 2px; }
        .bar-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 2px; height: 100%; }
        .chart-value-y { position: absolute; top: -20px; font-size: 10px; font-weight: 700; color: var(--text-main); }

        .stats-tf-capsule, .stats-nav-capsule { background: var(--ios-card); border: 1px solid var(--border); border-radius: 50px; display: flex; padding: 3px; width: 100%; }
        .stats-tf-capsule { height: 36px; margin-bottom: 8px; }
        .stats-nav-capsule { height: 50px; }
        .stats-tf-item, .stats-nav-item { flex: 1; display: flex; align-items: center; justify-content: center; border-radius: 40px; font-size: 11px; font-weight: 700; color: var(--text-secondary); cursor: pointer; text-transform: uppercase; }
        .stats-tf-item.active, .stats-nav-item.active { background: var(--nav-bg); color: var(--text-main); }

        /* =========================================
        10. SUBSCRIPTION MODAL (RESPONSIVE)
        ========================================= */
        .plan-card {
            background: var(--ios-card); border: 1px solid var(--border); border-radius: 20px;
            padding: 20px; margin-bottom: 15px; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .plan-card.pro { border-color: #ff9900; box-shadow: 0 0 20px rgba(255, 153, 0, 0.1); }
        .plan-card.beast { border-color: #9b59b6; background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), transparent); box-shadow: 0 0 20px rgba(155, 89, 182, 0.15); }
        
        .plan-title { font-size: 22px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; }
        .plan-card.pro .plan-title { color: #ff9900; }
        .plan-card.beast .plan-title { color: #9b59b6; }
        .plan-price { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 15px; }
        
        .plan-features { list-style: none; padding: 0; margin: 0 0 20px 0; }
        .plan-features li { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; padding-left: 20px; position: relative; }
        .plan-features li::before { content: "•"; position: absolute; left: 0; color: var(--text-main); }
        
        .plan-btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; text-transform: uppercase; font-size: 14px; margin-top: auto; }
        .plan-btn.current { background: var(--nav-bg); color: var(--text-secondary); opacity: 0.7; }
        .plan-btn.pro-btn { background: #ff9900; color: #000; box-shadow: 0 4px 15px rgba(255, 153, 0, 0.3); }
        .plan-btn.beast-btn { background: #9b59b6; color: #fff; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); }

        /* Mobile Default Layout for Plans */
        .plans-container { display: flex; flex-direction: column; gap: 15px; }
        #modal-sub-overlay .modal { width: 90%; max-width: 400px; max-height: 90vh; }

        /* =========================================
        11. Tinder Logic
        ========================================= */
        .tinder-actions {
            margin-top: auto; 
            padding-top: 10px;
            border-top: none;
            width: 100%;
            display: flex;
            gap: 10px;
        }

        .result-description {
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-secondary);
        }

        .related-section {
            margin-top: 5px !important;
            margin-bottom: 15px;
        }

        .btn-tinder {
            flex: 1;
            padding: 18px 10px;
            border-radius: 50px; /* Полностью круглые края */
            border: none;
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-tinder:active { transform: scale(0.95); }

        .btn-pass {
            background:transparent;
            border: 2px solid var(--highlight-red);
            color: var(--highlight-red);
        }
        
        .btn-like {
            background: var(--highlight-green) !important;
            color: #fff !important; /* Белый текст для контраста */
            border: 2px solid var(--highlight-green) !important;
        }

        .btn-like:active, .btn-like.active-state {
            background: rgba(46, 204, 113, 0.2) !important;
            color: var(--highlight-green) !important;
        }

        /* === 3. КНОПКА НАЗАД (UNDO) === */
        .undo-container {
            margin-top: 5px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .btn-undo {
            width: auto !important;
            height: auto !important;
            border-radius: 50px !important;
            padding: 8px 24px !important; 
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 13px !important;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-undo:active {
            background: var(--nav-bg);
            transform: scale(0.96);
        }

        /* === 4. СВАЙПЫ (Карточка) === */
        .card {
            position: relative; 
            overflow: hidden;
            touch-action: none; /* Важно для свайпов на мобильных */
            transform-origin: 50% 100%;
            will-change: transform, opacity;
            justify-content: space-between;
            margin-bottom: 10px !important; 
        }

        .card-reject {
            background: rgba(231, 76, 60, 0.9) !important; /* Красный */
            border-color: #c0392b !important;
            filter: blur(5px) grayscale(0.5); /* Блюр */
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.6) !important;
        }

        .card-like {
            background: rgba(46, 204, 113, 0.9) !important; /* Зеленый */
            border-color: #27ae60 !important;
            filter: blur(5px) grayscale(0.5); /* Блюр */
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6) !important;
        }

        /* --- 3. Начальная кнопка (Капсула внутри карточки) --- */
        #start-btn-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: auto;
            padding-bottom: 15px;
            
            flex-shrink: 0 !important; 
            min-height: 70px;
            
            position: relative;
            z-index: 30; 
        }

        .btn-start-capsule {
            /* Градиент темы: Слева светлее, Справа основной цвет */
            background: linear-gradient(to right, var(--accent-light), var(--accent));
            
            color: white; /* Текст всегда белый для контраста */
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 18px 40px;
            border-radius: 50px;
            border: none;
            
            /* Свечение (тень) в цвет темы */
            box-shadow: 0 10px 40px -5px var(--accent);
            
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            
            flex-shrink: 0; 
            z-index: 30;
        }

        .btn-start-capsule:active {
            transform: scale(0.95);
            /* Уменьшаем тень при нажатии */
            box-shadow: 0 5px 20px -5px var(--accent);
        }

        /* --- 4. Анимация "Вишенка на торте" (Staggered Fade Up) --- */
        @keyframes fadeInUpSmooth {
            from {
                opacity: 0;
                transform: translateY(20px);
                filter: blur(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }
        }

        /* Базовый класс для элементов, которые должны появляться плавно */
        .stagger-item {
            opacity: 0; /* Скрыты по умолчанию */
            animation: fadeInUpSmooth 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* Задержки (Очередь появления) */
        .delay-1 { animation-delay: 0.1s; } /* Заголовок (почти сразу после вспышки) */
        .delay-2 { animation-delay: 0.3s; } /* Описание */
        .delay-3 { animation-delay: 0.5s; } /* Похожие */
        .delay-4 { animation-delay: 0.7s; } /* Кнопки (Watch/Like) */
        .delay-5 { animation-delay: 1.0s; } /* Объяснение (Вишенка) */

        /* Фикс для заголовка (слота), чтобы он не конфликтовал со скриптом барабана */
        .slot-reel .slot-item.final-result {
            opacity: 0;
            animation: fadeInUpSmooth 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards 0.1s;
        }

        /* Активные состояния для новых кнопок */
        .btn-tinder.active-state {
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.3);
            transform: scale(0.98);
        }
        .btn-like.active-state { 
            background: #fff !important; 
            color: var(--accent) !important; 
            border-color: #fff !important;
        }
        .btn-pass.active-state { 
            background: var(--highlight-red) !important; 
            color: #fff !important; 
        }

        .restore-anim { animation: flyInLeft 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* 1. Скрываем старые кнопки по ID, а не по классу, чтобы не задеть кнопку старта */
        #btn-gen, #btn-similar { 
            display: none !important; 
        }

        /* 2. Принудительно показываем контейнер старта, если у него нет класса hidden-initial */
        #start-btn-container:not(.hidden-initial) {
            display: flex !important;
        }

        /* 3. Гарантируем, что новые кнопки будут Flex, когда мы уберем скрывающий класс */
        #main-actions:not(.hidden-initial) {
            display: flex !important;
        }

        .hidden-initial, .visually-hidden {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        #start-btn-container {
            transition: opacity 0.3s ease;
        }
        
        /* Адаптация под мобильные */
        @media (max-width: 768px) {
            
            /* 1. ГЛОБАЛЬНЫЕ СКРЫТИЯ */
            .sidebar, .tinder-actions, .btn-group, .undo-container, .badge-tooltip { display: none !important; }
            .mobile-header, .bottom-nav, .top-gradient-mask, .bottom-gradient-mask { display: flex !important; }
            .main-content { padding: 0 !important; }

            /* 2. КОНТЕЙНЕР */
            #tab-home .center-wrapper {
                height: 100vh !important;
                height: 100dvh !important;
                padding-top: 65px !important; 
                padding-bottom: 90px !important; 
                display: flex;
                flex-direction: column;
                justify-content: flex-start !important;
                overflow: hidden !important; 
                width: 100% !important;
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* 3. КАРТОЧКА */
            .card, .card.has-results {
                flex-grow: 1 !important;
                height: 100% !important;
                margin-bottom: 0 !important;
                width: 100% !important;
                padding: 10px 5px !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
                overflow: hidden !important;
            }

            /* === ВНУТРЕННИЕ БЛОКИ === */
            .card > div:nth-child(1) { flex: 0 0 auto !important; min-height: 25px !important; } /* Бейджи */
            
            /* ЦЕНТР */
            .card > div:nth-child(2) {
                flex: 1 1 auto !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-evenly !important; 
                align-items: center !important;
                overflow: hidden !important; 
                padding: 10px 0 !important;
            }

            .card > div:last-child { flex: 0 0 auto !important; margin-top: 5px !important; width: 100%; } /* Кнопки */

            /* --- ЭЛЕМЕНТЫ КОНТЕНТА --- */
            
            .slot-window {
                width: 100%;
                height: auto !important;
                flex: 0 1 auto !important;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .slot-item { 
                font-size: clamp(26px, 9vw, 48px) !important;
                line-height: 1.1 !important;
            }

            /* === ОПИСАНИЕ (УЛУЧШЕНО) === */
             #result-desc {
                max-height: none !important; 
                overflow-y: visible !important;
                
                flex-shrink: 0 !important; 
                
                font-size: 15px !important;
                line-height: 1.35 !important;
                margin: 10px 0 15px 0 !important;
                white-space: normal !important; 
                
                display: -webkit-box;
                -webkit-line-clamp: 6; /* Показать максимум 6 строк */
                -webkit-box-orient: vertical;
                overflow: hidden !important; 
            }
            
            /* === ПОХОЖИЕ (ТЕГИ) === */
            .related-section {
                margin-top: 0 !important; /* Отступ уже задан в margin-bottom описания */
                margin-bottom: 5px !important;
                width: 100%;
                display: flex !important;
                flex-direction: column;
                align-items: center;
            }
            
            .related-tags { 
                display: flex !important;
                flex-wrap: nowrap !important; /* Запрещаем перенос строк */
                overflow-x: auto !important;  /* Разрешаем горизонтальный скролл */
                justify-content: flex-start !important; /* Выравнивание по началу */
                width: 100%;
                padding-bottom: 5px;
                gap: 6px !important;
                
                scrollbar-width: none; 
                -ms-overflow-style: none;
                
                mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
                -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            }
            .related-tags::-webkit-scrollbar { 
                display: none; 
            }
            
            .related-item-btn { 
                flex-shrink: 0 !important; /* Запрещаем кнопкам сжиматься */
                white-space: nowrap !important; 
                font-size: 12px; 
                padding: 8px 14px; 
            }

            /* --- КНОПКИ --- */
            .tinder-nav-row {
                gap: 8px !important; margin-bottom: 5px !important;
                justify-content: space-between !important; padding: 0 5px !important;
            }
            .t-circle-btn.small { width: 38px !important; height: 38px !important; font-size: 18px !important; }
            .t-circle-btn.medium { width: 50px !important; height: 50px !important; font-size: 24px !important; }
            .t-circle-btn.large { width: 64px !important; height: 64px !important; font-size: 28px !important; }

            #start-btn-container { min-height: 50px !important; }
            .btn-start-capsule { padding: 12px 30px !important; font-size: 16px !important; }

            #tab-settings .center-wrapper, #tab-account .center-wrapper { 
                padding: 40px 15px 120px 15px !important; height: auto !important; display: block !important;
            }
        }

        .capsule-trigger {
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px; /* Полная капсула */
            padding: 8px 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            margin: 0 auto; /* Центрируем кнопку */
        }
        
        .capsule-trigger:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.98);
        }

        body.light-theme .capsule-trigger {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        /* === 4. ИКОНКА ЧАСОВ === */
        .t-circle-btn.wl {
            font-size: 26px; 
            padding-top: 2px; 
        }

        /* =========================================
        12. OTHER COMPONENTS (Badges, History)
        ========================================= */

        .warning-badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; color: #fff; cursor: help; }
        .badge-extreme { background: var(--highlight-red); }
        .badge-lgbt { background: #9b59b6; }
        .badge-niche { background: #34495e; }
        .badge-wrapper { display: flex; justify-content: center; gap: 6px; margin-bottom: 2px; margin-top: 5px; width: 100%; position: relative; z-index: 5; }
        
        .badge-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            color: #fff; padding: 12px; border-radius: 14px; font-size: 13px; line-height: 1.4;
            width: 220px; text-align: left; pointer-events: none; opacity: 0; transition: opacity 0.2s;
            margin-bottom: 10px; border: 1px solid var(--border); z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .warning-badge:hover .badge-tooltip { opacity: 1; pointer-events: auto; }

        .history-item-ios {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--ios-card); font-size: 16px; color: var(--text-main);
            position: relative; cursor: pointer; transition: background 0.2s;
        }
        .history-item-ios:active { background: var(--nav-bg); }
        .history-item-ios:not(:last-child)::after {
            content: ""; 
            position: absolute; 
            bottom: 0; 
            left: 16px; 
            right: 16px;
            height: 1px;
            background-color: var(--ios-separator); 
            transform: scaleY(0.5);
        }

        /* Onboarding & Age Gate */
        .onb-tag { background: var(--accent); color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #age-gate .logo { font-size: 40px; margin-bottom: 20px; }
        #age-gate .logo-img { height: 70px; margin-right: 10px; }

        .mobile-header {
            display: none; position: fixed; top: calc(10px + env(safe-area-inset-top)); 
            left: 50%; transform: translateX(-50%); width: auto; min-width: 260px; max-width: 90%;
            background: var(--ios-card); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border); border-radius: 35px; z-index: 9999;
            padding: 12px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            flex-direction: column; align-items: center; justify-content: center;
        }
        body.light-theme .mobile-header { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.1); }
        .mobile-header .logo { font-size: 20px; margin-bottom: 0; }
        .mobile-header .logo-img { height: 40px; }

        body:not(.tab-home-active) .center-wrapper {
            padding-top: 85px !important;
            padding-bottom: 100px !important;
            display: block !important;
        }

        body:not(.tab-home-active) #mobile-mode-mount {
            display: none !important;
        }

        .mod-title {
            width: 100%;
            text-align: center;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        /* === 12. PREMIUM STATS === */
        .locked-feature {
            position: relative;
            opacity: 0.5;
            pointer-events: none;
            filter: blur(2px);
        }
        .lock-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            pointer-events: auto; /* Чтобы клик проходил на оверлей */
        }
        .lock-badge {
            background: var(--accent); color: #000;
            padding: 5px 10px; border-radius: 12px;
            font-weight: 800; font-size: 12px; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* === WRAPPED / SUMMARY UI (Spotify Style) === */
        .wrapped-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 25000; background: #000;
            display: none; flex-direction: column;
        }
        .wrapped-overlay.active { display: flex; animation: fadeIn 0.3s ease; }

        /* Динамические фоны для слайдов */
        .wrapped-slide {
            flex: 1; display: none; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 40px; text-align: center;
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
        }
        .wrapped-slide.active-slide { display: flex; }

        /* Градиенты для разных настроений */
        .bg-fire { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); }
        .bg-dark { background: linear-gradient(-45deg, #000000, #434343, #1a1a1a); }
        .bg-toxic { background: linear-gradient(-45deg, #11998e, #38ef7d, #000000); }
        .bg-passion { background: linear-gradient(-45deg, #8E2DE2, #4A00E0, #ff00cc); }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Элементы сводки */
        .wrapped-progress-container {
            position: absolute; top: 10px; left: 0; width: 100%;
            padding: 0 10px; display: flex; gap: 5px; z-index: 20;
        }
        .wrapped-progress-bar {
            height: 4px; flex: 1; background: rgba(255,255,255,0.3);
            border-radius: 2px; overflow: hidden;
        }
        .wrapped-progress-fill {
            height: 100%; background: #fff; width: 0%;
            transition: width 0.1s linear;
        }

        .wrapped-big-text {
            font-size: clamp(40px, 10vw, 80px);
            font-weight: 900; line-height: 1; margin-bottom: 20px;
            color: #fff; text-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }
        .wrapped-sub-text {
            font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.9);
            line-height: 1.5; max-width: 400px;
        }
        .wrapped-stat-box {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px;
            margin: 20px 0; border: 1px solid rgba(255,255,255,0.3);
        }
        .wrapped-highlight { color: #ffe600; font-weight: 800; }

        .wrapped-nav-area {
            position: absolute; top: 0; height: 100%; width: 30%; z-index: 10;
        }
        .nav-left { left: 0; }
        .nav-right { right: 0; }
        .wrapped-close {
            position: absolute; top: 20px; right: 20px;
            font-size: 24px; color: rgba(255,255,255,0.5); z-index: 30; cursor: pointer;
        }

        /* === STATS UPDATE === */
        /* Контейнер графика */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 180px; 
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        /* Скролл-контейнер для предпочтений */
        .chart-scroll-view {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            height: 100%;
            align-items: flex-end;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            padding-bottom: 5px; /* Отступ для скролла */
        }
        .chart-scroll-view::-webkit-scrollbar { display: none; }

        /* Колонка предпочтений (5 + немного 6-ая колонка) */
        .pref-col {
            min-width: 17%; 
            max-width: 17%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 0 4px; /* Чуть больше отступ между ними */
        }

        /* Колонка активности */
        .act-col {
            flex: 1; 
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            min-width: 30px; 
        }

        .act-bar-group {
            width: 100%;
            max-width: 50px; /* Максимальная ширина "толстых" столбиков */
            display: flex;
            align-items: flex-end;
            justify-content: center;
            height: 100%;
            gap: 4px; /* Зазор между серым и цветным столбиком */
        }

        /* Сами бары */
        .chart-bar {
            width: 100%; 
            background: var(--accent);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            min-height: 4px;
            position: relative;
        }

        /* Подписи под графиком */
        .chart-label-x {
            margin-top: 5px;
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* Цифры для активности (ПОД графиком) */
        .act-values {
            display: flex;
            gap: 5px;
            font-size: 9px;
            font-weight: 700;
            margin-top: 2px;
            color: var(--text-main);
        }

        /* === 13. PAYMENT MODAL STYLES === */
        .pay-desc {
            padding: 15px 20px 10px;
            color: var(--text-secondary);
            font-size: 13px;
            text-align: center;
            line-height: 1.4;
        }

        /* Секция промокода */
        .promo-container {
            margin: 10px 15px 20px 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .promo-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            margin-left: 5px;
        }

        .promo-input-group {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .promo-input {
            flex: 1;
            background: var(--ios-bg); /* Цвет фона как у страницы */
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            font-size: 15px;
            color: var(--text-main);
            outline: none;
            transition: border-color 0.2s;
        }

        .promo-input:focus {
            border-color: var(--accent);
        }

        .promo-btn {
            width: 44px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        .promo-btn:active {
            transform: scale(0.95);
        }

        /* === 14. LOGIN MODAL === */
        .auth-benefits {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .auth-benefits li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-main);
        }

        .auth-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--nav-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .auth-note {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 15px;
            line-height: 1.4;
            opacity: 0.7;
        }

        .btn-google {
            width: 100%;
            background: #FFFFFF;
            color: #1f1f1f;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 14px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-google:active { transform: scale(0.98); }

        /* 15. SYNC MODAL STYLES */
        .sync-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .sync-stat-item {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .sync-stat-val {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .sync-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Анимация вращения для кнопки синхронизации */
        @keyframes spinIcon { 100% { transform: rotate(360deg); } }
        .spinning-icon { animation: spinIcon 1s linear infinite; display: inline-block; }


        /* Fetish Wrapped */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .wrapped-lock-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px dashed var(--border);
        }
        .wrapped-lock-title {
            font-size: 16px; font-weight: 800; margin-bottom: 5px;
            background: linear-gradient(45deg, #FF9900, #9B59B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }
        .wrapped-lock-desc {
            font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;
        }
        .w-progress-track {
            height: 8px; width: 100%; background: rgba(255,255,255,0.1);
            border-radius: 4px; overflow: hidden; margin-bottom: 8px;
        }
        .w-progress-fill {
            height: 100%; background: linear-gradient(90deg, #FF9900, #9B59B6);
            width: 0%; transition: width 0.5s ease;
        }
        .w-progress-text {
            font-size: 11px; font-weight: 700; color: var(--text-main);
        }

        /* Финальная сводка (Summary Card) */
        .summary-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            padding: 25px;
            width: 90%;
            max-width: 340px;
            text-align: left;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            opacity: 0; 
            transform: translateY(20px);
            animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards 0.5s;
        }
        @keyframes slideUpFade {
            to { opacity: 1; transform: translateY(0); }
        }
        .sum-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px; margin-bottom: 5px;
        }
        .sum-logo { font-weight: 900; font-size: 18px; color: #fff; }
        .sum-date { font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; text-align: right; }
        .sum-row { display: flex; justify-content: space-between; align-items: center; }
        .sum-label { font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; font-weight: 600; }
        .sum-val { font-size: 18px; font-weight: 800; color: #fff; }
        .sum-big-val { font-size: 28px; font-weight: 900; color: #ffe600; text-shadow: 0 0 20px rgba(255, 230, 0, 0.3); }
        .sum-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .sum-tag { 
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); 
            padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #fff; font-weight: 600; 
        }

        /* === TINDER STYLE CONTROLS === */
        .tinder-nav-row {
            display: flex;
            align-items: center;
            justify-content: space-evenly;
            width: 100%;
            margin-top: auto;
            margin-bottom: 10px;
            gap: 15px; /* Чуть больше расстояние */
            padding: 0 5px;
        }

        .t-circle-btn {
            border: none; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: #fff !important; 
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
            
            /* Тонкая рамка для стиля */
            border: 1px solid rgba(255,255,255,0.1); 
        }

        .t-circle-btn:active {
            transform: scale(0.92);
            filter: brightness(0.9);
        }

        /* Размеры */
        .t-circle-btn.small { width: 44px; height: 44px; font-size: 20px; }
        .t-circle-btn.medium { width: 58px; height: 58px; font-size: 26px; }
        .t-circle-btn.large { width: 72px; height: 72px; font-size: 32px; }

        /* Цвета */
        .t-circle-btn.undo {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        /* 2. DISLIKE (Красный градиент) */
        .t-circle-btn.dislike {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4);
        }

        /* 3. WATCH (Цвет темы + Свечение) */
        .t-circle-btn.watch {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
            
            /* Мощное свечение */
            box-shadow: 0 0 20px var(--accent), 
                        0 0 40px var(--accent-light),
                        inset 0 0 10px rgba(255,255,255,0.5);
            
            animation: pulseGlow 2s infinite;
            z-index: 2; /* Чуть выше остальных */
            border: 1px solid rgba(255,255,255,0.3);
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 20px var(--accent); transform: scale(1); }
            50% { box-shadow: 0 0 35px var(--accent); transform: scale(1.05); }
            100% { box-shadow: 0 0 20px var(--accent); transform: scale(1); }
        }

        /* 4. LIKE (Зеленый градиент) */
        .t-circle-btn.like {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        /* 5. WATCH LATER (серый) */
        .t-circle-btn.wl {
            background: rgba(255, 255, 255, 0.15); /* Полупрозрачный серый */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary) !important;
            box-shadow: none; /* Без свечения */
            transition: all 0.2s ease;
        }

        /* При наведении или нажатии чуть светлее */
        .t-circle-btn.wl:active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* АКТИВНОЕ СОСТОЯНИЕ (Синий градиент) */
        .t-circle-btn.wl.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
            border-color: transparent !important;
            color: #ffffff !important;
            box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3);
        }

        body.light-theme .t-circle-btn.wl {
            background: rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.1);
            color: #666 !important;
        }
        body.light-theme .t-circle-btn.wl.active {
            color: #ffffff !important; 
        }

        /* Нажатие */
        .t-circle-btn:active {
            transform: scale(0.92) !important; /* Перебивает анимацию пульса */
            filter: brightness(1.1);
        }
        
        /* Disabled */
        .t-circle-btn:disabled {
            background: #bdc3c7; /* Серый */
            box-shadow: none;
            opacity: 0.7;
            cursor: default;
            transform: none !important;
        }

        /* Скрываем старые элементы, которые мы заменили */
        .tinder-actions, .btn-group, .undo-container {
            display: none !important;
        }
        
        /* Карточка должна быть Flex-колонкой для правильного размещения */
        .card {
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important;
            padding-bottom: 10px !important;
        }
        
        /* Адаптация описания, чтобы не прилипало */
        .result-description {
            margin-bottom: 20px;
        }

        /* ROADMAP STYLES */
        .roadmap-container {
            display: flex;
            flex-direction: column;
            gap: 0; /* Убираем gap, так как линия рисуется внутри элемента */
        }

        .roadmap-item {
            display: flex;
            gap: 15px;
            position: relative;
            /* Убираем нижний отступ у последнего, у остальных оставляем место для линии */
            padding-bottom: 20px;
        }

        .roadmap-item:last-child {
            padding-bottom: 0;
        }

        /* Колонка с иконкой и линией */
        .rm-visual-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px; /* Фиксированная ширина */
            flex-shrink: 0;
        }

        /* Иконка */
        .rm-icon-box {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.05);
            z-index: 2; /* Поверх линии */
            background: var(--card-bg); /* Чтобы не просвечивала */
        }

        /* Линия-соединитель */
        .rm-line {
            width: 2px;
            background: var(--border);
            flex-grow: 1; /* Растягивается на всю оставшуюся высоту */
            margin-top: 5px; /* Отступ от иконки */
            margin-bottom: -15px; /* Залезает на следующий элемент, соединяясь */
            min-height: 20px;
        }

        /* Контент */
        .rm-content {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            flex: 1;
            /* Центрирование контента относительно иконки */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .rm-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 5px;
        }

        .rm-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Кнопка-капсула с плюсом */
        .btn-capsule-plus {
            width: 60%; /* Ширина как у второстепенных кнопок */
            max-width: 200px;
            height: 44px;
            border-radius: 22px;
            background: transparent;
            border: 1px solid var(--border); /* Тонкая обводка */
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 auto;
            padding-bottom: 4px; /* Выравнивание плюса */
        }

        /* Активное состояние кнопки (когда открыто) */
        .btn-capsule-plus.active {
            background: var(--nav-bg);
            border-color: var(--accent);
            color: var(--accent);
            transform: scale(0.98);
        }

        /* Анимация иконки плюса */
        .btn-capsule-plus span {
            transition: transform 0.3s ease;
            display: block;
            line-height: 1;
        }

        /* Поворот плюса в крестик */
        .btn-capsule-plus.active span {
            transform: rotate(45deg);
        }

        /* Контейнер с модификаторами */
        #mod-container {
            width: 100%;
            max-height: 0; /* Высота 0 скрывает контент */
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s ease;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 0;
            padding: 0 10px; /* Немного отступа по бокам */
            visibility: hidden; /* Скрываем от кликов */
        }

        .mods-wrapper-expanded.open #mod-container {
            max-height: 500px; 
            opacity: 1;
            margin-top: 40px; 
            padding-bottom: 15px;
            visibility: visible;
        }

        /* Состояние "Открыто" */
        #mod-container.open {
            max-height: 300px; /* Достаточно для всех тегов */
            opacity: 1;
            margin-top: 15px;
            padding-bottom: 10px;
        }

        #mods-block {
            width: 100%;
            padding: 0 15px; 
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }


        .mods-wrapper-expanded {
            position: relative;
            width: 60px; 
            height: 44px; 
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            margin: 10px auto 0 auto;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 10;
        }

        /* Иконка (Плюс -> Крестик) */
        .mods-icon-plus {
            position: absolute;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 300;
            color: var(--text-secondary);
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            
            /* ЦЕНТР (Закрыто) */
            top: 50%;
            right: 50%;
            transform: translate(50%, -50%);
        }

        /* Контент тегов (Список) */
        .mods-content {
            opacity: 0;
            width: 100%;
            padding: 45px 15px 20px 15px; /* Сверху отступ под крестик */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            transform: translateY(20px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none; /* Чтобы не кликалось в закрытом */
            visibility: hidden; /* Скрываем полностью */
        }

        /* === СОСТОЯНИЕ OPEN (ОТКРЫТО) === */
        .mods-wrapper-expanded.open {
            width: 100% !important; 
            max-width: 100%; 
            height: auto;
            min-height: 160px;
            background: var(--ios-card);
            border-color: var(--accent);
            border-radius: 24px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            margin-top: 5px;
        }

        /* Крестик улетает в угол */
        .mods-wrapper-expanded.open .mods-icon-plus {
            color: var(--highlight-red);
            top: 15px;
            right: 15px;
            left: auto; 
            transform: rotate(45deg);
        }

        .mods-wrapper-expanded.open .mods-content {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }

        /* Обновленный стиль тегов */
        .tag {
            padding: 8px 14px;
            border-radius: 12px;
            background: var(--bg-color);
            border: 1px solid var(--border);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: 0.2s;
            cursor: pointer;
            user-select: none;
        }
        .tag:active {
            transform: scale(0.95);
        }
        .tag.selected {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* === RAINBOW THEME STYLES === */

        /* Анимированный градиент для фона карточки */
        body.rainbow-mode .card {
            background: linear-gradient(
                120deg, 
                #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000
            );
            background-size: 400% 400%;
            animation: rainbowMove 10s ease infinite;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
        }

        /* Затемняющая подложка внутри карточки, чтобы текст читался */
        body.rainbow-mode .card > div {
            z-index: 2;
        }
        /* Псевдо-элемент для затемнения фона карточки, но сохранения градиента */
        body.rainbow-mode .card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75); /* Темная вуаль */
            z-index: 1;
        }

        @keyframes rainbowMove {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }

        /* Цвет текста в радужной теме всегда белый для контраста */
        body.rainbow-mode .card, body.rainbow-mode .slot-item {
            color: #ffffff !important;
        }

        .swipe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            
            /* Лежит поверх всего контента */
            z-index: 50 !important; 
            
            /* Скругляем углы под карточку */
            border-radius: 28px;
            
            pointer-events: none; 
            opacity: 1 !important; /* Управляем цветом через RGBA, а не opacity */
            background-color: transparent; /* По умолчанию прозрачный */
            transition: background-color 0.1s linear;
        }

        /* Верхняя часть (Бейджи) */
        .card > div:nth-child(2) { 
            z-index: 15; 
            padding-top: 20px;
            flex: 0 0 auto; /* Не сжимать */
        }

        /* ЦЕНТРАЛЬНАЯ ЧАСТЬ (Слот + Описание) */
        .card > div:nth-child(3) {
            z-index: 15;
            flex: 1 1 auto; /* Резиновая: может сжиматься и расти */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Чтобы длинное описание не ломало верстку */
            padding: 0 15px;
        }

        #onb-input {
            flex-shrink: 0 !important; /* Запрещаем сжимать поле ввода */
        }
        
        #onb-tags-container {
            max-height: 25vh; /* Ограничиваем высоту списка тегов */
            overflow-y: auto; /* Добавляем прокрутку, если тегов много */
            padding: 5px;
        }
        
        /* Скрываем скроллбар для красоты */
        #onb-tags-container::-webkit-scrollbar { display: none; }

        .version-tag {
                font-size: 11px;
                font-weight: 500;
                
                /* Сброс градиента */
                background: none !important;
                -webkit-text-fill-color: var(--text-secondary) !important; 
                color: var(--text-secondary) !important;
                
                opacity: 0.5;
                margin-left: 6px;
                
                /* Выравнивание */
                position: relative;
                top: 5px; /* Сдвигаем вниз от центральной линии */
            }

        /* Общий стиль для иконок */
        .deco-icon {
            position: absolute;
            z-index: 20 !important; 
            pointer-events: none; /* Клики проходят сквозь них */
            will-change: transform;
            transition: filter 0.3s ease; /* Плавная смена цвета при смене темы */
        }

        /* --- 1. ТЁМНАЯ ТЕМА (По умолчанию) --- */
        /* Исходники черные -> инвертируем в белые + белая тень */
        .deco-icon {
            /* invert(1) делает черное белым */
            filter: invert(1) drop-shadow(0 0 10px rgba(255, 255, 255, 0.4));
            opacity: 0.9;
        }

        /* --- 2. СВЕТЛАЯ ТЕМА --- */
        /* Исходники черные -> оставляем черными (invert 0) + темная тень */
        body.light-theme .deco-icon {
            filter: invert(0) drop-shadow(0 5px 15px rgba(0, 0, 0, 0.15));
            opacity: 0.8; 
        }

        /* --- 3. РАДУЖНАЯ ТЕМА --- */
        /* Делаем белыми, чтобы выделялись на ярком фоне + сильная тень */
        body.rainbow-mode .deco-icon {
            filter: invert(1) drop-shadow(0 0 15px rgba(255, 255, 255, 0.9));
            opacity: 1;
        }

        /* АНИМАЦИИ ПАРЕНИЯ */
        @keyframes floatLeft {
            0% { transform: translate3d(0, 0, 0) rotate(-20deg) scale(1); }
            50% { transform: translate3d(-8px, -12px, 0) rotate(-15deg) scale(1.05); }
            100% { transform: translate3d(0, 0, 0) rotate(-20deg) scale(1); }
        }

        @keyframes floatRight {
            0% { transform: translate3d(0, 0, 0) rotate(15deg) scale(1); }
            50% { transform: translate3d(8px, -12px, 0) rotate(20deg) scale(1.05); }
            100% { transform: translate3d(0, 0, 0) rotate(15deg) scale(1); }
        }

        .icon-left {
            width: 140px;
            top: -40px; 
            left: -20px;
            animation: floatLeft 6s ease-in-out infinite;
        }

        .icon-right {
            width: 110px;
            top: -20px;
            right: -10px;
            animation: floatRight 7s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            /* МОБИЛЬНАЯ ВЕРСИЯ ИКОНОК */
            .icon-left {
                width: 75px !important;  /* Было 120px -> стало 75px */
                top: 5px !important;     /* Опустили ниже (было -30px) */
                left: -5px !important;   /* Прижали ближе к краю */
            }

            .icon-right {
                width: 60px !important;  /* Было 90px -> стало 60px */
                top: 15px !important;    /* Опустили ниже (было -20px) */
                right: 0px !important;   /* Прижали ближе к краю */
            }
        }

        body.no-deco .deco-icon {
            display: none !important;
        }

        /* === BESTIE PLAN STYLES === */
        .plan-card.bestie {
            border: 2px solid #00d2ff; /* Яркий голубой бордюр */
            background: linear-gradient(165deg, rgba(0, 210, 255, 0.1), rgba(58, 123, 213, 0.05));
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.15);
            order: -1; /* На мобильных ставим его первым, чтобы заметили */
        }

        @media (min-width: 769px) {
            .plan-card.bestie { order: 0; }
        }

        .plan-card.bestie .plan-title {
            background: linear-gradient(to right, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #00d2ff;
        }

        .bestie-badge {
            position: absolute;
            top: 0; right: 0;
            background: #00d2ff;
            color: #000;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-bottom-left-radius: 12px;
        }

        /* Стили для счетчика (Scarcity Bar) */
        .limit-container {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .limit-labels {
            display: flex; 
            justify-content: space-between; 
            font-size: 11px; 
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .limit-track {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .limit-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            width: 96%; /* 48 из 50 */
            box-shadow: 0 0 10px #00d2ff;
            animation: pulseBar 2s infinite;
        }

        @keyframes pulseBar {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .plan-btn.bestie-btn {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        }

        /* === NOTCH & BORDER STYLES === */

        /* Базовый стиль чёлки */
        .card-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); 
            
            /* Размеры и форма */
            padding: 8px 24px;
            border-radius: 0 0 22px 22px; 
            
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
            
            z-index: 40;
            
            /* Переменная для цвета фона (чтобы псевдо-элементы тоже красились) */
            --notch-bg: transparent; 
            background: var(--notch-bg);
            
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }

        /* Плавные переходы в рамку (уши) */
        .card-notch::before, .card-notch::after {
            content: '';
            position: absolute;
            top: 0;
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        /* Левое ухо */
        .card-notch::before {
            right: 100%; /* Прилегает слева */
            background: radial-gradient(circle at 0 100%, transparent 14px, var(--notch-bg) 14.5px);
        }

        /* Правое ухо */
        .card-notch::after {
            left: 100%; /* Прилегает справа */
            background: radial-gradient(circle at 100% 100%, transparent 14px, var(--notch-bg) 14.5px);
        }

        /* Класс для показа чёлки */
        .card-notch.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* --- ВАРИАНТ 1: WATCH LATER (Синий) --- */
        .card.status-wl {
            border: 2px solid #3498db !important;
            box-shadow: 0 0 25px rgba(52, 152, 219, 0.15) !important;
        }
        .card.status-wl .card-notch {
            background: #3498db;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        /* --- ВАРИАНТ 2: FAVORITE (Зеленый) --- */
        .card.status-fav {
            border: 2px solid #2ecc71 !important;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.15) !important;
        }
        .card.status-fav .card-notch {
            background: #2ecc71;
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
        }

        /* --- ВАРИАНТ 3: DISLIKED (Красный) - на случай просмотра истории --- */
        .card.status-ban {
            border: 2px solid #e74c3c !important;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.15) !important;
        }
        .card.status-ban .card-notch {
            background: #e74c3c;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }

        body.rainbow-mode .card.status-wl,
        body.rainbow-mode .card.status-fav,
        body.rainbow-mode .card.status-ban {
            animation: none !important;
            background: var(--card-gradient) !important; 
        }

        /* === 1. MODE CAPSULE (DROPDOWN STYLE) === */
        .mode-capsule-wrapper {
            position: relative;
            z-index: 100;
            display: none; /* Скрыто по умолчанию (пока нет 10 действий) */
        }

        /* Стиль самой кнопки-капсулы */
        .mode-capsule-btn {
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .mode-capsule-btn:active, .mode-capsule-wrapper.open .mode-capsule-btn {
            background: var(--nav-bg);
            color: var(--text-main);
            border-color: var(--accent);
        }

        /* Выпадающий список */
        .mode-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            width: 160px;
            background: var(--ios-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 6px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mode-capsule-wrapper.open .mode-dropdown {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(5px);
        }

        .mode-item {
            padding: 10px 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .mode-item:hover, .mode-item:active {
            background: var(--nav-bg);
            color: var(--text-main);
        }

        .mode-item.active {
            background: rgba(155, 89, 182, 0.1); /* Акцент */
            color: var(--accent);
        }

        /* === 2. START SCREEN (CARD OVERLAY) === */
        .mode-start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-gradient);
            z-index: 50; /* Перекрывает всё внутри карточки */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between !important;
            padding: 40px 20px 30px 20px !important;
            transition: opacity 0.3s;
        }

        .mode-start-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .mode-greeting-text {
            font-size: clamp(28px, 6vw, 42px) !important; 
            font-weight: 900 !important;
            line-height: 1.1 !important;
            text-align: center;
            color: var(--text-main);
            
            margin-top: auto; 
            margin-bottom: auto;
            max-width: 90%;
        }

        .mode-buttons-circle-row {
            display: flex;
            justify-content: center;
            gap: 25px;
            width: 100%;
            margin-top: auto; 
            margin-bottom: 10px;
        }

        .mode-circle-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            border: none !important;
            font-size: 32px;
            
            /* Тень и позиционирование */
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            color: #fff; /* Эмодзи всегда яркие */
            
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .mode-circle-btn:active {
            transform: scale(0.92);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Градиенты для кнопок */
        .mode-circle-btn.explore {
            /* Красный градиент */
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
        }

        .mode-circle-btn.pleasure {
            /* Зеленый градиент */
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.4);
        }

        /* === 3. РАСПОЛОЖЕНИЕ КАПСУЛЫ (PC vs MOBILE) === */

        /* По умолчанию (Mobile): Капсула под хедером */
        #mobile-mode-mount {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: -100px !important; 
            margin-bottom: 20px !important;
            position: relative;
            z-index: 60;
        }

        #pc-mode-mount {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 15px; 
            border-top: none !important;
            padding-top: 0 !important;
        }

        /* PC ВЕРСИЯ */
        @media (min-width: 769px) {
            #mobile-mode-mount {
                display: none !important; /* Скрываем мобильную версию */
            }

            #pc-mode-mount {
                display: flex;
                width: 100%;
                margin-top: auto; /* Прижимаем к низу сайдбара (или куда вам нужно) */
                padding-top: 20px;
                border-top: 1px solid var(--border);
            }
            
            /* Капсула на ПК растягивается или имеет свой стиль */
            #pc-mode-mount .mode-capsule-btn {
                width: auto; 
                min-width: 140px;
                justify-content: center;
            }
        }

        /* =========================================
        18. MEDIA QUERIES (ADAPTATION)
        ========================================= */

        @media (max-width: 768px) {
            #row-install-app {
                display: none !important;
            }
        }

        /* DESKTOP / TABLET (> 768px) */
        @media (min-width: 769px) {
            
            /* 1. Глобальный контейнер таба - центрирует всё содержимое */
            #tab-home {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                height: 100vh !important;
                width: 100% !important;
                padding: 0 !important;
                overflow: hidden !important;
                position: relative; 
            }

            /* 2. Промежуточная обертка - сжимаем её до размера контента */
            #tab-home .center-wrapper {
                height: auto !important;
                width: auto !important; /* Не растягивать на всю ширину! */
                max-width: none !important; 
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                margin: 0 auto !important; /* Центрирование по горизонтали */
                flex-direction: column !important;
            }

            /* 3. ЯКОРЯ КАРТОЧКИ (Самое важное для иконок) */
            /* Задаем им фиксированную ширину, чтобы иконки знали, где "край" карточки */
            #card-anchor, #card-anim-wrapper {
                width: 650px !important; /* Ширина равна ширине карточки */
                max-width: 90vw !important;
                position: relative !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
            }

            /* 4. САМА КАРТОЧКА */
            .card {
                width: 100% !important; /* Занимает всю ширину якоря (650px) */
                height: 85vh !important;
                
                min-height: 700px !important;
                max-height: 950px !important;
                
                margin: 0 !important;
                justify-content: space-between !important; 
            }

            /* 5. ИКОНКИ НА ПК (Возвращаем их на место) */
            .icon-left {
                width: 160px !important; /* Чуть крупнее для ПК */
                top: -40px !important;
                left: -40px !important;
            }
            .icon-right {
                width: 130px !important;
                top: -30px !important;
                right: -30px !important;
            }

            /* 6. ТЕКСТ РЕЗУЛЬТАТА */
            .slot-window {
                height: 55% !important; 
                display: flex !important;
                align-items: center !important;
            }
            .slot-item {
                font-size: 110px !important; 
                line-height: 1.1 !important;
            }

            /* 7. Фраза над карточкой */
            .status-text-combined {
                font-size: 24px !important;
                margin-bottom: 30px !important;
                white-space: nowrap; /* Чтобы не переносилась */
            }

            /* 8. Кнопки управления */
            .t-circle-btn.large { width: 90px !important; height: 90px !important; font-size: 40px !important; }
            .t-circle-btn.medium { width: 70px !important; height: 70px !important; font-size: 30px !important; }
            
            /* 9. Модальные окна */
            #modal-sub-overlay .modal { max-width: 900px !important; width: 95%; }
            .plans-container { flex-direction: row; align-items: stretch; justify-content: center; }
            .plan-card { flex: 1; }
        }

        #hist-list-swipes, #hist-list-watch {
            padding-bottom: 20px;
        }

        /* =========================================
        MACOS STYLE SIDEBAR (DESKTOP ONLY)
        ========================================= */
        @media (min-width: 769px) {
            
            body {
                /* Добавляем немного отступа контенту, чтобы он не прилипал к парящему сайдбару */
                overflow: hidden; /* Убираем скролл у всего body */
            }

            .sidebar {
                /* 1. РАЗМЕРЫ И ОТСТУПЫ (Парящий эффект) */
                height: calc(100vh - 40px) !important; /* Отступ сверху и снизу по 20px */
                margin-top: 20px !important;
                margin-left: 20px !important;
                margin-bottom: 20px !important;
                margin-right: 0 !important; /* Справа не нужен отступ, там контент */
                
                border-radius: 24px !important; /* Сильные закругления */
                
                /* 2. ЭФФЕКТ СТЕКЛА (Glassmorphism) */
                /* Полупрозрачный черный фон */
                background: rgba(28, 28, 30, 0.65) !important; 
                
                /* Блюр заднего фона (Самое важное для macOS стиля) */
                backdrop-filter: blur(25px) saturate(180%) !important;
                -webkit-backdrop-filter: blur(25px) saturate(180%) !important;
                
                /* 3. ГРАНИЦЫ И ТЕНИ */
                /* Тонкая светлая обводка (Inset) для объема */
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-right: 1px solid rgba(255, 255, 255, 0.1) !important; /* Перебиваем старый border-right */
                
                /* Глубокая тень для ощущения "парения" */
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5) !important;
                
                z-index: 100 !important;
            }

            /* Адаптация для СВЕТЛОЙ ТЕМЫ */
            body.light-theme .sidebar {
                /* Полупрозрачный белый */
                background: rgba(255, 255, 255, 0.65) !important;
                border: 1px solid rgba(0, 0, 0, 0.05) !important;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            }

            /* Адаптация для РАДУЖНОЙ ТЕМЫ */
            body.rainbow-mode .sidebar {
                background: rgba(20, 20, 20, 0.4) !important; /* Более прозрачный */
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
            }

            /* Убираем скроллбар внутри сайдбара, чтобы было красиво, но оставляем возможность скроллить */
            .sidebar::-webkit-scrollbar {
                width: 0px;
                background: transparent;
            }
            
            /* Корректируем логотип, чтобы он красиво смотрелся в стекле */
            .sidebar .logo {
                margin-top: 10px;
                margin-bottom: 5px;
            }
        }

        .seo-context {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

    </style>
</head>
<body>

<div class="top-gradient-mask"></div>

<div class="app-layout">

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <!-- Логотип: Картинка + Текст -->
        <div class="logo" onclick="resetToHome()">
            <img src="logo.png" alt="X" class="logo-img">
            <span>Fetish</span>Hub <span class="version-tag">0.1</span>
        </div>
        <!-- Подзаголовок -->
        <div class="subtitle" data-key="subtitle">Your home for adult preferences</div>

        <!-- PC MODE CAPSULE -->
        <div id="pc-mode-mount">
            <div class="mode-capsule-wrapper" id="mode-capsule-pc">
                <button class="mode-capsule-btn" onclick="toggleModeDropdown('pc')">
                    <span class="current-mode-icon">🔭</span>
                    <span class="current-mode-text">Explore</span>
                    <span style="font-size:10px; opacity:0.5;">▼</span>
                </button>
                <!-- Выпадающий список -->
                <div class="mode-dropdown">
                    <div class="mode-item" onclick="setAppMode('explore')">
                        <span>🔭</span> <span data-key="mode_explore">Explore</span>
                    </div>
                    <div class="mode-item" onclick="setAppMode('pleasure')">
                        <span>🥰</span> <span data-key="mode_pleasure">Pleasure</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="pc-settings-mount"></div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <div class="mobile-header">
            <div class="logo" onclick="resetToHome()"> 
                <img src="logo.png" alt="X" class="logo-img">
                <span>Fetish</span>Hub <span class="version-tag">0.1</span>
            </div>
            <div class="subtitle" data-key="subtitle">Your home for adult preferences</div>
            
        </div>

       <!-- TAB 1: HOME -->
        <div id="tab-home" class="tab-content active">
            <div class="center-wrapper">
                
                <div id="mobile-mode-mount">
                    <div class="mode-capsule-wrapper" id="mode-capsule-mobile">
                        <button class="mode-capsule-btn" onclick="toggleModeDropdown('mobile')">
                            <span class="current-mode-icon">🔭</span>
                            <span class="current-mode-text">Explore</span>
                        </button>
                        <!-- Выпадающий список -->
                        <div class="mode-dropdown">
                            <div class="mode-item" onclick="setAppMode('explore')">
                                <span>🔭</span> <span data-key="mode_explore">Explore</span>
                            </div>
                            <div class="mode-item" onclick="setAppMode('pleasure')">
                                <span>🥰</span> <span data-key="mode_pleasure">Pleasure</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ЯКОРЬ -->
                <div id="card-anchor" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: visible;">
                    
                    <!-- ОБЁРТКА (Wrapper) -->
                    <div id="card-anim-wrapper" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: visible; z-index: 10;">
                        
                        <!-- 1. ФРАЗА СЮДА -->
                        <div class="status-text-combined stagger-item delay-5" id="status-text"></div>

                        <!-- 2. Иконки -->
                        <img src="" id="deco-left" class="deco-icon icon-left" alt="">
                        <img src="" id="deco-right" class="deco-icon icon-right" alt="">


                        <!-- КАРТОЧКА -->
                        <div class="card" id="card-block">

                            <div id="card-notch" class="card-notch">
                                <span id="card-notch-text">STATUS</span>
                            </div>

                            <!-- START SCREEN OVERLAY (Заменяет контент при старте) -->
                            <div id="mode-start-overlay" class="mode-start-overlay hidden">
                                <!-- Текст с намёком -->
                                <div class="mode-greeting-text" data-key="mode_greeting_hint">
                                    What are we watching today: something new 🔭 or familiar 🥰?
                                </div>
                                
                                <!-- Круглые кнопки -->
                                <div class="mode-buttons-circle-row">
                                    <button class="mode-circle-btn explore" onclick="setAppModeAndStart('explore')">🔭</button>
                                    <button class="mode-circle-btn pleasure" onclick="setAppModeAndStart('pleasure')">🥰</button>
                                </div>
                            </div>

                            <!-- Оверлей для цвета при свайпе -->
                            <div class="swipe-overlay"></div>
                            
                            <!-- Верхняя часть: Бейджи -->
                            <div style="width:100%; display:flex; justify-content:center; min-height: 30px; flex-shrink: 0;" class="stagger-item delay-1" id="badge-container-anim">
                                <div class="badge-wrapper" id="badge-wrapper"></div>
                            </div>

                            <!-- ЦЕНТРАЛЬНАЯ ЧАСТЬ (flex-grow: 1, чтобы занимать всё свободное место) -->
                            <div style="width:100%; display:flex; flex-direction:column; align-items:center; justify-content: center; flex-grow: 1; overflow: hidden;">
                                
                                <!-- Название (Слот-машина) -->
                                <div class="slot-window">
                                    <div id="slot-reel" class="slot-reel">
                                        <!-- Начальный текст -->
                                        <div class="slot-item" id="result-text" style="opacity: 0.8; font-size: 32px;">Ready?</div>
                                    </div>
                                </div>
                                
                                <!-- Описание -->
                                <div id="result-desc" class="result-description stagger-item delay-2"></div>
                                
                                <!-- "Вам может понравиться" -->
                                <div class="related-section hidden-initial stagger-item delay-3" id="related-block">
                                    <div class="related-title" data-key="related_header">You might also like:</div>
                                    <div class="related-tags" id="related-tags"></div>
                                </div>
                            </div>

                            <!-- НИЖНЯЯ ЧАСТЬ: Кнопки (flex-shrink: 0, чтобы не сжимались) -->
                            <div style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top: auto; flex-shrink: 0; padding-bottom: 5px;">
                                
                                <!-- 1. Кнопка СТАРТА (Внутри карточки) -->
                                <div id="start-btn-container">
                                    <button class="btn-start-capsule" onclick="startNewSession()">
                                        🔥 <span data-key="btn_start">Let's Go</span>
                                    </button>
                                </div>

                                <!-- 2. КНОПКИ TINDER (Скрыты в начале) -->
                                <div class="tinder-nav-row hidden-initial stagger-item delay-4" id="tinder-controls">
                                    <button class="t-circle-btn small undo" id="btn-t-undo" onclick="undoLastAction()">↺</button>
                                    <button class="t-circle-btn medium dislike" id="btn-t-pass" onclick="handleSwipeAction('left')">✕</button>
                                    <a href="#" target="_blank" class="t-circle-btn large watch" id="btn-t-watch" onclick="handleOutboundClick()">▶</a>
                                    <button class="t-circle-btn medium like" id="btn-t-like" onclick="handleSwipeAction('right')">♥</button>
                                    <button class="t-circle-btn small wl" id="btn-t-wl" onclick="toggleWatchLater()">🕓</button>
                                </div>

                                <!-- 3. Модификаторы (Expandable Capsule) -->
                                <div id="mods-block" class="hidden-initial stagger-item delay-4" style="width:100%; display: flex; justify-content: center;">
                                    
                                    <!-- Сама капсула -->
                                    <div id="mods-capsule" class="mods-wrapper-expanded" onclick="toggleModifiers(event)">
                                        <!-- Иконка (Плюс / Крестик) -->
                                        <div class="mods-icon-plus">+</div>
                                        
                                        <!-- Контейнер для тегов (Сюда JS будет вставлять кнопки) -->
                                        <div class="mods-content" id="mod-container">
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div> <!-- Конец .card -->
                    </div> <!-- Конец #card-anim-wrapper -->
                </div>
            </div>
        </div>

        <!-- TAB 2: SETTINGS -->
        <div id="tab-settings" class="tab-content">
            <div class="center-wrapper">
                <div id="mount-prefs"></div>
            </div>
        </div>

        <!-- TAB 3: ACCOUNT (Account & Extras) -->
        <div id="tab-account" class="tab-content">
            <div class="center-wrapper">
                <div id="mount-account"></div>
                <div id="mount-extras"></div>
            </div>
        </div>
    </div>
 </div>

<div class="bottom-gradient-mask"></div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <span class="nav-icon">🎲</span> <span data-key="nav_home">Home</span>
    </div>
    <div class="nav-item" onclick="switchTab('settings')" id="nav-settings">
        <span class="nav-icon">⚙️</span> <span data-key="nav_settings">Settings</span>
    </div>
    <div class="nav-item" onclick="switchTab('account')" id="nav-account">
        <span class="nav-icon">👤</span> <span data-key="nav_account">Account</span>
    </div>
</div>

<!-- Modal History -->
<div class="modal-overlay" id="modal-history-overlay" onclick="closeHistoryModal(event)">
    <div class="modal" style="background:var(--sidebar-bg); max-height:85vh; display:flex; flex-direction:column;">
        
        <div class="modal-header">
            <span data-key="history_title">History</span>
            <span style="cursor:pointer" onclick="closeHistoryModal(null, true)">✕</span>
        </div>

        <!-- Контейнеры списков (Тело с прокруткой) -->
        <div class="modal-body" style="padding: 0; flex: 1; overflow-y: auto;">
            <div id="hist-list-swipes" style="display:block;">
                <!-- Сюда рендерится история генераций -->
            </div>
            <div id="hist-list-watch" style="display:none;">
                <!-- Сюда рендерится история времени просмотра -->
            </div>
        </div>

        <!-- Переключатель вкладок (Footer - Прижат к низу) -->
        <div style="padding: 15px 20px 20px 20px; flex-shrink: 0;">
            <div class="stats-nav-capsule" style="height: 45px;">
                <div class="stats-nav-item active" id="hist-nav-swipes" onclick="switchHistoryTab('swipes')">
                    <span data-key="hist_tab_swipes">Swipes</span>
                </div>
                <div class="stats-nav-item" id="hist-nav-watch" onclick="switchHistoryTab('watch')">
                    <span data-key="hist_tab_watch">Time</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Favorites -->
<div class="modal-overlay" id="modal-overlay" onclick="closeList(event)">
    <div class="modal" style="max-height: 85vh; display: flex; flex-direction: column;"> 
        <div class="modal-header">
            <span data-key="favorites_catalog">Liked</span>
            <span style="cursor:pointer" onclick="closeList(null, true)">✕</span>
        </div>
        <div class="modal-body" id="modal-catalog-body" style="overflow-y: auto; flex: 1; padding: 15px;">
        </div>
    </div>
</div>

<!-- Modal Blacklist -->
<div class="modal-overlay" id="modal-blacklist-overlay" onclick="closeBlacklist(event)">
    <div class="modal" style="max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <span data-key="blacklist_catalog">Disliked</span>
            <span style="cursor:pointer" onclick="closeBlacklist(null, true)">✕</span>
        </div>
        <div class="modal-body" id="modal-blacklist-body" style="overflow-y: auto; flex: 1; padding: 15px;">
        </div>
    </div>
</div>

<!-- Modal Stats -->
<div class="modal-overlay" id="modal-stats-overlay" onclick="closeStats(event)">
    <div class="modal" style="background:var(--sidebar-bg); max-height:85vh; display:flex; flex-direction:column;">
        
        <!-- HEADER -->
        <div class="modal-header" style="flex-direction:column; gap:10px; align-items:flex-start; padding-bottom: 10px; border-bottom:none; flex-shrink: 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <span data-key="btn_stats" style="font-size:20px;">Statistics</span>
                
                <!-- Кнопки справа -->
                <div style="display:flex; align-items:center; gap:20px;">
                    <div onclick="shareStats()" style="cursor:pointer; padding:5px; display:flex; align-items:center; justify-content:center;">
                        <span style="font-size: 24px;">⤤</span>
                    </div>
                    <div onclick="closeStats(null, true)" style="cursor:pointer; padding:5px; display:flex; align-items:center; justify-content:center;">
                        <span style="font-size: 26px; font-weight:400; opacity:0.7;">✕</span>
                    </div>
                </div>
            </div>
            
            <!-- Кнопка WRAPPED -->
            <button id="btn-wrapped-trigger" onclick="openWrapped()" 
                style="display:none; width:100%; background: linear-gradient(45deg, #FF9900, #9B59B6); border:none; padding:12px; border-radius:14px; color:#fff; font-weight:800; font-size:15px; text-transform:uppercase; cursor:pointer; justify-content:center; align-items:center; letter-spacing:1px; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);">
                <span data-key="wrapped_btn">Fetish Wrapped ✨</span>
            </button>
        </div>

        <!-- BODY: График (Скроллится если нужно) -->
        <div class="modal-body" id="modal-stats-body" style="padding: 0 20px; flex: 1; overflow-y: auto; min-height: 280px; display:flex; flex-direction:column; justify-content:center;">
            <!-- Сюда JS рисует график -->
        </div>

        <!-- FOOTER: Элементы управления (Прижаты к низу) -->
        <div style="padding: 15px 20px 20px 20px; flex-shrink: 0;">
            <!-- Переключатель Периода (Week/Month/Year) -->
            <div class="stats-tf-capsule" style="margin-bottom: 10px;">
                <div class="stats-tf-item active" id="tf-week" onclick="switchTimeframe('week')">Week</div>
                <div class="stats-tf-item" id="tf-month" onclick="switchTimeframe('month')">Month</div>
                <div class="stats-tf-item" id="tf-year" onclick="switchTimeframe('year')">Year</div>
                <div class="stats-tf-item" id="tf-all" onclick="switchTimeframe('all')">All</div>
            </div>

            <!-- Переключатель Типа (Preferences/Activity) -->
            <div class="stats-nav-capsule" style="height: 45px; margin-bottom: 0;">
                <div class="stats-nav-item active" id="stat-nav-tags" onclick="switchStatsTab('tags')">
                    <span data-key="stats_prefs">Preferences</span>
                </div>
                <div class="stats-nav-item" id="stat-nav-activity" onclick="switchStatsTab('activity')">
                    <span data-key="stats_activity">Activity</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AGE GATE OVERLAY -->
<div id="age-gate" class="modal-overlay" style="z-index: 20000; background: var(--bg-color);">
    <div class="center-wrapper" style="text-align:center; padding:20px;">
        
        <!-- Логотип с картинкой -->
        <div class="logo">
            <img src="logo.png" alt="X" class="logo-img">
            <span>Fetish</span>Hub
        </div>

        <h2 style="margin-bottom:10px;" data-key="age_title">Age Verification</h2>
        
        <p style="color:var(--text-secondary); margin-bottom:30px; line-height:1.5;" data-key="age_desc">
            This website contains age-restricted materials. Are you 18 years or older?
        </p>
        
        <div style="display:flex; gap:15px; width:100%; max-width:300px; justify-content:center;">
            <button class="btn-gen secondary" onclick="blockAccess()" data-key="age_no">No, I am under 18</button>
            <button class="btn-gen" onclick="passAgeGate()" style="background:var(--accent); color:#000;" data-key="age_yes">Yes, I am 18+</button>
        </div>
    </div>
</div>

<!-- BLOCKED SCREEN -->
<div id="age-block" class="modal-overlay" style="z-index: 20001; background: #000; display:none;">
    <div class="center-wrapper" style="text-align:center;">
        <div style="font-size:50px; margin-bottom:20px;">⛔</div>
        <h2 style="color:#fff;" data-key="age_block_msg">This website is only for users over 18 years of age.</h2>
    </div>
</div>

<!-- ONBOARDING OVERLAY -->
<div id="onboarding-overlay" class="modal-overlay" style="z-index: 19000;">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <span data-key="onb_title">Preferences</span>
        </div>
        <div class="modal-body" style="padding:20px; display:flex; flex-direction:column; gap:15px;">
            <p style="color:var(--text-secondary); font-size:14px; text-align:center;" data-key="onb_desc">
                Tell us what you like in one sentence, and we will set up the feed for you.
            </p>
            
            <textarea id="onb-input" rows="3" 
                style="width:100%; background:var(--bg-color); border:1px solid var(--border); border-radius:12px; padding:10px; color:var(--text-main); font-size:16px; resize:none;"
                placeholder="e.g. I like milf, anal and big tits..."></textarea>
            
            <button class="btn-gen" onclick="processOnboardingText()" data-key="onb_btn_check" style="padding:12px; font-size:14px;">Check</button>

            <!-- Результаты поиска -->
            <div id="onb-results" style="display:none; flex-direction:column; gap:10px; margin-top:10px; border-top:1px solid var(--border); padding-top:15px;">
                <div style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; text-align:center;" data-key="onb_found">Found:</div>
                <div id="onb-tags-container" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;"></div>
                <button class="btn-watch" onclick="finishOnboarding()" data-key="onb_btn_confirm" style="margin-top:10px;">Confirm & Start</button>
            </div>
            
            <div style="text-align:center; margin-top:5px;">
                <span style="font-size:12px; color:var(--text-secondary); text-decoration:underline; cursor:pointer;" onclick="skipOnboarding()" data-key="onb_skip">Skip</span>
            </div>
        </div>
    </div>
</div>

<div id="ui-blocks-source" style="display:none;">
    
    <!-- BLOCK: PREFERENCES -->
    <div id="block-prefs">
        <!-- Site Select -->
        <div class="capsule-btn">
            <span data-key="site_label">Site</span>
            <select id="platform" onchange="savePlatform(this.value)" dir="rtl">
                <option value="xh">xHamster</option>
                <option value="ph">Pornhub</option>
                <option value="xv">xVideos</option>
                <option value="sb">SpankBang</option>
                <option value="yp">YouPorn</option>
                <option value="rt">RedTube</option>
                <option value="google">Google Images</option>
            </select>
        </div>

        <div class="ios-header" data-key="header_prefs">Preferences</div>
        <div class="ios-group">
            <div class="ios-row" style="display:block; padding: 15px 16px;">
                <div style="font-size:16px; margin-bottom:15px;" data-key="exploration_mode">Exploration Mode</div>
                <input type="range" min="1" max="3" value="1" class="range-slider" id="intensity-slider" oninput="updateIntensity(this.value)">
                <div class="intensity-labels">
                    <span class="intensity-label active" id="lbl-1" data-val="1">Safe</span>
                    <span class="intensity-label" id="lbl-2" data-val="2">Spicy</span>
                    <span class="intensity-label" id="lbl-3" data-val="3">Extreme</span>
                </div>
            </div>

            <div class="ios-row">
                <span class="platform-label" data-key="ori_label">Orientation</span>
                <select id="orientation-select" class="platform-select" onchange="changeOrientation(this.value)">
                    <option value="hetero" data-key="ori_hetero">Hetero</option>
                    <option value="gay" data-key="ori_gay">Gay</option>
                    <option value="trans" data-key="ori_trans">Trans</option>
                    <option value="pan" data-key="ori_pan">Pansexual</option>
                </select>
            </div>

            <div class="ios-row">
                <span class="platform-label" data-key="lang_label">Language</span>
                <select id="lang-select" class="platform-select" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ru">Русский</option>
                    <option value="es">Español</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>
            <div id="comp-search" class="ios-row" style="display:none;">
                <span class="toggle-text" data-key="search_en_label">Search EN</span>
                <label class="switch">
                    <input type="checkbox" id="force-en" checked onchange="updateLink()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="ios-row clickable" onclick="openThemeModal()">
                <span class="toggle-text" data-key="theme_label">Appearance</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="current-theme-name" style="color:var(--text-secondary); font-size:15px;">Dark</span>
                    <span style="color:var(--text-secondary)">›</span>
                </div>
            </div>
            <div class="ios-row">
                <span class="toggle-text" data-key="deco_label">Show Decorations</span>
                <label class="switch">
                    <input type="checkbox" id="deco-toggle" checked onchange="toggleDecoIcons(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- BLOCK: ACCOUNT -->
    <div id="block-account">
        <!-- ЗАГОЛОВОК С ДАТОЙ -->
        <div class="ios-header" style="display:flex; justify-content:space-between; align-items:baseline; padding-right: 16px;">
            <span data-key="nav_account">Account</span>
            <span id="last-sync-date" style="font-size:11px; color:var(--text-secondary); text-transform:none; font-weight:400; opacity:0.8; display:none;"></span>
        </div>
        
        <!-- ОСНОВНАЯ ГРУППА (УПРАВЛЕНИЕ) -->
        <div class="ios-group">
            
            <!-- 1. ВХОД -->
            <div class="ios-row clickable" onclick="window.handleLoginClick()" style="padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span id="login-status-icon" style="font-size:20px; width:24px; text-align:center;">☁️</span>
                    <span id="login-btn-text" style="font-weight:600; font-size:17px; color:var(--text-main);" data-key="login_text">Sync Data</span>
                </div>
                <span style="color:var(--text-secondary)">›</span>
            </div>

            <!-- 2. ПОДПИСКА -->
            <div class="ios-row clickable" onclick="openSubModal()" style="padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span style="font-size:20px; width:24px; text-align:center;">⭐</span>
                    <div style="display:flex; flex-direction:column;">
                        <span id="current-plan-name" style="font-weight:600; font-size:17px; color:var(--text-main);">FREE</span>
                        <span style="font-size:11px; color:var(--text-secondary);" data-key="lbl_current_plan">Current Plan</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="upgrade-badge" style="font-size:11px; font-weight:700; background:rgba(255,153,0,0.15); color:var(--accent); padding:4px 8px; border-radius:6px; text-transform:uppercase;">UPGRADE</span>
                    <span style="color:var(--text-secondary)">›</span>
                </div>
            </div>

            <!-- 3. СПИСКИ -->
            <div class="ios-row clickable" onclick="openFavoritesCatalog()">
                <span data-key="favorites_catalog">Liked</span>
                <span class="badge" id="count-fav" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>
            <div class="ios-row clickable" onclick="openBlacklistCatalog()">
                <span data-key="blacklist_catalog">Disliked</span>
                <span class="badge" id="count-ban" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>
            <div class="ios-row clickable" onclick="openWatchLaterCatalog()">
                <span data-key="watch_later">Watch Later</span>
                <span class="badge" id="count-wl" style="color:var(--text-secondary); font-size:17px;">0</span>
            </div>
            <!-- 4. СБРОС -->
            <div class="ios-row clickable" onclick="resetAppHistory()" style="color: var(--highlight-red);">
                <span data-key="btn_reset">Reset Data</span>
                <span>✕</span>
            </div>
            <!-- ADMIN BUTTON (Hidden by default) -->
            <div id="btn-admin-trigger" class="ios-row clickable" onclick="openAdminModal()" style="display:none; color: #ff0000;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span style="font-size:20px;">⚡</span>
                    <span style="font-weight:700;">Admin Panel</span>
                </div>
                <span style="color:var(--text-secondary)">›</span>
            </div>
        </div>

        <!-- ИНФОРМАЦИЯ -->
        <div class="ios-header" data-key="info_header">Information</div>
        <div class="ios-group">
            
            <!-- Статистика -->
            <div class="ios-row clickable" onclick="openStatistics()">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:18px;">📊</span>
                    <span data-key="btn_open_stats">Statistics</span>
                </div>
                <span style="color:var(--text-secondary)">›</span>
            </div>

            <!-- История (Кнопка открытия модалки) -->
            <div class="ios-row clickable" onclick="openHistoryModal()">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:18px;">📜</span>
                    <span data-key="history_title">History</span>
                </div>
                <span style="color:var(--text-secondary)">›</span>
            </div>

            <!-- Дорожная карта -->
            <div class="ios-row clickable" onclick="openRoadmap()">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:18px;">🚀</span>
                    <span data-key="btn_roadmap">Roadmap</span>
                </div>
                <span style="color:var(--text-secondary)">›</span>
            </div>

            <!-- Explored Counter -->
             <div class="ios-row">
                <span data-key="explored_label">Explored</span>
                <span style="color:var(--text-secondary); font-size:16px;" id="explored-count">0 / 0</span>
            </div>
        </div>
    </div>

    <!-- BLOCK: EXTRAS & HISTORY -->
    <div id="block-extras">
        
        <!-- Заголовок группы -->
        <div class="ios-header" data-key="header_extras">Extras</div>
        
        <!-- ГРУППА ССЫЛОК -->
        <div class="ios-group">
            
            <!-- 1. Reddit -->
            <div class="ios-row clickable" onclick="window.open('https://reddit.com/r/xfetishhub', '_blank')">
                <span>Reddit</span>
                <span style="color:var(--text-secondary)">↗</span>
            </div>

            <!-- 2. Report Issue -->
            <div class="ios-row clickable" onclick="window.open('https://tally.so/r/Y50280', '_blank')">
                <span data-key="report_issue">Report Issue</span>
                <span style="color:var(--text-secondary)">↗</span>
            </div>

            <div id="row-install-app" class="ios-row clickable" onclick="openQRModal()">
                <span data-key="btn_install_phone">Install on Phone</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:20px;">📱</span>
                    <span style="color:var(--text-secondary)">›</span>
                </div>
            </div>

            <!-- 3. О ПРОЕКТЕ -->
            <div class="ios-row clickable" onclick="window.openAbout()">
                <span data-key="lbl_about">About Project</span>
                <span style="color:var(--text-secondary)">›</span>
            </div>

            <!-- 4. Terms of Use -->
            <div class="ios-row clickable" onclick="window.openLegal('terms')">
                <span data-key="doc_terms">Terms of Use</span>
                <span style="color:var(--text-secondary)">›</span>
            </div>

            <!-- 5. Privacy Policy -->
            <div class="ios-row clickable" onclick="window.openLegal('privacy')">
                <span data-key="doc_privacy">Privacy Policy</span>
                <span style="color:var(--text-secondary)">›</span>
            </div>

            <!-- 6. Refund Policy -->
            <div class="ios-row clickable" onclick="window.openLegal('refund')">
                <span data-key="doc_refund">Refund Policy</span>
                <span style="color:var(--text-secondary)">›</span>
            </div>
                <div class="ios-row clickable" onclick="openSponsorsModal()">
                <span data-key="btn_early_sponsors">Early Sponsors 💎</span>
                <span style="color:var(--text-secondary)">›</span>
            </div>
        </div>
    </div>
    <div id="block-history" style="margin-top:20px;">
        <div class="ios-header" data-key="history_title">History</div>
        <div class="ios-group" id="history-list"></div>
    </div>

</div>

<!-- SUBSCRIPTION MODAL -->
<div class="modal-overlay" id="modal-sub-overlay" onclick="closeSubModal(event)">
    <div class="modal" style="background:var(--bg-color); max-height:95vh;">
        <div class="modal-header" style="border:none; padding-bottom:0;">
            <span data-key="sub_title">Premium Access</span>
            <span style="cursor:pointer" onclick="closeSubModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body" style="padding:0 20px 30px 20px; display:block; overflow-y:auto;">
            
            <!-- Intro Text -->
            <div style="text-align:center; margin-bottom:25px; margin-top:10px;">
                <p style="font-size:14px; color:var(--text-secondary); line-height:1.5;" data-key="sub_intro">
                    xFetishHub is an ad-free project developed by one enthusiast. It gives a unique experience for free, but your support helps it grow.
                </p>
            </div>

            <!-- PLANS CONTAINER (Flex on PC) -->
            <div class="plans-container">
                
                <!-- FREE CARD -->
                <div class="plan-card">
                    <div class="plan-title">Free</div>
                    <div class="plan-price">$0</div>
                    <ul class="plan-features">
                        <li data-key="feat_limit">🎲 10 Generations / day</li>
                        <li data-key="feat_wrapped_limited">🎁 1 Fetish Wrapped / week</li>
                        <li data-key="feat_stats_basic">📊 Basic Statistics</li>
                    </ul>
                    <button class="plan-btn current" disabled data-key="btn_current">Current Plan</button>
                </div>

                <!-- PRO CARD -->
                <div class="plan-card pro">
                    <div class="plan-title">Pro <span style="font-size:12px; opacity:0.7">Fan</span></div>
                    <div class="plan-price">$1.99 <span style="font-size:12px">/ mo</span></div>
                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_unlim">🔥 <b>Unlimited</b> Generations</li>
                        <li data-key="feat_stats_adv">📈 Advanced Stats & History</li>
                        <li data-key="feat_wrapped_unlim">✨ <b>Unlimited</b> Fetish Wrapped</li>
                        <li data-key="feat_custom">🎨 Deep Customization</li>
                        <li data-key="feat_early">🚀 Early Access features</li>
                    </ul>
                    <button class="plan-btn pro-btn" onclick="openPaymentSelection('pro')" data-key="btn_get_pro">Get Pro</button>
                </div>

                <!-- BEAST CARD -->
                <div class="plan-card beast">
                    <div class="plan-title">Beast <span style="font-size:12px; opacity:0.7">Sponsor</span></div>
                    <div class="plan-price">$4.99 <span style="font-size:12px">/ mo</span></div>
                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_all_pro">👑 <b>All Pro Features</b></li>
                        <li data-key="feat_discord">💬 <b>Discord</b> (Dev Chat)</li>
                        <li data-key="feat_vote">🗳️ Vote on Roadmap</li>
                    </ul>
                    <button class="plan-btn beast-btn" onclick="openPaymentSelection('beast')" data-key="btn_get_beast">Unleash Beast</button>
                </div>
                <!-- BESTIE CARD (LIFETIME) -->
                <div class="plan-card bestie">
                    <!-- Бейдж сверху -->
                    <div class="bestie-badge" data-key="badge_limited">LIMITED OFFER</div>
                    
                    <!-- Заголовок -->
                    <div class="plan-title">Bestie <span style="font-size:12px; opacity:0.7; -webkit-text-fill-color: initial; color:var(--text-secondary);" data-key="plan_bestie_sub">Lifetime</span></div>
                    
                    <!-- Цена -->
                    <div class="plan-price">$49.99 <span style="font-size:12px" data-key="plan_bestie_price">/ once</span></div>
                    
                    <!-- Счётчик -->
                    <div class="limit-container">
                        <div class="limit-labels">
                            <span style="font-weight:700; color:#ff6b6b;" data-key="limit_burn">🔥 ALMOST GONE</span>
                            <span style="font-weight:700; color:#fff;">48 / 50 <span data-key="limit_claimed">claimed</span></span>
                        </div>
                        <div class="limit-track">
                            <div class="limit-fill"></div>
                        </div>
                    </div>

                    <!-- Список фич -->
                    <ul class="plan-features">
                        <li style="color:var(--text-main)" data-key="feat_lifetime">♾️ <b>Lifetime Access</b></li>
                        <li style="color:var(--text-main)" data-key="feat_all_pro">👑 <b>All Pro Features</b></li>
                        <li data-key="feat_sponsors">💎 Listed in "Sponsors"</li>
                        <li data-key="feat_onetime">💸 One-time payment</li>
                    </ul>
                    
                    <button class="plan-btn bestie-btn" onclick="openPaymentSelection('bestie')" data-key="btn_get_bestie">Get Forever</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- THEME MODAL -->
<div class="modal-overlay" id="modal-theme-overlay" onclick="closeThemeModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span data-key="theme_title">Choose Theme</span>
            <span style="cursor:pointer" onclick="closeThemeModal(null, true)">✕</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            
            <div class="ios-header" style="margin-left:0; margin-top:0;" data-key="theme_basic">Basic</div>
            <div class="theme-grid" id="theme-list-basic"></div>

            <div class="ios-header" style="margin-left:0;" data-key="theme_premium">Premium (Pro)</div>
            <div class="theme-grid" id="theme-list-premium"></div>

        </div>
    </div>
</div>

<!-- PAYMENT SELECTION MODAL -->
<div class="modal-overlay" id="modal-payment-overlay" onclick="closePaymentModal(event)" style="z-index: 22000;">
    <div class="modal" style="max-width: 400px; background: var(--ios-card);">
        <div class="modal-header">
            <span id="payment-modal-title">Checkout</span>
            <span style="cursor:pointer" onclick="closePaymentModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body" style="padding: 0;">
            <div class="pay-desc" data-key="pay_desc">
                Select a payment method to receive your activation code instantly.
            </div>

            <!-- Список методов (Вертикальный, без скролла) -->
            <div class="ios-group" style="margin: 0 15px 15px 15px;">
                
                <!-- Telegram Stars -->
                <div class="ios-row clickable" onclick="processPayment('telegram')" style="padding: 12px 16px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span style="font-size:24px;">⭐</span>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; color:var(--text-main);" data-key="pay_stars">Telegram Stars</span>
                            <span style="font-size:11px; color:#2ecc71;">Apple Pay / Google Pay</span>
                        </div>
                    </div>
                    <span style="color:var(--text-secondary)">›</span>
                </div>

                <!-- Lava.top -->
                <div class="ios-row clickable" onclick="processPayment('lava')" style="padding: 12px 16px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span style="font-size:24px;">🌋</span>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; color:var(--text-main);" data-key="pay_card">Card (Lava.top)</span>
                            <span style="font-size:11px; color:var(--text-secondary);">Visa / Mastercard</span>
                        </div>
                    </div>
                    <span style="color:var(--text-secondary)">›</span>
                </div>

                <!-- Cryptomus -->
                <div class="ios-row clickable" onclick="processPayment('crypto')" style="padding: 12px 16px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span style="font-size:24px;">🛡️</span>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; color:var(--text-main);" data-key="pay_crypto">Crypto</span>
                            <span style="font-size:11px; color:var(--text-secondary);">USDT, TON, BTC</span>
                        </div>
                    </div>
                    <span style="color:var(--text-secondary)">›</span>
                </div>

                <!-- Boosty -->
                <div class="ios-row clickable" onclick="processPayment('boosty')" style="padding: 12px 16px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span style="font-size:24px;">🅱️</span>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; color:var(--text-main);" data-key="pay_boosty">Boosty</span>
                            <span style="font-size:11px; color:var(--text-secondary);">Cards (RF), PayPal</span>
                        </div>
                    </div>
                    <span style="color:var(--text-secondary)">›</span>
                </div>
            </div>
            
            <!-- Поле ввода кода -->
            <div class="promo-container">
                <div class="promo-label" data-key="pay_code_label">If you paid, enter code here:</div>
                <div class="promo-input-group">
                    <input type="text" id="promo-input-field" class="promo-input" placeholder="Activation code...">
                    <button class="promo-btn" onclick="submitPromoFromInput()">→</button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- LEGAL MODAL -->
<div class="modal-overlay" id="modal-legal-overlay" onclick="window.closeLegal(event)">
    <div class="modal" style="max-width: 600px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <span id="legal-modal-title">Document</span>
            <span style="cursor:pointer" onclick="window.closeLegal(null, true)">✕</span>
        </div>
        
        <!-- Контент с прокруткой -->
        <div class="modal-body" style="padding: 20px; overflow-y: auto; font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
            <div id="legal-modal-content"></div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--border); text-align: center;">
            <button class="btn-gen" onclick="window.closeLegal(null, true)" data-key="btn_close" style="padding: 10px 30px; font-size: 14px; width: auto;">Close</button>
        </div>
    </div>
</div>

<!-- ADMIN MODAL -->
<div class="modal-overlay" id="modal-admin-overlay" onclick="closeAdminModal(event)" style="z-index: 25000;">
    <div class="modal" style="max-width: 450px; background: var(--sidebar-bg);">
        
        <div class="modal-header" style="border-bottom: 1px solid var(--border);">
            <div style="display:flex; align-items:center; gap:10px; color:#ff0000;">
                <span>👑</span>
                <span>Admin Control</span>
            </div>
            <span style="cursor:pointer; opacity:0.7;" onclick="closeAdminModal(null, true)">✕</span>
        </div>

        <div class="modal-body" style="padding: 20px;">
            
            <!-- Генератор кодов -->
            <div class="ios-group" style="padding:15px; margin-bottom: 20px;">
                <div style="font-weight:700; margin-bottom:10px; font-size:13px; text-transform:uppercase; color:var(--text-secondary);">Generate Promo Code</div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="admin-code-type" class="promo-input" style="flex:1;">
                        <option value="pro">Pro</option>
                        <option value="beast">Beast</option>
                        <option value="bestie">Bestie</option>
                    </select>
                    <input type="number" id="admin-code-days" class="promo-input" style="width:80px;" value="30" placeholder="Days">
                </div>
                <button class="btn-gen" onclick="adminGenerateCode()" style="padding:12px; font-size:14px; background:var(--card-bg);">Create Code</button>
                <div id="admin-code-result" style="margin-top:15px; font-family:monospace; font-size:18px; color:#2ecc71; user-select:all; text-align:center; font-weight:800; min-height:20px;"></div>
            </div>

            <!-- Подарок подписки (Поиск по Email) -->
            <div class="ios-group" style="padding:15px; margin-bottom: 20px;">
                <div style="font-weight:700; margin-bottom:10px; font-size:13px; text-transform:uppercase; color:var(--text-secondary);">Gift Sub (By Email)</div>
                <input type="text" id="admin-gift-email" class="promo-input" placeholder="User Email..." style="margin-bottom:10px;">
                
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="admin-gift-type" class="promo-input" style="flex:1;">
                        <option value="pro">Pro</option>
                        <option value="beast">Beast</option>
                        <option value="bestie">Bestie</option>
                    </select>
                    <input type="number" id="admin-gift-days" class="promo-input" style="width:80px;" value="30">
                </div>
                
                <button class="btn-gen" onclick="adminGiftSub()" style="padding:12px; font-size:14px; background:var(--accent); color:#000;">Activate Sub</button>
            </div>

            <!-- Сброс подписки (Reset to Free) -->
            <div class="ios-group" style="padding:15px; border: 1px solid rgba(231, 76, 60, 0.3);">
                <div style="font-weight:700; margin-bottom:10px; color:var(--highlight-red); font-size:13px; text-transform:uppercase;">Reset Subscription ⚠️</div>
                <input type="text" id="admin-reset-email" class="promo-input" placeholder="User Email to reset..." style="margin-bottom:10px;">
                
                <button class="btn-gen" onclick="adminResetSub()" style="padding:12px; font-size:14px; background:rgba(231, 76, 60, 0.15); border:1px solid var(--highlight-red); color:var(--highlight-red);">
                    Set to FREE
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ABOUT AUTHOR MODAL -->
<div class="modal-overlay" id="modal-about-overlay" onclick="window.closeAbout(event)" style="z-index: 21000;">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <span id="about-modal-title">About</span>
            <span style="cursor:pointer" onclick="window.closeAbout(null, true)">✕</span>
        </div>
        <div class="modal-body" style="padding: 20px; font-size: 15px; line-height: 1.6; color: var(--text-main);">
            
            <p style="margin-bottom: 15px; font-weight: 700;" id="about-intro">
            </p>
            
            <p style="color: var(--text-secondary); margin-bottom: 25px;" id="about-desc">
            </p>

            <div style="background: var(--ios-card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px; font-weight:600; color:var(--text-secondary);">Email:</span>
                <a href="mailto:bdengerr@gmail.com" style="color:var(--accent); font-weight:700; text-decoration:none; font-size:15px;">bdengerr@gmail.com</a>
            </div>
        </div>
    </div>
</div>

<!-- INSTALL APP MODAL -->
<div id="modal-install-overlay" class="modal-overlay" style="z-index: 19500;">
    <div class="modal" style="max-width: 400px; padding: 20px;">
        <div style="text-align:center; margin-bottom:20px;">
            <img src="logo.png" style="width:60px; height:60px; border-radius:15px; margin-bottom:15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <h2 style="margin:0 0 10px 0; font-size:20px;" data-key="install_title">Install App</h2>
            
            <p style="font-size:14px; color:var(--text-secondary); line-height:1.5;" data-key="install_desc">
                Install our app for a full-screen experience. Plus, watch videos in the built-in browser to keep your main browser history clean!
            </p>
        </div>

        <!-- Кнопки выбора платформы -->
        <div class="ios-group" style="margin-bottom:15px;">
            <!-- iOS -->
            <div class="ios-row clickable" onclick="toggleInstallInstruct('ios')">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:20px;">🍎</span>
                    <span style="font-weight:600;">iPhone (Safari)</span>
                </div>
                <span>▼</span>
            </div>
            <!-- Инструкция iOS (Скрыта) -->
            <div id="instruct-ios" style="display:none; padding:15px; background:var(--bg-color); font-size:13px; color:var(--text-secondary); line-height:1.6;">
                1. <span data-key="inst_ios_1">Tap the <b>Share</b> button</span> <span style="font-size:16px">⎋</span><br>
                2. <span data-key="inst_ios_2">Scroll down and tap</span> <br>
                <span style="display:inline-block; background:var(--ios-separator); padding:4px 8px; border-radius:6px; margin:4px 0; color:var(--text-main); font-weight:600;">➕ <span data-key="inst_ios_btn">Add to Home Screen</span></span><br>
                3. <span data-key="inst_ios_3">Tap <b>Add</b> in the top right.</span>
            </div>

            <!-- Android -->
            <div class="ios-row clickable" onclick="toggleInstallInstruct('android')">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:20px;">🤖</span>
                    <span style="font-weight:600;">Android (Chrome)</span>
                </div>
                <span>▼</span>
            </div>
            <!-- Инструкция Android (Скрыта) -->
            <div id="instruct-android" style="display:none; padding:15px; background:var(--bg-color); font-size:13px; color:var(--text-secondary); line-height:1.6;">
                1. <span data-key="inst_and_1">Tap the <b>Menu</b> button (3 dots)</span> <span style="font-size:16px">⋮</span><br>
                2. <span data-key="inst_and_2">Select</span> <br>
                <span style="display:inline-block; background:var(--ios-separator); padding:4px 8px; border-radius:6px; margin:4px 0; color:var(--text-main); font-weight:600;">⬇ <span data-key="inst_and_btn">Install App</span></span>
            </div>
        </div>

        <button class="btn-gen" onclick="skipInstall()" data-key="install_continue" style="padding:15px; font-size:14px; background:transparent; border:1px solid var(--border); color:var(--text-secondary);">Continue in Browser</button>
    </div>
</div>

<!-- LOGIN EXPLANATION MODAL -->
<div class="modal-overlay" id="modal-login-overlay" onclick="closeLoginModal(event)" style="z-index: 23000;">
    <div class="modal" style="max-width: 380px; padding: 25px;">
        
        <div style="text-align:center; margin-bottom: 20px;">
            <div style="font-size:40px; margin-bottom:10px;">☁️</div>
            <h2 style="margin:0; font-size:22px;" data-key="auth_title">Sync & Backup</h2>
        </div>

        <ul class="auth-benefits">
            <li>
                <div class="auth-icon">🔄</div>
                <span data-key="auth_p1">Store history and preferences across all devices</span>
            </li>
            <li>
                <div class="auth-icon">⭐</div>
                <span data-key="auth_p2">Activate Pro / Beast status</span>
            </li>
            <li>
                <div class="auth-icon">🔒</div>
                <span data-key="auth_p3">Anonymous storage on Google servers</span>
            </li>
        </ul>

        <button class="btn-google" onclick="performGoogleLogin()">
            <img src="google_logo.svg.png" width="20" height="20" style="object-fit: contain;">
            <span data-key="btn_google_signin">Continue with Google</span>
        </button>

        <div class="auth-note" data-key="auth_security_note">
            Developer has no access to data. Don't worry about your history safety 😏
        </div>
        
        <div style="text-align:center; margin-top:15px;">
            <span style="color:var(--text-secondary); font-size:13px; cursor:pointer;" onclick="closeLoginModal(null, true)" data-key="btn_cancel">Cancel</span>
        </div>
    </div>
</div>

<!-- SYNC INFO & LOGOUT MODAL -->
<div class="modal-overlay" id="modal-sync-info-overlay" onclick="closeSyncInfoModal(event)" style="z-index: 23000;">
    <div class="modal" style="max-width: 400px; padding: 0; background: var(--sidebar-bg); overflow: hidden;">
        
        <!-- Header -->
        <div class="modal-header" style="border-bottom: 1px solid var(--border); padding: 15px 20px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:24px;">☁️</span>
                <span data-key="sync_title">Cloud Storage</span>
            </div>
            <span style="cursor:pointer; opacity:0.6;" onclick="closeSyncInfoModal(null, true)">✕</span>
        </div>

        <!-- Body -->
        <div class="modal-body" style="padding: 20px;">
            
            <div style="text-align:center; margin-bottom:20px; color:var(--text-secondary); font-size:13px;">
                <span id="sync-email-display" style="color:var(--text-main); font-weight:700;">...</span>
                
                <!-- Блок подписки -->
                <div id="sync-plan-box" style="margin-top: 8px; display: inline-flex; align-items: center; gap: 8px; background: var(--ios-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px;">
                    <span id="sync-plan-badge" style="font-weight: 800; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">FREE</span>
                    <span id="sync-plan-expiry" style="font-size: 11px; color: var(--text-secondary); display: none;">...</span>
                </div>

                <br>
                <!-- ДОБАВИЛ data-key -->
                <span data-key="sync_desc">Data stored safely on Google servers</span>
            </div>

            <!-- Stats Grid -->
            <div class="sync-stats-grid">
                <div class="sync-stat-item">
                    <span class="sync-stat-val" id="cloud-fav-count">...</span>
                    <span class="sync-stat-label" data-key="favorites_catalog">Liked</span>
                </div>
                <div class="sync-stat-item">
                    <span class="sync-stat-val" id="cloud-wl-count">...</span>
                    <span class="sync-stat-label" data-key="watch_later">Watch Later</span>
                </div>
                <div class="sync-stat-item">
                    <span class="sync-stat-val" id="cloud-hist-count">...</span>
                    <span class="sync-stat-label" data-key="history_title">History</span>
                </div>
                <div class="sync-stat-item">
                    <span class="sync-stat-val" id="cloud-ban-count">...</span>
                    <span class="sync-stat-label" data-key="blacklist_catalog">Disliked</span>
                </div>
            </div>

            <div style="background:rgba(255,153,0,0.1); border:1px solid rgba(255,153,0,0.3); padding:10px; border-radius:12px; margin-bottom:20px; font-size:12px; color:var(--text-secondary); text-align:center;">
                <!-- ДОБАВИЛ data-key -->
                <span data-key="sync_tip">Click "Synchronize" to merge Cloud data with this device.</span>
            </div>

            <!-- Actions -->
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-gen" onclick="performManualSync()" id="btn-manual-sync" style="padding:15px; font-size:15px; background:var(--accent); color:#000; border:none;">
                    <!-- ДОБАВИЛ data-key -->
                    <span id="sync-btn-text" data-key="btn_sync">🔄 Synchronize Device</span>
                </button>

                <button class="btn-gen" onclick="window.logout()" style="padding:15px; font-size:15px; background:transparent; border:1px solid var(--highlight-red); color:var(--highlight-red);">
                    <span data-key="logout_text">Log Out</span>
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ROADMAP MODAL -->
<div class="modal-overlay" id="modal-roadmap-overlay" onclick="closeRoadmap(event)">
    <div class="modal" style="max-width: 500px; max-height: 90vh;">
        
        <div class="modal-header" style="border-bottom:none; padding-bottom:0;">
            <span data-key="roadmap_title">Future Plans</span>
            <span style="cursor:pointer" onclick="closeRoadmap(null, true)">✕</span>
        </div>

        <div class="modal-body" style="padding: 20px;">
            
            <p style="font-size:14px; color:var(--text-secondary); line-height:1.5; margin-bottom:25px; text-align:center;" data-key="roadmap_desc">
                With your active support, xFetishHub will evolve into the ultimate platform. Here is what we are building:
            </p>

            <!-- Контейнер с обновленной структурой -->
            <div class="roadmap-container">
                
                <!-- Item 1 -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="color: #9b59b6; background: rgba(155, 89, 182, 0.15);">🌐</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" data-key="rm_global_title">Global Intelligence</div>
                        <div class="rm-desc" data-key="rm_global_desc">
                            Aggregation of anonymous data from all users to create the smartest recommendation engine.
                        </div>
                    </div>
                </div>

                <!-- Item 2 -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="color: #2ecc71; background: rgba(46, 204, 113, 0.15);">🤝</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" data-key="rm_coop_title">Co-op Mode</div>
                        <div class="rm-desc" data-key="rm_coop_desc">
                            Invite a partner or friend to a session. They will see what genres you roll in real-time.
                        </div>
                    </div>
                </div>

                <!-- Item 3 -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="color: #ff9900; background: rgba(255, 153, 0, 0.15);">📚</div>
                        <div class="rm-line"></div>
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" data-key="rm_content_title">5000+ Categories</div>
                        <div class="rm-desc" data-key="rm_content_desc">
                            Massive database expansion. Every specific micro-fetish and niche genre will be indexed.
                        </div>
                    </div>
                </div>

                <!-- Item 4 (Последний - без линии) -->
                <div class="roadmap-item">
                    <div class="rm-visual-col">
                        <div class="rm-icon-box" style="color: #3498db; background: rgba(52, 152, 219, 0.15);">⭐</div>
                        <!-- Линии нет -->
                    </div>
                    <div class="rm-content">
                        <div class="rm-title" data-key="rm_actors_title">Actor Selector</div>
                        <div class="rm-desc" data-key="rm_actors_desc">
                            A dedicated mode to find pornstars and models based on your visual preferences.
                        </div>
                    </div>
                </div>

            </div>

            <!-- Закрывает Roadmap -> Открывает Sub -->
            <div style="margin-top:20px; text-align:center;">
                <button class="btn-gen" onclick="closeRoadmap(null, true); openSubModal();" style="padding:15px; font-size:14px; background:var(--nav-bg); border:1px solid var(--accent); color:var(--text-main);">
                    <span data-key="rm_support_btn">Support Development 🚀</span>
                </button>
            </div>

        </div>
    </div>
</div>

<!-- QR CODE MODAL (FOR PC) -->
<div class="modal-overlay" id="modal-qr-overlay" onclick="closeQRModal(event)">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <span data-key="qr_title">Scan to Install</span>
            <span style="cursor:pointer" onclick="closeQRModal(null, true)">✕</span>
        </div>
        <div class="modal-body" style="padding: 25px; text-align: center;">
            
            <!-- QR Image -->
            <div style="background: white; padding: 15px; border-radius: 20px; display: inline-block; margin-bottom: 20px;">
                <img id="qr-code-img" src="" alt="QR Code" style="width: 200px; height: 200px; display: block;">
            </div>

            <p style="font-size:14px; color:var(--text-secondary); margin-bottom:25px; line-height: 1.5;" data-key="qr_desc">
                Scan this QR code with your phone camera to open the site, then follow the instructions below:
            </p>

            <!-- Instructions (Static List) -->
            <div class="ios-group" style="text-align: left;">
                <!-- iOS -->
                <div class="ios-row" style="display:block; padding: 12px 16px;">
                    <div style="font-weight:700; color:var(--text-main); margin-bottom:5px; display:flex; align-items:center; gap:8px;">
                        <span style="font-size:18px;">🍎</span> iOS (Safari)
                    </div>
                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.4;">
                        1. <span data-key="inst_ios_1">Tap Share</span> <span style="font-size:14px">⎋</span><br>
                        2. <span data-key="inst_ios_2">Scroll & Tap</span> <b><span data-key="inst_ios_btn">Add to Home Screen</span></b>
                    </div>
                </div>
                <!-- Android -->
                <div class="ios-row" style="display:block; padding: 12px 16px;">
                    <div style="font-weight:700; color:var(--text-main); margin-bottom:5px; display:flex; align-items:center; gap:8px;">
                        <span style="font-size:18px;">🤖</span> Android (Chrome)
                    </div>
                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.4;">
                        1. <span data-key="inst_and_1">Tap Menu</span> <span style="font-size:14px">⋮</span><br>
                        2. <span data-key="inst_and_btn">Install App</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- SPONSORS MODAL -->
<div class="modal-overlay" id="modal-sponsors-overlay" onclick="closeSponsorsModal(event)">
    <div class="modal" style="max-width: 400px; max-height: 80vh;">
        <div class="modal-header">
            <!-- ЗАГОЛОВОК -->
            <span data-key="sponsors_title">Early Sponsors</span>
            <span style="cursor:pointer" onclick="closeSponsorsModal(null, true)">✕</span>
        </div>
        
        <div class="modal-body" style="padding: 0;">
            <!-- ОПИСАНИЕ -->
            <div style="padding: 20px 20px 10px 20px; text-align: center; color: var(--text-secondary); font-size: 13px; line-height: 1.5;" data-key="sponsors_desc">
                These legends supported xFetishHub at the very beginning by purchasing the Bestie plan. <br>Forever grateful! 💙
            </div>

            <div class="ios-group" style="margin: 10px 15px 20px 15px;" id="sponsors-list">
            </div>
        </div>
    </div>
</div>

<div id="wrapped-mount" class="wrapped-overlay"></div>

<!-- FIREBASE INTEGRATION -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, serverTimestamp, writeBatch, query, where, collection, deleteField, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


    const firebaseConfig = {
        apiKey: "AIzaSyC94QWRaFu0o60kDSU8Uz0VJAcXwaDWjlI",
        authDomain: "xfetishhub.firebaseapp.com",
        projectId: "xfetishhub",
        storageBucket: "xfetishhub.firebasestorage.app",
        messagingSenderId: "617015941952",
        appId: "1:617015941952:web:4f75df1239b0c114d8f8a5"
    };

    const ADMIN_UID = "Tqk5aauZ8JVzQ4Bs7Z0BCT5dZKf1";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let syncTimeout = null;

    // Глобальное состояние входа
    window.isUserLoggedIn = false;

    // === ФУНКЦИИ ВХОДА/ВЫХОДА (Доступны глобально) ===
    
    window.loginWithGoogle = async function() {
        try {
            await signInWithPopup(auth, provider);
            // Состояние обновится в onAuthStateChanged
        } catch (error) {
            console.error("Login failed:", error);
        }
    };

   window.logout = async function() {
        const user = auth.currentUser;
        
        // Если пользователь был залогинен, пробуем сохранить данные перед выходом
        if (user) {
            const btnText = document.getElementById('sync-btn-text');
            if(btnText) btnText.innerText = "Saving...";
            try {
                console.log("Saving data before logout...");
                await window.syncToCloud(); // Финальное сохранение
            } catch (e) {
                console.error("Save before logout failed", e);
            }
        }

        try {
            await signOut(auth);
            
            // 1. Удаляем метку о синхронизации
            localStorage.removeItem('xch_last_sync_ts');
            
            // 2. УДАЛЯЕМ ПОДПИСКУ (Сбрасываем на Free)
            localStorage.removeItem('xch_sub_level');
            
            const currentTheme = localStorage.getItem('xch_theme_id');
            // Если тема не стандартная (dark/light), сбрасываем
            if (currentTheme && currentTheme !== 'dark' && currentTheme !== 'light') {
                localStorage.setItem('xch_theme_id', 'dark');
            }
            // ====================

            location.reload(); // Перезагрузка применит тариф Free
        } catch (error) {
            console.error("Logout failed:", error);
        }
    };

    // === АКТИВАЦИЯ ПРОМОКОДА ===
    window.activatePromoCode = async function(code) {
        const user = auth.currentUser;
        // Ссылки на документы
        const codeRef = doc(db, "promocodes", code);
        const userRef = doc(db, "users", user.uid);

        try {
            // 1. Сначала читаем код, чтобы убедиться, что он есть (как и раньше)
            const codeSnap = await getDoc(codeRef);
            if (!codeSnap.exists() || !codeSnap.data().active) {
                alert("Invalid code");
                return;
            }
            const promoData = codeSnap.data();

            // 2. Создаем ПАКЕТ (Batch)
            const batch = writeBatch(db);

            // Операция А: Сжигаем код
            batch.update(codeRef, {
                active: false,
                usedBy: user.uid,
                usedAt: serverTimestamp()
            });

            // Операция Б: Обновляем юзера
            batch.set(userRef, {
                subscription: promoData.type, // 'pro' или 'beast'
                expiresAt: new Date(Date.now() + (promoData.days * 86400000)),
                lastUsedCode: code 
            }, { merge: true });

            // 3. Отправляем всё вместе. Если хоть одно правило запретит, отменится ВСЁ.
            await batch.commit();

            alert("Success!");
            location.reload();

        } catch (error) {
            console.error("Hacking attempt failed:", error);
            alert("Error activating code.");
        }
    };

    // === 1. ФУНКЦИЯ КЛИКА ПО АККАУНТУ ===
    window.handleLoginClick = function() {
        if (window.isUserLoggedIn) {
            openSyncInfoModal();
        } else {
            openLoginModal();
        }
    };

    // === 2. ОТКРЫТИЕ ОКНА И ПОДГРУЗКА СТАТИСТИКИ ===
    window.openSyncInfoModal = async function() {
        const user = auth.currentUser;
        if (!user) return;

        document.getElementById('modal-sync-info-overlay').classList.add('open');
        document.getElementById('sync-email-display').innerText = user.email;

        const badge = document.getElementById('sync-plan-badge');
        const expiryText = document.getElementById('sync-plan-expiry');
        badge.innerText = "LOADING...";
        badge.style.color = "var(--text-secondary)";
        expiryText.style.display = "none";

        // Получаем текущие переводы
        const t = langData[currentLang] || langData['en'];

        ['cloud-fav-count', 'cloud-wl-count', 'cloud-hist-count', 'cloud-ban-count'].forEach(id => {
            document.getElementById(id).innerText = "...";
        });

        try {
            const userRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const d = docSnap.data();
                
                // === ПОДПИСКА ===
                const plan = d.subscription || 'free';
                badge.innerText = plan.toUpperCase();
                
                if (plan === 'pro') badge.style.color = '#ff9900';
                else if (plan === 'beast') badge.style.color = '#9b59b6';
                else badge.style.color = 'var(--text-main)';

                if (plan !== 'free' && d.expiresAt) {
                    const dateObj = d.expiresAt.toDate(); 
                    const dateStr = dateObj.toLocaleDateString();
                    const daysLeft = Math.ceil((dateObj - new Date()) / (1000 * 60 * 60 * 24));
                    
                    if (daysLeft > 0) {
                        // ИСПОЛЬЗУЕМ ПЕРЕВОДЫ
                        expiryText.innerText = `${t.sub_exp} ${dateStr} (${daysLeft}${t.time_d})`;
                        expiryText.style.display = "inline";
                    } else {
                        expiryText.innerText = t.sub_expired; // "Истекла"
                        expiryText.style.display = "inline";
                        expiryText.style.color = "var(--highlight-red)";
                    }
                }
                // ================

                document.getElementById('cloud-fav-count').innerText = d.favorites ? d.favorites.length : 0;
                document.getElementById('cloud-wl-count').innerText = d.watchLater ? d.watchLater.length : 0;
                document.getElementById('cloud-hist-count').innerText = d.history ? d.history.length : 0;
                document.getElementById('cloud-ban-count').innerText = d.blacklist ? d.blacklist.length : 0;
            } else {
                badge.innerText = "FREE";
                ['cloud-fav-count', 'cloud-wl-count', 'cloud-hist-count', 'cloud-ban-count'].forEach(id => {
                    document.getElementById(id).innerText = "0";
                });
            }
        } catch (e) {
            console.error("Error fetching sync stats:", e);
            badge.innerText = "ERROR";
        }
    };

    window.closeSyncInfoModal = function(e, force) {
        if (force || e.target.id === 'modal-sync-info-overlay') {
            document.getElementById('modal-sync-info-overlay').classList.remove('open');
        }
    };

    // === 3. РУЧНАЯ СИНХРОНИЗАЦИЯ (MERGE) ===
    window.performManualSync = async function() {
        const user = auth.currentUser;
        if (!user) return;

        const btn = document.getElementById('btn-manual-sync');
        const btnText = document.getElementById('sync-btn-text');
        const originalText = btnText.innerText;
        
        // Получаем перевод для успеха
        const t = langData[currentLang] || langData['en'];
        const successText = t.sync_btn_success || "✅ Done! Reloading...";

        // Блокируем кнопку и включаем спиннер
        btn.disabled = true;
        btnText.innerHTML = `<span class="spinning-icon">↻</span> Syncing...`;
        
        try {
            await loadUserData(user); // Это твоя функция слияния

            // УСПЕХ
            btnText.innerHTML = successText;
            btn.style.background = "var(--highlight-green)"; // Зеленый цвет
            btn.style.color = "#fff";

            // АВТОМАТИЧЕСКАЯ ПЕРЕЗАГРУЗКА ЧЕРЕЗ 1.5 СЕК
            setTimeout(() => {
                location.reload();
            }, 1500);

        } catch (e) {
            console.error("Manual sync failed:", e);
            btnText.innerText = "❌ Error";
            setTimeout(() => {
                btnText.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        }
    };

    // === СЛУШАТЕЛЬ АВТОРИЗАЦИИ (Главная точка входа) ===
    onAuthStateChanged(auth, async (user) => {
        const btnText = document.getElementById('login-btn-text');
        const btnIcon = document.getElementById('login-status-icon');
        
        // Получаем текущие переводы
        const currentLang = localStorage.getItem('xch_lang') || 'en';
        const t = (typeof langData !== 'undefined' && langData[currentLang]) ? langData[currentLang] : langData['en'];

        if (user) {
            // === ПОЛЬЗОВАТЕЛЬ ВОШЕЛ ===
            window.isUserLoggedIn = true;
            console.log("Authorized:", user.email);
            
            // 1. Обновляем интерфейс кнопки (Личный кабинет + Email)
            if(btnText) {
                const activeText = t.personal_account || "Personal Account";
                const shortEmail = user.email.split('@')[0]; // Берем часть до @
                btnText.innerHTML = `${activeText} <span style="font-size:12px; opacity:0.6; font-weight:400; margin-left:6px;">${shortEmail}</span>`;
            }
            
            // Иконка человека
            if(btnIcon) {
                btnIcon.innerText = "👤"; 
                btnIcon.style.color = "var(--accent)";
            }

            // 2. Обновляем дату синхронизации и грузим данные
            if (window.updateLastSyncUI) window.updateLastSyncUI();
            await loadUserData(user); 

            // 3. Проверка промокода в URL (если перешли по ссылке)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                await window.activatePromoCode(code);
            }
        } else {
            // === ПОЛЬЗОВАТЕЛЬ ВЫШЕЛ ===
            window.isUserLoggedIn = false;
            
            // Возвращаем исходный вид кнопки
            if(btnText) btnText.innerText = t.login_text || "Sync / Login";
            if(btnIcon) {
                btnIcon.innerText = "☁️"; // Иконка облака
                btnIcon.style.color = "var(--text-secondary)";
            }
            
            if (window.updateLastSyncUI) window.updateLastSyncUI();
        }

        if (user && user.uid === ADMIN_UID) {
            // Показываем кнопку в меню аккаунта
            const btn = document.getElementById('btn-admin-trigger');
            if(btn) btn.style.display = 'flex';
        }
    });

    // 2. Генерация промокода
    window.adminGenerateCode = async function() {
        const user = auth.currentUser;
        if (!user || user.uid !== ADMIN_UID) return;

        const type = document.getElementById('admin-code-type').value;
        const days = parseInt(document.getElementById('admin-code-days').value);
        
        // Генерируем читаемый код (XF-TYPE-XXXX)
        const randomPart = Math.random().toString(36).substr(2, 5).toUpperCase();
        const code = `XF-${type.toUpperCase()}-${randomPart}`;

        try {
            await setDoc(doc(db, "promocodes", code), {
                active: true,
                type: type,
                days: days,
                createdAt: serverTimestamp(),
                createdBy: "admin_ui"
            });
            document.getElementById('admin-code-result').innerText = code;
            alert(`Code created: ${code}`);
        } catch (e) {
            alert("Error: " + e.message);
        }
    };

    // 3. Выдача подписки по Email
    window.adminGiftSub = async function() {
        const user = auth.currentUser;
        if (!user || user.uid !== ADMIN_UID) return;

        const targetEmail = document.getElementById('admin-gift-email').value.trim();
        const type = document.getElementById('admin-gift-type').value;
        const days = parseInt(document.getElementById('admin-gift-days').value);

        if (!targetEmail) { alert("Enter email!"); return; }

        const btn = event.target;
        btn.innerText = "Searching...";
        btn.disabled = true;

        try {
            // Ищем пользователя в базе по полю email
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", targetEmail));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("User not found in Database. Ask them to Login/Sync first.");
                btn.innerText = "Activate Sub";
                btn.disabled = false;
                return;
            }

            // Берем первого найденного 
            let targetUserDoc = null;
            querySnapshot.forEach((doc) => { targetUserDoc = doc; });

            // Вычисляем дату
            const now = new Date();
            const expireDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));

            // Обновляем документ ЧУЖОГО пользователя
            await updateDoc(targetUserDoc.ref, {
                subscription: type,
                expiresAt: Timestamp.fromDate(expireDate)
            });

            alert(`Success! ${targetEmail} is now ${type} for ${days} days.`);
            document.getElementById('admin-gift-email').value = "";

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            btn.innerText = "Activate Sub";
            btn.disabled = false;
        }
    };

    // 4. Сброс подписки до FREE по Email
    window.adminResetSub = async function() {
        const user = auth.currentUser;
        
        if (!user || user.uid !== ADMIN_UID) return;

        const targetEmail = document.getElementById('admin-reset-email').value.trim();

        if (!targetEmail) { alert("Enter email!"); return; }
        if (!confirm(`Are you sure you want to RESET subscription for ${targetEmail}?`)) return;

        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "Processing...";
        btn.disabled = true;

        try {
            // 1. Ищем пользователя по Email
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", targetEmail));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("User not found via Email. They need to Login/Sync first.");
                return;
            }

            // Берем первого найденного
            let targetUserDoc = null;
            querySnapshot.forEach((doc) => { targetUserDoc = doc; });

            // 2. Сбрасываем подписку
            await updateDoc(targetUserDoc.ref, {
                subscription: "free",       // Ставим статус free
                expiresAt: deleteField()    // Полностью удаляем поле даты окончания
            });

            alert(`Done! ${targetEmail} is now Free.`);
            document.getElementById('admin-reset-email').value = "";

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            btn.innerText = oldText;
            btn.disabled = false;
        }
    };

    // === ЗАГРУЗКА И СЛИЯНИЕ ДАННЫХ (СЕРДЦЕ СИНХРОНИЗАЦИИ) ===
    async function loadUserData(user) {
        const userRef = doc(db, "users", user.uid);
        
        try {
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                console.log("Cloud data received. Merging smart...");

                // --- 1. ЛАЙКИ, ЧС, WATCH LATER (Множества) ---
                // Объединяем уникальные ID
                const localFav = window.favorites || [];
                const cloudFav = cloudData.favorites || [];
                const mergedFav = [...new Set([...localFav, ...cloudFav])];

                const localBan = window.blacklist || [];
                const cloudBan = cloudData.blacklist || [];
                const mergedBan = [...new Set([...localBan, ...cloudBan])];

                const localWL = window.watchLater || [];
                const cloudWL = cloudData.watchLater || [];
                const mergedWL = [...new Set([...localWL, ...cloudWL])];

                // --- 2. ИСТОРИЯ И ЛОГИ (Умное слияние) ---
                
                // А. История
                const localHist = window.historyData || [];
                const cloudHist = cloudData.history || [];
                const combinedHistMap = new Map();
                
                [...localHist, ...cloudHist].forEach(item => combinedHistMap.set(item.id, item));
                
                const mergedHistory = Array.from(combinedHistMap.values())
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 50); // В памяти держим топ-50 для UI истории

                // Б. Лог Активности (Самое важное для веса)
                const localLog = window.activityLog || [];
                const cloudLog = cloudData.activityLog || [];
                const combinedLogMap = new Map();
                
                // Ключ уникальности: "timestamp_id". 
                // Это позволит слить два массива без дублей, но сохранив всю историю.
                [...localLog, ...cloudLog].forEach(item => combinedLogMap.set((item.ts || 0) + "_" + item.id, item));
                
                const mergedActivityLog = Array.from(combinedLogMap.values())
                    .sort((a, b) => a.ts - b.ts)
                    .slice(-5000); // Локально храним до 5000 записей для статистики

                // В. История просмотров (Watch History)
                const localWatch = window.watchHistory || [];
                const cloudWatch = cloudData.watchHistory || [];
                const combinedWatchMap = new Map();
                
                // Сливаем по timestamp (времени), чтобы убрать дубликаты
                [...localWatch, ...cloudWatch].forEach(item => combinedWatchMap.set(item.timestamp, item));
                
                const mergedWatchHistory = Array.from(combinedWatchMap.values())
                    .sort((a, b) => b.timestamp - a.timestamp) // Сортируем: новые сверху
                    .slice(0, 100); // Храним последние 100 записей

                // --- 3. ВЕСА ТЕГОВ (Tag Scores) ---
                // Берем максимум из локального и облачного веса
                const localScores = window.tagScores || {};
                const cloudScores = cloudData.tagScores || {};
                const mergedScores = { ...cloudScores };
                
                for (const [tag, score] of Object.entries(localScores)) {
                    // Если тег есть в обоих местах, берем тот, где вес больше (значит он актуальнее/важнее)
                    // Либо можно просто суммировать, но max безопаснее от накрутки
                    if (mergedScores[tag]) {
                        if (Math.abs(score) > Math.abs(mergedScores[tag])) {
                            mergedScores[tag] = score;
                        }
                    } else {
                        mergedScores[tag] = score;
                    }
                }

                // --- 4. НАСТРОЙКИ ---
                let mergedPlatform = localStorage.getItem('xch_platform') || 'xh';
                if (cloudData.platform) mergedPlatform = cloudData.platform;

                if (cloudData.subscription) {
                    localStorage.setItem('xch_sub_level', cloudData.subscription);
                    if (window.updateSubscriptionUI) window.updateSubscriptionUI();
                }

                // === ПРИМЕНЕНИЕ ДАННЫХ (APPLY) ===
                
                // А. Обновляем память (window)
                window.favorites = mergedFav;
                window.blacklist = mergedBan;
                window.watchLater = mergedWL;
                window.historyData = mergedHistory;
                window.tagScores = mergedScores;
                window.activityLog = mergedActivityLog;
                window.watchHistory = mergedWatchHistory;

                // Б. Обновляем LocalStorage (Полные версии)
                localStorage.setItem('xch_favorites', JSON.stringify(mergedFav));
                localStorage.setItem('xch_blacklist', JSON.stringify(mergedBan));
                localStorage.setItem('xch_watch_later', JSON.stringify(mergedWL));
                localStorage.setItem('xch_history', JSON.stringify(mergedHistory));
                localStorage.setItem('xch_tag_scores', JSON.stringify(mergedScores));
                localStorage.setItem('xch_activity_log', JSON.stringify(mergedActivityLog));
                localStorage.setItem('xch_watch_history', JSON.stringify(mergedWatchHistory));
                localStorage.setItem('xch_platform', mergedPlatform);

                // В. Обновляем UI
                const now = Date.now();
                localStorage.setItem('xch_last_sync_ts', now);
                if (window.updateLastSyncUI) window.updateLastSyncUI();

                if (typeof updateCounts === 'function') updateCounts();
                if (typeof updateExploredCount === 'function') updateExploredCount();
                if (typeof renderHistory === 'function') renderHistory();
                if (typeof updateActionButtons === 'function') updateActionButtons();
                
                const platEl = document.getElementById('platform');
                if (platEl) { 
                    platEl.value = mergedPlatform; 
                    if (typeof updateLink === 'function') updateLink(); 
                }

                console.log(`Merge complete. History: ${mergedHistory.length}, Log: ${mergedActivityLog.length}`);
                
                window.syncToCloud(false); // Отложенная синхронизация результата

            } else {
                console.log("No cloud data. Creating initial backup...");
                if (window.syncToCloud) window.syncToCloud(true);
            }
        } catch (error) {
            console.error("Error loading data:", error);
        }
    }

    // === АВТО-СОХРАНЕНИЕ В ОБЛАКО ===
    window.syncToCloud = async function(immediate = false) {
        const user = auth.currentUser;
        if (!user) return; 

        const performSave = async () => {
            const userRef = doc(db, "users", user.uid);
            const currentPlatform = document.getElementById('platform') ? document.getElementById('platform').value : 'xh';
            
            const fullLog = window.activityLog || [];
            const fullHistory = window.historyData || [];
            
            const cloudLog = fullLog.slice(-200); 
            const cloudHistory = fullHistory.slice(-100);

            const dataToSave = {
                favorites: JSON.parse(localStorage.getItem('xch_favorites')) || [],
                blacklist: JSON.parse(localStorage.getItem('xch_blacklist')) || [],
                watchLater: JSON.parse(localStorage.getItem('xch_watch_later')) || [],
                tagScores: JSON.parse(localStorage.getItem('xch_tag_scores')) || {},
                history: cloudHistory,
                activityLog: cloudLog,
                watchHistory: window.watchHistory || [],
                platform: currentPlatform,
                subscription: localStorage.getItem('xch_sub_level') || 'free', 
                email: user.email,
                lastUpdated: serverTimestamp()
            };

            try {
                await setDoc(userRef, dataToSave, { merge: true });
                
                const now = Date.now();
                localStorage.setItem('xch_last_sync_ts', now);
                if(window.updateLastSyncUI) window.updateLastSyncUI();
                
                console.log(`☁️ Synced`);
            } catch (e) {
                console.error("Auto-save error:", e);
            }
        };

        if (syncTimeout) clearTimeout(syncTimeout);

        if (immediate) {
            await performSave();
        } else {
            syncTimeout = setTimeout(performSave, 5000);
        }
    };
</script>

<script>
    let currentLang = 'en';
    let subscriptionLevel = localStorage.getItem('xch_sub_level') || 'free';
    let currentOrientation = localStorage.getItem('xch_orientation') || 'hetero';
    let cooldownList = [];
    const COOLDOWN_SIZE = 20;
    const TAG_DECAY_RATE = 0.98;
    const WRAPPED_THRESHOLD = 30;
    let data = [];

    const earlySponsors = [
        { name: "Alex M.", date: "Jan 2026" },
        { name: "CryptoWhale", date: "Jan 2026" }
    ];

    const TAG_ICONS = {
        // БДСМ / Жесткое
        'bdsm': ['bdsm1.png', 'bdsm2.png'], 
        'bondage': ['bondage1.png', 'bondage2.png'],

        // Анал / Попы
        'anal': ['anal1.png', 'anal2.png', 'anal3.png'],

        // Ноги
        'feet': ['feet1.png', 'feet2.png'],
        
        // Групповое
        'group': ['group1.png', 'group2.png', 'group3.png'],

        // ЛГБТ
        'lesbian': ['lesbian1.png', 'lesbian2.png','lesbian3.png'],
        'gay': ['gay1.png', 'gay2.png', 'gay3.png'],
        'trans': ['trans1.png', 'trans2.png', 'trans3.png'],

        // Игрушки
        'toys': ['toys1.png', 'toys2.png'],

        // Романтика / Ваниль
        'romantic': ['romantic1.png', 'romantic2.png']
    };

    // 2. Нейтральные иконки
    const NEUTRAL_DECOS = [
        'deco1.png', 'deco2.png', 'deco3.png', 'deco4.png', 'deco5.png',
        'deco6.png', 'deco7.png', 'deco8.png', 'deco9.png', 'deco10.png', 'deco11.png'
    ];

    let watchStartTime = 0; // Время ухода с сайта

    // Слушатель возвращения на вкладку
    document.addEventListener("visibilitychange", () => {
        // Если вкладка стала видимой И мы засекали время
        if (document.visibilityState === "visible" && watchStartTime > 0) {
            calculateWatchTime();
        }
    });

    const DAILY_LIMIT = 10;
    let currentItem = null;
    let lastGeneratedItem = null; 
    let hasInteractedWithCurrent = false;

    let pendingPlan = null;

    let activeMods = new Set();
    let isGenerating = false;
    let isFirstGen = true;
    let hasWatchedCurrentItem = false;
    let currentIntensity = 1; 
    
    // STATS STATE
    let currentStatsTab = 'tags';
    let currentStatsTimeframe = 'all';

    // Tinder
    let startX = 0, startY = 0;
    let currentX = 0, currentY = 0;
    let isDragging = false;
    const card = document.getElementById('card-block');
    const overlayLike = document.querySelector('.overlay-like');
    const overlayNope = document.querySelector('.overlay-nope');

    let sessionHistoryStack = [];

    let onboardingSelectedIds = [];

    let currentSlideIndex = 0;
    let slideInterval;
    let itemBeingWatched = null; 
    let currentHistoryTab = 'swipes';

    let currentAppMode = 'explore';
    let isModeSelectActive = false; 
    
    const STORAGE = {
        THEME: 'xch_theme',
        LANG: 'xch_lang',
        BLACKLIST: 'xch_blacklist',
        FAVORITES: 'xch_favorites',
        WATCH_LATER: 'xch_watch_later',
        INTENSITY: 'xch_intensity',
        TAG_SCORES: 'xch_tag_scores',
        HISTORY: 'xch_history',
        ACTIVITY_LOG: 'xch_activity_log',
        WATCH_HISTORY: 'xch_watch_history'
    };

    const APP_THEMES = [
        // === BASIC (Row 1) ===
        { id: 'dark', name: 'Dark', type: 'free', isLight: false, preview: '#141414', accent: null },
        { id: 'light', name: 'Light', type: 'free', isLight: true, preview: '#ffffff', accent: null },
        
        // === BLUE (Row 2) ===
        { 
            id: 'blue-dark', name: 'Midnight', type: 'pro', isLight: false, preview: '#0a192f',
            colors: { bg: '#020c1b', sidebar: '#0a192f', card: '#112240', nav: '#112240', border: '#233554' },
            accent: '#64ffda', accentLight: '#94ffea'
        },
        { 
            id: 'blue-light', name: 'Sky', type: 'pro', isLight: true, preview: '#cce4ff',
            colors: { bg: '#dbeafe', sidebar: '#f0f9ff', card: '#ffffff', nav: '#ffffff', border: '#bfdbfe' },
            accent: '#2563eb', accentLight: '#60a5fa' 
        },

        // === GREEN (Row 3) ===
        { 
            id: 'green-dark', name: 'Forest', type: 'pro', isLight: false, preview: '#051405',
            colors: { bg: '#020a02', sidebar: '#051405', card: '#0f290f', nav: '#0f290f', border: '#1a401a' },
            accent: '#2ecc71', accentLight: '#58d68d'
        },
        { 
            id: 'green-light', name: 'Mint', type: 'pro', isLight: true, preview: '#dcfce7',
            colors: { bg: '#dcfce7', sidebar: '#f0fdf4', card: '#ffffff', nav: '#ffffff', border: '#86efac' },
            accent: '#16a34a', accentLight: '#4ade80'
        },

        // === RED (Row 4) ===
        { 
            id: 'red-dark', name: 'Vampire', type: 'pro', isLight: false, preview: '#1a0000',
            colors: { bg: '#0d0000', sidebar: '#1a0000', card: '#330000', nav: '#330000', border: '#4d0000' },
            accent: '#e74c3c', accentLight: '#ff6b6b'
        },
        { 
            id: 'red-light', name: 'Rose', type: 'pro', isLight: true, preview: '#ffe4e6',
            colors: { bg: '#ffe4e6', sidebar: '#fff1f2', card: '#ffffff', nav: '#ffffff', border: '#fecdd3' },
            accent: '#e11d48', accentLight: '#fb7185'
        },

        // === GOLD / ORANGE (Row 5) ===
        { 
            id: 'gold-dark', name: 'Luxury', type: 'pro', isLight: false, preview: '#141100',
            colors: { bg: '#0a0900', sidebar: '#141100', card: '#292200', nav: '#292200', border: '#4d4000' },
            accent: '#f1c40f', accentLight: '#f4d03f'
        },
        { 
            id: 'gold-light', name: 'Sand', type: 'pro', isLight: true, preview: '#fef3c7',
            colors: { bg: '#fef3c7', sidebar: '#fffbeb', card: '#ffffff', nav: '#ffffff', border: '#fde68a' },
            accent: '#d97706', accentLight: '#fbbf24'
        },

        // === PINK (Row 6) ===
        { 
            id: 'pink-dark', name: 'Cyber', type: 'pro', isLight: false, preview: '#ff00cc',
            colors: { bg: '#12000b', sidebar: '#1a0010', card: '#2b001b', nav: '#2b001b', border: '#4d0030' },
            accent: '#ff00cc', accentLight: '#ff66e0'
        },
        { 
            id: 'pink-light', name: 'Sakura', type: 'pro', isLight: true, preview: '#ffeef8',
            colors: { bg: '#ffeef8', sidebar: '#fff5fb', card: '#ffffff', nav: '#ffffff', border: '#fbcfe8' },
            accent: '#db2777', accentLight: '#f472b6'
        },

        // === PURPLE (Row 7) ===
        { 
            id: 'purple-dark', name: 'Amethyst', type: 'pro', isLight: false, preview: '#3b005e',
            colors: { bg: '#0d0014', sidebar: '#180026', card: '#240038', nav: '#240038', border: '#4a0072' },
            accent: '#9d00ff', accentLight: '#c466ff'
        },
        { 
            id: 'purple-light', name: 'Lavender', type: 'pro', isLight: true, preview: '#f3e8ff',
            colors: { bg: '#f3e8ff', sidebar: '#faf5ff', card: '#ffffff', nav: '#ffffff', border: '#d8b4fe' },
            accent: '#9333ea', accentLight: '#c084fc'
        },

        // === ORANGE (Row 8) ===
        { 
            id: 'orange-dark', name: 'Magma', type: 'pro', isLight: false, preview: '#331a00',
            colors: { bg: '#0f0700', sidebar: '#1f0f00', card: '#331a00', nav: '#331a00', border: '#663300' },
            accent: '#ff6600', accentLight: '#ff9933'
        },
        { 
            id: 'orange-light', name: 'Peach', type: 'pro', isLight: true, preview: '#fff7ed',
            colors: { bg: '#fff7ed', sidebar: '#fffaf5', card: '#ffffff', nav: '#ffffff', border: '#fed7aa' },
            accent: '#ea580c', accentLight: '#fb923c'
        },

        // === SPECIAL (Row 9) ===
        { 
            id: 'noir', name: 'Noir', type: 'pro', isLight: false, preview: '#000000',
            colors: { bg: '#000000', sidebar: '#0a0a0a', card: '#141414', nav: '#141414', border: '#333333' },
            accent: '#ffffff', accentLight: '#cccccc'
        },
        { 
            id: 'rainbow', name: 'Rainbow', type: 'pro', isLight: false, 
            preview: 'linear-gradient(135deg, #ff0000, #ffff00, #0000ff)',
            isRainbow: true,
            accent: null 
        }
    ];
    
    let blacklist = JSON.parse(localStorage.getItem(STORAGE.BLACKLIST)) || [];
    let favorites = JSON.parse(localStorage.getItem(STORAGE.FAVORITES)) || [];
    let watchLater = JSON.parse(localStorage.getItem(STORAGE.WATCH_LATER)) || [];
    let tagScores = JSON.parse(localStorage.getItem(STORAGE.TAG_SCORES)) || {};
    let historyData = JSON.parse(localStorage.getItem(STORAGE.HISTORY)) || [];
    let watchHistory = JSON.parse(localStorage.getItem(STORAGE.WATCH_HISTORY)) || [];
    let activityLog = JSON.parse(localStorage.getItem(STORAGE.ACTIVITY_LOG)) || [];

    const modifiersData = [
        { key: 'Amateur', en: 'Amateur', ru: 'Любительское', es: 'Amateur', de: 'Amateur' },
        { key: 'POV', en: 'POV', ru: 'POV', es: 'POV', de: 'POV' },
        { key: 'Hardcore', en: 'Hardcore', ru: 'Жесткое', es: 'Hardcore', de: 'Hardcore' },
        { key: 'Homemade', en: 'Homemade', ru: 'Домашнее', es: 'Casero', de: 'Hausgemacht' },
        { key: 'Oiled', en: 'Oiled', ru: 'В масле', es: 'Aceite', de: 'Eingeölt' },
        { key: 'Gay', en: 'Gay', ru: 'Геи', es: 'Gay', de: 'Schwul' },
        { key: 'BBW', en: 'BBW', ru: 'BBW', es: 'BBW', de: 'BBW' },
        { key: 'Lesbian', en: 'Lesbian', ru: 'Лесби', es: 'Lesbianas', de: 'Lesbisch' },
        { key: 'Trans', en: 'Trans', ru: 'Транс', es: 'Trans', de: 'Trans' },
        { key: 'Orgy', en: 'Orgy', ru: 'Оргия', es: 'Orgía', de: 'Orgie' },
        { key: 'VR', en: 'VR', ru: 'VR', es: 'RV (VR)', de: 'VR' },
        { key: 'Compilation', en: 'Compilation', ru: 'Сборник', es: 'Compilación', de: 'Kompilation' },
        { key: 'Vintage', en: 'Vintage', ru: 'Ретро', es: 'Vintage', de: 'Vintage' },
        { key: 'Solo', en: 'Solo', ru: 'Соло', es: 'Solo', de: 'Solo' },
        { key: 'AI', en: 'AI', ru: 'ИИ', es: 'IA', de: 'KI' },
        { key: 'Squirt', en: 'Squirt', ru: 'Сквирт', es: 'Squirt', de: 'Squirt' },
        { key: 'Cowgirl', en: 'Cowgirl', ru: 'Наездница', es: 'Vaquera', de: 'Reiterstellung' },
    ];

    const welcomePhrases = {
        en: ["Ready to find your genre? 😈", "Spin the wheel of lust!", "Let fate decide...", "Waiting for your command..."],
        ru: ["Готов узнать свой жанр? 😈", "Крути барабан желаний!", "Судьба решит, что тебя ждёт...", "Жду твоего нажатия..."],
        es: ["¿Listo para tu género? 😈", "¡Gira la rueda del deseo!", "Deja que el destino decida...", "Esperando tu orden..."],
        de: ["Bereit für dein Genre? 😈", "Dreh das Rad der Lust!", "Lass das Schicksal entscheiden...", "Warte auf deinen Befehl..."]
    };

    // === Фразы для напоминания о Watch Later ===
    const wlReminderPhrases = {
        en: [
            "Seems like you wanted to watch this... 👀",
            "You saved this for later. Is 'later' now? 😏",
            "A reminder from your personal stash 📂",
            "Don't let this wait forever 🔥",
            "Your past self had good taste ✨"
        ],
        ru: [
            "Кажется, ты хотел это посмотреть... 👀",
            "Ты отложил это на потом. 'Потом' наступило? 😏",
            "Напоминание из твоей личной коллекции 📂",
            "Не заставляй это ждать вечно 🔥",
            "У твоего прошлого 'я' был отличный вкус ✨"
        ],
        es: [
            "Parece que querías ver esto... 👀",
            "Guardaste esto para luego. ¿Es ahora? 😏",
            "Un recordatorio de tu colección personal 📂",
            "No lo hagas esperar para siempre 🔥",
            "Tu yo del pasado tenía buen gusto ✨"
        ],
        de: [
            "Scheint, als wolltest du das sehen... 👀",
            "Du hast das für später gespeichert. Ist jetzt 'später'? 😏",
            "Eine Erinnerung aus deiner Sammlung 📂",
            "Lass es nicht ewig warten 🔥",
            "Dein früheres Ich hatte guten Geschmack ✨"
        ]
    };

    // === Фразы для напоминания о ЛЮБИМОМ (Favorites) ===
    const favReminderPhrases = {
        en: [
            "Let's remember this gem? 💎",
            "A classic from your collection ✨",
            "Ready for round two? 🔄",
            "You loved this one. Still do? 😏",
            "Oldie but goldie 🔥"
        ],
        ru: [
            "Давай вспомним это ещё раз? 💎",
            "Классика твоей коллекции ✨",
            "Готов ко второму раунду? 🔄",
            "Тебе это нравилось. Всё ещё? 😏",
            "Старый друг лучше новых двух 🔥"
        ],
        es: [
            "¿Recordamos esta joya? 💎",
            "Un clásico de tu colección ✨",
            "¿Listo para la segunda ronda? 🔄",
            "Te encantó esto. ¿Aún te gusta? 😏",
            "Viejo pero bueno 🔥"
        ],
        de: [
            "Erinnern wir uns an dieses Juwel? 💎",
            "Ein Klassiker aus deiner Sammlung ✨",
            "Bereit für Runde zwei? 🔄",
            "Du hast das geliebt. Immer noch? 😏",
            "Alt aber gold 🔥"
        ]
    };

    // === Фразы для ВТОРОГО ШАНСА (Blacklist) ===
    const banReminderPhrases = {
        en: [
            "Maybe give it another shot? 🤔",
            "Tastes change... do yours? 🤨",
            "Are you sure you hate this? 🧐",
            "Everyone deserves a second chance 👻",
            "Risky click of the day 🎲"
        ],
        ru: [
            "Может дашь ещё шанс? 🤔",
            "Вкусы меняются... а твои? 🤨",
            "Точно уверен, что не нравится? 🧐",
            "Все заслуживают второй шанс 👻",
            "Рискнём ещё разок? 🎲"
        ],
        es: [
            "¿Quizás darle otra oportunidad? 🤔",
            "Los gustos cambian... ¿los tuyos? 🤨",
            "¿Seguro que odias esto? 🧐",
            "Todos merecen una segunda oportunidad 👻",
            "El riesgo del día 🎲"
        ],
        de: [
            "Vielleicht noch eine Chance geben? 🤔",
            "Geschmäcker ändern sich... deiner auch? 🤨",
            "Sicher, dass du das hasst? 🧐",
            "Jeder verdient eine zweite Chance 👻",
            "Risiko des Tages 🎲"
        ]
    };

    const animationPhrases = {
        en: ["Finding your fetish...", "Scanning the hub...", "What will it be?", "Looking for spicy stuff..."],
        ru: ["Ищем твой фетиш...", "Сканируем хаб...", "Что же выпадет?", "Подбираем погорячее..."],
        es: ["Buscando tu fetiche...", "Escaneando el hub...", "¿Qué será?", "Buscando algo picante..."],
        de: ["Suche deinen Fetisch...", "Scanne den Hub...", "Was wird es sein?", "Suche etwas Scharfes..."]
    };

    const resultComments = {
        en: ["Like it? Go watch 😈", "Not bad, huh? 😏", "Enjoy your time 🔥", "Go for it! 😀"],
        ru: ["Заинтересовало? Иди и смотри 😈", "Неплохой фетиш, а? 😏", "Приятного просмотра 🔥", "Ну всё, беги смотреть! 😀"],
        es: ["¿Te gusta? Ve a verlo 😈", "Nada mal, ¿eh? 😏", "Disfruta tu tiempo 🔥", "¡Ve por ello! 😀"],
        de: ["Gefällt es dir? Schau es an 😈", "Nicht schlecht, oder? 😏", "Viel Spaß 🔥", "Tu es! 😀"]
    };

    const langData = {
        en: {
            // --- 1. General & Navigation ---
            subtitle: "Your home for adult preferences",
            lang_label: "Language",
            nav_home: "Home",
            nav_settings: "Settings",
            nav_account: "Account",
            header_prefs: "Preferences",
            ori_label: "Orientation",
            ori_hetero: "Hetero",
            ori_gay: "Gay",
            ori_trans: "Trans",
            ori_pan: "Pansexual",
            header_extras: "Extras",
            theme_label: "Appearance",
            theme_title: "Choose Theme",
            theme_basic: "Basic",
            theme_premium: "Premium Colors",
            btn_start: "Let's Go",
            btn_pass: "Other",
            btn_like: "Similar",
            btn_upgrade_short: "Upgrade ⇧",
            btn_return: "Return",
            watch_later: "Watch Later",
            empty_wl: "No saved items yet",
            sync_label: "Synced: ",
            expl_undo: "Changed your mind? 😏",
            expl_hist: "From Archives 📜",
            deco_label: "Show Decorations",

            mode_greeting_hint: [
                "Something new 🔭 or familiar favorites 🥰?",
                "Explore the unknown 🔭 or stick to the hits 🥰?",
                "Feeling adventurous 🔭 or nostalgic 🥰?",
                "Trust the algorithm 🔭 or trust your gut 🥰?"
            ],
            mode_explore: "Explore",
            mode_pleasure: "Pleasure",

            info_header: "Information",
            hist_tab_swipes: "Swipes",
            hist_tab_watch: "Time",
            hist_empty_watch: "No watch data yet. Go watch something! 😏",
            hist_watched: "WATCHED",

            status_wl: "In Watch Later",
            status_fav: "Liked",
            status_ban: "Disliked",

            stats_no_data: "No data yet",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Make {n} more moves to unlock your personal summary",
            
            // НОВЫЕ ТЕМЫ
            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amethyst",
            "theme_purple-light": "Lavender",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Peach",
    

            plan_bestie_sub: "Lifetime",
            plan_bestie_price: "/ once",
            badge_limited: "LIMITED OFFER",
            limit_burn: "🔥 ALMOST GONE",
            limit_claimed: "claimed",
            feat_lifetime: "♾️ <b>Lifetime Access</b>",
            feat_onetime: "💸 One-time payment",
            btn_get_bestie: "Get Forever",

            // --- Sponsors ---
            btn_early_sponsors: "Early Sponsors 💎",
            sponsors_title: "Wall of Fame",
            sponsors_desc: "These legends supported xFetishHub at the very beginning by purchasing the Bestie plan. Forever grateful! 💙",

            return_phrases: [
                "A whole {t}. You acted surely 😏",
                "Back after {t}. Did you enjoy it? 🔥",
                "{t}... Quite a session! 😅",
                "You were gone for {t}. Hope it was worth it.",
                "Wow, {t}! Seems like a good choice."
            ],
            return_phrase_short: "Only {t}? That was quick... ⚡",

            reset_phrases: [
                "Sometimes everyone needs a break 🧘",
                "Let's start over...",
                "System reboot 🔄",
                "Peace and quiet...",
                "Clean slate ✨"
            ],

            auth_title: "Sync & Backup",
            auth_p1: "Store history and preferences on all devices",
            auth_p2: "Activate Pro / Beast status",
            auth_p3: "Anonymous storage on Google servers",
            btn_google_signin: "Continue with Google",
            auth_security_note: "Developer has no access to data. Don't worry about your history safety 😏",
            btn_cancel: "Cancel",

            info_header: "Information",
            lbl_support_email: "Support Email",
            doc_terms: "Terms of Use",
            doc_privacy: "Privacy Policy",
            doc_refund: "Refund Policy",

            
            btn_roadmap: "Roadmap",
            roadmap_title: "Roadmap",
            roadmap_desc: "With your active support via subscriptions, xFetishHub will evolve. Here is what we are building:",
            rm_global_title: "Global Intelligence",
            rm_global_desc: "Aggregation of anonymous data to create the smartest recommendation engine. Plus, view global 'Most Loved' and 'Most Hated' charts.",
            rm_coop_title: "Co-op Mode",
            rm_coop_desc: "Invite a partner or friend. They will see what genres you roll in real-time. Perfect for distant couples.",
            rm_content_title: "5000+ Categories",
            rm_content_desc: "Massive database expansion. Every specific micro-fetish and niche genre will be indexed.",
            rm_actors_title: "Actor Selector",
            rm_actors_desc: "A dedicated mode to find pornstars based on your visual preferences and body type filters.",
            rm_support_btn: "Support Development 🚀",
            
            // --- 2. Generator (Main Tab) ---
            generate: "Random Genre",
            generate_again: "Different Genre",
            btn_similar: "Similar",
            watch: "Watch",
            search: "Search", // For Google mode
            related_header: "You may also like:",
            add_genre: "Add to genre:",
            search_en_label: "Search EN",
            site_label: "Site",
            exploration_mode: "Safety Level",
            
            // --- 3. Subscription (Premium) ---
            sub_title: "Premium Access",
            sub_intro: "xFetishHub is a one-of-a-kind project that helps you discover and analyze your adult preferences in one cozy, ad-free place. By subscribing, you ensure the project's survival, and in return, I'll give you significantly more features:",
            
            // Plans Features
            feat_limit: "🎲 10 Generations / day",
            feat_stats_basic: "📊 Basic Statistics",
            feat_filters: "✔️ Standard Filters",
            btn_current: "Current Plan",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / week",
            feat_wrapped_unlim: "✨ <b>Unlimited</b> Fetish Wrapped",

            feat_unlim: "🔥 Unlimited Generations",
            feat_stats_adv: "📈 Advanced Stats & History",
            feat_custom: "🎨 Deep Customization",
            feat_early: "🚀 Early Access features",
            btn_get_pro: "Get Pro",

            feat_all_pro: "👑 All Pro Features",
            feat_sponsors: "💎 Listed in Sponsors",
            feat_discord: "💬 Discord (Dev Chat)",
            feat_vote: "🗳️ Vote on Roadmap",
            btn_get_beast: "Unleash Beast",

            btn_lower_tier: "You deserve better",

            pay_desc: "Select a payment method. You will receive an activation code instantly.",
            pay_stars: "Telegram Stars",
            pay_card: "Card (World)",
            pay_crypto: "Crypto (Anonymous)",
            pay_boosty: "Boosty (RF Cards)",
            pay_code_label: "If you paid, enter code here:",
            pay_code_placeholder: "Activation code...",

            lbl_current_plan: "Current Plan",
            login_alert: "Please log in to manage subscriptions!",

            // --- 4. Account & Data ---
            login_text: "Sync / Login",
            logout_text: "Logout",
            login_required: "Please log in (Sync Data) first so we can identify you!",
            sync_success: "Data synced successfully!",
            btn_open_stats: "Statistics",

            personal_account: "Personal Account",
            
            "theme_blue-dark": "Midnight",
            "theme_green-dark": "Forest",
            "theme_red-dark": "Vampire",
            "theme_gold-dark": "Luxury",
            "theme_noir": "Noir",
            "theme_blue-light": "Sky",
            "theme_green-light": "Mint",
            "theme_red-light": "Rose",
            "theme_gold-light": "Sand",
            "theme_rainbow": "Rainbow",
            "theme_dark": "Dark",
            "theme_light": "Light",

            history_title: "History",
            
            btn_reset: "Reset Data",
            confirm_reset: "Are you sure? This will delete your history, statistics, and preferences learning. This cannot be undone.",
            reset_done: "Data has been reset.",
            
            explored_label: "Explored",
            explored_txt: "{n} / {t} categories",
            report_issue: "Report Issue",

            sync_title: "Cloud Storage",
            sync_desc: "Data stored safely on Google servers",
            sync_tip: "Click 'Synchronize' to merge. <b>Page will reload to apply changes.</b>",
            sync_btn_success: "✅ Done! Reloading...",
            btn_sync: "🔄 Synchronize Device",
            sub_exp: "exp:",
            sub_expired: "Expired",
            time_d: "d",
            
            // --- 5. Lists (Favorites/Blacklist) ---
            favorites_catalog: "Liked",
            blacklist_catalog: "Disliked",
            btn_fav_add: "Favorite",
            btn_fav_remove: "In Favorites",
            btn_ban_add: "Block",
            btn_ban_remove: "Unblock",
            empty: "List is empty (Check filters)!",
            
            // --- 6. Filters ---
            filter_include: "Include",
            filter_exclude: "Exclude",
            tag_fav: "Favorites",
            tag_straight: "Straight", 
            tag_gay: "Gay", 
            tag_lesbian: "Lesbian", 
            tag_trans: "Trans",

            // --- 7. Statistics ---
            btn_stats: "Statistics",
            stats_header: "Your Favorite Categories",
            stats_prefs: "Preferences",
            stats_activity: "Activity",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Come back in a week. Or if you want stats every day, Pro subscription is your best friend.",
            btn_close: "Close",
            search_liked: "Search liked...",
            search_disliked: "Search disliked...",
            hist_empty: "History is empty",
            limit_reset: "Reset:",
            
            tf_week: "Week", 
            tf_month: "Month", 
            tf_year: "Year", 
            tf_all: "All time",
            
            act_gen: "Generations", 
            act_watch: "Watched",
            chart_prefs_x: "Preferences",
            chart_points_y: "Points",
            chart_count_y: "Count",
            share_btn: "Share",

            legend_watch: "Watch (+10)",
            legend_like: "Like / Similar (+5)",
            legend_dislike: "Other / Dislike (-10)",
            act_actions: "Swipes",
            act_watches: "Watches",

            // --- 8. Explanations (Why did I get this?) ---
            expl_fav: "Because you like ",
            expl_sim: "Related to previous",
            expl_rand: "Fate",
            expl_score: "Because you liked ",
            expl_tag_click: "You chose tag: ",

            // --- 9. Badges & Tooltips ---
            badge_extreme: "Extreme",
            badge_desc_extreme: "⚠️ <b>High Intensity</b><br>This category contains rough, intense, or hardcore elements. Not suitable for vanilla preferences.",
            
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>LGBTQ+ Content</b><br>Includes same-sex relationships (Gay/Lesbian) or Transgender content.",
            
            badge_niche: "Niche",
            badge_desc_niche: "🔍 <b>Specific Fetish</b><br>A distinct interest that focuses on specific body parts, objects, or scenarios rather than general sex.",
            
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM & Kink</b><br>Involves bondage, dominance, submission, or sensation play.",

            // --- 10. Modals (Age Gate, Onboarding) ---
            age_title: "Age Verification",
            age_desc: "This website contains age-restricted materials. Are you 18 years or older?",
            age_yes: "Yes, I am 18+",
            age_no: "No, Exit",
            age_block_msg: "This website is only for users over 18 years of age.",
            onb_placeholder: "e.g. I like milf, anal and big tits...",

            // Окно установки
            install_title: "Install App",
            install_desc: "Install app for full-screen mode. Plus, watch videos in the built-in browser to keep your main browser history clean!",
            install_continue: "Continue in Browser",

            btn_install_phone: "Install on Phone",
            qr_title: "Scan to Install",
            qr_desc: "Scan this QR code with your phone camera to open the site, then follow the instructions below:",
            
            inst_ios_1: "Tap the <b>Share</b> button",
            inst_ios_2: "Scroll down and tap",
            inst_ios_btn: "Add to Home Screen",
            inst_ios_3: "Tap <b>Add</b>.",
            
            inst_and_1: "Tap the <b>Menu</b> (3 dots)",
            inst_and_2: "Select",
            inst_and_btn: "Install App / Add to Home",

            onb_title: "Quick Setup",
            onb_desc: "Describe your tastes in one sentence (e.g. 'I love milf, anal and stockings'). We will auto-detect categories.",
            onb_btn_check: "Find Categories",
            onb_found: "We found:",
            onb_btn_confirm: "Add to Favorites",
            onb_skip: "Skip setup",

            lbl_about: "About Project",
            about_title: "Developer",
            about_intro: "I am Nikolai M., 23 years old, student.",
            about_desc: "The project's mission is to allow users to discover all adult genres through a smart recommendation system, as well as provide an opportunity to analyze their tastes for self-discovery.",
            
            terms_text: `
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing and using xFetishHub (the "Service"), you confirm that you are at least 18 years of age (or the age of majority in your jurisdiction) and agree to be bound by these Terms. If you do not agree, you must exit the Service immediately.</p>
                
                <h3>2. Nature of Service</h3>
                <p>xFetishHub is a search aggregator and recommendation engine. <b>We do not host, upload, or control any video content.</b> All links generated by the Service lead to third-party websites (e.g., xHamster, Pornhub). We serve as a conduit for finding content available publicly on the internet.</p>
                
                <h3>3. Third-Party Content</h3>
                <p>We have no control over, and assume no responsibility for, the content, privacy policies, or practices of any third-party websites. You acknowledge and agree that xFetishHub shall not be responsible or liable, directly or indirectly, for any damage or loss caused by your use of any third-party content.</p>
                
                <h3>4. User Accounts & Subscriptions</h3>
                <p>Some features require a paid subscription ("Pro" or "Beast"). Payment processing is handled by third-party providers (e.g., Telegram Stars, Lava, Cryptomus). We do not store your payment credentials. We reserve the right to terminate accounts that violate these Terms.</p>
                
                <h3>5. Disclaimer of Warranties</h3>
                <p>The Service is provided on an "AS IS" and "AS AVAILABLE" basis. We do not warrant that the results generated will meet your requirements or be free of errors.</p>
            `,

            privacy_text: `
                <h3>1. Introduction</h3>
                <p>Your privacy is our priority. This policy explains how we handle your data. We aim to collect the absolute minimum amount of information required to provide our Service.</p>
                
                <h3>2. Data We Collect</h3>
                <ul>
                    <li><b>Authentication Data:</b> When you login via Google, we receive your email address and UID to synchronize your preferences. We do not see your password.</li>
                    <li><b>Usage Data:</b> We store your generated history, favorite tags, and preferences ("liked" or "disliked" categories) locally on your device and encrypted in our database to provide the Service.</li>
                    <li><b>Local Storage:</b> We use browser local storage to save your settings (theme, language, platform preference) without cookies.</li>
                </ul>

                <h3>3. How We Use Data</h3>
                <p>Your data is used solely to:</p>
                <ul>
                    <li>Synchronize your progress across devices.</li>
                    <li>Verify your subscription status.</li>
                    <li>Train the personalization algorithm to improve suggestions.</li>
                </ul>
                <p><b>We do not sell, trade, or rent your personal identification information to others.</b></p>

                <h3>4. Data Deletion</h3>
                <p>You may request full deletion of your account and data at any time by contacting support or using the "Reset Data" button within the app (for local data).</p>
            `,

            refund_text: `
                <h3>1. Digital Goods Policy</h3>
                <p>Due to the nature of digital content, all sales of activation codes and subscriptions for xFetishHub are generally <b>final and non-refundable</b> once the code has been delivered or the subscription activated.</p>
                
                <h3>2. Exceptions</h3>
                <p>We may offer a refund or replacement at our sole discretion under the following circumstances:</p>
                <ul>
                    <li><b>Technical Error:</b> The activation code provided was invalid or defective.</li>
                    <li><b>Non-Delivery:</b> You paid but did not receive the service/code within 24 hours.</li>
                    <li><b>Double Billing:</b> You were charged twice for the same billing period due to a technical glitch.</li>
                </ul>

                <h3>3. How to Request</h3>
                <p>To request a refund, please contact support via the "Report Issue" button or email. Include your transaction ID and the date of purchase. Requests must be made within 14 days of purchase.</p>
            `
        },

        ru: {
            // --- 1. Общее и Навигация ---
            subtitle: "Твой дом для взрослых предпочтений",
            lang_label: "Язык",
            nav_home: "Главная",
            nav_settings: "Настройки",
            nav_account: "Аккаунт", // Исправлено (было Account на ПК)
            header_prefs: "Настройки",
            ori_label: "Ориентация",
            ori_hetero: "Гетеро",
            ori_gay: "Гей",
            ori_trans: "Транс",
            ori_pan: "Пансексуал",
            header_extras: "Дополнительно",
            theme_label: "Оформление",
            theme_title: "Выбор темы",
            theme_basic: "Базовые",
            theme_premium: "Премиум цвета",
            btn_start: "Поехали",
            btn_pass: "Другое",
            btn_like: "Похожее",
            btn_upgrade_short: "Улучш... ⇧",
            btn_return: "Вернуться",
            watch_later: "Смотреть позже",
            empty_wl: "Список пуст",
            sync_label: "Синхр: ",
            expl_undo: "Передумал? 😏",
            expl_hist: "Из архивов 📜",
            deco_label: "Показывать декор",

            mode_greeting_hint: [
                "Что-то новенькое 🔭 или проверенное 🥰?",
                "Эксперименты 🔭 или любимая классика 🥰?",
                "В поиск 🔭 или в зону комфорта 🥰?",
                "Рискнем 🔭 или пойдем по лайкам 🥰?"
            ],

            mode_explore: "Исследование",
            mode_pleasure: "Наслаждение",

            info_header: "Информация",
            hist_tab_swipes: "Свайпы",
            hist_tab_watch: "Время",
            hist_empty_watch: "Данных о просмотрах нет. Иди глянь что-нибудь! 😏",
            hist_watched: "ПРОСМОТРЕНО",

            status_wl: "Смотреть позже",
            status_fav: "В Избранном",
            status_ban: "Не нравится",

            stats_no_data: "Пока нет данных",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Сделайте ещё {n} действий, чтобы открыть личную сводку",

            "theme_pink-dark": "Кибер",
            "theme_pink-light": "Сакура",
            "theme_purple-dark": "Аметист",
            "theme_purple-light": "Лаванда",
            "theme_orange-dark": "Магма",
            "theme_orange-light": "Персик",

            plan_bestie_sub: "Навсегда",
            plan_bestie_price: "/ разово",
            badge_limited: "ОГРАНИЧЕНО",
            limit_burn: "🔥 СКОРО РАЗБЕРУТ",
            limit_claimed: "забрали",
            feat_lifetime: "♾️ <b>Доступ навсегда</b>",
            feat_onetime: "💸 Разовый платёж",
            btn_get_bestie: "Купить навсегда",

            // --- Sponsors ---
            btn_early_sponsors: "Ранние спонсоры 💎",
            sponsors_title: "Зал Славы",
            sponsors_desc: "Эти легенды поддержали xFetishHub в самом начале, купив тариф Bestie. Бесконечно благодарен! 💙",

            return_phrases: [
                "Целых {t}. Ты действовал наверняка 😏",
                "С возвращением спустя {t}. Понравилось? 🔥",
                "{t}... Неплохой марафон! 😅",
                "Тебя не было {t}. Надеюсь, оно того стоило.",
                "Ого, {t}! Кажется, это был отличный выбор."
            ],
            return_phrase_short: "Всего {t}? Быстро ты... ⚡",

            reset_phrases: [
                "Порой всем нужен отдых 🧘",
                "Давай начнём сначала...",
                "Перезагрузка системы 🔄",
                "Тишина и спокойствие...",
                "Чистый лист ✨"
            ],

            auth_title: "Синхронизация",
            auth_p1: "Хранение истории и предпочтений на всех устройствах",
            auth_p2: "Активация Pro / Beast статуса",
            auth_p3: "Анонимное хранение на серверах Google",
            btn_google_signin: "Войти через Google",
            auth_security_note: "Разработчик не имеет доступа к данным. Можешь не беспокоиться о сохранности своей истории 😏",
            btn_cancel: "Отмена",

            info_header: "Информация",
            lbl_support_email: "Почта поддержки",
            doc_terms: "Польз. соглашение",
            doc_privacy: "Политика конф-ти",
            doc_refund: "Политика возвратов",

            btn_roadmap: "Дорожная карта",
            roadmap_title: "Планы развития",
            roadmap_desc: "Благодаря вашей поддержке и подпискам, проект будет развиваться. Вот что мы планируем добавить:",
            rm_global_title: "Глобальный Разум",
            rm_global_desc: "Улучшение рекомендаций на основе анонимной статистики всех пользователей. Топы самых любимых и ненавистных жанров мира.",
            rm_coop_title: "Совместный режим",
            rm_coop_desc: "Пригласите партнера по ссылке. Он будет видеть ваши результаты в реальном времени. Идеально для пар на расстоянии.",
            rm_content_title: "5000+ Категорий",
            rm_content_desc: "Масштабное расширение базы. Каждый микро-фетиш и нишевый жанр будет добавлен в поиск.",
            rm_actors_title: "Поиск Актёров",
            rm_actors_desc: "Отдельный режим для подбора порнозвезд и моделей на основе ваших визуальных предпочтений.",
            rm_support_btn: "Поддержать развитие 🚀",


            // --- 2. Генератор ---
            generate: "Случайный жанр",
            generate_again: "Другой жанр",
            btn_similar: "Похожий",
            watch: "Смотреть",
            search: "Найти",
            related_header: "Вам также может понравиться:",
            add_genre: "Добавить к жанру:",
            search_en_label: "Поиск на Англ.",
            site_label: "Сайт",
            exploration_mode: "Откровенность",

            // --- 3. Подписка (Premium) ---
            sub_title: "Премиум доступ",
            sub_intro: "xFetishHub — это единственный в своём роде проект, который помогает тебе узнать и проанализировать твои взрослые предпочтения в одном уютном месте без рекламы. Если оплатишь подписку, то проект и дальше сможет существовать, а взамен я тебе дам ощутимо больше возможностей:",
            
            // Планы
            feat_limit: "🎲 10 Генераций / день",
            feat_stats_basic: "📊 Базовая статистика",
            feat_filters: "✔️ Стандартные фильтры",
            btn_current: "Текущий план",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / неделю",
            feat_wrapped_unlim: "✨ <b>Безлимитный</b> Wrapped",

            feat_unlim: "🔥 Безлимитные генерации",
            feat_stats_adv: "📈 Расширенные сводки",
            feat_custom: "🎨 Кастомизация",
            feat_early: "🚀 Ранний доступ к функциям",
            btn_get_pro: "Купить Pro",

            feat_all_pro: "👑 Всё, что есть в Pro",
            feat_sponsors: "💎 Имя во вкладке Спонсоры",
            feat_discord: "💬 Доступ в Discord чат",
            feat_vote: "🗳️ Влияние на развитие",
            btn_get_beast: "Стать Зверем",

            btn_lower_tier: "Ты достоен большего",
            pay_desc: "Выберите способ оплаты. Вы получите код активации мгновенно после оплаты.",
            pay_stars: "Telegram Stars",
            pay_card: "Карта (Весь мир)",
            pay_crypto: "Крипта (Анонимно)",
            pay_boosty: "Boosty (Карты РФ)",
            pay_code_label: "Если оплатили, введите код сюда:",
            pay_code_placeholder: "Код активации...",

            lbl_current_plan: "Текущий план",
            login_alert: "Пожалуйста, войдите в аккаунт для управления подпиской!",

            // --- 4. Аккаунт и Данные ---
            login_text: "Вход / Синхронизация",
            personal_account: "Личный кабинет",

            "theme_blue-dark": "Полночь",
            "theme_green-dark": "Лес",
            "theme_red-dark": "Вампир",
            "theme_gold-dark": "Роскошь",
            "theme_noir": "Нуар",
            "theme_blue-light": "Небо",
            "theme_green-light": "Мята",
            "theme_red-light": "Роза",
            "theme_gold-light": "Песок",
            "theme_rainbow": "Радуга",
            "theme_dark": "Тёмная",
            "theme_light": "Светлая",

            history_title: "История",


            logout_text: "Выйти",
            login_required: "Пожалуйста, войдите в аккаунт, чтобы мы могли активировать подписку!",
            sync_success: "Данные синхронизированы!",

            btn_open_stats: "Статистика",

            btn_reset: "Сброс данных",
            confirm_reset: "Вы уверены? Это удалит историю, статистику и обучение алгоритма. Это действие нельзя отменить.",
            reset_done: "Данные сброшены.",

            explored_label: "Открыто",
            explored_txt: "{n} из {t} категорий",
            report_issue: "Сообщить о проблеме",

            sync_title: "Облачное хранилище",
            sync_desc: "Данные безопасно хранятся на серверах Google",
            sync_tip: "Нажми «Синхронизировать» для объединения. <b>Страница перезагрузится.</b>",
            sync_btn_success: "✅ Готово! Перезагрузка...",
            btn_sync: "🔄 Синхронизировать",
            sub_exp: "ист:",
            sub_expired: "Истекла",
            time_d: "д",

            // --- 5. Списки ---
            favorites_catalog: "Понравившиеся",
            blacklist_catalog: "Не понравившиеся",
            btn_fav_add: "В Избранное",
            btn_fav_remove: "В Избранном",
            btn_ban_add: "В ЧС",
            btn_ban_remove: "Убрать из ЧС",
            empty: "Пусто (Проверь фильтры)!",

            // --- 6. Фильтры ---
            filter_include: "Включить",
            filter_exclude: "Исключить",
            tag_fav: "Избранное",
            tag_straight: "Гетеро", 
            tag_gay: "Гей", 
            tag_lesbian: "Лесби", 
            tag_trans: "Транс",

            // --- 7. Статистика ---
            btn_stats: "Статистика",
            stats_header: "Ваши любимые категории",
            stats_prefs: "Предпочтения",
            stats_activity: "Активность",
            
            tf_week: "Неделя", 
            tf_month: "Месяц", 
            tf_year: "Год", 
            tf_all: "Всё время",
            
            act_gen: "Генераций", 
            act_watch: "Просмотров",
            chart_prefs_x: "Предпочтения",
            chart_points_y: "Очки",
            chart_count_y: "Кол-во",
            share_btn: "Поделиться",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Приходи сюда снова через неделю. Либо если хочешь статистику каждый день, то Pro подписка будет твоим лучшим другом.",
            btn_close: "Закрыть",
            search_liked: "Поиск любимых...",
            search_disliked: "Поиск нелюбимых...",
            hist_empty: "История пуста",
            limit_reset: "Сброс:",

            legend_watch: "Просмотр (+10)",
            legend_like: "Лайк / Похожее (+5)",
            legend_dislike: "Другое / Дизлайк (-10)",
            act_actions: "Свайпы",
            act_watches: "Просмотры",

            // --- 8. Объяснения ---
            expl_fav: "Потому что ты любишь: ",
            expl_sim: "Похоже на прошлое",
            expl_rand: "Судьба",
            expl_score: "Потому что тебе зашло: ",
            expl_tag_click: "Выбрана категория: ",

            // --- 9. Бейджи ---
            badge_extreme: "Экстрим",
            badge_desc_extreme: "⚠️ <b>Высокая интенсивность</b><br>Категория содержит жесткие или специфические практики. Не для любителей 'ванильного' контента.",
            
            badge_lgbt: "ЛГБТ",
            badge_desc_lgbt: "🏳️‍🌈 <b>ЛГБТ+ Контент</b><br>Включает однополые отношения (Гей/Лесби) или Транс-тематику.",
            
            badge_niche: "Ниша",
            badge_desc_niche: "🔍 <b>Специфичный фетиш</b><br>Узконаправленный интерес, фокусирующийся на определенных частях тела, предметах или сценариях.",
            
            badge_bdsm: "БДСМ",
            badge_desc_bdsm: "⛓️ <b>БДСМ и Фетиш</b><br>Связывание, доминирование, подчинение и игры с ощущениями.",

            // --- 10. Модальные окна ---
            age_title: "Проверка возраста",
            age_desc: "Этот сайт содержит материалы для взрослых. Вам уже исполнилось 18 лет?",
            age_yes: "Да, мне 18+",
            age_no: "Нет, выйти",
            age_block_msg: "Этот сайт предназначен только для пользователей старше 18 лет.",

            onb_placeholder: "например: люблю милф, анал и большую грудь...",
        
            install_title: "Установить приложение",
            install_desc: "Установите приложение для полного экрана. Плюс, смотрите видео во встроенном браузере, чтобы не засорять историю основного браузера!",
            install_continue: "Продолжить в браузере",

            btn_install_phone: "Установить на телефон",
            qr_title: "Сканируйте для установки",
            qr_desc: "Наведите камеру телефона на QR-код, чтобы открыть сайт, затем следуйте инструкции:",
            
            inst_ios_1: "Нажмите кнопку <b>Поделиться</b>",
            inst_ios_2: "Пролистайте вниз и выберите",
            inst_ios_btn: "На экран «Домой»",
            inst_ios_3: "Нажмите <b>Добавить</b>.",
            
            inst_and_1: "Нажмите <b>Меню</b> (3 точки)",
            inst_and_2: "Выберите",
            inst_and_btn: "Установить / Добавить на экран",


            onb_title: "Быстрая настройка",
            onb_desc: "Опишите свои вкусы одним предложением (напр. 'Люблю милф, анал и чулки'). Мы автоматически подберем категории.",
            onb_btn_check: "Найти категории",
            onb_found: "Мы нашли:",
            onb_btn_confirm: "Добавить в избранное",
            onb_skip: "Пропустить",

            lbl_about: "О проекте",
            about_title: "Разработчик",
            about_intro: "Я — Николай М., 23 года, студент.",
            about_desc: "Миссия проекта — позволить пользователям узнать про все жанры для взрослых путём умной системы рекомендаций, а также дать возможность проанализировать свои вкусы для самопознания.",

            terms_text: `
                <h3>1. Принятие условий</h3>
                <p>Используя сервис xFetishHub, вы подтверждаете, что вам исполнилось 18 лет (или больше, в зависимости от законов вашей страны), и вы соглашаетесь с данными условиями. Если вы не согласны, пожалуйста, покиньте сайт.</p>
                
                <h3>2. Суть сервиса</h3>
                <p>xFetishHub является поисковым агрегатором и системой рекомендаций. <b>Мы не храним, не загружаем и не контролируем видеоконтент.</b> Все ссылки ведут на сторонние ресурсы (xHamster, Pornhub и др.). Мы лишь помогаем найти контент, который и так доступен в публичном доступе.</p>
                
                <h3>3. Сторонние ресурсы</h3>
                <p>Мы не несем ответственности за содержание, политику конфиденциальности или действия сторонних сайтов. Переходя по ссылкам, вы действуете на свой страх и риск. Мы не отвечаем за любой ущерб, связанный с использованием внешних ресурсов.</p>
                
                <h3>4. Аккаунты и Подписки</h3>
                <p>Некоторые функции доступны по подписке ("Pro" или "Beast"). Обработка платежей производится сторонними шлюзами (Lava, Cryptomus и др.). Мы не храним данные ваших карт. Мы оставляем за собой право блокировать аккаунты при нарушении правил.</p>
                
                <h3>5. Отказ от ответственности</h3>
                <p>Сервис предоставляется по принципу "КАК ЕСТЬ". Мы не гарантируем, что результаты поиска будут всегда соответствовать вашим ожиданиям или работать без сбоев.</p>
            `,

            privacy_text: `
                <h3>1. Введение</h3>
                <p>Конфиденциальность — наш приоритет. Мы собираем абсолютный минимум данных, необходимый для работы синхронизации.</p>
                
                <h3>2. Сбор данных</h3>
                <ul>
                    <li><b>Авторизация:</b> При входе через Google мы получаем ваш Email и UID для привязки настроек. Мы не видим ваш пароль.</li>
                    <li><b>Данные использования:</b> Мы храним историю генераций, лайки, дизлайки и веса тегов. Это нужно исключительно для работы алгоритма рекомендаций.</li>
                    <li><b>Локальное хранилище:</b> Мы используем LocalStorage браузера для сохранения темы и языка.</li>
                </ul>

                <h3>3. Использование данных</h3>
                <p>Ваши данные используются только для:</p>
                <ul>
                    <li>Синхронизации прогресса между устройствами.</li>
                    <li>Проверки статуса подписки.</li>
                    <li>Обучения алгоритма под ваши вкусы.</li>
                </ul>
                <p><b>Мы не продаем и не передаем ваши данные третьим лицам.</b></p>

                <h3>4. Удаление данных</h3>
                <p>Вы можете в любой момент сбросить данные в приложении ("Сброс данных") или написать в поддержку для полного удаления аккаунта с серверов.</p>
            `,

            refund_text: `
                <h3>1. Политика цифровых товаров</h3>
                <p>В связи с природой цифрового контента, все продажи кодов активации и подписок являются <b>окончательными и не подлежат возврату</b> после доставки кода или активации услуги.</p>
                
                <h3>2. Исключения</h3>
                <p>Мы можем рассмотреть возврат в индивидуальном порядке в следующих случаях:</p>
                <ul>
                    <li><b>Техническая ошибка:</b> Выданный код оказался нерабочим.</li>
                    <li><b>Недоставка:</b> Вы оплатили, но услуга не была предоставлена в течение 24 часов.</li>
                    <li><b>Двойное списание:</b> Из-за сбоя оплата прошла дважды.</li>
                </ul>

                <h3>3. Запрос возврата</h3>
                <p>Для запроса свяжитесь с поддержкой через кнопку "Сообщить о проблеме" или по Email. Укажите ID транзакции. Запросы принимаются в течение 14 дней с момента покупки.</p>
            `
        },

        es: {
            // --- General ---
            subtitle: "Tu hogar para preferencias adultas",
            lang_label: "Idioma",
            nav_home: "Inicio",
            nav_settings: "Ajustes",
            nav_account: "Cuenta",
            header_prefs: "Preferencias",
            ori_label: "Orientación",
            ori_hetero: "Hetero",
            ori_gay: "Gay",
            ori_trans: "Trans",
            ori_pan: "Pansexual",
            header_extras: "Extras",
            theme_label: "Apariencia",
            theme_title: "Elegir Tema",
            theme_basic: "Básico",
            theme_premium: "Colores Premium",
            btn_return: "Volver",
            watch_later: "Ver más tarde",
            empty_wl: "Lista vacía",
            sync_label: "Sinc: ",
            expl_undo: "¿Cambiaste de opinión? 😏",
            expl_hist: "De los archivos 📜",
            deco_label: "Mostrar decoración",

            mode_greeting_hint: [
                "¿Algo nuevo 🔭 o tus favoritos 🥰?",
                "¿Explorar lo desconocido 🔭 o ir a lo seguro 🥰?",
                "¿Aventurero 🔭 o nostálgico 🥰?",
                "¿Confiar en el azar 🔭 o en tu gusto 🥰?"
            ],
            mode_explore: "Explorar",
            mode_pleasure: "Placer",

            info_header: "Información",
            hist_tab_swipes: "Deslizamientos",
            hist_tab_watch: "Tiempo",
            hist_empty_watch: "Aún no hay datos de visualización. ¡Ve a ver algo! 😏",
            hist_watched: "VISTO",

            status_wl: "Ver más tarde",
            status_fav: "Me gusta",
            status_ban: "No me gusta",

            stats_no_data: "Aún no hay datos",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Haz {n} movimientos más para desbloquear tu resumen",

            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amatista",
            "theme_purple-light": "Lavanda",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Melocotón",

            plan_bestie_sub: "De por vida",
            plan_bestie_price: "/ una vez",
            badge_limited: "OFERTA LIMITADA",
            limit_burn: "🔥 CASI AGOTADO",
            limit_claimed: "reclamados",
            feat_lifetime: "♾️ <b>Acceso de por vida</b>",
            feat_onetime: "💸 Pago único",
            btn_get_bestie: "Obtener para siempre",

            // --- Sponsors ---
            btn_early_sponsors: "Patrocinadores 💎",
            sponsors_title: "Muro de la Fama",
            sponsors_desc: "Estas leyendas apoyaron xFetishHub al principio comprando el plan Bestie. ¡Eternamente agradecido! 💙",

            return_phrases: [
                "Todo un {t}. Fuiste a lo seguro 😏",
                "De vuelta tras {t}. ¿Te gustó? 🔥",
                "{t}... ¡Vaya sesión! 😅",
                "Te fuiste por {t}. Espero que valiera la pena.",
                "¡Wow, {t}! Parece una buena elección."
            ],
            return_phrase_short: "¿Solo {t}? Qué rápido... ⚡",

            reset_phrases: [
                "A veces todos necesitamos un descanso 🧘",
                "Empecemos de nuevo...",
                "Reinicio del sistema 🔄",
                "Paz y tranquilidad...",
                "Borrón y cuenta nueva ✨"
            ],

            auth_title: "Sincronización",
            auth_p1: "Historial y preferencias en todos los dispositivos",
            auth_p2: "Activar estado Pro / Beast",
            auth_p3: "Almacenamiento anónimo en servidores de Google",
            btn_google_signin: "Continuar con Google",
            auth_security_note: "El desarrollador no tiene acceso a los datos. No te preocupes por tu historial 😏",
            btn_cancel: "Cancelar",

            info_header: "Información",
            lbl_support_email: "Correo de soporte",
            doc_terms: "Términos de Uso",
            doc_privacy: "Privacidad",
            doc_refund: "Reembolsos",
            btn_close: "Cerrar",

            btn_roadmap: "Hoja de Ruta",
            roadmap_title: "Planes Futuros",
            roadmap_desc: "Con tu apoyo activo, xFetishHub evolucionará. Esto es lo que estamos construyendo:",
            rm_global_title: "Inteligencia Global",
            rm_global_desc: "Estadísticas anónimas de todos los usuarios para mejorar recomendaciones. Ver los fetiches más amados y odiados.",
            rm_coop_title: "Modo Cooperativo",
            rm_coop_desc: "Invita a tu pareja. Verán lo que generas en tiempo real. Perfecto para parejas a distancia.",
            rm_content_title: "5000+ Categorías",
            rm_content_desc: "Expansión masiva de la base de datos. Cada micro-fetiche será indexado.",
            rm_actors_title: "Selector de Actores",
            rm_actors_desc: "Un modo dedicado para encontrar estrellas porno basado en tus preferencias visuales.",
            rm_support_btn: "Apoyar Desarrollo 🚀",

            search_liked: "Buscar favoritos...",
            search_disliked: "Buscar bloqueados...",
            hist_empty: "Historial vacío",
            limit_reset: "Reinicio:",

            // --- Generator ---
            generate: "Género Aleatorio",
            generate_again: "Otro Género",
            btn_similar: "Similar",
            watch: "Ver",
            search: "Buscar",
            related_header: "También te puede interesar:",
            add_genre: "Añadir al género:",
            search_en_label: "Buscar en EN",
            site_label: "Sitio",
            exploration_mode: "Intensidad",


            btn_start: "¡Vamos!",
            btn_pass: "Otro",
            btn_like: "Similar",
            btn_upgrade_short: "Mejorar ⇧",

            // --- Subscription ---
            sub_title: "Acceso Premium",
            sub_intro: "xFetishHub es un proyecto único en su tipo que te ayuda a descubrir y analizar tus preferencias adultas en un lugar acogedor y sin publicidad. Al suscribirte aseguras la supervivencia del proyecto, y a cambio te daré muchas más funciones:",
            
            feat_limit: "🎲 10 Generaciones / día",
            feat_stats_basic: "📊 Estadísticas Básicas",
            feat_filters: "✔️ Filtros Estándar",
            btn_current: "Plan Actual",

            feat_wrapped_limited: "🎁 1 Fetish Wrapped / semana",
            feat_wrapped_unlim: "✨ Fetish Wrapped <b>Ilimitado</b>",

            feat_unlim: "🔥 Generaciones Ilimitadas",
            feat_stats_adv: "📈 Estadísticas Avanzadas",
            feat_custom: "🎨 Personalización",
            feat_early: "🚀 Acceso Anticipado",
            btn_get_pro: "Obtener Pro",

            feat_all_pro: "👑 Todo lo de Pro",
            feat_sponsors: "💎 En Patrocinadores",
            feat_discord: "💬 Acceso a Discord",
            feat_vote: "🗳️ Votar Futuro",
            btn_get_beast: "Modo Bestia",

            btn_lower_tier: "Mereces algo mejor",

            pay_desc: "Selecciona un método de pago. Recibirás un código de activación al instante.",
            pay_stars: "Estrellas Telegram",
            pay_card: "Tarjeta (Mundial)",
            pay_crypto: "Cripto (Anónimo)",
            pay_boosty: "Boosty (Tarjetas)",
            pay_code_label: "Si ya pagaste, ingresa el código:",
            pay_code_placeholder: "Código de activación...",

            lbl_current_plan: "Plan Actual",
            login_alert: "¡Inicia sesión para gestionar suscripciones!",

            // --- Account ---
            login_text: "Entrar / Sincronizar",
            personal_account: "Cuenta Personal",
            btn_open_stats: "Estadísticas",

            // ТЕМЫ
            "theme_blue-dark": "Medianoche",
            "theme_green-dark": "Bosque",
            "theme_red-dark": "Vampiro",
            "theme_gold-dark": "Lujo",
            "theme_noir": "Noir",
            "theme_blue-light": "Cielo",
            "theme_green-light": "Menta",
            "theme_red-light": "Rosa",
            "theme_gold-light": "Arena",
            "theme_rainbow": "Arcoíris",
            "theme_dark": "Oscuro",
            "theme_light": "Claro",

            history_title: "Historial",

            logout_text: "Cerrar sesión",
            login_required: "¡Por favor inicia sesión para activar tu suscripción!",
            sync_success: "¡Datos sincronizados!",
            
            btn_reset: "Restablecer datos",
            confirm_reset: "¿Estás seguro? Esto borrará tu historial y estadísticas. No se puede deshacer.",
            reset_done: "Datos restablecidos.",
            
            explored_label: "Explorado",
            explored_txt: "{n} / {t} categorías",
            report_issue: "Reportar Problema",

            sync_title: "Nube",
            sync_desc: "Datos guardados seguros en Google",
            sync_tip: "Haz clic en 'Sincronizar'. <b>La página se recargará.</b>",
            sync_btn_success: "✅ ¡Hecho! Recargando...",
            btn_sync: "🔄 Sincronizar",
            sub_exp: "exp:",
            sub_expired: "Vencido",
            time_d: "d",

            // --- Lists ---
            favorites_catalog: "Me Gusta",
            blacklist_catalog: "No Me Gusta",
            btn_fav_add: "A Favoritos",
            btn_fav_remove: "En Favoritos",
            btn_ban_add: "Bloquear",
            btn_ban_remove: "Desbloquear",
            empty: "¡Lista vacía (Filtros)!",

            // --- Filters ---
            filter_include: "Incluir",
            filter_exclude: "Excluir",
            tag_fav: "Favoritos",
            tag_straight: "Hetero", tag_gay: "Gay", tag_lesbian: "Lesbiana", tag_trans: "Trans",

            // --- Stats ---
            btn_stats: "Estadísticas",
            stats_header: "Tus Categorías",
            stats_prefs: "Preferencias",
            stats_activity: "Actividad",
            tf_week: "Semana", tf_month: "Mes", tf_year: "Año", tf_all: "Todo el tiempo",
            act_gen: "Generaciones", act_watch: "Vistas",
            chart_prefs_x: "Preferencias",
            chart_points_y: "Puntos",
            chart_count_y: "Cantidad",
            share_btn: "Compartir",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Vuelve en una semana. O si quieres estadísticas diarias, la suscripción Pro es tu mejor amiga.",

            legend_watch: "Ver (+10)",
            legend_like: "Me gusta (+5)",
            legend_dislike: "Otro / No me gusta (-10)",
            act_actions: "Desliza",
            act_watches: "Vistas", 

            // --- Explain ---
            expl_fav: "Porque te gusta ",
            expl_sim: "Relacionado",
            expl_rand: "Destino",
            expl_score: "Porque te gustó ",
            expl_tag_click: "Elegiste etiqueta: ",

            // --- Badges ---
            badge_extreme: "Extremo",
            badge_desc_extreme: "⚠️ <b>Alta Intensidad</b><br>Contenido rudo o intenso.",
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>Contenido LGBTQ+</b><br>Relaciones del mismo sexo o Trans.",
            badge_niche: "Nicho",
            badge_desc_niche: "🔍 <b>Fetiche Específico</b><br>Interés particular no convencional.",
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM</b><br>Bondage, dominación y sumisión.",

            // --- Modals ---
            age_title: "Verificación de edad",
            age_desc: "Este sitio web contiene material para adultos. ¿Tienes 18 años o más?",
            age_yes: "Sí, tengo 18+",
            age_no: "No, Salir",
            age_block_msg: "Este sitio web es solo para usuarios mayores de 18 años.",
            onb_placeholder: "ej. me gustan maduras, anal y pechos grandes...",
        
            install_title: "Instalar App",
            install_desc: "Instala la app para pantalla completa. ¡Además, mira videos en el navegador integrado para mantener limpio tu historial principal!",
            install_continue: "Continuar en navegador",

            btn_install_phone: "Instalar en móvil",
            qr_title: "Escanear para instalar",
            qr_desc: "Escanea este código QR con tu cámara para abrir el sitio, luego sigue las instrucciones:",
            
            inst_ios_1: "Toca el botón <b>Compartir</b>",
            inst_ios_2: "Baja y selecciona",
            inst_ios_btn: "Añadir a Inicio",
            inst_ios_3: "Toca <b>Añadir</b>.",
            
            inst_and_1: "Toca el <b>Menú</b> (3 puntos)",
            inst_and_2: "Selecciona",
            inst_and_btn: "Instalar Aplicación",

            onb_title: "Configuración rápida",
            onb_desc: "Describe tus gustos en una frase. Detectaremos las categorías automáticamente.",
            onb_btn_check: "Buscar Categorías",
            onb_found: "Encontramos:",
            onb_btn_confirm: "Añadir a Favoritos",
            onb_skip: "Saltar configuración",

            lbl_about: "Sobre el proyecto",
            about_title: "Desarrollador",
            about_intro: "Soy Nikolai M., 23 años, estudiante.",
            about_desc: "La misión del proyecto es permitir a los usuarios conocer todos los géneros para adultos a través de un sistema inteligente, y analizar sus gustos para el autoconocimiento.",

            terms_text: `
                <h3>1. Aceptación de los Términos</h3>
                <p>Al acceder y utilizar xFetishHub, confirma que tiene al menos 18 años de edad (o la mayoría de edad en su jurisdicción) y acepta estar sujeto a estos términos. Si no está de acuerdo, debe abandonar el servicio inmediatamente.</p>
                
                <h3>2. Naturaleza del Servicio</h3>
                <p>xFetishHub es un agregador de búsqueda y motor de recomendaciones. <b>No alojamos, subimos ni controlamos ningún contenido de video.</b> Todos los enlaces generados conducen a sitios web de terceros (por ejemplo, xHamster, Pornhub). Servimos como un conducto para encontrar contenido disponible públicamente en Internet.</p>
                
                <h3>3. Contenido de Terceros</h3>
                <p>No tenemos control ni asumimos responsabilidad por el contenido, las políticas de privacidad o las prácticas de sitios web de terceros. Usted reconoce y acepta que xFetishHub no será responsable, directa o indirectamente, por ningún daño o pérdida causada por su uso de cualquier contenido de terceros.</p>
                
                <h3>4. Cuentas y Suscripciones</h3>
                <p>Algunas funciones requieren una suscripción paga ("Pro" o "Beast"). El procesamiento de pagos es manejado por proveedores externos. No almacenamos sus credenciales de pago. Nos reservamos el derecho de cancelar cuentas que violen estos términos.</p>
                
                <h3>5. Renuncia de Garantías</h3>
                <p>El servicio se proporciona "TAL CUAL" y "SEGÚN DISPONIBILIDAD". No garantizamos que los resultados generados cumplan con sus requisitos o estén libres de errores.</p>
            `,

            privacy_text: `
                <h3>1. Introducción</h3>
                <p>Su privacidad es nuestra prioridad. Esta política explica cómo manejamos sus datos. Nuestro objetivo es recopilar la cantidad mínima absoluta de información requerida para proporcionar nuestro servicio.</p>
                
                <h3>2. Datos que Recopilamos</h3>
                <ul>
                    <li><b>Datos de Autenticación:</b> Al iniciar sesión a través de Google, recibimos su correo electrónico y UID para sincronizar sus preferencias. No vemos su contraseña.</li>
                    <li><b>Datos de Uso:</b> Almacenamos su historial generado, etiquetas favoritas y preferencias localmente en su dispositivo y encriptados en nuestra base de datos para el funcionamiento del algoritmo.</li>
                    <li><b>Almacenamiento Local:</b> Utilizamos el almacenamiento local del navegador para guardar sus configuraciones (tema, idioma) sin cookies de rastreo.</li>
                </ul>

                <h3>3. Cómo Usamos los Datos</h3>
                <p>Sus datos se utilizan únicamente para:</p>
                <ul>
                    <li>Sincronizar su progreso entre dispositivos.</li>
                    <li>Verificar el estado de su suscripción.</li>
                    <li>Entrenar el algoritmo de personalización para mejorar las sugerencias.</li>
                </ul>
                <p><b>No vendemos, intercambiamos ni alquilamos su información de identificación personal a terceros.</b></p>

                <h3>4. Eliminación de Datos</h3>
                <p>Puede solicitar la eliminación completa de su cuenta y datos en cualquier momento contactando al soporte o utilizando el botón "Restablecer datos" dentro de la aplicación.</p>
            `,

            refund_text: `
                <h3>1. Política de Bienes Digitales</h3>
                <p>Debido a la naturaleza del contenido digital, todas las ventas de códigos de activación y suscripciones para xFetishHub son generalmente <b>finales y no reembolsables</b> una vez que el código ha sido entregado o la suscripción activada.</p>
                
                <h3>2. Excepciones</h3>
                <p>Podemos ofrecer un reembolso o reemplazo a nuestra entera discreción bajo las siguientes circunstancias:</p>
                <ul>
                    <li><b>Error Técnico:</b> El código de activación proporcionado no era válido o estaba defectuoso.</li>
                    <li><b>No Entrega:</b> Pagó pero no recibió el servicio/código dentro de las 24 horas.</li>
                    <li><b>Doble Facturación:</b> Se le cobró dos veces por el mismo período debido a un fallo técnico.</li>
                </ul>

                <h3>3. Cómo Solicitar</h3>
                <p>Para solicitar un reembolso, contacte al soporte a través del botón "Reportar Problema". Incluya su ID de transacción y la fecha de compra. Las solicitudes deben realizarse dentro de los 14 días posteriores a la compra.</p>
            `
        },

        de: {
            // --- General ---
            subtitle: "Dein Zuhause für Erwachsenen-Vorlieben",
            lang_label: "Sprache",
            nav_home: "Start",
            nav_settings: "Einstell.",
            nav_account: "Konto",
            header_prefs: "Einstellungen",
            ori_label: "Orientierung",
            ori_hetero: "Hetero",
            ori_gay: "Schwul",
            ori_trans: "Trans",
            ori_pan: "Pansexuell",
            header_extras: "Extras",
            theme_label: "Aussehen",
            theme_title: "Thema wählen",
            theme_basic: "Basis",
            theme_premium: "Premium Farben",
            btn_return: "Zurück",
             watch_later: "Später ansehen",
            empty_wl: "Liste leer",
            sync_label: "Sync: ",
            expl_undo: "Meinung geändert? 😏",
            expl_hist: "Aus dem Archiv 📜",
            deco_label: "Dekoration anzeigen",

            mode_greeting_hint: [
                "Etwas Neues 🔭 oder bekannte Favoriten 🥰?",
                "Unbekanntes entdecken 🔭 oder bei Hits bleiben 🥰?",
                "Abenteuerlustig 🔭 oder nostalgisch 🥰?",
                "Dem Zufall vertrauen 🔭 oder dem Geschmack 🥰?"
            ],
            mode_explore: "Erkunden",
            mode_pleasure: "Genießen",

            info_header: "Informationen",
            hist_tab_swipes: "Swipes",
            hist_tab_watch: "Zeit",
            hist_empty_watch: "Noch keine Daten. Schau dir was an! 😏",
            hist_watched: "GESEHEN",

            status_wl: "Später ansehen",
            status_fav: "Gefällt mir",
            status_ban: "Gefällt nicht",

            stats_no_data: "Noch keine Daten",
            wrapped_lock_title: "FETISH WRAPPED 🔒",
            wrapped_lock_desc: "Mache noch {n} Aktionen, um deine Zusammenfassung freizuschalten",

            "theme_pink-dark": "Cyber",
            "theme_pink-light": "Sakura",
            "theme_purple-dark": "Amethyst",
            "theme_purple-light": "Lavendel",
            "theme_orange-dark": "Magma",
            "theme_orange-light": "Pfirsich",

            plan_bestie_sub: "Lebenslang",
            plan_bestie_price: "/ einmalig",
            badge_limited: "LIMITIERTES ANGEBOT",
            limit_burn: "🔥 FAST WEG",
            limit_claimed: "beansprucht",
            feat_lifetime: "♾️ <b>Lebenslanger Zugriff</b>",
            feat_onetime: "💸 Einmalzahlung",
            btn_get_bestie: "Für immer holen",

            // --- Sponsors ---
            btn_early_sponsors: "Frühe Sponsoren 💎",
            sponsors_title: "Ruhmeshalle",
            sponsors_desc: "Diese Legenden haben xFetishHub von Anfang an mit dem Bestie-Plan unterstützt. Ewig dankbar! 💙",

            return_phrases: [
                "Ganze {t}. Du warst dir sicher 😏",
                "Zurück nach {t}. Hat es dir gefallen? 🔥",
                "{t}... Was für eine Sitzung! 😅",
                "Du warst {t} weg. Hoffentlich war es das wert.",
                "Wow, {t}! Scheint eine gute Wahl zu sein."
            ],
            return_phrase_short: "Nur {t}? Das ging schnell... ⚡",

            reset_phrases: [
                "Manchmal braucht jeder eine Pause 🧘",
                "Lass uns neu anfangen...",
                "Systemneustart 🔄",
                "Ruhe und Frieden...",
                "Ein neuer Anfang ✨"
            ],

            auth_title: "Synchronisierung",
            auth_p1: "Verlauf und Vorlieben auf allen Geräten speichern",
            auth_p2: "Pro / Beast Status aktivieren",
            auth_p3: "Anonyme Speicherung auf Google-Servern",
            btn_google_signin: "Weiter mit Google",
            auth_security_note: "Entwickler hat keinen Zugriff auf Daten. Keine Sorge um deinen Verlauf 😏",
            btn_cancel: "Abbrechen",

            info_header: "Informationen",
            lbl_support_email: "Support-E-Mail",
            doc_terms: "Nutzungsbedingungen",
            doc_privacy: "Datenschutz",
            doc_refund: "Rückerstattung",

            btn_roadmap: "Roadmap",
            roadmap_title: "Zukunftspläne",
            roadmap_desc: "Mit deiner Unterstützung wird sich xFetishHub weiterentwickeln. Das bauen wir:",
            rm_global_title: "Globale Intelligenz",
            rm_global_desc: "Verbesserte Empfehlungen basierend auf anonymen Daten aller Nutzer. Siehe globale 'Top' und 'Flop' Listen.",
            rm_coop_title: "Koop-Modus",
            rm_coop_desc: "Lade einen Partner ein. Er sieht in Echtzeit, was du generierst. Perfekt für Fernbeziehungen.",
            rm_content_title: "5000+ Kategorien",
            rm_content_desc: "Massive Erweiterung der Datenbank. Jeder Mikro-Fetisch wird indexiert.",
            rm_actors_title: "Darsteller-Suche",
            rm_actors_desc: "Ein Modus zum Finden von Pornostars basierend auf deinen visuellen Vorlieben.",
            rm_support_btn: "Entwicklung unterstützen 🚀",

            btn_start: "Los geht's",
            btn_pass: "Andere",
            btn_like: "Ähnlich",
            btn_upgrade_short: "Upgrade ⇧",

            // --- Generator ---
            generate: "Zufallsgenre",
            generate_again: "Anderes Genre",
            btn_similar: "Ähnlich",
            watch: "Ansehen",
            search: "Suchen",
            related_header: "Das könnte Ihnen auch gefallen:",
            add_genre: "Zum Genre:",
            search_en_label: "Suche auf EN",
            site_label: "Webseite",
            exploration_mode: "Intensität",

            // --- Subscription ---
            sub_title: "Premium Zugang",
            sub_intro: "xFetishHub ist ein einzigartiges Projekt, das dir hilft, deine Vorlieben an einem gemütlichen, werbefreien Ort zu entdecken und zu analysieren. Mit einem Abo sicherst du den Fortbestand des Projekts, und im Gegenzug biete ich dir deutlich mehr Funktionen:",
            
            feat_limit: "🎲 10 Generationen / Tag",
            feat_stats_basic: "📊 Basis-Statistik",
            feat_filters: "✔️ Standardfilter",
            btn_current: "Aktueller Plan",
            feat_wrapped_limited: "🎁 1 Fetish Wrapped / Woche",
            feat_wrapped_unlim: "✨ <b>Unbegrenztes</b> Wrapped",

            feat_unlim: "🔥 Unbegrenzte Generationen",
            feat_stats_adv: "📈 Erweiterte Statistik",
            feat_custom: "🎨 Tiefe Anpassung",
            feat_early: "🚀 Frühzugang",
            btn_get_pro: "Pro holen",

            feat_all_pro: "👑 Alle Pro-Funktionen",
            feat_sponsors: "💎 In Sponsorenliste",
            feat_discord: "💬 Discord Zugang",
            feat_vote: "🗳️ Abstimmung",
            btn_get_beast: "Beast werden",

            btn_lower_tier: "Du verdienst Besseres",

            pay_desc: "Wähle eine Zahlungsmethode. Du erhältst sofort einen Aktivierungscode.",
            pay_stars: "Telegram Stars",
            pay_card: "Karte (Weltweit)",
            pay_crypto: "Krypto (Anonym)",
            pay_boosty: "Boosty (Karten)",
            pay_code_label: "Wenn bezahlt, Code hier eingeben:",
            pay_code_placeholder: "Aktivierungscode...",

            lbl_current_plan: "Aktueller Plan",
            login_alert: "Bitte anmelden, um Abos zu verwalten!",

            // --- Account ---
            login_text: "Anmelden / Sync",
            personal_account: "Persönliches Konto",
            btn_open_stats: "Statistik",

            // ТЕМЫ
            "theme_blue-dark": "Mitternacht",
            "theme_green-dark": "Wald",
            "theme_red-dark": "Vampir",
            "theme_gold-dark": "Luxus",
            "theme_noir": "Noir",
            "theme_blue-light": "Himmel",
            "theme_green-light": "Minze",
            "theme_red-light": "Rose",
            "theme_gold-light": "Sand",
            "theme_rainbow": "Regenbogen",
            "theme_dark": "Dunkel",
            "theme_light": "Hell",

            history_title: "Verlauf",

            logout_text: "Abmelden",
            login_required: "Bitte melde dich an, um das Abo zu aktivieren!",
            sync_success: "Daten synchronisiert!",
            
            btn_reset: "Daten zurücksetzen",
            confirm_reset: "Bist du sicher? Dies löscht Verlauf und Statistiken. Kann nicht rückgängig gemacht werden.",
            reset_done: "Daten zurückgesetzt.",
            
            explored_label: "Erforscht",
            explored_txt: "{n} / {t} Kategorien",
            report_issue: "Problem melden",

            sync_title: "Cloud-Speicher",
            sync_desc: "Daten sicher auf Google-Servern gespeichert",
            sync_tip: "Klicke auf 'Synchronisieren'. <b>Seite wird neu geladen.</b>",
            sync_btn_success: "✅ Fertig! Wird neu geladen...",
            btn_sync: "🔄 Synchronisieren",
            sub_exp: "abl:",
            sub_expired: "Abgelaufen",
            time_d: "t",

            // --- Lists ---
            favorites_catalog: "Gefällt mir",
            blacklist_catalog: "Gefällt mir nicht",
            btn_fav_add: "Favorit",
            btn_fav_remove: "In Favoriten",
            btn_ban_add: "Blockieren",
            btn_ban_remove: "Entblocken",
            empty: "Liste leer (Filter)!",

            // --- Filters ---
            filter_include: "Einschließen",
            filter_exclude: "Ausschließen",
            tag_fav: "Favoriten",
            tag_straight: "Hetero", tag_gay: "Schwul", tag_lesbian: "Lesbisch", tag_trans: "Trans",

            // --- Stats ---
            btn_stats: "Statistik",
            stats_header: "Deine Favoriten",
            stats_prefs: "Vorlieben",
            stats_activity: "Aktivität",
            tf_week: "Woche", tf_month: "Monat", tf_year: "Jahr", tf_all: "Gesamtzeit",
            act_gen: "Generationen", act_watch: "Angeschaut",
            chart_prefs_x: "Vorlieben",
            chart_points_y: "Punkte",
            chart_count_y: "Anzahl",
            share_btn: "Teilen",
            wrapped_btn: "Fetish Wrapped ✨",
            feat_filters: "✨ Fetish Wrapped",
            wrapped_free_outro: "Komm in einer Woche wieder. Oder wenn du tägliche Statistiken willst, ist das Pro-Abo dein bester Freund.",
            btn_close: "Schließen",
            search_liked: "Favoriten suchen...",
            search_disliked: "Blockierte suchen...",
            hist_empty: "Verlauf leer",
            limit_reset: "Reset:",

            legend_watch: "Ansehen (+10)",
            legend_like: "Like (+5)",
            legend_dislike: "Andere / Dislike (-10)",
            act_actions: "Swipes",
            act_watches: "Angeschaut",

            // --- Explain ---
            expl_fav: "Weil du magst: ",
            expl_sim: "Ähnlich wie voriges",
            expl_rand: "Schicksal",
            expl_score: "Weil du mochtest: ",
            expl_tag_click: "Tag gewählt: ",

            // --- Badges ---
            badge_extreme: "Extrem",
            badge_desc_extreme: "⚠️ <b>Hohe Intensität</b><br>Raue oder intensive Inhalte.",
            badge_lgbt: "LGBT",
            badge_desc_lgbt: "🏳️‍🌈 <b>LGBTQ+ Inhalt</b><br>Gleichgeschlechtliche oder Trans-Inhalte.",
            badge_niche: "Nische",
            badge_desc_niche: "🔍 <b>Spezifischer Fetisch</b><br>Besondere Interessen, kein Mainstream.",
            badge_bdsm: "BDSM",
            badge_desc_bdsm: "⛓️ <b>BDSM</b><br>Fesselspiele, Dominanz und Unterwerfung.",

            // --- Modals ---
            age_title: "Altersprüfung",
            age_desc: "Diese Website enthält Material für Erwachsene. Sind Sie 18 Jahre oder älter?",
            age_yes: "Ja, ich bin 18+",
            age_no: "Nein, Verlassen",
            age_block_msg: "Diese Website ist nur für Nutzer über 18 Jahre bestimmt.",
            onb_placeholder: "z.B. ich mag Milf, Anal und große Brüste...",
        
            install_title: "App installieren",
            install_desc: "Installiere die App für Vollbild. Plus: Schaue Videos im integrierten Browser, um deinen Hauptverlauf sauber zu halten!",
            install_continue: "Im Browser fortfahren",

            btn_install_phone: "Auf Handy installieren",
            qr_title: "Scannen zum Installieren",
            qr_desc: "Scanne diesen QR-Code mit deiner Kamera, dann befolge die Anweisungen:",
            
            inst_ios_1: "Tippe auf <b>Teilen</b>",
            inst_ios_2: "Scrolle runter und wähle",
            inst_ios_btn: "Zum Home-Bildschirm",
            inst_ios_3: "Tippe auf <b>Hinzufügen</b>.",
            
            inst_and_1: "Tippe auf <b>Menü</b> (3 Punkte)",
            inst_and_2: "Wähle",
            inst_and_btn: "App installieren",

            onb_title: "Schnelleinrichtung",
            onb_desc: "Beschreibe deine Vorlieben in einem Satz. Wir finden die Kategorien automatisch.",
            onb_btn_check: "Kategorien suchen",
            onb_found: "Wir haben gefunden:",
            onb_btn_confirm: "Zu Favoriten",
            onb_skip: "Überspringen",

            lbl_about: "Über das Projekt",
            about_title: "Entwickler",
            about_intro: "Ich bin Nikolai M., 23 Jahre alt, Student.",
            about_desc: "Die Mission des Projekts ist es, Benutzern durch ein intelligentes System alle Erwachsenengenres näherzubringen und ihre Vorlieben zur Selbstfindung zu analysieren.",

            terms_text: `
                <h3>1. Annahme der Bedingungen</h3>
                <p>Durch den Zugriff auf xFetishHub bestätigen Sie, dass Sie mindestens 18 Jahre alt sind (oder das gesetzliche Mindestalter in Ihrer Gerichtsbarkeit erreicht haben) und stimmen diesen Bedingungen zu. Wenn Sie nicht zustimmen, müssen Sie den Dienst sofort verlassen.</p>
                
                <h3>2. Art des Dienstes</h3>
                <p>xFetishHub ist ein Suchaggregator und eine Empfehlungsmaschine. <b>Wir hosten, laden hoch oder kontrollieren keine Videoinhalte.</b> Alle vom Dienst generierten Links führen zu Websites Dritter (z. B. xHamster, Pornhub). Wir dienen lediglich als Vermittler zum Auffinden von Inhalten, die öffentlich im Internet verfügbar sind.</p>
                
                <h3>3. Inhalte Dritter</h3>
                <p>Wir haben keine Kontrolle über und übernehmen keine Verantwortung für die Inhalte, Datenschutzrichtlinien oder Praktiken von Websites Dritter. Sie erkennen an, dass xFetishHub weder direkt noch indirekt für Schäden oder Verluste haftbar gemacht werden kann, die durch Ihre Nutzung von Inhalten Dritter verursacht werden.</p>
                
                <h3>4. Benutzerkonten & Abonnements</h3>
                <p>Einige Funktionen erfordern ein kostenpflichtiges Abonnement ("Pro" oder "Beast"). Die Zahlungsabwicklung erfolgt durch Drittanbieter. Wir speichern Ihre Zahlungsdaten nicht. Wir behalten uns das Recht vor, Konten zu kündigen, die gegen diese Bedingungen verstoßen.</p>
                
                <h3>5. Gewährleistungsausschluss</h3>
                <p>Der Dienst wird "WIE BESEHEN" (AS IS) bereitgestellt. Wir garantieren nicht, dass die generierten Ergebnisse Ihren Anforderungen entsprechen oder fehlerfrei sind.</p>
            `,

            privacy_text: `
                <h3>1. Einführung</h3>
                <p>Ihre Privatsphäre ist unsere Priorität. Diese Richtlinie erklärt, wie wir mit Ihren Daten umgehen. Unser Ziel ist es, nur die absolut notwendigen Informationen zu sammeln, die für den Dienst erforderlich sind.</p>
                
                <h3>2. Datenerfassung</h3>
                <ul>
                    <li><b>Authentifizierungsdaten:</b> Wenn Sie sich über Google anmelden, erhalten wir Ihre E-Mail-Adresse und UID, um Ihre Einstellungen zu synchronisieren. Wir sehen Ihr Passwort nicht.</li>
                    <li><b>Nutzungsdaten:</b> Wir speichern Ihren generierten Verlauf, Favoriten und Präferenzen lokal auf Ihrem Gerät und verschlüsselt in unserer Datenbank, um den Algorithmus zu betreiben.</li>
                    <li><b>Lokaler Speicher:</b> Wir verwenden den lokalen Browserspeicher, um Ihre Einstellungen (Thema, Sprache) ohne Tracking-Cookies zu speichern.</li>
                </ul>

                <h3>3. Verwendung der Daten</h3>
                <p>Ihre Daten werden ausschließlich verwendet für:</p>
                <ul>
                    <li>Synchronisierung Ihres Fortschritts über Geräte hinweg.</li>
                    <li>Überprüfung Ihres Abonnementstatus.</li>
                    <li>Training des Personalisierungsalgorithmus zur Verbesserung von Vorschlägen.</li>
                </ul>
                <p><b>Wir verkaufen, handeln oder vermieten Ihre persönlichen Identifikationsdaten nicht an Dritte.</b></p>

                <h3>4. Datenlöschung</h3>
                <p>Sie können jederzeit die vollständige Löschung Ihres Kontos und Ihrer Daten beantragen, indem Sie den Support kontaktieren oder die Schaltfläche "Daten zurücksetzen" in der App verwenden.</p>
            `,

            refund_text: `
                <h3>1. Richtlinie für digitale Güter</h3>
                <p>Aufgrund der Natur digitaler Inhalte sind alle Verkäufe von Aktivierungscodes und Abonnements für xFetishHub in der Regel <b>endgültig und nicht erstattungsfähig</b>, sobald der Code geliefert oder das Abonnement aktiviert wurde.</p>
                
                <h3>2. Ausnahmen</h3>
                <p>Wir können nach eigenem Ermessen unter folgenden Umständen eine Rückerstattung oder einen Ersatz anbieten:</p>
                <ul>
                    <li><b>Technischer Fehler:</b> Der bereitgestellte Aktivierungscode war ungültig oder defekt.</li>
                    <li><b>Nichtlieferung:</b> Sie haben bezahlt, aber den Dienst/Code nicht innerhalb von 24 Stunden erhalten.</li>
                    <li><b>Doppelbuchung:</b> Aufgrund eines technischen Fehlers wurde Ihnen derselbe Zeitraum zweimal berechnet.</li>
                </ul>

                <h3>3. Anforderung</h3>
                <p>Um eine Rückerstattung zu beantragen, kontaktieren Sie bitte den Support über die Schaltfläche "Problem melden". Geben Sie Ihre Transaktions-ID und das Kaufdatum an. Anfragen müssen innerhalb von 14 Tagen nach dem Kauf gestellt werden.</p>
            `
        }
    };

    const wrappedPhrases = {
        en: {
            // SCENARIO 1: FIRST TIME EVER (The Initiation)
            story_first: {
                intro: [
                    "Hey {name}... Finally decided to peek behind the curtain? 👀<br><br>I've been quietly taking notes while you were... occupied. You think your choices were random, but I see a pattern in the chaos.",
                    "Welcome, {name}. I was waiting for you. 🕯️<br><br>You've spent quite some time exploring your desires here. It's time to stop for a moment, catch your breath, and look at your reflection in the data mirror."
                ],
                activity: [
                    "You didn't hold back, did you? The algorithm is heating up just processing your data. <br><br>Let's look at the sheer volume of your curiosity.",
                    "Finger gymnastics at its finest. You swiped, clicked, and searched with purpose. <br><br>Here is the scale of your journey so far."
                ],
                timing: [
                    "Everyone has their own rhythm. Yours? It's distinct.<br><br>While the world was spinning, you carved out specific moments for yourself. We know exactly when your demons come out to play.",
                ],
                obsession: [
                    "And now... the truth. <br><br>Out of hundreds of possibilities, your brain kept rewiring itself back to specific themes. These aren't just tags; they are your map.",
                ],
                archetype: [
                    "So, who are you really? <br><br>We've crunched the numbers, analyzed the heatmaps, and found your digital soulmate. This is your Archetype."
                ]
            },

            // SCENARIO 2: REGULAR / WEEKLY (The Check-up)
            story_regular: {
                intro: [
                    "Look who's back, {name}. 😏<br><br>It's been a busy week for your thumbs, hasn't it? I've collected everything you did since we last spoke. Ready to see if your tastes have evolved?",
                    "Caught you again, {name}. ✨<br><br>Another cycle, another set of desires. You've been digging deeper this time. Let's unwrap the latest chapter of your story."
                ],
                activity: [
                    "Consistency is key, and you... well, you are definitely consistent. <br><br>The numbers don't lie. You've been active. Very active.",
                    "Your dopamine receptors must be working overtime. <br><br>We tracked every swipe and every hesitation. Here is the summary of your digital workout."
                ],
                timing: [
                    "Time flies when you're having fun. <br><br>But your internal clock has a specific schedule for pleasure. Here is when the magic usually happens."
                ],
                obsession: [
                    "Let's talk about what lives in your head rent-free. <br><br>You tried new things, but you always came back home to these specific categories.",
                ],
                archetype: [
                    "Based on your recent behavior, your vibe has shifted... or solidified. <br><br>Here is how the algorithm sees you right now."
                ]
            },

            // SHARED / STATIC TEXTS
            common: {
                total_label: "Total Interactions",
                top_label: "Your Heavy Rotation",
                tags_label: "The Flavor Palette",
                arch_label: "Your Archetype",
                
                arch_explorer: {
                    name: "The Voyager 🧭",
                    desc: "You refuse to settle. While others stick to the same old vanilla, you turn every stone. You swiped left on the ordinary to find the extraordinary. Your curiosity is your superpower."
                },
                arch_connoisseur: {
                    name: "The Sommelier 🍷",
                    desc: "You don't just watch; you curate. You skipped the trash and went straight for the gold. You know exactly what turns you on, and you don't waste time on anything else. A true tastemaker."
                },
                arch_wild: {
                    name: "The Untamed 🦁",
                    desc: "Safety limits? Never heard of them. Your stats show a hunger for intensity, adrenaline, and the extreme. While others dip their toes, you dive into the deep end. Respect."
                },
                arch_romantic: {
                    name: "The Dreamer 🌹",
                    desc: "Amidst the chaos of flesh, you sought connection. Softness, intimacy, and passion drove your choices. You proved that even here, the heart wants what it wants."
                },

                outro_free: "This story disappears in a moment. Want to keep your history and see stats daily? <br><b>Upgrade to Pro.</b>",
                outro_paid: "Your secrets are safe with us. <br>See you next time, space cowboy. 🤠"
            }
        },

        ru: {
            // СЦЕНАРИЙ 1: ПЕРВЫЙ РАЗ (Посвящение)
            story_first: {
                intro: [
                    "Хей, {name}! 😏<br><br>Наконец-то решился заглянуть за кулисы? Я тихо записывал всё, пока ты был... занят. Ты думаешь, твой выбор был случайным? О нет. В этом хаосе есть четкая система.",
                    "Добро пожаловать, {name}. Я тебя заждался. 🕯️<br><br>Ты провел немало времени, исследуя свои желания. Пришло время остановиться, выдохнуть и посмотреть на своё отражение в зеркале данных."
                ],
                activity: [
                    "Ты себя явно не сдерживал, а? <br><br>Алгоритм нагрелся, просто обрабатывая твои действия. Давай взглянем на масштаб твоего любопытства в цифрах.",
                    "Это была отличная пальчиковая гимнастика. <br><br>Ты свайпал, кликал и искал с завидным упорством. Вот как выглядит твой путь на языке сухой статистики."
                ],
                timing: [
                    "У каждого свой ритм. У тебя — особенный.<br><br>Пока мир вращался своим чередом, ты выкраивал моменты для себя. Мы точно знаем, когда твои демоны выходят поиграть.",
                ],
                obsession: [
                    "А теперь... момент истины. <br><br>Из сотен возможных вариантов твой мозг снова и снова возвращался к этим темам. Это не просто теги. Это карта твоего подсознания.",
                ],
                archetype: [
                    "Так кто же ты на самом деле? <br><br>Мы прогнали цифры, проанализировали тепловые карты и нашли твоего цифрового двойника. Вот твой Архетип."
                ]
            },

            // СЦЕНАРИЙ 2: РЕГУЛЯРНЫЙ / ЕЖЕНЕДЕЛЬНЫЙ (Проверка)
            story_regular: {
                intro: [
                    "С возвращением, {name}. 😏<br><br>Неделька выдалась жаркой, да? Твои пальцы потрудились на славу. Я собрал всё, что ты делал с нашей последней встречи. Готов узнать, как изменились твои вкусы?",
                    "Снова ты, {name}. ✨<br><br>Новый цикл, новые желания. В этот раз ты копал глубже. Давай распакуем свежую главу твоей истории."
                ],
                activity: [
                    "Стабильность — признак мастерства. И ты... ну, ты определенно мастер. <br><br>Цифры не врут. Ты был активен. Очень активен. Вот твой отчет о проделанной работе.",
                    "Твои рецепторы дофамина работали сверхурочно. <br><br>Мы отследили каждый свайп и каждое колебание. Вот сводка твоей цифровой тренировки."
                ],
                timing: [
                    "Время летит, когда тебе хорошо. <br><br>Но у твоих биологических часов есть четкое расписание для удовольствия. Вот когда происходит магия."
                ],
                obsession: [
                    "Поговорим о том, что живет в твоей голове бесплатно. <br><br>Ты пробовал новое, экспериментировал, но в итоге всегда возвращался домой — к этим категориям.",
                ],
                archetype: [
                    "Судя по твоему поведению на этой неделе, твоя аура изменилась... или стала тверже. <br><br>Вот каким алгоритм видит тебя прямо сейчас."
                ]
            },

            common: {
                total_label: "Твоя Активность",
                top_label: "Твоя Одержимость",
                tags_label: "Палитра Вкусов",
                arch_label: "Твой Архетип",
                
                arch_explorer: {
                    name: "Искатель 🧭",
                    desc: "Ты отказываешься довольствоваться малым. Пока другие смотрят одно и то же, ты переворачиваешь каждый камень. Ты свайпал влево обыденность, чтобы найти уникальность. Любопытство — твой дар."
                },
                arch_connoisseur: {
                    name: "Сомелье 🍷",
                    desc: "Ты не просто смотришь — ты дегустируешь. Ты пропускал мусор и шел сразу за золотом. Ты точно знаешь, что тебя заводит, и не тратишь время зря. Качество важнее количества."
                },
                arch_wild: {
                    name: "Неукротимый 🦁",
                    desc: "Границы безопасности? Не слышал. Твоя статистика кричит о жажде интенсивности и адреналина. Пока другие мочат ноги у берега, ты ныряешь в бездну. Мое уважение."
                },
                arch_romantic: {
                    name: "Мечтатель 🌹",
                    desc: "Среди хаоса плоти ты искал связь. Мягкость, близость и эмоции управляли твоим выбором. Ты доказал, что даже здесь сердце хочет того, чего хочет сердце."
                },

                outro_free: "Эта история исчезнет. Хочешь сохранить историю и видеть статистику каждый день? <br><b>Переходи на Pro.</b>",
                outro_paid: "Твои секреты в безопасности с нами. <br>До встречи, ковбой. 🤠"
            }
        },

        es: {
            // ESCENARIO 1: PRIMERA VEZ (La Iniciación)
            story_first: {
                intro: [
                    "Hola, {name}... ¿Por fin te atreves a mirar detrás del telón? 👀<br><br>He estado tomando notas en silencio mientras estabas... ocupado. Crees que tus elecciones fueron al azar, pero veo un patrón claro en el caos.",
                    "Bienvenido, {name}. Te estaba esperando. 🕯️<br><br>Has pasado bastante tiempo explorando tus deseos aquí. Es hora de detenerse, recuperar el aliento y mirar tu reflejo en el espejo de los datos."
                ],
                activity: [
                    "No te contuviste, ¿verdad? <br><br>El algoritmo se está calentando solo de procesar tus datos. Echemos un vistazo al volumen de tu curiosidad en números.",
                    "Gimnasia de dedos en su máxima expresión. <br><br>Deslizaste, hiciste clic y buscaste con un propósito claro. Aquí está la escala de tu viaje hasta ahora."
                ],
                timing: [
                    "Cada uno tiene su propio ritmo. ¿El tuyo? Es inconfundible.<br><br>Mientras el mundo giraba, tú tallabas momentos específicos para ti. Sabemos exactamente cuándo salen a jugar tus demonios.",
                ],
                obsession: [
                    "Y ahora... la verdad. <br><br>De cientos de posibilidades, tu cerebro seguía reconectándose con estos temas específicos. No son solo etiquetas; son tu mapa.",
                ],
                archetype: [
                    "Entonces, ¿quién eres realmente? <br><br>Hemos procesado los números, analizado los mapas de calor y encontrado tu alma gemela digital. Este es tu Arquetipo."
                ]
            },

            // ESCENARIO 2: REGULAR / SEMANAL (El Chequeo)
            story_regular: {
                intro: [
                    "Mira quién ha vuelto, {name}. 😏<br><br>Ha sido una semana ocupada para tus pulgares, ¿no? He recopilado todo lo que hiciste desde que hablamos. ¿Listo para ver si tus gustos han evolucionado?",
                    "Te atrapé de nuevo, {name}. ✨<br><br>Otro ciclo, otro conjunto de deseos. Esta vez has cavado más profundo. Vamos a desenvolver el último capítulo de tu historia."
                ],
                activity: [
                    "La consistencia es clave, y tú... bueno, definitivamente eres consistente. <br><br>Los números no mienten. Has estado activo. Muy activo.",
                    "Tus receptores de dopamina deben estar trabajando horas extras. <br><br>Rastreamos cada deslizamiento y cada duda. Aquí está el resumen de tu entrenamiento digital."
                ],
                timing: [
                    "El tiempo vuela cuando te diviertes. <br><br>Pero tu reloj interno tiene un horario específico para el placer. Aquí es cuando suele ocurrir la magia."
                ],
                obsession: [
                    "Hablemos de lo que vive en tu cabeza sin pagar alquiler. <br><br>Probaste cosas nuevas, pero siempre volviste a casa, a estas categorías específicas.",
                ],
                archetype: [
                    "Basado en tu comportamiento reciente, tu vibra ha cambiado... o se ha solidificado. <br><br>Así es como el algoritmo te ve ahora mismo."
                ]
            },

            // TEXTOS COMUNES
            common: {
                total_label: "Interacciones Totales",
                top_label: "Tu Rotación Pesada",
                tags_label: "Paleta de Sabores",
                arch_label: "Tu Arquetipo",
                
                arch_explorer: {
                    name: "El Viajero 🧭",
                    desc: "Te niegas a conformarte. Mientras otros se quedan con lo habitual, tú levantas cada piedra. Deslizaste a la izquierda en lo ordinario para encontrar lo extraordinario. La curiosidad es tu superpoder."
                },
                arch_connoisseur: {
                    name: "El Sommelier 🍷",
                    desc: "No solo miras; seleccionas. Saltaste la basura y fuiste directo al oro. Sabes exactamente lo que te excita y no pierdes el tiempo en nada más. Un verdadero creador de tendencias."
                },
                arch_wild: {
                    name: "El Indomable 🦁",
                    desc: "¿Límites de seguridad? Nunca escuché de ellos. Tus estadísticas muestran hambre de intensidad, adrenalina y lo extremo. Mientras otros mojan los pies, tú te sumerges en lo profundo. Respeto."
                },
                arch_romantic: {
                    name: "El Soñador 🌹",
                    desc: "En medio del caos de la carne, buscaste conexión. La suavidad, la intimidad y la pasión impulsaron tus elecciones. Demostraste que incluso aquí, el corazón quiere lo que quiere."
                },

                outro_free: "Esta historia desaparecerá. ¿Quieres guardar tu historial y ver estadísticas diarias? <br><b>Pásate a Pro.</b>",
                outro_paid: "Tus secretos están a salvo con nosotros. <br>Nos vemos la próxima, vaquero espacial. 🤠"
            }
        },

        de: {
            // SZENARIO 1: DAS ERSTE MAL (Die Einweihung)
            story_first: {
                intro: [
                    "Hey {name}... Hast du dich endlich entschieden, hinter den Vorhang zu blicken? 👀<br><br>Ich habe leise Notizen gemacht, während du... beschäftigt warst. Du denkst, deine Wahl war zufällig? Oh nein. In diesem Chaos gibt es ein klares Muster.",
                    "Willkommen, {name}. Ich habe auf dich gewartet. 🕯️<br><br>Du hast viel Zeit damit verbracht, deine Wünsche hier zu erforschen. Es ist Zeit, kurz innezuhalten, Luft zu holen und dein Spiegelbild im Daten-Spiegel zu betrachten."
                ],
                activity: [
                    "Du hast dich nicht zurückgehalten, oder? <br><br>Der Algorithmus läuft heiß, nur um deine Daten zu verarbeiten. Lass uns das Ausmaß deiner Neugier in Zahlen betrachten.",
                    "Fingergymnastik vom Feinsten. <br><br>Du hast gewischt, geklickt und gesucht mit einem klaren Ziel. Hier ist der Maßstab deiner bisherigen Reise."
                ],
                timing: [
                    "Jeder hat seinen eigenen Rhythmus. Deiner? Er ist unverwechselbar.<br><br>Während sich die Welt weiterdrehte, hast du dir spezielle Momente für dich herausgenommen. Wir wissen genau, wann deine Dämonen zum Spielen herauskommen.",
                ],
                obsession: [
                    "Und nun... die Wahrheit. <br><br>Von hunderten Möglichkeiten hat sich dein Gehirn immer wieder auf diese spezifischen Themen verschaltet. Das sind nicht nur Tags; das ist deine Landkarte.",
                ],
                archetype: [
                    "Also, wer bist du wirklich? <br><br>Wir haben die Zahlen geknackt, die Heatmaps analysiert und deinen digitalen Seelenverwandten gefunden. Das ist dein Archetyp."
                ]
            },

            // SZENARIO 2: REGELMÄẞIG / WÖCHENTLICH (Der Check-up)
            story_regular: {
                intro: [
                    "Sieh mal, wer wieder da ist, {name}. 😏<br><br>Es war eine geschäftige Woche für deine Daumen, nicht wahr? Ich habe alles gesammelt, was du seit unserem letzten Gespräch getan hast. Bereit zu sehen, ob sich dein Geschmack entwickelt hat?",
                    "Wieder erwischt, {name}. ✨<br><br>Ein neuer Zyklus, neue Wünsche. Diesmal hast du tiefer gegraben. Lass uns das neueste Kapitel deiner Geschichte auspacken."
                ],
                activity: [
                    "Konsistenz ist der Schlüssel, und du... nun, du bist definitiv konsistent. <br><br>Die Zahlen lügen nicht. Du warst aktiv. Sehr aktiv. Hier ist dein Leistungsbericht.",
                    "Deine Dopamin-Rezeptoren müssen Überstunden machen. <br><br>Wir haben jeden Swipe und jedes Zögern verfolgt. Hier ist die Zusammenfassung deines digitalen Workouts."
                ],
                timing: [
                    "Die Zeit verfliegt, wenn man Spaß hat. <br><br>Aber deine innere Uhr hat einen genauen Zeitplan für das Vergnügen. Hier passiert normalerweise die Magie."
                ],
                obsession: [
                    "Lass uns darüber reden, was mietfrei in deinem Kopf wohnt. <br><br>Du hast Neues ausprobiert, bist aber immer wieder zu diesen spezifischen Kategorien nach Hause gekommen.",
                ],
                archetype: [
                    "Basierend auf deinem jüngsten Verhalten hat sich deine Aura verändert... oder gefestigt. <br><br>So sieht dich der Algorithmus im Moment."
                ]
            },

            // GEMEINSAME TEXTE
            common: {
                total_label: "Deine Gesamtinteraktionen",
                top_label: "Deine Dauerrotation",
                tags_label: "Die Geschmackspalette",
                arch_label: "Dein Archetyp",
                
                arch_explorer: {
                    name: "Der Entdecker 🧭",
                    desc: "Du gibst dich nicht zufrieden. Während andere beim gewohnten Standard bleiben, drehst du jeden Stein um. Du hast das Gewöhnliche weggewischt, um das Außergewöhnliche zu finden. Neugier ist deine Superkraft."
                },
                arch_connoisseur: {
                    name: "Der Sommelier 🍷",
                    desc: "Du schaust nicht nur zu; du kuratierst. Du hast den Müll übersprungen und bist direkt zum Gold gegangen. Du weißt genau, was dich antörnt, und verschwendest keine Zeit mit anderem. Ein echter Kenner."
                },
                arch_wild: {
                    name: "Der Ungezähmte 🦁",
                    desc: "Sicherheitsgrenzen? Nie gehört. Deine Statistik schreit nach Intensität, Adrenalin und dem Extremen. Während andere nur die Zehen ins Wasser halten, tauchst du ins Tiefe. Respekt."
                },
                arch_romantic: {
                    name: "Der Träumer 🌹",
                    desc: "Im Chaos des Fleisches hast du nach Verbindung gesucht. Sanftheit, Intimität und Leidenschaft haben deine Entscheidungen geleitet. Du hast bewiesen, dass das Herz auch hier will, was es will."
                },

                outro_free: "Diese Geschichte verschwindet gleich. Willst du deinen Verlauf behalten und tägliche Statistiken sehen? <br><b>Hol dir Pro.</b>",
                outro_paid: "Deine Geheimnisse sind bei uns sicher. <br>Bis zum nächsten Mal, Space Cowboy. 🤠"
            }
        }
    };

    window.openLegal = function(type) {
        // 1. Берем текущие переводы из langData
        const t = langData[currentLang] || langData['en'];

        let titleText = "Document";
        let bodyHTML = "<p>Loading...</p>";

        // 2. Выбираем текст в зависимости от типа
        if (type === 'terms') {
            titleText = t.doc_terms;
            bodyHTML = t.terms_text;
        } 
        else if (type === 'privacy') {
            titleText = t.doc_privacy;
            bodyHTML = t.privacy_text;
        } 
        else if (type === 'refund') {
            titleText = t.doc_refund;
            bodyHTML = t.refund_text;
        }

        // 3. Заполняем модальное окно
        const titleEl = document.getElementById('legal-modal-title');
        const contentEl = document.getElementById('legal-modal-content');
        
        if (titleEl) titleEl.innerText = titleText;
        if (contentEl) contentEl.innerHTML = bodyHTML;

        // 4. Открываем
        const modal = document.getElementById('modal-legal-overlay');
        if(modal) {
            modal.classList.add('open');
            modal.style.display = 'flex';
        }
    };

    window.closeLegal = function(e, force) {
        if (force || e.target.id === 'modal-legal-overlay') {
            const modal = document.getElementById('modal-legal-overlay');
            if(modal) {
                modal.classList.remove('open');
                modal.style.display = 'none';
            }
        }
    };

    window.openAbout = function() {
        const t = langData[currentLang] || langData['en'];

        const titleEl = document.getElementById('about-modal-title');
        const introEl = document.getElementById('about-intro');
        const descEl = document.getElementById('about-desc');

        if (titleEl) titleEl.innerText = t.about_title; 
        if (introEl) introEl.innerText = t.about_intro;
        if (descEl) descEl.innerText = t.about_desc;

        const modal = document.getElementById('modal-about-overlay');
        if (modal) {
            modal.classList.add('open');
            modal.style.display = 'flex';
        }
    };
    
    window.closeAbout = function(e, force) {
        if (force || e.target.id === 'modal-about-overlay') {
            const modal = document.getElementById('modal-about-overlay');
            if(modal) {
                modal.classList.remove('open');
                modal.style.display = 'none';
            }
        }
    };

    const EXTREME_TAGS = ['extreme', 'blood', 'scat', 'piss', 'pain', 'torture', 'vomit', 'enema', 'fisting', 'needle-play'];
    const SPICY_TAGS = ['bdsm', 'kinky', 'fetish', 'bondage', 'domination', 'submission', 'spanking'];
    const LGBT_TAGS = ['gay', 'trans', 'shemale', 'bi', 'crossdresser'];

    const filterCats = [
        { id: 'straight', key: 'tag_straight' },
        { id: 'gay', key: 'tag_gay' },
        { id: 'lesbian', key: 'tag_lesbian' },
        { id: 'trans', key: 'tag_trans' }
    ];

    window.onload = () => {
        initLanguage();
        initTheme();
        initIntensity();
        initDecoSettings();
        randomizeDecorations();
        renderModifiers();
        renderHistory();
        updateCounts();
        
        // 2. Инициализация систем
        initAgeGate();
        initSwipeCards();
        
        // 3. Установка платформы
        const savedPlatform = localStorage.getItem('xch_platform');
        if (savedPlatform) {
            const platformSelect = document.getElementById('platform');
            if (platformSelect) platformSelect.value = savedPlatform;
        }
        updateLink();

        // 4. Текст и Анимация слота
        setWelcomeMessage(); 
        
        // Сброс флага первой генерации
        isFirstGen = true; 
        
        // Запуск "холостого хода" слота (бегущая строка)
        initIdleSlot(); 

        updateSubscriptionUI();
        
        // 5. Инициализация Ориентации
        const oriSelect = document.getElementById('orientation-select');
        if (oriSelect) oriSelect.value = currentOrientation;

        // 6. Верстка (в самом конце, чтобы всё уже было готово)
        checkLayout(); 
        window.addEventListener('resize', checkLayout);
        
        // Принудительно ставим класс для мобильной шапки
        document.body.classList.add('tab-home-active');
    };

    async function loadData() {
        try {
            // Пытаемся загрузить JSON файл (1200+ фетишей)
            const response = await fetch('data.json');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Парсим JSON в переменную data
            data = await response.json();
            console.log(`Успешно загружено ${data.length} категорий.`);

            // 3. Запускаем инициализацию приложения ТОЛЬКО после загрузки данных
            initApp();

        } catch (error) {
            console.error('Ошибка загрузки data.json:', error);
            document.body.innerHTML = '<h2 style="color:white;text-align:center;margin-top:50px;">Error loading data.json. Check console.</h2>';
        }
    }

    function initApp() {
        // Инициализация данных
        initLanguage();
        initTheme();
        initIntensity();
        randomizeDecorations(); 
        renderModifiers();
        renderHistory();
        updateCounts();
        
        // Инициализация систем
        initAgeGate();
        initSwipeCards();
        initModes();
        
        // Установка платформы
        const savedPlatform = localStorage.getItem('xch_platform');
        if (savedPlatform) {
            const platformSelect = document.getElementById('platform');
            if (platformSelect) platformSelect.value = savedPlatform;
        }
        updateLink();

        // Текст и Анимация слота
        setWelcomeMessage(); 
        
        isFirstGen = true; 
        
        // Запуск "холостого хода"
        initIdleSlot(); 

        updateSubscriptionUI();
        
        // Инициализация Ориентации
        const oriSelect = document.getElementById('orientation-select');
        if (oriSelect) oriSelect.value = currentOrientation;

        // Верстка
        checkLayout(); 
        window.addEventListener('resize', checkLayout);
        
        document.body.classList.add('tab-home-active');
    }

    window.onload = loadData;

    function setWelcomeMessage() {
        const statusEl = document.getElementById('status-text');
        if(!statusEl) return;
        
        const phrases = welcomePhrases[currentLang];
        // Ставим случайную фразу и делаем цвет акцентным
        statusEl.innerText = phrases[Math.floor(Math.random() * phrases.length)];
        statusEl.style.color = "var(--accent)"; 
    }

    function logActivity(type, itemId, tags) {
        const logEntry = {
            type: type, // 'gen', 'watch', 'like', 'dislike'
            id: itemId,
            tags: tags || [],
            ts: Date.now()
        };
        activityLog.push(logEntry);
        if (activityLog.length > 5000) activityLog = activityLog.slice(-5000);
        localStorage.setItem(STORAGE.ACTIVITY_LOG, JSON.stringify(activityLog));
        updateExploredCount();
    }

    function updateExploredCount() {
        const total = data.length;
        
        // Берем уникальные ID из полного лога активности, а не из короткой истории
        const uniqueExplored = new Set(activityLog.map(h => h.id)).size;
        
        const t = langData[currentLang];
        // Используем локализованную строку
        if (t && t.explored_txt) {
            const text = t.explored_txt.replace('{n}', uniqueExplored).replace('{t}', total);
            const el = document.getElementById('explored-count');
            if(el) el.innerText = text;
        }
    }

    function adjustTagScoresByTags(tags, delta) {
        if (!tags) return;
        
        // 1. Time Decay: Уменьшаем вес ВСЕХ тегов перед обновлением текущих
        // Это гарантирует, что свежие лайки важнее старых
        for (let key in tagScores) {
            if (tagScores[key] > 0) tagScores[key] *= TAG_DECAY_RATE;
        }

        // 2. Обновляем текущие теги
        const ignore = ['universal', 'straight', 'male', 'female', 'adult', 'video'];
        
        tags.forEach(tag => {
            if (ignore.includes(tag)) return;

            if (!tagScores[tag]) tagScores[tag] = 0;
            
            // Добавляем вес
            tagScores[tag] += delta;

            // 3. Кэппинг (Ограничение): Не даем весу улететь в космос
            // Максимум 100, Минимум -100
            if (tagScores[tag] > 100) tagScores[tag] = 100;
            if (tagScores[tag] < -100) tagScores[tag] = -100;
        });

        localStorage.setItem(STORAGE.TAG_SCORES, JSON.stringify(tagScores));
    }

    function adjustTagScores(item, delta) {
        if (!item) return;
        const tags = getCombinedTags(item);
        adjustTagScoresByTags(tags, delta);
    }

    function calculateItemWeight(item) {
        // Базовые проверки
        if (blacklist.includes(item.id)) return 0;
        if (cooldownList.includes(item.id)) return 0.1;

        let score = 50; 

        // === РЕЖИМЫ ===
        if (currentAppMode === 'pleasure') {
            // НАСЛАЖДЕНИЕ: Максимально близкое к лайкам
            if (favorites.includes(item.id)) score += 1000; // Огромный приоритет лайкнутым
            
            item.tags.forEach(tag => {
                if (tagScores[tag] && tagScores[tag] > 0) {
                    score += (tagScores[tag] * 3); // Утраиваем влияние положительных тегов
                }
            });
            
        } else {
            // ИССЛЕДОВАНИЕ: Новое, но с учетом вкусов
            if (favorites.includes(item.id)) score = 1; // Лайкнутое почти не показываем
            
            // Случайный буст для "свежести"
            score += Math.random() * 50;
            
            item.tags.forEach(tag => {
                // Учитываем теги, но слабее, чтобы не зацикливаться
                if (tagScores[tag]) score += tagScores[tag]; 
            });
        }

        // Фильтры ориентации 
        if (currentOrientation === 'gay' && item.tags.includes('gay')) score += 50;
        if (currentOrientation === 'trans' && item.tags.some(t => ['trans', 'shemale'].includes(t))) score += 50;
        if (currentOrientation === 'lesbian' && item.tags.includes('lesbian')) score += 50;
        
        if (currentOrientation === 'gay' && item.tags.includes('straight')) score -= 100;
        if (currentOrientation === 'hetero' && (item.tags.includes('gay') || item.tags.includes('shemale'))) score -= 100;

        return Math.max(1, score);
    }

    function getWeightedRandom(items) {
        // Шаг 1: Считаем веса
        let weightedItems = items.map(item => {
            return { item: item, weight: calculateItemWeight(item) };
        });

        // Шаг 2: Убираем совсем неподходящие (вес <= 1)
        // Но оставляем хотя бы что-то, если все отфильтровались
        let candidates = weightedItems.filter(i => i.weight > 1);
        if (candidates.length === 0) candidates = weightedItems;

        // Шаг 3: Exploration vs Exploitation (Исследование или Использование)
        // С шансом 20% мы игнорируем веса и берем случайное из топа 50% (чтобы подкинуть новое)
        const isExploration = Math.random() < 0.2; 

        if (isExploration && candidates.length > 5) {
            // Берем случайный из первой половины списка (но не обязательно лучший)
            // Сортируем по весу
            candidates.sort((a, b) => b.weight - a.weight);
            // Отрезаем топ 50%
            const sliceIndex = Math.floor(candidates.length / 2);
            const pool = candidates.slice(0, sliceIndex);
            return pool[Math.floor(Math.random() * pool.length)].item;
        }

        // Шаг 4: Классическая рулетка (Exploitation)
        let totalWeight = candidates.reduce((sum, i) => sum + i.weight, 0);
        let random = Math.random() * totalWeight;
        
        for (const candidate of candidates) {
            if (random < candidate.weight) return candidate.item;
            random -= candidate.weight;
        }

        return candidates[0].item;
    }

    function resetControls() {
        document.querySelector('.gen-controls').classList.remove('visually-hidden');
        document.getElementById('mods-block').classList.remove('visually-hidden');
        document.getElementById('card-block').classList.remove('is-spinning');
    }

    function getExplanationText(mode) {
        const t = langData[currentLang];
        let reason = null;

        // 1. Напоминание посмотреть/повторить/одуматься
        if (mode === 'wl_reminder') {
            const phrases = wlReminderPhrases[currentLang] || wlReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        else if (mode === 'fav_reminder') {
            const phrases = favReminderPhrases[currentLang] || favReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        else if (mode === 'ban_reminder') {
            const phrases = banReminderPhrases[currentLang] || banReminderPhrases['en'];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }
        // 2. Возврат (Кнопка Undo)
        else if (mode === 'undo') {
            reason = t.expl_undo; 
        }
        // 3. История (Клик из списка)
        else if (mode === 'history') {
            reason = t.expl_hist;
        }
        // 4. Похожее (Кнопка Similar)
        else if (mode === 'similar') {
            reason = t.expl_sim;
        } 
        // 5. Клик по тегу (В каталоге)
        else if (mode === 'tag_click') {
            reason = t.expl_tag_click; 
        } 
        // 6. Обычная генерация (Smart / Random)
        else {
            // === УМНЫЙ ПОИСК ПРИЧИНЫ ===
            let bestTag = null;
            let maxScore = 0;
            
            const ignoreTags = ['universal', 'straight', 'gay', 'lesbian', 'trans', 'bi', 'male', 'female'];
            
            currentItem.tags.forEach(tag => {
                if (!ignoreTags.includes(tag) && tagScores[tag] && tagScores[tag] > 5) {
                    if (tagScores[tag] > maxScore) {
                        maxScore = tagScores[tag];
                        bestTag = tag;
                    }
                }
            });
            
            if (bestTag) {
                // Ищем В ИСТОРИИ или ЛАЙКАХ предмет с этим тегом
                let sourceItem = null;
                if (favorites.length > 0) {
                    const favItem = favorites.map(id => data.find(x => x.id === id)).find(item => item && item.tags.includes(bestTag));
                    if (favItem) sourceItem = favItem;
                }
                
                if (!sourceItem && historyData.length > 0) {
                    const histItem = historyData.map(h => data.find(x => x.id === h.id)).find(item => item && item.id !== currentItem.id && item.tags.includes(bestTag));
                    if (histItem) sourceItem = histItem;
                }

                if (sourceItem) {
                    const reasonName = getLocalizedName(sourceItem);
                    reason = t.expl_score + reasonName; 
                } else {
                    let displayTag = bestTag.charAt(0).toUpperCase() + bestTag.slice(1);
                    reason = t.expl_score + displayTag; 
                }
            }
            else if (favorites.includes(currentItem.id)) {
                reason = t.expl_fav; // "Потому что ты любишь это"
            }
        }
        return reason;
    }

    function prepareElementsForFadeIn() {
        // Убрали старые ID, добавили status-text
        const ids = ['result-desc', 'status-text', 'related-block']; 
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('fade-visible');
                el.classList.add('fade-hidden');
            }
        });
    }

    function finishGeneration(item, mode) {
        isGenerating = false;
        
        addToHistory(item);

        cooldownList.push(item.id);
        if (cooldownList.length > COOLDOWN_SIZE) {
            cooldownList.shift();
        }

        logActivity('gen', item.id, item.tags);
        
        const card = document.getElementById('card-block');
        if(card) {
            card.classList.add('has-results');
        }

        renderResultUI(item, mode);
    }

    function forceShowResult(item, mode = 'history') {
        isGenerating = false;
        
        // 1. ОТКЛЮЧАЕМ СТАРТОВЫЙ РЕЖИМ
        isFirstGen = false; 
        hasInteractedWithCurrent = false; 
        hasWatchedCurrentItem = false; 

        // 2. СКРЫВАЕМ КНОПКУ СТАРТА И ПОКАЗЫВАЕМ ИНТЕРФЕЙС
        // Если пользователь зашел сразу в историю, не нажимая "Let's Go", эти элементы могут быть не в том состоянии.
        const startBtn = document.getElementById('start-btn-container');
        if(startBtn) {
            startBtn.classList.add('hidden-initial');
            startBtn.style.display = 'none';
        }

        // Убеждаемся, что обертка карточки на месте
        const wrapper = document.getElementById('card-anim-wrapper');
        if(wrapper) {
            wrapper.style.transform = '';
            wrapper.style.opacity = '1';
            // Добавляем легкую анимацию появления (Fly In Left), чтобы было понятно, что контент сменился
            wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
            void wrapper.offsetWidth; // Триггер перерисовки
            wrapper.classList.add('anim-fly-left');
        }

        // 3. СКРОЛЛ НАВЕРХ
        const mainContent = document.querySelector('.main-content') || document.querySelector('.tab-content.active');
        if(mainContent) mainContent.scrollTop = 0;
        
        addToHistory(item);
        
        // Запись в лог
        logActivity('gen', item.id, item.tags);

        // 4. РЕНДЕР
        renderResultUI(item, mode);
        
        // Снимаем класс анимации через секунду
        setTimeout(() => {
            if(wrapper) wrapper.classList.remove('anim-fly-left');
        }, 800);
    }

    function renderBadges() {
        const badgeWrapper = document.getElementById('badge-wrapper');
        badgeWrapper.innerHTML = '';
        const t = langData[currentLang];
        
        const safetyTags = ['straight', 'universal', 'vanilla'];
        const isSafe = currentItem.tags.some(t => safetyTags.includes(t));
        const isExtreme = currentItem.tags.some(t => EXTREME_TAGS.includes(t));
        const isBDSM = currentItem.tags.includes('bdsm') || currentItem.tags.includes('bondage');
        const hasLgbtTag = currentItem.tags.some(t => ['gay','trans','shemale','lesbian', 'bi'].includes(t));
        const showLgbt = hasLgbtTag && !isSafe;
        const isNiche = currentItem.tags.includes('fetish') || currentItem.tags.includes('scat');

        // Функция для создания HTML бейджа с тултипом
        const createBadge = (className, label, desc) => {
            return `
                <div class="warning-badge ${className}" style="position:relative; overflow:visible; cursor:help;">
                    ${label}
                    <div class="badge-tooltip">${desc}</div>
                </div>
            `;
        };

        // Логика добавления бейджей (теперь с тултипами внутри)
        // Добавляем класс 'has-tooltip' для обработки кликов на мобильных (опционально через CSS :hover)
        
        if(isExtreme) { 
            badgeWrapper.innerHTML += createBadge('badge-extreme', t.badge_extreme, t.badge_desc_extreme);
        }
        else if(isBDSM) { 
            badgeWrapper.innerHTML += createBadge('', t.badge_bdsm, t.badge_desc_bdsm); // Default dark style
            // Добавим стиль для BDSM если его нет в CSS
            badgeWrapper.lastElementChild.style.background = "#333";
        }
        else if(showLgbt) { 
            badgeWrapper.innerHTML += createBadge('badge-lgbt', t.badge_lgbt, t.badge_desc_lgbt);
        }
        else if(isNiche) {
            badgeWrapper.innerHTML += createBadge('badge-niche', t.badge_niche, t.badge_desc_niche);
        }
    }

    function renderExplanation(mode) {
        const explText = document.getElementById('explanation-text');
        const t = langData[currentLang];
        let reason = "";

        if (mode === 'similar') {
            reason = t.expl_sim;
        } else if (mode === 'tag_click') {
            reason = t.expl_tag_click; 
        } else {
            let bestTag = null;
            let maxScore = 0;
            currentItem.tags.forEach(tag => {
                if (tagScores[tag] && tagScores[tag] > 5) {
                    if (tagScores[tag] > maxScore) {
                        maxScore = tagScores[tag];
                        bestTag = tag;
                    }
                }
            });
            if (bestTag) reason = t.expl_score + bestTag;
            else if (favorites.includes(currentItem.id)) reason = t.expl_fav;
        }
        explText.innerText = reason;
    }

    function renderRelatedItems() {
        const relatedEl = document.getElementById('related-tags');
        const relatedBlock = document.getElementById('related-block');
        const btnSimilar = document.getElementById('btn-similar');
        
        relatedEl.innerHTML = '';
        
        // 1. Хелпер для токенов (слов)
        const getTokens = (text) => {
            if (!text) return [];
            const stopWords = [
                'the', 'and', 'or', 'of', 'in', 'on', 'at', 'to', 'a', 'an', 'is', 'are', 
                'for', 'with', 'by', 'from', 'using', 'being', 'getting', 'into', 'over', 'sex',
                'video', 'movie', 'porn', 'compilation'
            ];
            return text.toLowerCase()
                      .split(/[\s/\-(),.]+/g)
                      .filter(w => w.length > 2 && !stopWords.includes(w));
        };

        const currentTokens = new Set([
            ...getTokens(currentItem.name),
            ...getTokens(currentItem.desc_en)
        ]);

        // 2. Определение пола текущего предмета (Гендерный щит)
        const maleTags = ['gay', 'male', 'man', 'boy', 'bear', 'twink', 'jock', 'dick', 'cock', 'father', 'grandpa'];
        const femaleTags = ['female', 'woman', 'girl', 'lesbian', 'milf', 'mom', 'sister', 'pussy', 'tits', 'boobs', 'vagina'];
        
        const isCurrentMale = currentItem.tags.some(t => maleTags.includes(t));
        const isCurrentFemale = currentItem.tags.some(t => femaleTags.includes(t));

        let candidates = data.map(item => {
            if (item.id === currentItem.id) return null;

            // === БАЗОВЫЕ ФИЛЬТРЫ (Как и раньше) ===
            if (currentIntensity === 1) { 
                if (item.tags.some(t => EXTREME_TAGS.includes(t) || SPICY_TAGS.includes(t))) return null;
            } else if (currentIntensity === 2) { 
                if (item.tags.some(t => EXTREME_TAGS.includes(t))) return null;
            }

            // === ФИЛЬТР ОРИЕНТАЦИИ ДЛЯ ПОХОЖИХ ===
            // Если мы в режиме Гей, не показываем Лесби/Гетеро в похожих, даже если теги совпадают
            const itemIsGay = item.tags.includes('gay');
            const itemIsStraight = item.tags.includes('straight');
            const itemIsLesbian = item.tags.includes('lesbian');
            
            if (currentOrientation === 'gay' && !itemIsGay) return null;
            if (currentOrientation === 'hetero' && itemIsGay) return null;

            // === ГЕНДЕРНЫЙ ЩИТ (Gender Guard) ===
            // Если текущий предмет МУЖСКОЙ (напр. Bear), штрафуем ЖЕНСКИЕ (напр. SSBBW), даже если у них общий тег "Fat"
            const itemIsMale = item.tags.some(t => maleTags.includes(t));
            const itemIsFemale = item.tags.some(t => femaleTags.includes(t));

            if (isCurrentMale && !isCurrentFemale && itemIsFemale) return null; // Ищем мужское, убираем женское
            if (isCurrentFemale && !isCurrentMale && itemIsMale) return null; // Ищем женское, убираем мужское

            // === ПОДСЧЕТ ОЧКОВ ===
            let score = 0;

            // А. Текст (вес: 5)
            const candidateTokens = [...getTokens(item.name), ...getTokens(item.desc_en)];
            let textMatches = 0;
            candidateTokens.forEach(token => {
                if (currentTokens.has(token)) textMatches++;
            });
            score += textMatches * 5;

            // Б. Теги (Вес: 10 за редкие, 0 за мусорные)
            // Расширенный список мусорных тегов, которые не делают предметы "похожими"
            const trashTags = [
                'universal', 'straight', 'gay', 'lesbian', 'bi', 'male', 'female', 'adult', 
                'roleplay', 'video', 'hd', 'soft', 'hardcore', 'fetish', 'kinky', 'fantasy',
                'body-part', 'action', 'hair'
            ];

            item.tags.forEach(tag => {
                if (currentItem.tags.includes(tag)) {
                    if (!trashTags.includes(tag)) {
                        score += 15; // Увеличили вес совпадения специфичных тегов
                    }
                }
            });

            // Если очков мало - это случайное совпадение, убираем
            if (score < 5) return null;

            return { item: item, score: score };
        }).filter(x => x !== null);

        candidates.sort((a, b) => b.score - a.score);
        const topCandidates = candidates.slice(0, 5);

        if (topCandidates.length > 0) {
            topCandidates.forEach(cand => {
                const item = cand.item;
                const name = getLocalizedName(item);
                const btn = document.createElement('div');
                btn.className = 'related-item-btn';
                btn.innerText = name;
                
                btn.onclick = () => {
                    // Сначала проверяем лимит
                    if (checkGenerationLimit()) {
                        // Если ок — открываем
                        forceShowResult(item, 'similar');
                    }
                };
                
                relatedEl.appendChild(btn);
            });
            relatedBlock.classList.remove('hidden-initial');
            relatedBlock.classList.add('fade-visible');
            if(btnSimilar) {
                btnSimilar.classList.remove('hidden-initial');
                btnSimilar.style.display = 'flex';
            }
        } else {
            relatedBlock.classList.add('hidden-initial'); 
            if(btnSimilar) btnSimilar.style.display = 'none'; 
        }
    }

    function savePlatform(val) {
        // Сохраняем локально
        localStorage.setItem('xch_platform', val);
        
        // Обновляем цвета и ссылку (твоя старая функция)
        updateLink(); 
    }

    function getCombinedTags(item) {
        if (!item || !item.tags) return [];
        
        // Берем теги жанра
        const combined = [...item.tags];
        
        // Добавляем активные модификаторы (приводим к нижнему регистру)
        activeMods.forEach(modKey => {
            const tag = modKey.toLowerCase();
            if (!combined.includes(tag)) {
                combined.push(tag);
            }
        });
        
        return combined;
    }

    function handleOutboundClick() {
        if(!currentItem) return;
        
        // Таймер
        watchStartTime = Date.now();
        itemBeingWatched = currentItem;

        // === 1. УДАЛЕНИЕ ИЗ WATCH LATER ===
        if (watchLater.includes(currentItem.id)) {
            toggleWatchLater(); // Эта функция сама удалит ID, обновит счетчик и кнопку
        }

        // === 2. ЛОГИКА ОЧКОВ (Один раз) ===
        if(!hasWatchedCurrentItem) {
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, 3); 
            logActivity('watch', currentItem.id, fullTags);
            hasWatchedCurrentItem = true;
            hasInteractedWithCurrent = true;
        }
    }

    function addToHistory(item) {
        const entry = { id: item.id, timestamp: Date.now() };
        historyData = historyData.filter(x => x.id !== item.id);
        historyData.unshift(entry);
        if(historyData.length > 30) historyData.pop();
        localStorage.setItem(STORAGE.HISTORY, JSON.stringify(historyData));
        renderHistory();
        updateExploredCount();
    }
    
    function getLocalizedName(item) {
        if (!item) return "";
        if (currentLang === 'ru' && item.name_ru) return item.name_ru;
        if (currentLang === 'es' && item.name_es) return item.name_es;
        if (currentLang === 'de' && item.name_de) return item.name_de;
        return item.name; // По умолчанию английский
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (historyData.length === 0) {
            list.innerHTML = `<div class="ios-row" style="justify-content:center; color:var(--text-secondary); font-size:14px;">${t.hist_empty}</div>`;
            return;
        }

        historyData.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;
            const div = document.createElement('div');
            div.className = 'history-item-ios'; 
            
            const name = getLocalizedName(item);
            
            div.innerHTML = `<span>${name}</span><span style="color:var(--accent); font-size:18px;">↺</span>`;
            div.onclick = () => { switchTab('home'); forceShowResult(item, 'history'); };
            list.appendChild(div);
        });
    }

    function filterData() {
        const SAFETY_NET = ['straight', 'universal', 'vanilla'];
        const recentIds = historyData.slice(0, 50).map(entry => entry.id);

        let candidates = data.filter(item => {
            // 1. Черный список и История
            if (blacklist.includes(item.id)) return false;
            if (recentIds.includes(item.id)) return false;

            // 2. Интенсивность (Safe/Spicy)
            if (currentIntensity === 1) {
                // В Safe убираем экстрим и спайси
                if (item.tags.some(t => EXTREME_TAGS.includes(t) || SPICY_TAGS.includes(t))) return false;
            }
            if (currentIntensity === 2) {
                // В Spicy убираем только экстрим
                if (item.tags.some(t => EXTREME_TAGS.includes(t))) return false;
            }

            // === 3. ФИЛЬТРАЦИЯ ПО ОРИЕНТАЦИИ ===
            
            // Определяем, к каким группам относится фетиш
            const isGay = item.tags.includes('gay');
            const isTrans = item.tags.some(t => ['trans', 'shemale', 'futanari', 'crossdresser'].includes(t));
            const isLesbian = item.tags.includes('lesbian');
            const isStraight = item.tags.includes('straight');
            const isBi = item.tags.includes('bi');
            
            // Группа "ЛГБТ" для Гетеро-фильтра
            const isLgbtForHetero = isGay || isTrans || isBi; 

            if (currentOrientation === 'hetero') {
                // "Скрывать все ЛГБТ, кроме лесби"
                // Если есть гей/транс/би теги - скрываем.
                if (isLgbtForHetero && !isLesbian) return false;
            }
            else if (currentOrientation === 'gay') {
                // "Скрывать straight, кроме тех, где есть gay"
                // То есть чистое гетеро скрываем. Гетеро + Гей (Би) - оставляем.
                if (isStraight && !isGay) return false;
            }
            else if (currentOrientation === 'trans') {
                // "Как с гей, только для транс"
                // Скрываем straight, если нет транс-тегов
                if (isStraight && !isTrans) return false;
            }
            // 'pan' - показывает всё, фильтров нет.

            return true;
        });

        // Fallback: Если фильтры слишком жесткие (почти невозможная ситуация с новой логикой, но оставим)
        if (candidates.length < 3) {
            candidates = data.filter(item => !blacklist.includes(item.id));
        }
        
        return candidates;
    }

    function renderResultName() {
        if (!currentItem) return;
        
        // 1. Получаем базовое название (на нужном языке)
        const displayName = getLocalizedName(currentItem);
        
        // 2. Формируем HTML для модификаторов (точно так же, как при генерации результата)
        let modifiersHtml = "";
        
        if (activeMods.size > 0) {
            // Проходим по активным модам и ищем их перевод
            const modNames = Array.from(activeMods).map(key => {
                const m = modifiersData.find(x => x.key === key);
                if (m) {
                    if (currentLang === 'ru') return m.ru;
                    if (currentLang === 'es') return m.es;
                    if (currentLang === 'de') return m.de;
                    return m.en;
                }
                return key;
            });
            
            // Собираем строку: + POV + Hardcore
            if (modNames.length > 0) {
                // Важно: span с opacity создает эффект "второстепенного" текста
                modifiersHtml = ` <span style="color:var(--accent); font-weight:300; opacity:0.9;">+ ${modNames.join(" + ")}</span>`;
            }
        }

        // 3. Обновляем элемент на странице
        const titleEl = document.getElementById('result-text');
        if (titleEl) {
            // Используем innerHTML, чтобы отобразился цветной span, а не просто текст тегов
            titleEl.innerHTML = `${displayName}${modifiersHtml}`;
        }
        
        // 4. Обновляем описание (на всякий случай, если язык менялся)
        let desc = currentItem.desc_en;
        if (currentLang === 'ru' && currentItem.desc_ru) desc = currentItem.desc_ru;
        else if (currentLang === 'es' && currentItem.desc_es) desc = currentItem.desc_es;
        else if (currentLang === 'de' && currentItem.desc_de) desc = currentItem.desc_de;

        const descEl = document.getElementById('result-desc');
        if (descEl) descEl.innerText = desc || "";
    }

    function updateLink() {
        const platform = document.getElementById('platform').value;
        const root = document.documentElement;
        const currentThemeId = localStorage.getItem('xch_theme_id') || 'dark';
        
        // Находим текущую тему
        const currentTheme = APP_THEMES.find(t => t.id === currentThemeId);

        // Логика цветов сайтов
        const colors = {
            'xh': ['#9b59b6', '#b07cc6'],
            'ph': ['#ff9900', '#ffbd55'],
            'xv': ['#de2828', '#ff6b6b'],
            'sb': ['#ffd700', '#ffe666'],
            'yp': ['#ff3366', '#ff668a'],
            'rt': ['#ff0000', '#ff4d4d'],
            'google': ['#4285F4', '#7aaafc']
        };
        const [platMain, platLight] = colors[platform] || colors['xh'];

        if (!currentTheme || !currentTheme.accent) {
            root.style.setProperty('--accent', platMain);
            root.style.setProperty('--accent-light', platLight);
        }

        if(!currentItem) return;
        
        // НОВЫЙ ID КНОПКИ
        const btnWatch = document.getElementById('btn-t-watch');
        const forceEn = document.getElementById('force-en').checked;
        const useRu = (currentLang === 'ru' && !forceEn);
        
        let queryName = useRu ? (currentItem.name_ru || currentItem.name) : currentItem.name;
        let queryParts = [queryName];
        activeMods.forEach(key => {
            const mod = modifiersData.find(m => m.key === key);
            queryParts.push(useRu ? mod.ru : mod.en);
        });
        
        let plusQuery = queryParts.join("+").toLowerCase();
        let url = "";
        
        if (platform === 'google') {
            url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(queryParts.join(" ") + " porn")}`;
        } else {
            switch(platform) {
                case 'xh': url = `https://xhamster.com/search/${plusQuery}`; break;
                case 'ph': url = `https://www.pornhub.com/video/search?search=${plusQuery}`; break;
                case 'xv': url = `https://www.xvideos.com/?k=${plusQuery}`; break;
                case 'sb': url = `https://spankbang.com/s/${plusQuery}/`; break;
                case 'yp': url = `https://www.youporn.com/search/?query=${plusQuery}`; break;
                case 'rt': url = `https://www.redtube.com/?search=${plusQuery}`; break;
            }
        }
        if(btnWatch) btnWatch.href = url;
    }

    function saveLists() {
        localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
        localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
    }

    function updateCounts() { 
        document.getElementById('count-fav').innerText = favorites.length; 
        
        const banBadge = document.getElementById('count-ban');
        if(banBadge) banBadge.innerText = blacklist.length;
        
        const wlBadge = document.getElementById('count-wl');
        if(wlBadge) wlBadge.innerText = watchLater.length;
        
        updateExploredCount(); // Вызов соседней функции
    }

    function exportData() {
        const exportObj = {
            // Добавляем activityLog в экспорт
            activityLog: activityLog, 
            blacklist, 
            favorites, 
            tagScores, 
            history: historyData,
            settings: { 
                lang: currentLang, 
                theme: localStorage.getItem(STORAGE.THEME), 
                intensity: currentIntensity,
                platform: localStorage.getItem('xch_platform') || 'xh',
            sub: subscriptionLevel
            }
        };
        // Используем clipboard API для удобства, если поддерживается, или prompt
        const dataStr = JSON.stringify(exportObj);
        
        try {
            navigator.clipboard.writeText(dataStr).then(() => {
                alert("Data copied to clipboard!");
            }).catch(() => {
                prompt("Copy this data:", dataStr);
            });
        } catch (e) {
            prompt("Copy this data:", dataStr);
        }
    }

    function importData() {
        const str = prompt("Paste data here:");
        if(!str) return;
        try {
            const obj = JSON.parse(str);
            
            // Восстанавливаем все поля
            if(obj.blacklist) blacklist = obj.blacklist;
            if(obj.favorites) favorites = obj.favorites;
            if(obj.tagScores) tagScores = obj.tagScores;
            if(obj.history) historyData = obj.history;
            if(obj.activityLog) activityLog = obj.activityLog; // Восстанавливаем лог
            
            // Настройки
            if(obj.settings) {
                if (obj.settings.intensity) currentIntensity = obj.settings.intensity;
                if (obj.settings.platform) localStorage.setItem('xch_platform', obj.settings.platform);
                if (obj.settings.lang) localStorage.setItem(STORAGE.LANG, obj.settings.lang);
            }

            if (obj.settings && obj.settings.sub) {
                localStorage.setItem('xch_sub_level', obj.settings.sub);
                subscriptionLevel = obj.settings.sub;
            }
            
            // Сохраняем в память браузера
            saveLists();
            localStorage.setItem(STORAGE.TAG_SCORES, JSON.stringify(tagScores));
            localStorage.setItem(STORAGE.HISTORY, JSON.stringify(historyData));
            localStorage.setItem(STORAGE.ACTIVITY_LOG, JSON.stringify(activityLog)); // Сохраняем лог
            localStorage.setItem(STORAGE.INTENSITY, currentIntensity);
            
            alert("Import successful! Reloading page..."); 
            location.reload();
        } catch(e) { 
            console.error(e);
            alert("Error parsing data! Check format."); 
        }
    }

    function renderModifiers() {
        const container = document.getElementById('mod-container'); 
        container.innerHTML = '';
        
        // === ЗАГОЛОВОК ===
        const t = langData[currentLang] || langData['en'];
        const titleText = t.add_genre || "Add to genre:";
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'mod-title';
        titleDiv.innerText = titleText;
        container.appendChild(titleDiv);

        modifiersData.forEach(mod => {
            const tag = document.createElement('div'); 
            tag.className = 'tag';
            if(activeMods.has(mod.key)) tag.classList.add('selected');
            
            let text = mod.en;
            if (mod[currentLang]) {
                text = mod[currentLang];
            }
            
            tag.innerText = text;
            tag.onclick = () => {
                if(activeMods.has(mod.key)) activeMods.delete(mod.key); else activeMods.add(mod.key);
                renderModifiers(); 
                renderResultName(); 
                updateLink();
            };
            container.appendChild(tag);
        });
    }

    function initIntensity() {
        const saved = localStorage.getItem(STORAGE.INTENSITY);
        if(saved) currentIntensity = parseInt(saved);
        document.getElementById('intensity-slider').value = currentIntensity;
        updateIntensity(currentIntensity);
    }
    
    function updateIntensity(val) {
        currentIntensity = parseInt(val);
        localStorage.setItem(STORAGE.INTENSITY, currentIntensity);
        document.querySelectorAll('.intensity-label').forEach(el => el.classList.remove('active'));
        const activeLabel = document.getElementById('lbl-' + currentIntensity);
        if(activeLabel) activeLabel.classList.add('active');
    }

    function initIdleSlot() {
        const reel = document.getElementById('slot-reel');
        if (!reel) return;

        // Берем 30 случайных элементов
        const sample = [...data].sort(() => 0.5 - Math.random()).slice(0, 30);
        
        // Дублируем список 4 раза для бесшовности
        let html = '';
        // Генерируем HTML один раз
        const itemsHtml = sample.map(item => `<div class="slot-item">${getLocalizedName(item)}</div>`).join('');
        
        // Вставляем 4 копии
        reel.innerHTML = itemsHtml + itemsHtml + itemsHtml + itemsHtml;

        reel.className = 'slot-reel idle'; 
        reel.style.transform = ''; 
        reel.style.transition = ''; 
    }

    function checkLayout() {
        const isPC = window.innerWidth > 768;
        
        // 1. Исходные блоки
        const bPrefs = document.getElementById('block-prefs');    
        const bAccount = document.getElementById('block-account'); 
        const bExtras = document.getElementById('block-extras');
        
        // 2. Целевые контейнеры
        const sidebar = document.getElementById('pc-settings-mount'); 
        
        const mPrefs = document.getElementById('mount-prefs');     
        const mAccount = document.getElementById('mount-account'); 

        if (isPC) {
            // === ПК РЕЖИМ (ВСЁ В САЙДБАРЕ) ===
            if (sidebar) {
                if(bPrefs) sidebar.appendChild(bPrefs);
                if(bAccount) sidebar.appendChild(bAccount);
                if(bExtras) sidebar.appendChild(bExtras);
            }
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const homeTab = document.getElementById('tab-home');
            if(homeTab) homeTab.classList.add('active');

        } else {
            // === МОБИЛЬНЫЙ РЕЖИМ ===
            
            // 1. Настройки
            if(mPrefs && bPrefs) mPrefs.appendChild(bPrefs);
            
            // 2. Ссылки (Extras) в Settings
            if(mPrefs && bExtras) {
                bExtras.style.marginTop = "25px"; 
                mPrefs.appendChild(bExtras);
            }

            // 3. Аккаунт
            if(mAccount && bAccount) mAccount.appendChild(bAccount);
        }
    }

    function toggleModifiers(e) {
        if (e && e.target.classList.contains('tag')) return;

        const capsule = document.getElementById('mods-capsule');
        capsule.classList.toggle('open');
        
        // Вибрация
        if(navigator.vibrate) navigator.vibrate(10);
    }

    function switchTab(tab) {
        // Скрываем все табы
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        // Показываем нужный
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('nav-' + tab).classList.add('active');

        // === Управление классами body для мобильной шапки ===
        // Удаляем все классы активных табов
        document.body.classList.remove('tab-home-active', 'tab-settings-active', 'tab-account-active');
        // Добавляем текущий
        document.body.classList.add('tab-' + tab + '-active');
    }

    function initTheme() {
        const savedId = localStorage.getItem('xch_theme_id') || 'dark';
        applyTheme(savedId);
    }
    
    function initLanguage() {
        const saved = localStorage.getItem(STORAGE.LANG);
        currentLang = saved || 'en';
        document.getElementById('lang-select').value = currentLang;
        applyLanguage();
        updateToggleLabels();
    }
    
    function changeLanguage(val) {
        currentLang = val;
        localStorage.setItem(STORAGE.LANG, currentLang);
        applyLanguage();
        if (window.updateLastSyncUI) window.updateLastSyncUI(); 
        renderHistory();
        renderModifiers();
        updateThemeLabel();
        if(currentItem) { renderResultUI(currentItem, null); updateLink(); } 
        else { setInitialText(); }
        updateToggleLabels();
        updateExploredCount();
    }
    
    function updateToggleLabels() {
        const isRu = (currentLang === 'ru');
        document.getElementById('comp-search').style.display = isRu ? 'flex' : 'none';
    }
   
    function applyLanguage() {
        const t = langData[currentLang];
        
        // Перевод текстов
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if(t[key]) {
                if (key.startsWith('inst_') || key.startsWith('badge_') || key.startsWith('feat_') || key === 'sync_tip') {
                    el.innerHTML = t[key];
                } else {
                    el.innerText = t[key];
                }
            }
        });

        // Перевод плейсхолдеров
        const onbInput = document.getElementById('onb-input');
        if(onbInput && t.onb_placeholder) onbInput.placeholder = t.onb_placeholder;

        const promoInput = document.getElementById('promo-input-field');
        if(promoInput && t.pay_code_placeholder) promoInput.placeholder = t.pay_code_placeholder;
        
        updateExploredCount();
        updateSubscriptionUI(); 
    }

    function submitPromoFromInput() {
        const input = document.getElementById('promo-input-field');
        const code = input.value.trim();
        
        if (!code) {
            // Визуальная тряска или красная рамка (опционально)
            input.style.borderColor = "var(--highlight-red)";
            setTimeout(() => input.style.borderColor = "var(--border)", 1000);
            return;
        }

        // Вызываем существующую логику активации
        window.activatePromoCode(code);
        
        // Очищаем поле
        input.value = "";
        
        closePaymentModal(null, true);
        closeSubModal(null, true);
    }

    function openFavoritesCatalog() {
        renderListModal('fav');
    }

    function openBlacklistCatalog() {
        renderListModal('ban');
    }

    function renderListModal(type) {
        let modalId, bodyId, listData, placeholder;
        const t = langData[currentLang] || langData['en']; // Получаем переводы

        if (type === 'fav') {
            modalId = 'modal-overlay'; bodyId = 'modal-catalog-body'; listData = favorites;
            placeholder = t.search_liked; // Локализованный плейсхолдер
        } else if (type === 'ban') {
            modalId = 'modal-blacklist-overlay'; bodyId = 'modal-blacklist-body'; listData = blacklist;
            placeholder = t.search_disliked; // Локализованный плейсхолдер
        } else if (type === 'wl') {
            modalId = 'modal-overlay'; 
            bodyId = 'modal-catalog-body'; 
            listData = watchLater;
            
            const header = document.querySelector(`#${modalId} .modal-header span`);
            if(header) header.innerText = t.watch_later;
        }

        const modal = document.getElementById(modalId);
        const body = document.getElementById(bodyId);
        
        body.innerHTML = '';
        body.style.display = 'block';
        body.style.padding = '15px';

        // 1. ПОЛЕ ПОИСКА (Только если это НЕ Watch Later)
        if (type !== 'wl') {
            const searchBox = document.createElement('div');
            searchBox.className = 'modal-search-box';
            searchBox.innerHTML = `
                <input type="text" class="modal-search-input" placeholder="${placeholder}" id="search-${type}">
                <div class="modal-suggestions" id="suggest-${type}"></div>
            `;
            body.appendChild(searchBox);
        }

        // 2. Контейнер тегов
        const tagsContainer = document.createElement('div');
        tagsContainer.style.display = 'flex';
        tagsContainer.style.flexWrap = 'wrap';
        tagsContainer.style.gap = '8px';
        body.appendChild(tagsContainer);

        // 3. Рендер тегов
        renderCurrentTags(type, listData, tagsContainer);

        // 4. Логика поиска (Только если поле создано)
        if (type !== 'wl') {
            const input = document.getElementById(`search-${type}`);
            const suggestBox = document.getElementById(`suggest-${type}`);

            input.oninput = (e) => {
                const val = e.target.value.toLowerCase().trim();
                if (val.length < 2) { suggestBox.style.display = 'none'; return; }

                const matches = data.filter(item => {
                    if (listData.includes(item.id)) return false;
                    const terms = [item.name, item.name_ru || "", item.name_es || "", item.name_de || "", item.slug].map(x => x.toLowerCase());
                    return terms.some(term => term.includes(val));
                }).slice(0, 10);

                suggestBox.innerHTML = '';
                if (matches.length > 0) {
                    suggestBox.style.display = 'flex';
                    matches.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'suggestion-row';
                        row.innerHTML = `${getLocalizedName(item)} <span>+</span>`;
                        
                        row.onclick = () => {
                            if (type === 'fav') {
                                favorites.push(item.id);
                                if (blacklist.includes(item.id)) blacklist = blacklist.filter(x => x !== item.id);
                                adjustTagScores(item, 5);
                                logActivity('like', item.id, item.tags);
                            } else if (type === 'ban') {
                                blacklist.push(item.id);
                                if (favorites.includes(item.id)) favorites = favorites.filter(x => x !== item.id);
                                adjustTagScores(item, -5);
                                logActivity('dislike', item.id, item.tags);
                            } 
                            
                            localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
                            localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
                            
                            updateCounts();
                            if (window.syncToCloud) window.syncToCloud();
                            
                            input.value = ''; 
                            suggestBox.style.display = 'none';
                            renderListModal(type);
                            if(currentItem && currentItem.id === item.id) updateActionButtons();
                        };
                        suggestBox.appendChild(row);
                    });
                } else {
                    suggestBox.style.display = 'none';
                }
            };
        }

        // Возврат заголовка для Fav при закрытии (или при следующем открытии Fav само исправится)
        if (type === 'fav') {
             const header = document.querySelector(`#${modalId} .modal-header span`);
             if(header) header.innerText = t.favorites_catalog;
        }

        modal.classList.add('open');
    }

    function renderCurrentTags(type, listIds, container) {
        container.innerHTML = '';
        const t = langData[currentLang];
        
        if (listIds.length === 0) {
            container.innerHTML = `<div style="width:100%; text-align:center; color:var(--text-secondary); margin-top:20px; font-size:14px;">${t.empty_wl || "List is empty"}</div>`;
            return;
        }

        const sortedIds = [...listIds].sort((a, b) => {
            const itemA = data.find(x => x.id === a);
            const itemB = data.find(x => x.id === b);
            if (!itemA || !itemB) return 0;
            return getLocalizedName(itemA).localeCompare(getLocalizedName(itemB));
        });

        sortedIds.forEach(id => {
            const item = data.find(x => x.id === id);
            if (!item) return;

            const div = document.createElement('div');
            // ОПРЕДЕЛЕНИЕ КЛАССА
            let className = 'catalog-item';
            if (type === 'fav') className += ' active';
            else if (type === 'ban') className += ' ban-active';
            else if (type === 'wl') className += ' wl-active'; // СИНИЙ
            
            div.className = className;
            div.innerHTML = `${getLocalizedName(item)} <span class="catalog-remove-btn">✕</span>`;

            div.querySelector('.catalog-remove-btn').onclick = (e) => {
                e.stopPropagation();
                
                if (type === 'fav') favorites = favorites.filter(x => x !== id);
                else if (type === 'ban') blacklist = blacklist.filter(x => x !== id);
                else if (type === 'wl') watchLater = watchLater.filter(x => x !== id);
                
                localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites));
                localStorage.setItem(STORAGE.BLACKLIST, JSON.stringify(blacklist));
                localStorage.setItem(STORAGE.WATCH_LATER, JSON.stringify(watchLater));
                
                updateCounts();
                if (window.syncToCloud) window.syncToCloud();
                
                div.style.opacity = '0';
                div.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    renderCurrentTags(type, type === 'fav' ? favorites : (type === 'ban' ? blacklist : watchLater), container);
                }, 200);

                if(currentItem && currentItem.id === id) updateActionButtons();
            };
            
            // Клик по самому тегу открывает его (как в истории)
            div.onclick = (e) => {
                if(e.target.classList.contains('catalog-remove-btn')) return;
                closeList(null, true);
                closeBlacklist(null, true);
                switchTab('home');
                forceShowResult(item, 'history');
            }

            container.appendChild(div);
        });
    }

    function closeList(e, force) {
        if (force || e.target.id === 'modal-overlay') {
            document.getElementById('modal-overlay').classList.remove('open');
        }
    }
    
    function closeBlacklist(e, force) {
        if (force || e.target.id === 'modal-blacklist-overlay') {
            document.getElementById('modal-blacklist-overlay').classList.remove('open');
        }
    }

    function searchByTag(tag) {
        const candidates = data.filter(item => item.tags.includes(tag));
        if (candidates.length === 0) return; 
        const selected = getWeightedRandom(candidates); 
        forceShowResult(selected, 'tag_click');
    }

    function openStatistics() {
        const t = langData[currentLang];
        if (document.getElementById('tf-week')) document.getElementById('tf-week').innerText = t.tf_week;
        if (document.getElementById('tf-month')) document.getElementById('tf-month').innerText = t.tf_month;
        if (document.getElementById('tf-year')) document.getElementById('tf-year').innerText = t.tf_year;
        if (document.getElementById('tf-all')) document.getElementById('tf-all').innerText = t.tf_all;

        updateStatsLocks();

        // === ЛОГИКА WRAPPED / PROGRESS BAR ===
        const wData = getWrappedData();
        const wBtn = document.getElementById('btn-wrapped-trigger');
        const modalHeader = document.querySelector('#modal-stats-overlay .modal-header');
        
        const oldProgress = document.getElementById('wrapped-progress-ui');
        if (oldProgress) oldProgress.remove();

        if (wData) {
            if (wData.totalActions >= WRAPPED_THRESHOLD) {
                if(wBtn) wBtn.style.display = 'flex';
            } else {
                if(wBtn) wBtn.style.display = 'none';
                
                const percent = Math.min(100, (wData.totalActions / WRAPPED_THRESHOLD) * 100);
                const left = WRAPPED_THRESHOLD - wData.totalActions;
                
                const titleTxt = t.wrapped_lock_title; // "FETISH WRAPPED 🔒"
                const descTxt = t.wrapped_lock_desc.replace('{n}', left); // "Make 30 more..."

                const progressHTML = `
                    <div id="wrapped-progress-ui" class="wrapped-lock-container" style="margin: 0 10px 20px 10px;">
                        <div class="wrapped-lock-title">${titleTxt}</div>
                        <div class="wrapped-lock-desc">${descTxt}</div>
                        <div class="w-progress-track">
                            <div class="w-progress-fill" style="width: ${percent}%"></div>
                        </div>
                        <div class="w-progress-text">${wData.totalActions} / ${WRAPPED_THRESHOLD}</div>
                    </div>
                `;
                const modalBody = document.getElementById('modal-stats-body');
                modalBody.insertAdjacentHTML('beforebegin', progressHTML);
            }
        }
        // ======================================

        const modal = document.getElementById('modal-stats-overlay');
        if (modal) {
            modal.classList.add('open');
            currentStatsTimeframe = 'week'; 
            currentStatsTab = 'tags';
            document.querySelectorAll('.stats-tf-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tf-week').classList.add('active');
            document.getElementById('stat-nav-tags').classList.add('active');
            document.getElementById('stat-nav-activity').classList.remove('active');
            renderStatsContent();
        }
    }

    function switchStatsTab(tab) {
        if (tab === 'activity' && subscriptionLevel === 'free') {
            openSubModal();
            return;
        }
        
        currentStatsTab = tab;
        document.getElementById('stat-nav-tags').classList.toggle('active', tab === 'tags');
        document.getElementById('stat-nav-activity').classList.toggle('active', tab === 'activity');
        renderStatsContent();
    }

    function switchTimeframe(tf) {
        // NERF: Блокируем всё кроме "Week" для бесплатных
        if (tf !== 'week' && subscriptionLevel === 'free') {
            openSubModal();
            return;
        }

        currentStatsTimeframe = tf;
        document.querySelectorAll('.stats-tf-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tf-' + tf).classList.add('active');
        renderStatsContent();
    }

    function updateStatsLocks() {
        const isFree = subscriptionLevel === 'free';
        
        const idsToLock = ['tf-month', 'tf-year', 'tf-all', 'stat-nav-activity'];
        
        idsToLock.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            
            // Сначала чистим старые замки
            const existingLock = el.querySelector('.lock-icon-small');
            if (existingLock) existingLock.remove();
            
            // Сбрасываем прозрачность
            el.style.opacity = '1';
            
            // Если тариф бесплатный — добавляем замок и прозрачность
            if (isFree) {
                el.style.opacity = '0.6';
                const lockSpan = document.createElement('span');
                lockSpan.className = 'lock-icon-small';
                lockSpan.innerText = ' 🔒';
                lockSpan.style.fontSize = '10px';
                el.appendChild(lockSpan);
            }
        });
    }

    function renderStatsContent() {
        const body = document.getElementById('modal-stats-body');
        body.innerHTML = '';
        const t = langData[currentLang] || langData['en'];

        // --- ЛОГИКА 1: ПРЕДПОЧТЕНИЯ (TAGS) ---
        if (currentStatsTab === 'tags') {
            const tempScores = {};
            const ignoreStats = ['universal', 'straight', 'male', 'female']; 
            
            activityLog.forEach(log => {
                if (log.tags) {
                    let weight = 0;
                    if (log.type === 'watch') weight = 10;
                    else if (log.type === 'like' || log.type === 'similar') weight = 5;
                    else if (log.type === 'gen' || log.type === 'pass') weight = 0;
                    else if (log.type === 'dislike') weight = -5;

                    if (weight !== 0) {
                        log.tags.forEach(tag => {
                            if(!ignoreStats.includes(tag)) {
                                tempScores[tag] = (tempScores[tag] || 0) + weight;
                            }
                        });
                    }
                }
            });

            const sortedTags = Object.entries(tempScores)
                .sort((a, b) => b[1] - a[1])
                .filter(x => x[1] > 0)
                .slice(0, 20); 
            
            let html = `<div class="chart-wrapper"><div class="chart-scroll-view">`;

            if(sortedTags.length === 0) {
                html += `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                const maxVal = Math.max(...sortedTags.map(x => x[1]));
                sortedTags.forEach(([tag, score]) => {
                    const height = Math.max(5, (score / maxVal) * 100);
                    let displayTag = tag.charAt(0).toUpperCase() + tag.slice(1);
                    if (displayTag.length > 9) displayTag = displayTag.substring(0, 7) + '..';

                    html += `
                        <div class="pref-col">
                            <div style="font-size:10px; color:var(--text-main); margin-bottom:2px; font-weight:700;">${score}</div>
                            <div class="chart-bar" style="height:${height}%;"></div>
                            <div class="chart-label-x" title="${tag}">${displayTag}</div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            html += `
                <div style="margin-top:15px; display:flex; flex-direction:column; gap:5px; align-items:center;">
                    <div style="display:flex; gap:15px; font-size:10px; color:var(--text-secondary);">
                        <div style="display:flex; align-items:center; gap:4px;"><span style="color:var(--accent)">●</span> ${t.legend_watch}</div>
                        <div style="display:flex; align-items:center; gap:4px;"><span style="color:var(--text-main)">●</span> ${t.legend_like}</div>
                    </div>
                </div>
            `;
            body.innerHTML = html;
        } 
        
        // --- ЛОГИКА 2: АКТИВНОСТЬ (ACTIVITY) ---
        else {
            const aggregated = {};
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            
            let cutoffTime = 0;
            if (currentStatsTimeframe === 'week') cutoffTime = now - 7 * oneDay;
            else if (currentStatsTimeframe === 'month') cutoffTime = now - 30 * oneDay;
            else if (currentStatsTimeframe === 'year') cutoffTime = now - 365 * oneDay;
            
            // 1. Считаем Действия (Swipes/Generations)
            activityLog.forEach(log => {
                if (log.ts < cutoffTime) return;
                const d = new Date(log.ts);
                let key = (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') 
                    ? `${d.getFullYear()}-${d.getMonth()}`
                    : d.toISOString().split('T')[0];
                    
                let label = (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all')
                    ? d.toLocaleDateString(currentLang, { month: 'short' }).replace('.', '')
                    : d.toLocaleDateString(currentLang, { day: 'numeric', month: 'numeric' });

                if (!aggregated[key]) aggregated[key] = { gen: 0, watch: 0, mins: 0, label: label, sort: d.getTime() };
                
                if (log.type === 'watch') aggregated[key].watch++;
                else if (['like', 'gen', 'pass', 'dislike'].includes(log.type)) aggregated[key].gen++;
            });

            // 2. Считаем Минуты (из Watch History)
            watchHistory.forEach(entry => {
                if (entry.timestamp < cutoffTime) return;
                const d = new Date(entry.timestamp);
                let key = (currentStatsTimeframe === 'year' || currentStatsTimeframe === 'all') 
                    ? `${d.getFullYear()}-${d.getMonth()}`
                    : d.toISOString().split('T')[0];
                
                if (aggregated[key]) {
                    // Добавляем минуты (секунды / 60)
                    aggregated[key].mins += (entry.seconds || 0) / 60;
                }
            });

            const chartData = Object.values(aggregated).sort((a, b) => a.sort - b.sort);

            let html = `<div class="chart-wrapper"><div class="chart-scroll-view" style="justify-content: flex-start;">`;

            if (chartData.length === 0) {
                html += `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary);">${t.stats_no_data}</div>`;
            } else {
                let maxVal = 0;
                chartData.forEach(d => {
                    if (d.gen > maxVal) maxVal = d.gen;
                    if (d.watch > maxVal) maxVal = d.watch;
                    if (d.mins > maxVal) maxVal = d.mins; 
                });
                if (maxVal === 0) maxVal = 1;

                chartData.forEach(d => {
                    const hGen = Math.max(2, (d.gen / maxVal) * 80);
                    const hWatch = Math.max(2, (d.watch / maxVal) * 80);
                    const hMins = Math.max(2, (d.mins / maxVal) * 80);
                    const minsDisplay = Math.round(d.mins);

                    html += `
                        <div class="act-col">
                            <div class="act-bar-group" style="gap:2px; max-width:60px;">
                                <!-- Свайпы (Серый) -->
                                <div style="width:30%; background:var(--text-secondary); height:${hGen}%; border-radius:3px 3px 0 0; opacity:0.3;"></div>
                                <!-- Клики Watch (Акцент) -->
                                <div style="width:30%; background:var(--accent); height:${hWatch}%; border-radius:3px 3px 0 0;"></div>
                                <!-- Минуты (Фиолетовый) -->
                                <div style="width:30%; background:#9b59b6; height:${hMins}%; border-radius:3px 3px 0 0;"></div>
                            </div>
                            
                            <div class="act-values" style="gap:3px;">
                                <span style="color:var(--text-secondary); opacity:0.6;">${d.gen}</span>
                                <span style="color:var(--accent);">${d.watch}</span>
                                <span style="color:#9b59b6;">${minsDisplay}m</span>
                            </div>
                            
                            <div class="chart-label-x" style="font-size:9px;">${d.label}</div>
                        </div>
                    `;
                });
            }

            html += `</div></div>`; 

            // Легенда активности (3 пункта)
            html += `
                <div style="margin-top:15px; display:flex; justify-content:center; gap:15px; font-size:10px; flex-wrap:wrap;">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:10px; height:10px; background:var(--text-secondary); opacity:0.3; border-radius:2px;"></div>
                        <span>${t.act_actions}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:10px; height:10px; background:var(--accent); border-radius:2px;"></div>
                        <span>${t.act_watches}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:10px; height:10px; background:#9b59b6; border-radius:2px;"></div>
                        <span>${t.time_d ? (currentLang==='ru'?'Время (мин)':'Time (min)') : 'Mins'}</span>
                    </div>
                </div>
            `;
            body.innerHTML = html;
        }
    }

    function shareStats() {
        const modalBody = document.getElementById('modal-stats-body');
        if(!modalBody) return;
        
        html2canvas(modalBody, {
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--sidebar-bg') 
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'my-stats.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function openSupportModal() {
        const t = langData[currentLang];
        const contentDiv = document.getElementById('support-content');
        
        contentDiv.innerHTML = `
            <p>${t.support_intro}</p>
            <p>${t.support_why}</p>
            <h4 style="color:var(--text-main); margin:15px 0 10px 0;">${t.support_roadmap_title}</h4>
            <ul style="padding-left:20px; margin:0;">
                ${t.support_roadmap_list}
            </ul>
        `;
        
        document.getElementById('modal-support-overlay').classList.add('open');
    }
    
    function closeSupport(e, force) {
        if (force || e.target.id === 'modal-support-overlay') {
            document.getElementById('modal-support-overlay').classList.remove('open');
        }
    }

    function closeStats(e, force) {
        if (force || e.target.id === 'modal-stats-overlay') {
            document.getElementById('modal-stats-overlay').classList.remove('open');
        }
    }

    function initAgeGate() {
        const isVerified = localStorage.getItem('xch_age_verified');

        if (!isVerified) {
            // Если возраст не подтвержден - показываем Age Gate
            document.getElementById('age-gate').classList.add('open');
        } else {
            // Если подтвержден - запускаем цепочку проверок
            runStartupChecks();
        }
    }

    function passAgeGate() {
        localStorage.setItem('xch_age_verified', 'true');
        document.getElementById('age-gate').classList.remove('open');
        runStartupChecks();
    }

    function runStartupChecks() {
        const isMobile = window.innerWidth < 768; // Проверка на мобильность
        const isInstalled = isAppInstalled();
        const isSkipped = sessionStorage.getItem('xch_install_skipped'); // Проверка, пропускали ли в этой сессии

        // ЦЕПОЧКА:
        // 1. Мобилка? НЕ установлено? НЕ пропускали? -> Показать Install Modal
        // 2. Иначе -> Проверить Onboarding Preferences

        if (isMobile && !isInstalled && !isSkipped) {
            document.getElementById('modal-install-overlay').classList.add('open');
        } else {
            checkOnboarding();
        }
    }

    function blockAccess() {
        document.getElementById('age-block').style.display = 'flex';
        // На всякий случай блокируем скролл и всё остальное
        document.body.style.overflow = 'hidden';
    }

    function skipOnboarding() {
        localStorage.setItem('xch_onboarding_done', 'true');
        document.getElementById('onboarding-overlay').classList.remove('open');
    }

    function processOnboardingText() {
        const inputField = document.getElementById('onb-input');
        const rawInput = inputField.value.toLowerCase();
        
        // Очищаем ввод от знаков препинания и добавляем пробелы по краям для поиска целых слов
        // Например: "hello, anal!" -> " hello anal "
        const cleanInput = " " + rawInput.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ") + " ";

        if (!rawInput.trim()) return;

        const container = document.getElementById('onb-tags-container');
        const resultsBlock = document.getElementById('onb-results');
        
        // Убираем сообщение об ошибке, если оно было
        const existingError = container.querySelector('.onb-error');
        if(existingError) existingError.remove();

        const foundItems = [];

        // Вспомогательная функция для разбиения строки на ключевые слова
        const getKeywords = (str) => {
            if (!str) return [];
            // Разбиваем по пробелам, слэшам, дефисам
            return str.toLowerCase().split(/[\s\/,\-]+/)
                      .filter(w => w.length > 2); // Игнорируем слова короче 3 букв (в, на, in, at)
        };

        data.forEach(item => {
            // Если этот тег уже добавлен в список, пропускаем его
            if (onboardingSelectedIds.includes(item.id)) return;

            // Собираем все ключевые слова для этого фетиша из всех языков
            const keywords = [
                ...getKeywords(item.name),
                ...getKeywords(item.name_ru),
                ...getKeywords(item.name_es),
                ...getKeywords(item.name_de),
                ...getKeywords(item.slug) // slug часто содержит полезные слова (step-mom -> step, mom)
            ];

            // Проверяем: есть ли хотя бы одно ключевое слово фетиша в тексте пользователя?
            // Ищем с пробелами по краям, чтобы "anal" не нашлось внутри "analyst" (хотя тут это редкость, но надежнее)
            const isMatch = keywords.some(word => cleanInput.includes(" " + word + " "));

            if (isMatch) {
                foundItems.push(item);
            }
        });

        if (foundItems.length > 0) {
            foundItems.forEach(item => {
                onboardingSelectedIds.push(item.id);
                renderOnbTag(item, container);
            });
            // Показываем блок результатов
            resultsBlock.style.display = 'flex';
            // Очищаем поле ввода для следующей фразы
            inputField.value = "";
            inputField.placeholder = "... anything else?"; // Подсказка
        } else {
            // Если ничего не нашли И список пуст (первый ввод)
            if (onboardingSelectedIds.length === 0) {
                resultsBlock.style.display = 'flex';
                container.innerHTML = '<span class="onb-error" style="color:var(--highlight-red); font-size:13px; width:100%; text-align:center; padding:10px;">No matches found. Try simpler words (e.g. "anal", "feet").</span>';
            }
        }
    }

    function renderOnbTag(item, container) {
        const name = getLocalizedName(item);
        const div = document.createElement('div');
        div.className = 'onb-tag';
        div.innerHTML = `
            ${name}
            <span class="onb-tag-remove" onclick="removeOnbTag(${item.id}, this)">✕</span>
        `;
        container.appendChild(div);
    }

    function removeOnbTag(id, el) {
        onboardingSelectedIds = onboardingSelectedIds.filter(x => x !== id);
        el.parentElement.remove();
    }

    function finishOnboarding() {
        if (onboardingSelectedIds.length > 0) {
            onboardingSelectedIds.forEach(id => {
                if (!favorites.includes(id)) {
                    favorites.push(id);
                    const item = data.find(x => x.id === id);
                    if (item) {
                        adjustTagScores(item, 5);
                        // Запись в лог для статистики
                        logActivity('like', item.id, item.tags);
                    }
                }
            });
            saveLists();
            updateCounts();
            if (window.syncToCloud) window.syncToCloud();
        }
        
        localStorage.setItem('xch_onboarding_done', 'true');
        document.getElementById('onboarding-overlay').classList.remove('open');
    }

    function resetAppHistory() {
        const t = langData[currentLang];
        
        if (confirm(t.confirm_reset)) {
            localStorage.removeItem(STORAGE.HISTORY);
            localStorage.removeItem(STORAGE.ACTIVITY_LOG);
            localStorage.removeItem(STORAGE.TAG_SCORES);
            localStorage.removeItem(STORAGE.BLACKLIST);
            localStorage.removeItem(STORAGE.FAVORITES);
            localStorage.removeItem(STORAGE.WATCH_LATER);
            localStorage.removeItem(STORAGE.WATCH_HISTORY);
            
            historyData = [];
            activityLog = [];
            tagScores = {};
            blacklist = [];
            favorites = [];
            watchLater = [];
            watchHistory = [];
            
            updateCounts();
            updateExploredCount();
            renderHistory();
            if (window.syncToCloud) window.syncToCloud();
            
            const progressUI = document.getElementById('wrapped-progress-ui');
            if (progressUI) progressUI.remove();
            
            const wBtn = document.getElementById('btn-wrapped-trigger');
            if (wBtn) wBtn.style.display = 'none';

            // Сбрасываем график
            const modalBody = document.getElementById('modal-stats-body');
            if (modalBody && document.getElementById('modal-stats-overlay').classList.contains('open')) {
                renderStatsContent();
                // Перерисовываем заголовок статистики, чтобы обновить прогресс бар (показать заблокированный)
                openStatistics(); 
            }

            alert(t.reset_done);
        }
    }

    function openSubModal() {
        // 1. Находим кнопки
        const btnFree = document.querySelector('.plan-card:nth-child(1) .plan-btn'); 
        
        // Лучше искать по классам, чтобы порядок в HTML не влиял
        const btnPro = document.querySelector('.plan-card.pro .plan-btn');
        const btnBeast = document.querySelector('.plan-card.beast .plan-btn');
        const btnBestie = document.querySelector('.plan-card.bestie .plan-btn');

        // 2. Получаем текущие переводы
        const t = langData[currentLang] || langData['en'];

        const tCurrent = t.btn_current || "Current Plan";
        const tLower = t.btn_lower_tier || "You deserve better";
        
        const tPro = t.btn_get_pro || "Get Pro";
        const tBeast = t.btn_get_beast || "Unleash Beast";
        
        const tBestie = t.btn_get_bestie || "Get Forever"; 

        // Helper: Настройка кнопки
        const configureBtn = (btn, state, buyText, planType) => {
            if (!btn) return; 
            btn.onclick = null;
            btn.classList.remove('current', 'pro-btn', 'beast-btn', 'bestie-btn');
            
            if (state === 'current') {
                btn.disabled = true;
                btn.classList.add('current');
                btn.innerText = tCurrent;
            } 
            else if (state === 'lower') {
                btn.disabled = true;
                btn.classList.add('current'); 
                btn.innerText = tLower;       
            } 
            else { // 'buy'
                btn.disabled = false;
                
                // Возвращаем цвета
                if (btn.closest('.pro')) btn.classList.add('pro-btn');
                if (btn.closest('.beast')) btn.classList.add('beast-btn');
                if (btn.closest('.bestie')) btn.classList.add('bestie-btn');
                
                btn.innerText = buyText;
                btn.onclick = () => openPaymentSelection(planType);
            }
        };

        // ЛОГИКА ОТОБРАЖЕНИЯ (Кто что видит)
        if (subscriptionLevel === 'bestie') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'lower', null, null);
            configureBtn(btnBeast, 'lower', null, null);
            configureBtn(btnBestie, 'current', null, null);
        }
        else if (subscriptionLevel === 'beast') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'lower', null, null);
            configureBtn(btnBeast, 'current', null, null);
            configureBtn(btnBestie, 'buy', tBestie, 'bestie'); 
        } 
        else if (subscriptionLevel === 'pro') {
            configureBtn(btnFree, 'lower', null, null);
            configureBtn(btnPro, 'current', null, null);
            configureBtn(btnBeast, 'buy', tBeast, 'beast');
            configureBtn(btnBestie, 'buy', tBestie, 'bestie');
        } 
        else {
            // Free user
            configureBtn(btnFree, 'current', null, null);
            configureBtn(btnPro, 'buy', tPro, 'pro');
            configureBtn(btnBeast, 'buy', tBeast, 'beast');
            configureBtn(btnBestie, 'buy', tBestie, 'bestie');
        }

        document.getElementById('modal-sub-overlay').classList.add('open');
    }

    function openPaymentSelection(plan) {
        if (!window.isUserLoggedIn) {
            openLoginModal();
            return;
        }

        pendingPlan = plan;
        
        const titleEl = document.getElementById('payment-modal-title');
        
        let planName = 'Pro';
        let price = '$1.99';

        if (plan === 'beast') {
            planName = 'Beast';
            price = '$4.99';
        } else if (plan === 'bestie') {
            planName = 'Bestie Lifetime';
            price = '$49.99';
        }

        if(titleEl) titleEl.innerText = `Get ${planName} (${price})`;

        document.getElementById('modal-payment-overlay').classList.add('open');
    }

    function closePaymentModal(e, force) {
        if (force || e.target.id === 'modal-payment-overlay') {
            document.getElementById('modal-payment-overlay').classList.remove('open');
        }
    }

    function processPayment(provider) {
        let url = "";
        
        if (provider === 'telegram') {
            url = "https://t.me/YourBotName?start=" + pendingPlan; 
        } 
        else if (provider === 'lava') {
            if (pendingPlan === 'pro') url = "https://lava.top/product/pro-link";
            else if (pendingPlan === 'beast') url = "https://lava.top/product/beast-link";
            else if (pendingPlan === 'bestie') url = "https://lava.top/product/bestie-link";
        }
        else if (provider === 'boosty') {
            url = "https://boosty.to/xfetishhub"; // На Бусти можно сделать пост с донатом 49.99
        }
        // ... crypto ...

        window.open(url, '_blank');
    }

    function promptPromoCode() {
        const code = prompt("Enter your activation code (received after payment):");
        if (code) {
            // Вызываем существующую функцию активации
            window.activatePromoCode(code.trim());
            closePaymentModal(null, true);
            closeSubModal(null, true);
        }
    }

    function closeSubModal(e, force) {
        if (force || e.target.id === 'modal-sub-overlay') {
            document.getElementById('modal-sub-overlay').classList.remove('open');
        }
    }

    function checkGenerationLimit(onlyCheck = false) {
        if (subscriptionLevel !== 'free') return true; 

        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        
        // Читаем сохраненные данные
        let count = parseInt(localStorage.getItem('xch_limit_count') || '0');
        let startTime = parseInt(localStorage.getItem('xch_limit_start') || '0');

        // Логика сброса: Если прошло 24 часа с момента старта отсчета — сбрасываем визуально
        if (startTime > 0 && (now - startTime > oneDay)) {
            // Если мы только проверяем, мы не должны сбрасывать данные в хранилище,
            // но для корректной проверки мы считаем, что счетчик равен 0
            if (!onlyCheck) {
                count = 0;
                startTime = 0;
                localStorage.setItem('xch_limit_count', '0');
                localStorage.setItem('xch_limit_start', '0');
            } else {
                // Для проверки притворяемся, что счетчик сброшен
                count = 0; 
            }
        }

        // Если лимит исчерпан
        if (count >= DAILY_LIMIT) {
            // Показываем модалку и Алерт
            openSubModal();
            
            // Вычисляем время сброса
            const resetTime = startTime > 0 ? startTime + oneDay : now + oneDay;
            const resetDate = new Date(resetTime);
            
            const dateStr = resetDate.toLocaleString(currentLang, { 
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });

            const t = langData[currentLang] || langData['en'];
            let msg = currentLang === 'ru' 
                ? `Лимит исчерпан (${DAILY_LIMIT}).\nСброс: ${dateStr}.\nКупите Pro для безлимита!` 
                : `Daily limit reached (${DAILY_LIMIT}).\nReset: ${dateStr}.\nGet Pro for unlimited!`;

            alert(msg);
            
            // Обновляем кнопку (красная)
            updateSubscriptionUI();
            
            return false;
        }

        // === ЕСЛИ ЭТО ТОЛЬКО ПРОВЕРКА (без списания) ===
        if (onlyCheck) {
            return true; 
        }

        // === СПИСАНИЕ (только если onlyCheck = false) ===
        
        // Если это первая генерация в цикле
        if (count === 0 || startTime === 0) {
            localStorage.setItem('xch_limit_start', now);
        }

        count++;
        localStorage.setItem('xch_limit_count', count);
        
        updateSubscriptionUI(); 
        
        return true;
    }

    function updateSubscriptionUI() {
        const nameEl = document.getElementById('current-plan-name');
        const badgeEl = document.getElementById('upgrade-badge'); 
        const btnFree = document.querySelector('.plan-card:nth-child(1) .plan-btn'); 
        
        if (!nameEl) return;

        // Обновляем переменную уровня подписки из памяти (на случай, если она изменилась без перезагрузки)
        subscriptionLevel = localStorage.getItem('xch_sub_level') || 'free';

        const t = langData[currentLang] || langData['en'];

        // Сброс стилей
        nameEl.style.textShadow = 'none';
        nameEl.style.fontWeight = '900';

        // --- ПРОВЕРКА BESTIE ---
        if (subscriptionLevel === 'bestie') {
            nameEl.innerText = "BESTIE";
            nameEl.style.color = "#00d2ff"; 
            nameEl.style.textShadow = "0 0 15px rgba(0, 210, 255, 0.4)";
            
            if(badgeEl) badgeEl.style.display = 'none';
            
            // Кнопка Free в модальном окне становится "You deserve better"
            if(btnFree) {
                btnFree.innerText = t.btn_lower_tier || "You deserve better";
                btnFree.classList.add('current');
                btnFree.disabled = true;
            }
        
        } else if (subscriptionLevel === 'beast') {
            nameEl.innerText = "BEAST";
            nameEl.style.color = "#9b59b6"; 
            
            if(badgeEl) badgeEl.style.display = 'none';
            if(btnFree) {
                btnFree.innerText = t.btn_lower_tier;
                btnFree.classList.add('current');
                btnFree.disabled = true;
            }

        } else if (subscriptionLevel === 'pro') {
            nameEl.innerText = "PRO";
            nameEl.style.color = "#ff9900"; 
            
            if(badgeEl) badgeEl.style.display = 'none';
            if(btnFree) {
                btnFree.innerText = t.btn_lower_tier;
                btnFree.classList.add('current');
                btnFree.disabled = true;
            }

        } else {
            // --- FREE ---
            const count = parseInt(localStorage.getItem('xch_limit_count') || '0');
            const startTime = parseInt(localStorage.getItem('xch_limit_start') || '0');
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;

            let displayCount = count;
            if (startTime > 0 && (now - startTime > oneDay)) {
                displayCount = 0;
            }
            const remaining = Math.max(0, DAILY_LIMIT - displayCount);

            nameEl.innerHTML = `FREE <span style="font-size:14px; opacity:0.6; font-weight:600; margin-left:5px; color:var(--text-secondary);">${remaining}/${DAILY_LIMIT}</span>`;
            nameEl.style.color = "var(--text-main)";
            nameEl.style.fontWeight = "600";
            
            if(badgeEl) {
                badgeEl.style.display = 'inline-block';
                badgeEl.innerText = t.btn_upgrade_short || "Upgrade ⇧"; 
            }

            // Логика кнопки Free (таймер)
            if (btnFree) {
                btnFree.disabled = true;
                btnFree.classList.remove('current'); // Сброс класса current, чтобы стили таймера сработали
                
                if (startTime > 0 && displayCount > 0) {
                    const resetDate = new Date(startTime + oneDay);
                    const dateStr = resetDate.toLocaleString(currentLang, { 
                        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                    });
                    
                    btnFree.innerText = `${t.limit_reset} ${dateStr}`;
                    
                    if (remaining === 0) {
                        btnFree.style.color = "var(--highlight-red)";
                        btnFree.style.border = "1px solid var(--highlight-red)";
                        btnFree.style.background = "rgba(231, 76, 60, 0.1)";
                        btnFree.style.opacity = "1";
                    } else {
                        btnFree.style.color = "var(--text-secondary)";
                        btnFree.style.border = "1px solid var(--border)";
                        btnFree.style.background = "var(--nav-bg)";
                    }
                } else {
                    btnFree.innerText = t.btn_current;
                    btnFree.classList.add('current');
                    btnFree.style.color = ""; 
                    btnFree.style.background = "";
                    btnFree.style.border = "";
                }
            }
        }
    }

    function openBoosty(url) {
        if (!window.isUserLoggedIn) {
            // Если не залогинен - требуем вход
            alert(langData[currentLang].login_required || "Please log in (Sync Data) first so we can activate your subscription!");
            
            // Скроллим к кнопке входа и подсвечиваем её (опционально)
            switchTab('account');
            const loginBtn = document.getElementById('login-capsule');
            if(loginBtn) {
                loginBtn.style.border = "1px solid var(--accent)";
                setTimeout(() => loginBtn.style.border = "none", 1000);
            }
            return;
        }
        // Если залогинен - открываем
        window.open(url, '_blank');
    }

    function openThemeModal() {
        renderThemes();
        document.getElementById('modal-theme-overlay').classList.add('open');
    }

    function closeThemeModal(e, force) {
        if (force || e.target.id === 'modal-theme-overlay') {
            document.getElementById('modal-theme-overlay').classList.remove('open');
        }
    }

    function renderThemes() {
        const basicCont = document.getElementById('theme-list-basic');
        const premCont = document.getElementById('theme-list-premium');
        const currentTheme = localStorage.getItem('xch_theme_id') || 'dark';
        
        // Получаем объект переводов
        const t = langData[currentLang] || langData['en'];
        
        basicCont.innerHTML = '';
        premCont.innerHTML = '';

        APP_THEMES.forEach(theme => {
            const isLocked = (theme.type === 'pro' && subscriptionLevel === 'free');
            const isActive = (currentTheme === theme.id);
            
            // 1. ЛОКАЛИЗАЦИЯ НАЗВАНИЯ
            // Ищем ключ 'theme_midnight', 'theme_blue-dark' и т.д.
            const themeKey = 'theme_' + theme.id;
            
            // Если перевод есть - берем его, иначе дефолтное имя
            const localizedName = (t && t[themeKey]) ? t[themeKey] : theme.name;

            // 2. ЛОКАЛИЗАЦИЯ ТИПА (Light/Dark)
            let typeText = theme.isLight ? 'Light' : 'Dark';
            if (currentLang === 'ru') typeText = theme.isLight ? 'Светлая' : 'Тёмная';
            else if (currentLang === 'es') typeText = theme.isLight ? 'Claro' : 'Oscuro';
            else if (currentLang === 'de') typeText = theme.isLight ? 'Hell' : 'Dunkel';

            // Создаем элемент
            const div = document.createElement('div');
            div.className = `theme-item ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`;
            
            div.innerHTML = `
                <div class="theme-preview-box" style="background: ${theme.preview}; border: 1px solid var(--border);">
                    <span style="font-size:10px; font-weight:700; color:${theme.isLight ? '#000' : '#fff'}">Aa</span>
                </div>
                <div class="theme-info">
                    <span class="theme-name">${localizedName}</span>
                    <span class="theme-type" style="color: ${theme.type==='pro' ? 'var(--accent)' : 'var(--text-secondary)'}">
                        ${typeText}
                    </span>
                </div>
                ${isLocked ? '<span class="lock-icon">🔒</span>' : ''}
                ${isActive ? '<span class="lock-icon" style="color:var(--accent)">✓</span>' : ''}
            `;

            div.onclick = () => selectTheme(theme);
            
            // Распределяем по контейнерам
            if (theme.type === 'free') basicCont.appendChild(div);
            else premCont.appendChild(div);
        });
    }

    function selectTheme(theme) {
        if (theme.type === 'pro' && subscriptionLevel === 'free') {
            closeThemeModal(null, true);
            openSubModal(); // Открываем окно покупки
            return;
        }
        
        applyTheme(theme.id);
        renderThemes(); // Обновить галочки
        
        // Обновляем текст в меню настроек
        const label = document.getElementById('current-theme-name');
        if(label) label.innerText = theme.name;
    }

    function applyTheme(themeId) {
        localStorage.setItem('xch_theme_id', themeId);
        const root = document.documentElement;
        
        const theme = APP_THEMES.find(t => t.id === themeId);
        if (!theme) return;

        // 1. Light/Dark logic
        document.body.classList.toggle('light-theme', theme.isLight);
        
        // 2. Rainbow logic toggle
        if (theme.isRainbow) {
            document.body.classList.add('rainbow-mode');
            // Генерируем случайный цвет сразу при выборе
            setRandomRainbowColor();
        } else {
            document.body.classList.remove('rainbow-mode');
        }
        
        // 3. Reset styles
        const props = ['--bg-color', '--sidebar-bg', '--card-bg', '--nav-bg', '--border', '--ios-card', '--ios-bg', '--card-gradient'];
        props.forEach(p => root.style.removeProperty(p));
        
        // 4. Apply Custom Colors
        if (theme.colors) {
            // Добавляем !important логикой приоритета переменных
            if (theme.colors.bg) {
                root.style.setProperty('--bg-color', theme.colors.bg);
                root.style.setProperty('--ios-bg', theme.colors.bg);
            }
            if (theme.colors.sidebar) root.style.setProperty('--sidebar-bg', theme.colors.sidebar);
            
            if (theme.colors.card) {
                root.style.setProperty('--card-bg', theme.colors.card);
                root.style.setProperty('--ios-card', theme.colors.card);
                root.style.setProperty('--card-gradient', `linear-gradient(165deg, ${theme.colors.card}, ${theme.colors.bg})`);
            }
            
            if (theme.colors.nav) root.style.setProperty('--nav-bg', theme.colors.nav);
            if (theme.colors.border) root.style.setProperty('--border', theme.colors.border);
        }

        // 5. Apply Accent
        if (theme.accent) {
            root.style.setProperty('--accent', theme.accent);
            root.style.setProperty('--accent-light', theme.accentLight || theme.accent);
        } else if (!theme.isRainbow) {
            // Если не радуга и нет акцента (Free темы) -> вызываем updateLink для цвета сайта
            updateLink();
        }

        updateThemeLabel(theme.id);
    }

    function setRandomRainbowColor() {
        // Генерируем случайный оттенок (Hue) от 0 до 360
        const hue = Math.floor(Math.random() * 360);
        const color = `hsl(${hue}, 100%, 60%)`; // Яркий цвет
        const lightColor = `hsl(${hue}, 100%, 80%)`; 

        const root = document.documentElement;
        root.style.setProperty('--accent', color);
        root.style.setProperty('--accent-light', lightColor);
    }

    // Обновленная функция обновления текста в кнопке
    function updateThemeLabel(themeId) {
        // Если ID не передан, берем из памяти или дефолт
        if (!themeId) themeId = localStorage.getItem('xch_theme_id') || 'dark';
        
        const t = langData[currentLang] || langData['en'];
        const label = document.getElementById('current-theme-name');
        
        if (label) {
            // Формируем ключ перевода (например: theme_blue-dark)
            const key = 'theme_' + themeId;
            
            // Проверяем, есть ли перевод для этого ключа в текущем языке
            if (t && t[key]) {
                label.innerText = t[key];
            } else {
                // Если перевода нет, ищем оригинальное английское название
                const themeObj = APP_THEMES.find(x => x.id === themeId);
                label.innerText = themeObj ? themeObj.name : themeId;
            }
        }
    }

    function initSwipeCards() {
        const card = document.getElementById('card-block');
        const overlay = document.querySelector('.swipe-overlay'); 
        
        // Элементы декора (Иконки)
        const iconLeft = document.querySelector('.icon-left');
        const iconRight = document.querySelector('.icon-right');
        const statusText = document.getElementById('status-text');

        // Элементы, которые нужно размывать
        const blurTargets = [
            document.getElementById('slot-reel'),
            document.getElementById('result-desc'),
            document.getElementById('badge-wrapper'),
            document.getElementById('related-block'),
            document.getElementById('tinder-controls') 
        ];

        if (!card) return;

        // Базовые углы наклона иконок
        const leftBaseRot = -20;
        const rightBaseRot = 15;

        // --- 1. START ---
        card.addEventListener('touchstart', (e) => {
            // Игнорируем клики по кнопкам внутри карточки
            if (e.target.closest('button') || 
                e.target.closest('.related-item-btn') || 
                e.target.closest('.capsule-trigger') || 
                e.target.closest('.tag')) return;
            
            if (isGenerating) return;

            // ПРОВЕРКА ЛИМИТА (Без списания, только алерт)
            if (typeof checkGenerationLimit === 'function' && !checkGenerationLimit(true)) return;

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            currentX = startX;
            currentY = startY;
            isDragging = true;
            
            // Отключаем плавность для мгновенной реакции на палец
            card.style.transition = 'none';
            if (statusText) statusText.style.transition = 'none';
            if (overlay) overlay.style.transition = 'none';
            
            // Пауза анимации иконок
            if(iconLeft) {
                iconLeft.style.transition = 'none';
                iconLeft.style.animation = 'none'; 
            }
            if(iconRight) {
                iconRight.style.transition = 'none';
                iconRight.style.animation = 'none'; 
            }
            
        }, {passive: false});

        // --- 2. MOVE ---
        card.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;
            let deltaX = currentX - startX;
            let deltaY = currentY - startY; 

            // Блокируем скролл страницы, если тянем карточку
            if (Math.abs(deltaX) > 10 && e.cancelable) e.preventDefault();

            // А. ДВИЖЕНИЕ КАРТОЧКИ
            let rotate = deltaX * 0.05;
            card.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;

            // Б. ДВИЖЕНИЕ ТЕКСТА (Над карточкой)
            if (statusText) {
                statusText.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;
            }

            // В. ПАРАЛЛАКС ИКОНОК (Если они есть)
            if (iconLeft) {
                iconLeft.style.transform = `translate(${deltaX * 1.2}px, ${deltaY * 0.6}px) rotate(${leftBaseRot + (deltaX * 0.1)}deg)`;
            }
            if (iconRight) {
                iconRight.style.transform = `translate(${deltaX * 0.7}px, ${deltaY * 0.3}px) rotate(${rightBaseRot - (deltaX * 0.05)}deg)`;
            }

            // Г. ЭФФЕКТЫ (ЦВЕТ + БЛЮР) - Самое важное!
            const progress = Math.min(Math.abs(deltaX) / 150, 1); // 0...1 (1 = полный свайп)
            
            // Заливка цветом
            if (overlay) {
                const alpha = progress * 0.85; // Максимум 85% непрозрачности
                if (deltaX > 0) {
                    // Вправо (Зеленый)
                    overlay.style.backgroundColor = `rgba(46, 204, 113, ${alpha})`; 
                } else {
                    // Влево (Красный)
                    overlay.style.backgroundColor = `rgba(231, 76, 60, ${alpha})`; 
                }
            }

            // Блюр контента
            const blurAmount = progress * 8; // Максимум 8px блюра
            blurTargets.forEach(el => { 
                if(el) el.style.filter = `blur(${blurAmount}px)`; 
            });

        }, {passive: false});

        // --- 3. END ---
        card.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            
            let deltaX = currentX - startX;
            const threshold = window.innerWidth * 0.25; // Свайпнуть нужно на 25% ширины экрана

            if (Math.abs(deltaX) > threshold) {
                // === УЛЕТАЕТ ===
                const direction = deltaX > 0 ? 'right' : 'left';

                if (isModeSelectionActive) {
                    // Анимация улета карточки
                    card.style.transition = 'transform 0.3s ease-out';
                    card.style.transform = `translateX(${direction === 'right' ? 500 : -500}px)`;

                    setTimeout(() => {
                        // Возврат
                        card.style.transition = 'none';
                        card.style.transform = '';
                        
                        // Логика
                        if (direction === 'right') {
                            setAppModeAndStart('pleasure'); // Вправо -> Привычное (Наслаждение)
                        } else {
                            setAppModeAndStart('explore');  // Влево -> Новое (Исследование)
                        }
                    }, 300);
                    return;
                }

                const endX = deltaX > 0 ? window.innerWidth + 200 : -window.innerWidth - 200;
                
                // Запускаем анимацию вылета
                card.style.transition = 'transform 0.3s ease-out';
                card.style.transform = `translateX(${endX}px) rotate(${endX * 0.05}deg)`;

                // Текст тоже улетает
                if (statusText) {
                    statusText.style.transition = 'transform 0.3s ease-out';
                    statusText.style.transform = `translateX(${endX}px) rotate(${endX * 0.05}deg)`;
                }

                // Иконки улетают
                if(iconLeft) {
                    iconLeft.style.transition = 'transform 0.3s ease-out, opacity 0.3s';
                    iconLeft.style.opacity = '0';
                    iconLeft.style.transform = `translate(${endX}px, -50px)`;
                }
                if(iconRight) {
                    iconRight.style.transition = 'transform 0.3s ease-out, opacity 0.3s';
                    iconRight.style.opacity = '0';
                    iconRight.style.transform = `translate(${endX}px, -20px)`;
                }

                // Вызываем логику
                setTimeout(() => {
                    handleSwipeAction(direction);
                }, 300);

            } else {
                // === ВОЗВРАТ НА МЕСТО (Отмена свайпа) ===
                
                // Убираем блюр плавно
                blurTargets.forEach(el => { 
                    if(el) { 
                        el.style.transition = 'filter 0.3s ease'; 
                        el.style.filter = 'none'; 
                    } 
                });

                // Убираем цвет оверлея плавно
                if (overlay) { 
                    overlay.style.transition = 'background-color 0.3s ease'; 
                    overlay.style.backgroundColor = 'transparent'; 
                }

                // Возвращаем карточку
                card.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                card.style.transform = 'translateX(0) rotate(0)';

                // Возвращаем текст
                if (statusText) {
                    statusText.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    statusText.style.transform = 'translateX(0) rotate(0)';
                }

                // Возвращаем иконки
                if(iconLeft) {
                    iconLeft.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    iconLeft.style.transform = `translate(0px, 0px) rotate(${leftBaseRot}deg)`;
                    setTimeout(() => { iconLeft.style.animation = ''; }, 400); // Возвращаем парение
                }
                if(iconRight) {
                    iconRight.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    iconRight.style.transform = `translate(0px, 0px) rotate(${rightBaseRot}deg)`;
                    setTimeout(() => { iconRight.style.animation = ''; }, 400);
                }
            }
        });
    }

    function handleSwipeAction(direction) {
        // 1. Проверка лимита
        if (typeof checkGenerationLimit === 'function' && !checkGenerationLimit(true)) return;

        if (isGenerating) return;
        if (currentItem) sessionHistoryStack.push(currentItem);

        const wrapper = document.getElementById('card-anim-wrapper');
        const card = document.getElementById('card-block');
        const btnUndo = document.getElementById('btn-t-undo');
        
        // Элементы для эффектов (Те же, что и в свайпах)
        const overlay = document.querySelector('.swipe-overlay');
        const blurTargets = [
            document.getElementById('slot-reel'),
            document.getElementById('result-desc'),
            document.getElementById('badge-wrapper'),
            document.getElementById('related-block'),
            document.getElementById('tinder-controls')
        ];

        if(btnUndo) btnUndo.disabled = true;

        if (direction === 'right') toggleFavorite(true); 
        else toggleBlacklist(true);

        // Проверяем, сдвинута ли карточка пальцем
        // Если transform == 'none', значит карточка стоит в центре -> это клик по кнопке
        const currentTransform = getComputedStyle(card).transform;
        const isCardCentered = currentTransform === 'none' || currentTransform === 'matrix(1, 0, 0, 1, 0, 0)';

        if (isCardCentered && wrapper) {
            // === ЭТО КЛИК ПО КНОПКЕ ===
            
            // 1. Применяем цвет и блюр (Визуальный отклик)
            if (overlay) {
                overlay.style.transition = 'background-color 0.2s ease';
                if (direction === 'right') {
                    overlay.style.backgroundColor = 'rgba(46, 204, 113, 0.8)'; // Зеленый
                } else {
                    overlay.style.backgroundColor = 'rgba(231, 76, 60, 0.8)'; // Красный
                }
            }

            blurTargets.forEach(el => {
                if(el) {
                    el.style.transition = 'filter 0.2s ease';
                    el.style.filter = 'blur(5px)'; // Блюрим контент
                }
            });

            // 2. Анимируем улет всей ОБЁРТКИ
            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.opacity = '0';
            
            if (direction === 'right') {
                wrapper.style.transform = 'translateX(150%) rotate(10deg)';
            } else {
                wrapper.style.transform = 'translateX(-150%) rotate(-10deg)';
            }

            setTimeout(() => {
                startGeneration(
                    direction === 'right' ? 'similar' : 'random', 
                    direction === 'right' ? 'like' : 'dislike'
                );
            }, 300);
        } else {
            // === ЭТО БЫЛ СВАЙП ПАЛЬЦЕМ (Эффекты уже применены в touchmove) ===
            startGeneration(
                direction === 'right' ? 'similar' : 'random', 
                direction === 'right' ? 'like' : 'dislike'
            );
        }
    }

    function animateSwipeEnd(moveX, direction) {
        const card = document.getElementById('card-block');
        card.style.transition = 'transform 0.3s ease-out';
        card.style.transform = `translateX(${moveX}px) rotate(${moveX * 0.05}deg)`;
        
        // Ждем окончания анимации вылета, затем запускаем логику
        setTimeout(() => {
            handleSwipeAction(direction);
        }, 300);
    }

    function undoLastAction() {
        if (sessionHistoryStack.length === 0) return;

        const prevItem = sessionHistoryStack.pop();
        const card = document.getElementById('card-block');
        
        // Сброс стилей
        card.classList.remove('restore-anim', 'anim-fly-left', 'anim-fly-right');
        card.style.transform = 'none';
        void card.offsetWidth; 
        
        card.classList.add('has-results');

        // Анимация возврата (справа налево)
        card.classList.add('anim-fly-right');

        setTimeout(() => {
            forceShowResult(prevItem, 'undo'); 
            
            setTimeout(() => card.classList.remove('anim-fly-right'), 700);
        }, 50);

        if (sessionHistoryStack.length === 0) {
            const undoBtn = document.getElementById('btn-t-undo');
            if(undoBtn) undoBtn.disabled = true;
        }
    }

    function startGeneration(mode, direction = 'next') {
        if (document.body.classList.contains('rainbow-mode')) setRandomRainbowColor();
        if (!checkGenerationLimit()) return; 
        if (isGenerating) return;

        randomizeDecorations();

        if (mode === 'random') {
            const roll = Math.random(); // Генерируем число от 0.0 до 1.0
            const depth = sessionHistoryStack.length; // Глубина текущей сессии

            // Хелпер для проверки валидности предмета (чтобы не дублировать код)
            const isValidInjection = (item) => {
                if (!item) return false;
                if (cooldownList.includes(item.id)) return false; // Недавно было
                
                // Проверка ориентации (не показывать гей-контент в гетеро режиме и наоборот)
                if (currentOrientation === 'gay' && !item.tags.includes('gay')) return false;
                if (currentOrientation === 'hetero' && item.tags.includes('gay')) return false;
                if (currentOrientation === 'trans' && !item.tags.some(t=>['trans','shemale'].includes(t))) return false;
                
                return true;
            };

            let targetItem = null;
            let injectionMode = null;

            // 1. WATCH LATER (Приоритет: Высокий, Шанс: ~12%, Глубина: >2)
            if (roll < 0.12 && watchLater.length > 0 && depth > 2) {
                const candidate = data.find(x => x.id === watchLater[Math.floor(Math.random() * watchLater.length)]);
                if (isValidInjection(candidate)) {
                    targetItem = candidate;
                    injectionMode = 'wl_reminder';
                }
            }
            
            // 2. FAVORITES (Приоритет: Средний, Шанс: ~4% (0.12 - 0.16), Глубина: >5)
            // Напоминаем о любимом, только если уже немного посвайпали
            else if (roll >= 0.12 && roll < 0.16 && favorites.length > 0 && depth > 5) {
                const candidate = data.find(x => x.id === favorites[Math.floor(Math.random() * favorites.length)]);
                if (isValidInjection(candidate)) {
                    targetItem = candidate;
                    injectionMode = 'fav_reminder';
                }
            }

            // 3. BLACKLIST (Приоритет: Низкий, Шанс: ~1.5% (0.16 - 0.175), Глубина: >10)
            // Очень редко и только если сессия долгая
            else if (roll >= 0.16 && roll < 0.175 && blacklist.length > 0 && depth > 10) {
                const candidate = data.find(x => x.id === blacklist[Math.floor(Math.random() * blacklist.length)]);
                if (isValidInjection(candidate)) {
                    targetItem = candidate;
                    injectionMode = 'ban_reminder';
                }
            }

            // ЕСЛИ ВБРОС СРАБОТАЛ:
            if (targetItem && injectionMode) {
                console.log(`Injection Triggered: ${injectionMode}`);
                isGenerating = true;
                hasInteractedWithCurrent = false;

                const wrapper = document.getElementById('card-anim-wrapper');
                if(wrapper) wrapper.style.opacity = '0';
                
                // Запускаем с особым режимом
                finishGeneration(targetItem, injectionMode);

                if(wrapper) {
                    wrapper.style.transform = '';
                    void wrapper.offsetWidth; 
                    wrapper.style.opacity = '1';
                    const animClass = (direction === 'like') ? 'anim-fly-left' : 'anim-fly-right';
                    wrapper.classList.add(animClass);
                    setTimeout(() => {
                        wrapper.classList.remove('anim-fly-right', 'anim-fly-left');
                        wrapper.style.transform = '';
                    }, 800);
                }
                return; 
            }
        }

        // 1. Модификаторы
        if (currentOrientation === 'gay') activeMods.add('Gay');
        else if (currentOrientation === 'trans') activeMods.add('Trans');
        renderModifiers();

        // 2. Чистка UI
        const descEl = document.getElementById('result-desc');
        if(descEl) descEl.style.display = 'none';
        const statusText = document.getElementById('status-text');
        if(statusText) statusText.innerText = ''; 
        document.getElementById('badge-wrapper').innerHTML = '';
        
        document.getElementById('mods-capsule').classList.remove('open');
        const modContainer = document.getElementById('mod-container');
        if (modContainer) modContainer.classList.remove('open');
        
        document.getElementById('tinder-controls').classList.add('hidden-initial');
        document.getElementById('mods-block').classList.add('hidden-initial');
        document.getElementById('related-block').classList.add('hidden-initial');

        // 3. Элементы
        const card = document.getElementById('card-block');
        const wrapper = document.getElementById('card-anim-wrapper');
        const iconLeft = document.querySelector('.icon-left');
        const iconRight = document.querySelector('.icon-right');
        const overlay = document.querySelector('.swipe-overlay');
        
        // === СБРОС СОСТОЯНИЯ ===
        if (wrapper) {
            wrapper.classList.remove('anim-fly-left', 'anim-fly-right');
            wrapper.style.transform = '';
            wrapper.style.transition = '';
            wrapper.style.opacity = '1';
        }

        if(card) {
            card.classList.remove('status-wl', 'status-fav', 'status-ban');
            card.classList.remove('flash-active', 'has-results'); 
            card.style.transform = ''; 
            card.style.transition = '';
            card.style.opacity = '1'; 
            card.style.backgroundColor = '';
            card.style.borderColor = '';
            card.style.filter = '';
            
            // Сброс оверлея
            if (overlay) {
                overlay.style.transition = 'none'; // Убираем анимацию, чтобы сбросилось мгновенно
                overlay.style.backgroundColor = 'transparent';
                overlay.style.opacity = ''; 
            }
            
            // Сброс блюра на элементах
            const blurTargets = [
                document.getElementById('slot-reel'), 
                document.getElementById('result-desc'), 
                document.getElementById('badge-wrapper'), 
                document.getElementById('related-block'),
                document.getElementById('tinder-controls') // Добавили кнопки
            ];
            
            blurTargets.forEach(el => { 
                if(el) { 
                    el.style.transition = 'none'; // Мгновенно
                    el.style.filter = 'none'; 
                }
            });
            
            void card.offsetWidth; // Force reflow
        }
        
        // --- ПОЛНЫЙ СБРОС ИКОНОК ---
        if(iconLeft) {
            iconLeft.style.transition = 'none'; // Убираем плавность, чтобы они вернулись мгновенно
            iconLeft.style.opacity = '';        // Сбрасываем прозрачность (вернется к CSS значению)
            iconLeft.style.transform = '';      // Возвращаем на место
            iconLeft.style.animation = '';      // Сбрасываем паузу анимации
        }
        if(iconRight) {
            iconRight.style.transition = 'none';
            iconRight.style.opacity = '';
            iconRight.style.transform = '';
            iconRight.style.animation = '';
        }
        
        // 4. Логика выбора
        if (mode === 'random' && currentItem && !hasInteractedWithCurrent) {
            if (watchLater.includes(currentItem.id)) adjustTagScores(currentItem, 1);
            else adjustTagScores(currentItem, -1);
        }
        if (mode === 'similar' && currentItem) adjustTagScores(currentItem, 1);

        let filtered = filterData();
        if (mode === 'similar' && lastGeneratedItem) {
            const subset = filtered.filter(item => {
                if (item.id === lastGeneratedItem.id) return false;
                const intersection = item.tags.filter(t => lastGeneratedItem.tags.includes(t));
                return intersection.length >= 2;
            });
            if (subset.length > 0) filtered = subset;
        }

        const reel = document.getElementById('slot-reel');
        if (filtered.length === 0) {
            reel.innerHTML = `<div class="slot-item" style="color:var(--highlight-red);">List Empty</div>`;
            document.getElementById('tinder-controls').classList.remove('hidden-initial');
            return;
        }

        isGenerating = true;
        hasInteractedWithCurrent = false;
        hasWatchedCurrentItem = false;
        const finalItem = getWeightedRandom(filtered);

        // === АНИМАЦИЯ ===

        if (isFirstGen) {
            // Сценарий 1: Первый запуск
            const spinCount = 10;
            let html = '';
            for (let i = 0; i < spinCount - 1; i++) {
                const randomItem = filtered[Math.floor(Math.random() * filtered.length)];
                html += `<div class="slot-item">${getLocalizedName(randomItem)}</div>`;
            }
            const winnerName = getLocalizedName(finalItem);
            html += `<div class="slot-item" id="result-text">${winnerName}</div>`;
            
            reel.className = 'slot-reel spinning'; 
            reel.innerHTML = html;
            reel.querySelectorAll('.slot-item').forEach(el => el.classList.add('shrunk'));
            reel.style.transform = 'translateY(0)';
            
            // Влет обёртки
            if(wrapper) wrapper.classList.add('anim-fly-left'); 

            setTimeout(() => {
                isFirstGen = false;
                const isPC = window.innerWidth > 768;
                const itemHeight = isPC ? 450 : 300;
                const realHeight = reel.firstElementChild ? reel.firstElementChild.offsetHeight : itemHeight;
                const targetIndex = 9; 
                const targetY = -(targetIndex * realHeight);
                
                requestAnimationFrame(() => {
                    reel.style.transition = 'transform 1.2s cubic-bezier(0.25, 1, 0.5, 1)';
                    reel.style.transform = `translateY(${targetY}px)`;
                });
                setTimeout(() => { finishGeneration(finalItem, mode); }, 1200);
            }, 300);

        } else {
            // Сценарий 2: Обычная генерация
            if(wrapper) wrapper.style.opacity = '0'; // Скрываем на мгновение
            
            finishGeneration(finalItem, mode);

            if(wrapper) {
                wrapper.style.transform = '';
                void wrapper.offsetWidth; 
                wrapper.style.opacity = '1';

                const animClass = (direction === 'like') ? 'anim-fly-left' : 'anim-fly-right';
                wrapper.classList.add(animClass);

                setTimeout(() => {
                    wrapper.classList.remove('anim-fly-right', 'anim-fly-left');
                    wrapper.style.transform = '';
                }, 800);
            }
        }
    }

    function startNewSession() {
        if (!checkGenerationLimit(true)) return;
        const wrapper = document.getElementById('card-anim-wrapper');
        const startBtn = document.getElementById('start-btn-container');
        
        if(startBtn) {
            startBtn.classList.add('hidden-initial');
            startBtn.style.display = 'none';
        }

        if(wrapper) {
                wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
                wrapper.style.opacity = '0';
                wrapper.style.transform = 'translateX(150%) rotate(10deg)'; 
        }

        setTimeout(() => {
            sessionHistoryStack = []; 
            isFirstGen = false; 
            startGeneration('random', 'like'); 
        }, 350);
    }

    function updateCardStatusVisuals(suppressColors = false) {
        const card = document.getElementById('card-block');
        const notch = document.getElementById('card-notch');
        const notchText = document.getElementById('card-notch-text');
        
        if (!card || !notch || !currentItem) return;

        // Сброс классов
        card.classList.remove('status-wl', 'status-fav', 'status-ban');
        notch.classList.remove('visible');

        // Если это "Напоминание", мы хотим показать карточку нейтральной,
        // чтобы пользователь принял решение заново.
        if (suppressColors) return;

        const t = langData[currentLang];
        let activeStatus = null;

        if (blacklist.includes(currentItem.id)) {
            activeStatus = 'ban';
            notchText.innerText = t.status_ban;
        } 
        else if (favorites.includes(currentItem.id)) {
            activeStatus = 'fav';
            notchText.innerText = t.status_fav;
        }
        else if (watchLater.includes(currentItem.id)) {
            activeStatus = 'wl';
            notchText.innerText = t.status_wl;
        }

        if (activeStatus) {
            card.classList.add('status-' + activeStatus);
            setTimeout(() => {
                notch.classList.add('visible');
            }, 50);
        }
    }

    function renderResultUI(item, mode) {
        currentItem = item;
        lastGeneratedItem = item;
        
        // 1. Сброс анимаций элементов
        const elementsToReset = document.querySelectorAll('.stagger-item');
        elementsToReset.forEach(el => {
            el.style.animation = 'none';
            el.offsetHeight; /* trigger reflow */
            el.style.animation = ''; 
            // Убираем классы скрытия, чтобы элементы могли появиться
            el.classList.remove('hidden-initial', 'visually-hidden', 'fade-hidden');
        });

        let baseName = getLocalizedName(item);
        let finalHtml = baseName;

        // 2. Название (Слот)
        let displayName = getLocalizedName(item);
    
        // Формируем HTML с модификаторами
        let modifiersHtml = "";
        if (activeMods.size > 0) {
            const modNames = Array.from(activeMods).map(key => {
                const m = modifiersData.find(x => x.key === key);
                if (m) {
                    if (currentLang === 'ru') return m.ru;
                    if (currentLang === 'es') return m.es;
                    if (currentLang === 'de') return m.de;
                    return m.en;
                }
                return key;
            });
            
            // Добавляем красивый спан с плюсом
            if (modNames.length > 0) {
                modifiersHtml = ` <span style="color:var(--accent); font-weight:300; opacity:0.9;">+ ${modNames.join(" + ")}</span>`;
            }
        }

        const reel = document.getElementById('slot-reel');
        reel.removeAttribute('style');
        reel.className = 'slot-reel';
        
        // Используем innerHTML и вставляем переменную modifiersHtml
        reel.innerHTML = `<div class="slot-item final-result" id="result-text" style="color:var(--text-main); font-weight:900;">
            ${displayName}${modifiersHtml}
        </div>`;
        
        // 3. Описание
        const descEl = document.getElementById('result-desc');
        let desc = item.desc_en; 
        if (currentLang === 'ru' && item.desc_ru) desc = item.desc_ru;
        else if (currentLang === 'es' && item.desc_es) desc = item.desc_es;
        else if (currentLang === 'de' && item.desc_de) desc = item.desc_de;
        
        if(descEl) {
            descEl.innerText = desc || "";
            descEl.style.display = 'block'; 
        }

        // 4. Фраза сверху
        const statusEl = document.getElementById('status-text');
        if(statusEl) {
            const explanation = getExplanationText(mode);
            statusEl.style.display = 'flex'; 
            statusEl.classList.remove('hidden-initial'); // Важно убрать скрытие
            
            if (explanation) {
                statusEl.innerText = explanation;
                statusEl.style.color = "var(--accent)";
            } else {
                const comments = resultComments[currentLang];
                statusEl.innerText = comments[Math.floor(Math.random() * comments.length)];
                statusEl.style.color = "var(--text-secondary)";
            }
        }

        // 5. Карточка (Эффекты)
        const card = document.getElementById('card-block');
        if(card) {
            card.classList.remove('is-spinning');
            card.classList.add('has-results');
            
            // Вспышка
            card.classList.add('flash-active'); 
            setTimeout(() => card.classList.remove('flash-active'), 300);
            
            // Сброс позиций и цветов
            card.style.transform = 'translate(0, 0) rotate(0)';
            card.style.backgroundColor = '';
            card.style.borderColor = '';
            card.style.filter = '';
            card.style.transition = 'none';
        }

        // 6. ПЕРЕКЛЮЧЕНИЕ КНОПОК (ГЛАВНОЕ ИСПРАВЛЕНИЕ)
        
        // А. Скрываем кнопку "Поехали"
        const startBtnContainer = document.getElementById('start-btn-container');
        if (startBtnContainer) {
            startBtnContainer.classList.add('hidden-initial'); // Добавляем класс
            startBtnContainer.style.display = 'none'; // Дублируем инлайном для надежности
        }

        // Б. Показываем игровые кнопки, моды и "Похожее"
        const idsToShow = ['tinder-controls', 'mods-block', 'related-block'];
        idsToShow.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('hidden-initial', 'visually-hidden');
                el.style.display = 'flex'; // Принудительно ставим flex
                
                // Перезапуск анимации появления
                el.style.animation = 'none';
                el.offsetHeight;
                el.style.animation = '';
            }
        });

        // 7. Кнопка Undo
        const btnUndo = document.getElementById('btn-t-undo');
        if (btnUndo) {
            if (sessionHistoryStack && sessionHistoryStack.length > 0) {
                btnUndo.disabled = false;
                btnUndo.style.opacity = "1";
            } else {
                btnUndo.disabled = true;
                btnUndo.style.opacity = "0.3";
            }
        }

        updateLink();
        renderBadges();
        renderRelatedItems();
        updateActionButtons();
        const isReminder = mode && mode.includes('reminder');
        updateCardStatusVisuals(isReminder);
        randomizeDecorations(item);
    }

    function updateActionButtons() {
        if(!currentItem) return;
        
        const btnPass = document.getElementById('btn-t-pass'); // Крестик
        const btnLike = document.getElementById('btn-t-like'); // Сердце
        const btnWL = document.getElementById('btn-t-wl');     // Звезда

        // Сброс стилей (убираем inline стили фона/бордера, оставляем классы)
        if (btnPass) btnPass.style.background = "";
        if (btnLike) btnLike.style.background = "";
        if (btnWL) btnWL.classList.remove('active');

        // Ставим стили для активных
        if (blacklist.includes(currentItem.id)) {
            if (btnPass) btnPass.style.background = "#e74c3c"; // Красный фон
            if (btnPass) btnPass.style.color = "#fff";
        } 
        if (favorites.includes(currentItem.id)) {
            if (btnLike) btnLike.style.background = "#2ecc71"; // Зеленый фон
            if (btnLike) btnLike.style.color = "#fff";
        }
        if (watchLater.includes(currentItem.id)) {
            if (btnWL) btnWL.classList.add('active'); // Добавляет синий
        } else {
            if (btnWL) btnWL.classList.remove('active'); // Убирает синий (становится серым)
        }
    }

    function toggleFavorite(silent = false) {
        if(!currentItem) return;
        const id = currentItem.id;
        
        if (favorites.includes(id)) {
            if (!silent) favorites = favorites.filter(x => x !== id);
        } else {
            favorites.push(id); 
            blacklist = blacklist.filter(x => x !== id);
            
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, 5); // Лайк влияет на выдачу
            
            hasInteractedWithCurrent = true;
            logActivity('like', id, fullTags);
        }
        saveLists(); 
        updateActionButtons(); 
        updateCounts();
        updateCardStatusVisuals(); 
    }

    function toggleBlacklist(silent = false) {
        if(!currentItem) return;
        const id = currentItem.id;
        
        // Не баним, если это Watch Later ИЛИ Favorites (вброс)
        if (watchLater.includes(id) || favorites.includes(id)) {
            return;
        }

        if (blacklist.includes(id)) {
            if (!silent) blacklist = blacklist.filter(x => x !== id);
        } else { 
            blacklist.push(id); 

            favorites = favorites.filter(x => x !== id); 
            
            const fullTags = getCombinedTags(currentItem);
            adjustTagScoresByTags(fullTags, -5); 
            
            logActivity('dislike', id, fullTags);
        }
        
        saveLists(); 
        updateActionButtons();
    }

    function toggleWatchLater() {
        if(!currentItem) return;
        const id = currentItem.id;
        const btn = document.getElementById('btn-t-wl'); // Новый ID

        if (watchLater.includes(id)) {
            watchLater = watchLater.filter(x => x !== id);
            if(btn) btn.classList.remove('active');
        } else {
            watchLater.push(id);
            if(btn) btn.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(50);
        }
        
        localStorage.setItem(STORAGE.WATCH_LATER, JSON.stringify(watchLater));
        updateCounts(); 
    }

    function openWatchLaterCatalog() {
        renderListModal('wl');
    }

    function getWrappedData() {
        const logs = activityLog; 
        
        let totalActions = 0;
        let firstActionTime = Date.now();
        let lastActionTime = 0;

        const itemCounts = {};
        const tagCounts = {};
        const hours = new Array(24).fill(0);
        
        let countToday = 0;
        const startOfDay = new Date();
        startOfDay.setHours(0,0,0,0);

        let extremeCount = 0;
        let vanillaCount = 0;
        let watchCount = 0;

        logs.forEach(l => {
            // Учитываем все "активные" действия
            if (l.type === 'watch' || l.type === 'like' || l.type === 'gen' || l.type === 'dislike' || l.type === 'pass') {
                totalActions++;
                
                if (l.ts < firstActionTime) firstActionTime = l.ts;
                if (l.ts > lastActionTime) lastActionTime = l.ts;
                if (l.ts >= startOfDay.getTime()) countToday++;

                // Для статистики берем только позитивные или нейтральные (кроме дизлайков для подсчета топов)
                if (l.type === 'watch' || l.type === 'like' || l.type === 'gen') {
                    itemCounts[l.id] = (itemCounts[l.id] || 0) + (l.type === 'watch' ? 3 : 1);
                    
                    if (l.tags) {
                        l.tags.forEach(t => {
                            if(['universal','straight','gay','lesbian','trans','male','female','adult'].includes(t)) return;
                            tagCounts[t] = (tagCounts[t] || 0) + 1;
                            if (EXTREME_TAGS.includes(t)) extremeCount++;
                            if (['vanilla', 'romantic', 'kissing', 'massage'].includes(t)) vanillaCount++;
                        });
                    }
                    const h = new Date(l.ts).getHours();
                    hours[h]++;
                    if (l.type === 'watch') watchCount++;
                }
            }
        });

        // Сортировка
        const topItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([id, score]) => {
            const item = data.find(x => x.id == id);
            return item ? { name: getLocalizedName(item), score } : null;
        }).filter(x => x);

        const topTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([tag]) => tag.charAt(0).toUpperCase() + tag.slice(1));

        // Время
        const morning = hours.slice(5, 12).reduce((a,b)=>a+b,0);
        const day = hours.slice(12, 20).reduce((a,b)=>a+b,0);
        const night = hours.slice(20, 24).reduce((a,b)=>a+b,0) + hours.slice(0, 5).reduce((a,b)=>a+b,0);
        let peakTime = 'day';
        if (night > day && night > morning) peakTime = 'night';
        else if (morning > day && morning > night) peakTime = 'morning';

        // Архетип
        let archetype = 'explorer';
        const totalPositive = watchCount + extremeCount + vanillaCount; // Грубая оценка базы
        if (watchCount / (totalActions || 1) > 0.4) archetype = 'connoisseur';
        else if (extremeCount > vanillaCount * 1.5) archetype = 'wild';
        else if (vanillaCount > extremeCount * 1.5) archetype = 'romantic';

        // Форматирование дат
        const opts = { day: 'numeric', month: 'short' };
        const dateRange = `${new Date(firstActionTime).toLocaleDateString(currentLang, opts)} - ${new Date(lastActionTime).toLocaleDateString(currentLang, opts)}`;

        return {
            totalActions,
            countToday,
            topItems,
            topTags,
            peakTime,
            archetype,
            dateRange
        };
    }

    function getWrappedPhrase(category, replacements = {}) {
        // 1. Определяем язык (если нет перевода, берем EN)
        const lang = wrappedPhrases[currentLang] ? currentLang : 'en';
        const phrases = wrappedPhrases[lang][category];
        
        // 2. Берем случайную фразу
        let phrase = phrases[Math.floor(Math.random() * phrases.length)];
        
        // 3. Заменяем плейсхолдеры (например, {n} на число)
        for (const [key, value] of Object.entries(replacements)) {
            phrase = phrase.replace(`{${key}}`, value);
        }
        
        return phrase;
    }

    function openWrapped() {
        const dataStats = getWrappedData();
        // Фоллбек на английский, если язык не поддерживается новой структурой
        const langKey = (wrappedPhrases[currentLang] && wrappedPhrases[currentLang].story_first) ? currentLang : 'en';
        const content = wrappedPhrases[langKey];
        
        // --- 1. ОПРЕДЕЛЕНИЕ СЮЖЕТА (Первый раз или нет) ---
        const hasSeenBefore = localStorage.getItem('xch_has_seen_wrapped');
        const storyType = hasSeenBefore ? 'story_regular' : 'story_first';
        const story = content[storyType];
        
        // Помечаем, что видел
        localStorage.setItem('xch_has_seen_wrapped', 'true');

        // --- 2. ИМЯ ПОЛЬЗОВАТЕЛЯ ---
        let userName = langKey === 'ru' ? "Путник" : "Stranger";
        if (window.isUserLoggedIn && auth.currentUser && auth.currentUser.email) {
            // Берем часть до @ и делаем первую букву заглавной
            const emailName = auth.currentUser.email.split('@')[0];
            userName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
        }

        // Хелпер для случайной фразы с заменой имени
        const getPhrase = (arr) => {
            let txt = arr[Math.floor(Math.random() * arr.length)];
            return txt.replace(/{name}/g, `<span style="color:var(--accent)">${userName}</span>`);
        };

        // ... (Проверка на FREE лимит остается без изменений) ...
        if (subscriptionLevel === 'free') {
            const lastAccess = parseInt(localStorage.getItem('xch_last_wrapped_free') || '0');
            const now = Date.now();
            const cooldownTime = 7 * 24 * 60 * 60 * 1000; 
            if (now - lastAccess < cooldownTime) {
                const daysLeft = Math.ceil((lastAccess + cooldownTime - now) / (1000 * 60 * 60 * 24));
                alert(currentLang === 'ru' ? `Доступно раз в 7 дней. Ждать: ${daysLeft} дн.` : `Available once every 7 days. Days left: ${daysLeft}`); 
                openSubModal();
                return;
            }
            localStorage.setItem('xch_last_wrapped_free', now);
        }

        if (!dataStats || dataStats.totalActions < 5) { // Подняли порог для теста
            alert("Not enough data to generate a story. Keep exploring!");
            return;
        }

        const overlay = document.getElementById('wrapped-mount');
        overlay.innerHTML = '';
        overlay.classList.add('active');
        
        const slides = [];

        // --- SLIDE 1: INTRO (Сюжетное) ---
        slides.push(`
            <div class="wrapped-slide bg-dark active-slide" style="justify-content: center; text-align: left; padding: 40px;">
                <div class="wrapped-big-text" style="font-size:40px; margin-bottom:30px; text-align:center;">Fetish<br><span style="color:var(--accent)">Wrapped</span></div>
                <div class="wrapped-sub-text" style="font-size:22px; line-height:1.6; font-weight:500;">
                    ${getPhrase(story.intro)}
                </div>
            </div>
        `);

        // --- SLIDE 2: ACTIVITY (Сюжетное) ---
        slides.push(`
            <div class="wrapped-slide bg-fire">
                <div class="wrapped-sub-text" style="opacity:0.8; margin-bottom:10px;">${content.common.total_label}</div>
                <div class="wrapped-big-text" style="font-size:110px; line-height:1; margin: 10px 0;">${dataStats.totalActions}</div>
                <div class="wrapped-sub-text" style="font-size:20px; line-height:1.5; max-width:340px; margin-top:20px;">
                    ${getPhrase(story.activity)}
                </div>
            </div>
        `);

        // --- SLIDE 3: TIME (Сюжетное) ---
        let timeIcon = "☀️";
        if (dataStats.peakTime === 'night') timeIcon = "🦇";
        if (dataStats.peakTime === 'morning') timeIcon = "🌅";

        slides.push(`
            <div class="wrapped-slide" style="background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);">
                <div class="wrapped-big-text" style="font-size:80px; margin-bottom:10px;">${timeIcon}</div>
                <div class="wrapped-sub-text" style="font-size:20px; line-height:1.6; max-width:340px;">
                    ${getPhrase(story.timing)}
                </div>
            </div>
        `);

        // --- SLIDE 4: TOP ITEMS (Сюжетное) ---
        let listHtml = dataStats.topItems.map((item, i) => 
            `<div style="font-size:${22 - i*1}px; margin:12px 0; font-weight:700; opacity:0; animation: slideInRight 0.6s ease forwards ${i*0.4}s; text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">
                <span style="color:var(--accent); margin-right:10px;">#${i+1}</span> ${item.name}
            </div>`
        ).join('');

        slides.push(`
            <div class="wrapped-slide bg-toxic">
                <div class="wrapped-sub-text" style="font-size:18px; margin-bottom:20px;">${getPhrase(story.obsession)}</div>
                <div style="width:100%; max-width:320px;">${listHtml}</div>
            </div>
        `);

        // --- SLIDE 5: ARCHETYPE (Детальное описание) ---
        let archObj = content.common.arch_explorer;
        let archBg = "linear-gradient(45deg, #11998e, #38ef7d)";

        if (dataStats.archetype === 'connoisseur') {
            archObj = content.common.arch_connoisseur;
            archBg = "linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045)";
        } else if (dataStats.archetype === 'wild') {
            archObj = content.common.arch_wild;
            archBg = "linear-gradient(45deg, #000000, #434343)";
        } else if (dataStats.archetype === 'romantic') {
            archObj = content.common.arch_romantic;
            archBg = "linear-gradient(45deg, #ff9a9e, #fecfef)";
        }

        slides.push(`
            <div class="wrapped-slide" style="background: ${archBg}; justify-content:center;">
                <div class="wrapped-sub-text" style="text-transform:uppercase; letter-spacing:2px; font-size:12px; margin-bottom:15px;">${getPhrase(story.archetype)}</div>
                
                <div class="wrapped-big-text" style="font-size:42px; margin:10px 0; border:4px solid #fff; padding:25px; line-height:1.1; background:rgba(0,0,0,0.2); backdrop-filter:blur(5px); border-radius:4px;">
                    ${archObj.name}
                </div>
                
                <div class="wrapped-sub-text" style="font-size:18px; line-height:1.6; margin-top:20px; font-weight:500; max-width:350px;">
                    ${archObj.desc}
                </div>
            </div>
        `);

        // --- SLIDE 6: SUMMARY (Финал) ---
        let sumTagsHtml = dataStats.topTags.slice(0, 3).map(tag => `<div class="sum-tag">${tag}</div>`).join('');
        let planName = subscriptionLevel.toUpperCase();
        let planColor = subscriptionLevel === 'free' ? '#fff' : '#9b59b6';
        let outroText = subscriptionLevel === 'free' ? content.common.outro_free : content.common.outro_paid;

        slides.push(`
            <div class="wrapped-slide bg-dark">
                <div class="summary-card">
                    <div class="sum-header">
                        <div class="sum-logo">Fetish<span style="color:var(--accent)">Hub</span></div>
                        <div class="sum-date">${dataStats.dateRange}<br><span style="color:${planColor}">${planName}</span></div>
                    </div>
                    <div class="sum-row">
                        <div>
                            <div class="sum-label">${content.common.arch_label}</div>
                            <div class="sum-big-val" style="font-size:22px;">${archObj.name.replace(/ .*/, '')}</div> 
                        </div>
                        <div style="text-align:right">
                            <div class="sum-label">Actions</div>
                            <div class="sum-val">${dataStats.totalActions}</div>
                        </div>
                    </div>
                    <div>
                        <div class="sum-label">Top Interest</div>
                        <div class="sum-val" style="color:var(--accent); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${dataStats.topItems.length > 0 ? dataStats.topItems[0].name : '-'}</div>
                    </div>
                    <div>
                        <div class="sum-label">Tags</div>
                        <div class="sum-tags">${sumTagsHtml}</div>
                    </div>
                </div>

                <div class="wrapped-sub-text" style="font-size:14px; margin-top:20px; max-width:300px; opacity:0.8;">
                    ${outroText}
                </div>

                <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px; width:100%; align-items:center;">
                    <button onclick="closeWrapped()" class="btn-gen" style="padding:15px 40px; background:var(--text-main); color:var(--bg-color); width:auto; border-radius:30px; font-size:14px; text-transform:uppercase; font-weight:800;">
                        ${langData[currentLang].btn_close || "Done"}
                    </button>
                </div>
            </div>
        `);

        let barsHtml = '';
        slides.forEach((_, i) => {
            barsHtml += `<div class="wrapped-progress-bar"><div class="wrapped-progress-fill" id="bar-${i}"></div></div>`;
        });

        overlay.innerHTML = `
            <div class="wrapped-progress-container">${barsHtml}</div>
            <div class="wrapped-close" onclick="closeWrapped()">✕</div>
            <div class="wrapped-nav-area nav-left" onclick="prevSlide()"></div>
            <div class="wrapped-nav-area nav-right" onclick="nextSlide()"></div>
            ${slides.join('')}
        `;

        currentSlideIndex = 0;
        startSlideTimer(slides.length, 9000); 
    }

    function startSlideTimer(total, duration = 9000) {
        clearInterval(slideInterval);
        
        const show = (idx) => {
            document.querySelectorAll('.wrapped-slide').forEach(el => el.classList.remove('active-slide'));
            document.querySelectorAll('.wrapped-slide')[idx].classList.add('active-slide');
            
            for(let i=0; i<total; i++) {
                const bar = document.getElementById('bar-'+i);
                if(i < idx) { 
                    bar.style.width = '100%'; 
                    bar.style.transition = 'none'; 
                }
                else if(i > idx) { 
                    bar.style.width = '0%'; 
                    bar.style.transition = 'none'; 
                }
                else {
                    bar.style.width = '0%';
                    bar.style.transition = 'none';
                    setTimeout(() => {
                        // Используем linear для плавного заполнения
                        bar.style.transition = `width ${duration}ms linear`;
                        bar.style.width = '100%';
                    }, 50);
                }
            }
        };

        show(currentSlideIndex);

        slideInterval = setInterval(() => {
            if (currentSlideIndex < total - 1) {
                currentSlideIndex++;
                show(currentSlideIndex);
            } else {
                clearInterval(slideInterval); 
            }
        }, duration);
    }

    function nextSlide() {
        const total = document.querySelectorAll('.wrapped-slide').length;
        if (currentSlideIndex < total - 1) {
            currentSlideIndex++;
            startSlideTimer(total);
        } else {
            closeWrapped();
        }
    }

    function prevSlide() {
        const total = document.querySelectorAll('.wrapped-slide').length;
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            startSlideTimer(total);
        }
    }

    function closeWrapped() {
        clearInterval(slideInterval);
        document.getElementById('wrapped-mount').classList.remove('active');
    }

    function toggleInstallInstruct(platform) {
        const el = document.getElementById('instruct-' + platform);
        const isVisible = el.style.display === 'block';
        
        // Скрываем все
        document.getElementById('instruct-ios').style.display = 'none';
        document.getElementById('instruct-android').style.display = 'none';
        
        // Показываем нужный, если он был скрыт
        if (!isVisible) {
            el.style.display = 'block';
        }
    }

    function isAppInstalled() {
        // iOS Standalone или стандартный display-mode
        return (window.navigator.standalone === true) || (window.matchMedia('(display-mode: standalone)').matches);
    }

    function skipInstall() {
        document.getElementById('modal-install-overlay').classList.remove('open');
        // Помечаем, что видели (на эту сессию или навсегда - решать вам)
        sessionStorage.setItem('xch_install_skipped', 'true'); 
        
        // Переходим к следующему шагу (Онбординг предпочтений)
        checkOnboarding(); 
    }

    function checkOnboarding() {
        const isOnboarded = localStorage.getItem('xch_onboarding_done');
        if (!isOnboarded) {
            document.getElementById('onboarding-overlay').classList.add('open');
        }
    }

    function openLoginModal() {
        document.getElementById('modal-login-overlay').classList.add('open');
    }

    function closeLoginModal(e, force) {
        if (force || e.target.id === 'modal-login-overlay') {
            document.getElementById('modal-login-overlay').classList.remove('open');
        }
    }

    function performGoogleLogin() {
        // Закрываем модалку
        document.getElementById('modal-login-overlay').classList.remove('open');
        // Вызываем оригинальную функцию из модуля Firebase
        window.loginWithGoogle();
    }

    function changeOrientation(val) {
        currentOrientation = val;
        localStorage.setItem('xch_orientation', val);
    }

    function openRoadmap() {
        document.getElementById('modal-roadmap-overlay').classList.add('open');
    }

    function closeRoadmap(e, force) {
        if (force || e.target.id === 'modal-roadmap-overlay') {
            document.getElementById('modal-roadmap-overlay').classList.remove('open');
        }
    }

    function openQRModal() {
        // Генерируем ссылку на текущий URL
        const currentUrl = window.location.href;
        // Используем API для генерации QR
        const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=10&data=${encodeURIComponent(currentUrl)}`;
        
        document.getElementById('qr-code-img').src = qrApi;
        document.getElementById('modal-qr-overlay').classList.add('open');
    }

    function closeQRModal(e, force) {
        if (force || e.target.id === 'modal-qr-overlay') {
            document.getElementById('modal-qr-overlay').classList.remove('open');
        }
    }

    function initDecoSettings() {
        // По умолчанию true (показывать), если в памяти нет записи
        const saved = localStorage.getItem('xch_show_deco');
        const isEnabled = saved !== 'false'; // Если null или 'true', то true

        // Обновляем состояние чекбокса
        const toggle = document.getElementById('deco-toggle');
        if (toggle) toggle.checked = isEnabled;

        // Применяем класс
        applyDecoState(isEnabled);
    }

    function toggleDecoIcons(isChecked) {
        localStorage.setItem('xch_show_deco', isChecked);
        applyDecoState(isChecked);
    }

    function applyDecoState(isEnabled) {
        if (isEnabled) {
            document.body.classList.remove('no-deco');
        } else {
            document.body.classList.add('no-deco');
        }
    }

    function randomizeDecorations(item = null) {
        const leftImg = document.getElementById('deco-left');
        const rightImg = document.getElementById('deco-right');
        
        if (!leftImg || !rightImg) return;

        let selectedIcons = [];

        // ШАГ 1: Пытаемся найти специфичные иконки, если передан предмет
        if (item && item.tags) {
            // Проходим по всем тегам предмета
            item.tags.forEach(tag => {
                if (TAG_ICONS[tag]) {
                    // Добавляем все иконки, связанные с этим тегом
                    selectedIcons.push(...TAG_ICONS[tag]);
                }
            });
        }

        // Убираем дубликаты (если один файл прописан в разных тегах)
        selectedIcons = [...new Set(selectedIcons)];
        
        // Перемешиваем найденные специфичные иконки
        selectedIcons.sort(() => 0.5 - Math.random());

        // ШАГ 2: Заполняем пропуски нейтральными
        // Нам нужно ровно 2 иконки (левая и правая)
        
        // Если специфичных нет вообще -> берем две нейтральные
        if (selectedIcons.length === 0) {
            selectedIcons.push(getRandomNeutral());
            selectedIcons.push(getRandomNeutral(selectedIcons[0])); // Передаем первую, чтобы вторая не совпала
        } 
        // Если есть только одна специфичная -> добавляем к ней одну нейтральную
        else if (selectedIcons.length === 1) {
            selectedIcons.push(getRandomNeutral());
        }
        // Если специфичных 2 или больше -> массив уже заполнен (лишние обрежутся ниже)

        // ШАГ 3: Применяем
        leftImg.src = selectedIcons[0];
        rightImg.src = selectedIcons[1];
    }

    function getRandomNeutral(excludeSrc = null) {
        let pool = NEUTRAL_DECOS;
        if (excludeSrc) {
            pool = pool.filter(src => src !== excludeSrc);
        }
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function calculateWatchTime() {
        // Проверка: было ли начало просмотра и есть ли сохраненный предмет
        if (watchStartTime === 0 || !itemBeingWatched) return;

        const now = Date.now();
        const diffInSeconds = Math.floor((now - watchStartTime) / 1000);
        
        watchStartTime = 0; 

        // Игнорируем меньше 5 сек
        if (diffInSeconds < 5) return;

        // Если больше 30 минут (1800 сек), ставим заглушку
        let timeString = "";
        const minLabel = currentLang === 'ru' ? 'мин' : 'min';
        const secLabel = currentLang === 'ru' ? 'сек' : 'sec';

        if (diffInSeconds > 1800) {
            timeString = `30+ ${minLabel}`;
        } else {
            const minutes = Math.floor(diffInSeconds / 60);
            const seconds = diffInSeconds % 60;
            
            if (minutes > 0) {
                timeString = `${minutes} ${minLabel} ${seconds} ${secLabel}`;
            } else {
                timeString = `${seconds} ${secLabel}`;
            }
        }

        // === СОХРАНЕНИЕ В ИСТОРИЮ ===
        const historyEntry = {
            id: itemBeingWatched.id,
            timestamp: Date.now(),
            durationStr: timeString,
            seconds: diffInSeconds
        };
        
        // Добавляем в начало
        watchHistory.unshift(historyEntry);
        // Храним последние 100 записей
        if (watchHistory.length > 100) watchHistory.pop();
        
        localStorage.setItem(STORAGE.WATCH_HISTORY, JSON.stringify(watchHistory));
        
        // Обновляем облако
        if (window.syncToCloud) window.syncToCloud();
        // ======================================

        // Показ сообщения
        const t = langData[currentLang] || langData['en'];
        let phraseTemplate = "";
        
        // Если смотрел долго (или сработала заглушка 30+)
        if (diffInSeconds > 1800) {
             phraseTemplate = (currentLang === 'ru') ? "Долгое погружение... 🌊" : "Deep dive... 🌊";
             // Перезаписываем timeString в шаблоне, если нужно, или просто выводим фразу
        } else if (diffInSeconds < 40) {
            phraseTemplate = t.return_phrase_short || "Only {t}...";
        } else {
            const phrases = t.return_phrases || ["{t} passed."];
            phraseTemplate = phrases[Math.floor(Math.random() * phrases.length)];
        }
        
        // Если phraseTemplate не содержит {t}, просто выводим её
        const finalPhrase = phraseTemplate.includes("{t}") ? phraseTemplate.replace("{t}", timeString) : phraseTemplate;

        const statusEl = document.getElementById('status-text');
        if (statusEl) {
            statusEl.style.opacity = '0';
            setTimeout(() => {
                statusEl.innerText = finalPhrase;
                statusEl.style.color = "var(--text-main)";
                statusEl.style.opacity = '1';
            }, 200);
        }
    }

    function resetToHome() {
        // Если мы уже на стартовом экране или идет генерация — выходим
        if (!currentItem || isGenerating) return;

        const wrapper = document.getElementById('card-anim-wrapper');
        const card = document.getElementById('card-block');
        
        // 1. АНИМАЦИЯ УХОДА (Улетает влево)
        if (wrapper) {
            wrapper.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
            wrapper.style.transform = 'translateX(-150%) rotate(-10deg)';
            wrapper.style.opacity = '0';
        }

        // Ждем окончания анимации (350мс)
        setTimeout(() => {
            // 2. СБРОС ДАННЫХ
            currentItem = null;
            lastGeneratedItem = null;
            isFirstGen = true; 
            sessionHistoryStack = []; 

            // 3. СБРОС ИНТЕРФЕЙСА (Скрываем результаты)
            const uiToHide = ['result-desc', 'tinder-controls', 'mods-block', 'related-block'];
            uiToHide.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.add('hidden-initial'); 
                    el.style.display = 'none'; 
                }
            });

            // Очищаем бейджи и статус
            document.getElementById('badge-wrapper').innerHTML = '';
            const statusEl = document.getElementById('status-text');
            if(statusEl) statusEl.innerText = ''; // Очищаем верхний текст

            // Сброс классов карточки
            if(card) {
                card.classList.remove('has-results', 'flash-active', 'status-wl', 'status-fav', 'status-ban');
                const notch = document.getElementById('card-notch');
                if(notch) notch.classList.remove('visible');
            }

            // Запускаем "Холостой ход" слотов
            initIdleSlot();
            randomizeDecorations();

            // Сброс иконок (декора)
            const iconLeft = document.querySelector('.icon-left');
            const iconRight = document.querySelector('.icon-right');
            [iconLeft, iconRight].forEach(icon => {
                if(icon) {
                    icon.style.transition = 'none';
                    icon.style.opacity = '';
                    icon.style.transform = '';
                    icon.style.animation = ''; 
                }
            });

            const totalInteractions = favorites.length + blacklist.length;
            const startBtn = document.getElementById('start-btn-container');
            const overlay = document.getElementById('mode-start-overlay');

            if (totalInteractions >= 10) {
                // ВАРИАНТ А: Опытный пользователь -> Показываем ВЫБОР РЕЖИМА
                
                // 1. Обновляем фразу (чтобы не была одной и той же)
                randomizeModeGreeting(); 

                // 2. Показываем оверлей с кнопками 🔭 и 🥰
                if(overlay) {
                    overlay.classList.remove('hidden');
                    overlay.style.opacity = '1';
                    overlay.style.transform = 'scale(1)';
                }
                
                // 3. Включаем флаг, чтобы работали свайпы для выбора
                isModeSelectionActive = true; 
                
                // 4. Скрываем старую кнопку "Поехали"
                if(startBtn) startBtn.style.display = 'none';

            } else {
                // ВАРИАНТ Б: Новичок -> Старая кнопка "Поехали"
                
                // 1. Скрываем оверлей выбора
                if(overlay) overlay.classList.add('hidden');
                isModeSelectionActive = false;

                // 2. Показываем кнопку "Let's Go"
                if(startBtn) {
                    startBtn.classList.remove('hidden-initial');
                    startBtn.style.display = 'flex';
                    startBtn.style.opacity = '1';
                }
            }


            // 6. ВОЗВРАЩЕНИЕ КАРТОЧКИ (Телепорт в центр и Fade In)
            if (wrapper) {
                wrapper.style.transition = 'none';
                wrapper.style.transform = 'scale(0.95)'; // Чуть меньше для эффекта
                
                void wrapper.offsetWidth; // Reflow

                wrapper.style.transition = 'opacity 0.5s ease, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                wrapper.style.opacity = '1';
                wrapper.style.transform = 'scale(1)';
            }

        }, 350);
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') {
            // Если пользователь залогинен, форсируем сохранение (immediate = true)
            if (window.isUserLoggedIn) {
                console.log("App hidden, forcing save...");
                window.syncToCloud(true);
            }
        }
    });

    function openSponsorsModal() {
        const list = document.getElementById('sponsors-list');
        list.innerHTML = '';

        earlySponsors.forEach(person => {
            const row = document.createElement('div');
            row.className = 'ios-row';
            row.style.cursor = 'default'; // Не кликабельно
            row.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:18px;">💎</span>
                    <span style="font-weight:600; color:var(--text-main);">${person.name}</span>
                </div>
                <span style="font-size:12px; color:var(--text-secondary);">${person.date}</span>
            `;
            list.appendChild(row);
        });

        document.getElementById('modal-sponsors-overlay').classList.add('open');
    }

    function closeSponsorsModal(e, force) {
        if (force || e.target.id === 'modal-sponsors-overlay') {
            document.getElementById('modal-sponsors-overlay').classList.remove('open');
        }
    }

    function openHistoryModal() {
        document.getElementById('modal-history-overlay').classList.add('open');
        // Рендерим текущую вкладку
        switchHistoryTab(currentHistoryTab);
    }

    function closeHistoryModal(e, force) {
        if (force || e.target.id === 'modal-history-overlay') {
            document.getElementById('modal-history-overlay').classList.remove('open');
        }
    }

    function switchHistoryTab(tab) {
        currentHistoryTab = tab;
        
        const btnSwipes = document.getElementById('hist-nav-swipes');
        const btnWatch = document.getElementById('hist-nav-watch');
        const listSwipes = document.getElementById('hist-list-swipes');
        const listWatch = document.getElementById('hist-list-watch');

        if (tab === 'swipes') {
            btnSwipes.classList.add('active');
            btnWatch.classList.remove('active');
            listSwipes.style.display = 'block';
            listWatch.style.display = 'none';
            renderSwipesHistoryList();
        } else {
            btnSwipes.classList.remove('active');
            btnWatch.classList.add('active');
            listSwipes.style.display = 'none';
            listWatch.style.display = 'block';
            renderWatchHistoryList();
        }
    }

    function renderSwipesHistoryList() {
        const list = document.getElementById('hist-list-swipes');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (historyData.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">${t.hist_empty}</div>`;
            return;
        }

        historyData.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;
            
            // Используем стили ios-row для красоты
            const div = document.createElement('div');
            div.className = 'ios-row clickable';
            div.style.padding = '12px 20px'; // Чуть больше отступ в модалке
            
            const name = getLocalizedName(item);
            
            // Дата генерации (опционально)
            // const dateStr = new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            div.innerHTML = `
                <div style="font-weight:500;">${name}</div>
                <div style="color:var(--accent); font-size:18px;">↺</div>
            `;
            
            div.onclick = () => { 
                closeHistoryModal(null, true);
                switchTab('home'); 
                forceShowResult(item, 'history'); 
            };
            list.appendChild(div);
        });
    }

    function renderWatchHistoryList() {
        const list = document.getElementById('hist-list-watch');
        list.innerHTML = '';
        const t = langData[currentLang] || langData['en'];
        
        if (watchHistory.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">${t.hist_empty_watch}</div>`;
            return;
        }

        watchHistory.forEach(entry => {
            const item = data.find(x => x.id === entry.id);
            if(!item) return;

            const div = document.createElement('div');
            div.className = 'ios-row clickable';
            div.style.padding = '12px 20px';

            const name = getLocalizedName(item);
            const d = new Date(entry.timestamp);
            const dateStr = d.toLocaleDateString() === new Date().toLocaleDateString() 
                ? d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                : d.toLocaleDateString([], {day:'numeric', month:'numeric'}) + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            div.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div style="font-weight:600;">${name}</div>
                    <div style="font-size:11px; color:var(--text-secondary);">${dateStr}</div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:2px;">
                    <span style="font-weight:700; color:var(--text-main); font-size:15px;">${entry.durationStr}</span>
                    <span style="font-size:10px; color:var(--accent);">${t.hist_watched}</span>
                </div>
            `;
            
            div.onclick = () => {
                closeHistoryModal(null, true);
                switchTab('home');
                forceShowResult(item, 'history');
            };
            
            list.appendChild(div);
        });
    }

    window.openAdminModal = function() {
        document.getElementById('modal-admin-overlay').classList.add('open');
    };

    window.closeAdminModal = function(e, force) {
        if (force || e.target.id === 'modal-admin-overlay') {
            document.getElementById('modal-admin-overlay').classList.remove('open');
        }
    };

    function initModes() {
        const totalInteractions = favorites.length + blacklist.length;
        const hasEnoughData = totalInteractions >= 10;

        const capsules = document.querySelectorAll('.mode-capsule-wrapper');
        const startOverlay = document.getElementById('mode-start-overlay');
        const startBtn = document.getElementById('start-btn-container');

        if (hasEnoughData) {
            randomizeModeGreeting();
            // 1. Показываем капсулы (CSS media query решит, какую именно)
            capsules.forEach(el => el.style.display = 'block');
            
            // 2. Показываем Оверлей выбора в карточке
            if(startOverlay) {
                startOverlay.classList.remove('hidden');
                isModeSelectionActive = true;
            }

            // 3. Скрываем старую кнопку "Поехали" (она нам не нужна)
            if(startBtn) {
                startBtn.classList.add('hidden-initial'); // Скрываем через класс
                startBtn.style.display = 'none'; // И на всякий случай инлайном
            }
            
            // Обновляем текст в капсулах
            updateCapsuleUI();

        } else {
            // Если мало действий — скрываем всё новое, работаем как раньше
            capsules.forEach(el => el.style.display = 'none');
            if(startOverlay) startOverlay.classList.add('hidden');
            isModeSelectionActive = false;
            
            // Убеждаемся, что кнопка старта видна
            if(startBtn) {
                startBtn.classList.remove('hidden-initial');
                startBtn.style.display = 'flex';
            }
        }
    }

    function randomizeModeGreeting() {
        const el = document.querySelector('.mode-greeting-text');
        if (!el) return;
        
        const t = langData[currentLang] || langData['en'];
        const phrases = Array.isArray(t.mode_greeting_hint) 
            ? t.mode_greeting_hint 
            : [t.mode_greeting_hint];
            
        el.innerText = phrases[Math.floor(Math.random() * phrases.length)];
    }

    function toggleModeDropdown(type) {
        const id = type === 'pc' ? 'mode-capsule-pc' : 'mode-capsule-mobile';
        const wrapper = document.getElementById(id);
        
        // Закрываем другую, если открыта (опционально)
        document.querySelectorAll('.mode-capsule-wrapper').forEach(el => {
            if(el.id !== id) el.classList.remove('open');
        });

        wrapper.classList.toggle('open');
    }

    function setAppMode(mode) {
        currentAppMode = mode;
        updateCapsuleUI();
        
        // Закрываем все дропдауны
        document.querySelectorAll('.mode-capsule-wrapper').forEach(el => el.classList.remove('open'));
        
        console.log("Mode set to:", mode);
    }

    function setAppModeAndStart(mode) {
        setAppMode(mode);
        
        // Анимация скрытия оверлея
        const overlay = document.getElementById('mode-start-overlay');
        if(overlay) {
            overlay.style.transition = 'opacity 0.3s, transform 0.3s';
            overlay.style.opacity = '0';
            overlay.style.transform = 'scale(1.1)';
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
        
        isModeSelectionActive = false;
        
        // Запуск
        startNewSession();
    }

    function updateCapsuleUI() {
        const t = langData[currentLang] || langData['en'];
        
        // Иконка и текст зависят от режима
        const icon = currentAppMode === 'explore' ? '🔭' : '🥰';
        const textKey = currentAppMode === 'explore' ? 'mode_explore' : 'mode_pleasure';
        const text = t[textKey];

        // Обновляем все капсулы (и ПК и Мобайл)
        document.querySelectorAll('.current-mode-icon').forEach(el => el.innerText = icon);
        document.querySelectorAll('.current-mode-text').forEach(el => el.innerText = text);
        
        // Подсветка активного пункта в списке
        document.querySelectorAll('.mode-item').forEach(el => el.classList.remove('active'));
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.mode-capsule-wrapper')) {
            document.querySelectorAll('.mode-capsule-wrapper').forEach(el => el.classList.remove('open'));
        }
    });

</script>

<!-- SEO CONTEXT BLOCK -->
<div class="seo-context">
    <h2>xFetishHub: The Ultimate Adult Preference Ecosystem</h2>
    <p>
        xFetishHub is not just a randomizer; it is your personal <strong>adult preference tracker</strong> and discovery platform. 
        Unlike simple tube sites, we provide a smart environment where you can <strong>analyze your sexual tastes</strong> through detailed charts and statistics.
    </p>
    <h3>Why use xFetishHub?</h3>
    <ul>
        <li>
            <strong>Smart Discovery:</strong> Learn about new genres and fetishes you didn't know existed. Our database covers 1000+ tags from vanilla to niche.
        </li>
        <li>
            <strong>Taste Analytics:</strong> Track what you like and dislike. View your "Fetish Wrapped" and understand your own psychology better with visual graphs.
        </li>
        <li>
            <strong>Private Browser Experience:</strong> On mobile devices, xFetishHub acts as a <strong>secure browser</strong>. Watch content from xHamster, Pornhub, and xVideos directly within our app without cluttering your main browser history.
        </li>
        <li>
            <strong>Personalized Feed:</strong> The more you use it, the better it gets. Our algorithm learns from your swipes to recommend content that truly matches your interests.
        </li>
    </ul>
    <p>
        Whether you are looking for a <strong>porn history tracker</strong>, a safe way to explore new kinks, or simply a better way to browse adult content, xFetishHub is your private home for digital intimacy.
    </p>
</div>
</body>
</html>